"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[3898],{89487:(e,t,i)=>{i.d(t,{Cq:()=>P,Dd:()=>E,cT:()=>C,fD:()=>S,hr:()=>R,py:()=>M,zs:()=>A});var r=i(20246),n=i.n(r),s=i(39831),o=i.n(s),a=i(61799),h=i.n(a),l=i(26117),c=i.n(l),u=i(5996),d=i.n(u),p=i(20658),_=i.n(p),f=i(3434),g=i.n(f),m=i(97828),y=i.n(m),v=i(93213),b=(i(13567),i(6475)),w=i(29115);function x(e,t){var i=n()(e);if(o()){var r=o()(e);t&&(r=h()(r).call(r,(function(t){return c()(e,t).enumerable}))),i.push.apply(i,r)}return i}function T(e){for(var t=1;t<arguments.length;t++){var i,r,n=null!=arguments[t]?arguments[t]:{};t%2?d()(i=x(Object(n),!0)).call(i,(function(t){(0,v.Z)(e,t,n[t])})):_()?g()(e,_()(n)):d()(r=x(Object(n))).call(r,(function(t){y()(e,t,c()(n,t))}))}return e}async function C({name:e,jsonData:t,sourceType:i,moduleIds:r,projectId:n,pid:s}){return await(0,w.qu)(b.au.create,{name:e,pic_key:"icon.png",source_type:i,node_type:"file",json_data:t,resources:r,project_id:n,pid:s,status:1,project_type:"3d"})}async function E(e){return await(0,w.pz)(b.au.update,T({},e))}async function S(e,t=0,i){const r=await(0,w.ZL)(b.au.list,{params:{source_type:e,pid:t,project_type:"3d",name:i,status:1}});return r.code===w.Mx.Ok?r.data??[]:null}async function P(e){const t=await(0,w.ZL)(b.au.detail+"/"+e);return t.code===w.Mx.Ok?t.data?.info?.json_data:null}async function R(e){const t=await(0,w.ZL)(b.au.detail+"/"+e);return t.code===w.Mx.Ok?t.data?.info:null}async function A({name:e,sourceType:t}){return await w.GH.post(b.au.create,{name:e,pid:0,source_type:t,node_type:"dir",status:1,project_type:"3d"})}async function M(e){return await w.GH.put(b.au.update,T({},e))}},99394:(e,t,i)=>{i.d(t,{s7:()=>n});var r=i(29115);function n(e,t){return(0,r.GH)({url:e,method:"get",params:t})}},84199:(e,t,i)=>{let r;i.d(t,{d:()=>r}),function(e){e.Delete="DELETE",e.Model2Zero="MODEL2ZERO",e.SelectAll="SELECTALL",e.Copy="COPY",e.Paste="PASTE",e.Group="GROUP"}(r||(r={}))},2361:(e,t,i)=>{i.d(t,{fl:()=>r});const r="class CustomComponent extends HC.Component {\n    //\u7ec4\u4ef6\u5c5e\u6027\n    getData() {\n        return {\n            \n        };\n    }\n    //\u7ec4\u4ef6\u5305\u542b\u5b9e\u4f53\n    initComponents(){\n        return [\n            \n        ]\n    }\n}\n"},97198:(e,t,i)=>{i.d(t,{A5:()=>h});var r=i(74857),n=i(94063),s=i(5212),o=i(45709),a=i(32735);function h(e){return a.createElement(n.Z,{sx:{display:"flex",alignItems:"center"}},a.createElement(n.Z,{sx:{width:"20%",whiteSpace:"no-wrap"}},e.label||"\u6b63\u5728\u52a0\u8f7d\u8d44\u6e90\uff1a"),a.createElement(n.Z,{sx:{width:"70%",mr:1}},a.createElement(s.Z,(0,r.Z)({variant:"determinate"},e))),a.createElement(n.Z,{sx:{width:"10%"}},a.createElement(o.Z,{variant:"body2",color:"#fff"},`${Math.round(e.value)}%`)))}},69326:(e,t,i)=>{var r,n,s=i(29405),o=i.n(s),a=i(20246),h=i.n(a),l=i(14549),c=i.n(l),u=i(66989),d=i.n(u),p=i(57055),_=i(42977);(0,p.Factory)(((n=class extends p.BaseDom{constructor(e){super(),this._source=void 0,this.graphView=void 0,this.hcNode=void 0,this._dataBindings=void 0,this._setAttr={},this.load=e=>{if(!e)return;const t="object"==typeof e.width?e.width.value:e.width,i="object"==typeof e.height?e.height.value:e.height;this._width||(this._width=t),this._height||(this._height=i),this._dataBindings=e.dataBindings;const r=this.graphView.getView();r.style.cssText=`\n    position:absolute;\n    left:${this._position.x}px;\n    top:${this._position.y}px;\n    width:${this._width}px;\n    height:${this._height}px;\n    outline:none;\n    `,this.Visiable||(r.style.visibility="hidden"),o()((()=>{r.style.visibility="visible",r.style.display=this.Visiable&&!this.IsErase?"block":"none"}),0),this.graphView.fitContent(!1,0),this.update()},e?.url&&(this._source=e.url),window.gui=this}get DataBindings(){return this._dataBindings??[]}get Attr(){return this._setAttr}setProp(e,t){this.updateAttr({[e]:t})}updateAttr(e){0!==h()(e).length&&this.graphView&&this.hcNode&&(c()(this._setAttr,e),this.hcNode.a(e))}initDrawObject(){const e=(0,_.yD)();return this.graphView=e,(0,_.Tt)(e.dm(),this._source).then((e=>{if(!e)return;this.hcNode=e,e.target3d=this;const t=(0,_.Er)(e.getImage());this.load(t)})),e.getView()}updateDrawObject(e){super.updateDrawObject(e);const t=this.convertValue(this._width,p.AppStore.MainViewer.Width),i=this.convertValue(this._height,p.AppStore.MainViewer.Height);this.graphView.setWidth(t),this.hcNode.setWidth(t),this.graphView.setHeight(i),this.hcNode.setHeight(i),this.graphView.fitContent(!1,0),this.updateAttr(this._setAttr)}getTexture(){return null}writeFile(e){super.writeFile(e),e.write(2),e.write(this._source),e.write(d()(this._setAttr))}readFile(e){super.readFile(e);const t=e.read();this._source=e.read(),t>1&&(this._setAttr=JSON.parse(e.read())),this.update()}}).type="HC2DDom",r=n))},49142:(e,t,i)=>{var r,n,s=i(29405),o=i.n(s),a=i(13567),h=i.n(a),l=i(71722),c=i.n(l),u=i(57055),d=i(42977);(0,u.Factory)(((n=class extends u.BaseTextureRecord{constructor(e){super(),this._source=e,this.graphView=void 0,this.hcNode=void 0,this._dataBindings=void 0,this.texture=void 0,this.timer=void 0,this.load=e=>{if(!e)return;const t="object"==typeof e.width?e.width.value:e.width,i="object"==typeof e.height?e.height.value:e.height;this._dataBindings=e.dataBindings;const r=this.graphView.getView();r.style.cssText=`position:fixed;left:0;top:0;width:${t}px;height:${i}px;visibility:hidden`,this.graphView.getCanvas().width=t,this.graphView.getCanvas().height=i,document.body.append(r),this.texture&&this.texture.update(),o()((()=>{r.remove()}),2e3)}}get Texture(){return this.texture||this.update(),this.texture}get Source(){return this._source}set Source(e){e!==this._source&&(this._source=e,this.update())}initTexture(){const e=(0,d.yD)();let t;return e.addViewListener((e=>{this.timer&&clearTimeout(this.timer),"validate"===e?.kind&&(this.timer=o()((()=>{let e=!1;const i=this.graphView.__htmlOrderList?.[0];if("VIDEO"===i?.nodeName)this.texture?i.src!==this.texture.video.src&&(e=!0,this.texture.updateURL(i.src)):(this.texture=u.Utils.getVideoTexture("video"+h()(),i.src,u.AppStore.MainScene),t(this));else{let r;i&&i instanceof HTMLElement&&(r=i.getElementsByTagName("canvas")[0]),r||(r=this.graphView.getCanvas()),r&&(this.texture?(e=!0,this.texture._canvas=r,this.texture._context=r.getContext("2d")):(this.texture=u.Utils.getCanvasTexture("canvas"+h()(),r,u.AppStore.MainScene),t(this)))}e&&(this.graphView.fitContent(!1,0),this.texture.update())}),100))})),this.graphView=e,new(c())((e=>{(0,d.Tt)(this.graphView.dm(),this._source).then((i=>{this.hcNode=i;const r=(0,d.Er)(i.getImage());this.load(r),t=e}))}))}update(){super.update(),this.graphView}writeFile(e){super.writeFile(e),e.write(1),e.write(this._source)}readFile(e){super.readFile(e),e.read(),this._source=e.read(),this.initTexture()}}).type="HC2DTexture",r=n))},29556:(e,t,i)=>{var r,n,s=i(29405),o=i.n(s),a=i(20246),h=i.n(a),l=i(14549),c=i.n(l),u=i(32849),d=i.n(u),p=i(66989),_=i.n(p),f=i(57055),g=i(42977);(0,f.Factory)(((n=class extends f.BaseGui{constructor(e){super(),this._source=void 0,this.graphView=void 0,this.hcNode=void 0,this._dataBindings=void 0,this._setAttr={},this.timer=void 0,this.load=e=>{if(!e)return;const t="object"==typeof e.width?e.width.value:e.width,i="object"==typeof e.height?e.height.value:e.height;this._dataBindings=e.dataBindings;const r=this.graphView.getView();this._width=t+"px",this._height=i+"px",r.style.cssText=`position:fixed;left:0;top:0;width:${t}px;height:${i}px;visibility:hidden`,this.graphView.getCanvas().width=t,this.graphView.getCanvas().height=i,document.body.append(r),o()((()=>{r.remove()}),2e3)},e?.url&&(this._source=e.url)}get DataBindings(){return this._dataBindings??[]}get Attr(){return this._setAttr}setProp(e,t){this.updateAttr({[e]:t})}updateAttr(e){if(0===h()(e).length||!this.graphView||!this.hcNode)return;const t=this.graphView.getView();document.body.append(t),this.timer&&clearTimeout(this.timer),this.timer=o()((()=>{t.remove()}),2e3),c()(this._setAttr,e),this.hcNode.a(e)}initDrawObject(){const e=(0,g.yD)(),t=f.Utils.getGuiContainer(this.UniqueName);return t.horizontalAlignment=0,t.verticalAlignment=0,e.addViewListener((e=>{"validate"===e?.kind&&this.updateDrawObject(t)})),this.graphView=e,(0,g.Tt)(e.dm(),this._source).then((e=>{if(!e)return;this.hcNode=e;const i=(0,g.Er)(e.getImage());this.load(i),this.generateLinkLine(t,100)})),t}updateDrawObject(e){let t,i;super.updateDrawObject(e),this.linkEntity?e.linkWithMesh(this.linkEntity.Object.DrawObject):e.linkWithMesh(null),this.graphView.fitContent(!1,0);const r=this.graphView.__htmlOrderList?.[0];if(r&&r instanceof HTMLElement?(t=this.graphView.__htmlOrderList[0].getElementsByTagName("canvas")[0],"VIDEO"===r.nodeName&&(i=r)):t=this.graphView.getCanvas(),t||(t=this.graphView.getCanvas()),0===e.children.length)if(i){d()(this.DataBindings);const t=new f.Video(this.UniqueName+"_video",i.src,this._width,this._height,f.AppStore.MainScene);e.addControl(t),t.width=this._width,t.height=this._height}else{const i=new f.CanvasControl(this.UniqueName,t,f.AppStore.MainScene);e.addControl(i),i.width=this._width,i.height=this._height}else{const r=e.children[0];i?r.source=i.src:r.CanvasDom=t}e.width=this._width,e.height=this._height,this.updateAttr(this._setAttr)}getTexture(){return null}get IsSelect(){return this._isSelect}set IsSelect(e){if(this._isSelect=e,!this._drawObject)return;const t=this._drawObject;t.background=e?"#9595d8":""}writeFile(e){super.writeFile(e),e.write(1),e.write(this._source),e.write(_()(this._setAttr))}readFile(e){super.readFile(e),e.read(),this._source=e.read(),this._setAttr=JSON.parse(e.read()),this.update()}}).type="HC2DGui",r=n))},42977:(e,t,i)=>{i.d(t,{Er:()=>y,Tt:()=>m,yD:()=>g});var r=i(39282),n=i.n(r),s=i(13567),o=i.n(s),a=i(71722),h=i.n(a),l=i(57055),c=i(54056),u=i(73554),d=i(84199),p=i(92513);const _=window.ht;window.storagePrefix=l.AppConfig.assetURL,_.Default.convertURL=function(e){let t=l.AppConfig.assetURL;return!t||!e||/^data:image/.test(e)||/^http/.test(e)||/^https/.test(e)||(e=t+"/"+e),e};new(n());const f=o()();function g(){const e=new _.DataModel,t=new _.graph.GraphView(e);return t.getSelectWidth=()=>0,t.setMovableFunc((e=>!1)),t.setPannable(!1),t.setRectSelectable(!1),t.setScrollBarVisible(!1),t.handleScroll=()=>!1,t.onDataClicked=(e,t)=>{if(!e)return;l.AppEvent.trigger({type:"click",target:e.target3d,event:t});const i=e.target3d;i.trigger({type:"click",target:e.target3d,event:t}),l.AppStore.PreviewMode||(i.start(t.clientX,t.clientY),c.gV.intance.Editor.selectControl&&(c.gV.intance.Editor.selectControl.SelectDOM=i))},t.getView().addEventListener("keydown",(e=>{"Delete"===e.key?(l.CMD.commandManager.ExecCommand(d.d.Delete),e.stopPropagation()):"KeyC"===e.code&&e.ctrlKey?(l.CMD.commandManager.ExecCommand(d.d.Copy),e.stopPropagation()):"KeyV"===e.code&&e.ctrlKey&&(l.CMD.commandManager.ExecCommand(d.d.Paste),e.stopPropagation())})),t}async function m(e,t){t=(e=>e+"?timestap="+f)(t);const i=new _.Node;e.add(i);const r=(0,p.F)();return new(h())((e=>{_.Default.xhrLoad(t,(function(t){t?(_.Default.setImage(r,_.Default.parse(t)),i.setImage(r),e(i)):(u.y.error("2d\u8d44\u6e90\u672a\u627e\u5230"),e(null))}))}))}function y(e){return _.Default.getImage(e)}},93765:(e,t,i)=>{i.d(t,{U:()=>h});var r=i(31025),n=i(57055),s=i(6475),o=i(29115),a=i(93187);const h=new class{constructor(){this._projectId=0,this.particleDisplay=!0,this.bgType=n.SkyboxMode.None,this._appIndexId=void 0,this._projectName="",(0,r.ky)(this)}get projectId(){return this._projectId}set projectId(e){this._projectId=e}get BgType(){return this.bgType}set BgType(e){this.bgType=e}get appIndexId(){return this._appIndexId}set appIndexId(e){this._appIndexId=e}get projectName(){return this._projectName}set projectName(e){this._projectName=e}async loadProject(e){if(this.projectId=e,!e)return;const t=await(0,o.ZL)(s.U.detail+e);if(t.code===o.Mx.Ok&&t.data?.info){this.appIndexId=t.data.info.preview_app_id,this.projectName=t.data.info.name;const e=t.data.info.variable;e&&a.E.globalVarStore.setVariable(JSON.parse(e))}}}},17665:(e,t,i)=>{var r,n=i(41843),s=i(26117),o=i.n(s),a=i(31025),h=i(92604),l=i(99394),c=i(46266);new(r=class{constructor(){this.userName="",this.userCode="",this.userId="",this.userRole=[],(0,a.ky)(this,{userCode:!1})}get UserName(){return this.userName}set UserName(e){this.userName=e}get UserId(){return this.userId}set UserId(e){this.userId=e}get UserRole(){return this.userRole}set UserRole(e){this.userRole=e}logOut(){(0,h.gy)(),c.Z.signoutRedirect()}getUserInfo(){(0,l.s7)("editor/user/detail",{}).then((e=>{if(e&&e.data&&e.data.info){this.userId=e.data.info.user_code,this.userName=e.data.info.user_name,this.userCode=e.data.info.user_code;let t=[];if(e.data.info.Role&&e.data.info.Role.length>0)for(let i of e.data.info.Role)t.push(i.role_code);this.userRole=t}}))}},(0,n.Z)(r.prototype,"getUserInfo",[a.aD],o()(r.prototype,"getUserInfo"),r.prototype),r)},27660:(e,t,i)=>{i.d(t,{l:()=>J});var r=i(20246),n=i.n(r),s=i(39831),o=i.n(s),a=i(61799),h=i.n(a),l=i(5996),c=i.n(l),u=i(20658),d=i.n(u),p=i(3434),_=i.n(p),f=i(97828),g=i.n(f),m=i(93213),y=i(41843),v=i(12625),b=i.n(v),w=i(39282),x=i.n(w),T=i(51463),C=i.n(T),E=i(14549),S=i.n(E),P=i(27566),R=i.n(P),A=i(62750),M=i.n(A),O=i(66989),I=i.n(O),F=i(26117),D=i.n(F),L=i(2361),B=i(93765),N=i(73554),k=i(6475),U=i(29115),z=i(31025),G=i(12117),V=i(71722),j=i.n(V);let W;!function(e){e.Component="component",e.Files="files"}(W||(W={}));const H=[W.Component,W.Files];class K{static async getIdb(){return await this.iDb.open(),this.iDb}constructor(){this.opening=!1,this._db=void 0,this.resFunctionList=[]}open(){return new(j())(((e,t)=>{if(this._db)return void e(!0);if(this.resFunctionList.push(e),this.opening)return;this.opening=!0;const i=indexedDB.open("HC",H.length);i.onerror=function(e){t(!1)},i.onsuccess=e=>{var t;this._db=e.target.result,this._db.onclose=e=>{this._db=null,this.opening=!1},c()(t=this.resFunctionList).call(t,(e=>e())),this.resFunctionList.length=0},i.onupgradeneeded=e=>{this._db=e.target.result;for(let t=e.oldVersion;t<H.length;t++)this._db.createObjectStore(H[t])}}))}put(e,t,i){this._db.transaction(e,"readwrite").objectStore(e).put(i,t)}get(e,t){const i=this._db.transaction(e,"readwrite");return new(j())((r=>{i.objectStore(e).get(t).onsuccess=function(e){r(e.target.result)}}))}getAll(e){const t=this._db.transaction(e,"readwrite");return new(j())((i=>{t.objectStore(e).getAll().onsuccess=function(e){i(e.target.result)}}))}clear(e){this._db.transaction(e,"readwrite").objectStore(e).clear()}delete(e,t){this._db.transaction(e,"readwrite").objectStore(e).delete(t)}}K.iDb=new K;var X,q=i(89487),Y=i(19853);function Z(e,t){var i=n()(e);if(o()){var r=o()(e);t&&(r=h()(r).call(r,(function(t){return D()(e,t).enumerable}))),i.push.apply(i,r)}return i}function Q(e){for(var t=1;t<arguments.length;t++){var i,r,n=null!=arguments[t]?arguments[t]:{};t%2?c()(i=Z(Object(n),!0)).call(i,(function(t){(0,m.Z)(e,t,n[t])})):d()?_()(e,d()(n)):c()(r=Z(Object(n))).call(r,(function(t){g()(e,t,D()(n,t))}))}return e}const J=new(X=class{constructor(){this.dirList=[],this.assetMap=new(b()),this.usedAssets=new(x()),this._open=!1,this._current=null,this._selectId=0,this.collKeys=new(x()),this._prefix="",this.loadLocal=async()=>{const e=await K.getIdb(),t=await e.getAll(W.Component);return C()(t).call(t,(e=>(0,G.RM)(e))),t},(0,z.ky)(this,{assetMap:!1,usedAssets:!1})}get selectId(){return this._selectId}set selectId(e){this._selectId=e}get open(){return this._open}set open(e){this._open=e}get current(){return this._current}set current(e){e?this._current?S()(this._current,e):this._current=(0,z.ZN)(e):this._current=null}startEditor(e,t){this.open=!0,this.current={code:t??L.fl,id:void 0,title:void 0,propertys:[]},this.selectId=e}toggleExpand(e){this.collKeys.has(e)?this.collKeys.delete(e):(this.collKeys.add(e),this.updateDirList(e)),this.collKeys=new(x())((0,z.ZN)(this.collKeys))}isExpand(e){return this.collKeys.has(e)}get prefix(){return this._prefix}set prefix(e){this._prefix=e}async updateDirList(e,t=this.dirList){R()(e)||(e=[e]);const i=new(b());for(const t of e){let e=await(0,q.fD)(k.fL.Component,t);e||(e=[]),i.set(t,e)}for(const e of t)if(i.has(e.id)){const t=[];for(const r of i.get(e.id)){const e=await(0,q.hr)(r.id),i=e.json_data;let n={};if(i){const e=JSON.parse(i);n=e.data,n.camera=e.camera,(0,G.RM)(Q(Q({},n),{},{id:r.id}))}t.push(Q(Q({},n),{},{id:r.id,title:r.name,preview:(0,Y.qm)(r,!0,!0),data:{id:r.id,component:!0,key:(0,G.d1)(r.id),name:r.name,modelId:r.uuid},moduleIds:e?.resources??""}))}(0,z.z)((()=>{e.children=t}))}(0,z.z)((()=>{this.dirList=t}))}getComponents(e=[]){return e?C()(e).call(e,(e=>{const t=JSON.parse(e.data.jsonData),i=t?.version?t.data:t;return(0,G.RM)(Q(Q({},i),{},{id:e.data.ID})),Q(Q({},i),{},{id:e.data.ID,title:e.title,preview:e.data.picUrl,data:{id:e.data.ID,component:!0,key:(0,G.d1)(e.data.ID),name:e.title}})})):[]}async loadUsedComponent(e=[]){for(const t of e){if((0,G.zJ)(t))continue;const e=await(0,q.Cq)(t);if(e){const i=JSON.parse(e).data;(0,G.RM)(Q(Q({},i),{},{id:t}))}}}addDir(){this.dirList.push({name:"\u65b0\u5efa\u76ee\u5f55",node_type:"dir",id:-1,editor:!0})}async handleDir(e){let t;t=-1===e.id?await(0,q.zs)({name:e.name,sourceType:k.fL.Component}):await(0,q.py)(e),t.code===U.Mx.Ok&&this.load()}startRenameDir(){for(const e of this.dirList)if(e.id===this._selectId)return void(e.editor=!0)}async deleteDir(){(await(0,U.QO)(k.au.delete,{data:{id:this._selectId}})).code===U.Mx.Ok&&(this.selectId=0,this.load())}async load(e){const t=await(0,q.fD)(k.fL.Component,0,e);t&&await this.updateDirList(M()(this.collKeys),t)}async addComponent(e,t,i){if(!this._selectId)return void N.y.error("\u6ca1\u9009\u62e9\u76ee\u5f55");(0,G.RM)(e);const r=await(0,q.cT)({name:e.title,jsonData:I()({version:1,data:this.getCompontData(e),camera:i}),sourceType:k.fL.Component,moduleIds:t,projectId:B.U.projectId,pid:this._selectId});return r.code===U.Mx.Ok?r.data?.[0]?.id:void 0}updateComponent(e,t){return(0,z.z)((async()=>{(0,G.RM)((0,z.ZN)(e));return(await(0,q.Dd)({id:e.id,name:e.title,sourceType:k.fL.Component,resources:e.moduleIds,json_data:I()({version:1,data:this.getCompontData(e),camera:t}),pid:this._selectId})).code===U.Mx.Ok}))}async deleteComponent(e){(0,G.jz)(e);(await(0,U.QO)(k.au.delete,{data:{id:e.id}})).code===U.Mx.Ok&&(this.load(),N.y.success("\u5220\u9664\u6210\u529f"))}getCompontData(e){return{code:e.code,propertys:e.propertys}}async getPrefix(){const e=await(0,U.ZL)(k.yy.prefix);e.code===U.Mx.Ok&&(this.prefix=e.data.prefix)}},(0,y.Z)(X.prototype,"isExpand",[z.Fl],D()(X.prototype,"isExpand"),X.prototype),X)},70485:(e,t,i)=>{var r,n=i(41843),s=i(39282),o=i.n(s),a=i(62750),h=i.n(a),l=i(14549),c=i.n(l),u=i(66989),d=i.n(u),p=i(13567),_=i.n(p),f=i(5996),g=i.n(f),m=i(26117),y=i.n(m),v=i(537),b=i(29115),w=i(57055),x=i(31025),T=i(6475),C=i(65492),E=i(54056),S=i(73554),P=i(19853),R=i(27660),A=i(93765),M=i(40652);new(r=class{constructor(){this.isOpenModal=!1,this.fileList=[],this.currentFileId=0,this.currentFileName="\u672a\u547d\u540d\u573a\u666f",this.loadingEntity={loading:!1,value:0},this.selectedModels=[],this.modelIds=new(o()),this.componentIds=new(o()),this.saveNewFile=null,this.selectFile={id:0,name:""},this.codeList=[],this.url2d="",this._editorScriptId=0,this._loading=!1,(0,x.ky)(this,{modelIds:!1,componentIds:!1,saveNewFile:!1});const e=new BroadcastChannel("preview_channel");e.addEventListener("message",(t=>{"load"===t.data&&e.postMessage({type:"data",data:E.gV.intance?.saveFile?.(),components:h()(this.componentIds)})}))}get Url2d(){return this.url2d}set Url2d(e){this.url2d=e}get loading(){return this._loading}set loading(e){this._loading=e}set SelectFile(e){c()(this.selectFile,e)}get editorScriptId(){return this._editorScriptId}set editorScriptId(e){this._editorScriptId=e}addUseModel(e){e&&this.modelIds.add(e)}async addFile(e,t){this.currentFileName=e;const i={title:e,id:-1,preview:"",data:{key:"file"}};this.saveNewFile?(t=this.saveNewFile,this.saveNewFile=null):(this.reset(),t||E.gV.intance.new());const r=await(0,C.yD)({name:e,pic_key:"icon.png",jsonData:d()({version:1,data:t,componentIds:h()(this.componentIds)}),sourceType:T.fL.Files,resources:h()(this.modelIds).join(","),projectId:A.U.projectId});return r.code===b.Mx.Ok?(i.id=r.data.id,i.preview=r.data.uuid+"/icon.png",await(0,C.aP)(r.data.id,(()=>E.gV.intance.Viewer.getPreviewUrl())),this.fileList.push(i),1===this.fileList.length&&this.setAppIndex(r.data.id),this.currentFileId=r.data.id,this.currentFileId):r.code===b.Mx.Error&&r.error?(S.y.error(r.error[0]),!1):void 0}async save(e=!0){const t=E.gV.intance.saveFile(),i={version:1,data:t,components:h()(this.componentIds),scripts:(0,x.ZN)(this.codeList),url2d:this.url2d};if(e&&this.currentFileId&&await(0,C.aP)(this.currentFileId,(()=>E.gV.intance.Viewer.getPreviewUrl())),this.currentFileId){for(const e of this.fileList)if(e.id===this.currentFileId)return(0,x.z)((async()=>{c()(e,{data:i,preview:e.preview+"?t="+_()()});return(await(0,C.KT)({id:this.currentFileId,jsonData:d()(i),name:this.currentFileName,resources:h()(this.modelIds).join(","),project_id:A.U.projectId})).code===b.Mx.Ok}))}else this.saveNewFile=t,this.isOpenModal=!0;return!1}async updateFileName(e,t=this.currentFileId){this.currentFileName=e;for(const i of this.fileList)if(i.id===t)return c()(i,{title:e}),(0,v.N)((async()=>(await(0,C.KT)({id:t,name:e,project_id:A.U.projectId})).code===b.Mx.Ok),300),!0;return!1}async load(e){this.reset(),this.currentFileId=e;const t=await(0,C.YZ)(e);if(t?.json_data){var i;this.currentFileName=t.name;const e=JSON.parse(t.json_data);this.url2d=e.url2d,this.componentIds=e.components?new(o())((0,x.ZN)(e.components)):new(o()),(0,x.LO)(this.codeList).replace(e.scripts??[]),g()(i=t.resources.split(",")).call(i,(e=>this.modelIds.add(e))),await R.l.loadUsedComponent(e.components),E.gV.intance.loadFile(e?.data??null)}}getIsSelect(e){return this.currentFileId===e}async loadFileList(e){this.fileList.length=0,this.loading=!0,await(0,x.gx)((()=>!!A.U.projectId));const t=await(0,C.yk)(A.U.projectId,e);if(this.loading=!1,t)return(0,x.z)((()=>{for(const e of t)e.file_key||this.fileList.push({id:e.id,title:e.name,preview:(0,P.qm)(e,!0),data:{key:"file"}})}))}async deleteFile(e){w.Utils.arrayRemoveIf(this.fileList,(t=>t.id===e)),this.currentFileId===e&&(this.currentFileId=void 0,(0,P.HY)("id",""),M.G.trigger({type:"Delete-File",target:null}));await(0,C.P2)(e)&&(this.SelectFile={id:0,name:""},S.y.success("\u5220\u9664\u6587\u4ef6\u6210\u529f"))}exportFile(){const e=E.gV.intance.saveFile();w.Utils.FileSystem.writeFile(this.currentFileName+".hc3d",d()({version:1,components:h()(this.componentIds),data:e,type:"hc3d"}))}importFile(){w.Utils.FileSystem.chooseFile({filter:"hc3d",callback:e=>{if(e[0]){const t=new FileReader;t.readAsText(e[0]),t.onload=e=>{try{const e=JSON.parse(t.result);"hc3d"===e.type&&(E.gV.intance.loadFile(e.data),this.componentIds=new(o())(e.components??[]))}catch(e){}}}}})}openModal(e=!1){e&&(this.currentFileId=void 0),this.isOpenModal=!0}closeModal(){this.isOpenModal=!1}setLoadProcess(e,t=0){c()(this.loadingEntity,{loading:e,value:t})}async copy(e,t){return(await(0,b.qu)(T.yy.copy,{src_id:e,project_id:t??A.U.projectId})).code===b.Mx.Ok}async move(e,t,i){if(i)return await this.copy(t,e);return(await(0,b.pz)(T.yy.update,{id:t,project_id:e})).code===b.Mx.Ok}async setAppIndex(e){(0,b.qu)(T.yy.preview,{id:e}).then((t=>{A.U.appIndexId=e}))}set SelectedModels(e){this.selectedModels=e}get SelectedModels(){return this.selectedModels}reset(){this.currentFileId=void 0,this.modelIds.clear(),this.codeList.length=0}appendCodeScript(e){this.codeList.push(e)}updateCodeScript(e){for(const t of this.codeList)t.id===e.id&&c()(t,e)}deleteScript(e){w.Utils.arrayRemoveIf(this.codeList,(t=>t.id===e))}},(0,n.Z)(r.prototype,"save",[x.aD],y()(r.prototype,"save"),r.prototype),(0,n.Z)(r.prototype,"load",[x.aD],y()(r.prototype,"load"),r.prototype),(0,n.Z)(r.prototype,"getIsSelect",[x.Fl],y()(r.prototype,"getIsSelect"),r.prototype),(0,n.Z)(r.prototype,"openModal",[x.aD],y()(r.prototype,"openModal"),r.prototype),(0,n.Z)(r.prototype,"setLoadProcess",[x.aD],y()(r.prototype,"setLoadProcess"),r.prototype),r)},93187:(e,t,i)=>{i.d(t,{E:()=>b});var r=i(31025);class n{constructor(){(0,r.ky)(this)}}var s=i(32849),o=i.n(s),a=i(58044),h=i.n(a),l=i(14549),c=i.n(l),u=i(66989),d=i.n(u),p=i(6475),_=i(29115),f=i(73554),g=i(93765);let m=1;class y{constructor(){this._open=!1,this.variables=[],this.oldOvariables=[],this.globalId=void 0,this.currentIndex=-1,(0,r.ky)(this,{oldOvariables:!1,globalId:!1})}get Open(){return this._open}set Open(e){e&&(this.oldOvariables=(0,r.ZN)(this.variables)),this._open=e}get CurrentIndex(){return this.currentIndex}set CurrentIndex(e){this.currentIndex=e}setVariable(e){(0,r.LO)(this.variables).replace(e)}add(){var e;let t="newVar"+m++;o()(e=this.variables).call(e,(e=>e.key===t))&&(t+="(1)"),this.currentIndex=this.variables.push({key:t,value:"",desc:""})-1}delete(){var e;this.currentIndex>=0&&(h()(e=this.variables).call(e,this.currentIndex,1),this.currentIndex=this.currentIndex-1<0?0:this.currentIndex-1)}update(e,t){var i;const r=o()(i=this.variables).call(i,(t=>t.key===e));r&&c()(r,t)}up(){const e=this.currentIndex;e>0&&([this.variables[e],this.variables[e-1]]=[this.variables[e-1],this.variables[e]],this.currentIndex-=1)}down(){const e=this.currentIndex;e<this.variables.length-1&&([this.variables[e],this.variables[e+1]]=[this.variables[e+1],this.variables[e]],this.currentIndex+=1)}confirm(){this._open=!1,this.save()}async load(e){const t=await(0,_.ZL)(p.U.detail+e);if(t.code===_.Mx.Ok&&t.data?.info){const e=t.data.info.variable;e&&(this.variables=JSON.parse(e))}}async save(){(await(0,_.pz)(p.U.edit,{id:g.U.projectId,variable:d()((0,r.ZN)(this.variables))})).code===_.Mx.Ok&&f.y.success("\u53d8\u91cf\u4fdd\u5b58\u6210\u529f")}cancel(){this.reset(),this._open=!1}reset(){(0,r.LO)(this.variables).replace(this.oldOvariables)}}new y;class v{constructor(){this._open=!1,this.cloudServices=void 0,this.currentIndex=-1,(0,r.ky)(this)}get Open(){return this._open}set Open(e){this._open=e}get CurrentIndex(){return this.currentIndex}set CurrentIndex(e){this.currentIndex=e}getCloudServices(){}add(){}delete(){}batchDelete(){}update(){}confirm(){this._open=!1}cancel(){this.reset(),this._open=!1}reset(){}}const b=new class{constructor(){this.globalVarStore=new y,this.dataBindStore=new n,this.cloudServicesStore=new v,(0,r.ky)(this)}}},92604:(e,t,i)=>{i.d(t,{LP:()=>s,gy:()=>o});i(97539),i(5996);var r=i(19082);const n="Admin-Token";function s(){return r.Z.get(n)}function o(){return r.Z.remove(n)}},40652:(e,t,i)=>{i.d(t,{G:()=>r});const r=new(i(57055).EventDispatcher)},3864:(e,t,i)=>{i.d(t,{Z:()=>n});var r=i(73231);const n=()=>{if(!r.l_.test(window.location.hostname)){let e=new Headers;e.append("pragma","no-cache"),e.append("cache-control","no-cache");let t={method:"GET",headers:e};fetch(location.origin+"/ver.txt",t).then((e=>{e.ok&&e.text().then((t=>{e.status&&t&&"1657434415709"!==t&&alert("\u60a8\u672c\u5730\u7f13\u5b58\u7248\u672c\u5df2\u8fc7\u671f,\u8bf7\u5f3a\u5236\u5237\u65b0\u6d4f\u89c8\u5668(Shift+F5)")}))}))}}},92513:(e,t,i)=>{i.d(t,{F:()=>r});const r=function(){var e=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy-]/g,(function(t){var i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?i:3&i|8).toString(16)}))}},12117:(e,t,i)=>{i.d(t,{RM:()=>h,d1:()=>o,jz:()=>l,uf:()=>c,zJ:()=>a});var r=i(34682),n=i.n(r),s=i(57055);function o(e){return`CustomComponent_${e}`}function a(e){const t=o(e);return s.HCFactory.isRegister(t)}function h(e){const{code:t,id:i,propertys:r,title:a}=e;if(!t)return;const h=function(e){if(e)try{return new Function("HC","return "+n()(e).call(e))(s)}catch(e){return null}}(t);h.type=o(i),h.Schema={title:a,propertys:r},s.RegisterComponent(h)}function l(e){s.UnRegisterComponent(o(e.id))}function c(e){return new Function("return "+n()(e).call(e))}},73231:(e,t,i)=>{i.d(t,{l_:()=>a});var r=i(39282),n=i.n(r);i(66989),i(17665),i(70485);const s=document.createElement("canvas");let o=!1;window.addEventListener("unload",(()=>{o=!0}));new(n());const a=/^[\d.:(localhost)]+$/;!function(){try{const e=s.getContext("experimental-webgl"),t=e.getExtension("WEBGL_debug_renderer_info");e.getParameter(t.UNMASKED_RENDERER_WEBGL)}catch(e){return""}}()},46266:(e,t,i)=>{i.d(t,{Z:()=>o});var r=i(6232),n=i.n(r);const s=window.location.origin+window.location.pathname,o=new(n().UserManager)({authority:"https://auth-trial.histron.cn/authcenter/oidc",client_id:"product-app",client_secret:"xyz",post_logout_redirect_uri:`${s}`,redirect_uri:s,response_type:"id_token token",scope:"email phone realname post",automaticSilentRenew:!0,accessTokenExpiringNotificationTime:10})},537:(e,t,i)=>{i.d(t,{N:()=>o});var r=i(29405),n=i.n(r);let s;function o(e,t=100){s&&clearTimeout(s),s=n()((()=>{e()}),t)}},83228:(e,t,i)=>{i.d(t,{_v:()=>a});var r=i(71722),n=i.n(r),s=i(29405),o=i.n(s);i(52069),i(97539),i(17349),i(34682),i(57055);function a(e){return new(n())((t=>o()(t,e)))}},57055:(e,t,i)=>{i.r(t),i.d(t,{ActionManagerType:()=>pe,AppConfig:()=>fe,AppEvent:()=>he,AppStore:()=>ge,Application:()=>Gn,ArcRotateCameraControl:()=>ln,BaseCamera:()=>an,BaseDom:()=>ve,BaseGui:()=>we,BaseObject:()=>L,BaseTextureRecord:()=>zr,BaseWidget:()=>kr,Box:()=>Hn,CMD:()=>as,CameraEnable:()=>q,CameraManager:()=>un,CameraType:()=>xr,CameraViewMode:()=>Y,CanvasControl:()=>zs,Capsule:()=>Qn,CenterType:()=>Q,CesiumViewer:()=>h,CompareType:()=>ee,Component:()=>Nr,ConeEmitter:()=>Qs,Control:()=>s.Control,CustomArcRotateCameraPointersInput:()=>hn,Cylinder:()=>Yn,CylinderEmitter:()=>Zs,DataBind:()=>Ls,DataBindType:()=>Fs,DataCondition:()=>ls,Database:()=>Dn,DirectedCylinder:()=>Js,DirectionalLight:()=>is,EConditionType:()=>J,Editor:()=>tn,Emiter:()=>Hs,EmiterShape:()=>Gs,EmiterType:()=>Vs,Entity:()=>_e,EventDispatcher:()=>I,Factory:()=>E,FilePreviewer:()=>jn,FreeCameraControl:()=>cn,Ground:()=>$n,GroupRecord:()=>ro,HCFactory:()=>C,HCFiler:()=>D,HemisphericEmiter:()=>Ys,HemisphericLight:()=>Bn,HighlightManager:()=>rn,History:()=>Ws,ISPROXYKEY:()=>Fr,ImportEntity:()=>ye,Interaction:()=>Ds,Light:()=>Ln,Lines:()=>Xn,MoveAction:()=>cs,MoveType:()=>$,MultiLine2:()=>be,ObjectId:()=>F,PBRMaterialRecord:()=>Un,Particle:()=>bn,ParticleSystem:()=>$s,ParticleSystemGroup:()=>io,Plane:()=>Zn,PointLight:()=>es,PointTypeEnum:()=>de,PointerEventTypes:()=>n.PointerEventTypes,RadiusEmiter:()=>Ks,RainParticleSystem:()=>to,RegisterComponent:()=>S,RenderType:()=>u,SceneControl:()=>gn,SceneHelper:()=>yn,SelectType:()=>X,SkyboxMode:()=>te,SnowParticleSystem:()=>eo,Solid3D:()=>Wn,Sphere:()=>qn,SphereEmiter:()=>Xs,SpotLight:()=>ts,StackPanelGui:()=>Bs,StandardMaterialRecord:()=>hs,SubEmitter:()=>qs,TextureRecord:()=>zn,Torus:()=>Jn,TransformMode:()=>Z,UnRegisterComponent:()=>P,Utils:()=>ie,Video:()=>ks,VideoGui:()=>Us,Viewer:()=>vn,autoRecord:()=>Br,autoUpdate:()=>Lr,begin:()=>Or,defineProperty:()=>Dr,end:()=>Ir,getFunctionName:()=>Ar});var r=i(64595),n=i(2851),s=i(17217),o=i(77889);i(58603),i(65301),i(5515);class a{constructor(e){this.show=!0,this.viewer=e.viewer,this.height=e.height,this.position=r.Cartesian3.fromDegrees(e.position[0],e.position[1],e.height),this.div||(this.div=document.createElement("div"),this.addLabel(e))}addLabel(e){this.div.id=e.id,this.div.style.position="absolute",this.div.style.width="100px",this.div.style.height="30px",e=`<div>${e.title}</div>`,this.div.innerHTML=e,this.viewer.cesiumWidget.container.appendChild(this.div),this.addPostRender()}addPostRender(){this.viewer.scene.postRender.addEventListener(this.postRender,this)}postRender(){var e=this.viewer.scene.canvas.height,t=new r.Cartesian2;r.SceneTransforms.wgs84ToWindowCoordinates(this.viewer.scene,this.position,t),this.div.style.bottom=e-t.y+100+"px",e=this.div.offsetWidth,this.div.style.left=t.x-e/2+"px",t=this.viewer.camera.position,e=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(t).height;e+=this.viewer.scene.globe.ellipsoid.maximumRadius,!(r.Cartesian3.distance(t,this.position)>e)&&this.viewer.camera.positionCartographic.height<5e7&&!0===this.show?this.div.style.display="block":this.div.style.display="none"}}class h{constructor(){this.open=!1}static getSurfaceArea(e){if(e.length<3)return 0;var[t,i,r]=[e[0].x,e[0].y,e[0].z],[n,s,o]=[e[1].x,e[1].y,e[1].z],[a,h,l]=[e[2].x,e[2].y,e[2].z];const c=Math.pow;var o,u=c((s-i)*(l-r)-(h-i)*(o-r),2)+c((a-t)*(o-r)-(n-t)*(l-r),2)+c((n-t)*(h-i)-(a-t)*(s-i),2),d=((s-i)*(l-r)-(h-i)*(o-r))/c(u,.5),p=((a-t)*(o-r)-(n-t)*(l-r))/c(u,.5),_=((n-t)*(h-i)-(a-t)*(s-i))/c(u,.5);let f=_*((o=e[e.length-1]).x*i-t*o.y)+d*(o.y*r-i*o.z)+p*(o.z*t-r*o.x);for(let t=0;t<e.length-1;t++){var g=e[t],m=e[t+1];f+=m=_*(g.x*m.y-m.x*g.y)+d*(g.y*m.z-m.y*g.z)+p*(g.z*m.x-m.z*g.x)}return Math.abs(f/2)}get CameraHeight(){return this.viewer.camera.positionCartographic.height}init(e){window.Cesium=r,this.open=!0,this.container=e;const t=this.viewer=new r.Viewer(this.container,{fullscreenButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,timeline:!0,navigationHelpButton:!1,shouldAnimate:!1,useDefaultRenderLoop:!0,baseLayerPicker:!1,animation:!0});t.scene.screenSpaceCameraController.lookEventTypes={eventType:r.CameraEventType.MIDDLE_DRAG,modifier:r.KeyboardEventModifier.ALT},t.cesiumWidget.creditContainer.remove(),this.register()}createDivLabel(e){return new a(e)}flyTo(e,t){this.viewer.camera.flyTo({destination:r.Cartesian3.fromDegrees(e.x,e.y,e.z),orientation:t})}openViewer(){this.open=!0,this.container&&(this.container.style.display="block")}close(){this.open&&(this.container.style.display="none",this.open=!1)}moveBackward(e){this.viewer.camera.moveBackward(e)}getFlyMaterial(e=0){var t=new r.Material({fabric:{uniforms:{color:r.Color.DEEPSKYBLUE,speed:70},source:"\n                vec4 getColor(){\n                    return color;\n                }\n                float getSpeed(){\n                   return speed;\n                }"}});return new r.PolylineMaterialAppearance({material:t,translucent:!0,vertexShaderSource:"\n#define CLIP_POLYLINE \nvoid clipLineSegmentToNearPlane(\n    vec3 p0,\n    vec3 p1,\n    out vec4 positionWC,\n    out bool clipped,\n    out bool culledByNearPlane,\n    out vec4 clippedPositionEC)\n{\n    culledByNearPlane = false;\n    clipped = false;\n    vec3 p0ToP1 = p1 - p0;\n    float magnitude = length(p0ToP1);\n    vec3 direction = normalize(p0ToP1);\n    float endPoint0Distance =  czm_currentFrustum.x + p0.z;\n    float denominator = -direction.z;\n    if (endPoint0Distance > 0.0 && abs(denominator) < czm_epsilon7)\n    {\n        culledByNearPlane = true;\n    }\n    else if (endPoint0Distance > 0.0)\n    {\n        float t = endPoint0Distance / denominator;\n        if (t < 0.0 || t > magnitude)\n        {\n            culledByNearPlane = true;\n        }\n        else\n        {\n            p0 = p0 + t * direction;\n            p0.z = min(p0.z, -czm_currentFrustum.x);\n            clipped = true;\n        }\n    }\n    clippedPositionEC = vec4(p0, 1.0);\n    positionWC = czm_eyeToWindowCoordinates(clippedPositionEC);\n}\nvec4 getPolylineWindowCoordinatesEC(vec4 positionEC, vec4 prevEC, vec4 nextEC, float expandDirection, float width, bool usePrevious, out float angle)\n{\n    #ifdef POLYLINE_DASH\n    vec4 positionWindow = czm_eyeToWindowCoordinates(positionEC);\n    vec4 previousWindow = czm_eyeToWindowCoordinates(prevEC);\n    vec4 nextWindow = czm_eyeToWindowCoordinates(nextEC);\n    vec2 lineDir;\n    if (usePrevious) {\n        lineDir = normalize(positionWindow.xy - previousWindow.xy);\n    }\n    else {\n        lineDir = normalize(nextWindow.xy - positionWindow.xy);\n    }\n    angle = atan(lineDir.x, lineDir.y) - 1.570796327;\n    angle = floor(angle / czm_piOverFour + 0.5) * czm_piOverFour;\n    #endif\n    vec4 clippedPrevWC, clippedPrevEC;\n    bool prevSegmentClipped, prevSegmentCulled;\n    clipLineSegmentToNearPlane(prevEC.xyz, positionEC.xyz, clippedPrevWC, prevSegmentClipped, prevSegmentCulled, clippedPrevEC);\n    vec4 clippedNextWC, clippedNextEC;\n    bool nextSegmentClipped, nextSegmentCulled;\n    clipLineSegmentToNearPlane(nextEC.xyz, positionEC.xyz, clippedNextWC, nextSegmentClipped, nextSegmentCulled, clippedNextEC);\n    bool segmentClipped, segmentCulled;\n    vec4 clippedPositionWC, clippedPositionEC;\n    clipLineSegmentToNearPlane(positionEC.xyz, usePrevious ? prevEC.xyz : nextEC.xyz, clippedPositionWC, segmentClipped, segmentCulled, clippedPositionEC);\n    if (segmentCulled)\n    {\n        return vec4(0.0, 0.0, 0.0, 1.0);\n    }\n    vec2 directionToPrevWC = normalize(clippedPrevWC.xy - clippedPositionWC.xy);\n    vec2 directionToNextWC = normalize(clippedNextWC.xy - clippedPositionWC.xy);\n    if (prevSegmentCulled)\n    {\n        directionToPrevWC = -directionToNextWC;\n    }\n    else if (nextSegmentCulled)\n    {\n        directionToNextWC = -directionToPrevWC;\n    }\n    vec2 thisSegmentForwardWC, otherSegmentForwardWC;\n    if (usePrevious)\n    {\n        thisSegmentForwardWC = -directionToPrevWC;\n        otherSegmentForwardWC = directionToNextWC;\n    }\n    else\n    {\n        thisSegmentForwardWC = directionToNextWC;\n        otherSegmentForwardWC =  -directionToPrevWC;\n    }\n    vec2 thisSegmentLeftWC = vec2(-thisSegmentForwardWC.y, thisSegmentForwardWC.x);\n    vec2 leftWC = thisSegmentLeftWC;\n    float expandWidth = width * 0.5;\n    if (!czm_equalsEpsilon(prevEC.xyz - positionEC.xyz, vec3(0.0), czm_epsilon1) && !czm_equalsEpsilon(nextEC.xyz - positionEC.xyz, vec3(0.0), czm_epsilon1))\n    {\n        vec2 otherSegmentLeftWC = vec2(-otherSegmentForwardWC.y, otherSegmentForwardWC.x);\n        vec2 leftSumWC = thisSegmentLeftWC + otherSegmentLeftWC;\n        float leftSumLength = length(leftSumWC);\n        leftWC = leftSumLength < czm_epsilon6 ? thisSegmentLeftWC : (leftSumWC / leftSumLength);\n        vec2 u = -thisSegmentForwardWC;\n        vec2 v = leftWC;\n        float sinAngle = abs(u.x * v.y - u.y * v.x);\n        expandWidth = clamp(expandWidth / sinAngle, 0.0, width * 2.0);\n    }\n    vec2 offset = leftWC * expandDirection * expandWidth * czm_pixelRatio;\n    return vec4(clippedPositionWC.xy + offset, -clippedPositionWC.z, 1.0) * (czm_projection * clippedPositionEC).w;\n}\nvec4 getPolylineWindowCoordinates(vec4 position, vec4 previous, vec4 next, float expandDirection, float width, bool usePrevious, out float angle)\n{\n    vec4 positionEC = czm_modelViewRelativeToEye * position;\n    vec4 prevEC = czm_modelViewRelativeToEye * previous;\n    vec4 nextEC = czm_modelViewRelativeToEye * next;\n    return getPolylineWindowCoordinatesEC(positionEC, prevEC, nextEC, expandDirection, width, usePrevious, angle);\n}\n\nattribute vec3 position3DHigh;\nattribute vec3 position3DLow;\nattribute vec3 prevPosition3DHigh;\nattribute vec3 prevPosition3DLow;\nattribute vec3 nextPosition3DHigh;\nattribute vec3 nextPosition3DLow;\nattribute vec2 expandAndWidth;\nattribute vec2 st;\n\nattribute float batchId;\n\nvarying float v_width;\nvarying vec2 v_st;\nvarying float v_polylineAngle;\n\nvarying vec4 v_positionEC;\nvarying vec3 v_normalEC;\n\n\n\nvoid main()\n{\nfloat expandDir = expandAndWidth.x;\nfloat width = abs(expandAndWidth.y) + 0.5;\nbool usePrev = expandAndWidth.y < 0.0;\n\nvec4 p = czm_computePosition();\nvec4 prev = czm_computePrevPosition();\nvec4 next = czm_computeNextPosition();\n\nfloat angle;\nvec4 positionWC = getPolylineWindowCoordinates(p, prev, next, expandDir, width, usePrev, angle);\ngl_Position = czm_viewportOrthographic * positionWC;\n\nv_width = width;\nv_st.s = st.s;\nv_st.t = st.t;\n// v_st.t = czm_writeNonPerspective(st.t, gl_Position.w);\nv_polylineAngle = angle;\n\n\n\nvec4 eyePosition = czm_modelViewRelativeToEye * p;\nv_positionEC =  czm_inverseModelView * eyePosition;      // position in eye coordinates\n//v_normalEC = czm_normal * normal;                         // normal in eye coordinates\n}\n\n",fragmentShaderSource:1===(t=e)?"         \nvarying vec2 v_st;    \nvarying float v_width;    \nvarying float v_polylineAngle;\nvarying vec4 v_positionEC;\nvarying vec3 v_normalEC;\nvarying vec4 v_color;\nvoid main()\n{\n    vec2 st = v_st;\n\n    float num = 4.0;\n    float speed=getSpeed();\n    vec4 color=getColor();\n    float xx = fract(st.s - czm_frameNumber/speed);\n    float r = color.r;\n    float g =color.g*xx;\n    float b = color.b*xx;\n    float a = xx*color.a;\n    if(fract(st.s*num/4.0 - czm_frameNumber/240.0)<0.75){\n        a=0.0;\n    }\n\n    gl_FragColor = vec4(r,g,b,a);\n}\n\n":2===t?"         \nvarying vec2 v_st;    \nvarying float v_width;    \nvarying float v_polylineAngle;\nvarying vec4 v_positionEC;\nvarying vec3 v_normalEC;\nvoid main()\n{\n    vec2 st = v_st;\n\n    // \u4e03\u5f69\u6e10\u53d8\u98de\u7ebf,\u5bbd\u5ea62\n    float xx = fract(st.s*2.0 - czm_frameNumber/60.0);\n    float r = xx;\n    float g = sin(czm_frameNumber/30.0);\n    float b = cos(czm_frameNumber/30.0);\n    float a = xx;\n\n    gl_FragColor = vec4(r,g,b,a);\n}":3===t?"\nvarying vec2 v_st;    \nvarying float v_width;    \nvarying float v_polylineAngle;\nvarying vec4 v_positionEC;\nvarying vec3 v_normalEC;\nvoid main()\n{\n    vec2 st = v_st;\n    \n    //\u5361\u5df4\u65af\u57fa\n    float xx = sin(st.s*6.0 -czm_frameNumber/5.0) - cos(st.t*6.0);\n    float r = 0.0;\n    float g = xx;\n    float b = xx;\n    float a = xx;\n\n    gl_FragColor = vec4(r,g,b,a);\n}\n":4===t?"\nvarying vec2 v_st;    \nvarying float v_width;    \nvarying float v_polylineAngle;d\nvarying vec4 v_positionEC;\nvarying vec3 v_normalEC;\nvoid main()\n{\n    vec2 st = v_st;\n    // \u7bad\u5934\u98de\u7ebf\uff0c\u5bbd\u5ea6 8\n    float xx = fract(st.s*10.0 + st.t  - czm_frameNumber/60.0);\n    if (st.t<0.5) {\n        xx = fract(st.s*10.0 - st.t - czm_frameNumber/60.0);\n    }\n\n    vec4 color=getColor();\n    float r = color.r;\n    float g =color.g*xx;\n    float b = color.b*xx;\n    float a = xx*color.a;\n\n    // \u98de\u7ebf\u8fb9\u6846\n    if (st.t>0.8||st.t<0.2) {\n        g = 1.0;\n        b = 1.0;\n        a = 0.4;\n    }\n\n    gl_FragColor = vec4(r,g,b,a);\n}\n":"         \n varying vec2 v_st;    \n varying float v_width;    \n varying float v_polylineAngle;\n varying vec4 v_positionEC;\n varying vec3 v_normalEC;\n\n void main()\n {\n     vec2 st = v_st;\n     float speed=getSpeed();\n     vec4 color=getColor();\n     float xx = fract(st.s - czm_frameNumber/speed);\n     float r = color.r;\n     float g =color.g*xx;\n     float b = color.b*xx;\n     float a = xx*color.a;\n\n     gl_FragColor = vec4(r,g,b,a);\n }\n\n"})}createPolyline(e,t,i){return e=new r.PolylineGeometry({positions:e,width:i}),i=Date.now(),e=new r.GeometryInstance({geometry:e,id:+i}),this.viewer.scene.primitives.add(new r.Primitive({geometryInstances:[e],appearance:t,releaseGeometryInstances:!1,compressVertices:!1}))}loadClounds(){var e=new r.Material({fabric:{type:"CloudMaterial",uniforms:{image:"https://am-img.gkiiot.com/editor/textures/map.png",speed:5e3,repeat:new r.Cartesian2(1,1),color:new r.Color(1,1,1,.5)},source:"\nczm_material czm_getMaterial(czm_materialInput materialInput)\n{\n     czm_material material = czm_getDefaultMaterial(materialInput);\n     float t=czm_frameNumber/speed;\n     vec2 st = materialInput.st;\n     vec4 colorImage = texture2D(image,vec2(fract(st.s + t),fract(st.t)));\n     material.alpha = colorImage.a * color.a  ;\n     material.diffuse =    color.rgb  ;\n     return material;\n }"}});return e=this.viewer.scene.primitives.add(new r.Primitive({geometryInstances:new r.GeometryInstance({geometry:new r.RectangleGeometry({rectangle:r.Rectangle.fromDegrees(-180,-90,180,90),vertexFormat:r.EllipsoidSurfaceAppearance.VERTEX_FORMAT})}),appearance:new r.EllipsoidSurfaceAppearance({material:e,translucent:!0})}))}pa(){}render(){this.viewer&&this.open&&this.viewer.render()}destory(){this.viewer&&this.viewer.destroy()}wheelEvent(e,t){}readFile(e){e.read()}writeFile(e){e.write(1)}leftClickEvent(e,t){}register(){const e=new r.ScreenSpaceEventHandler(this.viewer.scene.canvas);e.setInputAction((e=>{r.Color.fromCssColorString;var t=this.viewer.camera.positionCartographic.height;this.wheelEvent(t,e)}),r.ScreenSpaceEventType.WHEEL),e.setInputAction((e=>{var t=this.viewer.scene.pick(e.position);this.leftClickEvent(t,e)}),r.ScreenSpaceEventType.LEFT_CLICK)}test(){const e=new r.Material({fabric:{type:"ColorMaterial",uniforms:{speed:5e3,repeat:new r.Cartesian2(1,1),color:new r.Color(0,1,0,.4),image:"https://am-img.gkiiot.com/editor/textures/colors1.png",time:1},source:"\n        czm_material czm_getMaterial(czm_materialInput materialInput)\n        {\n          czm_material material = czm_getDefaultMaterial(materialInput);\n          vec2 st = materialInput.st;\n          vec4 colorImage = texture2D(image, vec2(fract((st.s - czm_frameNumber/60.0)), fract((st.t - czm_frameNumber/60.0))));\n          vec4 fragColor;\n          fragColor.rgb = (colorImage.rgb+color.rgb) / 1.0;\n          fragColor = czm_gammaCorrect(fragColor);\n          material.alpha = colorImage.a * color.a;\n          material.diffuse = (colorImage.rgb+color.rgb)/2.0;\n          material.emission = fragColor.rgb;\n          return material;\n          }"}});let t=new window.AMap.DistrictSearch({subdistrict:0,extensions:"all",level:"province"}),i=["\u4e2d\u56fd"];for(let n=0;n<i.length;n++)t.search(i[n],((t,i)=>{var n=i.districtList[0].boundaries.length;for(let t=0;t<n;t++){let n=[];i.districtList[0].boundaries[t].forEach((e=>{n.push(r.Cartesian3.fromDegrees(e.lng,e.lat,1e4))}));var s=new r.PolygonGeometry({polygonHierarchy:new r.PolygonHierarchy(n)});s=(r.PolygonGeometry.createGeometry(s),new r.GeometryInstance({geometry:s}));this.viewer.scene.primitives.add(new r.Primitive({geometryInstances:s,appearance:new r.EllipsoidSurfaceAppearance({material:e})}))}}))}}var l=function(e,t){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(e,t)};function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}l(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var u,d,p,_,f,g,m=function(){return(m=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function y(e,t,i,r){var n,s=arguments.length,o=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(o=(s<3?n(o):3<s?n(t,i,o):n(t,i))||o);return 3<s&&o&&Object.defineProperty(t,i,o),o}function v(e,t,i,r){return new(i=i||Promise)((function(n,s){function o(e){try{h(r.next(e))}catch(e){s(e)}}function a(e){try{h(r.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):((t=e.value)instanceof i?t:new i((function(e){e(t)}))).then(o,a)}h((r=r.apply(e,t||[])).next())}))}function b(e,t){var i,r,n,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},o={next:a(0),throw:a(1),return:a(2)};return"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){var h=[o,a];if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,r&&(n=2&h[0]?r.return:h[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,h[1])).done)return n;switch(r=0,(h=n?[2&h[0],n.value]:h)[0]){case 0:case 1:n=h;break;case 4:return s.label++,{value:h[1],done:!1};case 5:s.label++,r=h[1],h=[0];continue;case 7:h=s.ops.pop(),s.trys.pop();continue;default:if(!(n=0<(n=s.trys).length&&n[n.length-1])&&(6===h[0]||2===h[0])){s=0;continue}if(3===h[0]&&(!n||h[1]>n[0]&&h[1]<n[3])){s.label=h[1];break}if(6===h[0]&&s.label<n[1]){s.label=n[1],n=h;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(h);break}n[2]&&s.ops.pop(),s.trys.pop();continue}h=t.call(e,s)}catch(a){h=[6,a],r=0}finally{i=n=0}if(5&h[0])throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}}}class w extends n.BoundingBox{static GetCenterFromPoints(e){if(e.length<=1)return e[0];var t=x(e[0],e[1]),i=T(e[0],e[1]);const r=new w(t,i);return 2<e.length&&r.setFromPoints(e.slice(2)),r.center}constructor(e=n.Vector3.Zero(),t=n.Vector3.Zero(),i){super(e,t,i)}union(e){const t=this.minimumWorld.clone();var i=e.minimumWorld.clone();t.set(Math.min(t.x,i.x),Math.min(t.y,i.y),Math.min(t.z,i.z));const r=this.maximumWorld.clone();return i=e.maximumWorld.clone(),r.set(Math.max(r.x,i.x),Math.max(r.y,i.y),Math.max(r.z,i.z)),this.reConstruct(t,r),this}get Size(){var e=this.extendSize;return{x:2*e.x,y:2*e.y,z:2*e.z}}expandByPoint(e){return this.min(this.minimum,e),this.max(this.maximum,e),this}setFromPoints(e){for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this.reConstruct(this.minimum,this.maximum,this.getWorldMatrix()),this}min(e,t){return e.x=Math.min(e.x,t.x),e.y=Math.min(e.y,t.y),e.z=Math.min(e.z,t.z),this}max(e,t){return e.x=Math.max(e.x,t.x),e.y=Math.max(e.y,t.y),e.z=Math.max(e.z,t.z),this}}function x(e,t){const i=new n.Vector3;return i.x=Math.min(e.x,t.x),i.y=Math.min(e.y,t.y),i.z=Math.min(e.z,t.z),i}function T(e,t){const i=new n.Vector3;return i.x=Math.max(e.x,t.x),i.y=Math.max(e.y,t.y),i.z=Math.max(e.z,t.z),i}class C{constructor(){this.objectNameMap=new Map}static RegisterObject(e){var t=e.type||e.name;this.factory.objectNameMap.has(t)||this.factory.objectNameMap.set(t,e)}static RegisterObjectAlias(e,t){this.factory.objectNameMap.set(t,e)}static CreateObject(e,t){let i=this.factory.objectNameMap.get(e);if(i)return new i(t)}static RegisterComponent(e){this.factory.objectNameMap.set(e.type,e)}static RemoveComponent(e){this.factory.objectNameMap.delete(e)}static isRegister(e){return this.factory.objectNameMap.has(e)}}function E(e){C.RegisterObject(e)}function S(e){C.RegisterComponent(e)}function P(e){C.RemoveComponent(e)}C.factory=new C;class R{constructor(e=!0){this.isErase=e}readFile(e){return this.isErase=e.read(),this}writeFile(e){return e.write(this.isErase),this}}function A(e){return e[e.length-1]}function M(e,t){let i=0;for(let r=0,n=e.length;r<n;r++)e[r]!==t&&(e[i++]=e[r]);return e.length=i,e}function O(e,t){let i=0;for(let r=0,n=e.length;r<n;r++)t(e[r])||(e[i++]=e[r]);return e.length=i,e}(g=u=u||{})[g.Wireframe=1]="Wireframe",g[g.Conceptual=2]="Conceptual",g[g.Physical=3]="Physical";class I{constructor(){this._listeners=new Map}on(e,t,i){let r=this._listeners.get(e);return r||(r=[],this._listeners.set(e,r)),-1===r.indexOf(t)&&(i&&(t.__customOption__=i),r.push(t)),()=>this.off(e,t)}once(e,t,i){return t.__isOnce__=!0,this.on(e,t,i)}hasEventListener(e,t){let i=this._listeners.get(e);return!!i&&-1!==i.indexOf(t)}off(e,t){let i=this._listeners.get(e);i&&-1!==(e=i.indexOf(t))&&i.splice(e,1)}trigger(e){var t;let i=this._listeners.get(e.type);if(i){e.target||(e.target=this);const n=i.slice(0);for(let i=0,s=n.length;i<s;i++){var r=n[i].__customOption__;r&&(r.userData&&(e.data=r.userData),null==(t=r.condition)||!t.call(r,e))||n[i].call(this,e)}O(i,(e=>e.__isOnce__))}}}class F{constructor(e=-1,t){this.index=e,this.object=t}get isErase(){return!this.object||this.object.IsErase}set Object(e){this.object=e}get Object(){return this.object}get Index(){return this.index}}class D{constructor(e=[]){this._datas=e,this.readIndex=0}get Data(){return this._datas}set Data(e){this._datas=e,this.reset()}clear(){return this._datas.length=0,this.reset()}reset(){return this.readIndex=0,this}write(e){return e instanceof F?this._datas.push(e.Index):this._datas.push(e),this}read(){return this._datas[this.readIndex++]}writeObjectId(e){return e?this.write(e.Index):this.write(0),this}readObjectId(){var e=this.read();if(this.database)return this.database.getObjectId(e)}writeObject(e){if(e)return this.writeString(e.constructor.type||e.constructor.name),e.writeFile(this),this;this.write("")}readObject(e){let t=this.readString();if(t)return void 0===e&&(!(e=C.CreateObject(t))&&t.startsWith("CustomComponent")&&(e=C.CreateObject("Component")),void 0!==this.database&&"_SetDefaultDb"in e&&e._SetDefaultDb(this.database)),e.readFile(this),e}writeString(e){return this._datas.push(e),this}readString(){return this._datas[this.readIndex++]}writeArray(e){this.write(e.length);for(const t of e)this.write(t)}readArray(e){var t=this._datas.slice(this.readIndex,this.readIndex+e);return this.readIndex+=e,t}writeAnyArray(e,t){this.write(e.length);for(const i of e)t.call(this,i)}readAnyArray(e){var t=this.read();for(let i=0;i<t;i++)e.call(this)}readAnyArrayAndPush(e,t){e.length=0;var i=this.read();for(let n=0;n<i;n++){var r=t.call(this);e.push(r)}}writeWidgetValue(e){this.write(null==e?void 0:e.type),"entity"===(null==e?void 0:e.type)?this.writeObjectId(null==e?void 0:e.value):this.write(null==e?void 0:e.value),this.write(null==e?void 0:e.entityKey)}readWidgetValue(e){e.type=this.read(),"entity"===e.type?e.value=this.readObjectId():e.value=this.read(),e.entityKey=this.read()}writeVector3(e){this.write(e.x),this.write(e.y),this.write(e.z)}readVector3(e){e.x=this.read(),e.y=this.read(),e.z=this.read()}}class L extends I{constructor(){super(...arguments),this._ver=1,this._erase=!1}set Owner(e){this._Owner=e}get Owner(){return this._Owner}get IsErase(){return this._erase}get ObjectId(){return this._id}set ObjectId(e){this._id=e}get Id(){var e;return null==(e=this._id)?void 0:e.Index}get DB(){return this._db}get Name(){return this._name}get Type(){return this.constructor.type}erase(e=!0){if(this._erase!==e){this._erase=e;const t=this.UndoRecord;t&&t.createEraseHistory(this,e)}}clone(){const e=new this.constructor;var t=new D;return this.writeFile(t),e.readFile(t),e._id=null,e}destory(){this._db=void 0}writeFile(e){e.write(this._ver),e.writeObjectId(this._id),e.write(this._erase),e.writeObjectId(this._Owner)}readFile(e){this._ver=e.read();var t=e.readObjectId();!this._id&&t&&(this._id=t,this._id.Object=this),this._erase=e.read(),this._Owner=e.readObjectId()}_SetOwnerDatabase(e){return this._db||(this._db=e,this._id=e.allocateId(),this._id.Object=this),this}_SetDefaultDb(e){return this._db||(this._db=e),this}_SetDatabase(e){this._db=e}_applyHistoryRecord(e){e instanceof R&&(this._erase=e.isErase)}get UndoRecord(){if(this._db)return this._db.HistoryManager.LastCmdRecord}writeSnapshoot(){const e=this.UndoRecord;e&&e.writeObjectSnapshoot(this)}}class B{constructor(e){this.filer=new D,e&&(this.filer.database=e.DB,e.writeFile(this.filer))}get Filer(){const e=new D(this.filer.Data);return e.database=this.filer.database,e}readFile(e){e.read(),this.filer.Data=e.read(),this.filer.reset()}writeFile(e){e.write(1),e.write(this.filer.Data)}}function N(e){for(var t,i;e&&(null==(t=e.metadata)||!t.Entity);)e=e.parent;return null==(i=null==e?void 0:e.metadata)?void 0:i.Entity}function k(e){for(;e.parent;)e=e.parent;return e}function U(e,t,i=1e-5){return Math.abs(e-t)<=i}function z(e){return new Promise((t=>setTimeout(t,e)))}function G(e){var t=e.split(",")[0].split(":")[1].split(";")[0];const i=atob(e.split(",")[1]);e=new ArrayBuffer(i.length);const r=new Uint8Array(e);for(let e=0;e<i.length;e++)r[e]=i.charCodeAt(e);return new Blob([r],{type:t})}function V(e,t){for(const i in e){if(!t.hasOwnProperty(i))return!1;if(e[i]!==t[i])return!1}return!0}function j(e,t,i){if(void 0===i)return e;var r=new RegExp("([?&])"+t+"=.*?(&|$)","i"),n=-1!==e.indexOf("?")?"&":"?";return e.match(r)?e.replace(r,"$1"+t+"="+i+"$2"):e+n+t+"="+i}function W(e){return n.Tools.ToRadians(e)}!function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right"}(d=d||{}),function(e){e[e.Digit1=49]="Digit1",e[e.Digit2=50]="Digit2",e[e.Digit3=51]="Digit3",e[e.Digit4=52]="Digit4",e[e.Digit5=53]="Digit5",e[e.Digit6=54]="Digit6",e[e.Digit7=55]="Digit7",e[e.Digit8=56]="Digit8",e[e.Digit9=57]="Digit9",e[e.Digit0=58]="Digit0",e[e.KeyA=65]="KeyA",e[e.KeyB=66]="KeyB",e[e.KeyC=67]="KeyC",e[e.KeyD=68]="KeyD",e[e.KeyE=69]="KeyE",e[e.KeyF=70]="KeyF",e[e.KeyG=71]="KeyG",e[e.KeyH=72]="KeyH",e[e.KeyI=73]="KeyI",e[e.KeyJ=74]="KeyJ",e[e.KeyK=75]="KeyK",e[e.KeyL=76]="KeyL",e[e.KeyM=77]="KeyM",e[e.KeyN=78]="KeyN",e[e.KeyO=79]="KeyO",e[e.KeyP=80]="KeyP",e[e.KeyQ=81]="KeyQ",e[e.KeyR=82]="KeyR",e[e.KeyS=83]="KeyS",e[e.KeyT=84]="KeyT",e[e.KeyU=85]="KeyU",e[e.KeyV=86]="KeyV",e[e.KeyW=87]="KeyW",e[e.KeyX=88]="KeyX",e[e.KeyY=89]="KeyY",e[e.KeyZ=90]="KeyZ",e[e.Comma=188]="Comma",e[e.CommaChrome=229]="CommaChrome",e[e.Period=190]="Period",e[e.Semicolon=186]="Semicolon",e[e.Quote=222]="Quote",e[e.BracketLeft=219]="BracketLeft",e[e.BracketRight=220]="BracketRight",e[e.Backquote=192]="Backquote",e[e.Backslash=220]="Backslash",e[e.Minus=189]="Minus",e[e.Equal=187]="Equal",e[e.IntlRo=193]="IntlRo",e[e.IntlYen=255]="IntlYen",e[e.Alt=18]="Alt",e[e.CapsLock=20]="CapsLock",e[e.Control=17]="Control",e[e.OSLeft=91]="OSLeft",e[e.OSRight=92]="OSRight",e[e.Shift=16]="Shift",e[e.ContextMenu=93]="ContextMenu",e[e.Enter=13]="Enter",e[e.Space=32]="Space",e[e.Backspace=8]="Backspace",e[e.Tab=9]="Tab",e[e.Delete=46]="Delete",e[e.End=35]="End",e[e.Home=36]="Home",e[e.Insert=45]="Insert",e[e.PageDown=34]="PageDown",e[e.PageUp=33]="PageUp",e[e.ArrowDown=40]="ArrowDown",e[e.ArrowLeft=37]="ArrowLeft",e[e.ArrowRight=39]="ArrowRight",e[e.ArrowUp=38]="ArrowUp",e[e.Escape=27]="Escape",e[e.PrintScreen=44]="PrintScreen",e[e.ScrollLock=145]="ScrollLock",e[e.Pause=19]="Pause",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NumLock=114]="NumLock",e[e.Numpad0=96]="Numpad0",e[e.Numpad1=97]="Numpad1",e[e.Numpad2=98]="Numpad2",e[e.Numpad3=99]="Numpad3",e[e.Numpad4=100]="Numpad4",e[e.Numpad5=101]="Numpad5",e[e.Numpad6=102]="Numpad6",e[e.Numpad7=103]="Numpad7",e[e.Numpad8=104]="Numpad8",e[e.Numpad9=105]="Numpad9",e[e.NumpadAdd=107]="NumpadAdd",e[e.NumpadDivide=111]="NumpadDivide",e[e.NumpadEqual=12]="NumpadEqual",e[e.NumpadMultiply=106]="NumpadMultiply",e[e.NumpadSubtract=109]="NumpadSubtract",e[e.NumpadDot=110]="NumpadDot",e[e.NumpadDot1=190]="NumpadDot1"}(p=p||{}),function(e){e.Digit1="Digit1",e.Digit2="Digit2",e.Digit3="Digit3",e.Digit4="Digit4",e.Digit5="Digit5",e.Digit6="Digit6",e.Digit7="Digit7",e.Digit8="Digit8",e.Digit9="Digit9",e.Digit0="Digit0",e.KeyA="KeyA",e.KeyB="KeyB",e.KeyC="KeyC",e.KeyD="KeyD",e.KeyE="KeyE",e.KeyF="KeyF",e.KeyG="KeyG",e.KeyH="KeyH",e.KeyI="KeyI",e.KeyJ="KeyJ",e.KeyK="KeyK",e.KeyL="KeyL",e.KeyM="KeyM",e.KeyN="KeyN",e.KeyO="KeyO",e.KeyP="KeyP",e.KeyQ="KeyQ",e.KeyR="KeyR",e.KeyS="KeyS",e.KeyT="KeyT",e.KeyU="KeyU",e.KeyV="KeyV",e.KeyW="KeyW",e.KeyX="KeyX",e.KeyY="KeyY",e.KeyZ="KeyZ",e.Comma="Comma",e.CommaChrome="CommaChrome",e.Period="Period",e.Semicolon="Semicolon",e.Quote="Quote",e.BracketLeft="BracketLeft",e.BracketRight="BracketRight",e.Backquote="Backquote",e.Backslash="Backslash",e.Minus="Minus",e.Equal="Equal",e.IntlRo="IntlRo",e.IntlYen="IntlYen",e.Alt="Alt",e.AltLeft="AltLeft",e.CapsLock="CapsLock",e.Control="Control",e.ControlLeft="ControlLeft",e.OSLeft="OSLeft",e.OSRight="OSRight",e.Shift="Shift",e.ShiftLeft="ShiftLeft",e.ShiftRight="ShiftRight",e.ContextMenu="ContextMenu",e.Enter="Enter",e.Space="Space",e.Backspace="Backspace",e.Tab="Tab",e.Delete="Delete",e.End="End",e.Home="Home",e.Insert="Insert",e.PageDown="PageDown",e.PageUp="PageUp",e.ArrowDown="ArrowDown",e.ArrowLeft="ArrowLeft",e.ArrowRight="ArrowRight",e.ArrowUp="ArrowUp",e.Escape="Escape",e.PrintScreen="PrintScreen",e.ScrollLock="ScrollLock",e.Pause="Pause",e.F1="F1",e.F2="F2",e.F3="F3",e.F5="F5",e.F6="F6",e.F7="F7",e.F8="F8",e.F9="F9",e.F10="F10",e.F11="F11",e.F12="F12",e.NumLock="NumLock",e.Numpad0="Numpad0",e.Numpad1="Numpad1",e.Numpad2="Numpad2",e.Numpad3="Numpad3",e.Numpad4="Numpad4",e.Numpad5="Numpad5",e.Numpad6="Numpad6",e.Numpad7="Numpad7",e.Numpad8="Numpad8",e.Numpad9="Numpad9",e.NumpadAdd="NumpadAdd",e.NumpadDivide="NumpadDivide",e.NumpadEqual="NumpadEqual",e.NumpadMultiply="NumpadMultiply",e.NumpadSubtract="NumpadSubtract",e.NumpadDot="NumpadDot",e.NumpadDot1="NumpadDot1"}(_=_||{}),function(e){let t;e.writeFile=function(e,t){t=new Blob([t],{type:"octet/stream"});let i=document.createElement("a");i.download=e,i.href=window.URL.createObjectURL(t),i.style.display="none",i.onclick=function(){document.body.removeChild(i)},document.body.appendChild(i),i.click()},e.chooseFile=function({filter:e,multiple:i=!1,callback:r}){t&&t.remove(),(t=document.createElement("input")).type="file",t.style.display="none",document.body.appendChild(t),t.accept=e,t.onchange=()=>{0<t.files.length&&r(t.files)},t.multiple=i,t.click()}}(f=f||{});const H=[[0,0,0,0],[255,0,0,255],[255,255,0,255],[0,255,0,255],[0,255,255,255],[0,0,255,255],[255,0,255,255],[255,255,255,255],[128,128,128,255],[192,192,192,255],[255,0,0,255],[255,127,127,255],[165,0,0,255],[165,82,82,255],[127,0,0,255],[127,63,63,255],[76,0,0,255],[76,38,38,255],[38,0,0,255],[38,19,19,255],[255,63,0,255],[255,159,127,255],[165,41,0,255],[165,103,82,255],[127,31,0,255],[127,79,63,255],[76,19,0,255],[76,47,38,255],[38,9,0,255],[38,23,19,255],[255,127,0,255],[255,191,127,255],[165,82,0,255],[165,124,82,255],[127,63,0,255],[127,95,63,255],[76,38,0,255],[76,57,38,255],[38,19,0,255],[38,28,19,255],[255,191,0,255],[255,223,127,255],[165,124,0,255],[165,145,82,255],[127,95,0,255],[127,111,63,255],[76,57,0,255],[76,66,38,255],[38,28,0,255],[38,33,19,255],[255,255,0,255],[255,255,127,255],[165,165,0,255],[165,165,82,255],[127,127,0,255],[127,127,63,255],[76,76,0,255],[76,76,38,255],[38,38,0,255],[38,38,19,255],[191,255,0,255],[223,255,127,255],[124,165,0,255],[145,165,82,255],[95,127,0,255],[111,127,63,255],[57,76,0,255],[66,76,38,255],[28,38,0,255],[33,38,19,255],[127,255,0,255],[191,255,127,255],[82,165,0,255],[124,165,82,255],[63,127,0,255],[95,127,63,255],[38,76,0,255],[57,76,38,255],[19,38,0,255],[28,38,19,255],[63,255,0,255],[159,255,127,255],[41,165,0,255],[103,165,82,255],[31,127,0,255],[79,127,63,255],[19,76,0,255],[47,76,38,255],[9,38,0,255],[23,38,19,255],[0,255,0,255],[127,255,127,255],[0,165,0,255],[82,165,82,255],[0,127,0,255],[63,127,63,255],[0,76,0,255],[38,76,38,255],[0,38,0,255],[19,38,19,255],[0,255,63,255],[127,255,159,255],[0,165,41,255],[82,165,103,255],[0,127,31,255],[63,127,79,255],[0,76,19,255],[38,76,47,255],[0,38,9,255],[19,38,23,255],[0,255,127,255],[127,255,191,255],[0,165,82,255],[82,165,124,255],[0,127,63,255],[63,127,95,255],[0,76,38,255],[38,76,57,255],[0,38,19,255],[19,38,28,255],[0,255,191,255],[127,255,223,255],[0,165,124,255],[82,165,145,255],[0,127,95,255],[63,127,111,255],[0,76,57,255],[38,76,66,255],[0,38,28,255],[19,38,33,255],[0,255,255,255],[127,255,255,255],[0,165,165,255],[82,165,165,255],[0,127,127,255],[63,127,127,255],[0,76,76,255],[38,76,76,255],[0,38,38,255],[19,38,38,255],[0,191,255,255],[127,223,255,255],[0,124,165,255],[82,145,165,255],[0,95,127,255],[63,111,127,255],[0,57,76,255],[38,66,76,255],[0,28,38,255],[19,33,38,255],[0,127,255,255],[127,191,255,255],[0,82,165,255],[82,124,165,255],[0,63,127,255],[63,95,127,255],[0,38,76,255],[38,57,76,255],[0,19,38,255],[19,28,38,255],[0,63,255,255],[127,159,255,255],[0,41,165,255],[82,103,165,255],[0,31,127,255],[63,79,127,255],[0,19,76,255],[38,47,76,255],[0,9,38,255],[19,23,38,255],[0,0,255,255],[127,127,255,255],[0,0,165,255],[82,82,165,255],[0,0,127,255],[63,63,127,255],[0,0,76,255],[38,38,76,255],[0,0,38,255],[19,19,38,255],[63,0,255,255],[159,127,255,255],[41,0,165,255],[103,82,165,255],[31,0,127,255],[79,63,127,255],[19,0,76,255],[47,38,76,255],[9,0,38,255],[23,19,38,255],[127,0,255,255],[191,127,255,255],[82,0,165,255],[124,82,165,255],[63,0,127,255],[95,63,127,255],[38,0,76,255],[57,38,76,255],[19,0,38,255],[28,19,38,255],[191,0,255,255],[223,127,255,255],[124,0,165,255],[145,82,165,255],[95,0,127,255],[111,63,127,255],[57,0,76,255],[66,38,76,255],[28,0,38,255],[33,19,38,255],[255,0,255,255],[255,127,255,255],[165,0,165,255],[165,82,165,255],[127,0,127,255],[127,63,127,255],[76,0,76,255],[76,38,76,255],[38,0,38,255],[38,19,38,255],[255,0,191,255],[255,127,223,255],[165,0,124,255],[165,82,145,255],[127,0,95,255],[127,63,111,255],[76,0,57,255],[76,38,66,255],[38,0,28,255],[38,19,33,255],[255,0,127,255],[255,127,191,255],[165,0,82,255],[165,82,124,255],[127,0,63,255],[127,63,95,255],[76,0,38,255],[76,38,57,255],[38,0,19,255],[38,19,28,255],[255,0,63,255],[255,127,159,255],[165,0,41,255],[165,82,103,255],[127,0,31,255],[127,63,79,255],[76,0,19,255],[76,38,47,255],[38,0,9,255],[38,19,23,255],[84,84,84,255],[118,118,118,255],[152,152,152,255],[186,186,186,255],[220,220,220,255],[255,255,255,255],[0,0,0,0]];function K(e){return"string"==typeof e?n.Color3.FromHexString(e):n.Color3.FromHexString(e.toString())}n.Effect.ShadersStore.myshaderVertexShader="\n         attribute vec3 position;                \n         uniform mat4 world;                    \n         uniform mat4 view;                    \n         uniform mat4 viewProjection;          \n         varying float fFogDistance;\n         void main(void) {\n                 vec4 worldPosition = world * vec4(position, 1.0);\n                 fFogDistance = (view * worldPosition).z;\n                 gl_Position =  viewProjection * worldPosition;\n         }",n.Effect.ShadersStore.myshaderFragmentShader='\n      #ifdef GL_ES\n  precision mediump float;\n  #endif\n  \n  uniform float time;\n  uniform vec2 mouse;\n  uniform vec2 resolution;\n  \n  // "Seascape" by Alexander Alekseev aka TDM - 2014\n  // License Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.\n  \n  const int NUM_STEPS = 12;\n  const float PI\t \t= 3.1415;\n  const float EPSILON\t= 1e-3;\n  float EPSILON_NRM\t= 0.;\n  \n  // sea\n  const int ITER_GEOMETRY = 3;\n  const int ITER_FRAGMENT = 5;\n  const float SEA_HEIGHT = 0.6;\n  const float SEA_CHOPPY = 4.0;\n  const float SEA_SPEED = 0.8;\n  const float SEA_FREQ = 0.16;\n  const vec3 SEA_BASE = vec3(0.1,0.19,0.22);\n  const vec3 SEA_WATER_COLOR = vec3(0.8,0.9,0.6);\n  float SEA_TIME = 0.;\n  mat2 octave_m = mat2(1.6,1.2,-1.2,1.6);\n  \n  // math\n  mat3 fromEuler(vec3 ang) {\n      vec2 a1 = vec2(sin(ang.x),cos(ang.x));\n      vec2 a2 = vec2(sin(ang.y),cos(ang.y));\n      vec2 a3 = vec2(sin(ang.z),cos(ang.z));\n      mat3 m;\n      m[0] = vec3(a1.y*a3.y+a1.x*a2.x*a3.x,a1.y*a2.x*a3.x+a3.y*a1.x,-a2.y*a3.x);\n      m[1] = vec3(-a2.y*a1.x,a1.y*a2.y,a2.x);\n      m[2] = vec3(a3.y*a1.x*a2.x+a1.y*a3.x,a1.x*a3.x-a1.y*a3.y*a2.x,a2.y*a3.y);\n      return m;\n  }\n  float hash( vec2 p ) {\n      float h = dot(p,vec2(127.1,311.7));\t\n      return fract(sin(h)*43758.5453123);\n  }\n  float noise( in vec2 p ) {\n      vec2 i = floor( p );\n      vec2 f = fract( p );\t\n      vec2 u = f*f*(3.0-2.0*f);\n      return -1.0+2.0*mix( mix( hash( i + vec2(0.0,0.0) ), \n                       hash( i + vec2(1.0,0.0) ), u.x),\n                  mix( hash( i + vec2(0.0,1.0) ), \n                       hash( i + vec2(1.0,1.0) ), u.x), u.y);\n  }\n  \n  // lighting\n  float diffuse(vec3 n,vec3 l,float p) {\n      return pow(dot(n,l) * 0.4 + 0.6,p);\n  }\n  float specular(vec3 n,vec3 l,vec3 e,float s) {    \n      float nrm = (s + 8.0) / (3.1415 * 8.0);\n      return pow(max(dot(reflect(e,n),l),0.0),s) * nrm;\n  }\n  \n  // sky\n  vec3 getSkyColor(vec3 e) {\n      e.y = max(e.y,0.0);\n      vec3 ret;\n      ret.x = pow(1.0-e.y,2.0);\n      ret.y = 1.0-e.y;\n      ret.z = 0.6+(1.0-e.y)*0.4;\n      return ret;\n  }\n  \n  // sea\n  float sea_octave(vec2 uv, float choppy) {\n      uv += noise(uv);        \n      vec2 wv = 1.0-abs(sin(uv));\n      vec2 swv = abs(cos(uv));    \n      wv = mix(wv,swv,wv);\n      return pow(1.0-pow(wv.x * wv.y,0.65),choppy);\n  }\n  \n  float map(vec3 p) {\n      float freq = SEA_FREQ;\n      float amp = SEA_HEIGHT;\n      float choppy = SEA_CHOPPY;\n      vec2 uv = p.xz; uv.x *= 0.75;\n      \n      float d, h = 0.0;    \n      for(int i = 0; i < ITER_GEOMETRY; i++) {        \n          d = sea_octave((uv+SEA_TIME)*freq,choppy);\n          d += sea_octave((uv-SEA_TIME)*freq,choppy);\n          h += d * amp;        \n          uv *= octave_m; freq *= 1.9; amp *= 0.22;\n          choppy = mix(choppy,1.0,0.2);\n      }\n      return p.y - h;\n  }\n  \n  float map_detailed(vec3 p) {\n      float freq = SEA_FREQ;\n      float amp = SEA_HEIGHT;\n      float choppy = SEA_CHOPPY;\n      vec2 uv = p.xz; uv.x *= 0.75;\n      \n      float d, h = 0.0;    \n      for(int i = 0; i < ITER_FRAGMENT; i++) {        \n          d = sea_octave((uv+SEA_TIME)*freq,choppy);\n          d += sea_octave((uv-SEA_TIME)*freq,choppy);\n          h += d * amp;        \n          uv *= octave_m; freq *= 1.9; amp *= 0.22;\n          choppy = mix(choppy,1.0,0.2);\n      }\n      return p.y - h;\n  }\n  \n  vec3 getSeaColor(vec3 p, vec3 n, vec3 l, vec3 eye, vec3 dist) {  \n      float fresnel = 1.0 - max(dot(n,-eye),0.0);\n      fresnel = pow(fresnel,3.0) * 0.65;\n          \n      vec3 reflected = getSkyColor(reflect(eye,n));    \n      vec3 refracted = SEA_BASE + diffuse(n,l,80.0) * SEA_WATER_COLOR * 0.12; \n      \n      vec3 color = mix(refracted,reflected,fresnel);\n      \n      float atten = max(1.0 - dot(dist,dist) * 0.001, 0.0);\n      color += SEA_WATER_COLOR * (p.y - SEA_HEIGHT) * 0.18 * atten;\n      \n      color += vec3(specular(n,l,eye,60.0));\n      \n      return color;\n  }\n  \n  // tracing\n  vec3 getNormal(vec3 p, float eps) {\n      vec3 n;\n      n.y = map_detailed(p);    \n      n.x = map_detailed(vec3(p.x+eps,p.y,p.z)) - n.y;\n      n.z = map_detailed(vec3(p.x,p.y,p.z+eps)) - n.y;\n      n.y = eps;\n      return normalize(n);\n  }\n  \n  float heightMapTracing(vec3 ori, vec3 dir, out vec3 p) {  \n      float tm = 0.0;\n      float tx = 1000.0;    \n      float hx = map(ori + dir * tx);\n      if(hx > 0.0) return tx;   \n      float hm = map(ori + dir * tm);    \n      float tmid = 0.0;\n      for(int i = 0; i < NUM_STEPS; i++) {\n          tmid = mix(tm,tx, hm/(hm-hx));                   \n          p = ori + dir * tmid;                   \n          float hmid = map(p);\n          if(hmid < 0.0) {\n              tx = tmid;\n              hx = hmid;\n          } else {\n              tm = tmid;\n              hm = hmid;\n          }\n      }\n      return tmid;\n  }\n  \n  // main\n  void main() {\n      EPSILON_NRM = 0.1 / resolution.x;\n      SEA_TIME = time * SEA_SPEED;\n      \n      vec2 uv = gl_FragCoord.xy / resolution.xy;\n      uv = uv * 2.0 - 1.0;\n      uv.x *= resolution.x / resolution.y;  \n      float time2 = 0.0;\n      time2 = time * 0.1 + (mouse.x*10.0);\n          \n      // ray\n      vec3 ang = vec3(sin(time2*3.0)*0.1,sin(time2)*0.2+0.3,time2);    \n      vec3 ori = vec3(0.0,3.5,time*5.0);\n      vec3 dir = normalize(vec3(uv.xy,-2.0)); \n      dir.z += length(uv) * 0.15;\n      dir = normalize(dir) * fromEuler(ang);\n      \n      // tracing\n      vec3 p;\n      heightMapTracing(ori,dir,p);\n      vec3 dist = p - ori;\n      vec3 n = getNormal(p, dot(dist,dist) * EPSILON_NRM);\n      vec3 light = normalize(vec3(0.0,1.0,0.8)); \n               \n      // color\n      vec3 color = mix(\n          getSkyColor(dir),\n          getSeaColor(p,n,light,dir,dist),\n          pow(smoothstep(0.0,-0.05,dir.y),0.3));\n          \n      // post\n      gl_FragColor = vec4(pow(color,vec3(0.75)), 1.0);\n  }';var X,q,Y,Z,Q,J,$,ee,te,ie=Object.freeze({__proto__:null,showWorldAxis:function(e,t){n.MeshBuilder.CreateLines("axisX",{points:[n.Vector3.Zero(),new n.Vector3(e,0,0),new n.Vector3(.95*e,.05*e,0),new n.Vector3(e,0,0),new n.Vector3(.95*e,-.05*e,0)]},t).color=new n.Color3(1,0,0),n.MeshBuilder.CreateLines("axisY",{points:[n.Vector3.Zero(),new n.Vector3(0,e,0),new n.Vector3(-.05*e,.95*e,0),new n.Vector3(0,e,0),new n.Vector3(.05*e,.95*e,0)]},t).color=new n.Color3(0,1,0),n.MeshBuilder.CreateLines("axisZ",{points:[n.Vector3.Zero(),new n.Vector3(0,0,e),new n.Vector3(0,-.05*e,.95*e),new n.Vector3(0,0,e),new n.Vector3(0,.05*e,.95*e)]},t).color=new n.Color3(0,0,1)},getEntity:N,getRoot:k,isTextureAsset:function(e){var t=e.indexOf("?");return-1!==t&&(e=e.substring(0,t)),n.StringTools.EndsWith(e,".ktx")||n.StringTools.EndsWith(e,".ktx2")||n.StringTools.EndsWith(e,".png")||n.StringTools.EndsWith(e,".jpg")||n.StringTools.EndsWith(e,".jpeg")},equaln:U,sleep:z,b64toBlob:G,simpleObjectEqual:V,updateQueryStringParameter:j,isNone:function(e){return void 0===e||!e&&0!==e},get MouseKey(){return d},get KeyBoard(){return p},get KeyCode(){return _},arrayLast:A,removeOne:M,arrayRemoveIf:O,get FileSystem(){return f},deg2rad:W,rad2Deg:function(e){return n.Tools.ToDegrees(e)},Box3:w,unionBoundbox:function(e,t){var i=e.minimum,r=t.minimum;return e.minimum.set(Math.min(i.x,r.x),Math.min(i.y,r.y),Math.min(i.z,r.z)),i=e.maximum,r=t.maximum,e.maximum.set(Math.max(i.x,r.x),Math.max(i.y,r.y),Math.max(i.z,r.z)),e},getMin:x,getMax:T,getCanvasTexture:function(e,t,i){return new n.DynamicTexture(e,t,i)},getVideoTexture:function(e,t,i){return new n.VideoTexture(e,t,i)},mirrorMaterial:function(e,t,i){const r=e.material;if(r){i.blockMaterialDirtyMechanism=!1;var s=e.getWorldMatrix(),o=e.getVerticesData("normal");o=new n.Vector3(o[0],o[1],o[2]);let a=n.Vector3.TransformNormal(o,s);o=n.Plane.FromPositionAndNormal(e.absolutePosition,a.scale(-1));const h=new n.MirrorTexture("mirror"+this.Id,1024,i,!0);(r.reflectionTexture=h).mirrorPlane=o,h.renderList=t,h.level=1,i.blockMaterialDirtyMechanism=!0}},Container:s.Container,getGuiContainer:function(e){return new s.Container(e)},Color4:n.Color4,Color3:n.Color3,ColorPalette:H,getColor3:K,getColor4:function(e){return"string"==typeof e?n.Color4.FromHexString(e):n.Color4.FromHexString(e.toString())},generateOcean:function(e,t){return v(this,void 0,void 0,(function*(){const i=n.MeshBuilder.CreateGround("ground",{width:1,height:1,subdivisions:128},e);i.scaling=new n.Vector3(t,t,t),i.position.y=-t/4;var r=yield n.NodeMaterial.ParseFromFileAsync("waterMaterial","https://am-img.gkiiot.com/editor/envs/water.json",e);i.material=r;const s=new n.DefaultRenderingPipeline("defaultPipeline",!1,e,[e.activeCamera]);return s.bloomEnabled=!0,s.bloomThreshold=0,s.bloomKernel=.35,s.bloomScale=.5,s.grainEnabled=!0,s.grain.intensity=8,s.grain.animated=!0,s.chromaticAberrationEnabled=!0,s.chromaticAberration.aberrationAmount=65.1,s.chromaticAberration.radialIntensity=2,s.sharpenEnabled=!0,s.sharpen.edgeAmount=.15,i}))},getOcean:function(e,t){e=n.MeshBuilder.CreateGround("ground",{width:e,height:e},t);var i=new n.ShaderMaterial("test",t,{vertex:"myshader",fragment:"myshader"},{needAlphaBlending:!0,attributes:["position"],uniforms:["world","view","viewProjection","vFogInfos","vFogColor","time","mouse","resolution"],samplers:[]});e.material=i;let r=.1;i.onBind=function(e){var t=i.getEffect();t.setFloat("time",r+=.001),t.setVector2("mouse",new n.Vector2(.8,.5)),t.setVector2("resolution",new n.Vector2(1024,1024))}},getWaterPlane:function(e,t,i=[]){const r=(0,n.CreateDisc)("waterMesh",{radius:t},e),s=(r.rotation.x=Math.PI/2,new o.WaterMaterial("water",e,new n.Vector2(512,512)));return s.backFaceCulling=!0,s.bumpTexture=new n.Texture("https://am-img.gkiiot.com/editor/textures/waterbump.png",e),s.windForce=-10,s.waveHeight=2,s.bumpHeight=.2,s.windDirection=new n.Vector2(1,0),s.waterColor=new n.Color3(.1,.1,.6),s.colorBlendFactor=0,i.forEach((e=>s.addToRenderList(e))),r.material=s,[r,s]}});new n.Vector3(1/0,1/0,1/0),new n.Vector3(-1/0,-1/0,-1/0);const re=new n.Vector3;function ne(e){var t;return n.Vector3.FromArray([null!=(t=e.x)?t:0,null!=(t=e.y)?t:0,null!=(t=e.z)?t:0])}function se(e,t){var i;e.x=null!=(i=t.x)?i:e.x,e.y=null!=(i=t.y)?i:e.y,"z"in e&&"z"in t&&(e.z=null!=(i=t.z)?i:e.z)}function oe(e,t){return U(e.x,t.x)&&U(e.y,t.y)&&U(e.z,t.z)}function ae(e){return{x:e.x,y:e.y,z:e.z}}const he=new I;class le{constructor(e){this._name="\u672a\u547d\u540d",this._speedRadio=1,this._time=1,this._loop=!1,this._frame=30,this._entity=e}get Animation(){return this._animation}get name(){return this._name}set name(e){this._name=e}init(){}start(){this._animatable=this._entity.Scene.beginAnimation(this._entity.RenderObject,0,this._time*this._frame,this._loop,this._speedRadio),this.completeCallback&&this._animatable.onAnimationEndObservable.add(this.completeCallback),this._loopCount&&this._loop&&this.setLoopCount(this._loopCount)}pause(){this._animatable&&this._animatable.pause()}restart(){this._animatable&&this._animatable.restart()}stop(){this._animatable&&this._animatable.stop()}reset(){this._animatable&&this._animatable.reset()}clear(){var e=null==(e=this._entity)?void 0:e.RenderObject;e&&M(e.animations,this._animation)}writeFile(e){e.write(1),e.write(this._name),e.write(this._time),e.write(this._loop),e.write(this._frame),e.write(this._speedRadio),e.write(this._loopCount)}readFile(e){e.read(),this._name=e.read(),this._time=e.read(),this._loop=e.read(),this._frame=e.read(),this._speedRadio=e.read(),this._loopCount=e.read()}setLoopCount(e){let t;if(e){let i=0;t=this._animatable.onAnimationLoopObservable.add((r=>{++i===e&&(r.stop(),this._animatable.onAnimationEndObservable.remove(t))}))}return()=>{t&&this._animatable.onAnimationEndObservable.remove(t)}}}let ce=class extends le{constructor(e,t){super(e),this._name="\u672a\u547d\u540d\u79fb\u52a8",this._points=[];var{path:e,time:i=1,loop:r=!1,frame:n=30,loopCount:s}=t;this._time=i,this._loop=r,this._frame=n,this._loopCount=s,this._points=Array.isArray(e)?e:e.Points,t.name&&(this._name=t.name),this.init()}init(){this._entity.removeAnimation(this._name);const e=this._entity.RenderObject,t=new n.Animation(this._name,"position",this._frame,n.Animation.ANIMATIONTYPE_VECTOR3),i=[];let r=0;var s=this._time/this._points.length;for(const e of this._points)i.push({frame:this._frame*s*r++,value:new n.Vector3(e.x,e.y,e.z)});t.setKeys(i),e.animations.push(t),this._animation=t}writeFile(e){super.writeFile(e),e.write(1),e.write(this._points.length);for(const t of this._points)e.write(t.x),e.write(t.y),e.write(t.z)}readFile(e){super.readFile(e),e.read();var t=e.read();for(let i=this._points.length=0;i<t;i++){const t={x:0,y:0,z:0};t.x=e.read(),t.y=e.read(),t.z=e.read(),this._points.push(t)}}},ue=(ce=y([E],ce),class extends le{constructor(e,t){super(e),this._name="\u672a\u547d\u540d\u65cb\u8f6c",this._from=0,this._angle=0,this._angles=[];var{angle:e,dir:i={x:0,y:1,z:0},time:r=1,frame:n=30,loop:s=!0,from:o=0,angles:a=[],loopCount:h,origin:l}=t;this._time=r,this._loop=s,this._frame=n,this._loopCount=h,this._dir=i,this._angle=e,this._from=o,t.name&&(this._name=t.name),this._origin=l,this._angles=a,this.init()}init(){this._entity.removeAnimation(this._name);const e=this._entity.RenderObject,t=new n.Animation(this._name,"rotationQuaternion",this._frame,n.Animation.ANIMATIONTYPE_QUATERNION);e.rotationQuaternion||(e.rotationQuaternion=e.rotation.toQuaternion(),e.rotation.setAll(0));var i,r=n.Vector3.FromArray(Object.values(this._dir)).normalize();const s=[];if(null!=(i=this._angles)&&i.length){var o=this._time/this._angles.length;for(let e=0;e<this._angles.length;e++)s.push({frame:this._frame*e*o,value:n.Quaternion.RotationAxis(r,this._angles[e])})}else s.push({frame:0,value:n.Quaternion.RotationAxis(r,this._from)}),Math.abs(this._from-this._angle)>=2*Math.PI-.001&&s.push({frame:this._frame*this._time*.5,value:n.Quaternion.RotationAxis(r,.5*(this._angle-this._from))}),s.push({frame:this._frame*this._time,value:n.Quaternion.RotationAxis(r,this._angle)});t.setKeys(s),this._origin&&(i=n.Vector3.FromArray(Object.values(this._origin)).negate(),i=ne(this._entity?this._entity.Position:n.Vector3.Zero()).add(i),e.setPivotMatrix(n.Matrix.Translation(i.x,i.y,i.z))),e.animations.push(t),this._animation=t}writeFile(e){super.writeFile(e),e.write(1)}readFile(e){super.readFile(e),e.read(),e.read()}});ue=y([E],ue),function(e){e[e.None=0]="None",e[e.C=1]="C",e[e.W=2]="W"}(X=X||{});const de={[n.PointerEventTypes.POINTERDOWN]:"pointerDown",[n.PointerEventTypes.POINTERUP]:"pointerUp",[n.PointerEventTypes.POINTERMOVE]:"pointerMove",[n.PointerEventTypes.POINTERPICK]:"pointerPick",[n.PointerEventTypes.POINTERWHEEL]:"pointerWheel",[n.PointerEventTypes.POINTERTAP]:"pointerTap",[n.PointerEventTypes.POINTERDOUBLETAP]:"pointerDoubleTap"},pe={pointerOver:n.ActionManager.OnPointerOverTrigger,pointerOut:n.ActionManager.OnPointerOutTrigger,pointerLongPress:n.ActionManager.OnLongPressTrigger};!function(e){e[e.None=0]="None",e[e.Pan=1]="Pan",e[e.Roate=2]="Roate",e[e.Zoom=4]="Zoom",e[e.All=7]="All"}(q=q||{}),function(e){e[e.Up=1]="Up",e[e.Down=2]="Down",e[e.Left=3]="Left",e[e.Right=4]="Right",e[e.Front=5]="Front",e[e.Back=6]="Back",e[e.SW=7]="SW"}(Y=Y||{}),function(e){e[e.None=0]="None",e[e.Translate=1]="Translate",e[e.Rotate=2]="Rotate",e[e.Scale=4]="Scale",e[e.All=7]="All"}(Z=Z||{}),function(e){e[e.Center=0]="Center",e[e.Bottom=1]="Bottom",e[e.Top=2]="Top",e[e.Left=3]="Left",e[e.Right=4]="Right",e[e.Front=5]="Front",e[e.Back=6]="Back",e[e.LFB=351]="LFB",e[e.RFB=451]="RFB",e[e.LBB=361]="LBB",e[e.RBB=461]="RBB"}(Q=Q||{}),function(e){e[e.Equal=0]="Equal",e[e.Greater=1]="Greater",e[e.Less=2]="Less",e[e.GreEqu=3]="GreEqu",e[e.LessEqu=4]="LessEqu"}(J=J||{}),function(e){e[e.Offset=0]="Offset",e[e.To=1]="To"}($=$||{}),function(e){e[e.Equal=0]="Equal",e[e.UnEqual=1]="UnEqual",e[e.Great=2]="Great",e[e.Less=3]="Less",e[e.GtEqual=4]="GtEqual",e[e.LessEqual=5]="LessEqual",e[e.Include=6]="Include",e[e.UnInclude=7]="UnInclude",e[e.Is=8]="Is",e[e.IsNot=9]="IsNot"}(ee=ee||{}),function(e){e[e.None=0]="None",e[e.Sun=1]="Sun",e[e.Image=2]="Image",e[e.Env=3]="Env"}(te=te||{});class _e extends L{constructor(){super(),this.isAsync=!1,this.isLight=!1,this.isPart=!1,this.IsSelect=!1,this._enableShadow=!0,this._matrix=n.Matrix.Identity(),this._scale=new n.Vector3(1,1,1),this._rotation=new n.Vector3,this._rotationQuaternion=new n.Quaternion,this._position=new n.Vector3,this._isVisiable=!0,this._colorIndex=9,this._cacheDrawObject=new Map,this._animations=[],this._isPickable=!0,this._highlight=!1,this._opacity=1,this._animationing=[]}get Material(){if(this._PBRID)return this._PBRID.Object}set Material(e){this._PBRID=e.ObjectId,this.updateMaterial()}get UniqueName(){return this.constructor.type+this.Id}get Name(){var e;return null!=(e=this._name)?e:this.UniqueName}set Name(e){this._name=e,he.trigger({type:"updateName",target:this})}get CanUpdate(){var e;return!(null==(e=this.ObjectId)||!e.Index||this._erase)}get RenderType(){var e;return null!=(e=this._renderType)?e:_e.renderType}get IsPickable(){return this._isPickable}set IsPickable(e){this._isPickable=e,this._drawObject.getChildMeshes().forEach((t=>t.isPickable=e))}get Highlight(){return this._highlight}get IsComponent(){return!1}highlight(e){const t=_e.Scene.getHighlightLayerByName("select-entity");this._drawObject.getChildMeshes().forEach((i=>e?t.addMesh(i,n.Color3.FromHexString(e)):t.removeMesh(i)))}get DrawObject(){var e;if(this._drawObject)return this._drawObject;const t=this.GetDrawObjectFromRenderType(null!=(e=this._renderType)?e:_e.renderType);return this._drawObject=new n.TransformNode(null!=(e=this.Name)?e:null==(e=this._id)?void 0:e.Index.toString(),_e.Scene,!1),this.isPart||(t.parent=this._drawObject,this._drawObject.metadata={Entity:this}),this._drawObject.setEnabled(this._isVisiable&&!this._erase),this.update(),this._drawObject}get Scene(){var e;return null==(e=this.RenderObject)?void 0:e.getScene()}get RenderObject(){return this.GetDrawObjectFromRenderType(this.RenderType)}get ColorIndex(){return this._colorIndex}set ColorIndex(e){this._colorIndex!==e&&(this.writeSnapshoot(),this._colorIndex=e,this.update())}get Matrix(){return this._matrix.clone()}set Matrix(e){this.writeSnapshoot(),this._matrix.copyFrom(e),this._matrix.decompose(this._scale,this._rotationQuaternion,this._position),this._rotationQuaternion.toEulerAnglesToRef(this._rotation),this.update()}get MatrixInv(){return this._matrix.invert()}get TransfromFromMtx(){var e=new n.Vector3;const t=new n.Quaternion;var i=new n.Vector3;return this._matrix.decompose(i,t,e),{position:e,rotation:t.toEulerAngles(),scale:i}}get BoundingVectors(){return this.DrawObject.getHierarchyBoundingVectors()}get BoundingBox(){const e=this.RenderObject.getBoundingInfo().boundingBox;return new w(e.minimum,e.maximum,e.getWorldMatrix())}get Opacity(){return this._opacity}set Opacity(e){e!==this._opacity&&(this.writeSnapshoot(),this._opacity=e,this.setPrivateMaterial(),this._standardMaterial.alpha=e)}get Color(){return this._color}set Color(e){e!==this._color&&(this.writeSnapshoot(),this._color=e,this.setPrivateMaterial(),this._standardMaterial.diffuseColor=n.Color3.FromHexString(e))}translate(e){this.writeSnapshoot(),this.Position=this._position.add(ne(e))}GetDrawObjectFromRenderType(e=u.Conceptual){if(this._cacheDrawObject.has(e)){const t=this._cacheDrawObject.get(e);return t.setEnabled(!0),t}var t=this.initDrawObject(e);if(t)return this._cacheDrawObject.set(e,t),t}get Position(){return{x:this._position.x,y:this._position.y,z:this._position.z}}set Position(e){this.writeSnapshoot(),se(this._position,e),this.updateMatrix(),this.update()}get Rotation(){return{x:this._rotation.x,y:this._rotation.y,z:this._rotation.z}}set Rotation(e){this.writeSnapshoot(),se(this._rotation,e),n.Quaternion.FromEulerAnglesToRef(this._rotation.x,this._rotation.y,this._rotation.z,this._rotationQuaternion),this.updateMatrix(),this.update()}get Scale(){return{x:this._scale.x,y:this._scale.y,z:this._scale.z}}set Scale(e){this.writeSnapshoot(),se(this._scale,e),this._scale.copyFromFloats(e.x,e.y,e.z),this.updateMatrix(),this.update()}get Visiable(){return this._isVisiable&&!this.IsErase}set Visiable(e){e!==this._isVisiable&&(this.writeSnapshoot(),this._isVisiable=e,this._drawObject.setEnabled(!this._erase&&this._isVisiable),this.trigger({type:"updateVisiable",target:this}),he.trigger({type:"updateVisiable",target:this}))}lookAt(e){this._drawObject.lookAt(ne(e)),this._drawObject.rotationQuaternion?(this._rotationQuaternion.copyFrom(this._drawObject.rotationQuaternion),this._rotation.copyFrom(this._rotationQuaternion.toEulerAngles())):(this._rotation.copyFrom(this._drawObject.rotation),this._rotationQuaternion.copyFrom(this._rotation.toQuaternion())),this.updateMatrix()}get AnimationNames(){const e=[];return this.modelAnimations&&this.modelAnimations.forEach((t=>e.push(t.name))),this._animations.forEach((t=>e.push(t.name))),e}get Animations(){var e;const t=[...this._animations];return null!=(e=this.modelAnimations)&&e.length&&t.push(...this.modelAnimations),t}get EnableShadow(){return this._enableShadow}set EnableShadow(e){this._enableShadow!==e&&(this._enableShadow=e,he.trigger({type:"update-shadow",target:this}))}get DiffuseTexutre(){return this.diffuseTexture}set DiffuseTexture(e){this.diffuseTexture=e,this.setPrivateMaterial();const t=this._standardMaterial;t.diffuseTexture=e.Object.Texture,t.ambientColor=n.Color3.White()}removeAnimation(e){const t=this._animations.find((t=>t.name===e));t&&(t.clear(),M(this._animations,t))}startAnimates(e,t=!0,i=1){for(const r of this.Animations)e===r.name&&r.start(t,i)}stopAnimates(e){for(const t of this.Animations)e&&!e.includes(t.name)||t.stop()}clearAnimatable(){this.RenderObject.animations.length=0;for(const e of this._animations)e.pause(),e.stop(),e.reset();this._animations.length=0,this.stopAnimates()}appendAnimation(e){this.writeSnapshoot(),this._animations.push(e),this.trigger({type:"addAnimation",target:this})}mirrorMaterial(e,t){const i=e.material;if(i){var r=e.getWorldMatrix(),s=e.getVerticesData("normal");s=new n.Vector3(s[0],s[1],s[2]);let o=n.Vector3.TransformNormal(s,r);s=n.Plane.FromPositionAndNormal(e.position,o.scale(-1));const a=new n.MirrorTexture("mirror"+this.Id,1024,_e.Scene,!0);(i.reflectionTexture=a).mirrorPlane=s,a.renderList=t,a.level=1}}moveAnimate(e){return e=new ce(this,e),this.appendAnimation(e),e}rotateAnimate(e){return e=new ue(this,e),this.appendAnimation(e),e}scaleAnimate(e){const{scale:t,time:i=1,frame:r=30,loop:s=!1,loopCount:o,complete:a}=e;e=n.Vector3.FromArray([null!=(e=t.x)?e:this._scale.x,null!=(e=t.y)?e:this._scale.y,null!=(e=t.z)?e:this._scale.z]);const h=this.RenderObject,l=h.getScene(),c=new n.Animation("rotate-animate","scaling",30,n.Animation.ANIMATIONTYPE_VECTOR3),u=(c.setKeys([{frame:0,value:this._scale.clone()},{frame:i*r,value:e}]),h.animations.push(c),l.beginAnimation(h,0,i*r,s));u.onAnimationEndObservable.addOnce((()=>{null!=a&&a()}));let d=this.setLoopCount(o,u);return{clear:()=>{u.stop(),null!=d&&d(),M(h.animations,c)},restart:()=>u.restart(),stop:()=>u.stop(),pause:()=>u.pause(),reset:()=>u.reset()}}setLoopCount(e,t){let i;if(e){let r=0;i=t.onAnimationLoopObservable.add((t=>{++r===e&&t.stop()}))}return()=>{i&&t.onAnimationEndObservable.remove(i)}}moveTo(e,t=!0,i){return new Promise((r=>{if(i){var{time:s=1,startTime:o}=i;const a=this._drawObject.position.clone(),h=[{frame:30*o,value:a},{frame:30*(s+o),value:t?a.clone().add(ne(e)):ne(e)}];if(oe(h[0].value,h[1].value))r(null);else{const e=new n.Animation("move-animate","position",30,n.Animation.ANIMATIONTYPE_VECTOR3);(e.setKeys(h),this._animationing.push(e),this._drawObject.animations.push(e),this._drawObject.getScene().beginDirectAnimation(this._drawObject,this._animationing,30*o,30*(s+o),!1)).onAnimationEndObservable.addOnce((()=>{M(this._drawObject.animations,e),M(this._animationing,e),this._position=h[1].value,r(null)}))}}else t?this.applyMatrix(n.Matrix.Translation(null!=(s=e.x)?s:0,null!=(o=e.y)?o:0,null!=(s=e.z)?s:0)):this.Position=e,r(null)}))}rotateTo(e){return new Promise((t=>{const{time:i=1,dir:r={x:0,y:1,z:0},angle:s,animation:o,isOffset:a,pivot:h,startTime:l=0}=e;var c=n.Vector3.FromArray(Object.values(r)).normalize();if(o){const e=this._drawObject.rotationQuaternion||n.Quaternion.FromEulerVector(this._drawObject.rotation),r=[{frame:30*l,value:e.clone()}];if(U(s%(2*Math.PI),0)){var u=Math.round(s/(2*Math.PI));for(let t=0;t<u;t++){var d=n.Quaternion.RotationAxis(c,2*Math.PI*t+Math.PI);r.push({frame:30*(l+i),value:a?e.clone().multiply(d):d})}}var p=n.Quaternion.RotationAxis(c,s);if(r.push({frame:30*(l+i),value:a?e.clone().multiply(p):p}),2===r.length&&oe(r[0].value,r[1].value))t(null);else{h&&this._drawObject.setPivotPoint(ne(h));const e=new n.Animation("rotate-animation","rotationQuaternion",30,n.Animation.ANIMATIONTYPE_QUATERNION);(this._animationing.push(e),e.setKeys(r),this._drawObject.animations.push(e),this._drawObject.getScene().beginDirectAnimation(this._drawObject,this._animationing,30*l,30*(l+i),!1)).onAnimationEndObservable.addOnce((()=>{M(this._drawObject.animations,e),M(this._animationing,e),this._rotation=r[1].value.toEulerAngles(),t(null)}))}}else p=n.Quaternion.RotationAxis(c,s).toEulerAngles(),a?this.applyMatrix(n.Matrix.RotationAxis(c,s)):this.Rotation=p,t(null)}))}scaleTo(e){const{scale:t,time:i,animation:r,isOffset:s,pivot:o,startTime:a}=e;return new Promise((e=>{if(r){const r=this.DrawObject,h=r.getScene(),l=[{frame:30*a,value:this._scale.clone()},{frame:30*(i+a),value:ne(s?this._scale.multiplyByFloats(t.x,t.y,t.z):t)}];if(oe(l[0].value,l[1].value))e(null);else{const t=new n.Animation("scale-animate","scaling",30,n.Animation.ANIMATIONTYPE_VECTOR3);(this._animationing.push(t),t.setKeys(l),r.animations.push(t),o&&r.setPivotPoint(ne(o)),h.beginDirectAnimation(r,this._animationing,30*a,30*(i+a),!1)).onAnimationEndObservable.addOnce((()=>{M(this._drawObject.animations,t),M(this._animationing,t),this._scale=l[1].value,e(null)}))}}else this.Scale=t,e(null)}))}opacityTo(e){return new Promise((t=>{this.setPrivateMaterial();var{opacity:i,time:r,startTime:s}=e;const o=[{frame:30*s,value:this._opacity},{frame:30*(s+r),value:i}];if(o[0].value===o[1].value)t(!1);else{const e=new n.Animation("opacity"+this.UniqueName,"alpha",30,n.Animation.ANIMATIONTYPE_FLOAT);(this._animationing.push(e),e.setKeys(o),this._standardMaterial.animations?this._standardMaterial.animations.push(e):this._standardMaterial.animations=[e],this.Scene.beginDirectAnimation(this._standardMaterial,this._animationing,30*s,30*(r+s))).onAnimationEndObservable.add((()=>{this._opacity=o[1].value,t(!0)}))}}))}updateRenderType(e){if(this._renderType!==e||0===this.DrawObject.getChildMeshes.length){this._drawObject.getChildren().forEach((e=>{e.setEnabled(!1)})),this._renderType=e;const t=this.GetDrawObjectFromRenderType(e);!t||t.parent||(t.parent=this._drawObject)}}updateMatrix(){this.CanUpdate&&(n.Matrix.ComposeToRef(this._scale,this._rotationQuaternion,this._position,this._matrix),this.trigger({type:"matrix",target:this}))}updatePart(){if(this.isPart){const e=this.RenderObject;e.position.copyFrom(this._position),e.rotation.copyFrom(this._rotation),e.scaling.copyFrom(this._scale)}}update(){var e;this.isPart?this.updatePart():this.CanUpdate&&this._drawObject&&(this._drawObject.position.copyFrom(this._position),this._drawObject.rotation.copyFrom(this._rotation),this._drawObject.scaling.copyFrom(this._scale),this._drawObject.setEnabled(this._isVisiable),this._drawObject.getChildMeshes().forEach((e=>e.isPickable=this._isPickable)),this.updateDrawObject(null!=(e=this._renderType)?e:_e.renderType,this.RenderObject),this.updateMaterial(),this.trigger({type:"update",target:this}),he.trigger({type:"update",target:this}))}applyMatrix(e){this._matrix.multiplyToRef(e,this._matrix);const t=new n.Quaternion;this._matrix.decompose(this._scale,t,this._scale),t.toEulerAnglesToRef(this._rotation),this.update()}initDrawObject(e){return null}updateDrawObject(e,t){}updateMaterial(){}erase(e=!0){e!==this._erase&&(super.erase(e),this._drawObject.setEnabled(!e),he.trigger({type:"remove",target:this}),this.trigger({type:"remove",target:this}))}destory(){for(var[e,t]of(super.destory(),this._cacheDrawObject))t.dispose(void 0,!0);this._cacheDrawObject.clear(),this._drawObject&&this._drawObject.dispose(void 0,!0),this._drawObject=null}registerAction(e,t){e=pe[e];let i=this.RenderObject;if(i instanceof n.Mesh){if(!i.geometry){let e=i.getChildren().find((e=>"actionHelper"===e.name));if(!e){let t=i.getHierarchyBoundingVectors();t.min.divideToRef(this._scale,t.min),t.max.divideToRef(this._scale,t.max);var r=t.max.y-t.min.y;(e=n.MeshBuilder.CreateBox("actionHelper",{width:t.max.x-t.min.x,height:r,depth:t.max.z-t.min.z},_e.Scene)).visibility=0,e.parent=i,e.position.y=r/2}i=e}i.actionManager||(i.actionManager=new n.ActionManager(this.Scene));const s=i.actionManager.registerAction(new n.ExecuteCodeAction({trigger:e,parameter:"r"},t));return()=>{i.actionManager.unregisterAction(s)}}}move2Zero(e){const t=this.RenderObject;e=e||t.getHierarchyBoundingVectors().min,e=this._position.clone().subtract(e),this.Position=e}renderEdge(e=10,t="#ffffff"){if(this._drawObject)for(const i of this._drawObject.getChildMeshes())i.geometry&&(i.enableEdgesRendering(),i.edgesWidth=e,i.edgesColor=n.Color4.FromHexString(t))}cloneMaterial(){if(this._drawObject)for(const e of this._drawObject.getChildMeshes())e.material&&(e.material=e.material.clone(e.material.name+Date.now()))}emissive(e){if(this._drawObject){var t=e?n.Color3.FromHexString(e):n.Color3.Black;for(const e of this._drawObject.getChildMeshes())e.material&&"emissiveColor"in e.material&&(e.material.emissiveColor=t)}}disabledRenderEdge(){if(this._drawObject)for(const e of this._drawObject.getChildMeshes())e.geometry&&e.disableEdgesRendering()}writeFile(e){super.writeFile(e),e.write(2),e.write(this._name),e.write(this._colorIndex),e.writeArray(this._position.asArray()),e.writeArray(this._rotation.asArray()),e.writeArray(this._scale.asArray()),e.write(this._isPickable),e.write(this._isVisiable),e.write(this._color),e.writeObjectId(this.GroupId)}readFile(e){super.readFile(e);var t=e.read(),i=(this._name=e.read(),this._colorIndex=e.read(),e.read()),r=e.readArray(i);this._position.fromArray(r),i=e.read(),r=e.readArray(i),this._rotation.fromArray(r),n.Quaternion.FromEulerVectorToRef(this._rotation,this._rotationQuaternion),i=e.read(),r=e.readArray(i),this._scale.fromArray(r),this._isPickable=e.read(),this._isVisiable=e.read(),this._color=e.read(),1<t&&(this.GroupId=e.readObjectId()),this.updateMatrix()}_applyHistoryRecord(e){super._applyHistoryRecord(e),e instanceof R?this._drawObject.setEnabled(!this._erase):e instanceof B&&this.readFile(e.Filer)}setPrivateMaterial(){this._standardMaterial||(this._standardMaterial=this.defaultMaterial.clone("material"+this.UniqueName),this.RenderObject.material=this._standardMaterial)}}_e.renderType=u.Conceptual;const fe={debugger:!1,loadPlugins:new Set,assetURL:"",Texture_URL:"",SkyBox_URL:""};class ge{static get MainViewer(){return this._MainViewer}static set MainViewer(e){this._MainViewer=e,this._MainScene=e.Scene}static get MainScene(){return this._MainScene}static get Scene(){return this._Scene}static set Scene(e){this._Scene=e,_e.Scene=e}static StartWait(){this.waiting=!0}static Wait(){if(!this.waiting)return()=>{};let e;var t=new Promise((t=>{e=t}));return this.waitList.push(t),e}static WaitComplete(){return v(this,void 0,void 0,(function*(){return Promise.all(this.waitList).then((e=>(this.waiting=!1,this.waitList.length=0,e)))}))}static getLastPromise(){return A(this.waitList)}}ge.waitList=[],ge.waiting=!1,ge.PreviewMode=!1,ge.Reading=!1,ge.GlobalVariables=[];const me=new class{constructor(){this.assestPromiseCache=new Map}getAssetPromise(e){return this.assestPromiseCache.get(e)}setAssetPromise(e,t){this.assestPromiseCache.set(e,t)}clear(){this.assestPromiseCache.clear()}};let ye=class extends _e{constructor(e={url:""}){super(),this.isAsync=!0,this.isRead=!1,this.uvs=[],this.count=0,this.tessNb=64,this.url=null!=(e=null==e?void 0:e.url)?e:""}move2Zero(e){const t=this.RenderObject;var i;return e||(i=this.BoundingVectors,(e=n.Vector3.Center(i.min,i.max).negate()).y=0),this.Position=t.position.add(e),e}get BoundingBox(){var{min:e,max:t}=this.BoundingVectors;return new w(e,t)}initDrawObject(e){const t=new n.Mesh("import"+this.Id,_e.Scene);if(t.doNotSyncBoundingInfo=!0,this.url){var i=this.url.startsWith("http")?this.url:fe.assetURL+this.url,r=(this.Name||(this.Name=A(this.url.split("/")).split(".")[0]),i+"&"+_e.Scene.uid);const s=me.getAssetPromise(r);if(s)s.then((e=>{const i=this.handleAssetContainer(e);this.model2Zero(i),i.parent=t,this.trigger({type:"load",target:this}),he.trigger({type:"load",target:this})}));else{const s=ge.Wait();me.setAssetPromise(r,ge.getLastPromise()),r=n.SceneLoader.LoadAssetContainer(i,void 0,_e.Scene,(i=>{if(this.isPart||this._db||_e.Scene!==ge.MainScene){for(const e of i.materials)e instanceof n.StandardMaterial&&(e.diffuseColor=n.Color3.White(),e.ambientColor=n.Color3.White(),e.backFaceCulling=!1),e.transparencyMode=n.Material.MATERIAL_ALPHABLEND,e.alpha=this._opacity;var r=t;i.textures.length=0,i.meshes.forEach((e=>e instanceof n.Mesh&&(e.receiveShadows=!0)));const o=this.handleAssetContainer(i);e===u.Wireframe&&i.materials.forEach((e=>e.wireframe=!0)),this.model2Zero(o),this.trigger({type:"load",target:this}),he.trigger({type:"load",target:this}),s(i),o.parent=r}}),(e=>{e=e.lengthComputable?Math.floor(e.loaded/e.total*100):0,this.trigger({type:"loading",target:this,percentage:e}),he.trigger({type:"loading",target:this,percentage:e})}),((e,t)=>{(this.isPart||this._db||_e.Scene!==ge.MainScene)&&(this.trigger({type:"load",target:this,error:t}),he.trigger({type:"load",target:this,error:t}))})),fe.loadPlugins.add(r)}}return t}uvOffset(e){_e.Scene.registerBeforeRender((()=>{e.bumpTexture.uOffset=e.bumpTexture.uOffset+.001}))}updateMaterial(){}writeFile(e){super.writeFile(e),e.write(1),e.write(this.url)}readFile(e){this.isRead=!0,super.readFile(e),e.read(),this.url=e.read(),this.update()}model2Zero(e){var t=e.getHierarchyBoundingVectors();const i=n.Vector3.Center(t.min,t.max),r=(i.y=t.min.y,i.negate());e.position=r,this.isRead||(this.Position=r.negate(),this.isRead=!1)}handleAssetContainer(e){let t=e.instantiateModelsToScene((e=>e+this.Id));if(this.modelAnimations=t.animationGroups,1===t.rootNodes.length)return t.rootNodes[0];{const e=new n.TransformNode("assetContainerRootMesh",_e.Scene);return t.rootNodes.forEach((t=>{t.parent||(t.parent=e)})),e}}get Opacity(){return this._opacity}set Opacity(e){if(e!==this._opacity){this.writeSnapshoot(),this._opacity=e;for(const t of this._drawObject.getChildMeshes())t.material&&(t.material.transparencyMode=n.Material.MATERIAL_ALPHABLEND,t.material.alpha=e)}}};ye.type="ImportEntity",ye=y([E],ye);class ve extends L{constructor(){super(...arguments),this._position={x:"0",y:"0"},this._rotation=0,this._scale={x:1,y:1},this.isSelect=!1,this._isVisiable=!0,this._horAlign=0,this._verAlign=0,this._isPickable=!0,this._hasTransition=!1}get Name(){var e;return null!=(e=this._name)?e:"\u56fe\u6807"+this.Id}set Name(e){this._name=e,he.trigger({type:"updateName",target:this})}get DrawObject(){return this._drawObject||(this._drawObject=this.initDrawObject(),this._drawObject.metadata={entity:this},this._drawObject.style.display=this._isVisiable&&!this._erase?"block":"none",this._drawObject)}get Visiable(){return this._isVisiable}set Visiable(e){e!==this._isVisiable&&(this.writeSnapshoot(),this._isVisiable=e,this.update())}get IsPickable(){return this._isPickable}set IsPickable(e){this._isPickable=e,this.update()}get Position(){return Object.assign({},this._position)}set Position(e){V(this._position,e)||(this.writeSnapshoot(),this._position.x=e.x,this._position.y=e.y,this.update())}get Rotation(){return this._rotation}set Rotation(e){e!==this._rotation&&(this.writeSnapshoot(),this._rotation=e,this.update())}get Scale(){return this._scale}set Scale(e){V(this._scale,e)||(this.writeSnapshoot(),this._scale=e,this.update())}get IsSelect(){return this.isSelect}set IsSelect(e){e!==this.isSelect&&(this.isSelect=e,this._drawObject&&(this._drawObject.style.outline=e?"2px solid #cccccc":"none"))}get Draging(){return!!this._start}get Width(){return this._width}set Width(e){e!==this._width&&(this.writeSnapshoot(),this._width=e,this.update())}get Height(){return this._height}set Height(e){e!==this._height&&(this.writeSnapshoot(),this._height=e,this.update())}get HorAlign(){return this._horAlign}set HorAlign(e){e!==this._horAlign&&(this.writeSnapshoot(),this._horAlign=e,this.update())}get VerAlign(){return this._verAlign}set VerAlign(e){e!==this._verAlign&&(this.writeSnapshoot(),this._verAlign=e,this.update())}get HasTransition(){return this._hasTransition}set HasTransition(e){e!==this._hasTransition&&(this.writeSnapshoot(),this._hasTransition=e,this.update())}start(e,t){this._db&&this._db.HistoryManager.startCmd("\u62d6\u62fdDOM"),this.writeSnapshoot(),this._start=new n.Vector2(e,t)}end(){this._start=null,this._db&&this._db.HistoryManager.endCmd()}move(e,t,i=this._drawObject){var r,n,s;i&&(i=e-this._start.x,r=t-this._start.y,s=this.convertValue(this._position.x,ge.MainViewer.Width),n=this.convertValue(this._position.y,ge.MainViewer.Height),s=2===this._horAlign?s-i:s+i,this._verAlign,i=n+r,this.Position={x:s/ge.MainViewer.Width*100+"%",y:i/ge.MainViewer.Height*100+"%"},this._start.set(e,t))}initDrawObject(){return null}updateDrawObject(e){e.style.width=this.convertValue(this._width,ge.MainViewer.Width)+"px",e.style.height=this.convertValue(this._height,ge.MainViewer.Height)+"px",this.setPosition(e),e.style.zIndex="2",e.style.overflow="hidden",e.style.transform=`rotate(${this._rotation}deg) scale(${this._scale.x},${this._scale.y})`,e.style.transition=this._hasTransition?"all .1s":"",e.style.display=this._isVisiable?"block":"none",e.style.pointerEvents=this._isPickable?"auto":"none"}update(){this._drawObject&&(this.updateDrawObject(this._drawObject),this.trigger({type:"update",target:this}),he.trigger({type:"update",target:this}))}erase(e=!0){e!==this._erase&&(super.erase(e),this._drawObject.style.display=e?"none":"block",he.trigger({type:"remove",target:this}),this.trigger({type:"remove",target:this}))}destory(){super.destory(),this._drawObject&&this._drawObject.remove(),this._drawObject=null}writeFile(e){super.writeFile(e),e.write(5),e.write(this._position.x),e.write(this._position.y),e.write(this._rotation),e.write(this._scale.x),e.write(this._scale.y),e.write(this._width),e.write(this._height),e.write(this._isVisiable),e.write(this._name),e.write(this._horAlign),e.write(this._verAlign),e.write(this._isPickable),e.write(this._hasTransition)}readFile(e){super.readFile(e);var t=e.read();this._position.x=e.read(),this._position.y=e.read(),this._rotation=e.read(),this._scale.x=e.read(),this._scale.y=e.read(),this._width=e.read(),this._height=e.read(),this._isVisiable=e.read(),1<t&&(this._name=e.read()),2<t&&(this._horAlign=e.read(),this._verAlign=e.read()),3<t&&(this._isPickable=e.read()),4<t&&(this._hasTransition=e.read())}_applyHistoryRecord(e){super._applyHistoryRecord(e),e instanceof R?this._drawObject.style.display=this._erase?"none":"block":e instanceof B&&this.readFile(e.Filer)}convertValue(e,t){return"string"==typeof e?e.endsWith("%")?parseFloat(e)/100*t:parseFloat(e):e}setPosition(e){var t=this.convertValue(this._position.x,ge.MainViewer.Width),i=this.convertValue(this._position.y,ge.MainViewer.Height),r=this.convertValue(this._width,ge.MainViewer.Width),n=this.convertValue(this._height,ge.MainViewer.Height);0===this._horAlign?(e.style.left=t+"px",e.style.right="auto"):2===this._horAlign?(e.style.right=t+"px",e.style.left="auto"):(e.style.left=ge.MainViewer.Width/2-r/2+"px",e.style.right="auto"),0===this._verAlign?(e.style.top=i+"px",e.style.bottom="auto"):2===this._verAlign?(e.style.bottom=i+"px",e.style.top="auto"):(e.style.top=ge.MainViewer.Height/2-n/2+"px",e.style.bottom="auto")}}class be extends s.MultiLine{_draw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._applyStates(e),e.strokeStyle=this.color,e.lineWidth=this.lineWidth,e.setLineDash(this.dash),e.beginPath();let t,i=!0,r=this._points.slice();var s,o,a;2===r.length&&(s=r[0]._point,o=r[1]._point,U(s.x,o.x)||U(s.y,o.y)||(a=n.Vector3.Center(s,o),r=[r[0],{_point:{x:s.x,y:a.y,z:a.z}},{_point:{x:o.x,y:a.y,z:a.z}},r[1]])),r.forEach((r=>{r&&(i?(e.moveTo(r._point.x,r._point.y),i=!1):r._point.z<1&&t.z<1?e.lineTo(r._point.x,r._point.y):e.moveTo(r._point.x,r._point.y),t=r._point)})),e.stroke(),e.restore()}}class we extends L{constructor(){super(...arguments),this.Is3D=!1,this._color="#000000",this._fontSize="12px",this._width="200px",this._height="30px",this._rotation=0,this._scale={x:1,y:1},this._zIndex=0,this._alpha=.9,this._end=new n.Vector2,this._position={x:"0",y:"0"},this._isSelect=!1,this._name="",this.dataList=[],this._isVisiable=!0,this._isPickable=!0,this.lines=[],this.drag=e=>{var t;this._start&&([e,t]=[-(e=this._start.subtract(new n.Vector2(e.x,e.y))).x+this._end.x,-e.y+this._end.y],this.move({x:e,y:t}))}}get DataList(){return[...this.dataList]}set DataList(e){this.dataList=e}get UniqueName(){return this.constructor.type+this.Id}get Name(){return this._name||this.UniqueName}set Name(e){this._name=e,he.trigger({type:"updateName",target:this})}get Position(){return Object.assign({},this._position)}set Position(e){this.writeSnapshoot(),this._position.x=e.x,this._position.y=e.y,this.move(e)}get Rotation(){return this._rotation}set Rotation(e){this.writeSnapshoot(),this._rotation=e,this._drawObject.rotation=e}get Scale(){return Object.assign({},this._scale)}set Scale(e){this.writeSnapshoot(),Object.assign(this._scale,e),this._drawObject.scaleX=e.x,this._drawObject.scaleY=e.y}get Width(){return this._width}set Width(e){e!==this._width&&(this.writeSnapshoot(),this._width=e,this.update())}get Height(){return this._height}set Height(e){e!==this._height&&(this.writeSnapshoot(),this._height=e,this.update())}get DrawObject(){return this._drawObject||(this._drawObject=this.initDrawObject(),this._drawObject.metadata={entity:this},this._drawObject.isVisible=this._isVisiable&&!this._erase,this.supportDrag(),this._drawObject)}get Draging(){return!!this._start}get IsSelect(){return this._isSelect}set IsSelect(e){this._isSelect=e,this._drawObject&&(this._drawObject.shadowColor=e?"#000000":"#168df8")}get Visiable(){return this._isVisiable}set Visiable(e){e!==this._isVisiable&&(this.writeSnapshoot(),this._isVisiable=e,this.update())}get IsPickable(){return this._isPickable}set IsPickable(e){this._isPickable=e}attachEntity(e){this.linkEntity=e}initDrawObject(){return null}setProp(e,t){for(const i of this.dataList)i.key===e&&(i.value=t)}updateDrawObject(e){e.width=this._width,e.color=this._color,e.rotation=this._rotation,e.scaleX=this._scale.x,e.scaleY=this._scale.y,e.zIndex=this._zIndex,e.fontSize=this._fontSize,e.alpha=this._alpha,e.isVisible=this._isVisiable,this.lines.forEach((e=>e.isVisible=this._isVisiable)),this.move(this._position,e)}update(){this._drawObject&&(this.updateDrawObject(this._drawObject),this.trigger({type:"update",target:this}),he.trigger({type:"update",target:this}))}move(e,t=this._drawObject){var i,r;t&&(i=ge.MainViewer.Width,r=ge.MainViewer.Height,this.linkEntity?(t.linkOffsetX=e.x,t.linkOffsetY=e.y,this._position.x=e.x.toString(),this._position.y=e.y.toString()):("number"==typeof e.x?(t.left=e.x/i*100+"%",this._position.x=e.x/i*100+"%"):(t.left=e.x,this._position.x=e.x),"number"==typeof e.y?(t.top=e.y/r*100+"%",this._position.y=e.y/r*100+"%"):(t.top=e.y,this._position.y=e.y)),he.trigger({type:"update",target:this}),this.trigger({type:"update",target:this}))}erase(e=!0){e!==this._erase&&(super.erase(e),this._drawObject.isVisible=!e,this.lines.forEach((t=>t.isVisible=!e)),he.trigger({type:"remove",target:this}),this.trigger({type:"remove",target:this}))}destory(){super.destory(),this._drawObject&&this._drawObject.dispose(),this._drawObject=null,this.lines.forEach((e=>e.dispose())),this.lines.length=0}writeFile(e){super.writeFile(e),e.write(2),e.write(this._position.x),e.write(this._position.y),e.write(this._rotation),e.write(this._scale.x),e.write(this._scale.y),e.write(this._name),e.write(this._width),e.write(this._height),e.write(this._color),e.write(this._zIndex),e.write(this._fontSize),e.write(this._alpha),e.writeObjectId(this.linkEntity),e.writeAnyArray(this.dataList,(t=>{e.write(t.key),e.write(t.label),e.write(t.value),e.write(t.unit)})),e.write(this._isVisiable)}readFile(e){super.readFile(e);var t=e.read();this._position.x=e.read(),this._position.y=e.read(),this._rotation=e.read(),this._scale.x=e.read(),this._scale.y=e.read(),this._name=e.read(),this._width=e.read(),this._height=e.read(),this._color=e.read(),this._zIndex=e.read(),this._fontSize=e.read(),this._alpha=e.read(),this.linkEntity=e.readObjectId(),this.dataList.length=0,e.readAnyArray((()=>{const t={};t.key=e.read(),t.label=e.read(),t.value=e.read(),t.unit=e.read(),this.dataList.push(t)})),1<t&&(this._isVisiable=e.read())}_applyHistoryRecord(e){super._applyHistoryRecord(e),e instanceof R?this._drawObject.isVisible=!this._erase:e instanceof B&&this.readFile(e.Filer)}getPositionValue(e,t){return"string"==typeof e?e.endsWith("%")?parseFloat(e)/100*t:parseFloat(e):e}supportDrag(){this._drawObject.isPointerBlocker=!0,this._drawObject.onPointerDownObservable.add((e=>{if(this._isPickable&&(he.trigger({type:"pointerDownGui",target:this,point:e}),!ge.PreviewMode)){this._db&&this._db.HistoryManager.startCmd("\u62d6\u62fdGUI"),this.writeSnapshoot(),this._start=new n.Vector2(e.x,e.y);let i=this._drawObject.left,r=this._drawObject.top;this.linkEntity&&(i=this._drawObject.linkOffsetX,r=this._drawObject.linkOffsetY);e=ge.MainViewer.Width;var t=ge.MainViewer.Height;e=this.getPositionValue(i,e),t=this.getPositionValue(r,t);this._end=new n.Vector2(e,t),this._drawObject.isPointerBlocker=!1}})),this._drawObject.onPointerUpObservable.add((e=>{he.trigger({type:"pointerUpGui",target:this,point:e}),this._start=null,this._drawObject.isPointerBlocker=!0,this._db&&this._db.HistoryManager.endCmd()}))}generateLinkLine(e,t=0){setTimeout((()=>{var t;if(null!=(t=this.linkEntity)&&t.Object){const t=new be("linkLine"+this.Id);(t.color="#697d93",t.lineWidth=3,t.add(e),t.getAt(1)).mesh=this.linkEntity.Object.RenderObject,e.zIndex=1,e.parent.addControl(t),e.linkWithMesh(this.linkEntity.Object.DrawObject),e.linkOffsetY=-parseFloat(this._height)+"px",this.move(this.Position,e),this.lines.push(t)}}),t)}}var xe=function(){function e(e,t,i,r){this.initialize(e,t=void 0!==t&&t,i,r)}return e.prototype.initialize=function(e,t,i,r){return void 0===t&&(t=!1),this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=r,this},e}(),Te=function(e,t,i){void 0===i&&(i=null),this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1},Ce=function(){function e(e){this._observers=new Array,this._eventState=new xe(0),e&&(this._onObserverAdded=e)}return e.FromPromise=function(t,i){var r=new e;return t.then((function(e){r.notifyObservers(e)})).catch((function(e){if(!i)throw e;i.notifyObservers(e)})),r},Object.defineProperty(e.prototype,"observers",{get:function(){return this._observers},enumerable:!1,configurable:!0}),e.prototype.add=function(e,t,i,r,n){return void 0===i&&(i=!1),void 0===n&&(n=!1),e?((e=new Te(e,t=void 0===t?-1:t,r=void 0===r?null:r)).unregisterOnNextCall=n,i?this._observers.unshift(e):this._observers.push(e),this._onObserverAdded&&this._onObserverAdded(e),e):null},e.prototype.addOnce=function(e){return this.add(e,void 0,void 0,void 0,!0)},e.prototype.remove=function(e){return!!e&&-1!==this._observers.indexOf(e)&&(this._deferUnregister(e),!0)},e.prototype.removeCallback=function(e,t){for(var i=0;i<this._observers.length;i++){var r=this._observers[i];if(!(r._willBeUnregistered||r.callback!==e||t&&t!==r.scope))return this._deferUnregister(r),!0}return!1},e.prototype._deferUnregister=function(e){var t=this;e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout((function(){t._remove(e)}),0)},e.prototype._remove=function(e){return!!e&&(-1!==(e=this._observers.indexOf(e))&&(this._observers.splice(e,1),!0))},e.prototype.makeObserverTopPriority=function(e){this._remove(e),this._observers.unshift(e)},e.prototype.makeObserverBottomPriority=function(e){this._remove(e),this._observers.push(e)},e.prototype.notifyObservers=function(e,t,i,r,n){if(!this._observers.length)return!0;var s=this._eventState;s.mask=t=void 0===t?-1:t,s.target=i,s.currentTarget=r,s.skipNextObservers=!1,s.lastReturnValue=e,s.userInfo=n;for(var o=0,a=this._observers;o<a.length;o++){var h=a[o];if(!h._willBeUnregistered&&(h.mask&t&&(h.scope?s.lastReturnValue=h.callback.apply(h.scope,[e,s]):s.lastReturnValue=h.callback(e,s),h.unregisterOnNextCall&&this._deferUnregister(h)),s.skipNextObservers))return!1}return!0},e.prototype.notifyObserversWithPromise=function(e,t,i,r,n){var s=this,o=(void 0===t&&(t=-1),Promise.resolve(e));if(!this._observers.length)return o;var a=this._eventState;return a.mask=t,a.target=i,a.currentTarget=r,a.skipNextObservers=!1,a.userInfo=n,this._observers.forEach((function(i){a.skipNextObservers||i._willBeUnregistered||i.mask&t&&(o=i.scope?o.then((function(t){return a.lastReturnValue=t,i.callback.apply(i.scope,[e,a])})):o.then((function(t){return a.lastReturnValue=t,i.callback(e,a)})),i.unregisterOnNextCall&&s._deferUnregister(i))})),o.then((function(){return e}))},e.prototype.notifyObserver=function(e,t,i){var r;void 0===i&&(i=-1),e._willBeUnregistered||((r=this._eventState).mask=i,r.skipNextObservers=!1,e.callback(t,r),e.unregisterOnNextCall&&this._deferUnregister(e))},e.prototype.hasObservers=function(){return 0<this._observers.length},e.prototype.clear=function(){this._observers=new Array,this._onObserverAdded=null},e.prototype.clone=function(){var t=new e;return t._observers=this._observers.slice(0),t},e.prototype.hasSpecificMask=function(e){void 0===e&&(e=-1);for(var t=0,i=this._observers;t<i.length;t++){var r=i[t];if(r.mask&e||r.mask===e)return!0}return!1},e}();function Ee(){return"undefined"!=typeof window}function Se(){return"undefined"!=typeof navigator}function Pe(){return"undefined"!=typeof document}function Re(e){for(var t="",i=e.firstChild;i;)3===i.nodeType&&(t+=i.textContent),i=i.nextSibling;return t}var Ae={IsWindowObjectExist:Ee,IsNavigatorAvailable:Se,IsDocumentAvailable:Pe,GetDOMTextContent:Re},Me=function(){function e(){}return e._CheckLimit=function(t,i){var r=e._LogLimitOutputs[t];return r?r.current++:e._LogLimitOutputs[t]=r={limit:i,current:1},r.current<=r.limit},e._GenerateLimitMessage=function(t,i){var r=e._LogLimitOutputs[t];if(r&&e.MessageLimitReached&&r.current===r.limit)switch(i){case 0:e.Log(e.MessageLimitReached.replace(/%LIMIT%/g,""+r.limit).replace(/%TYPE%/g,"log"));break;case 1:e.Warn(e.MessageLimitReached.replace(/%LIMIT%/g,""+r.limit).replace(/%TYPE%/g,"warning"));break;case 2:e.Error(e.MessageLimitReached.replace(/%LIMIT%/g,""+r.limit).replace(/%TYPE%/g,"error"))}},e._AddLogEntry=function(t){e._LogCache=t+e._LogCache,e.OnNewCacheEntry&&e.OnNewCacheEntry(t)},e._FormatMessage=function(e){function t(e){return e<10?"0"+e:""+e}var i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e},e._LogDisabled=function(e,t){},e._LogEnabled=function(t,i){void 0!==i&&!e._CheckLimit(t,i)||(i=e._FormatMessage(t),e._AddLogEntry("<div style='color:white'>"+i+"</div><br>"),e._GenerateLimitMessage(t,0))},e._WarnDisabled=function(e,t){},e._WarnEnabled=function(t,i){void 0!==i&&!e._CheckLimit(t,i)||(i=e._FormatMessage(t),e._AddLogEntry("<div style='color:orange'>"+t+"</div><br>"),e._GenerateLimitMessage(t,1))},e._ErrorDisabled=function(e,t){},e._ErrorEnabled=function(t,i){void 0!==i&&!e._CheckLimit(t,i)||(i=e._FormatMessage(t),e.errorsCount++,e._AddLogEntry("<div style='color:red'>"+i+"</div><br>"),e._GenerateLimitMessage(t,2))},Object.defineProperty(e,"LogCache",{get:function(){return e._LogCache},enumerable:!1,configurable:!0}),e.ClearLogCache=function(){e._LogCache="",e._LogLimitOutputs={},e.errorsCount=0},Object.defineProperty(e,"LogLevels",{set:function(t){e.Log=(t&e.MessageLogLevel)===e.MessageLogLevel?e._LogEnabled:e._LogDisabled,e.Warn=(t&e.WarningLogLevel)===e.WarningLogLevel?e._WarnEnabled:e._WarnDisabled,e.Error=(t&e.ErrorLogLevel)===e.ErrorLogLevel?e._ErrorEnabled:e._ErrorDisabled},enumerable:!1,configurable:!0}),e.NoneLogLevel=0,e.MessageLogLevel=1,e.WarningLogLevel=2,e.ErrorLogLevel=4,e.AllLogLevel=7,e.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",e._LogCache="",e._LogLimitOutputs={},e.errorsCount=0,e.Log=e._LogEnabled,e.Warn=e._WarnEnabled,e.Error=e._ErrorEnabled,e}(),Oe=function(e,t){return!e||e.getClassName&&"Mesh"===e.getClassName()?null:e.getClassName&&"SubMesh"===e.getClassName()?e.clone(t):e.clone?e.clone():null};var Ie=function(){function e(){}return e.DeepCopy=function(e,t,i,r){for(var n=0,s=function(e){for(var t=[];Object.getOwnPropertyNames(e).forEach((function(e){-1===t.indexOf(e)&&t.push(e)})),e=Object.getPrototypeOf(e););return t}(e);n<s.length;n++){var o=s[n];if(("_"!==o[0]||r&&-1!==r.indexOf(o))&&!(o.endsWith("Observable")||i&&-1!==i.indexOf(o))){var a=e[o],h=typeof a;if("function"!=h)try{if("object"==h)if(a instanceof Array){if(t[o]=[],0<a.length)if("object"==typeof a[0])for(var l=0;l<a.length;l++){var c=Oe(a[l],t);-1===t[o].indexOf(c)&&t[o].push(c)}else t[o]=a.slice(0)}else t[o]=Oe(a,t);else t[o]=a}catch(e){Me.Warn(e.message)}}}},e}(),Fe=function(){function e(){}return Object.defineProperty(e,"Now",{get:function(){return(Ae.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance:Date).now()},enumerable:!1,configurable:!0}),e}();function De(e){return"".concat(e," needs to be imported before as it contains a side-effect required by your code.")}var Le,Be,Ne=function(){function e(){this._xhr=new("undefined"!=typeof _native&&_native.XMLHttpRequest?_native.XMLHttpRequest:XMLHttpRequest),this._requestURL=""}return e.prototype._injectCustomRequestHeaders=function(){if(!this._shouldSkipRequestModifications(this._requestURL))for(var t in e.CustomRequestHeaders){var i=e.CustomRequestHeaders[t];i&&this._xhr.setRequestHeader(t,i)}},e.prototype._shouldSkipRequestModifications=function(t){return e.SkipRequestModificationForBabylonCDN&&(t.includes("preview.babylonjs.com")||t.includes("cdn.babylonjs.com"))},Object.defineProperty(e.prototype,"onprogress",{get:function(){return this._xhr.onprogress},set:function(e){this._xhr.onprogress=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._xhr.readyState},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"status",{get:function(){return this._xhr.status},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"statusText",{get:function(){return this._xhr.statusText},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"response",{get:function(){return this._xhr.response},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"responseURL",{get:function(){return this._xhr.responseURL},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"responseText",{get:function(){return this._xhr.responseText},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"responseType",{get:function(){return this._xhr.responseType},set:function(e){this._xhr.responseType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"timeout",{get:function(){return this._xhr.timeout},set:function(e){this._xhr.timeout=e},enumerable:!1,configurable:!0}),e.prototype.addEventListener=function(e,t,i){this._xhr.addEventListener(e,t,i)},e.prototype.removeEventListener=function(e,t,i){this._xhr.removeEventListener(e,t,i)},e.prototype.abort=function(){this._xhr.abort()},e.prototype.send=function(t){e.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(t)},e.prototype.open=function(t,i){for(var r=0,n=e.CustomRequestModifiers;r<n.length;r++){var s=n[r];if(this._shouldSkipRequestModifications(i))return;s(this._xhr,i)}return i=(i=i.replace("file:http:","http:")).replace("file:https:","https:"),this._requestURL=i,this._xhr.open(t,i,!0)},e.prototype.setRequestHeader=function(e,t){this._xhr.setRequestHeader(e,t)},e.prototype.getResponseHeader=function(e){return this._xhr.getResponseHeader(e)},e.CustomRequestHeaders={},e.CustomRequestModifiers=new Array,e.SkipRequestModificationForBabylonCDN=!0,e}(),ke=function(){function e(){}return Object.defineProperty(e,"LastCreatedEngine",{get:function(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LastCreatedScene",{get:function(){return this._LastCreatedScene},enumerable:!1,configurable:!0}),e.Instances=new Array,e._LastCreatedScene=null,e.UseFallbackTexture=!0,e.FallbackTexture="",e}(),Ue=function(){function e(){}return e.FilesToLoad={},e}(),ze=function(){function e(){}return e.ExponentialBackoff=function(e,t){return void 0===e&&(e=3),void 0===t&&(t=500),function(i,r,n){return 0!==r.status||e<=n||-1!==i.indexOf("file:")?-1:Math.pow(2,n)*t}},e}(),Ge=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t._setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t}(Error),Ve=4e3,je=4001,We=4002,He=function(e){function t(i,r,n){return(i=e.call(this,i)||this).errorCode=r,i.innerError=n,i.name="RuntimeError",Ge._setPrototypeOf(i,t.prototype),i}return c(t,e),t}(Ge),Ke=function(e){return atob(e)},Xe=function(){function e(){this.children=[]}return e.prototype.isValid=function(e){return!0},e.prototype.process=function(e,t){var i,r,n="";return this.line&&(i=this.line,(r=t.processor)&&(r.lineProcessor&&(i=r.lineProcessor(i,t.isFragment,t.processingContext)),r.attributeProcessor&&this.line.startsWith("attribute")?i=r.attributeProcessor(this.line,e,t.processingContext):r.varyingProcessor&&this.line.startsWith("varying")?i=r.varyingProcessor(this.line,t.isFragment,e,t.processingContext):r.uniformProcessor&&r.uniformRegexp&&r.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(i=r.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):r.uniformBufferProcessor&&r.uniformBufferRegexp&&r.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(i=r.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):r.textureProcessor&&r.textureRegexp&&r.textureRegexp.test(this.line)?i=r.textureProcessor(this.line,t.isFragment,e,t.processingContext):(r.uniformProcessor||r.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?r.uniformProcessor&&(i=r.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):r.uniformBufferProcessor&&(i=r.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=!1,r.endOfUniformBufferProcessor&&(i=r.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))),n+=i+"\r\n"),this.children.forEach((function(i){n+=i.process(e,t)})),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),n},e}(),qe=function(){function e(){}return Object.defineProperty(e.prototype,"currentLine",{get:function(){return this._lines[this.lineIndex]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canRead",{get:function(){return this.lineIndex<this._lines.length-1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lines",{set:function(e){this._lines=[];for(var t=0,i=e;t<i.length;t++){var r=i[t];if("#"===r[0])this._lines.push(r);else if(r.trim().startsWith("//"))this._lines.push(r);else for(var n=r.split(";"),s=0;s<n.length;s++){var o=n[s];(o=o.trim())&&this._lines.push(o+(s!==n.length-1?";":""))}}},enumerable:!1,configurable:!0}),e}(),Ye=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.process=function(e,t){for(var i=0;i<this.children.length;i++){var r=this.children[i];if(r.isValid(e))return r.process(e,t)}return""},t}(Xe),Ze=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.isValid=function(e){return this.testExpression.isTrue(e)},t}(Xe),Qe=function(){function e(){}return e.prototype.isTrue=function(e){return!0},e.postfixToInfix=function(t){for(var i=[],r=0,n=t;r<n.length;r++){var s,o,a=n[r];void 0===e._OperatorPriority[a]?i.push(a):(s=i[i.length-1],o=i[i.length-2],i.length-=2,i.push("(".concat(o).concat(a).concat(s,")")))}return i[i.length-1]},e.infixToPostfix=function(t){function i(){""!==(l=l.trim())&&(o.push(l),l="")}function r(t){a<e._Stack.length-1&&(e._Stack[++a]=t)}function n(){return e._Stack[a]}function s(){return-1===a?"!!INVALID EXPRESSION!!":e._Stack[a--]}for(var o=[],a=-1,h=0,l="";h<t.length;){var c=t.charAt(h),u=h<t.length-1?t.substr(h,2):"";if("("===c)l="",r(c);else if(")"===c){for(i();-1!==a&&"("!==n();)o.push(s());s()}else if(1<e._OperatorPriority[u]){for(i();-1!==a&&e._OperatorPriority[n()]>=e._OperatorPriority[u];)o.push(s());r(u),h++}else l+=c;h++}for(i();-1!==a;)"("===n()?s():o.push(s());return o},e._OperatorPriority={")":0,"(":1,"||":2,"&&":3},e._Stack=["","","","","","","","","","","","","","","","","","","",""],e}(),Je=function(e){function t(t,i){void 0===i&&(i=!1);var r=e.call(this)||this;return r.define=t,r.not=i,r}return c(t,e),t.prototype.isTrue=function(e){return e=void 0!==e[this.define],this.not?!e:e},t}(Qe),$e=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.isTrue=function(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)},t}(Qe),et=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.isTrue=function(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)},t}(Qe),tt=function(e){function t(t,i,r){var n=e.call(this)||this;return n.define=t,n.operand=i,n.testValue=r,n}return c(t,e),t.prototype.isTrue=function(e){var t=(void 0===(e=e[this.define])&&(e=this.define),!1),i=parseInt(e),r=parseInt(this.testValue);switch(this.operand){case">":t=r<i;break;case"<":t=i<r;break;case"<=":t=i<=r;break;case">=":t=r<=i;break;case"==":t=i===r}return t},t}(Qe),it=(function(e){e[e.GLSL=0]="GLSL",e[e.WGSL=1]="WGSL"}(Le=Le||{}),/defined\s*?\((.+?)\)/g),rt=/defined\s*?\[(.+?)\]/g,nt=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,st=function(){function e(){}return e.Initialize=function(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)},e.Process=function(e,t,i,r){var n,s=this;null!=(n=t.processor)&&n.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,(function(e){t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e)),e=s._ProcessShaderConversion(e,t,r),i(e)}))},e.PreProcess=function(e,t,i,r){var n,s=this;null!=(n=t.processor)&&n.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,(function(e){t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e)),e=s._ApplyPreProcessing(e,t,r),i(e)}))},e.Finalize=function(e,t,i){return i.processor&&i.processor.finalizeShaders?i.processor.finalizeShaders(e,t,i.processingContext):{vertexCode:e,fragmentCode:t}},e._ProcessPrecision=function(e,t){if(null!=(i=t.processor)&&i.noPrecision)return e;var i=t.shouldUseHighPrecisionShader;return-1===e.indexOf("precision highp float")?e=i?"precision highp float;\n"+e:"precision mediump float;\n"+e:i||(e=e.replace("precision highp float","precision mediump float")),e},e._ExtractOperation=function(e){if((s=/defined\((.+)\)/.exec(e))&&s.length)return new Je(s[1].trim(),"!"===e[0]);for(var t="",i=0,r=0,n=["==",">=","<=","<",">"];r<n.length&&!(-1<(i=e.indexOf(t=n[r])));r++);if(-1===i)return new Je(e);var s=e.substring(0,i).trim(),o=e.substring(i+t.length).trim();return new tt(s,t,o)},e._BuildSubExpression=function(e){e=e.replace(it,"defined[$1]");for(var t=[],i=0,r=Qe.infixToPostfix(e);i<r.length;i++){var n,s,o=r[i];"||"!==o&&"&&"!==o?t.push(o):2<=t.length&&(n=t[t.length-1],s=t[t.length-2],t.length-=2,o=new("&&"==o?et:$e),"string"==typeof n&&(n=n.replace(rt,"defined($1)")),"string"==typeof s&&(s=s.replace(rt,"defined($1)")),o.leftOperand="string"==typeof s?this._ExtractOperation(s):s,o.rightOperand="string"==typeof n?this._ExtractOperation(n):n,t.push(o))}return"string"==typeof(e="string"==typeof(e=t[t.length-1])?e.replace(rt,"defined($1)"):e)?this._ExtractOperation(e):e},e._BuildExpression=function(e,t){var i=new Ze,r=e.substring(0,t);e=(e=e.substring(t)).substring(0,(e.indexOf("//")+1||e.length+1)-1).trim();return i.testExpression="#ifdef"===r?new Je(e):"#ifndef"===r?new Je(e,!0):this._BuildSubExpression(e),i},e._MoveCursorWithinIf=function(e,t,i){for(var r=e.currentLine;this._MoveCursor(e,i);){var n,s=(r=e.currentLine).substring(0,5).toLowerCase();if("#else"===s)return n=new Xe,t.children.push(n),void this._MoveCursor(e,n);"#elif"===s&&(n=this._BuildExpression(r,5),t.children.push(n),i=n)}},e._MoveCursor=function(e,t){for(;e.canRead;){e.lineIndex++;var i,r,n=e.currentLine;if((r=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(n))&&r.length)switch(r[0]){case"#ifdef":var s=new Ye,o=(t.children.push(s),this._BuildExpression(n,6));s.children.push(o),this._MoveCursorWithinIf(e,s,o);break;case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":s=new Ye,t.children.push(s),o=this._BuildExpression(n,7),s.children.push(o),this._MoveCursorWithinIf(e,s,o);break;case"#if":s=new Ye,o=this._BuildExpression(n,3),t.children.push(s),s.children.push(o),this._MoveCursorWithinIf(e,s,o)}else(r=new Xe).line=n,t.children.push(r),"#"===n[0]&&"d"===n[1]&&(i=n.replace(";","").split(" "),r.additionalDefineKey=i[1],3===i.length&&(r.additionalDefineValue=i[2]))}return!1},e._EvaluatePreProcessors=function(e,t,i){var r=new Xe,n=new qe;return n.lineIndex=-1,n.lines=e.split("\n"),this._MoveCursor(n,r),r.process(t,i)},e._PreparePreProcessors=function(e,t){for(var i,r={},n=0,s=e.defines;n<s.length;n++){var o=s[n].replace("#define","").replace(";","").trim().split(" ");r[o[0]]=1<o.length?o[1]:""}return(null==(i=e.processor)?void 0:i.shaderLanguage)===Le.GLSL&&(r.GL_ES="true"),r.__VERSION__=e.version,r[e.platformName]="true",t._getGlobalDefines(r),r},e._ProcessShaderConversion=function(e,t,i){if(e=this._ProcessPrecision(e,t),!t.processor)return e;if(t.processor.shaderLanguage===Le.GLSL&&-1!==e.indexOf("#version 3"))return e.replace("#version 300 es","");var r=t.defines,n=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(e=t.processor.preProcessor(e,r,t.isFragment,t.processingContext)),e=this._EvaluatePreProcessors(e,n,t),t.processor.postProcessor&&(e=t.processor.postProcessor(e,r,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining?i.inlineShaderCode(e):e},e._ApplyPreProcessing=function(e,t,i){var r,n=t.defines,s=this._PreparePreProcessors(t,i);return null!=(r=t.processor)&&r.preProcessor&&(e=t.processor.preProcessor(e,n,t.isFragment,t.processingContext)),e=this._EvaluatePreProcessors(e,s,t),null!=(r=t.processor)&&r.postProcessor&&(e=t.processor.postProcessor(e,n,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining?i.inlineShaderCode(e):e},e._ProcessIncludes=function(t,i,r){for(var n=this,s=nt.exec(t),o=new String(t),a=!1;null!=s;){var h=function(){var h=s[1];if(-1!==h.indexOf("__decl__")&&(h=h.replace(/__decl__/,""),i.supportsUniformBuffers&&(h=(h=h.replace(/Vertex/,"Ubo")).replace(/Fragment/,"Ubo")),h+="Declaration"),!i.includesShadersStore[h])return _=i.shadersRepository+"ShadersInclude/"+h+".fx",e._FileToolsLoadFile(_,(function(e){i.includesShadersStore[h]=e,n._ProcessIncludes(o,i,r)})),{value:void 0};var l=i.includesShadersStore[h];if(s[2])for(var c=s[3].split(","),u=0;u<c.length;u+=2){var d=new RegExp(c[u],"g"),p=c[u+1];l=l.replace(d,p)}if(s[4]){var _=s[5];if(-1!==_.indexOf("..")){var f=_.split(".."),g=parseInt(f[0]),m=parseInt(f[1]),y=l.slice(0);l="",isNaN(m)&&(m=i.indexParameters[f[1]]);for(var v=g;v<m;v++)l+=(y=i.supportsUniformBuffers?y:y.replace(/light\{X\}.(\w*)/g,(function(e,t){return t+"{X}"}))).replace(/\{X\}/g,v.toString())+"\n"}else l=(l=i.supportsUniformBuffers?l:l.replace(/light\{X\}.(\w*)/g,(function(e,t){return t+"{X}"}))).replace(/\{X\}/g,_)}o=o.replace(s[0],l),a=a||0<=l.indexOf("#include<")||0<=l.indexOf("#include <"),s=nt.exec(t)}();if("object"==typeof h)return h.value}a?this._ProcessIncludes(o.toString(),i,r):r(o)},e._FileToolsLoadFile=function(e,t,i,r,n,s){throw De("FileTools")},e}(),ot=function(){function e(){}return e.GetShadersRepository=function(t){return(t=void 0===t?Le.GLSL:t)===Le.GLSL?e.ShadersRepository:e.ShadersRepositoryWGSL},e.GetShadersStore=function(t){return(t=void 0===t?Le.GLSL:t)===Le.GLSL?e.ShadersStore:e.ShadersStoreWGSL},e.GetIncludesShadersStore=function(t){return(t=void 0===t?Le.GLSL:t)===Le.GLSL?e.IncludesShadersStore:e.IncludesShadersStoreWGSL},e.ShadersRepository="src/Shaders/",e.ShadersStore={},e.IncludesShadersStore={},e.ShadersRepositoryWGSL="src/ShadersWGSL/",e.ShadersStoreWGSL={},e.IncludesShadersStoreWGSL={},e}(),at=function(){function e(t,i,r,n,s,o,a,h,l,c,u,d){void 0===n&&(n=null),void 0===o&&(o=null),void 0===a&&(a=null),void 0===h&&(h=null),void 0===l&&(l=null),void 0===u&&(u=""),void 0===d&&(d=Le.GLSL);var p=this,_=(u=(this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new Ce,this.onErrorObservable=new Ce,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=t,void(this._key=u)),null);if(i.attributes){var f=i;if(this._engine=r,this._attributesNames=f.attributes,this._uniformsNames=f.uniformsNames.concat(f.samplers),this._samplerList=f.samplers.slice(),this.defines=f.defines,this.onError=f.onError,this.onCompiled=f.onCompiled,this._fallbacks=f.fallbacks,this._indexParameters=f.indexParameters,this._transformFeedbackVaryings=f.transformFeedbackVaryings||null,this._multiTarget=!!f.multiTarget,this._shaderLanguage=null!=(y=f.shaderLanguage)?y:Le.GLSL,f.uniformBuffersNames){this._uniformBuffersNamesList=f.uniformBuffersNames.slice();for(var g=0;g<f.uniformBuffersNames.length;g++)this._uniformBuffersNames[f.uniformBuffersNames[g]]=g}_=null!=(y=f.processFinalCode)?y:null,u=null!=(y=f.processCodeAfterIncludes)?y:void 0}else this._engine=s,this.defines=null==o?"":o,this._uniformsNames=r.concat(n),this._samplerList=n?n.slice():[],this._attributesNames=i,this._uniformBuffersNamesList=[],this._shaderLanguage=d,this.onError=l,this.onCompiled=h,this._indexParameters=c,this._fallbacks=a;function m(){var e,i;x[0]&&x[1]&&(w.isFragment=!0,e=x[0],i=x[1],st.Process(i,w,(function(i){_&&(i=_("fragment",i)),i=st.Finalize(e,i,w),p._useFinalCode(i.vertexCode,i.fragmentCode,t)}),p._engine))}this._attributeLocationByName={},this.uniqueId=e._UniqueIdSeed++;var y=Ee()?this._engine.getHostDocument():null,v=t.vertexSource?"source:"+t.vertexSource:t.vertexElement?(v=y?y.getElementById(t.vertexElement):null)||t.vertexElement:t.vertex||t,b=t.fragmentSource?"source:"+t.fragmentSource:t.fragmentElement?(b=y?y.getElementById(t.fragmentElement):null)||t.fragmentElement:t.fragment||t,w=(this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage),{defines:this.defines.split("\n"),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:ot.GetShadersRepository(this._shaderLanguage),includesShadersStore:ot.GetIncludesShadersStore(this._shaderLanguage),version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:u}),x=[void 0,void 0];this._loadShader(v,"Vertex","",(function(e){st.Initialize(w),st.Process(e,w,(function(t){p._rawVertexSourceCode=e,_&&(t=_("vertex",t)),x[0]=t,m()}),p._engine)})),this._loadShader(b,"Fragment","Pixel",(function(e){p._rawFragmentSourceCode=e,x[1]=e,m()}))}return Object.defineProperty(e,"ShadersRepository",{get:function(){return ot.ShadersRepository},set:function(e){ot.ShadersRepository=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBindObservable",{get:function(){return this._onBindObservable||(this._onBindObservable=new Ce),this._onBindObservable},enumerable:!1,configurable:!0}),e.prototype._useFinalCode=function(e,t,i){var r;i?(r=i.vertexElement||i.vertex||i.spectorName||i,i=i.fragmentElement||i.fragment||i.spectorName||i,this._vertexSourceCode=(this._shaderLanguage===Le.WGSL?"//":"")+"#define SHADER_NAME vertex:"+r+"\n"+e,this._fragmentSourceCode=(this._shaderLanguage===Le.WGSL?"//":"")+"#define SHADER_NAME fragment:"+i+"\n"+t):(this._vertexSourceCode=e,this._fragmentSourceCode=t),this._prepareEffect()},Object.defineProperty(e.prototype,"key",{get:function(){return this._key},enumerable:!1,configurable:!0}),e.prototype.isReady=function(){try{return this._isReadyInternal()}catch(e){return!1}},e.prototype._isReadyInternal=function(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady},e.prototype.getEngine=function(){return this._engine},e.prototype.getPipelineContext=function(){return this._pipelineContext},e.prototype.getAttributesNames=function(){return this._attributesNames},e.prototype.getAttributeLocation=function(e){return this._attributes[e]},e.prototype.getAttributeLocationByName=function(e){return this._attributeLocationByName[e]},e.prototype.getAttributesCount=function(){return this._attributes.length},e.prototype.getUniformIndex=function(e){return this._uniformsNames.indexOf(e)},e.prototype.getUniform=function(e){return this._uniforms[e]},e.prototype.getSamplers=function(){return this._samplerList},e.prototype.getUniformNames=function(){return this._uniformsNames},e.prototype.getUniformBuffersNames=function(){return this._uniformBuffersNamesList},e.prototype.getIndexParameters=function(){return this._indexParameters},e.prototype.getCompilationError=function(){return this._compilationError},e.prototype.allFallbacksProcessed=function(){return this._allFallbacksProcessed},e.prototype.executeWhenCompiled=function(e){var t=this;this.isReady()?e(this):(this.onCompileObservable.add((function(t){e(t)})),this._pipelineContext&&!this._pipelineContext.isAsync||setTimeout((function(){t._checkIsReady(null)}),16))},e.prototype._checkIsReady=function(e){var t=this;try{if(this._isReadyInternal())return}catch(t){return void this._processCompilationErrors(t,e)}this._isDisposed||setTimeout((function(){t._checkIsReady(e)}),16)},e.prototype._loadShader=function(e,t,i,r){var n;"undefined"!=typeof HTMLElement&&e instanceof HTMLElement?r(Re(e)):"source:"===e.substr(0,7)?r(e.substr(7)):"base64:"===e.substr(0,7)?r(window.atob(e.substr(7))):(n=ot.GetShadersStore(this._shaderLanguage))[e+t+"Shader"]?r(n[e+t+"Shader"]):i&&n[e+i+"Shader"]?r(n[e+i+"Shader"]):(n="."===e[0]||"/"===e[0]||-1<e.indexOf("http")?e:ot.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(n+"."+t.toLowerCase()+".fx",r))},Object.defineProperty(e.prototype,"vertexSourceCode",{get:function(){var e;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:null!=(e=null==(e=this._pipelineContext)?void 0:e._getVertexShaderCode())?e:this._vertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fragmentSourceCode",{get:function(){var e;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:null!=(e=null==(e=this._pipelineContext)?void 0:e._getFragmentShaderCode())?e:this._fragmentSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rawVertexSourceCode",{get:function(){return this._rawVertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rawFragmentSourceCode",{get:function(){return this._rawFragmentSourceCode},enumerable:!1,configurable:!0}),e.prototype._rebuildProgram=function(e,t,i,r){var n=this;this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=function(e,t){r&&r(t)},this.onCompiled=function(){var e=n.getEngine().scenes;if(e)for(var t=0;t<e.length;t++)e[t].markAllMaterialsAsDirty(63);n._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()},e.prototype._prepareEffect=function(){var e=this,t=this._attributesNames,i=this.defines,r=this._pipelineContext;this._isReady=!1;try{var n=this._engine,s=(this._pipelineContext=n.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key,this._rebuildProgram.bind(this));this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?n._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,null,this._transformFeedbackVaryings,this._key):n._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,i,this._transformFeedbackVaryings,this._key),n._executeWhenRenderingStateIsCompiled(this._pipelineContext,(function(){if(e._attributes=[],e._pipelineContext._fillEffectInformation(e,e._uniformBuffersNames,e._uniformsNames,e._uniforms,e._samplerList,e._samplers,t,e._attributes),t)for(var i=0;i<t.length;i++){var s=t[i];e._attributeLocationByName[s]=e._attributes[i]}n.bindSamplers(e),e._compilationError="",e._isReady=!0,e.onCompiled&&e.onCompiled(e),e.onCompileObservable.notifyObservers(e),e.onCompileObservable.clear(),e._fallbacks&&e._fallbacks.unBindMesh(),r&&e.getEngine()._deletePipelineContext(r)})),this._pipelineContext.isAsync&&this._checkIsReady(r)}catch(i){this._processCompilationErrors(i,r)}},e.prototype._getShaderCodeAndErrorLine=function(e,t,i){var r,n=null;return t&&e&&(t=t.match(i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/))&&2===t.length&&(t=parseInt(t[1]),(r=e.split("\n",-1)).length>=t&&(n="Offending line [".concat(t,"] in ").concat(i?"fragment":"vertex"," code: ").concat(r[t-1]))),[e,n]},e.prototype._processCompilationErrors=function(t,i){void 0===i&&(i=null),this._compilationError=t.message;t=this._attributesNames;var r,n,s,o=this._fallbacks;Me.Error("Unable to compile effect:"),Me.Error("Uniforms: "+this._uniformsNames.map((function(e){return" "+e}))),Me.Error("Attributes: "+t.map((function(e){return" "+e}))),Me.Error("Defines:\r\n"+this.defines),e.LogShaderCodeOnCompilationError&&((s=n=t=null)!=(r=this._pipelineContext)&&r._getVertexShaderCode()&&(s=(r=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1))[0],t=r[1],s&&(Me.Error("Vertex code:"),Me.Error(s))),null!=(r=this._pipelineContext)&&r._getFragmentShaderCode()&&(s=(r=this._getShaderCodeAndErrorLine(null==(r=this._pipelineContext)?void 0:r._getFragmentShaderCode(),this._compilationError,!0))[0],n=r[1],s&&(Me.Error("Fragment code:"),Me.Error(s))),t&&Me.Error(t),n&&Me.Error(n)),Me.Error("Error: "+this._compilationError),i&&(this._pipelineContext=i,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)),o?(this._pipelineContext=null,o.hasMoreFallbacks?(this._allFallbacksProcessed=!1,Me.Error("Trying next fallback."),this.defines=o.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):this._allFallbacksProcessed=!0},Object.defineProperty(e.prototype,"isSupported",{get:function(){return""===this._compilationError},enumerable:!1,configurable:!0}),e.prototype._bindTexture=function(e,t){this._engine._bindTexture(this._samplers[e],t,e)},e.prototype.setTexture=function(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)},e.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)},e.prototype.setTextureArray=function(e,t){var i=e+"Ex";if(-1===this._samplerList.indexOf(i+"0")){for(var r=this._samplerList.indexOf(e),n=1;n<t.length;n++){var s=i+(n-1).toString();this._samplerList.splice(r+n,0,s)}for(var o=0,a=0,h=this._samplerList;a<h.length;a++){var l=h[a];this._samplers[l]=o,o+=1}}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)},e.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)},e.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)},e.prototype.bindUniformBuffer=function(t,i){var r=this._uniformBuffersNames[i];void 0===r||e._BaseCache[r]===t&&this._engine._features.useUBOBindingCache||(e._BaseCache[r]=t,this._engine.bindUniformBufferBase(t,r,i))},e.prototype.bindUniformBlock=function(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)},e.prototype.setInt=function(e,t){return this._pipelineContext.setInt(e,t),this},e.prototype.setInt2=function(e,t,i){return this._pipelineContext.setInt2(e,t,i),this},e.prototype.setInt3=function(e,t,i,r){return this._pipelineContext.setInt3(e,t,i,r),this},e.prototype.setInt4=function(e,t,i,r,n){return this._pipelineContext.setInt4(e,t,i,r,n),this},e.prototype.setIntArray=function(e,t){return this._pipelineContext.setIntArray(e,t),this},e.prototype.setIntArray2=function(e,t){return this._pipelineContext.setIntArray2(e,t),this},e.prototype.setIntArray3=function(e,t){return this._pipelineContext.setIntArray3(e,t),this},e.prototype.setIntArray4=function(e,t){return this._pipelineContext.setIntArray4(e,t),this},e.prototype.setFloatArray=function(e,t){return this._pipelineContext.setArray(e,t),this},e.prototype.setFloatArray2=function(e,t){return this._pipelineContext.setArray2(e,t),this},e.prototype.setFloatArray3=function(e,t){return this._pipelineContext.setArray3(e,t),this},e.prototype.setFloatArray4=function(e,t){return this._pipelineContext.setArray4(e,t),this},e.prototype.setArray=function(e,t){return this._pipelineContext.setArray(e,t),this},e.prototype.setArray2=function(e,t){return this._pipelineContext.setArray2(e,t),this},e.prototype.setArray3=function(e,t){return this._pipelineContext.setArray3(e,t),this},e.prototype.setArray4=function(e,t){return this._pipelineContext.setArray4(e,t),this},e.prototype.setMatrices=function(e,t){return this._pipelineContext.setMatrices(e,t),this},e.prototype.setMatrix=function(e,t){return this._pipelineContext.setMatrix(e,t),this},e.prototype.setMatrix3x3=function(e,t){return this._pipelineContext.setMatrix3x3(e,t),this},e.prototype.setMatrix2x2=function(e,t){return this._pipelineContext.setMatrix2x2(e,t),this},e.prototype.setFloat=function(e,t){return this._pipelineContext.setFloat(e,t),this},e.prototype.setBool=function(e,t){return this._pipelineContext.setInt(e,t?1:0),this},e.prototype.setVector2=function(e,t){return this._pipelineContext.setVector2(e,t),this},e.prototype.setFloat2=function(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this},e.prototype.setVector3=function(e,t){return this._pipelineContext.setVector3(e,t),this},e.prototype.setFloat3=function(e,t,i,r){return this._pipelineContext.setFloat3(e,t,i,r),this},e.prototype.setVector4=function(e,t){return this._pipelineContext.setVector4(e,t),this},e.prototype.setQuaternion=function(e,t){return this._pipelineContext.setQuaternion(e,t),this},e.prototype.setFloat4=function(e,t,i,r,n){return this._pipelineContext.setFloat4(e,t,i,r,n),this},e.prototype.setColor3=function(e,t){return this._pipelineContext.setColor3(e,t),this},e.prototype.setColor4=function(e,t,i){return this._pipelineContext.setColor4(e,t,i),this},e.prototype.setDirectColor4=function(e,t){return this._pipelineContext.setDirectColor4(e,t),this},e.prototype.dispose=function(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0},e.RegisterShader=function(e,t,i,r){void 0===r&&(r=Le.GLSL),t&&(ot.GetShadersStore(r)["".concat(e,"PixelShader")]=t),i&&(ot.GetShadersStore(r)["".concat(e,"VertexShader")]=i)},e.ResetCache=function(){e._BaseCache={}},e.LogShaderCodeOnCompilationError=!0,e._UniqueIdSeed=0,e._BaseCache={},e.ShadersStore=ot.ShadersStore,e.IncludesShadersStore=ot.IncludesShadersStore,e}(),ht=function(){function e(e){void 0===e&&(e=!0),this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"zOffset",{get:function(){return this._zOffset},set:function(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"zOffsetUnits",{get:function(){return this._zOffsetUnits},set:function(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cullFace",{get:function(){return this._cullFace},set:function(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cull",{get:function(){return this._cull},set:function(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthMask",{get:function(){return this._depthMask},set:function(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthTest",{get:function(){return this._depthTest},set:function(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frontFace",{get:function(){return this._frontFace},set:function(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)},enumerable:!1,configurable:!0}),e.prototype.reset=function(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1},e.prototype.apply=function(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))},e}(),lt=function(){function e(){this.reset()}return e.prototype.reset=function(){this.enabled=!1,this.mask=255,this.func=e.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=e.KEEP,this.opDepthFail=e.KEEP,this.opStencilDepthPass=e.REPLACE},Object.defineProperty(e.prototype,"stencilFunc",{get:function(){return this.func},set:function(e){this.func=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilFuncRef",{get:function(){return this.funcRef},set:function(e){this.funcRef=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilFuncMask",{get:function(){return this.funcMask},set:function(e){this.funcMask=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpStencilFail",{get:function(){return this.opStencilFail},set:function(e){this.opStencilFail=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpDepthFail",{get:function(){return this.opDepthFail},set:function(e){this.opDepthFail=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpStencilDepthPass",{get:function(){return this.opStencilDepthPass},set:function(e){this.opStencilDepthPass=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilMask",{get:function(){return this.mask},set:function(e){this.mask=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilTest",{get:function(){return this.enabled},set:function(e){this.enabled=e},enumerable:!1,configurable:!0}),e.ALWAYS=519,e.KEEP=7680,e.REPLACE=7681,e}(),ct=function(){function e(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"alphaBlend",{get:function(){return this._alphaBlend},set:function(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)},enumerable:!1,configurable:!0}),e.prototype.setAlphaBlendConstants=function(e,t,i,r){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===r||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=r,this._isBlendConstantsDirty=!0)},e.prototype.setAlphaBlendFunctionParameters=function(e,t,i,r){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===r||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=r,this._isBlendFunctionParametersDirty=!0)},e.prototype.setAlphaEquationParameters=function(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)},e.prototype.reset=function(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1},e.prototype.apply=function(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))},e}(),ut=function(){function e(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}return Object.defineProperty(e.prototype,"wrapU",{get:function(){return this._cachedWrapU},set:function(e){this._cachedWrapU=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wrapV",{get:function(){return this._cachedWrapV},set:function(e){this._cachedWrapV=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wrapR",{get:function(){return this._cachedWrapR},set:function(e){this._cachedWrapR=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"anisotropicFilteringLevel",{get:function(){return this._cachedAnisotropicFilteringLevel},set:function(e){this._cachedAnisotropicFilteringLevel=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"comparisonFunction",{get:function(){return this._comparisonFunction},set:function(e){this._comparisonFunction=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"useMipMaps",{get:function(){return this._useMipMaps},set:function(e){this._useMipMaps=e},enumerable:!1,configurable:!0}),e.prototype.setParameters=function(e,t,i,r,n,s){return void 0===t&&(t=1),void 0===i&&(i=1),void 0===r&&(r=1),void 0===n&&(n=2),void 0===s&&(s=0),this._cachedWrapU=e=void 0===e?1:e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=r,this.samplingMode=n,this._comparisonFunction=s,this},e.prototype.compareSampler=function(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps},e}(),dt=(function(e){e[e.Unknown=0]="Unknown",e[e.Url=1]="Url",e[e.Temp=2]="Temp",e[e.Raw=3]="Raw",e[e.Dynamic=4]="Dynamic",e[e.RenderTarget=5]="RenderTarget",e[e.MultiRenderTarget=6]="MultiRenderTarget",e[e.Cube=7]="Cube",e[e.CubeRaw=8]="CubeRaw",e[e.CubePrefiltered=9]="CubePrefiltered",e[e.Raw3D=10]="Raw3D",e[e.Raw2DArray=11]="Raw2DArray",e[e.DepthStencil=12]="DepthStencil",e[e.CubeRawRGBD=13]="CubeRawRGBD",e[e.Depth=14]="Depth"}(Be=Be||{}),function(e){function t(i,r,n){void 0===n&&(n=!1);var s=e.call(this)||this;return s.isReady=!1,s.isCube=!1,s.is3D=!1,s.is2DArray=!1,s.isMultiview=!1,s.url="",s.generateMipMaps=!1,s.samples=0,s.type=-1,s.format=-1,s.onLoadedObservable=new Ce,s.onErrorObservable=new Ce,s.onRebuildCallback=null,s.width=0,s.height=0,s.depth=0,s.baseWidth=0,s.baseHeight=0,s.baseDepth=0,s.invertY=!1,s._invertVScale=!1,s._associatedChannel=-1,s._source=Be.Unknown,s._buffer=null,s._bufferView=null,s._bufferViewArray=null,s._bufferViewArrayArray=null,s._size=0,s._extension="",s._files=null,s._workingCanvas=null,s._workingContext=null,s._cachedCoordinatesMode=null,s._isDisabled=!1,s._compression=null,s._sphericalPolynomial=null,s._sphericalPolynomialPromise=null,s._sphericalPolynomialComputed=!1,s._lodGenerationScale=0,s._lodGenerationOffset=0,s._useSRGBBuffer=!1,s._lodTextureHigh=null,s._lodTextureMid=null,s._lodTextureLow=null,s._isRGBD=!1,s._linearSpecularLOD=!1,s._irradianceTexture=null,s._hardwareTexture=null,s._maxLodLevel=null,s._references=1,s._gammaSpace=null,s._engine=i,s._source=r,s._uniqueId=t._Counter++,n||(s._hardwareTexture=i._createHardwareTexture()),s}return c(t,e),Object.defineProperty(t.prototype,"useMipMaps",{get:function(){return this.generateMipMaps},set:function(e){this.generateMipMaps=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),t.prototype.getEngine=function(){return this._engine},Object.defineProperty(t.prototype,"source",{get:function(){return this._source},enumerable:!1,configurable:!0}),t.prototype.incrementReferences=function(){this._references++},t.prototype.updateSize=function(e,t,i){this._engine.updateTextureDimensions(this,e,t,i=void 0===i?1:i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i},t.prototype._rebuild=function(){var e,t,i,r,n=this;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback)return i=function(e){e._swapAndDie(n,!1),n.isReady=t.isReady},void((t=this.onRebuildCallback(this)).isAsync?t.proxy.then(i):i(t.proxy));switch(this.source){case Be.Temp:break;case Be.Url:return void(r=this._engine.createTexture(null!=(e=this._originalUrl)?e:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,(function(){r._swapAndDie(n,!1),n.isReady=!0}),null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer));case Be.Raw:(r=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer))._swapAndDie(this,!1),this.isReady=!0;break;case Be.Raw3D:(r=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type))._swapAndDie(this,!1),this.isReady=!0;break;case Be.Raw2DArray:(r=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type))._swapAndDie(this,!1),this.isReady=!0;break;case Be.Dynamic:(r=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode))._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case Be.Cube:return void(r=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,(function(){r._swapAndDie(n,!1),n.isReady=!0}),null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer));case Be.CubeRaw:(r=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression))._swapAndDie(this,!1),this.isReady=!0;break;case Be.CubeRawRGBD:return;case Be.CubePrefiltered:return void((r=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,(function(e){e&&e._swapAndDie(n,!1),n.isReady=!0}),null,this.format,this._extension))._sphericalPolynomial=this._sphericalPolynomial)}},t.prototype._swapAndDie=function(e,t){void 0===t&&(t=!0),null!=(i=this._hardwareTexture)&&i.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);var i=this._engine.getLoadedTexturesCache();-1!==(t=i.indexOf(this))&&i.splice(t,1),-1===(t=i.indexOf(e))&&i.push(e)},t.prototype.dispose=function(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),0===this._references&&(this._engine._releaseTexture(this),this._hardwareTexture=null)},t._Counter=0,t}(ut)),pt=function(){function e(){this.shaderLanguage=Le.GLSL}return e.prototype.postProcessor=function(e,t,i,r,n){return n.getCaps().drawBuffersExtension||(e=e.replace(/#extension.+GL_EXT_draw_buffers.+(enable|require)/g,"")),e},e}(),_t=function(){function e(){this.shaderLanguage=Le.GLSL}return e.prototype.attributeProcessor=function(e){return e.replace("attribute","in")},e.prototype.varyingProcessor=function(e,t){return e.replace("varying",t?"in":"out")},e.prototype.postProcessor=function(e,t,i){var r=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i)e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(r?"":"out vec4 glFragColor;\n")+"void main(");else if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e},e}(),ft=function(){function e(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=e._Counter++}return Object.defineProperty(e.prototype,"underlyingResource",{get:function(){return null},enumerable:!1,configurable:!0}),e._Counter=0,e}(),gt=function(e){function t(t){var i=e.call(this)||this;return i._buffer=t,i}return c(t,e),Object.defineProperty(t.prototype,"underlyingResource",{get:function(){return this._buffer},enumerable:!1,configurable:!0}),t}(ft),mt=function(){function e(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null}return Object.defineProperty(e.prototype,"isAsync",{get:function(){return this.isParallelCompiled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isReady",{get:function(){return!!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))},enumerable:!1,configurable:!0}),e.prototype._handlesSpectorRebuildCallback=function(e){e&&this.program&&e(this.program)},e.prototype._fillEffectInformation=function(e,t,i,r,n,s,o,a){var h,l=this.engine;if(l.supportsUniformBuffers)for(var c in t)e.bindUniformBlock(c,t[c]);for(this.engine.getUniforms(this,i).forEach((function(e,t){r[i[t]]=e})),this._uniforms=r,h=0;h<n.length;h++)null==e.getUniform(n[h])&&(n.splice(h,1),h--);n.forEach((function(e,t){s[e]=t}));for(var u=0,d=l.getAttributes(this,o);u<d.length;u++){var p=d[u];a.push(p)}},e.prototype.dispose=function(){this._uniforms={}},e.prototype._cacheMatrix=function(e,t){var i=this._valueCache[e];t=t.updateFlag;return(void 0===i||i!==t)&&(this._valueCache[e]=t,!0)},e.prototype._cacheFloat2=function(e,t,i){var r=this._valueCache[e];return r&&2===r.length?(e=!1,r[0]!==t&&(r[0]=t,e=!0),r[1]!==i&&(r[1]=i,e=!0),e):(this._valueCache[e]=r=[t,i],!0)},e.prototype._cacheFloat3=function(e,t,i,r){var n=this._valueCache[e];return n&&3===n.length?(e=!1,n[0]!==t&&(n[0]=t,e=!0),n[1]!==i&&(n[1]=i,e=!0),n[2]!==r&&(n[2]=r,e=!0),e):(this._valueCache[e]=n=[t,i,r],!0)},e.prototype._cacheFloat4=function(e,t,i,r,n){var s=this._valueCache[e];return s&&4===s.length?(e=!1,s[0]!==t&&(s[0]=t,e=!0),s[1]!==i&&(s[1]=i,e=!0),s[2]!==r&&(s[2]=r,e=!0),s[3]!==n&&(s[3]=n,e=!0),e):(this._valueCache[e]=s=[t,i,r,n],!0)},e.prototype.setInt=function(e,t){var i=this._valueCache[e];void 0!==i&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)},e.prototype.setInt2=function(e,t,i){!this._cacheFloat2(e,t,i)||this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null)},e.prototype.setInt3=function(e,t,i,r){!this._cacheFloat3(e,t,i,r)||this.engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null)},e.prototype.setInt4=function(e,t,i,r,n){!this._cacheFloat4(e,t,i,r,n)||this.engine.setInt4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null)},e.prototype.setIntArray=function(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)},e.prototype.setIntArray2=function(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)},e.prototype.setIntArray3=function(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)},e.prototype.setIntArray4=function(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)},e.prototype.setArray=function(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)},e.prototype.setArray2=function(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)},e.prototype.setArray3=function(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)},e.prototype.setArray4=function(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)},e.prototype.setMatrices=function(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))},e.prototype.setMatrix=function(e,t){!this._cacheMatrix(e,t)||this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null)},e.prototype.setMatrix3x3=function(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)},e.prototype.setMatrix2x2=function(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)},e.prototype.setFloat=function(e,t){var i=this._valueCache[e];void 0!==i&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)},e.prototype.setVector2=function(e,t){!this._cacheFloat2(e,t.x,t.y)||this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null)},e.prototype.setFloat2=function(e,t,i){!this._cacheFloat2(e,t,i)||this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null)},e.prototype.setVector3=function(e,t){!this._cacheFloat3(e,t.x,t.y,t.z)||this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null)},e.prototype.setFloat3=function(e,t,i,r){!this._cacheFloat3(e,t,i,r)||this.engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null)},e.prototype.setVector4=function(e,t){!this._cacheFloat4(e,t.x,t.y,t.z,t.w)||this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null)},e.prototype.setQuaternion=function(e,t){!this._cacheFloat4(e,t.x,t.y,t.z,t.w)||this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null)},e.prototype.setFloat4=function(e,t,i,r,n){!this._cacheFloat4(e,t,i,r,n)||this.engine.setFloat4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null)},e.prototype.setColor3=function(e,t){!this._cacheFloat3(e,t.r,t.g,t.b)||this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null)},e.prototype.setColor4=function(e,t,i){!this._cacheFloat4(e,t.r,t.g,t.b,i)||this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null)},e.prototype.setDirectColor4=function(e,t){!this._cacheFloat4(e,t.r,t.g,t.b,t.a)||this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null)},e.prototype._getVertexShaderCode=function(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null},e.prototype._getFragmentShaderCode=function(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null},e}(),yt=function(){function e(){}return e.SetMatrixPrecision=function(t){if(e.MatrixTrackPrecisionChange=!1,t&&!e.MatrixUse64Bits&&e.MatrixTrackedMatrices)for(var i=0;i<e.MatrixTrackedMatrices.length;++i){var r=e.MatrixTrackedMatrices[i],n=r._m;r._m=new Array(16);for(var s=0;s<16;++s)r._m[s]=n[s]}e.MatrixCurrentType=(e.MatrixUse64Bits=t)?Array:Float32Array,e.MatrixTrackedMatrices=null},e.MatrixUse64Bits=!1,e.MatrixTrackPrecisionChange=!0,e.MatrixCurrentType=Float32Array,e.MatrixTrackedMatrices=[],e}(),vt=function(){function e(e,t){if(void 0===e&&(e=null),this._MSAARenderBuffer=null,this._context=t,!e&&!(e=t.createTexture()))throw new Error("Unable to create webGL texture");this.set(e)}return Object.defineProperty(e.prototype,"underlyingResource",{get:function(){return this._webGLTexture},enumerable:!1,configurable:!0}),e.prototype.setUsage=function(){},e.prototype.set=function(e){this._webGLTexture=e},e.prototype.reset=function(){this._webGLTexture=null,this._MSAARenderBuffer=null},e.prototype.release=function(){this._MSAARenderBuffer&&(this._context.deleteRenderbuffer(this._MSAARenderBuffer),this._MSAARenderBuffer=null),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()},e}(),bt=function(){function e(e,t){void 0===t&&(t=!0),this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}return e.IsWrapper=function(e){return void 0===e.getPipelineContext},e.GetEffect=function(e){return void 0===e.getPipelineContext?e.effect:e},e.prototype.setEffect=function(e,t,i){void 0===i&&(i=!0),this.effect=e,void 0!==t&&(this.defines=t),i&&null!=(e=this.drawContext)&&e.reset()},e.prototype.dispose=function(){var e;null!=(e=this.drawContext)&&e.dispose()},e}(),wt=function(){function e(e){void 0===e&&(e=!0),this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"func",{get:function(){return this._func},set:function(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"funcRef",{get:function(){return this._funcRef},set:function(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"funcMask",{get:function(){return this._funcMask},set:function(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"opStencilFail",{get:function(){return this._opStencilFail},set:function(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"opDepthFail",{get:function(){return this._opDepthFail},set:function(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"opStencilDepthPass",{get:function(){return this._opStencilDepthPass},set:function(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mask",{get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)},enumerable:!1,configurable:!0}),e.prototype.reset=function(){var e;this.stencilMaterial=void 0,null!=(e=this.stencilGlobal)&&e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0},e.prototype.apply=function(e){var t;e&&(t=!this.useStencilGlobalOnly&&!(null==(t=this.stencilMaterial)||!t.enabled),this.enabled=(t?this.stencilMaterial:this.stencilGlobal).enabled,this.func=(t?this.stencilMaterial:this.stencilGlobal).func,this.funcRef=(t?this.stencilMaterial:this.stencilGlobal).funcRef,this.funcMask=(t?this.stencilMaterial:this.stencilGlobal).funcMask,this.opStencilFail=(t?this.stencilMaterial:this.stencilGlobal).opStencilFail,this.opDepthFail=(t?this.stencilMaterial:this.stencilGlobal).opDepthFail,this.opStencilDepthPass=(t?this.stencilMaterial:this.stencilGlobal).opStencilDepthPass,this.mask=(t?this.stencilMaterial:this.stencilGlobal).mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1)))},e}(),xt=function(){},Tt=function(){function e(t,i,r,n){var s=this,o=(this._name="WebGL",this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new Ce,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new Ce,this.onContextRestoredObservable=new Ce,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new ht,this._stencilStateComposer=new wt,this._stencilState=new lt,this._alphaState=new ct,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this._adaptToDeviceRatio=!1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new Ce,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},null);if(this._creationOptions=r=r||{},this._adaptToDeviceRatio=null!=n&&n,this._stencilStateComposer.stencilGlobal=this._stencilState,yt.SetMatrixPrecision(!!r.useHighPrecisionMatrix),t){if(n=n||r.adaptToDeviceRatio||!1,t.getContext){if(this._renderingCanvas=o=t,void 0!==i&&(r.antialias=i),void 0===r.deterministicLockstep&&(r.deterministicLockstep=!1),void 0===r.lockstepMaxSteps&&(r.lockstepMaxSteps=4),void 0===r.timeStep&&(r.timeStep=1/60),void 0===r.preserveDrawingBuffer&&(r.preserveDrawingBuffer=!1),void 0===r.audioEngine&&(r.audioEngine=!0),void 0!==r.audioEngineOptions&&void 0!==r.audioEngineOptions.audioContext&&(this._audioContext=r.audioEngineOptions.audioContext),void 0!==r.audioEngineOptions&&void 0!==r.audioEngineOptions.audioDestination&&(this._audioDestination=r.audioEngineOptions.audioDestination),void 0===r.stencil&&(r.stencil=!0),!1===r.premultipliedAlpha&&(this.premultipliedAlpha=!1),void 0===r.xrCompatible&&(r.xrCompatible=!0),this._doNotHandleContextLost=!!r.doNotHandleContextLost,navigator&&navigator.userAgent){this._checkForMobile=function(){var e=navigator.userAgent;s.hostInformation.isMobile=-1!==e.indexOf("Mobile")||-1!==e.indexOf("Mac")&&Pe()&&"ontouchend"in document},this._checkForMobile(),Ee()&&window.addEventListener("resize",this._checkForMobile);for(var a=navigator.userAgent,h=0,l=e.ExceptionList;h<l.length;h++){var c=l[h],u=c.key,d=c.targets;if(new RegExp(u).test(a)){if(c.capture&&c.captureConstraint&&(u=c.capture,c=c.captureConstraint,(u=new RegExp(u).exec(a))&&0<u.length&&c<=parseInt(u[u.length-1])))continue;for(var p=0,_=d;p<_.length;p++)switch(_[p]){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":r.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost||(this._onContextLost=function(e){e.preventDefault(),s._contextWasLost=!0,Me.Warn("WebGL context lost."),s.onContextLostObservable.notifyObservers(s)},this._onContextRestored=function(){s._restoreEngineAfterContextLost(s._initGLContext.bind(s))},o.addEventListener("webglcontextlost",this._onContextLost,!1),o.addEventListener("webglcontextrestored",this._onContextRestored,!1),r.powerPreference="high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(r.xrCompatible=!1),!r.disableWebGL2Support)try{this._gl=o.getContext("webgl2",r)||o.getContext("experimental-webgl2",r),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(t){}if(!this._gl){if(!o)throw new Error("The provided canvas is null or undefined.");try{this._gl=o.getContext("webgl",r)||o.getContext("experimental-webgl",r)}catch(t){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else this._gl=t,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1",(i=this._gl.getContextAttributes())&&(r.stencil=i.stencil);this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==r.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=r.useHighPrecisionFloats),o=Ee()&&window.devicePixelRatio||1,t=r.limitDeviceRatio||o,this._hardwareScalingLevel=n?1/Math.min(t,o):1,this.resize(),this._isStencilEnable=!!r.stencil,this._initGLContext(),this._initFeatures();for(var f=0;f<this._caps.maxVertexAttribs;f++)this._currentBufferPointers[f]=new xt;this._shaderProcessor=new(1<this.webGLVersion?_t:pt),this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),i="Babylon.js v".concat(e.Version),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",i)}}return Object.defineProperty(e,"NpmPackage",{get:function(){return"babylonjs@5.11.0"},enumerable:!1,configurable:!0}),Object.defineProperty(e,"Version",{get:function(){return"5.11.0"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){var e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},set:function(e){this._name=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"version",{get:function(){return this._webGLVersion},enumerable:!1,configurable:!0}),Object.defineProperty(e,"ShadersRepository",{get:function(){return at.ShadersRepository},set:function(e){at.ShadersRepository=e},enumerable:!1,configurable:!0}),e.prototype._getShaderProcessor=function(e){return this._shaderProcessor},Object.defineProperty(e.prototype,"useReverseDepthBuffer",{get:function(){return this._useReverseDepthBuffer},set:function(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,this._depthCullingState.depthFunc=e?518:515)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frameId",{get:function(){return this._frameId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"supportsUniformBuffers",{get:function(){return 1<this.webGLVersion&&!this.disableUniformBuffers},enumerable:!1,configurable:!0}),e.prototype.getCreationOptions=function(){return this._creationOptions},Object.defineProperty(e.prototype,"_shouldUseHighPrecisionShader",{get:function(){return!(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"needPOTTextures",{get:function(){return this._webGLVersion<2||this.forcePOTTextures},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"activeRenderLoops",{get:function(){return this._activeRenderLoops},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"doNotHandleContextLost",{get:function(){return this._doNotHandleContextLost},set:function(e){this._doNotHandleContextLost=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_supportsHardwareTextureRescaling",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"framebufferDimensionsObject",{set:function(e){this._framebufferDimensionsObject=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentViewport",{get:function(){return this._cachedViewport},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyTexture",{get:function(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyTexture3D",{get:function(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyTexture2DArray",{get:function(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"emptyCubeTexture",{get:function(){var e;return this._emptyCubeTexture||(e=new Uint8Array(4),this._emptyCubeTexture=this.createRawCubeTexture([e,e,e,e,e,e],1,5,0,!1,!1,1)),this._emptyCubeTexture},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isWebGPU",{get:function(){return this._isWebGPU},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shaderPlatformName",{get:function(){return this._shaderPlatformName},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"snapshotRendering",{get:function(){return!1},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"snapshotRenderingMode",{get:function(){return this._snapshotRenderingMode},set:function(e){this._snapshotRenderingMode=e},enumerable:!1,configurable:!0}),e.prototype.snapshotRenderingReset=function(){this.snapshotRendering=!1},e._CreateCanvas=function(e,t){if("undefined"==typeof document)return new OffscreenCanvas(e,t);var i=document.createElement("canvas");return i.width=e,i.height=t,i},e.prototype.createCanvas=function(t,i){return e._CreateCanvas(t,i)},e.prototype.createCanvasImage=function(){return document.createElement("img")},e.prototype._restoreEngineAfterContextLost=function(e){var t=this;setTimeout((function(){return v(t,void 0,void 0,(function(){var t,i,r,n,s;return b(this,(function(o){switch(o.label){case 0:return this._dummyFramebuffer=null,t=this._depthCullingState.depthTest,i=this._depthCullingState.depthFunc,r=this._depthCullingState.depthMask,n=this._stencilState.stencilTest,[4,e()];case 1:return o.sent(),this._rebuildEffects(),null!=(s=this._rebuildComputeEffects)&&s.call(this),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this._rebuildBuffers(),this.wipeCaches(!0),this._depthCullingState.depthTest=t,this._depthCullingState.depthFunc=i,this._depthCullingState.depthMask=r,this._stencilState.stencilTest=n,Me.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1,[2]}}))}))}),0)},e.prototype._sharedInit=function(e,t,i){this._renderingCanvas=e},e.prototype._getShaderProcessingContext=function(e){return null},e.prototype._rebuildInternalTextures=function(){for(var e=0,t=this._internalTexturesCache.slice();e<t.length;e++)t[e]._rebuild()},e.prototype._rebuildRenderTargetWrappers=function(){for(var e=0,t=this._renderTargetWrapperCache.slice();e<t.length;e++)t[e]._rebuild()},e.prototype._rebuildEffects=function(){for(var e in this._compiledEffects)(e=this._compiledEffects[e])._pipelineContext=null,e._wasPreviouslyReady=!1,e._prepareEffect();at.ResetCache()},e.prototype.areAllEffectsReady=function(){for(var e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0},e.prototype._rebuildBuffers=function(){for(var e=0,t=this._uniformBuffers;e<t.length;e++)t[e]._rebuild();for(var i=0,r=this._storageBuffers;i<r.length;i++)r[i]._rebuild()},e.prototype._initGLContext=function(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:1<this._webGLVersion?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:1<this._webGLVersion||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:1<this._webGLVersion||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:1<this._webGLVersion||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:1<this._webGLVersion,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(1<this._webGLVersion&&this._gl.getExtension("EXT_color_buffer_float")),textureFloat:!!(1<this._webGLVersion||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(1<this._webGLVersion||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(1<this._webGLVersion||this._gl.getExtension("EXT_shader_texture_lod")),blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:1<this._webGLVersion,canUseGLVertexID:1<this._webGLVersion,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:1<this._webGLVersion,textureMaxLevel:1<this._webGLVersion,texture2DArrayMaxLayerCount:1<this._webGLVersion?256:128},this._glVersion=this._gl.getParameter(this._gl.VERSION);var e,t=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=t&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=0<this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(1<this._webGLVersion||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),1<this._webGLVersion&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),1<this._webGLVersion)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{var i=this._gl.getExtension("WEBGL_draw_buffers");if(null!==i){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=i.drawBuffersWEBGL.bind(i),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(var r=0;r<16;r++)this._gl["COLOR_ATTACHMENT"+r+"_WEBGL"]=i["COLOR_ATTACHMENT"+r+"_WEBGL"]}}1<this._webGLVersion?this._caps.depthTextureExtension=!0:null!=(t=this._gl.getExtension("WEBGL_depth_texture"))&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=t.UNSIGNED_INT_24_8_WEBGL),this.disableVertexArrayObjects?this._caps.vertexArrayObject=!1:1<this._webGLVersion?this._caps.vertexArrayObject=!0:null!=(t=this._gl.getExtension("OES_vertex_array_object"))&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=t.createVertexArrayOES.bind(t),this._gl.bindVertexArray=t.bindVertexArrayOES.bind(t),this._gl.deleteVertexArray=t.deleteVertexArrayOES.bind(t)),1<this._webGLVersion?this._caps.instancedArrays=!0:null!=(t=this._gl.getExtension("ANGLE_instanced_arrays"))?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=t.drawArraysInstancedANGLE.bind(t),this._gl.drawElementsInstanced=t.drawElementsInstancedANGLE.bind(t),this._gl.vertexAttribDivisor=t.vertexAttribDivisorANGLE.bind(t)):this._caps.instancedArrays=!1,this._gl.getShaderPrecisionFormat&&(t=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),e=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT),t&&e&&(this._caps.highPrecisionShaderSupported=0!==t.precision&&0!==e.precision)),1<this._webGLVersion?this._caps.blendMinMax=!0:null!=(t=this._gl.getExtension("EXT_blend_minmax"))&&(this._caps.blendMinMax=!0,this._gl.MAX=t.MAX_EXT,this._gl.MIN=t.MIN_EXT),this._caps.supportSRGBBuffers||(1<this._webGLVersion?this._caps.supportSRGBBuffers=!0:null!=(e=this._gl.getExtension("EXT_sRGB"))&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=e.SRGB_EXT,this._gl.SRGB8=e.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=e.SRGB_ALPHA_EXT),this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!(!this._creationOptions||!this._creationOptions.forceSRGBBufferSupportState)),this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(var n=0;n<this._maxSimultaneousTextures;n++)this._nextFreeTextureSlots.push(n)},e.prototype._initFeatures=function(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,_collectUbosUpdatedInFrame:!1}},Object.defineProperty(e.prototype,"webGLVersion",{get:function(){return this._webGLVersion},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"ThinEngine"},Object.defineProperty(e.prototype,"isStencilEnable",{get:function(){return this._isStencilEnable},enumerable:!1,configurable:!0}),e.prototype._prepareWorkingCanvas=function(){var e;this._workingCanvas||(this._workingCanvas=this.createCanvas(1,1),(e=this._workingCanvas.getContext("2d"))&&(this._workingContext=e))},e.prototype.resetTextureCache=function(){for(var e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1},e.prototype.getInfo=function(){return this.getGlInfo()},e.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}},e.prototype.setHardwareScalingLevel=function(e){this._hardwareScalingLevel=e,this.resize()},e.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},e.prototype.getLoadedTexturesCache=function(){return this._internalTexturesCache},e.prototype.getCaps=function(){return this._caps},e.prototype.stopRenderLoop=function(e){e?0<=(e=this._activeRenderLoops.indexOf(e))&&this._activeRenderLoops.splice(e,1):this._activeRenderLoops=[]},e.prototype._renderLoop=function(){if(!this._contextWasLost){var e=!0;if(e=!(!this.renderEvenInBackground&&this._windowIsBackground)&&e){this.beginFrame();for(var t=0;t<this._activeRenderLoops.length;t++)(0,this._activeRenderLoops[t])();this.endFrame()}}0<this._activeRenderLoops.length?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1},e.prototype.getRenderingCanvas=function(){return this._renderingCanvas},e.prototype.getAudioContext=function(){return this._audioContext},e.prototype.getAudioDestination=function(){return this._audioDestination},e.prototype.getHostWindow=function(){return Ee()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null},e.prototype.getRenderWidth=function(e){return!(e=void 0!==e&&e)&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth},e.prototype.getRenderHeight=function(e){return!(e=void 0!==e&&e)&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight},e.prototype._queueNewFrame=function(t,i){return e.QueueNewFrame(t,i)},e.prototype.runRenderLoop=function(e){-1===this._activeRenderLoops.indexOf(e)&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))},e.prototype.clear=function(e,t,i,r){void 0===r&&(r=!1);var n=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=n,n=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),n|=this._gl.COLOR_BUFFER_BIT),i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),r&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)},e.prototype._viewport=function(e,t,i,r){e===this._viewportCached.x&&t===this._viewportCached.y&&i===this._viewportCached.z&&r===this._viewportCached.w||(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r,this._gl.viewport(e,t,i,r))},e.prototype.setViewport=function(e,t,i){t=t||this.getRenderWidth(),i=i||this.getRenderHeight();var r=e.x||0,n=e.y||0;this._cachedViewport=e,this._viewport(r*t,n*i,t*e.width,i*e.height)},e.prototype.beginFrame=function(){},e.prototype.endFrame=function(){this._badOS&&this.flushFramebuffer(),this._frameId++},e.prototype.resize=function(e){var t,i,r;void 0===e&&(e=!1),this._adaptToDeviceRatio&&(i=Ee()&&window.devicePixelRatio||1,r=this._creationOptions.limitDeviceRatio||i,this._hardwareScalingLevel=this._adaptToDeviceRatio?1/Math.min(r,i):1),r=Ee()?(t=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(t=this._renderingCanvas?this._renderingCanvas.width:100,this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(t/this._hardwareScalingLevel,r/this._hardwareScalingLevel,e)},e.prototype.setSize=function(e,t,i){return!(!this._renderingCanvas||(e|=0,t|=0,!(i=void 0!==i&&i)&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t||(this._renderingCanvas.width=e,this._renderingCanvas.height=t,0)))},e.prototype.bindFramebuffer=function(e,t,i,r,n,s,o){void 0===t&&(t=0),void 0===s&&(s=0),void 0===o&&(o=0);var a,h,l=e,c=(l=(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(l._MSAAFramebuffer||l._framebuffer),this._gl),e.is2DArray?l.framebufferTextureLayer(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,null==(c=e.texture._hardwareTexture)?void 0:c.underlyingResource,s,o):e.isCube&&l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_CUBE_MAP_POSITIVE_X+t,null==(c=e.texture._hardwareTexture)?void 0:c.underlyingResource,s),e._depthStencilTexture);c&&(h=e._depthStencilTextureWithStencil?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT,e.is2DArray?l.framebufferTextureLayer(l.FRAMEBUFFER,h,null==(a=c._hardwareTexture)?void 0:a.underlyingResource,s,o):e.isCube?l.framebufferTexture2D(l.FRAMEBUFFER,h,l.TEXTURE_CUBE_MAP_POSITIVE_X+t,null==(a=c._hardwareTexture)?void 0:a.underlyingResource,s):l.framebufferTexture2D(l.FRAMEBUFFER,h,l.TEXTURE_2D,null==(o=c._hardwareTexture)?void 0:o.underlyingResource,s)),this._cachedViewport&&!n?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,s&&(i/=Math.pow(2,s))),r||(r=e.height,s&&(r/=Math.pow(2,s))),this._viewport(0,0,i,r)),this.wipeCaches()},e.prototype.setState=function(e,t,i,r,n,s,o){void 0===t&&(t=0),void 0===r&&(r=!1),void 0===o&&(o=0),this._depthCullingState.cull===e&&!i||(this._depthCullingState.cull=e),n=null==(e=null!=(e=this.cullBackFaces)?e:n)||e?this._gl.BACK:this._gl.FRONT,this._depthCullingState.cullFace===n&&!i||(this._depthCullingState.cullFace=n),this.setZOffset(t),this.setZOffsetUnits(o),e=r?this._gl.CW:this._gl.CCW,this._depthCullingState.frontFace===e&&!i||(this._depthCullingState.frontFace=e),this._stencilStateComposer.stencilMaterial=s},e.prototype.setZOffset=function(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e},e.prototype.getZOffset=function(){var e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e},e.prototype.setZOffsetUnits=function(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e},e.prototype.getZOffsetUnits=function(){var e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e},e.prototype._bindUnboundFramebuffer=function(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)},e.prototype._currentFrameBufferIsDefaultFrameBuffer=function(){return null===this._currentFramebuffer},e.prototype.generateMipmaps=function(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)},e.prototype.unBindFramebuffer=function(e,t,i){void 0===t&&(t=!1);var r=e,n=(this._currentRenderTarget=null,this._gl);if(r._MSAAFramebuffer){if(e.isMulti)return void this.unBindMultiColorAttachmentFramebuffer(e,t,i);n.bindFramebuffer(n.READ_FRAMEBUFFER,r._MSAAFramebuffer),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,r._framebuffer),n.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,n.COLOR_BUFFER_BIT,n.NEAREST)}null==(n=e.texture)||!n.generateMipMaps||t||e.isCube||this.generateMipmaps(e.texture),i&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),i()),this._bindUnboundFramebuffer(null)},e.prototype.flushFramebuffer=function(){this._gl.flush()},e.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()},e.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null},e.prototype.createVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)},e.prototype._createVertexBuffer=function(e,t){var i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");return i=new gt(i),this.bindArrayBuffer(i),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),i.references=1,i},e.prototype.createDynamicVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)},e.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null},e.prototype.createIndexBuffer=function(e,t){var i=this._gl.createBuffer(),r=new gt(i);if(!i)throw new Error("Unable to create index buffer");return this.bindIndexBuffer(r),i=this._normalizeIndexData(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=4===i.BYTES_PER_ELEMENT,r},e.prototype._normalizeIndexData=function(e){if(2===e.BYTES_PER_ELEMENT)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(var t=0;t<e.length;t++)if(65535<=e[t])return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)},e.prototype.bindArrayBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)},e.prototype.bindUniformBlock=function(e,t,i){e=e.program,t=this._gl.getUniformBlockIndex(e,t),this._gl.uniformBlockBinding(e,t,i)},e.prototype.bindIndexBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)},e.prototype._bindBuffer=function(e,t){!this._vaoRecordInProgress&&this._currentBoundBuffer[t]===e||(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)},e.prototype.updateArrayBuffer=function(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)},e.prototype._vertexAttribPointer=function(e,t,i,r,n,s,o){var a,h=this._currentBufferPointers[t];h&&(a=!1,h.active?(h.buffer!==e&&(h.buffer=e,a=!0),h.size!==i&&(h.size=i,a=!0),h.type!==r&&(h.type=r,a=!0),h.normalized!==n&&(h.normalized=n,a=!0),h.stride!==s&&(h.stride=s,a=!0),h.offset!==o&&(h.offset=o,a=!0)):(h.active=a=!0,h.index=t,h.size=i,h.type=r,h.normalized=n,h.stride=s,h.offset=o,h.buffer=e),(a||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),this._gl.vertexAttribPointer(t,i,r,n,s,o)))},e.prototype._bindIndexBufferWithCache=function(e){null!=e&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)},e.prototype._bindVertexBuffersAttributes=function(e,t,i){var r=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var n=0;n<r.length;n++){var s,o,a=t.getAttributeLocation(n);0<=a&&(s=r[n],o=null,(o=(o=i?i[s]:o)||e[s])&&(this._gl.enableVertexAttribArray(a),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[a]=!0),(s=o.getBuffer())&&(this._vertexAttribPointer(s,a,o.getSize(),o.type,o.normalized,o.byteStride,o.byteOffset),o.getIsInstanced()&&(this._gl.vertexAttribDivisor(a,o.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(s))))))}},e.prototype.recordVertexArrayObject=function(e,t,i,r){var n=this._gl.createVertexArray();return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(n),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,r),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),n},e.prototype.bindVertexArrayObject=function(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=t&&t.is32Bits,this._mustWipeVertexAttributes=!0)},e.prototype.bindBuffersDirectly=function(e,t,i,r,n){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==n){this._cachedVertexBuffers=e;for(var s,o=(this._cachedEffectForVertexBuffers=n).getAttributesCount(),a=(this._unbindVertexArrayObject(),this.unbindAllAttributes(),0),h=0;h<o;h++)h<i.length&&(0<=(s=n.getAttributeLocation(h))&&(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0,this._vertexAttribPointer(e,s,i[h],this._gl.FLOAT,!1,r,a)),a+=4*i[h])}this._bindIndexBufferWithCache(t)},e.prototype._unbindVertexArrayObject=function(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))},e.prototype.bindBuffers=function(e,t,i,r){this._cachedVertexBuffers===e&&this._cachedEffectForVertexBuffers===i||(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,r)),this._bindIndexBufferWithCache(t)},e.prototype.unbindInstanceAttributes=function(){for(var e,t=0,i=this._currentInstanceLocations.length;t<i;t++){var r=(e!=(r=this._currentInstanceBuffers[t])&&r.references&&this.bindArrayBuffer(e=r),this._currentInstanceLocations[t]);this._gl.vertexAttribDivisor(r,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0},e.prototype.releaseVertexArrayObject=function(e){this._gl.deleteVertexArray(e)},e.prototype._releaseBuffer=function(e){return e.references--,0===e.references&&(this._deleteBuffer(e),!0)},e.prototype._deleteBuffer=function(e){this._gl.deleteBuffer(e.underlyingResource)},e.prototype.updateAndBindInstancesBuffer=function(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),void 0!==i[0].index)this.bindInstancesBuffer(e,i,!0);else for(var r=0;r<4;r++){var n=i[r];this._vertexAttribArraysEnabled[n]||(this._gl.enableVertexAttribArray(n),this._vertexAttribArraysEnabled[n]=!0),this._vertexAttribPointer(e,n,4,this._gl.FLOAT,!1,64,16*r),this._gl.vertexAttribDivisor(n,1),this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(e)}},e.prototype.bindInstancesBuffer=function(e,t,i){void 0===i&&(i=!0),this.bindArrayBuffer(e);var r=0;if(i)for(var n=0;n<t.length;n++)r+=4*(s=t[n]).attributeSize;var s;for(n=0;n<t.length;n++)void 0===(s=t[n]).index&&(s.index=this._currentEffect.getAttributeLocationByName(s.attributeName)),s.index<0||(this._vertexAttribArraysEnabled[s.index]||(this._gl.enableVertexAttribArray(s.index),this._vertexAttribArraysEnabled[s.index]=!0),this._vertexAttribPointer(e,s.index,s.attributeSize,s.attributeType||this._gl.FLOAT,s.normalized||!1,r,s.offset),this._gl.vertexAttribDivisor(s.index,void 0===s.divisor?1:s.divisor),this._currentInstanceLocations.push(s.index),this._currentInstanceBuffers.push(e))},e.prototype.disableInstanceAttributeByName=function(e){this._currentEffect&&(e=this._currentEffect.getAttributeLocationByName(e),this.disableInstanceAttribute(e))},e.prototype.disableInstanceAttribute=function(e){for(var t,i=!1;-1!==(t=this._currentInstanceLocations.indexOf(e));)this._currentInstanceLocations.splice(t,1),this._currentInstanceBuffers.splice(t,1),i=!0,this._currentInstanceLocations.indexOf(e);i&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))},e.prototype.disableAttributeByIndex=function(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1},e.prototype.draw=function(e,t,i,r){this.drawElementsType(e?0:1,t,i,r)},e.prototype.drawPointClouds=function(e,t,i){this.drawArraysType(2,e,t,i)},e.prototype.drawUnIndexed=function(e,t,i,r){this.drawArraysType(e?0:1,t,i,r)},e.prototype.drawElementsType=function(e,t,i,r){this.applyStates(),this._reportDrawCall();e=this._drawMode(e);var n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,s=this._uintIndicesCurrentlySet?4:2;r?this._gl.drawElementsInstanced(e,i,n,t*s,r):this._gl.drawElements(e,i,n,t*s)},e.prototype.drawArraysType=function(e,t,i,r){this.applyStates(),this._reportDrawCall(),e=this._drawMode(e),r?this._gl.drawArraysInstanced(e,t,i,r):this._gl.drawArrays(e,t,i)},e.prototype._drawMode=function(e){switch(e){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}},e.prototype._reportDrawCall=function(){},e.prototype._releaseEffect=function(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],(e=e.getPipelineContext())&&this._deletePipelineContext(e))},e.prototype._deletePipelineContext=function(e){e&&e.program&&(e.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(e.program))},e.prototype._getGlobalDefines=function(e){var t;if(!e)return t="",this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+="\n"),t+="#define USE_REVERSE_DEPTHBUFFER"),t;this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER},e.prototype.createEffect=function(e,t,i,r,n,s,o,a,h,l){void 0===l&&(l=Le.GLSL);var c=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,u=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,d=this._getGlobalDefines(),p=null!=(p=null!=n?n:t.defines)?p:"";d&&(p+=d),d=c+"+"+u+"@"+p;return this._compiledEffects[d]?(c=this._compiledEffects[d],o&&c.isReady()&&o(c),c):(u=new at(e,t,i,r,this,n,s,o,a,h,d,l),this._compiledEffects[d]=u)},e._ConcatenateShader=function(e,t,i){return(i=void 0===i?"":i)+(t?t+"\n":"")+e},e.prototype._compileShader=function(t,i,r,n){return this._compileRawShader(e._ConcatenateShader(t,r,n),i)},e.prototype._compileRawShader=function(e,t){var i=this._gl,r=i.createShader("vertex"===t?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(r)return i.shaderSource(r,e),i.compileShader(r),r;var n,s=i.NO_ERROR;for(i.NO_ERROR;(n=i.getError())!==i.NO_ERROR;)s=n;throw new Error("Something went wrong while creating a gl ".concat(t," shader object. gl error=").concat(s,", gl isContextLost=").concat(i.isContextLost(),", _contextWasLost=").concat(this._contextWasLost))},e.prototype._getShaderSource=function(e){return this._gl.getShaderSource(e)},e.prototype.createRawShaderProgram=function(e,t,i,r,n){return void 0===n&&(n=null),r=r||this._gl,t=this._compileRawShader(t,"vertex"),i=this._compileRawShader(i,"fragment"),this._createShaderProgram(e,t,i,r,n)},e.prototype.createShaderProgram=function(e,t,i,r,n,s){void 0===s&&(s=null),n=n||this._gl;var o=1<this._webGLVersion?"#version 300 es\n#define WEBGL2 \n":"";t=this._compileShader(t,"vertex",r,o),i=this._compileShader(i,"fragment",r,o);return this._createShaderProgram(e,t,i,n,s)},e.prototype.inlineShaderCode=function(e){return e},e.prototype.createPipelineContext=function(e){var t=new mt;return(t.engine=this)._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t},e.prototype.createMaterialContext=function(){},e.prototype.createDrawContext=function(){},e.prototype._createShaderProgram=function(e,t,i,r,n){var s=r.createProgram();if(e.program=s)return r.attachShader(s,t),r.attachShader(s,i),r.linkProgram(s),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),s;throw new Error("Unable to create program")},e.prototype._finalizePipelineContext=function(e){var t,i=e.context,r=e.vertexShader,n=e.fragmentShader,s=e.program;if(!i.getProgramParameter(s,i.LINK_STATUS)){if(!this._gl.getShaderParameter(r,this._gl.COMPILE_STATUS)&&(t=this._gl.getShaderInfoLog(r)))throw e.vertexCompilationError=t,new Error("VERTEX SHADER "+t);if(!this._gl.getShaderParameter(n,this._gl.COMPILE_STATUS)&&(t=this._gl.getShaderInfoLog(n)))throw e.fragmentCompilationError=t,new Error("FRAGMENT SHADER "+t);if(t=i.getProgramInfoLog(s))throw e.programLinkError=t,new Error(t)}if(this.validateShaderPrograms&&(i.validateProgram(s),!i.getProgramParameter(s,i.VALIDATE_STATUS)&&(t=i.getProgramInfoLog(s))))throw e.programValidationError=t,new Error(t);i.deleteShader(r),i.deleteShader(n),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)},e.prototype._preparePipelineContext=function(e,t,i,r,n,s,o,a,h,l){e.program=r?this.createRawShaderProgram(e,t,i,void 0,h):this.createShaderProgram(e,t,i,a,void 0,h),e.program.__SPECTOR_rebuildProgram=o},e.prototype._isRenderingStateCompiled=function(e){return!!this._gl.getProgramParameter(e.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)&&(this._finalizePipelineContext(e),!0)},e.prototype._executeWhenRenderingStateIsCompiled=function(e,t){var i;e.isParallelCompiled?(i=e.onCompiled,e.onCompiled=i?function(){i(),t()}:t):t()},e.prototype.getUniforms=function(e,t){for(var i=new Array,r=e,n=0;n<t.length;n++)i.push(this._gl.getUniformLocation(r.program,t[n]));return i},e.prototype.getAttributes=function(e,t){for(var i=[],r=e,n=0;n<t.length;n++)try{i.push(this._gl.getAttribLocation(r.program,t[n]))}catch(e){i.push(-1)}return i},e.prototype.enableEffect=function(e){(e=null!==e&&bt.IsWrapper(e)?e.effect:e)&&e!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),(this._currentEffect=e).onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))},e.prototype.setInt=function(e,t){return!!e&&(this._gl.uniform1i(e,t),!0)},e.prototype.setInt2=function(e,t,i){return!!e&&(this._gl.uniform2i(e,t,i),!0)},e.prototype.setInt3=function(e,t,i,r){return!!e&&(this._gl.uniform3i(e,t,i,r),!0)},e.prototype.setInt4=function(e,t,i,r,n){return!!e&&(this._gl.uniform4i(e,t,i,r,n),!0)},e.prototype.setIntArray=function(e,t){return!!e&&(this._gl.uniform1iv(e,t),!0)},e.prototype.setIntArray2=function(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2iv(e,t),0))},e.prototype.setIntArray3=function(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3iv(e,t),0))},e.prototype.setIntArray4=function(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4iv(e,t),0))},e.prototype.setArray=function(e,t){return!(!e||t.length<1||(this._gl.uniform1fv(e,t),0))},e.prototype.setArray2=function(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2fv(e,t),0))},e.prototype.setArray3=function(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3fv(e,t),0))},e.prototype.setArray4=function(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4fv(e,t),0))},e.prototype.setMatrices=function(e,t){return!!e&&(this._gl.uniformMatrix4fv(e,!1,t),!0)},e.prototype.setMatrix3x3=function(e,t){return!!e&&(this._gl.uniformMatrix3fv(e,!1,t),!0)},e.prototype.setMatrix2x2=function(e,t){return!!e&&(this._gl.uniformMatrix2fv(e,!1,t),!0)},e.prototype.setFloat=function(e,t){return!!e&&(this._gl.uniform1f(e,t),!0)},e.prototype.setFloat2=function(e,t,i){return!!e&&(this._gl.uniform2f(e,t,i),!0)},e.prototype.setFloat3=function(e,t,i,r){return!!e&&(this._gl.uniform3f(e,t,i,r),!0)},e.prototype.setFloat4=function(e,t,i,r,n){return!!e&&(this._gl.uniform4f(e,t,i,r,n),!0)},e.prototype.applyStates=function(){var e;this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged&&(this._colorWriteChanged=!1,e=this._colorWrite,this._gl.colorMask(e,e,e,e))},e.prototype.setColorWrite=function(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)},e.prototype.getColorWrite=function(){return this._colorWrite},Object.defineProperty(e.prototype,"depthCullingState",{get:function(){return this._depthCullingState},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"alphaState",{get:function(){return this._alphaState},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilState",{get:function(){return this._stencilState},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilStateComposer",{get:function(){return this._stencilStateComposer},enumerable:!1,configurable:!0}),e.prototype.clearInternalTexturesCache=function(){this._internalTexturesCache=[]},e.prototype.wipeCaches=function(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))},e.prototype._getSamplingParameters=function(e,t){var i=this._gl,r=i.NEAREST,n=i.NEAREST;switch(e){case 11:r=i.LINEAR,n=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 3:r=i.LINEAR,n=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 8:r=i.NEAREST,n=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 4:r=i.NEAREST,n=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 5:r=i.NEAREST,n=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 6:r=i.NEAREST,n=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 7:r=i.NEAREST,n=i.LINEAR;break;case 1:r=i.NEAREST,n=i.NEAREST;break;case 9:r=i.LINEAR,n=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 10:r=i.LINEAR,n=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 2:r=i.LINEAR,n=i.LINEAR;break;case 12:r=i.LINEAR,n=i.NEAREST}return{min:n,mag:r}},e.prototype._createTexture=function(){var e=this._gl.createTexture();if(e)return e;throw new Error("Unable to create texture")},e.prototype._createHardwareTexture=function(){return new vt(this._createTexture(),this._gl)},e.prototype._createInternalTexture=function(e,t,i,r){void 0===r&&(r=Be.Unknown);var n={},s=(t=(void 0!==t&&"object"==typeof t?(n.generateMipMaps=t.generateMipMaps,n.type=void 0===t.type?0:t.type,n.samplingMode=void 0===t.samplingMode?3:t.samplingMode,n.format=void 0===t.format?5:t.format,n.useSRGBBuffer=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer):(n.generateMipMaps=t,n.type=0,n.samplingMode=3,n.format=5,n.useSRGBBuffer=!1),n.useSRGBBuffer=n.useSRGBBuffer&&this._caps.supportSRGBBuffers&&(1<this.webGLVersion||this.isWebGPU),(1!==n.type||this._caps.textureFloatLinearFiltering)&&(2!==n.type||this._caps.textureHalfFloatLinearFiltering)||(n.samplingMode=1),1!==n.type||this._caps.textureFloat||(n.type=0,Me.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE")),this._gl),(r=new dt(this,r))._useSRGBBuffer=!!n.useSRGBBuffer,e.width||e),o=e.height||e,a=(e=e.layers||0,this._getSamplingParameters(n.samplingMode,!!n.generateMipMaps)),h=0!==e?t.TEXTURE_2D_ARRAY:t.TEXTURE_2D,l=this._getRGBABufferInternalSizedFormat(n.type,n.format,n.useSRGBBuffer),c=this._getInternalFormat(n.format),u=this._getWebGLTextureType(n.type);return this._bindTextureDirectly(h,r),0!==e?(r.is2DArray=!0,t.texImage3D(h,0,l,s,o,e,0,c,u,null)):t.texImage2D(h,0,l,s,o,0,c,u,null),t.texParameteri(h,t.TEXTURE_MAG_FILTER,a.mag),t.texParameteri(h,t.TEXTURE_MIN_FILTER,a.min),t.texParameteri(h,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(h,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),n.generateMipMaps&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),r.baseWidth=s,r.baseHeight=o,r.width=s,r.height=o,r.depth=e,r.isReady=!0,r.samples=1,r.generateMipMaps=!!n.generateMipMaps,r.samplingMode=n.samplingMode,r.type=n.type,r.format=n.format,this._internalTexturesCache.push(r),r},e.prototype._getUseSRGBBuffer=function(e,t){return e&&this._caps.supportSRGBBuffers&&(1<this.webGLVersion||this.isWebGPU||t)},e.prototype._createTextureBase=function(t,i,r,n,s,o,a,h,l,c,u,d,p,_,f,g){var m=this,y=(void 0===s&&(s=3),void 0===o&&(o=null),void 0===a&&(a=null),void 0===c&&(c=null),void 0===u&&(u=null),void 0===d&&(d=null),void 0===p&&(p=null),"data:"===(t=t||"").substr(0,5)),v="blob:"===t.substr(0,5),b=y&&-1!==t.indexOf(";base64,"),w=u||new dt(this,Be.Url),x=t,T=(!this._transformTextureUrl||b||u||c||(t=this._transformTextureUrl(t)),x!==t&&(w._originalUrl=x),t.lastIndexOf(".")),C=p||(-1<T?t.substring(T).toLowerCase():""),E=null;-1<C.indexOf("?")&&(C=C.split("?")[0]);for(var S=0,P=e._TextureLoaders;S<P.length;S++){var R=P[S];if(R.canLoad(C,_)){E=R;break}}n&&n._addPendingData(w),w.url=t,w.generateMipMaps=!i,w.samplingMode=s,w.invertY=r,w._useSRGBBuffer=this._getUseSRGBBuffer(!!g,i),this._doNotHandleContextLost||(w._buffer=c);var A,M=null,O=(o&&!u&&(M=w.onLoadedObservable.add(o)),u||this._internalTexturesCache.push(w),function(e,r){n&&n._removePendingData(w),t===x?(M&&w.onLoadedObservable.remove(M),ke.UseFallbackTexture&&m._createTextureBase(ke.FallbackTexture,i,w.invertY,n,s,null,a,h,l,c,w),e=(e||"Unknown error")+(ke.UseFallbackTexture?" - Fallback texture was used":""),w.onErrorObservable.notifyObservers({message:e,exception:r}),a&&a(e,r)):(Me.Warn("Failed to load ".concat(t,", falling back to ").concat(x)),m._createTextureBase(x,i,w.invertY,n,s,o,a,h,l,c,w,d,p,_,f,g))});return E?(A=function(e){E.loadData(e,w,(function(e,t,i,r,o,a){a?O("TextureLoader failed to load data"):h(w,C,n,{width:e,height:t},w.invertY,!i,r,(function(){return o(),!1}),s)}),f)},c?c instanceof ArrayBuffer?A(new Uint8Array(c)):ArrayBuffer.isView(c)?A(c):a&&a("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(t,(function(e){return A(new Uint8Array(e))}),void 0,n?n.offlineProvider:void 0,!0,(function(e,t){O("Unable to load "+(e&&e.responseURL,t))}))):(T=function(e){v&&!m._doNotHandleContextLost&&(w._buffer=e),h(w,C,n,e,w.invertY,i,!1,l,s)},!y||b?c&&("string"==typeof c.decoding||c.close)?T(c):e._FileToolsLoadImage(t,T,O,n?n.offlineProvider:null,_,w.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):"string"==typeof c||c instanceof ArrayBuffer||ArrayBuffer.isView(c)||c instanceof Blob?e._FileToolsLoadImage(c,T,O,n?n.offlineProvider:null,_,w.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):c&&T(c)),w},e.prototype.createTexture=function(e,t,i,r,n,s,o,a,h,l,c,u,d,p,_){var f=this;return void 0===a&&(a=null),void 0===h&&(h=null),void 0===l&&(l=null),void 0===c&&(c=null),this._createTextureBase(e,t,i,r,n=void 0===n?3:n,s=void 0===s?null:s,o=void 0===o?null:o,this._prepareWebGLTexture.bind(this),(function(e,t,i,n,s,o){var a=f._gl,h=i.width===e&&i.height===t,c=l?f._getInternalFormat(l,s._useSRGBBuffer):".jpg"!==n||s._useSRGBBuffer?s._useSRGBBuffer?a.SRGB8_ALPHA8:a.RGBA:a.RGB;n=l?f._getInternalFormat(l):".jpg"!==n||s._useSRGBBuffer?a.RGBA:a.RGB;if(s._useSRGBBuffer&&1===f.webGLVersion&&(n=c),h)return a.texImage2D(a.TEXTURE_2D,0,c,n,a.UNSIGNED_BYTE,i),!1;if(h=f._caps.maxTextureSize,i.width>h||i.height>h||!f._supportsHardwareTextureRescaling)return f._prepareWorkingCanvas(),f._workingCanvas&&f._workingContext&&(f._workingCanvas.width=e,f._workingCanvas.height=t,f._workingContext.drawImage(i,0,0,i.width,i.height,0,0,e,t),a.texImage2D(a.TEXTURE_2D,0,c,n,a.UNSIGNED_BYTE,f._workingCanvas),s.width=e,s.height=t),!1;var u=new dt(f,Be.Temp);return f._bindTextureDirectly(a.TEXTURE_2D,u,!0),a.texImage2D(a.TEXTURE_2D,0,c,n,a.UNSIGNED_BYTE,i),f._rescaleTexture(u,s,r,c,(function(){f._releaseTexture(u),f._bindTextureDirectly(a.TEXTURE_2D,s,!0),o()})),!0}),a,h,l,c,u,d,_)},e._FileToolsLoadImage=function(e,t,i,r,n,s){throw De("FileTools")},e.prototype._rescaleTexture=function(e,t,i,r,n){},e.prototype.createRawTexture=function(e,t,i,r,n,s,o,a,h,l,c){throw De("Engine.RawTexture")},e.prototype.createRawCubeTexture=function(e,t,i,r,n,s,o,a){throw De("Engine.RawTexture")},e.prototype.createRawTexture3D=function(e,t,i,r,n,s,o,a,h,l){throw De("Engine.RawTexture")},e.prototype.createRawTexture2DArray=function(e,t,i,r,n,s,o,a,h,l){throw De("Engine.RawTexture")},e.prototype._unpackFlipY=function(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))},e.prototype._getUnpackAlignement=function(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)},e.prototype._getTextureTarget=function(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D},e.prototype.updateTextureSamplingMode=function(e,t,i){void 0===i&&(i=!1);var r=this._getTextureTarget(t),n=this._getSamplingParameters(e,t.generateMipMaps||i);this._setTextureParameterInteger(r,this._gl.TEXTURE_MAG_FILTER,n.mag,t),this._setTextureParameterInteger(r,this._gl.TEXTURE_MIN_FILTER,n.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(r)),this._bindTextureDirectly(r,null),t.samplingMode=e},e.prototype.updateTextureDimensions=function(e,t,i,r){},e.prototype.updateTextureWrappingMode=function(e,t,i,r){void 0===i&&(i=null),void 0===r&&(r=null);var n=this._getTextureTarget(e);null!==t&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),null!==i&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&null!==r&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r),e),e._cachedWrapR=r),this._bindTextureDirectly(n,null)},e.prototype._setupDepthStencilTexture=function(e,t,i,r,n,s){void 0===s&&(s=1);var o=t.width||t,a=t.height||t;t=t.layers||0,e.baseWidth=o,e.baseHeight=a,e.width=o,e.height=a,e.is2DArray=0<t,e.depth=t,e.isReady=!0,e.samples=s,e.generateMipMaps=!1,e.samplingMode=r?2:1,e.type=0,e._comparisonFunction=n,o=this._gl,a=this._getTextureTarget(e),t=this._getSamplingParameters(e.samplingMode,!1);o.texParameteri(a,o.TEXTURE_MAG_FILTER,t.mag),o.texParameteri(a,o.TEXTURE_MIN_FILTER,t.min),o.texParameteri(a,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(a,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),0===n?(o.texParameteri(a,o.TEXTURE_COMPARE_FUNC,515),o.texParameteri(a,o.TEXTURE_COMPARE_MODE,o.NONE)):(o.texParameteri(a,o.TEXTURE_COMPARE_FUNC,n),o.texParameteri(a,o.TEXTURE_COMPARE_MODE,o.COMPARE_REF_TO_TEXTURE))},e.prototype._uploadCompressedDataToTextureDirectly=function(e,t,i,r,n,s,o){void 0===s&&(s=0),void 0===o&&(o=0);var a=this._gl,h=a.TEXTURE_2D;if(e.isCube&&(h=a.TEXTURE_CUBE_MAP_POSITIVE_X+s),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=a.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=a.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=a.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=a.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=a.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=a.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=a.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1}this._gl.compressedTexImage2D(h,o,t,i,r,0,n)},e.prototype._uploadDataToTextureDirectly=function(e,t,i,r,n,s){void 0===i&&(i=0),void 0===r&&(r=0),void 0===s&&(s=!1);var o=this._gl,a=this._getWebGLTextureType(e.type),h=this._getInternalFormat(e.format),l=(n=void 0===n?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(n,e._useSRGBBuffer),this._unpackFlipY(e.invertY),o.TEXTURE_2D),c=(i=(e.isCube&&(l=o.TEXTURE_CUBE_MAP_POSITIVE_X+i),Math.round(Math.log(e.width)*Math.LOG2E)),Math.round(Math.log(e.height)*Math.LOG2E));i=s?e.width:Math.pow(2,Math.max(i-r,0)),s=s?e.height:Math.pow(2,Math.max(c-r,0));o.texImage2D(l,r,n,i,s,0,h,a,t)},e.prototype.updateTextureData=function(e,t,i,r,n,s,o,a,h){void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=!1);var l=this._gl,c=this._getWebGLTextureType(e.type),u=this._getInternalFormat(e.format),d=(this._unpackFlipY(e.invertY),l.TEXTURE_2D);e.isCube&&(d=l.TEXTURE_CUBE_MAP_POSITIVE_X+o),this._bindTextureDirectly(d,e,!0),l.texSubImage2D(d,a,i,r,n,s,u,c,t),h&&this._gl.generateMipmap(d),this._bindTextureDirectly(d,null)},e.prototype._uploadArrayBufferViewToTexture=function(e,t,i,r){void 0===i&&(i=0),void 0===r&&(r=0);var n=this._gl;n=e.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,i,r),this._bindTextureDirectly(n,null,!0)},e.prototype._prepareWebGLTextureContinuation=function(e,t,i,r,n){var s=this._gl;s&&(n=this._getSamplingParameters(n,!i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,n.mag),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,n.min),i||r||s.generateMipmap(s.TEXTURE_2D),this._bindTextureDirectly(s.TEXTURE_2D,null),t&&t._removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear())},e.prototype._prepareWebGLTexture=function(t,i,r,n,s,o,a,h,l){var c=this,u=(void 0===l&&(l=3),this.getCaps().maxTextureSize),d=Math.min(u,this.needPOTTextures?e.GetExponentOfTwo(n.width,u):n.width),p=(u=Math.min(u,this.needPOTTextures?e.GetExponentOfTwo(n.height,u):n.height),this._gl);p&&(t._hardwareTexture?(this._bindTextureDirectly(p.TEXTURE_2D,t,!0),this._unpackFlipY(void 0===s||!!s),t.baseWidth=n.width,t.baseHeight=n.height,t.width=d,t.height=u,t.isReady=!0,h(d,u,n,i,t,(function(){c._prepareWebGLTextureContinuation(t,r,o,a,l)}))||this._prepareWebGLTextureContinuation(t,r,o,a,l)):r&&r._removePendingData(t))},e.prototype._setupFramebufferDepthAttachments=function(e,t,i,r,n){void 0===n&&(n=1);var s=this._gl;return e&&t?this._createRenderBuffer(i,r,n,s.DEPTH_STENCIL,s.DEPTH24_STENCIL8,s.DEPTH_STENCIL_ATTACHMENT):t?(t=s.DEPTH_COMPONENT16,1<this._webGLVersion&&(t=s.DEPTH_COMPONENT32F),this._createRenderBuffer(i,r,n,t,t,s.DEPTH_ATTACHMENT)):e?this._createRenderBuffer(i,r,n,s.STENCIL_INDEX8,s.STENCIL_INDEX8,s.STENCIL_ATTACHMENT):null},e.prototype._createRenderBuffer=function(e,t,i,r,n,s,o){void 0===o&&(o=!0);var a=this._gl,h=a.createRenderbuffer();return a.bindRenderbuffer(a.RENDERBUFFER,h),1<i&&a.renderbufferStorageMultisample?a.renderbufferStorageMultisample(a.RENDERBUFFER,i,n,e,t):a.renderbufferStorage(a.RENDERBUFFER,r,e,t),a.framebufferRenderbuffer(a.FRAMEBUFFER,s,a.RENDERBUFFER,h),o&&a.bindRenderbuffer(a.RENDERBUFFER,null),h},e.prototype._releaseTexture=function(e){this._deleteTexture(null==(t=e._hardwareTexture)?void 0:t.underlyingResource),this.unbindAllTextures();var t=this._internalTexturesCache.indexOf(e);-1!==t&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()},e.prototype._releaseRenderTargetWrapper=function(e){-1!==(e=this._renderTargetWrapperCache.indexOf(e))&&this._renderTargetWrapperCache.splice(e,1)},e.prototype._deleteTexture=function(e){e&&this._gl.deleteTexture(e)},e.prototype._setProgram=function(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)},e.prototype.bindSamplers=function(e){for(var t=e.getPipelineContext(),i=(this._setProgram(t.program),e.getSamplers()),r=0;r<i.length;r++){var n=e.getUniform(i[r]);n&&(this._boundUniforms[r]=n)}this._currentEffect=null},e.prototype._activateCurrentTexture=function(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)},e.prototype._bindTextureDirectly=function(e,t,i,r){void 0===r&&(r=!1);var n=!1,s=t&&-1<t._associatedChannel;if((i=void 0!==i&&i)&&s&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||r){if(this._activateCurrentTexture(),t&&t.isMultiview)throw"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,null!=(e=null==(r=null==t?void 0:t._hardwareTexture)?void 0:r.underlyingResource)?e:null),(this._boundTexturesCache[this._activeChannel]=t)&&(t._associatedChannel=this._activeChannel)}else i&&(n=!0,this._activateCurrentTexture());return s&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),n},e.prototype._bindTexture=function(e,t,i){void 0!==e&&(t&&(t._associatedChannel=e),this._activeChannel=e,e=t?this._getTextureTarget(t):this._gl.TEXTURE_2D,this._bindTextureDirectly(e,t))},e.prototype.unbindAllTextures=function(){for(var e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),1<this.webGLVersion&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))},e.prototype.setTexture=function(e,t,i,r){void 0!==e&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))},e.prototype._bindSamplerUniformToChannel=function(e,t){(e=this._boundUniforms[e])&&e._currentState!==t&&(this._gl.uniform1i(e,t),e._currentState=t)},e.prototype._getTextureWrapMode=function(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT},e.prototype._setTexture=function(e,t,i,r,n){if(void 0===i&&(i=!1),void 0===r&&(r=!1),!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),1<this.webGLVersion&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video)this._activeChannel=e,t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;r=r?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture;var s=(!i&&r&&(r._associatedChannel=e),!0);this._boundTexturesCache[e]===r&&(i||this._bindSamplerUniformToChannel(r._associatedChannel,e),s=!1),this._activeChannel=e,e=this._getTextureTarget(r);return s&&this._bindTextureDirectly(e,r,i),r&&!r.isMultiview&&(r.isCube&&r._cachedCoordinatesMode!==t.coordinatesMode&&(r._cachedCoordinatesMode=t.coordinatesMode,s=3!==t.coordinatesMode&&5!==t.coordinatesMode?1:0,t.wrapU=s,t.wrapV=s),r._cachedWrapU!==t.wrapU&&(r._cachedWrapU=t.wrapU,this._setTextureParameterInteger(e,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),r)),r._cachedWrapV!==t.wrapV&&(r._cachedWrapV=t.wrapV,this._setTextureParameterInteger(e,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),r)),r.is3D&&r._cachedWrapR!==t.wrapR&&(r._cachedWrapR=t.wrapR,this._setTextureParameterInteger(e,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),r)),this._setAnisotropicLevel(e,r,t.anisotropicFilteringLevel)),!0},e.prototype.setTextureArray=function(e,t,i,r){if(void 0!==e&&t){this._textureUnits&&this._textureUnits.length===i.length||(this._textureUnits=new Int32Array(i.length));for(var n=0;n<i.length;n++){var s=i[n].getInternalTexture();s?(this._textureUnits[n]=e+n,s._associatedChannel=e+n):this._textureUnits[n]=-1}this._gl.uniform1iv(t,this._textureUnits);for(var o=0;o<i.length;o++)this._setTexture(this._textureUnits[o],i[o],!0)}},e.prototype._setAnisotropicLevel=function(e,t,i){var r=this._caps.textureAnisotropicFilterExtension;11!==t.samplingMode&&3!==t.samplingMode&&2!==t.samplingMode&&(i=1),r&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)},e.prototype._setTextureParameterFloat=function(e,t,i,r){this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameterf(e,t,i)},e.prototype._setTextureParameterInteger=function(e,t,i,r){r&&this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameteri(e,t,i)},e.prototype.unbindAllAttributes=function(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(var e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e)}else{e=0;for(var t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}},e.prototype.releaseEffects=function(){for(var e in this._compiledEffects)e=this._compiledEffects[e].getPipelineContext(),this._deletePipelineContext(e);this._compiledEffects={}},e.prototype.dispose=function(){var e;this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),null!=(e=this.releaseComputeEffects)&&e.call(this),this.unbindAllAttributes(),this._boundUniforms=[],Ee()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers=[],this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,at.ResetCache();for(var t=0,i=this._activeRequests;t<i.length;t++)i[t].abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},e.prototype.attachContextLostEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)},e.prototype.attachContextRestoredEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)},e.prototype.getError=function(){return this._gl.getError()},e.prototype._canRenderToFloatFramebuffer=function(){return 1<this._webGLVersion?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)},e.prototype._canRenderToHalfFloatFramebuffer=function(){return 1<this._webGLVersion?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)},e.prototype._canRenderToFramebuffer=function(e){for(var t=this._gl;t.getError()!==t.NO_ERROR;);var i,r,n=!0,s=t.createTexture(),o=(e=(t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.createFramebuffer()),t.bindFramebuffer(t.FRAMEBUFFER,e),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0),t.checkFramebufferStatus(t.FRAMEBUFFER));for((n=(n=n&&o===t.FRAMEBUFFER_COMPLETE)&&t.getError()===t.NO_ERROR)&&(t.clear(t.COLOR_BUFFER_BIT),n=n&&t.getError()===t.NO_ERROR),n&&(t.bindFramebuffer(t.FRAMEBUFFER,null),o=t.RGBA,i=t.UNSIGNED_BYTE,r=new Uint8Array(4),t.readPixels(0,0,1,1,o,i,r),n=n&&t.getError()===t.NO_ERROR),t.deleteTexture(s),t.deleteFramebuffer(e),t.bindFramebuffer(t.FRAMEBUFFER,null);!n&&t.getError()!==t.NO_ERROR;);return n},e.prototype._getWebGLTextureType=function(e){if(1===this._webGLVersion){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE},e.prototype._getInternalFormat=function(e,t){var i=(t=void 0!==t&&t)?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._gl.SRGB:this._gl.RGB;break;case 5:i=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA}if(1<this._webGLVersion)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER}return i},e.prototype._getRGBABufferInternalSizedFormat=function(e,t,i){if(void 0===i&&(i=!1),1===this._webGLVersion){if(void 0!==t)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._gl.SRGB8:this._gl.RGB8;case 5:return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8},e.prototype._getRGBAMultiSampleBufferFormat=function(e){return 1===e?this._gl.RGBA32F:2===e?this._gl.RGBA16F:this._gl.RGBA8},e.prototype._loadFile=function(t,i,r,n,s,o){var a=this;t=e._FileToolsLoadFile(t,i,r,n,s,o);return this._activeRequests.push(t),t.onCompleteObservable.add((function(e){a._activeRequests.splice(a._activeRequests.indexOf(e),1)})),t},e._FileToolsLoadFile=function(e,t,i,r,n,s){throw De("FileTools")},e.prototype.readPixels=function(e,t,i,r,n,s){void 0===s&&(s=!0);var o=(n=void 0===n||n)?this._gl.RGBA:this._gl.RGB;n=new Uint8Array(r*i*(n?4:3));return s&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,r,o,this._gl.UNSIGNED_BYTE,n),Promise.resolve(n)},Object.defineProperty(e,"IsSupportedAsync",{get:function(){return Promise.resolve(this.isSupported())},enumerable:!1,configurable:!0}),Object.defineProperty(e,"IsSupported",{get:function(){return this.isSupported()},enumerable:!1,configurable:!0}),e.isSupported=function(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{var e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=null!=t&&!!window.WebGLRenderingContext}catch(e){this._IsSupported=!1}return this._IsSupported},Object.defineProperty(e,"HasMajorPerformanceCaveat",{get:function(){if(null===this._HasMajorPerformanceCaveat)try{var e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch(e){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat},enumerable:!1,configurable:!0}),e.CeilingPOT=function(e){return e--,e=(e=(e=(e=(e|=e>>1)|e>>2)|e>>4)|e>>8)|e>>16,++e},e.FloorPOT=function(e){return(e=(e=(e=(e=(e|=e>>1)|e>>2)|e>>4)|e>>8)|e>>16)-(e>>1)},e.NearestPOT=function(t){var i=e.CeilingPOT(t),r=e.FloorPOT(t);return t-r<i-t?r:i},e.GetExponentOfTwo=function(t,i,r){var n;switch(r=void 0===r?2:r){case 1:n=e.FloorPOT(t);break;case 2:n=e.NearestPOT(t);break;default:n=e.CeilingPOT(t)}return Math.min(n,i)},e.QueueNewFrame=function(e,t){return Ee()?(t=t||window).requestPostAnimationFrame?t.requestPostAnimationFrame(e):t.requestAnimationFrame?t.requestAnimationFrame(e):t.msRequestAnimationFrame?t.msRequestAnimationFrame(e):t.webkitRequestAnimationFrame?t.webkitRequestAnimationFrame(e):t.mozRequestAnimationFrame?t.mozRequestAnimationFrame(e):t.oRequestAnimationFrame?t.oRequestAnimationFrame(e):window.setTimeout(e,16):"undefined"!=typeof requestAnimationFrame?requestAnimationFrame(e):setTimeout(e,16)},e.prototype.getHostDocument=function(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:Pe()?document:null},e.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],e._TextureLoaders=[],e.CollisionsEpsilon=.001,e._IsSupported=null,e._HasMajorPerformanceCaveat=null,e}(),Ct=function(){function e(){}return e.SetImmediate=function(e){Ee()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)},e}(),Et=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i),St=function(e){function t(i,r){return(i=e.call(this,i,Ve)||this).name="LoadFileError",Ge._setPrototypeOf(i,t.prototype),r instanceof Ne?i.request=r:i.file=r,i}return c(t,e),t}(He),Pt=function(e){function t(i,r){return(i=e.call(this,i,je)||this).request=r,i.name="RequestFileError",Ge._setPrototypeOf(i,t.prototype),i}return c(t,e),t}(He),Rt=function(e){function t(i,r){return(i=e.call(this,i,We)||this).file=r,i.name="ReadFileError",Ge._setPrototypeOf(i,t.prototype),i}return c(t,e),t}(He),At={DefaultRetryStrategy:ze.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:function(e){return e}},Mt=function(e){return e.replace(/#/gm,"%23")},Ot=function(e,t){e&&0===e.indexOf("data:")||At.CorsBehavior&&("string"==typeof At.CorsBehavior||At.CorsBehavior instanceof String?t.crossOrigin=At.CorsBehavior:(e=At.CorsBehavior(e))&&(t.crossOrigin=e))},It=function(e,t,i,r,n,s){void 0===n&&(n="");var o,a=!1,h=(e instanceof ArrayBuffer||ArrayBuffer.isView(e)?"undefined"!=typeof Blob?(o=URL.createObjectURL(new Blob([e],{type:n})),a=!0):o="data:".concat(n,";base64,")+function(e){for(var t,i,r,n,s,o,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h="",l=0,c=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);l<c.length;)r=(t=c[l++])>>2,n=(3&t)<<4|(t=l<c.length?c[l++]:Number.NaN)>>4,s=(15&t)<<2|(i=l<c.length?c[l++]:Number.NaN)>>6,o=63&i,isNaN(t)?s=o=64:isNaN(i)&&(o=64),h+=a.charAt(r)+a.charAt(n)+a.charAt(s)+a.charAt(o);return h}(e):e instanceof Blob?(o=URL.createObjectURL(e),a=!0):(o=Mt(e),o=At.PreprocessUrl(e)),ke.LastCreatedEngine),l=function(t){var r;i&&(r=o||e.toString(),i("Error while trying to load image: ".concat(0===r.indexOf("http")||r.length<=128?r:r.slice(0,128)+"..."),t))};if("undefined"==typeof Image||null!=(_=null==h?void 0:h._features.forceBitmapOverHTMLImageElement)&&_)return Dt(o,(function(r){h.createImageBitmap(new Blob([r],{type:n}),m({premultiplyAlpha:"none"},s)).then((function(e){t(e),a&&URL.revokeObjectURL(o)})).catch((function(t){i&&i("Error while trying to load image: "+e,t)}))}),void 0,r||void 0,!0,(function(e,t){l(t)})),null;function c(){u.src=o}var u=new Image,d=(Ot(o,u),function(){u.removeEventListener("load",d),u.removeEventListener("error",p),t(u),a&&u.src&&URL.revokeObjectURL(u.src)}),p=function(e){u.removeEventListener("load",d),u.removeEventListener("error",p),l(e),a&&u.src&&URL.revokeObjectURL(u.src)};if(u.addEventListener("load",d),u.addEventListener("error",p),"blob:"!==o.substr(0,5)&&"data:"!==o.substr(0,5)&&r&&r.enableTexturesOffline)r.open((function(){r&&r.loadImage(o,u)}),c);else{if(-1!==o.indexOf("file:")){var _=decodeURIComponent(o.substring(5).toLowerCase());if(Ue.FilesToLoad[_]){try{var f=void 0;try{f=URL.createObjectURL(Ue.FilesToLoad[_])}catch(r){f=URL.createObjectURL(Ue.FilesToLoad[_])}u.src=f,a=!0}catch(r){u.src=""}return u}}c()}return u},Ft=function(e,t,i,r,n){var s=new FileReader,o={onCompleteObservable:new Ce,abort:function(){return s.abort()}};return s.onloadend=function(){return o.onCompleteObservable.notifyObservers(o)},n&&(s.onerror=function(){n(new Rt("Unable to read ".concat(e.name),e))}),s.onload=function(e){t(e.target.result)},i&&(s.onprogress=i),r?s.readAsArrayBuffer(e):s.readAsText(e),o},Dt=function(e,t,i,r,n,s,o){if(e.name)return Ft(e,t,i,n,s?function(e){s(void 0,e)}:void 0);var a;if(-1!==e.indexOf("file:")&&(a=(0===(a=decodeURIComponent(e.substring(5).toLowerCase())).indexOf("./")&&(a=a.substring(2)),Ue.FilesToLoad[a])))return Ft(a,t,i,n,s?function(e){return s(void 0,new St(e.message,e.file))}:void 0);if(Nt(e)){var h={onCompleteObservable:new Ce,abort:function(){return function(){}}};try{t((n?kt:zt)(e))}catch(e){s?s(void 0,e):Me.Error(e.message||"Failed to parse the Data URL")}return Ct.SetImmediate((function(){h.onCompleteObservable.notifyObservers(h)})),h}return Lt(e,(function(e,i){t(e,i?i.responseURL:void 0)}),i,r,n,s?function(e){s(e.request,new St(e.message,e.request))}:void 0,o)},Lt=function(e,t,i,r,n,s,o){e=Mt(e),e=At.PreprocessUrl(e);var a,h=At.BaseUrl+e,l=!1,c={onCompleteObservable:new Ce,abort:function(){return l=!0}},u=function(){function e(){u&&(i&&u.removeEventListener("progress",i),a&&u.removeEventListener("readystatechange",a),u.removeEventListener("loadend",p))}function r(e){e=e.message||"Unknown error",s&&u?s(new Pt(e,u)):Me.Error(e)}var a,u=new Ne,d=null,p=function(){e(),c.onCompleteObservable.notifyObservers(c),c.onCompleteObservable.clear(),p=a=null,t=o=s=i=void 0};c.abort=function(){l=!0,p&&p(),u&&u.readyState!==(XMLHttpRequest.DONE||4)&&u.abort(),null!==d&&(clearTimeout(d),d=null),u=null},function c(_){if(u){if(u.open("GET",h),o)try{o(u)}catch(e){return void r(e)}n&&(u.responseType="arraybuffer"),i&&u.addEventListener("progress",i),p&&u.addEventListener("loadend",p),a=function(){if(!l&&u&&u.readyState===(XMLHttpRequest.DONE||4))if(a&&u.removeEventListener("readystatechange",a),200<=u.status&&u.status<300||0===u.status&&(!Ee()||Bt()))try{t&&t(n?u.response:u.responseText,u)}catch(i){r(i)}else{var i=At.DefaultRetryStrategy;if(i&&-1!==(i=i(h,u,_)))return e(),u=new Ne,void(d=setTimeout((function(){return c(_+1)}),i));i=new Pt("Error status: "+u.status+" "+u.statusText+" - Unable to load "+h,u),s&&s(i)}},u.addEventListener("readystatechange",a),u.send()}}(0)};return r&&r.enableSceneOffline?r.open((function(){r&&r.loadFile(At.BaseUrl+e,(function(e){!l&&t&&t(e),c.onCompleteObservable.notifyObservers(c)}),i?function(e){!l&&i&&i(e)}:void 0,a,n)}),a=function(e){e&&400<e.status?s&&s(e):u()}):u(),c},Bt=function(){return"undefined"!=typeof location&&"file:"===location.protocol},Nt=function(e){return Et.test(e)};function kt(e){return function(e){for(var t=Ke(e),i=t.length,r=new Uint8Array(new ArrayBuffer(i)),n=0;n<i;n++)r[n]=t.charCodeAt(n);return r.buffer}(e.split(",")[1])}var Ut,zt=function(e){return Ke(e.split(",")[1])},Gt=(Tt._FileToolsLoadImage=It,Tt._FileToolsLoadFile=Dt,st._FileToolsLoadFile=Dt,function(e,t,i,r,n,s,o,a,h,l){Ut={DecodeBase64UrlToBinary:e,DecodeBase64UrlToString:t,DefaultRetryStrategy:i.DefaultRetryStrategy,BaseUrl:i.BaseUrl,CorsBehavior:i.CorsBehavior,PreprocessUrl:i.PreprocessUrl,IsBase64DataUrl:r,IsFileURL:n,LoadFile:s,LoadImage:o,ReadFile:a,RequestFile:h,SetCorsBehavior:l},Object.defineProperty(Ut,"DefaultRetryStrategy",{get:function(){return i.DefaultRetryStrategy},set:function(e){i.DefaultRetryStrategy=e}}),Object.defineProperty(Ut,"BaseUrl",{get:function(){return i.BaseUrl},set:function(e){i.BaseUrl=e}}),Object.defineProperty(Ut,"PreprocessUrl",{get:function(){return i.PreprocessUrl},set:function(e){i.PreprocessUrl=e}}),Object.defineProperty(Ut,"CorsBehavior",{get:function(){return i.CorsBehavior},set:function(e){i.CorsBehavior=e}})}),Vt=(Gt(kt,zt,At,Nt,Bt,Dt,It,Ft,Lt,Ot),{});function jt(e,t){Vt[e]=t}var Wt=function(){function e(){}return e.Instantiate=function(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];var t=function(e){return Vt[e]}(e);if(t)return t;Me.Warn(e+" not found, you may have missed an import.");for(var i=e.split("."),r=window||this,n=0,s=i.length;n<s;n++)r=r[i[n]];return"function"!=typeof r?null:r},e.RegisteredExternalClasses={},e}();var Ht=function(){function e(){}return Object.defineProperty(e,"BaseUrl",{get:function(){return At.BaseUrl},set:function(e){At.BaseUrl=e},enumerable:!1,configurable:!0}),Object.defineProperty(e,"DefaultRetryStrategy",{get:function(){return At.DefaultRetryStrategy},set:function(e){At.DefaultRetryStrategy=e},enumerable:!1,configurable:!0}),Object.defineProperty(e,"CorsBehavior",{get:function(){return At.CorsBehavior},set:function(e){At.CorsBehavior=e},enumerable:!1,configurable:!0}),Object.defineProperty(e,"UseFallbackTexture",{get:function(){return ke.UseFallbackTexture},set:function(e){ke.UseFallbackTexture=e},enumerable:!1,configurable:!0}),Object.defineProperty(e,"RegisteredExternalClasses",{get:function(){return Wt.RegisteredExternalClasses},set:function(e){Wt.RegisteredExternalClasses=e},enumerable:!1,configurable:!0}),Object.defineProperty(e,"fallbackTexture",{get:function(){return ke.FallbackTexture},set:function(e){ke.FallbackTexture=e},enumerable:!1,configurable:!0}),e.FetchToRef=function(e,t,i,r,n,s){e=4*((Math.abs(e)*i%i|0)+(Math.abs(t)*r%r|0)*i),s.r=n[e]/255,s.g=n[1+e]/255,s.b=n[2+e]/255,s.a=n[3+e]/255},e.Mix=function(e,t,i){return e*(1-i)+t*i},e.Instantiate=function(e){return Wt.Instantiate(e)},e.SetImmediate=function(e){Ct.SetImmediate(e)},e.IsExponentOfTwo=function(e){for(var t=1;(t*=2)<e;);return t===e},e.FloatRound=function(t){return Math.fround?Math.fround(t):(e._TmpFloatArray[0]=t,e._TmpFloatArray[0])},e.GetFilename=function(e){var t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)},e.GetFolderPath=function(e,t){void 0===t&&(t=!1);var i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)},e.ToDegrees=function(e){return 180*e/Math.PI},e.ToRadians=function(e){return e*Math.PI/180},e.MakeArray=function(e,t){return!0===t||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:null},e.GetPointerPrefix=function(e){var t="pointer";return Ee()&&!window.PointerEvent&&(t="mouse"),!e._badDesktopOS||e._badOS||document&&"ontouchend"in document?t:"mouse"},e.SetCorsBehavior=function(e,t){Ot(e,t)},e.CleanUrl=function(e){return e.replace(/#/gm,"%23")},Object.defineProperty(e,"PreprocessUrl",{get:function(){return At.PreprocessUrl},set:function(e){At.PreprocessUrl=e},enumerable:!1,configurable:!0}),e.LoadImage=function(e,t,i,r,n,s){return It(e,t,i,r,n,s)},e.LoadFile=function(e,t,i,r,n,s){return Dt(e,t,i,r,n,s)},e.LoadFileAsync=function(e,t){return void 0===t&&(t=!0),new Promise((function(i,r){Dt(e,(function(e){i(e)}),void 0,void 0,t,(function(e,t){r(t)}))}))},e.LoadScript=function(e,t,i,r){var n,s;Ee()&&(n=document.getElementsByTagName("head")[0],(s=document.createElement("script")).setAttribute("type","text/javascript"),s.setAttribute("src",e),r&&(s.id=r),s.onload=function(){t&&t()},s.onerror=function(t){i&&i("Unable to load script '".concat(e,"'"),t)},n.appendChild(s))},e.LoadScriptAsync=function(e){var t=this;return new Promise((function(i,r){t.LoadScript(e,(function(){i()}),(function(e,t){r(t)}))}))},e.ReadFileAsDataURL=function(e,t,i){var r=new FileReader,n={onCompleteObservable:new Ce,abort:function(){return r.abort()}};return r.onloadend=function(){n.onCompleteObservable.notifyObservers(n)},r.onload=function(e){t(e.target.result)},r.onprogress=i,r.readAsDataURL(e),n},e.ReadFile=function(e,t,i,r,n){return Ft(e,t,i,r,n)},e.FileAsURL=function(e){return e=new Blob([e]),(window.URL||window.webkitURL).createObjectURL(e)},e.Format=function(e,t){return e.toFixed(t=void 0===t?2:t)},e.DeepCopy=function(e,t,i,r){Ie.DeepCopy(e,t,i,r)},e.IsEmpty=function(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0},e.RegisterTopRootEvents=function(e,t){for(var i=0;i<t.length;i++){var r=t[i];e.addEventListener(r.name,r.handler,!1);try{window.parent&&window.parent.addEventListener(r.name,r.handler,!1)}catch(e){}}},e.UnregisterTopRootEvents=function(e,t){for(var i=0;i<t.length;i++){var r=t[i];e.removeEventListener(r.name,r.handler);try{e.parent&&e.parent.removeEventListener(r.name,r.handler)}catch(e){}}},e.DumpFramebuffer=function(t,i,r,n,s,o){return void 0===s&&(s="image/png"),v(this,void 0,void 0,(function(){var a;return b(this,(function(h){switch(h.label){case 0:return[4,r.readPixels(0,0,t,i)];case 1:return a=h.sent(),a=new Uint8Array(a.buffer),e.DumpData(t,i,a,n,s,o,!0),[2]}}))}))},e.DumpData=function(t,i,r,n,s,o,a,h,l){if(void 0===s&&(s="image/png"),void 0===a&&(a=!1),void 0===h&&(h=!1),(e._ScreenshotCanvas=e._ScreenshotCanvas?e._ScreenshotCanvas:document.createElement("canvas")).width=t,e._ScreenshotCanvas.height=i,_=e._ScreenshotCanvas.getContext("2d")){if(r instanceof Float32Array){for(var c=new Uint8Array(r.length),u=r.length;u--;){var d=r[u];c[u]=d<0?0:1<d?1:Math.round(255*d)}r=c}var p=_.createImageData(t,i),_=(p.data.set(r),_.putImageData(p,0,0),e._ScreenshotCanvas);if(a){if((p=document.createElement("canvas")).width=t,p.height=i,!(a=p.getContext("2d")))return;a.translate(0,i),a.scale(1,-1),a.drawImage(e._ScreenshotCanvas,0,0),_=p}h?e.ToBlob(_,(function(e){var t=new FileReader;t.onload=function(e){e=e.target.result,n&&n(e)},t.readAsArrayBuffer(e)}),s,l):e.EncodeScreenshotCanvasData(n,s,o,_,l)}},e.DumpDataAsync=function(t,i,r,n,s,o,a,h){return void 0===n&&(n="image/png"),void 0===o&&(o=!1),void 0===a&&(a=!1),new Promise((function(l){e.DumpData(t,i,r,(function(e){return l(e)}),n,s,o,a,h)}))},e.ToBlob=function(e,t,i,r){void 0===i&&(i="image/png"),e.toBlob||(e.toBlob=function(e,t,i){var r=this;setTimeout((function(){for(var n=atob(r.toDataURL(t,i).split(",")[1]),s=n.length,o=new Uint8Array(s),a=0;a<s;a++)o[a]=n.charCodeAt(a);e(new Blob([o]))}))}),e.toBlob((function(e){t(e)}),i,r)},e.EncodeScreenshotCanvasData=function(t,i,r,n,s){void 0===i&&(i="image/png"),t?t((null!=n?n:e._ScreenshotCanvas).toDataURL(i,s)):this.ToBlob(null!=n?n:e._ScreenshotCanvas,(function(t){var i,n;"download"in document.createElement("a")?(r||(n=((n=new Date).getFullYear()+"-"+(n.getMonth()+1)).slice(2)+"-"+n.getDate()+"_"+n.getHours()+"-"+("0"+n.getMinutes()).slice(-2),r="screenshot_"+n+".png"),e.Download(t,r)):t&&(i=URL.createObjectURL(t),(n=window.open(""))&&((t=n.document.createElement("img")).onload=function(){URL.revokeObjectURL(i)},t.src=i,n.document.body.appendChild(t)))}),i,s)},e.Download=function(e,t){var i;navigator&&navigator.msSaveBlob?navigator.msSaveBlob(e,t):(e=window.URL.createObjectURL(e),i=document.createElement("a"),document.body.appendChild(i),i.style.display="none",i.href=e,i.download=t,i.addEventListener("click",(function(){i.parentElement&&i.parentElement.removeChild(i)})),i.click(),window.URL.revokeObjectURL(e))},e.BackCompatCameraNoPreventDefault=function(e){return"boolean"==typeof e[0]?e[0]:"boolean"==typeof e[1]&&e[1]},e.CreateScreenshot=function(e,t,i,r,n){throw De("ScreenshotTools")},e.CreateScreenshotAsync=function(e,t,i,r){throw De("ScreenshotTools")},e.CreateScreenshotUsingRenderTarget=function(e,t,i,r,n,s,o,a){throw De("ScreenshotTools")},e.CreateScreenshotUsingRenderTargetAsync=function(e,t,i,r,n,s,o){throw De("ScreenshotTools")},e.RandomId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))},e.IsBase64=function(e){return Nt(e)},e.DecodeBase64=function(e){return kt(e)},Object.defineProperty(e,"errorsCount",{get:function(){return Me.errorsCount},enumerable:!1,configurable:!0}),e.Log=function(e){Me.Log(e)},e.Warn=function(e){Me.Warn(e)},e.Error=function(e){Me.Error(e)},Object.defineProperty(e,"LogCache",{get:function(){return Me.LogCache},enumerable:!1,configurable:!0}),e.ClearLogCache=function(){Me.ClearLogCache()},Object.defineProperty(e,"LogLevels",{set:function(e){Me.LogLevels=e},enumerable:!1,configurable:!0}),Object.defineProperty(e,"PerformanceLogLevel",{set:function(t){return(t&e.PerformanceUserMarkLogLevel)===e.PerformanceUserMarkLogLevel?(e.StartPerformanceCounter=e._StartUserMark,void(e.EndPerformanceCounter=e._EndUserMark)):(t&e.PerformanceConsoleLogLevel)===e.PerformanceConsoleLogLevel?(e.StartPerformanceCounter=e._StartPerformanceConsole,void(e.EndPerformanceCounter=e._EndPerformanceConsole)):(e.StartPerformanceCounter=e._StartPerformanceCounterDisabled,void(e.EndPerformanceCounter=e._EndPerformanceCounterDisabled))},enumerable:!1,configurable:!0}),e._StartPerformanceCounterDisabled=function(e,t){},e._EndPerformanceCounterDisabled=function(e,t){},e._StartUserMark=function(t,i){if(void 0===i&&(i=!0),!e._Performance){if(!Ee())return;e._Performance=window.performance}i&&e._Performance.mark&&e._Performance.mark(t+"-Begin")},e._EndUserMark=function(t,i){(i=void 0===i||i)&&e._Performance.mark&&(e._Performance.mark(t+"-End"),e._Performance.measure(t,t+"-Begin",t+"-End"))},e._StartPerformanceConsole=function(t,i){(i=void 0===i||i)&&(e._StartUserMark(t,i),console.time)},e._EndPerformanceConsole=function(t,i){(i=void 0===i||i)&&e._EndUserMark(t,i)},Object.defineProperty(e,"Now",{get:function(){return Fe.Now},enumerable:!1,configurable:!0}),e.GetClassName=function(e,t){var i=null;return!(t=void 0!==t&&t)&&e.getClassName?e.getClassName():(i=e instanceof Object?(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__:i)||typeof e},e.First=function(e,t){for(var i=0,r=e;i<r.length;i++){var n=r[i];if(t(n))return n}return null},e.getFullClassName=function(e,t){var i=null,r=null;return(i=!(t=void 0!==t&&t)&&e.getClassName?e.getClassName():(e instanceof Object&&(i=(t=t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__,r=t.constructor.__bjsmoduleName__),i||typeof e))?(null!=r?r+".":"")+i:null},e.DelayAsync=function(e){return new Promise((function(t){setTimeout((function(){t()}),e)}))},e.IsSafari=function(){return!!Se()&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)},e.UseCustomRequestHeaders=!1,e.CustomRequestHeaders=Ne.CustomRequestHeaders,e._TmpFloatArray=new Float32Array(1),e.GetDOMTextContent=Re,e.GetAbsoluteUrl="object"==typeof document?function(e){var t=document.createElement("a");return t.href=e,t.href}:"function"==typeof URL&&"object"==typeof location?function(e){return new URL(e,location.origin).href}:function(){throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},e.NoneLogLevel=Me.NoneLogLevel,e.MessageLogLevel=Me.MessageLogLevel,e.WarningLogLevel=Me.WarningLogLevel,e.ErrorLogLevel=Me.ErrorLogLevel,e.AllLogLevel=Me.AllLogLevel,e.IsWindowObjectExist=Ee,e.PerformanceNoneLogLevel=0,e.PerformanceUserMarkLogLevel=1,e.PerformanceConsoleLogLevel=2,e.StartPerformanceCounter=e._StartPerformanceCounterDisabled,e.EndPerformanceCounter=e._EndPerformanceCounterDisabled,e}(),Kt=(ke.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z",function(){function e(t){this.length=0,this.data=new Array(t),this._id=e._GlobalId++}return e.prototype.push=function(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)},e.prototype.forEach=function(e){for(var t=0;t<this.length;t++)e(this.data[t])},e.prototype.sort=function(e){this.data.sort(e)},e.prototype.reset=function(){this.length=0},e.prototype.dispose=function(){this.reset(),this.data&&(this.data.length=0,this.data=[])},e.prototype.concat=function(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(var t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}},e.prototype.indexOf=function(e){return(e=this.data.indexOf(e))>=this.length?-1:e},e.prototype.contains=function(e){return-1!==this.indexOf(e)},e._GlobalId=0,e}()),Xt=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._duplicateId=0,t}return c(t,e),t.prototype.push=function(t){e.prototype.push.call(this,t),t.__smartArrayFlags||(t.__smartArrayFlags={}),t.__smartArrayFlags[this._id]=this._duplicateId},t.prototype.pushNoDuplicate=function(e){return!(e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId||(this.push(e),0))},t.prototype.reset=function(){e.prototype.reset.call(this),this._duplicateId++},t.prototype.concatWithNoDuplicate=function(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(var t=0;t<e.length;t++){var i=(e.data||e)[t];this.pushNoDuplicate(i)}}},t}(Kt),qt=function(){function e(){this._count=0,this._data={}}return e.prototype.copyFrom=function(e){var t=this;this.clear(),e.forEach((function(e,i){return t.add(e,i)}))},e.prototype.get=function(e){if(void 0!==(e=this._data[e]))return e},e.prototype.getOrAddWithFactory=function(e,t){var i=this.get(e);return void 0!==i||(i=t(e))&&this.add(e,i),i},e.prototype.getOrAdd=function(e,t){var i=this.get(e);return void 0!==i?i:(this.add(e,t),t)},e.prototype.contains=function(e){return void 0!==this._data[e]},e.prototype.add=function(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)},e.prototype.set=function(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)},e.prototype.getAndRemove=function(e){var t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null},e.prototype.remove=function(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)},e.prototype.clear=function(){this._data={},this._count=0},Object.defineProperty(e.prototype,"count",{get:function(){return this._count},enumerable:!1,configurable:!0}),e.prototype.forEach=function(e){for(var t in this._data)e(t,this._data[t])},e.prototype.first=function(e){for(var t in this._data)if(t=e(t,this._data[t]))return t;return null},e}(),Yt=function(){function e(){}return e.Eval=function(t,i){return"true"===(t=t.match(/\([^()]*\)/g)?t.replace(/\([^()]*\)/g,(function(t){return t=t.slice(1,t.length-1),e._HandleParenthesisContent(t,i)})):e._HandleParenthesisContent(t,i))||"false"!==t&&e.Eval(t,i)},e._HandleParenthesisContent=function(t,i){i=i||function(e){return"true"===e};var r,n=t.split("||");for(r in n)if(Object.prototype.hasOwnProperty.call(n,r)){var s=e._SimplifyNegation(n[r].trim()),o=s.split("&&");if(1<o.length)for(var a=0;a<o.length;++a){var h,l=e._SimplifyNegation(o[a].trim());if(!(h="true"!==l&&"false"!==l?"!"===l[0]?!i(l.substring(1)):i(l):"true"===l)){s="false";break}}if(h||"true"===s){h=!0;break}h="true"!==s&&"false"!==s?"!"===s[0]?!i(s.substring(1)):i(s):"true"===s}return h?"true":"false"},e._SimplifyNegation=function(e){return"!true"===(e=(e=e.replace(/^[\s!]+/,(function(e){return(e=e.replace(/[\s]/g,(function(){return""}))).length%2?"!":""}))).trim())?e="false":"!false"===e&&(e="true"),e},e}(),Zt=function(){function e(){}return e.EnableFor=function(t){t._tags=t._tags||{},t.hasTags=function(){return e.HasTags(t)},t.addTags=function(i){return e.AddTagsTo(t,i)},t.removeTags=function(i){return e.RemoveTagsFrom(t,i)},t.matchesTagsQuery=function(i){return e.MatchesQuery(t,i)}},e.DisableFor=function(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery},e.HasTags=function(e){if(!e._tags)return!1;var t,i=e._tags;for(t in i)if(Object.prototype.hasOwnProperty.call(i,t))return!0;return!1},e.GetTags=function(e,t){if(!e._tags)return null;if(t=void 0===t||t){var i,r=[];for(i in e._tags)Object.prototype.hasOwnProperty.call(e._tags,i)&&!0===e._tags[i]&&r.push(i);return r.join(" ")}return e._tags},e.AddTagsTo=function(t,i){i&&"string"==typeof i&&i.split(" ").forEach((function(i){e._AddTagTo(t,i)}))},e._AddTagTo=function(t,i){""===(i=i.trim())||"true"===i||"false"===i||i.match(/[\s]/)||i.match(/^([!]|([|]|[&]){2})/)||(e.EnableFor(t),t._tags[i]=!0)},e.RemoveTagsFrom=function(t,i){if(e.HasTags(t)){var r,n=i.split(" ");for(r in n)e._RemoveTagFrom(t,n[r])}},e._RemoveTagFrom=function(e,t){delete e._tags[t]},e.MatchesQuery=function(t,i){return void 0===i||(""===i?e.HasTags(t):Yt.Eval(i,(function(i){return e.HasTags(t)&&t._tags[i]})))},e}(),Qt=function(){function e(){}return e.WithinEpsilon=function(e,t,i){return void 0===i&&(i=1401298e-51),Math.abs(e-t)<=i},e.ToHex=function(e){var t=e.toString(16);return(e<=15?"0"+t:t).toUpperCase()},e.Sign=function(e){return 0==(e=+e)||isNaN(e)?e:0<e?1:-1},e.Clamp=function(e,t,i){return void 0===t&&(t=0),void 0===i&&(i=1),Math.min(i,Math.max(t,e))},e.Log2=function(e){return Math.log(e)*Math.LOG2E},e.ILog2=function(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(0===e)return-1/0;var t=0;if(e<1){for(;e<1;)t++,e*=2;t=-t}else if(1<e)for(;1<e;)t++,e=Math.floor(e/2);return t},e.Repeat=function(e,t){return e-Math.floor(e/t)*t},e.Normalize=function(e,t,i){return(e-t)/(i-t)},e.Denormalize=function(e,t,i){return e*(i-t)+t},e.DeltaAngle=function(t,i){return 180<(i=e.Repeat(i-t,360))&&(i-=360),i},e.PingPong=function(t,i){return t=e.Repeat(t,2*i),i-Math.abs(t-i)},e.SmoothStep=function(t,i,r){return i*(r=-2*(r=e.Clamp(r))*r*r+3*r*r)+t*(1-r)},e.MoveTowards=function(t,i,r){return Math.abs(i-t)<=r?i:t+e.Sign(i-t)*r},e.MoveTowardsAngle=function(t,i,r){var n=e.DeltaAngle(t,i);return-r<n&&n<r?i:e.MoveTowards(t,i=t+n,r)},e.Lerp=function(e,t,i){return e+(t-e)*i},e.LerpAngle=function(t,i,r){return 180<(i=e.Repeat(i-t,360))&&(i-=360),t+i*e.Clamp(r)},e.InverseLerp=function(t,i,r){return t!=i?e.Clamp((r-t)/(i-t)):0},e.Hermite=function(e,t,i,r,n){var s=n*n,o=n*s;return e*(2*o-3*s+1)+i*(-2*o+3*s)+t*(o-2*s+n)+r*(o-s)},e.Hermite1stDerivative=function(e,t,i,r,n){var s=n*n;return 6*(s-n)*e+(3*s-4*n+1)*t+6*(-s+n)*i+(3*s-2*n)*r},e.RandomRange=function(e,t){return e===t?e:Math.random()*(t-e)+e},e.RangeToPercent=function(e,t,i){return(e-t)/(i-t)},e.PercentToRange=function(e,t,i){return(i-t)*e+t},e.NormalizeRadians=function(t){return t-e.TwoPi*Math.floor((t+Math.PI)/e.TwoPi)},e.HCF=function(t,i){return 0==(t%=i)?i:e.HCF(i,t)},e.TwoPi=2*Math.PI,e}(),Jt=1/2.2,$t=2.2,ei=.001,ti=function(){function e(){}return e.BuildArray=function(e,t){for(var i=[],r=0;r<e;++r)i.push(t());return i},e.BuildTuple=function(t,i){return e.BuildArray(t,i)},e}(),ii=function(e){return parseInt(e.toString().replace(/\W/g,""))},ri=function(){function e(e,t){void 0===t&&(t=0),this.x=e=void 0===e?0:e,this.y=t}return e.prototype.toString=function(){return"{X: ".concat(this.x," Y: ").concat(this.y,"}")},e.prototype.getClassName=function(){return"Vector2"},e.prototype.getHashCode=function(){return 397*ii(this.x)^ii(this.y)},e.prototype.toArray=function(e,t){return e[t=void 0===t?0:t]=this.x,e[t+1]=this.y,this},e.prototype.fromArray=function(t,i){return e.FromArrayToRef(t,i=void 0===i?0:i,this),this},e.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},e.prototype.copyFrom=function(e){return this.x=e.x,this.y=e.y,this},e.prototype.copyFromFloats=function(e,t){return this.x=e,this.y=t,this},e.prototype.set=function(e,t){return this.copyFromFloats(e,t)},e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y)},e.prototype.addToRef=function(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,this},e.prototype.addInPlace=function(e){return this.x+=e.x,this.y+=e.y,this},e.prototype.addVector3=function(t){return new e(this.x+t.x,this.y+t.y)},e.prototype.subtract=function(t){return new e(this.x-t.x,this.y-t.y)},e.prototype.subtractToRef=function(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,this},e.prototype.subtractInPlace=function(e){return this.x-=e.x,this.y-=e.y,this},e.prototype.multiplyInPlace=function(e){return this.x*=e.x,this.y*=e.y,this},e.prototype.multiply=function(t){return new e(this.x*t.x,this.y*t.y)},e.prototype.multiplyToRef=function(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,this},e.prototype.multiplyByFloats=function(t,i){return new e(this.x*t,this.y*i)},e.prototype.divide=function(t){return new e(this.x/t.x,this.y/t.y)},e.prototype.divideToRef=function(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,this},e.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},e.prototype.negate=function(){return new e(-this.x,-this.y)},e.prototype.negateInPlace=function(){return this.x*=-1,this.y*=-1,this},e.prototype.negateToRef=function(e){return e.copyFromFloats(-1*this.x,-1*this.y)},e.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this},e.prototype.scale=function(t){var i=new e(0,0);return this.scaleToRef(t,i),i},e.prototype.scaleToRef=function(e,t){return t.x=this.x*e,t.y=this.y*e,this},e.prototype.scaleAndAddToRef=function(e,t){return t.x+=this.x*e,t.y+=this.y*e,this},e.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y},e.prototype.equalsWithEpsilon=function(e,t){return void 0===t&&(t=ei),e&&Qt.WithinEpsilon(this.x,e.x,t)&&Qt.WithinEpsilon(this.y,e.y,t)},e.prototype.floor=function(){return new e(Math.floor(this.x),Math.floor(this.y))},e.prototype.fract=function(){return new e(this.x-Math.floor(this.x),this.y-Math.floor(this.y))},e.prototype.rotateToRef=function(e,t){var i=Math.cos(e);e=Math.sin(e);return t.x=i*this.x-e*this.y,t.y=e*this.x+i*this.y,this},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},e.prototype.normalize=function(){return e.NormalizeToRef(this,this),this},e.prototype.clone=function(){return new e(this.x,this.y)},e.Zero=function(){return new e(0,0)},e.One=function(){return new e(1,1)},e.FromArray=function(t,i){return new e(t[i=void 0===i?0:i],t[i+1])},e.FromArrayToRef=function(e,t,i){i.x=e[t],i.y=e[t+1]},e.CatmullRom=function(t,i,r,n,s){var o=s*s,a=s*o;return new e(.5*(2*i.x+(-t.x+r.x)*s+(2*t.x-5*i.x+4*r.x-n.x)*o+(-t.x+3*i.x-3*r.x+n.x)*a),.5*(2*i.y+(-t.y+r.y)*s+(2*t.y-5*i.y+4*r.y-n.y)*o+(-t.y+3*i.y-3*r.y+n.y)*a))},e.Clamp=function(t,i,r){var n=t.x;n=(n=n>r.x?r.x:n)<i.x?i.x:n,t=t.y;return new e(n,t=(t=t>r.y?r.y:t)<i.y?i.y:t)},e.Hermite=function(t,i,r,n,s){var o=s*s,a=2*(l=s*o)-3*o+1,h=-2*l+3*o,l=(s=l-2*o+s,l-o);return new e(t.x*a+r.x*h+i.x*s+n.x*l,t.y*a+r.y*h+i.y*s+n.y*l)},e.Hermite1stDerivative=function(t,i,r,n,s){var o=e.Zero();return this.Hermite1stDerivativeToRef(t,i,r,n,s,o),o},e.Hermite1stDerivativeToRef=function(e,t,i,r,n,s){var o=n*n;s.x=6*(o-n)*e.x+(3*o-4*n+1)*t.x+6*(-o+n)*i.x+(3*o-2*n)*r.x,s.y=6*(o-n)*e.y+(3*o-4*n+1)*t.y+6*(-o+n)*i.y+(3*o-2*n)*r.y},e.Lerp=function(t,i,r){return new e(t.x+(i.x-t.x)*r,t.y+(i.y-t.y)*r)},e.Dot=function(e,t){return e.x*t.x+e.y*t.y},e.Normalize=function(t){var i=e.Zero();return this.NormalizeToRef(t,i),i},e.NormalizeToRef=function(e,t){var i=e.length();0!==i&&(t.x=e.x/i,t.y=e.y/i)},e.Minimize=function(t,i){return new e((t.x<i.x?t:i).x,(t.y<i.y?t:i).y)},e.Maximize=function(t,i){return new e((t.x>i.x?t:i).x,(t.y>i.y?t:i).y)},e.Transform=function(t,i){var r=e.Zero();return e.TransformToRef(t,i,r),r},e.TransformToRef=function(e,t,i){t=t.m;var r=e.x*t[0]+e.y*t[4]+t[12];e=e.x*t[1]+e.y*t[5]+t[13];i.x=r,i.y=e},e.PointInTriangle=function(e,t,i,r){var n=.5*(-i.y*r.x+t.y*(-i.x+r.x)+t.x*(i.y-r.y)+i.x*r.y),s=n<0?-1:1;r=(t.y*r.x-t.x*r.y+(r.y-t.y)*e.x+(t.x-r.x)*e.y)*s,i=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*s;return 0<r&&0<i&&r+i<2*n*s},e.Distance=function(t,i){return Math.sqrt(e.DistanceSquared(t,i))},e.DistanceSquared=function(e,t){var i=e.x-t.x;return i*i+(e=e.y-t.y)*e},e.Center=function(t,i){return e.CenterToRef(t,i,e.Zero())},e.CenterToRef=function(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)},e.DistanceOfPointFromSegment=function(t,i,r){var n=e.DistanceSquared(i,r);return 0===n||(r=r.subtract(i),n=Math.max(0,Math.min(1,e.Dot(t.subtract(i),r)/n)),i=i.add(r.multiplyByFloats(n,n))),e.Distance(t,i)},e}(),ni=function(){function e(e,t,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),this._isDirty=!0,this._x=e,this._y=t,this._z=i}return Object.defineProperty(e.prototype,"x",{get:function(){return this._x},set:function(e){this._x=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._y},set:function(e){this._y=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this._z},set:function(e){this._z=e,this._isDirty=!0},enumerable:!1,configurable:!0}),e.prototype.toString=function(){return"{X: ".concat(this._x," Y: ").concat(this._y," Z: ").concat(this._z,"}")},e.prototype.getClassName=function(){return"Vector3"},e.prototype.getHashCode=function(){return 397*(397*ii(this._x)^ii(this._y))^ii(this._z)},e.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},e.prototype.toArray=function(e,t){return e[t=void 0===t?0:t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this},e.prototype.fromArray=function(t,i){return e.FromArrayToRef(t,i=void 0===i?0:i,this),this},e.prototype.toQuaternion=function(){return oi.RotationYawPitchRoll(this._y,this._x,this._z)},e.prototype.addInPlace=function(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)},e.prototype.addInPlaceFromFloats=function(e,t,i){return this.x+=e,this.y+=t,this.z+=i,this},e.prototype.add=function(t){return new e(this._x+t._x,this._y+t._y,this._z+t._z)},e.prototype.addToRef=function(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)},e.prototype.subtractInPlace=function(e){return this.x-=e._x,this.y-=e._y,this.z-=e._z,this},e.prototype.subtract=function(t){return new e(this._x-t._x,this._y-t._y,this._z-t._z)},e.prototype.subtractToRef=function(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)},e.prototype.subtractFromFloats=function(t,i,r){return new e(this._x-t,this._y-i,this._z-r)},e.prototype.subtractFromFloatsToRef=function(e,t,i,r){return r.copyFromFloats(this._x-e,this._y-t,this._z-i)},e.prototype.negate=function(){return new e(-this._x,-this._y,-this._z)},e.prototype.negateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},e.prototype.negateToRef=function(e){return e.copyFromFloats(-1*this._x,-1*this._y,-1*this._z)},e.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this},e.prototype.scale=function(t){return new e(this._x*t,this._y*t,this._z*t)},e.prototype.scaleToRef=function(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)},e.prototype.applyRotationQuaternionToRef=function(e,t){var i=e.w*this.x+e.y*this.z-e.z*this.y,r=e.w*this.y+e.z*this.x-e.x*this.z,n=e.w*this.z+e.x*this.y-e.y*this.x,s=-e.x*this.x-e.y*this.y-e.z*this.z;return t.x=i*e.w+s*-e.x+r*-e.z-n*-e.y,t.y=r*e.w+s*-e.y+n*-e.x-i*-e.z,t.z=n*e.w+s*-e.z+i*-e.y-r*-e.x,t},e.prototype.applyRotationQuaternionInPlace=function(e){return this.applyRotationQuaternionToRef(e,this)},e.prototype.applyRotationQuaternion=function(t){return this.applyRotationQuaternionToRef(t,e.Zero())},e.prototype.scaleAndAddToRef=function(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)},e.prototype.projectOnPlane=function(t,i){var r=e.Zero();return this.projectOnPlaneToRef(t,i,r),r},e.prototype.projectOnPlaneToRef=function(t,i,r){var n=t.normal,s=(t=t.d,hi.Vector3[0]),o=(this.subtractToRef(i,s),s.normalize(),e.Dot(s,n));n=-(e.Dot(i,n)+t)/o,t=s.scaleInPlace(n);i.addToRef(t,r)},e.prototype.equals=function(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z},e.prototype.equalsWithEpsilon=function(e,t){return void 0===t&&(t=ei),e&&Qt.WithinEpsilon(this._x,e._x,t)&&Qt.WithinEpsilon(this._y,e._y,t)&&Qt.WithinEpsilon(this._z,e._z,t)},e.prototype.equalsToFloats=function(e,t,i){return this._x===e&&this._y===t&&this._z===i},e.prototype.multiplyInPlace=function(e){return this.x*=e._x,this.y*=e._y,this.z*=e._z,this},e.prototype.multiply=function(e){return this.multiplyByFloats(e._x,e._y,e._z)},e.prototype.multiplyToRef=function(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)},e.prototype.multiplyByFloats=function(t,i,r){return new e(this._x*t,this._y*i,this._z*r)},e.prototype.divide=function(t){return new e(this._x/t._x,this._y/t._y,this._z/t._z)},e.prototype.divideToRef=function(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)},e.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},e.prototype.minimizeInPlace=function(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)},e.prototype.maximizeInPlace=function(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)},e.prototype.minimizeInPlaceFromFloats=function(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this},e.prototype.maximizeInPlaceFromFloats=function(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this},e.prototype.isNonUniformWithinEpsilon=function(e){var t=Math.abs(this._x),i=Math.abs(this._y);if(!Qt.WithinEpsilon(t,i,e))return!0;var r=Math.abs(this._z);return!Qt.WithinEpsilon(t,r,e)||!Qt.WithinEpsilon(i,r,e)},Object.defineProperty(e.prototype,"isNonUniform",{get:function(){var e=Math.abs(this._x);return e!==Math.abs(this._y)||e!==Math.abs(this._z)},enumerable:!1,configurable:!0}),e.prototype.floor=function(){return new e(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))},e.prototype.fract=function(){return new e(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))},e.prototype.length=function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)},e.prototype.lengthSquared=function(){return this._x*this._x+this._y*this._y+this._z*this._z},Object.defineProperty(e.prototype,"hasAZeroComponent",{get:function(){return this._x*this._y*this._z==0},enumerable:!1,configurable:!0}),e.prototype.normalize=function(){return this.normalizeFromLength(this.length())},e.prototype.reorderInPlace=function(e){var t=this;return"xyz"===(e=e.toLowerCase())||(hi.Vector3[0].copyFrom(this),["x","y","z"].forEach((function(i,r){t[i]=hi.Vector3[0][e[r]]}))),this},e.prototype.rotateByQuaternionToRef=function(t,i){return t.toRotationMatrix(hi.Matrix[0]),e.TransformCoordinatesToRef(this,hi.Matrix[0],i),i},e.prototype.rotateByQuaternionAroundPointToRef=function(e,t,i){return this.subtractToRef(t,hi.Vector3[0]),hi.Vector3[0].rotateByQuaternionToRef(e,hi.Vector3[0]),t.addToRef(hi.Vector3[0],i),i},e.prototype.cross=function(t){return e.Cross(this,t)},e.prototype.normalizeFromLength=function(e){return 0===e||1===e?this:this.scaleInPlace(1/e)},e.prototype.normalizeToNew=function(){var t=new e(0,0,0);return this.normalizeToRef(t),t},e.prototype.normalizeToRef=function(e){var t=this.length();return 0===t||1===t?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)},e.prototype.clone=function(){return new e(this._x,this._y,this._z)},e.prototype.copyFrom=function(e){return this.copyFromFloats(e._x,e._y,e._z)},e.prototype.copyFromFloats=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},e.prototype.set=function(e,t,i){return this.copyFromFloats(e,t,i)},e.prototype.setAll=function(e){return this.x=this.y=this.z=e,this},e.GetClipFactor=function(t,i,r,n){return(t=e.Dot(t,r)-n)/(t-(e.Dot(i,r)-n))},e.GetAngleBetweenVectors=function(t,i,r){t=t.normalizeToRef(hi.Vector3[1]),i=i.normalizeToRef(hi.Vector3[2]);var n=e.Dot(t,i),s=(n=Qt.Clamp(n,-1,1),Math.acos(n)),o=hi.Vector3[3];return e.CrossToRef(t,i,o),0<e.Dot(o,r)?isNaN(s)?0:s:isNaN(s)?-Math.PI:-Math.acos(n)},e.GetAngleBetweenVectorsOnPlane=function(t,i,r){hi.Vector3[0].copyFrom(t);t=hi.Vector3[0],hi.Vector3[1].copyFrom(i),i=hi.Vector3[1],hi.Vector3[2].copyFrom(r),r=hi.Vector3[2];var n=hi.Vector3[3],s=hi.Vector3[4];t.normalize(),i.normalize(),r.normalize(),e.CrossToRef(r,t,n),e.CrossToRef(n,r,s),t=Math.atan2(e.Dot(i,n),e.Dot(i,s));return Qt.NormalizeRadians(t)},e.SlerpToRef=function(t,i,r,n){r=Qt.Clamp(r,0,1);var s,o,a=hi.Vector3[0],h=hi.Vector3[1],l=(t=(a.copyFrom(t),a.length()),i=(a.normalizeFromLength(t),h.copyFrom(i),h.length()),h.normalizeFromLength(i),e.Dot(a,h));l=l<.999?(l=Math.acos(l),s=1/Math.sin(l),o=Math.sin((1-r)*l)*s,Math.sin(r*l)*s):(o=1-r,r),a.scaleInPlace(o),h.scaleInPlace(l),n.copyFrom(a).addInPlace(h),n.scaleInPlace(Qt.Lerp(t,i,r))},e.SmoothToRef=function(t,i,r,n,s){e.SlerpToRef(t,i,0===n?1:r/n,s)},e.FromArray=function(t,i){return new e(t[i=void 0===i?0:i],t[i+1],t[i+2])},e.FromFloatArray=function(t,i){return e.FromArray(t,i)},e.FromArrayToRef=function(e,t,i){i.x=e[t],i.y=e[t+1],i.z=e[t+2]},e.FromFloatArrayToRef=function(t,i,r){return e.FromArrayToRef(t,i,r)},e.FromFloatsToRef=function(e,t,i,r){r.copyFromFloats(e,t,i)},e.Zero=function(){return new e(0,0,0)},e.One=function(){return new e(1,1,1)},e.Up=function(){return new e(0,1,0)},Object.defineProperty(e,"UpReadOnly",{get:function(){return e._UpReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(e,"RightReadOnly",{get:function(){return e._RightReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LeftReadOnly",{get:function(){return e._LeftReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LeftHandedForwardReadOnly",{get:function(){return e._LeftHandedForwardReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(e,"RightHandedForwardReadOnly",{get:function(){return e._RightHandedForwardReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(e,"ZeroReadOnly",{get:function(){return e._ZeroReadOnly},enumerable:!1,configurable:!0}),e.Down=function(){return new e(0,-1,0)},e.Forward=function(t){return new e(0,0,(t=void 0!==t&&t)?-1:1)},e.Backward=function(t){return new e(0,0,(t=void 0!==t&&t)?1:-1)},e.Right=function(){return new e(1,0,0)},e.Left=function(){return new e(-1,0,0)},e.TransformCoordinates=function(t,i){var r=e.Zero();return e.TransformCoordinatesToRef(t,i,r),r},e.TransformCoordinatesToRef=function(t,i,r){e.TransformCoordinatesFromFloatsToRef(t._x,t._y,t._z,i,r)},e.TransformCoordinatesFromFloatsToRef=function(e,t,i,r,n){var s=e*(r=r.m)[0]+t*r[4]+i*r[8]+r[12],o=e*r[1]+t*r[5]+i*r[9]+r[13],a=e*r[2]+t*r[6]+i*r[10]+r[14];e=1/(e*r[3]+t*r[7]+i*r[11]+r[15]);n.x=s*e,n.y=o*e,n.z=a*e},e.TransformNormal=function(t,i){var r=e.Zero();return e.TransformNormalToRef(t,i,r),r},e.TransformNormalToRef=function(e,t,i){this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i)},e.TransformNormalFromFloatsToRef=function(e,t,i,r,n){r=r.m,n.x=e*r[0]+t*r[4]+i*r[8],n.y=e*r[1]+t*r[5]+i*r[9],n.z=e*r[2]+t*r[6]+i*r[10]},e.CatmullRom=function(t,i,r,n,s){var o=s*s,a=s*o;return new e(.5*(2*i._x+(-t._x+r._x)*s+(2*t._x-5*i._x+4*r._x-n._x)*o+(-t._x+3*i._x-3*r._x+n._x)*a),.5*(2*i._y+(-t._y+r._y)*s+(2*t._y-5*i._y+4*r._y-n._y)*o+(-t._y+3*i._y-3*r._y+n._y)*a),.5*(2*i._z+(-t._z+r._z)*s+(2*t._z-5*i._z+4*r._z-n._z)*o+(-t._z+3*i._z-3*r._z+n._z)*a))},e.Clamp=function(t,i,r){var n=new e;return e.ClampToRef(t,i,r,n),n},e.ClampToRef=function(e,t,i,r){var n=e._x,s=(n=(n=n>i._x?i._x:n)<t._x?t._x:n,e._y);e=(e=(e=(s=(s=s>i._y?i._y:s)<t._y?t._y:s,e._z))>i._z?i._z:e)<t._z?t._z:e,r.copyFromFloats(n,s,e)},e.CheckExtends=function(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)},e.Hermite=function(t,i,r,n,s){var o=s*s,a=2*(l=s*o)-3*o+1,h=-2*l+3*o,l=(s=l-2*o+s,l-o);return new e(t._x*a+r._x*h+i._x*s+n._x*l,t._y*a+r._y*h+i._y*s+n._y*l,t._z*a+r._z*h+i._z*s+n._z*l)},e.Hermite1stDerivative=function(t,i,r,n,s){var o=e.Zero();return this.Hermite1stDerivativeToRef(t,i,r,n,s,o),o},e.Hermite1stDerivativeToRef=function(e,t,i,r,n,s){var o=n*n;s.x=6*(o-n)*e.x+(3*o-4*n+1)*t.x+6*(-o+n)*i.x+(3*o-2*n)*r.x,s.y=6*(o-n)*e.y+(3*o-4*n+1)*t.y+6*(-o+n)*i.y+(3*o-2*n)*r.y,s.z=6*(o-n)*e.z+(3*o-4*n+1)*t.z+6*(-o+n)*i.z+(3*o-2*n)*r.z},e.Lerp=function(t,i,r){var n=new e(0,0,0);return e.LerpToRef(t,i,r,n),n},e.LerpToRef=function(e,t,i,r){r.x=e._x+(t._x-e._x)*i,r.y=e._y+(t._y-e._y)*i,r.z=e._z+(t._z-e._z)*i},e.Dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z},e.Cross=function(t,i){var r=e.Zero();return e.CrossToRef(t,i,r),r},e.CrossToRef=function(e,t,i){var r=e._y*t._z-e._z*t._y,n=e._z*t._x-e._x*t._z;e=e._x*t._y-e._y*t._x;i.copyFromFloats(r,n,e)},e.Normalize=function(t){var i=e.Zero();return e.NormalizeToRef(t,i),i},e.NormalizeToRef=function(e,t){e.normalizeToRef(t)},e.Project=function(t,i,r,n){var s=new e;return e.ProjectToRef(t,i,r,n,s),s},e.ProjectToRef=function(t,i,r,n,s){var o=n.width,a=n.height,h=n.x,l=(n=n.y,hi.Matrix[1]);ai.FromValuesToRef(o/2,0,0,0,0,-a/2,0,0,0,0,.5,0,h+o/2,a/2+n,.5,1,l),h=hi.Matrix[0];return i.multiplyToRef(r,h),h.multiplyToRef(l,h),e.TransformCoordinatesToRef(t,h,s),s},e._UnprojectFromInvertedMatrixToRef=function(t,i,r){e.TransformCoordinatesToRef(t,i,r),i=i.m,t=t._x*i[3]+t._y*i[7]+t._z*i[11]+i[15],Qt.WithinEpsilon(t,1)&&r.scaleInPlace(1/t)},e.UnprojectFromTransform=function(e,t,i,r,n){return this.Unproject(e,t,i,r,n,ai.IdentityReadOnly)},e.Unproject=function(t,i,r,n,s,o){var a=e.Zero();return e.UnprojectToRef(t,i,r,n,s,o,a),a},e.UnprojectToRef=function(t,i,r,n,s,o,a){e.UnprojectFloatsToRef(t._x,t._y,t._z,i,r,n,s,o,a)},e.UnprojectFloatsToRef=function(t,i,r,n,s,o,a,h,l){var c=hi.Matrix[0];(o=(o.multiplyToRef(a,c),c.multiplyToRef(h,c),c.invert(),hi.Vector3[0])).x=t/n*2-1,o.y=-(i/s*2-1),null!=(a=ke.LastCreatedEngine)&&a.isNDCHalfZRange?o.z=r:o.z=2*r-1,e._UnprojectFromInvertedMatrixToRef(o,c,l)},e.Minimize=function(e,t){return(e=e.clone()).minimizeInPlace(t),e},e.Maximize=function(e,t){return(e=e.clone()).maximizeInPlace(t),e},e.Distance=function(t,i){return Math.sqrt(e.DistanceSquared(t,i))},e.DistanceSquared=function(e,t){var i=e._x-t._x,r=e._y-t._y;return i*i+r*r+(e=e._z-t._z)*e},e.ProjectOnTriangleToRef=function(t,i,r,n,s){var o=hi.Vector3[0],a=hi.Vector3[1],h=hi.Vector3[2],l=hi.Vector3[3],c=hi.Vector3[4],u=(r.subtractToRef(i,o),n.subtractToRef(i,a),n.subtractToRef(r,h),o.length()),d=a.length(),p=h.length();if(u<ei||d<ei||p<ei)return s.copyFrom(i),e.Distance(t,i);t.subtractToRef(i,c),e.CrossToRef(o,a,l);var _=l.length();if(_<ei)return s.copyFrom(i),e.Distance(t,i);if(l.normalizeFromLength(_),(_=c.length())<ei)return s.copyFrom(i),0;c.normalizeFromLength(_);c=e.Dot(l,c);var f,g=hi.Vector3[5],m=hi.Vector3[6],y=(g=(g.copyFrom(l).scaleInPlace(-_*c),m.copyFrom(t).addInPlace(g),hi.Vector3[4]),hi.Vector3[5]),v=hi.Vector3[7],b=hi.Vector3[8];(u=(g.copyFrom(o).scaleInPlace(1/u),b.copyFrom(a).scaleInPlace(1/d),g.addInPlace(b).scaleInPlace(-1),y.copyFrom(o).scaleInPlace(-1/u),b.copyFrom(h).scaleInPlace(1/p),y.addInPlace(b).scaleInPlace(-1),v.copyFrom(h).scaleInPlace(-1/p),b.copyFrom(a).scaleInPlace(-1/d),v.addInPlace(b).scaleInPlace(-1),hi.Vector3[9])).copyFrom(m).subtractInPlace(i),e.CrossToRef(g,u,b),p=e.Dot(b,l),u.copyFrom(m).subtractInPlace(r),e.CrossToRef(y,u,b),d=e.Dot(b,l),u.copyFrom(m).subtractInPlace(n),e.CrossToRef(v,u,b),g=e.Dot(b,l),y=hi.Vector3[10],v=0<p&&d<0?(y.copyFrom(o),f=i,r):0<d&&g<0?(y.copyFrom(h),f=r,n):(y.copyFrom(a).scaleInPlace(-1),f=n,i),u=hi.Vector3[9],p=hi.Vector3[4];return f.subtractToRef(m,b),v.subtractToRef(m,u),e.CrossToRef(b,u,p),e.Dot(p,l)<0?(o=hi.Vector3[5],e.CrossToRef(y,p,o),o.normalize(),(d=hi.Vector3[9]).copyFrom(f).subtractInPlace(m),(g=d.length())<ei?(s.copyFrom(f),e.Distance(t,f)):(d.normalizeFromLength(g),h=e.Dot(o,d),(r=hi.Vector3[7]).copyFrom(m).addInPlace(o.scaleInPlace(g*h)),b.copyFrom(r).subtractInPlace(f),_=y.length(),y.normalizeFromLength(_),a=e.Dot(b,y)/Math.max(_,ei),a=Qt.Clamp(a,0,1),r.copyFrom(f).addInPlace(y.scaleInPlace(a*_)),s.copyFrom(r),e.Distance(t,r))):(s.copyFrom(m),Math.abs(_*c))},e.Center=function(t,i){return e.CenterToRef(t,i,e.Zero())},e.CenterToRef=function(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)},e.RotationFromAxis=function(t,i,r){var n=e.Zero();return e.RotationFromAxisToRef(t,i,r,n),n},e.RotationFromAxisToRef=function(e,t,i,r){var n=hi.Quaternion[0];oi.RotationQuaternionFromAxisToRef(e,t,i,n),n.toEulerAnglesToRef(r)},e._UpReadOnly=e.Up(),e._LeftHandedForwardReadOnly=e.Forward(!1),e._RightHandedForwardReadOnly=e.Forward(!0),e._RightReadOnly=e.Right(),e._LeftReadOnly=e.Left(),e._ZeroReadOnly=e.Zero(),e}(),si=function(){function e(e,t,i,r){this.x=e,this.y=t,this.z=i,this.w=r}return e.prototype.toString=function(){return"{X: ".concat(this.x," Y: ").concat(this.y," Z: ").concat(this.z," W: ").concat(this.w,"}")},e.prototype.getClassName=function(){return"Vector4"},e.prototype.getHashCode=function(){return 397*(397*(397*ii(this.x)^ii(this.y))^ii(this.z))^ii(this.w)},e.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},e.prototype.toArray=function(e,t){return e[t=void 0===t?0:t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this},e.prototype.fromArray=function(t,i){return e.FromArrayToRef(t,i=void 0===i?0:i,this),this},e.prototype.addInPlace=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)},e.prototype.addToRef=function(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,this},e.prototype.subtractInPlace=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},e.prototype.subtract=function(t){return new e(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)},e.prototype.subtractToRef=function(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,this},e.prototype.subtractFromFloats=function(t,i,r,n){return new e(this.x-t,this.y-i,this.z-r,this.w-n)},e.prototype.subtractFromFloatsToRef=function(e,t,i,r,n){return n.x=this.x-e,n.y=this.y-t,n.z=this.z-i,n.w=this.w-r,this},e.prototype.negate=function(){return new e(-this.x,-this.y,-this.z,-this.w)},e.prototype.negateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this},e.prototype.negateToRef=function(e){return e.copyFromFloats(-1*this.x,-1*this.y,-1*this.z,-1*this.w)},e.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},e.prototype.scale=function(t){return new e(this.x*t,this.y*t,this.z*t,this.w*t)},e.prototype.scaleToRef=function(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,this},e.prototype.scaleAndAddToRef=function(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,this},e.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},e.prototype.equalsWithEpsilon=function(e,t){return void 0===t&&(t=ei),e&&Qt.WithinEpsilon(this.x,e.x,t)&&Qt.WithinEpsilon(this.y,e.y,t)&&Qt.WithinEpsilon(this.z,e.z,t)&&Qt.WithinEpsilon(this.w,e.w,t)},e.prototype.equalsToFloats=function(e,t,i,r){return this.x===e&&this.y===t&&this.z===i&&this.w===r},e.prototype.multiplyInPlace=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},e.prototype.multiply=function(t){return new e(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)},e.prototype.multiplyToRef=function(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,this},e.prototype.multiplyByFloats=function(t,i,r,n){return new e(this.x*t,this.y*i,this.z*r,this.w*n)},e.prototype.divide=function(t){return new e(this.x/t.x,this.y/t.y,this.z/t.z,this.w/t.w)},e.prototype.divideToRef=function(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,this},e.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},e.prototype.minimizeInPlace=function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this},e.prototype.maximizeInPlace=function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this},e.prototype.floor=function(){return new e(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))},e.prototype.fract=function(){return new e(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},e.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},e.prototype.normalize=function(){var e=this.length();return 0===e?this:this.scaleInPlace(1/e)},e.prototype.toVector3=function(){return new ni(this.x,this.y,this.z)},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)},e.prototype.copyFrom=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e.prototype.copyFromFloats=function(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this},e.prototype.set=function(e,t,i,r){return this.copyFromFloats(e,t,i,r)},e.prototype.setAll=function(e){return this.x=this.y=this.z=this.w=e,this},e.FromArray=function(t,i){return new e(t[i=i||0],t[i+1],t[i+2],t[i+3])},e.FromArrayToRef=function(e,t,i){i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3]},e.FromFloatArrayToRef=function(t,i,r){e.FromArrayToRef(t,i,r)},e.FromFloatsToRef=function(e,t,i,r,n){n.x=e,n.y=t,n.z=i,n.w=r},e.Zero=function(){return new e(0,0,0,0)},e.One=function(){return new e(1,1,1,1)},e.Normalize=function(t){var i=e.Zero();return e.NormalizeToRef(t,i),i},e.NormalizeToRef=function(e,t){t.copyFrom(e),t.normalize()},e.Minimize=function(e,t){return(e=e.clone()).minimizeInPlace(t),e},e.Maximize=function(e,t){return(e=e.clone()).maximizeInPlace(t),e},e.Distance=function(t,i){return Math.sqrt(e.DistanceSquared(t,i))},e.DistanceSquared=function(e,t){var i=e.x-t.x,r=e.y-t.y,n=e.z-t.z;return i*i+r*r+n*n+(e=e.w-t.w)*e},e.Center=function(t,i){return e.CenterToRef(t,i,e.Zero())},e.CenterToRef=function(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)},e.TransformCoordinates=function(t,i){var r=e.Zero();return e.TransformCoordinatesToRef(t,i,r),r},e.TransformCoordinatesToRef=function(t,i,r){e.TransformCoordinatesFromFloatsToRef(t._x,t._y,t._z,i,r)},e.TransformCoordinatesFromFloatsToRef=function(e,t,i,r,n){var s=e*(r=r.m)[0]+t*r[4]+i*r[8]+r[12],o=e*r[1]+t*r[5]+i*r[9]+r[13],a=e*r[2]+t*r[6]+i*r[10]+r[14];e=e*r[3]+t*r[7]+i*r[11]+r[15];n.x=s,n.y=o,n.z=a,n.w=e},e.TransformNormal=function(t,i){var r=e.Zero();return e.TransformNormalToRef(t,i,r),r},e.TransformNormalToRef=function(e,t,i){t=t.m;var r=e.x*t[0]+e.y*t[4]+e.z*t[8],n=e.x*t[1]+e.y*t[5]+e.z*t[9];t=e.x*t[2]+e.y*t[6]+e.z*t[10];i.x=r,i.y=n,i.z=t,i.w=e.w},e.TransformNormalFromFloatsToRef=function(e,t,i,r,n,s){n=n.m,s.x=e*n[0]+t*n[4]+i*n[8],s.y=e*n[1]+t*n[5]+i*n[9],s.z=e*n[2]+t*n[6]+i*n[10],s.w=r},e.FromVector3=function(t,i){return new e(t._x,t._y,t._z,i=void 0===i?0:i)},e}(),oi=function(){function e(e,t,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===r&&(r=1),this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=r}return Object.defineProperty(e.prototype,"x",{get:function(){return this._x},set:function(e){this._x=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._y},set:function(e){this._y=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this._z},set:function(e){this._z=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"w",{get:function(){return this._w},set:function(e){this._w=e,this._isDirty=!0},enumerable:!1,configurable:!0}),e.prototype.toString=function(){return"{X: ".concat(this._x," Y: ").concat(this._y," Z: ").concat(this._z," W: ").concat(this._w,"}")},e.prototype.getClassName=function(){return"Quaternion"},e.prototype.getHashCode=function(){return 397*(397*(397*ii(this._x)^ii(this._y))^ii(this._z))^ii(this._w)},e.prototype.asArray=function(){return[this._x,this._y,this._z,this._w]},e.prototype.equals=function(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w},e.prototype.equalsWithEpsilon=function(e,t){return void 0===t&&(t=ei),e&&Qt.WithinEpsilon(this._x,e._x,t)&&Qt.WithinEpsilon(this._y,e._y,t)&&Qt.WithinEpsilon(this._z,e._z,t)&&Qt.WithinEpsilon(this._w,e._w,t)},e.prototype.clone=function(){return new e(this._x,this._y,this._z,this._w)},e.prototype.copyFrom=function(e){return this.x=e._x,this.y=e._y,this.z=e._z,this.w=e._w,this},e.prototype.copyFromFloats=function(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this},e.prototype.set=function(e,t,i,r){return this.copyFromFloats(e,t,i,r)},e.prototype.add=function(t){return new e(this._x+t._x,this._y+t._y,this._z+t._z,this._w+t._w)},e.prototype.addInPlace=function(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this},e.prototype.subtract=function(t){return new e(this._x-t._x,this._y-t._y,this._z-t._z,this._w-t._w)},e.prototype.subtractInPlace=function(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this},e.prototype.scale=function(t){return new e(this._x*t,this._y*t,this._z*t,this._w*t)},e.prototype.scaleToRef=function(e,t){return t.x=this._x*e,t.y=this._y*e,t.z=this._z*e,t.w=this._w*e,this},e.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},e.prototype.scaleAndAddToRef=function(e,t){return t.x+=this._x*e,t.y+=this._y*e,t.z+=this._z*e,t.w+=this._w*e,this},e.prototype.multiply=function(t){var i=new e(0,0,0,1);return this.multiplyToRef(t,i),i},e.prototype.multiplyToRef=function(e,t){var i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,r=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,n=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z;e=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,r,n,e),this},e.prototype.multiplyInPlace=function(e){return this.multiplyToRef(e,this),this},e.prototype.conjugateToRef=function(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),this},e.prototype.conjugateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},e.prototype.conjugate=function(){return new e(-this._x,-this._y,-this._z,this._w)},e.prototype.invert=function(){var e=this.conjugate(),t=this.lengthSquared();return 0==t||1==t||e.scaleInPlace(1/t),e},e.prototype.invertInPlace=function(){this.conjugateInPlace();var e=this.lengthSquared();return 0==e||1==e||this.scaleInPlace(1/e),this},e.prototype.lengthSquared=function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},e.prototype.length=function(){return Math.sqrt(this.lengthSquared())},e.prototype.normalize=function(){var e=this.length();return 0===e||this.scaleInPlace(1/e),this},e.prototype.normalizeToNew=function(){var e=this.length();return 0===e?this.clone():this.scale(1/e)},e.prototype.toEulerAngles=function(){var e=ni.Zero();return this.toEulerAnglesToRef(e),e},e.prototype.toEulerAnglesToRef=function(e){var t,i,r,n,s=this._z,o=this._x,a=this._y,h=this._w,l=a*s-o*h;return l<-.4999999?(e.y=2*Math.atan2(a,h),e.x=Math.PI/2,e.z=0):.4999999<l?(e.y=2*Math.atan2(a,h),e.x=-Math.PI/2,e.z=0):(t=h*h,i=s*s,r=o*o,n=a*a,e.z=Math.atan2(2*(o*a+s*h),-i-r+n+t),e.x=Math.asin(-2*l),e.y=Math.atan2(2*(s*o+a*h),i-r-n+t)),this},e.prototype.toRotationMatrix=function(e){return ai.FromQuaternionToRef(this,e),this},e.prototype.fromRotationMatrix=function(t){return e.FromRotationMatrixToRef(t,this),this},e.FromRotationMatrix=function(t){var i=new e;return e.FromRotationMatrixToRef(t,i),i},e.FromRotationMatrixToRef=function(e,t){var i,r=(e=e.m)[0],n=e[4],s=e[8],o=e[1],a=e[5],h=e[9],l=e[2],c=e[6],u=r+a+(e=e[10]);0<u?(i=.5/Math.sqrt(u+1),t.w=.25/i,t.x=(c-h)*i,t.y=(s-l)*i,t.z=(o-n)*i):a<r&&e<r?(i=2*Math.sqrt(1+r-a-e),t.w=(c-h)/i,t.x=.25*i,t.y=(n+o)/i,t.z=(s+l)/i):e<a?(i=2*Math.sqrt(1+a-r-e),t.w=(s-l)/i,t.x=(n+o)/i,t.y=.25*i,t.z=(h+c)/i):(i=2*Math.sqrt(1+e-r-a),t.w=(o-n)/i,t.x=(s+l)/i,t.y=(h+c)/i,t.z=.25*i)},e.Dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w},e.AreClose=function(t,i){return 0<=e.Dot(t,i)},e.SmoothToRef=function(t,i,r,n,s){r=Qt.Clamp(0===n?1:r/n,0,1),e.SlerpToRef(t,i,r,s)},e.Zero=function(){return new e(0,0,0,0)},e.Inverse=function(t){return new e(-t._x,-t._y,-t._z,t._w)},e.InverseToRef=function(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t},e.Identity=function(){return new e(0,0,0,1)},e.IsIdentity=function(e){return e&&0===e._x&&0===e._y&&0===e._z&&1===e._w},e.RotationAxis=function(t,i){return e.RotationAxisToRef(t,i,new e)},e.RotationAxisToRef=function(e,t,i){var r=Math.sin(t/2);return e.normalize(),i.w=Math.cos(t/2),i.x=e._x*r,i.y=e._y*r,i.z=e._z*r,i},e.FromArray=function(t,i){return new e(t[i=i||0],t[i+1],t[i+2],t[i+3])},e.FromArrayToRef=function(e,t,i){i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3]},e.FromEulerAngles=function(t,i,r){var n=new e;return e.RotationYawPitchRollToRef(i,t,r,n),n},e.FromEulerAnglesToRef=function(t,i,r,n){return e.RotationYawPitchRollToRef(i,t,r,n),n},e.FromEulerVector=function(t){var i=new e;return e.RotationYawPitchRollToRef(t._y,t._x,t._z,i),i},e.FromEulerVectorToRef=function(t,i){return e.RotationYawPitchRollToRef(t._y,t._x,t._z,i),i},e.FromUnitVectorsToRef=function(e,t,i){var r=ni.Dot(e,t)+1;return r<ei?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(ni.CrossToRef(e,t,li.Vector3[0]),i.set(li.Vector3[0].x,li.Vector3[0].y,li.Vector3[0].z,r)),i.normalize()},e.RotationYawPitchRoll=function(t,i,r){var n=new e;return e.RotationYawPitchRollToRef(t,i,r,n),n},e.RotationYawPitchRollToRef=function(e,t,i,r){i*=.5,t*=.5,e*=.5;var n=Math.sin(i),s=(i=Math.cos(i),Math.sin(t)),o=(t=Math.cos(t),Math.sin(e));e=Math.cos(e);r.x=e*s*i+o*t*n,r.y=o*t*i-e*s*n,r.z=e*t*n-o*s*i,r.w=e*t*i+o*s*n},e.RotationAlphaBetaGamma=function(t,i,r){var n=new e;return e.RotationAlphaBetaGammaToRef(t,i,r,n),n},e.RotationAlphaBetaGammaToRef=function(e,t,i,r){var n=.5*(i+e);i=.5*(i-e),e=.5*t;r.x=Math.cos(i)*Math.sin(e),r.y=Math.sin(i)*Math.sin(e),r.z=Math.sin(n)*Math.cos(e),r.w=Math.cos(n)*Math.cos(e)},e.RotationQuaternionFromAxis=function(t,i,r){var n=new e(0,0,0,0);return e.RotationQuaternionFromAxisToRef(t,i,r,n),n},e.RotationQuaternionFromAxisToRef=function(t,i,r,n){var s=hi.Matrix[0];ai.FromXYZAxesToRef(t.normalize(),i.normalize(),r.normalize(),s),e.FromRotationMatrixToRef(s,n)},e.FromLookDirectionLH=function(t,i){var r=new e;return e.FromLookDirectionLHToRef(t,i,r),r},e.FromLookDirectionLHToRef=function(t,i,r){var n=hi.Matrix[0];ai.LookDirectionLHToRef(t,i,n),e.FromRotationMatrixToRef(n,r)},e.FromLookDirectionRH=function(t,i){var r=new e;return e.FromLookDirectionRHToRef(t,i,r),r},e.FromLookDirectionRHToRef=function(t,i,r){var n=hi.Matrix[0];return ai.LookDirectionRHToRef(t,i,n),e.FromRotationMatrixToRef(n,r)},e.Slerp=function(t,i,r){var n=e.Identity();return e.SlerpToRef(t,i,r,n),n},e.SlerpToRef=function(e,t,i,r){var n,s,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,a=!1;o<0&&(a=!0,o=-o),a=.999999<o?(s=1-i,a?-i:i):(o=Math.acos(o),n=1/Math.sin(o),s=Math.sin((1-i)*o)*n,a?-Math.sin(i*o)*n:Math.sin(i*o)*n),r.x=s*e._x+a*t._x,r.y=s*e._y+a*t._y,r.z=s*e._z+a*t._z,r.w=s*e._w+a*t._w},e.Hermite=function(t,i,r,n,s){var o=s*s,a=2*(l=s*o)-3*o+1,h=-2*l+3*o,l=(s=l-2*o+s,l-o);return new e(t._x*a+r._x*h+i._x*s+n._x*l,t._y*a+r._y*h+i._y*s+n._y*l,t._z*a+r._z*h+i._z*s+n._z*l,t._w*a+r._w*h+i._w*s+n._w*l)},e.Hermite1stDerivative=function(t,i,r,n,s){var o=e.Zero();return this.Hermite1stDerivativeToRef(t,i,r,n,s,o),o},e.Hermite1stDerivativeToRef=function(e,t,i,r,n,s){var o=n*n;s.x=6*(o-n)*e.x+(3*o-4*n+1)*t.x+6*(-o+n)*i.x+(3*o-2*n)*r.x,s.y=6*(o-n)*e.y+(3*o-4*n+1)*t.y+6*(-o+n)*i.y+(3*o-2*n)*r.y,s.z=6*(o-n)*e.z+(3*o-4*n+1)*t.z+6*(-o+n)*i.z+(3*o-2*n)*r.z,s.w=6*(o-n)*e.w+(3*o-4*n+1)*t.w+6*(-o+n)*i.w+(3*o-2*n)*r.w},e}(),ai=function(){function e(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,yt.MatrixTrackPrecisionChange&&yt.MatrixTrackedMatrices.push(this),this._m=new yt.MatrixCurrentType(16),this.markAsUpdated()}return Object.defineProperty(e,"Use64Bits",{get:function(){return yt.MatrixUse64Bits},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"m",{get:function(){return this._m},enumerable:!1,configurable:!0}),e.prototype.markAsUpdated=function(){this.updateFlag=e._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0},e.prototype._updateIdentityStatus=function(e,t,i,r){void 0===t&&(t=!1),void 0===i&&(i=!1),void 0===r&&(r=!0),this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=!this._isIdentity&&t,this._isIdentity3x2Dirty=!this._isIdentity3x2&&r},e.prototype.isIdentity=function(){var e;return this._isIdentityDirty&&(this._isIdentityDirty=!1,e=this._m,this._isIdentity=1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]),this._isIdentity},e.prototype.isIdentityAs3x2=function(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,1!==this._m[0]||1!==this._m[5]||1!==this._m[15]||0!==this._m[1]||0!==this._m[2]||0!==this._m[3]||0!==this._m[4]||0!==this._m[6]||0!==this._m[7]||0!==this._m[8]||0!==this._m[9]||0!==this._m[10]||0!==this._m[11]||0!==this._m[12]||0!==this._m[13]||0!==this._m[14]?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2},e.prototype.determinant=function(){if(!0===this._isIdentity)return 1;var e,t=(e=this._m)[0],i=e[1],r=e[2],n=e[3],s=e[4],o=e[5],a=e[6],h=e[7],l=e[8],c=e[9],u=e[10],d=e[11],p=e[12],_=e[13],f=e[14],g=u*(e=e[15])-f*d,m=c*e-_*d,y=c*f-_*u;return t*(o*g-a*m+h*y)+i*-(s*g-a*(e=l*e-p*d)+h*(d=l*f-u*p))+r*(s*m-o*e+h*(f=l*_-p*c))+n*-(s*y-o*d+a*f)},e.prototype.toArray=function(){return this._m},e.prototype.asArray=function(){return this._m},e.prototype.invert=function(){return this.invertToRef(this),this},e.prototype.reset=function(){return e.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this},e.prototype.add=function(t){var i=new e;return this.addToRef(t,i),i},e.prototype.addToRef=function(e,t){for(var i=this._m,r=t._m,n=e.m,s=0;s<16;s++)r[s]=i[s]+n[s];return t.markAsUpdated(),this},e.prototype.addToSelf=function(e){for(var t=this._m,i=e.m,r=0;r<16;r++)t[r]+=i[r];return this.markAsUpdated(),this},e.prototype.invertToRef=function(t){if(!0===this._isIdentity)return e.IdentityToRef(t),this;var i=(O=this._m)[0],r=O[1],n=O[2],s=O[3],o=O[4],a=O[5],h=O[6],l=O[7],c=O[8],u=O[9],d=O[10],p=O[11],_=O[12],f=O[13],g=O[14],m=d*(O=O[15])-g*p,y=u*O-f*p,v=u*g-f*d,b=c*O-_*p,w=c*g-d*_,x=c*f-_*u,T=a*m-h*y+l*v,C=-(o*m-h*b+l*w),E=o*y-a*b+l*x,S=-(o*v-a*w+h*x);if(0==(P=i*T+r*C+n*E+s*S))return t.copyFrom(this),this;var P=1/P,R=h*O-g*l,A=a*O-f*l,M=a*g-f*h,O=o*O-_*l,I=(g=o*g-_*h,f=o*f-_*a,_=h*p-d*l,a*p-u*l),F=a*d-u*h;p=o*p-c*l,l=o*d-c*h,d=o*u-c*a;return e.FromValuesToRef(T*P,-(r*m-n*y+s*v)*P,(r*R-n*A+s*M)*P,-(r*_-n*I+s*F)*P,C*P,(i*m-n*b+s*w)*P,-(i*R-n*O+s*g)*P,(i*_-n*p+s*l)*P,E*P,-(i*y-r*b+s*x)*P,(i*A-r*O+s*f)*P,-(i*I-r*p+s*d)*P,S*P,(i*v-r*w+n*x)*P,-(i*M-r*g+n*f)*P,(i*F-r*l+n*d)*P,t),this},e.prototype.addAtIndex=function(e,t){return this._m[e]+=t,this.markAsUpdated(),this},e.prototype.multiplyAtIndex=function(e,t){return this._m[e]*=t,this.markAsUpdated(),this},e.prototype.setTranslationFromFloats=function(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this},e.prototype.addTranslationFromFloats=function(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this},e.prototype.setTranslation=function(e){return this.setTranslationFromFloats(e._x,e._y,e._z)},e.prototype.getTranslation=function(){return new ni(this._m[12],this._m[13],this._m[14])},e.prototype.getTranslationToRef=function(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],this},e.prototype.removeRotationAndScaling=function(){var t=this.m;return e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t[12],t[13],t[14],t[15],this),this._updateIdentityStatus(0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]),this},e.prototype.multiply=function(t){var i=new e;return this.multiplyToRef(t,i),i},e.prototype.copyFrom=function(e){return e.copyToArray(this._m),this.updateFlag=e.updateFlag,this._updateIdentityStatus(e._isIdentity,e._isIdentityDirty,e._isIdentity3x2,e._isIdentity3x2Dirty),this},e.prototype.copyToArray=function(e,t){var i=this._m;return e[t=void 0===t?0:t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this},e.prototype.multiplyToRef=function(e,t){return this._isIdentity?t.copyFrom(e):e._isIdentity?t.copyFrom(this):(this.multiplyToArray(e,t._m,0),t.markAsUpdated()),this},e.prototype.multiplyToArray=function(e,t,i){var r=this._m,n=(e=e.m,r[0]),s=r[1],o=r[2],a=r[3],h=r[4],l=r[5],c=r[6],u=r[7],d=r[8],p=r[9],_=r[10],f=r[11],g=r[12],m=r[13],y=r[14],v=(r=r[15],e[0]),b=e[1],w=e[2],x=e[3],T=e[4],C=e[5],E=e[6],S=e[7],P=e[8],R=e[9],A=e[10],M=e[11],O=e[12],I=e[13],F=e[14];e=e[15];return t[i]=n*v+s*T+o*P+a*O,t[i+1]=n*b+s*C+o*R+a*I,t[i+2]=n*w+s*E+o*A+a*F,t[i+3]=n*x+s*S+o*M+a*e,t[i+4]=h*v+l*T+c*P+u*O,t[i+5]=h*b+l*C+c*R+u*I,t[i+6]=h*w+l*E+c*A+u*F,t[i+7]=h*x+l*S+c*M+u*e,t[i+8]=d*v+p*T+_*P+f*O,t[i+9]=d*b+p*C+_*R+f*I,t[i+10]=d*w+p*E+_*A+f*F,t[i+11]=d*x+p*S+_*M+f*e,t[i+12]=g*v+m*T+y*P+r*O,t[i+13]=g*b+m*C+y*R+r*I,t[i+14]=g*w+m*E+y*A+r*F,t[i+15]=g*x+m*S+y*M+r*e,this},e.prototype.equals=function(e){if(!e)return!1;if((this._isIdentity||e._isIdentity)&&!this._isIdentityDirty&&!e._isIdentityDirty)return this._isIdentity&&e._isIdentity;var t=this.m;e=e.m;return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},e.prototype.clone=function(){var t=new e;return t.copyFrom(this),t},e.prototype.getClassName=function(){return"Matrix"},e.prototype.getHashCode=function(){for(var e=ii(this._m[0]),t=1;t<16;t++)e=397*e^ii(this._m[t]);return e},e.prototype.decomposeToTransformNode=function(e){return e.rotationQuaternion=e.rotationQuaternion||new oi,this.decompose(e.scaling,e.rotationQuaternion,e.position)},e.prototype.decompose=function(t,i,r,n){if(this._isIdentity)return r&&r.setAll(0),t&&t.setAll(1),i&&i.copyFromFloats(0,0,0,1),!0;var s,o=this._m;return r&&r.copyFromFloats(o[12],o[13],o[14]),(t=t||hi.Vector3[0]).x=Math.sqrt(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]),t.y=Math.sqrt(o[4]*o[4]+o[5]*o[5]+o[6]*o[6]),t.z=Math.sqrt(o[8]*o[8]+o[9]*o[9]+o[10]*o[10]),n?(r=n.scaling.x<0?-1:1,s=n.scaling.y<0?-1:1,n=n.scaling.z<0?-1:1,t.x*=r,t.y*=s,t.z*=n):this.determinant()<=0&&(t.y*=-1),0===t._x||0===t._y||0===t._z?(i&&i.copyFromFloats(0,0,0,1),!1):(i&&(r=1/t._x,s=1/t._y,n=1/t._z,e.FromValuesToRef(o[0]*r,o[1]*r,o[2]*r,0,o[4]*s,o[5]*s,o[6]*s,0,o[8]*n,o[9]*n,o[10]*n,0,0,0,0,1,hi.Matrix[0]),oi.FromRotationMatrixToRef(hi.Matrix[0],i)),!0)},e.prototype.getRow=function(e){return e<0||3<e?null:(e*=4,new si(this._m[0+e],this._m[1+e],this._m[2+e],this._m[3+e]))},e.prototype.setRow=function(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)},e.prototype.transpose=function(){return e.Transpose(this)},e.prototype.transposeToRef=function(t){return e.TransposeToRef(this,t),this},e.prototype.setRowFromFloats=function(e,t,i,r,n){return e<0||3<e||(e*=4,this._m[0+e]=t,this._m[1+e]=i,this._m[2+e]=r,this._m[3+e]=n,this.markAsUpdated()),this},e.prototype.scale=function(t){var i=new e;return this.scaleToRef(t,i),i},e.prototype.scaleToRef=function(e,t){for(var i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),this},e.prototype.scaleAndAddToRef=function(e,t){for(var i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),this},e.prototype.toNormalMatrix=function(t){var i=hi.Matrix[0];this.invertToRef(i),i.transposeToRef(t),i=t._m;e.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,t)},e.prototype.getRotationMatrix=function(){var t=new e;return this.getRotationMatrixToRef(t),t},e.prototype.getRotationMatrixToRef=function(t){var i=hi.Vector3[0];if(!this.decompose(i))return e.IdentityToRef(t),this;var r=this._m,n=1/i._x,s=1/i._y;i=1/i._z;return e.FromValuesToRef(r[0]*n,r[1]*n,r[2]*n,0,r[4]*s,r[5]*s,r[6]*s,0,r[8]*i,r[9]*i,r[10]*i,0,0,0,0,1,t),this},e.prototype.toggleModelMatrixHandInPlace=function(){var e=this._m;e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated()},e.prototype.toggleProjectionMatrixHandInPlace=function(){var e=this._m;e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated()},e.FromArray=function(t,i){void 0===i&&(i=0);var r=new e;return e.FromArrayToRef(t,i,r),r},e.FromArrayToRef=function(e,t,i){for(var r=0;r<16;r++)i._m[r]=e[r+t];i.markAsUpdated()},e.FromFloat32ArrayToRefScaled=function(e,t,i,r){for(var n=0;n<16;n++)r._m[n]=e[n+t]*i;r.markAsUpdated()},Object.defineProperty(e,"IdentityReadOnly",{get:function(){return e._IdentityReadOnly},enumerable:!1,configurable:!0}),e.FromValuesToRef=function(e,t,i,r,n,s,o,a,h,l,c,u,d,p,_,f,g){var m=g._m;m[0]=e,m[1]=t,m[2]=i,m[3]=r,m[4]=n,m[5]=s,m[6]=o,m[7]=a,m[8]=h,m[9]=l,m[10]=c,m[11]=u,m[12]=d,m[13]=p,m[14]=_,m[15]=f,g.markAsUpdated()},e.FromValues=function(t,i,r,n,s,o,a,h,l,c,u,d,p,_,f,g){var m=new e,y=m._m;return y[0]=t,y[1]=i,y[2]=r,y[3]=n,y[4]=s,y[5]=o,y[6]=a,y[7]=h,y[8]=l,y[9]=c,y[10]=u,y[11]=d,y[12]=p,y[13]=_,y[14]=f,y[15]=g,m.markAsUpdated(),m},e.Compose=function(t,i,r){var n=new e;return e.ComposeToRef(t,i,r,n),n},e.ComposeToRef=function(e,t,i,r){var n=r._m,s=(a=t._x)*(u=a+a),o=a*(d=(l=t._y)+l),a=a*(p=(c=t._z)+c),h=l*d,l=l*p,c=c*p,u=(t=t._w)*u,d=t*d,p=(t=t*p,e._x),_=e._y;e=e._z;n[0]=(1-(h+c))*p,n[1]=(o+t)*p,n[2]=(a-d)*p,n[3]=0,n[4]=(o-t)*_,n[5]=(1-(s+c))*_,n[6]=(l+u)*_,n[7]=0,n[8]=(a+d)*e,n[9]=(l-u)*e,n[10]=(1-(s+h))*e,n[11]=0,n[12]=i._x,n[13]=i._y,n[14]=i._z,n[15]=1,r.markAsUpdated()},e.Identity=function(){var t=e.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return t._updateIdentityStatus(!0),t},e.IdentityToRef=function(t){e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(!0)},e.Zero=function(){var t=e.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return t._updateIdentityStatus(!1),t},e.RotationX=function(t){var i=new e;return e.RotationXToRef(t,i),i},e.Invert=function(t){var i=new e;return t.invertToRef(i),i},e.RotationXToRef=function(t,i){var r=Math.sin(t);t=Math.cos(t);e.FromValuesToRef(1,0,0,0,0,t,r,0,0,-r,t,0,0,0,0,1,i),i._updateIdentityStatus(1===t&&0===r)},e.RotationY=function(t){var i=new e;return e.RotationYToRef(t,i),i},e.RotationYToRef=function(t,i){var r=Math.sin(t);t=Math.cos(t);e.FromValuesToRef(t,0,-r,0,0,1,0,0,r,0,t,0,0,0,0,1,i),i._updateIdentityStatus(1===t&&0===r)},e.RotationZ=function(t){var i=new e;return e.RotationZToRef(t,i),i},e.RotationZToRef=function(t,i){var r=Math.sin(t);t=Math.cos(t);e.FromValuesToRef(t,r,0,0,-r,t,0,0,0,0,1,0,0,0,0,1,i),i._updateIdentityStatus(1===t&&0===r)},e.RotationAxis=function(t,i){var r=new e;return e.RotationAxisToRef(t,i,r),r},e.RotationAxisToRef=function(e,t,i){var r=Math.sin(-t),n=1-(t=Math.cos(-t)),s=(e.normalize(),i._m);s[0]=e._x*e._x*n+t,s[1]=e._x*e._y*n-e._z*r,s[2]=e._x*e._z*n+e._y*r,s[3]=0,s[4]=e._y*e._x*n+e._z*r,s[5]=e._y*e._y*n+t,s[6]=e._y*e._z*n-e._x*r,s[7]=0,s[8]=e._z*e._x*n-e._y*r,s[9]=e._z*e._y*n+e._x*r,s[10]=e._z*e._z*n+t,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,i.markAsUpdated()},e.RotationAlignToRef=function(e,t,i){var r=ni.Dot(t,e),n=i._m;r<-.999?(n[0]=-1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1):(t=ni.Cross(t,e),n[0]=t._x*t._x*(e=1/(1+r))+r,n[1]=t._y*t._x*e-t._z,n[2]=t._z*t._x*e+t._y,n[3]=0,n[4]=t._x*t._y*e+t._z,n[5]=t._y*t._y*e+r,n[6]=t._z*t._y*e-t._x,n[7]=0,n[8]=t._x*t._z*e-t._y,n[9]=t._y*t._z*e+t._x,n[10]=t._z*t._z*e+r),n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,i.markAsUpdated()},e.RotationYawPitchRoll=function(t,i,r){var n=new e;return e.RotationYawPitchRollToRef(t,i,r,n),n},e.RotationYawPitchRollToRef=function(e,t,i,r){oi.RotationYawPitchRollToRef(e,t,i,hi.Quaternion[0]),hi.Quaternion[0].toRotationMatrix(r)},e.Scaling=function(t,i,r){var n=new e;return e.ScalingToRef(t,i,r,n),n},e.ScalingToRef=function(t,i,r,n){e.FromValuesToRef(t,0,0,0,0,i,0,0,0,0,r,0,0,0,0,1,n),n._updateIdentityStatus(1===t&&1===i&&1===r)},e.Translation=function(t,i,r){var n=new e;return e.TranslationToRef(t,i,r,n),n},e.TranslationToRef=function(t,i,r,n){e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t,i,r,1,n),n._updateIdentityStatus(0===t&&0===i&&0===r)},e.Lerp=function(t,i,r){var n=new e;return e.LerpToRef(t,i,r,n),n},e.LerpToRef=function(e,t,i,r){for(var n=r._m,s=e.m,o=t.m,a=0;a<16;a++)n[a]=s[a]*(1-i)+o[a]*i;r.markAsUpdated()},e.DecomposeLerp=function(t,i,r){var n=new e;return e.DecomposeLerpToRef(t,i,r,n),n},e.DecomposeLerpToRef=function(t,i,r,n){var s=hi.Vector3[0],o=hi.Quaternion[0],a=hi.Vector3[1],h=(t=(t.decompose(s,o,a),hi.Vector3[2]),hi.Quaternion[1]),l=hi.Vector3[3];i.decompose(t,h,l),i=hi.Vector3[4],ni.LerpToRef(s,t,r,i),s=hi.Quaternion[2],oi.SlerpToRef(o,h,r,s),t=hi.Vector3[5];ni.LerpToRef(a,l,r,t),e.ComposeToRef(i,s,t,n)},e.LookAtLH=function(t,i,r){var n=new e;return e.LookAtLHToRef(t,i,r,n),n},e.LookAtLHToRef=function(t,i,r,n){var s=hi.Vector3[0],o=hi.Vector3[1],a=hi.Vector3[2];0===(i=(i.subtractToRef(t,a),a.normalize(),ni.CrossToRef(r,a,s),s.lengthSquared()))?s.x=1:s.normalizeFromLength(Math.sqrt(i)),ni.CrossToRef(a,s,o),o.normalize(),r=-ni.Dot(s,t),i=-ni.Dot(o,t),t=-ni.Dot(a,t);e.FromValuesToRef(s._x,o._x,a._x,0,s._y,o._y,a._y,0,s._z,o._z,a._z,0,r,i,t,1,n)},e.LookAtRH=function(t,i,r){var n=new e;return e.LookAtRHToRef(t,i,r,n),n},e.LookAtRHToRef=function(t,i,r,n){var s=hi.Vector3[0],o=hi.Vector3[1],a=hi.Vector3[2];0===(i=(t.subtractToRef(i,a),a.normalize(),ni.CrossToRef(r,a,s),s.lengthSquared()))?s.x=1:s.normalizeFromLength(Math.sqrt(i)),ni.CrossToRef(a,s,o),o.normalize(),r=-ni.Dot(s,t),i=-ni.Dot(o,t),t=-ni.Dot(a,t);e.FromValuesToRef(s._x,o._x,a._x,0,s._y,o._y,a._y,0,s._z,o._z,a._z,0,r,i,t,1,n)},e.LookDirectionLH=function(t,i){var r=new e;return e.LookDirectionLHToRef(t,i,r),r},e.LookDirectionLHToRef=function(t,i,r){var n=hi.Vector3[0];n.copyFrom(t),n.scaleInPlace(-1),t=hi.Vector3[1];ni.CrossToRef(i,n,t),e.FromValuesToRef(t._x,t._y,t._z,0,i._x,i._y,i._z,0,n._x,n._y,n._z,0,0,0,0,1,r)},e.LookDirectionRH=function(t,i){var r=new e;return e.LookDirectionRHToRef(t,i,r),r},e.LookDirectionRHToRef=function(t,i,r){var n=hi.Vector3[2];ni.CrossToRef(i,t,n),e.FromValuesToRef(n._x,n._y,n._z,0,i._x,i._y,i._z,0,t._x,t._y,t._z,0,0,0,0,1,r)},e.OrthoLH=function(t,i,r,n,s){var o=new e;return e.OrthoLHToRef(t,i,r,n,o,s),o},e.OrthoLHToRef=function(t,i,r,n,s,o){t=2/t,i=2/i;var a=2/(n-r);n=-(n+r)/(n-r);e.FromValuesToRef(t,0,0,0,0,i,0,0,0,0,a,0,0,0,n,1,s),o&&s.multiplyToRef(ci,s),s._updateIdentityStatus(1==t&&1==i&&1==a&&0==n)},e.OrthoOffCenterLH=function(t,i,r,n,s,o,a){var h=new e;return e.OrthoOffCenterLHToRef(t,i,r,n,s,o,h,a),h},e.OrthoOffCenterLHToRef=function(t,i,r,n,s,o,a,h){e.FromValuesToRef(2/(i-t),0,0,0,0,2/(n-r),0,0,0,0,2/(o-s),0,(t+i)/(t-i),(n+r)/(r-n),-(o+s)/(o-s),1,a),h&&a.multiplyToRef(ci,a),a.markAsUpdated()},e.OrthoOffCenterRH=function(t,i,r,n,s,o,a){var h=new e;return e.OrthoOffCenterRHToRef(t,i,r,n,s,o,h,a),h},e.OrthoOffCenterRHToRef=function(t,i,r,n,s,o,a,h){e.OrthoOffCenterLHToRef(t,i,r,n,s,o,a,h),a._m[10]*=-1},e.PerspectiveLH=function(t,i,r,n,s,o){void 0===o&&(o=0);var a=new e,h=(t=2*r/t,i=2*r/i,(n+r)/(n-r));n=-2*n*r/(n-r),r=Math.tan(o);return e.FromValuesToRef(t,0,0,0,0,i,0,r,0,0,h,1,0,0,n,0,a),s&&a.multiplyToRef(ci,a),a._updateIdentityStatus(!1),a},e.PerspectiveFovLH=function(t,i,r,n,s,o,a){void 0===o&&(o=0),void 0===a&&(a=!1);var h=new e;return e.PerspectiveFovLHToRef(t,i,r,n,h,!0,s,o,a),h},e.PerspectiveFovLHToRef=function(t,i,r,n,s,o,a,h,l){void 0===o&&(o=!0),void 0===h&&(h=0),void 0===l&&(l=!1);t=1/Math.tan(.5*t);var c=o?t/i:t;o=o?t:t*i,t=l&&0===r?-1:0!==n?(n+r)/(n-r):1,i=l&&0===r?2*n:0!==n?-2*n*r/(n-r):-2*r,l=Math.tan(h);e.FromValuesToRef(c,0,0,0,0,o,0,l,0,0,t,1,0,0,i,0,s),a&&s.multiplyToRef(ci,s),s._updateIdentityStatus(!1)},e.PerspectiveFovReverseLHToRef=function(t,i,r,n,s,o,a,h){void 0===o&&(o=!0),void 0===h&&(h=0);t=1/Math.tan(.5*t);var l=o?t/i:t;o=o?t:t*i,t=Math.tan(h);e.FromValuesToRef(l,0,0,0,0,o,0,t,0,0,-r,1,0,0,1,0,s),a&&s.multiplyToRef(ci,s),s._updateIdentityStatus(!1)},e.PerspectiveFovRH=function(t,i,r,n,s,o,a){void 0===o&&(o=0),void 0===a&&(a=!1);var h=new e;return e.PerspectiveFovRHToRef(t,i,r,n,h,!0,s,o,a),h},e.PerspectiveFovRHToRef=function(t,i,r,n,s,o,a,h,l){void 0===o&&(o=!0),void 0===h&&(h=0),void 0===l&&(l=!1);t=1/Math.tan(.5*t);var c=o?t/i:t;o=o?t:t*i,t=l&&0===r?1:0!==n?-(n+r)/(n-r):-1,i=l&&0===r?2*n:0!==n?-2*n*r/(n-r):-2*r,l=Math.tan(h);e.FromValuesToRef(c,0,0,0,0,o,0,l,0,0,t,-1,0,0,i,0,s),a&&s.multiplyToRef(ci,s),s._updateIdentityStatus(!1)},e.PerspectiveFovReverseRHToRef=function(t,i,r,n,s,o,a,h){void 0===o&&(o=!0),void 0===h&&(h=0);t=1/Math.tan(.5*t);var l=o?t/i:t;o=o?t:t*i,t=Math.tan(h);e.FromValuesToRef(l,0,0,0,0,o,0,t,0,0,-r,-1,0,0,-1,0,s),a&&s.multiplyToRef(ci,s),s._updateIdentityStatus(!1)},e.PerspectiveFovWebVRToRef=function(e,t,i,r,n,s,o){void 0===o&&(o=0);n=(n=void 0!==n&&n)?-1:1;var a=Math.tan(e.upDegrees*Math.PI/180),h=Math.tan(e.downDegrees*Math.PI/180),l=Math.tan(e.leftDegrees*Math.PI/180),c=2/(l+(e=Math.tan(e.rightDegrees*Math.PI/180))),u=2/(a+h),d=(o=Math.tan(o),r._m);d[0]=c,d[1]=d[2]=d[3]=d[4]=0,d[5]=u,d[6]=0,d[7]=o,d[8]=(l-e)*c*.5,d[9]=-(a-h)*u*.5,d[10]=-i/(t-i),d[11]=n,d[12]=d[13]=d[15]=0,d[14]=-2*i*t/(i-t),s&&r.multiplyToRef(ci,r),r.markAsUpdated()},e.GetFinalMatrix=function(t,i,r,n,s,o){var a=t.width,h=t.height,l=t.x;t=t.y,o=e.FromValues(a/2,0,0,0,0,-h/2,0,0,0,0,o-s,0,l+a/2,h/2+t,s,1),l=hi.Matrix[0];return i.multiplyToRef(r,l),l.multiplyToRef(n,l),l.multiply(o)},e.GetAsMatrix2x2=function(e){return e=[(e=e.m)[0],e[1],e[4],e[5]],yt.MatrixUse64Bits?e:new Float32Array(e)},e.GetAsMatrix3x3=function(e){return e=[(e=e.m)[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]],yt.MatrixUse64Bits?e:new Float32Array(e)},e.Transpose=function(t){var i=new e;return e.TransposeToRef(t,i),i},e.TransposeToRef=function(e,t){var i=t._m,r=e.m;i[0]=r[0],i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=r[1],i[5]=r[5],i[6]=r[9],i[7]=r[13],i[8]=r[2],i[9]=r[6],i[10]=r[10],i[11]=r[14],i[12]=r[3],i[13]=r[7],i[14]=r[11],i[15]=r[15],t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty)},e.Reflection=function(t){var i=new e;return e.ReflectionToRef(t,i),i},e.ReflectionToRef=function(t,i){t.normalize();var r=t.normal.x,n=t.normal.y,s=t.normal.z,o=-2*r,a=-2*n,h=-2*s;e.FromValuesToRef(o*r+1,a*r,h*r,0,o*n,a*n+1,h*n,0,o*s,a*s,h*s+1,0,o*t.d,a*t.d,h*t.d,1,i)},e.FromXYZAxesToRef=function(t,i,r,n){e.FromValuesToRef(t._x,t._y,t._z,0,i._x,i._y,i._z,0,r._x,r._y,r._z,0,0,0,0,1,n)},e.FromQuaternionToRef=function(e,t){var i=e._x*e._x,r=e._y*e._y,n=e._z*e._z,s=e._x*e._y,o=e._z*e._w,a=e._z*e._x,h=e._y*e._w,l=e._y*e._z;e=e._x*e._w;t._m[0]=1-2*(r+n),t._m[1]=2*(s+o),t._m[2]=2*(a-h),t._m[3]=0,t._m[4]=2*(s-o),t._m[5]=1-2*(n+i),t._m[6]=2*(l+e),t._m[7]=0,t._m[8]=2*(a+h),t._m[9]=2*(l-e),t._m[10]=1-2*(r+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated()},e._UpdateFlagSeed=0,e._IdentityReadOnly=e.Identity(),e}(),hi=function(){function e(){}return e.Vector3=ti.BuildTuple(11,ni.Zero),e.Matrix=ti.BuildTuple(2,ai.Identity),e.Quaternion=ti.BuildTuple(3,oi.Zero),e}(),li=function(){function e(){}return e.Vector2=ti.BuildTuple(3,ri.Zero),e.Vector3=ti.BuildTuple(13,ni.Zero),e.Vector4=ti.BuildTuple(3,si.Zero),e.Quaternion=ti.BuildTuple(2,oi.Zero),e.Matrix=ti.BuildTuple(8,ai.Identity),e}(),ci=(jt("BABYLON.Vector2",ri),jt("BABYLON.Vector3",ni),jt("BABYLON.Vector4",si),jt("BABYLON.Matrix",ai),ai.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1)),ui=function(){function e(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}return e.AddParser=function(e,t){this._BabylonFileParsers[e]=t},e.GetParser=function(e){return this._BabylonFileParsers[e]||null},e.AddIndividualParser=function(e,t){this._IndividualBabylonFileParsers[e]=t},e.GetIndividualParser=function(e){return this._IndividualBabylonFileParsers[e]||null},e.Parse=function(e,t,i,r){for(var n in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,n)&&this._BabylonFileParsers[n](e,t,i,r)},Object.defineProperty(e.prototype,"environmentTexture",{get:function(){return this._environmentTexture},set:function(e){this._environmentTexture=e},enumerable:!1,configurable:!0}),e.prototype.getNodes=function(){var e=new Array;return e=(e=(e=(e=e.concat(this.meshes)).concat(this.lights)).concat(this.cameras)).concat(this.transformNodes),this.skeletons.forEach((function(t){return e=e.concat(t.bones)})),e},e._BabylonFileParsers={},e._IndividualBabylonFileParsers={},e}(),di=function(){function e(e,t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.r=e=void 0===e?0:e,this.g=t,this.b=i}return e.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"},e.prototype.getClassName=function(){return"Color3"},e.prototype.getHashCode=function(){return 397*(397*(255*this.r|0)^(255*this.g|0))^(255*this.b|0)},e.prototype.toArray=function(e,t){return e[t=void 0===t?0:t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this},e.prototype.fromArray=function(t,i){return e.FromArrayToRef(t,i=void 0===i?0:i,this),this},e.prototype.toColor4=function(e){return new pi(this.r,this.g,this.b,e=void 0===e?1:e)},e.prototype.asArray=function(){return[this.r,this.g,this.b]},e.prototype.toLuminance=function(){return.3*this.r+.59*this.g+.11*this.b},e.prototype.multiply=function(t){return new e(this.r*t.r,this.g*t.g,this.b*t.b)},e.prototype.multiplyToRef=function(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this},e.prototype.equals=function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b},e.prototype.equalsFloats=function(e,t,i){return this.r===e&&this.g===t&&this.b===i},e.prototype.scale=function(t){return new e(this.r*t,this.g*t,this.b*t)},e.prototype.scaleToRef=function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this},e.prototype.scaleAndAddToRef=function(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this},e.prototype.clampToRef=function(e,t,i){return i.r=Qt.Clamp(this.r,e=void 0===e?0:e,t=void 0===t?1:t),i.g=Qt.Clamp(this.g,e,t),i.b=Qt.Clamp(this.b,e,t),this},e.prototype.add=function(t){return new e(this.r+t.r,this.g+t.g,this.b+t.b)},e.prototype.addToRef=function(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this},e.prototype.subtract=function(t){return new e(this.r-t.r,this.g-t.g,this.b-t.b)},e.prototype.subtractToRef=function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this},e.prototype.clone=function(){return new e(this.r,this.g,this.b)},e.prototype.copyFrom=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},e.prototype.copyFromFloats=function(e,t,i){return this.r=e,this.g=t,this.b=i,this},e.prototype.set=function(e,t,i){return this.copyFromFloats(e,t,i)},e.prototype.toHexString=function(){var e=Math.round(255*this.r),t=Math.round(255*this.g),i=Math.round(255*this.b);return"#"+Qt.ToHex(e)+Qt.ToHex(t)+Qt.ToHex(i)},e.prototype.toLinearSpace=function(){var t=new e;return this.toLinearSpaceToRef(t),t},e.prototype.toHSV=function(){var t=new e;return this.toHSVToRef(t),t},e.prototype.toHSVToRef=function(e){var t=this.r,i=this.g,r=this.b,n=Math.max(t,i,r),s=Math.min(t,i,r),o=0,a=0,h=n,l=n-s;0!==n&&(a=l/n),n!=s&&(n==t?(o=(i-r)/l,i<r&&(o+=6)):n==i?o=(r-t)/l+2:n==r&&(o=(t-i)/l+4),o*=60),e.r=o,e.g=a,e.b=h},e.prototype.toLinearSpaceToRef=function(e){return e.r=Math.pow(this.r,$t),e.g=Math.pow(this.g,$t),e.b=Math.pow(this.b,$t),this},e.prototype.toGammaSpace=function(){var t=new e;return this.toGammaSpaceToRef(t),t},e.prototype.toGammaSpaceToRef=function(e){return e.r=Math.pow(this.r,Jt),e.g=Math.pow(this.g,Jt),e.b=Math.pow(this.b,Jt),this},e.HSVtoRGBToRef=function(e,t,i,r){e/=60;var n=(t=i*t)*(1-Math.abs(e%2-1)),s=0,o=0,a=0;0<=e&&e<=1?(s=t,o=n):1<=e&&e<=2?(s=n,o=t):2<=e&&e<=3?(o=t,a=n):3<=e&&e<=4?(o=n,a=t):4<=e&&e<=5?(s=n,a=t):5<=e&&e<=6&&(s=t,a=n),e=i-t;r.set(s+e,o+e,a+e)},e.FromHexString=function(t){if("#"!==t.substring(0,1)||7!==t.length)return new e(0,0,0);var i=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16);t=parseInt(t.substring(5,7),16);return e.FromInts(i,r,t)},e.FromArray=function(t,i){return new e(t[i=void 0===i?0:i],t[i+1],t[i+2])},e.FromArrayToRef=function(e,t,i){i.r=e[t=void 0===t?0:t],i.g=e[t+1],i.b=e[t+2]},e.FromInts=function(t,i,r){return new e(t/255,i/255,r/255)},e.Lerp=function(t,i,r){var n=new e(0,0,0);return e.LerpToRef(t,i,r,n),n},e.LerpToRef=function(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i},e.Hermite=function(t,i,r,n,s){var o=s*s,a=2*(l=s*o)-3*o+1,h=-2*l+3*o,l=(s=l-2*o+s,l-o);return new e(t.r*a+r.r*h+i.r*s+n.r*l,t.g*a+r.g*h+i.g*s+n.g*l,t.b*a+r.b*h+i.b*s+n.b*l)},e.Hermite1stDerivative=function(t,i,r,n,s){var o=e.Black();return this.Hermite1stDerivativeToRef(t,i,r,n,s,o),o},e.Hermite1stDerivativeToRef=function(e,t,i,r,n,s){var o=n*n;s.r=6*(o-n)*e.r+(3*o-4*n+1)*t.r+6*(-o+n)*i.r+(3*o-2*n)*r.r,s.g=6*(o-n)*e.g+(3*o-4*n+1)*t.g+6*(-o+n)*i.g+(3*o-2*n)*r.g,s.b=6*(o-n)*e.b+(3*o-4*n+1)*t.b+6*(-o+n)*i.b+(3*o-2*n)*r.b},e.Red=function(){return new e(1,0,0)},e.Green=function(){return new e(0,1,0)},e.Blue=function(){return new e(0,0,1)},e.Black=function(){return new e(0,0,0)},Object.defineProperty(e,"BlackReadOnly",{get:function(){return e._BlackReadOnly},enumerable:!1,configurable:!0}),e.White=function(){return new e(1,1,1)},e.Purple=function(){return new e(.5,0,.5)},e.Magenta=function(){return new e(1,0,1)},e.Yellow=function(){return new e(1,1,0)},e.Gray=function(){return new e(.5,.5,.5)},e.Teal=function(){return new e(0,1,1)},e.Random=function(){return new e(Math.random(),Math.random(),Math.random())},e._BlackReadOnly=e.Black(),e}(),pi=function(){function e(e,t,i,r){void 0===t&&(t=0),void 0===i&&(i=0),void 0===r&&(r=1),this.r=e=void 0===e?0:e,this.g=t,this.b=i,this.a=r}return e.prototype.addInPlace=function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this},e.prototype.asArray=function(){return[this.r,this.g,this.b,this.a]},e.prototype.toArray=function(e,t){return e[t=void 0===t?0:t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this},e.prototype.fromArray=function(t,i){return e.FromArrayToRef(t,i=void 0===i?0:i,this),this},e.prototype.equals=function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a},e.prototype.add=function(t){return new e(this.r+t.r,this.g+t.g,this.b+t.b,this.a+t.a)},e.prototype.subtract=function(t){return new e(this.r-t.r,this.g-t.g,this.b-t.b,this.a-t.a)},e.prototype.subtractToRef=function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this},e.prototype.scale=function(t){return new e(this.r*t,this.g*t,this.b*t,this.a*t)},e.prototype.scaleToRef=function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this},e.prototype.scaleAndAddToRef=function(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this},e.prototype.clampToRef=function(e,t,i){return i.r=Qt.Clamp(this.r,e=void 0===e?0:e,t=void 0===t?1:t),i.g=Qt.Clamp(this.g,e,t),i.b=Qt.Clamp(this.b,e,t),i.a=Qt.Clamp(this.a,e,t),this},e.prototype.multiply=function(t){return new e(this.r*t.r,this.g*t.g,this.b*t.b,this.a*t.a)},e.prototype.multiplyToRef=function(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t},e.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"},e.prototype.getClassName=function(){return"Color4"},e.prototype.getHashCode=function(){return 397*(397*(397*(255*this.r|0)^(255*this.g|0))^(255*this.b|0))^(255*this.a|0)},e.prototype.clone=function(){return new e(this.r,this.g,this.b,this.a)},e.prototype.copyFrom=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},e.prototype.copyFromFloats=function(e,t,i,r){return this.r=e,this.g=t,this.b=i,this.a=r,this},e.prototype.set=function(e,t,i,r){return this.copyFromFloats(e,t,i,r)},e.prototype.toHexString=function(e){void 0===e&&(e=!1);var t=Math.round(255*this.r),i=Math.round(255*this.g),r=Math.round(255*this.b);return e?"#"+Qt.ToHex(t)+Qt.ToHex(i)+Qt.ToHex(r):(e=Math.round(255*this.a),"#"+Qt.ToHex(t)+Qt.ToHex(i)+Qt.ToHex(r)+Qt.ToHex(e))},e.prototype.toLinearSpace=function(){var t=new e;return this.toLinearSpaceToRef(t),t},e.prototype.toLinearSpaceToRef=function(e){return e.r=Math.pow(this.r,$t),e.g=Math.pow(this.g,$t),e.b=Math.pow(this.b,$t),e.a=this.a,this},e.prototype.toGammaSpace=function(){var t=new e;return this.toGammaSpaceToRef(t),t},e.prototype.toGammaSpaceToRef=function(e){return e.r=Math.pow(this.r,Jt),e.g=Math.pow(this.g,Jt),e.b=Math.pow(this.b,Jt),e.a=this.a,this},e.FromHexString=function(t){if("#"!==t.substring(0,1)||9!==t.length&&7!==t.length)return new e(0,0,0,0);var i=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16),n=parseInt(t.substring(5,7),16);t=9===t.length?parseInt(t.substring(7,9),16):255;return e.FromInts(i,r,n,t)},e.Lerp=function(t,i,r){var n=new e(0,0,0,0);return e.LerpToRef(t,i,r,n),n},e.LerpToRef=function(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i,r.a=e.a+(t.a-e.a)*i},e.Hermite=function(t,i,r,n,s){var o=s*s,a=2*(l=s*o)-3*o+1,h=-2*l+3*o,l=(s=l-2*o+s,l-o);return new e(t.r*a+r.r*h+i.r*s+n.r*l,t.g*a+r.g*h+i.g*s+n.g*l,t.b*a+r.b*h+i.b*s+n.b*l,t.a*a+r.a*h+i.a*s+n.a*l)},e.Hermite1stDerivative=function(t,i,r,n,s){var o=new e;return this.Hermite1stDerivativeToRef(t,i,r,n,s,o),o},e.Hermite1stDerivativeToRef=function(e,t,i,r,n,s){var o=n*n;s.r=6*(o-n)*e.r+(3*o-4*n+1)*t.r+6*(-o+n)*i.r+(3*o-2*n)*r.r,s.g=6*(o-n)*e.g+(3*o-4*n+1)*t.g+6*(-o+n)*i.g+(3*o-2*n)*r.g,s.b=6*(o-n)*e.b+(3*o-4*n+1)*t.b+6*(-o+n)*i.b+(3*o-2*n)*r.b,s.a=6*(o-n)*e.a+(3*o-4*n+1)*t.a+6*(-o+n)*i.a+(3*o-2*n)*r.a},e.FromColor3=function(t,i){return new e(t.r,t.g,t.b,i=void 0===i?1:i)},e.FromArray=function(t,i){return new e(t[i=void 0===i?0:i],t[i+1],t[i+2],t[i+3])},e.FromArrayToRef=function(e,t,i){i.r=e[t=void 0===t?0:t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]},e.FromInts=function(t,i,r,n){return new e(t/255,i/255,r/255,n/255)},e.CheckColors4=function(e,t){if(e.length!==3*t)return e;for(var i=[],r=0;r<e.length;r+=3){var n=r/3*4;i[n]=e[r],i[1+n]=e[r+1],i[2+n]=e[r+2],i[3+n]=1}return i},e}(),_i=(ti.BuildArray(3,di.Black),ti.BuildArray(3,(function(){return new pi(0,0,0,0)})),jt("BABYLON.Color3",di),jt("BABYLON.Color4",pi),{}),fi={},gi=function(e,t,i){var r,n=e(),s=(Zt&&Zt.AddTagsTo(n,t.tags),mi(n));for(r in s){var o=s[r],a=t[r];o=o.type;if(null!=a&&("uniqueId"!==r||Ii.AllowLoadingUniqueId))switch(o){case 0:case 6:case 11:n[r]=a;break;case 1:n[r]=i||a.isRenderTarget?a:a.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:n[r]=i?a:a.clone()}}return n};function mi(e){var t=e.getClassName();if(fi[t])return fi[t];fi[t]={};for(var i=fi[t],r=e,n=t;n;){var s,o=_i[n];for(s in o)i[s]=o[s];var a=void 0,h=!1;do{if(!(a=Object.getPrototypeOf(r)).getClassName){h=!0;break}}while(a.getClassName()===n&&(r=a));if(h)break;n=a.getClassName(),r=a}return i}function yi(e,t){return function(i,r){(i=function(e){return e=e.getClassName(),_i[e]||(_i[e]={}),_i[e]}(i))[r]||(i[r]={type:e,sourceName:t})}}function vi(e){return yi(0,e)}function bi(e){return yi(1,e)}function wi(e){return yi(7,e)}function xi(e){return yi(8,e)}var Ti,Ci,Ei,Si,Pi,Ri,Ai,Mi,Oi,Ii=function(){function e(){}return e.AppendSerializedAnimations=function(e,t){if(e.animations){t.animations=[];for(var i=0;i<e.animations.length;i++){var r=e.animations[i];t.animations.push(r.serialize())}}},e.Serialize=function(t,i){i=i||{},Zt&&(i.tags=Zt.GetTags(t));var r,n=mi(t);for(r in n){var s=(o=n[r]).sourceName||r,o=o.type,a=t[r];if(null!=a&&("uniqueId"!==r||e.AllowLoadingUniqueId))switch(o){case 0:i[s]=a;break;case 1:case 3:case 7:case 9:i[s]=a.serialize();break;case 2:case 4:case 5:case 8:case 10:case 12:i[s]=a.asArray();break;case 6:case 11:i[s]=a.id}}return i},e.Parse=function(t,i,r,n){void 0===n&&(n=null);var s,o=t(),a=(n=n||"",Zt&&Zt.AddTagsTo(o,i.tags),mi(o));for(s in a){var h=i[(l=a[s]).sourceName||s],l=l.type;if(null!=h&&("uniqueId"!==s||e.AllowLoadingUniqueId)){var c=o;switch(l){case 0:c[s]=h;break;case 1:r&&(c[s]=e._TextureParser(h,r,n));break;case 2:c[s]=di.FromArray(h);break;case 3:c[s]=e._FresnelParametersParser(h);break;case 4:c[s]=ri.FromArray(h);break;case 5:c[s]=ni.FromArray(h);break;case 6:r&&(c[s]=r.getLastMeshById(h));break;case 7:c[s]=e._ColorCurvesParser(h);break;case 8:c[s]=pi.FromArray(h);break;case 9:c[s]=e._ImageProcessingConfigurationParser(h);break;case 10:c[s]=oi.FromArray(h);break;case 11:r&&(c[s]=r.getCameraById(h));break;case 12:c[s]=ai.FromArray(h)}}}return o},e.Clone=function(e,t){return gi(e,t,!1)},e.Instanciate=function(e,t){return gi(e,t,!0)},e.AllowLoadingUniqueId=!1,e._ImageProcessingConfigurationParser=function(e){throw De("ImageProcessingConfiguration")},e._FresnelParametersParser=function(e){throw De("FresnelParameters")},e._ColorCurvesParser=function(e){throw De("ColorCurves")},e._TextureParser=function(e,t,i){throw De("Texture")},e}(),Fi=function(){function e(e){if(this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isDirty},enumerable:!1,configurable:!0}),e.prototype.markAsProcessed=function(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1},e.prototype.markAsUnprocessed=function(){this._isDirty=!0},e.prototype.markAllAsDirty=function(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0},e.prototype.markAsImageProcessingDirty=function(){this._areImageProcessingDirty=!0,this._isDirty=!0},e.prototype.markAsLightDirty=function(e){void 0===e&&(e=!1),this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0},e.prototype.markAsAttributesDirty=function(){this._areAttributesDirty=!0,this._isDirty=!0},e.prototype.markAsTexturesDirty=function(){this._areTexturesDirty=!0,this._isDirty=!0},e.prototype.markAsFresnelDirty=function(){this._areFresnelDirty=!0,this._isDirty=!0},e.prototype.markAsMiscDirty=function(){this._areMiscDirty=!0,this._isDirty=!0},e.prototype.markAsPrePassDirty=function(){this._arePrePassDirty=!0,this._isDirty=!0},e.prototype.rebuild=function(){this._keys=[];for(var e=0,t=Object.keys(this);e<t.length;e++){var i=t[e];"_"!==i[0]&&this._keys.push(i)}if(this._externalProperties)for(var r in this._externalProperties)-1===this._keys.indexOf(r)&&this._keys.push(r)},e.prototype.isEqual=function(e){if(this._keys.length!==e._keys.length)return!1;for(var t=0;t<this._keys.length;t++){var i=this._keys[t];if(this[i]!==e[i])return!1}return!0},e.prototype.cloneTo=function(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(var t=0;t<this._keys.length;t++){var i=this._keys[t];e[i]=this[i]}},e.prototype.reset=function(){var e=this;this._keys.forEach((function(t){return e._setDefaultValue(t)}))},e.prototype._setDefaultValue=function(e){var t,i=null!=(i=null==(i=null==(i=this._externalProperties)?void 0:i[e])?void 0:i.type)?i:typeof this[e],r=null==(t=null==(t=this._externalProperties)?void 0:t[e])?void 0:t.default;switch(i){case"number":this[e]=null!=r?r:0;break;case"string":this[e]=null!=r?r:"";break;default:this[e]=null!=r&&r}},e.prototype.toString=function(){for(var e="",t=0;t<this._keys.length;t++){var i=this._keys[t],r=this[i];switch(typeof r){case"number":case"string":e+="#define "+i+" "+r+"\n";break;default:r&&(e+="#define "+i+"\n")}}return e},e}(),Di=function(){function e(){this._dirty=!0,this._tempColor=new pi(0,0,0,0),this._globalCurve=new pi(0,0,0,0),this._highlightsCurve=new pi(0,0,0,0),this._midtonesCurve=new pi(0,0,0,0),this._shadowsCurve=new pi(0,0,0,0),this._positiveCurve=new pi(0,0,0,0),this._negativeCurve=new pi(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}return Object.defineProperty(e.prototype,"globalHue",{get:function(){return this._globalHue},set:function(e){this._globalHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"globalDensity",{get:function(){return this._globalDensity},set:function(e){this._globalDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"globalSaturation",{get:function(){return this._globalSaturation},set:function(e){this._globalSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"globalExposure",{get:function(){return this._globalExposure},set:function(e){this._globalExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"highlightsHue",{get:function(){return this._highlightsHue},set:function(e){this._highlightsHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"highlightsDensity",{get:function(){return this._highlightsDensity},set:function(e){this._highlightsDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"highlightsSaturation",{get:function(){return this._highlightsSaturation},set:function(e){this._highlightsSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"highlightsExposure",{get:function(){return this._highlightsExposure},set:function(e){this._highlightsExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"midtonesHue",{get:function(){return this._midtonesHue},set:function(e){this._midtonesHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"midtonesDensity",{get:function(){return this._midtonesDensity},set:function(e){this._midtonesDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"midtonesSaturation",{get:function(){return this._midtonesSaturation},set:function(e){this._midtonesSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"midtonesExposure",{get:function(){return this._midtonesExposure},set:function(e){this._midtonesExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shadowsHue",{get:function(){return this._shadowsHue},set:function(e){this._shadowsHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shadowsDensity",{get:function(){return this._shadowsDensity},set:function(e){this._shadowsDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shadowsSaturation",{get:function(){return this._shadowsSaturation},set:function(e){this._shadowsSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shadowsExposure",{get:function(){return this._shadowsExposure},set:function(e){this._shadowsExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"ColorCurves"},e.Bind=function(e,t,i,r,n){void 0===i&&(i="vCameraColorCurvePositive"),void 0===r&&(r="vCameraColorCurveNeutral"),void 0===n&&(n="vCameraColorCurveNegative"),e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(r,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(n,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))},e.PrepareUniforms=function(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")},e.prototype._getColorGradingDataToRef=function(t,i,r,n,s){null!=t&&(t=e._Clamp(t,0,360),i=e._Clamp(i,-100,100),r=e._Clamp(r,-100,100),n=e._Clamp(n,-100,100),i=e._ApplyColorGradingSliderNonlinear(i),i*=.5,n=e._ApplyColorGradingSliderNonlinear(n),i<0&&(i*=-1,t=(t+180)%360),e._FromHSBToRef(t,i,50+.25*n,s),s.scaleToRef(2,s),s.a=1+.01*r)},e._ApplyColorGradingSliderNonlinear=function(e){e/=100;var t=Math.abs(e);t=Math.pow(t,2);return e<0&&(t*=-1),100*t},e._FromHSBToRef=function(t,i,r,n){t=e._Clamp(t,0,360),i=e._Clamp(i/100,0,1);var s=e._Clamp(r/100,0,1);if(0===i)n.r=s,n.g=s,n.b=s;else{var o=s*(1-i),a=s*(1-i*(t=(t/=60)-(r=Math.floor(t)))),h=s*(1-i*(1-t));switch(r){case 0:n.r=s,n.g=h,n.b=o;break;case 1:n.r=a,n.g=s,n.b=o;break;case 2:n.r=o,n.g=s,n.b=h;break;case 3:n.r=o,n.g=a,n.b=s;break;case 4:n.r=h,n.g=o,n.b=s;break;default:n.r=s,n.g=o,n.b=a}}n.a=1},e._Clamp=function(e,t,i){return Math.min(Math.max(e,t),i)},e.prototype.clone=function(){return Ii.Clone((function(){return new e}),this)},e.prototype.serialize=function(){return Ii.Serialize(this)},e.Parse=function(t){return Ii.Parse((function(){return new e}),t,null,null)},y([vi()],e.prototype,"_globalHue",void 0),y([vi()],e.prototype,"_globalDensity",void 0),y([vi()],e.prototype,"_globalSaturation",void 0),y([vi()],e.prototype,"_globalExposure",void 0),y([vi()],e.prototype,"_highlightsHue",void 0),y([vi()],e.prototype,"_highlightsDensity",void 0),y([vi()],e.prototype,"_highlightsSaturation",void 0),y([vi()],e.prototype,"_highlightsExposure",void 0),y([vi()],e.prototype,"_midtonesHue",void 0),y([vi()],e.prototype,"_midtonesDensity",void 0),y([vi()],e.prototype,"_midtonesSaturation",void 0),y([vi()],e.prototype,"_midtonesExposure",void 0),e}(),Li=(Ii._ColorCurvesParser=Di.Parse,c((function(){var e=Oi.call(this)||this;return e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.EXPOSURE=!1,e.SKIPFINALCOLORCLAMP=!1,e.rebuild(),e}),Oi=Fi),function(){function e(){this.colorCurves=new Di,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=e.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCentreX=0,this.vignetteCentreY=0,this.vignetteWeight=1.5,this.vignetteColor=new pi(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=e.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new Ce}return Object.defineProperty(e.prototype,"colorCurvesEnabled",{get:function(){return this._colorCurvesEnabled},set:function(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"colorGradingTexture",{get:function(){return this._colorGradingTexture},set:function(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"colorGradingEnabled",{get:function(){return this._colorGradingEnabled},set:function(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"colorGradingWithGreenDepth",{get:function(){return this._colorGradingWithGreenDepth},set:function(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"colorGradingBGR",{get:function(){return this._colorGradingBGR},set:function(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"exposure",{get:function(){return this._exposure},set:function(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"toneMappingEnabled",{get:function(){return this._toneMappingEnabled},set:function(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"toneMappingType",{get:function(){return this._toneMappingType},set:function(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"contrast",{get:function(){return this._contrast},set:function(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vignetteBlendMode",{get:function(){return this._vignetteBlendMode},set:function(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vignetteEnabled",{get:function(){return this._vignetteEnabled},set:function(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"skipFinalColorClamp",{get:function(){return this._skipFinalColorClamp},set:function(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"applyByPostProcess",{get:function(){return this._applyByPostProcess},set:function(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),e.prototype._updateParameters=function(){this.onUpdateParameters.notifyObservers(this)},e.prototype.getClassName=function(){return"ImageProcessingConfiguration"},e.PrepareUniforms=function(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),t.VIGNETTE&&(e.push("vInverseScreenSize"),e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&Di.PrepareUniforms(e)},e.PrepareSamplers=function(e,t){t.COLORGRADING&&e.push("txColorTransform")},e.prototype.prepareDefines=function(t,i){if((i=void 0!==i&&i)!==this.applyByPostProcess||!this._isEnabled)return t.VIGNETTE=!1,t.TONEMAPPING=!1,t.TONEMAPPING_ACES=!1,t.CONTRAST=!1,t.EXPOSURE=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.IMAGEPROCESSING=!1,t.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,void(t.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled);t.VIGNETTE=this.vignetteEnabled,t.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===e._VIGNETTEMODE_MULTIPLY,t.VIGNETTEBLENDMODEOPAQUE=!t.VIGNETTEBLENDMODEMULTIPLY,t.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType===e.TONEMAPPING_ACES?t.TONEMAPPING_ACES=!0:t.TONEMAPPING_ACES=!1,t.CONTRAST=1!==this.contrast,t.EXPOSURE=1!==this.exposure,t.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,t.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,t.COLORGRADING?t.COLORGRADING3D=this.colorGradingTexture.is3D:t.COLORGRADING3D=!1,t.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,t.SAMPLER3DBGRMAP=this.colorGradingBGR,t.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,t.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,t.IMAGEPROCESSING=t.VIGNETTE||t.TONEMAPPING||t.CONTRAST||t.EXPOSURE||t.COLORCURVES||t.COLORGRADING},e.prototype.isReady=function(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()},e.prototype.bind=function(e,t){var i,r;this._colorCurvesEnabled&&this.colorCurves&&Di.Bind(this.colorCurves,e),this._vignetteEnabled&&(r=1/e.getEngine().getRenderWidth(),i=1/e.getEngine().getRenderHeight(),e.setFloat2("vInverseScreenSize",r,i),t=null!=t?t:i/r,r=(i=Math.tan(.5*this.vignetteCameraFov))*t,t=Math.sqrt(r*i),r=Ht.Mix(r,t,this.vignetteStretch),i=Ht.Mix(i,t,this.vignetteStretch),e.setFloat4("vignetteSettings1",r,i,-r*this.vignetteCentreX,-i*this.vignetteCentreY),t=-2*this.vignetteWeight,e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,t)),e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture&&(e.setTexture("txColorTransform",this.colorGradingTexture),r=this.colorGradingTexture.getSize().height,e.setFloat4("colorTransformSettings",(r-1)/r,.5/r,r,this.colorGradingTexture.level))},e.prototype.clone=function(){return Ii.Clone((function(){return new e}),this)},e.prototype.serialize=function(){return Ii.Serialize(this)},e.Parse=function(t){return Ii.Parse((function(){return new e}),t,null,null)},Object.defineProperty(e,"VIGNETTEMODE_MULTIPLY",{get:function(){return this._VIGNETTEMODE_MULTIPLY},enumerable:!1,configurable:!0}),Object.defineProperty(e,"VIGNETTEMODE_OPAQUE",{get:function(){return this._VIGNETTEMODE_OPAQUE},enumerable:!1,configurable:!0}),e.TONEMAPPING_STANDARD=0,e.TONEMAPPING_ACES=1,e._VIGNETTEMODE_MULTIPLY=0,e._VIGNETTEMODE_OPAQUE=1,y([wi()],e.prototype,"colorCurves",void 0),y([vi()],e.prototype,"_colorCurvesEnabled",void 0),y([bi("colorGradingTexture")],e.prototype,"_colorGradingTexture",void 0),y([vi()],e.prototype,"_colorGradingEnabled",void 0),y([vi()],e.prototype,"_colorGradingWithGreenDepth",void 0),y([vi()],e.prototype,"_colorGradingBGR",void 0),y([vi()],e.prototype,"_exposure",void 0),y([vi()],e.prototype,"_toneMappingEnabled",void 0),y([vi()],e.prototype,"_toneMappingType",void 0),y([vi()],e.prototype,"_contrast",void 0),y([vi()],e.prototype,"vignetteStretch",void 0),y([vi()],e.prototype,"vignetteCentreX",void 0),y([vi()],e.prototype,"vignetteCentreY",void 0),y([vi()],e.prototype,"vignetteWeight",void 0),y([xi()],e.prototype,"vignetteColor",void 0),y([vi()],e.prototype,"vignetteCameraFov",void 0),y([vi()],e.prototype,"_vignetteBlendMode",void 0),y([vi()],e.prototype,"_vignetteEnabled",void 0),y([vi()],e.prototype,"_skipFinalColorClamp",void 0),y([vi()],e.prototype,"_applyByPostProcess",void 0),y([vi()],e.prototype,"_isEnabled",void 0),e}()),Bi=(Ii._ImageProcessingConfigurationParser=Li.Parse,Tt.prototype.createUniformBuffer=function(e){var t=this._gl.createBuffer();if(!t)throw new Error("Unable to create uniform buffer");return t=new gt(t),this.bindUniformBuffer(t),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t},Tt.prototype.createDynamicUniformBuffer=function(e){var t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic uniform buffer");return t=new gt(t),this.bindUniformBuffer(t),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t},Tt.prototype.updateUniformBuffer=function(e,t,i,r){this.bindUniformBuffer(e),void 0===i&&(i=0),void 0===r?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(i,i+r)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(i,i+r)),this.bindUniformBuffer(null)},Tt.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null)},Tt.prototype.bindUniformBufferBase=function(e,t,i){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e?e.underlyingResource:null)},Tt.prototype.bindUniformBlock=function(e,t,i){e=e.program,4294967295!==(t=this._gl.getUniformBlockIndex(e,t))&&this._gl.uniformBlockBinding(e,t,i)},function(){function e(e,t,i,r,n){void 0===n&&(n=!1),this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||n,this._dynamic=i,this._name=null!=r?r:"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform)}return Object.defineProperty(e.prototype,"useUbo",{get:function(){return!this._noUBO},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isSync",{get:function(){return!this._needSync},enumerable:!1,configurable:!0}),e.prototype.isDynamic=function(){return void 0!==this._dynamic},e.prototype.getData=function(){return this._bufferData},e.prototype.getBuffer=function(){return this._buffer},e.prototype._fillAlignment=function(e){if(e=e<=2?e:4,this._uniformLocationPointer%e!=0)for(var t=this._uniformLocationPointer,i=(this._uniformLocationPointer+=e-this._uniformLocationPointer%e,this._uniformLocationPointer-t),r=0;r<i;r++)this._data.push(0)},e.prototype.addUniform=function(e,t,i){if(void 0===i&&(i=0),!this._noUBO&&void 0===this._uniformLocations[e]){if(0<i){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},16==t?t*=i:t=t*i+(4-t)*i;for(var r=[],n=0;n<t;n++)r.push(0)}else{if(t instanceof Array)t=(r=t).length;else for(r=[],n=0;n<t;n++)r.push(0);this._fillAlignment(t)}for(this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t,n=0;n<t;n++)this._data.push(r[n]);this._needSync=!0}},e.prototype.addMatrix=function(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))},e.prototype.addFloat2=function(e,t,i){this.addUniform(e,[t,i])},e.prototype.addFloat3=function(e,t,i,r){this.addUniform(e,[t,i,r])},e.prototype.addColor3=function(e,t){t=[t.r,t.g,t.b],this.addUniform(e,t)},e.prototype.addColor4=function(e,t,i){t=[t.r,t.g,t.b,i],this.addUniform(e,t)},e.prototype.addVector3=function(e,t){t=[t.x,t.y,t.z],this.addUniform(e,t)},e.prototype.addMatrix3x3=function(e){this.addUniform(e,12)},e.prototype.addMatrix2x2=function(e){this.addUniform(e,8)},e.prototype.create=function(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)},e.prototype._rebuild=function(){!this._noUBO&&this._bufferData&&(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))},Object.defineProperty(e.prototype,"_numBuffers",{get:function(){return this._buffers.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_indexBuffer",{get:function(){return this._bufferIndex},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),e.prototype._buffersEqual=function(e,t){for(var i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0},e.prototype._copyBuffer=function(e,t){for(var i=0;i<e.length;++i)t[i]=e[i]},e.prototype.update=function(){if(!this._noUBO)if(this.bindUniformBuffer(),this._buffer)if(this._dynamic||this._needSync){if(this._buffers&&1<this._buffers.length&&this._buffers[this._bufferIndex][1]){if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1]))return this._needSync=!1,void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1])}this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(e._UpdatedUbosInFrame[this._name]||(e._UpdatedUbosInFrame[this._name]=0),e._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}else this._createBufferOnWrite=this._engine._features.trackUbosInFrame;else this.create()},e.prototype._createNewBuffer=function(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()},e.prototype._checkNewFrame=function(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&0<this._buffers.length?(this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)},e.prototype.updateUniform=function(e,t,i){this._checkNewFrame();var r=this._uniformLocations[e];if(void 0===r){if(this._buffer)return void Me.Error("Cannot add an uniform after UBO has been created.");this.addUniform(e,i),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(s=0;s<i;s++)this._bufferData[r+s]=t[s];else{for(var n=!1,s=0;s<i;s++)(16!==i||this._engine._features.uniformBufferHardCheckMatrix)&&this._bufferData[r+s]===Ht.FloatRound(t[s])||(n=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+s]=t[s]);this._needSync=this._needSync||n}},e.prototype.updateUniformArray=function(e,t,i){this._checkNewFrame();var r=this._uniformLocations[e];if(void 0===r)Me.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform.");else{this._buffer||this.create();var n=this._uniformArraySizes[e];if(this._dynamic)for(h=0;h<i;h++)this._bufferData[r+h]=t[h];else{for(var s=!1,o=0,a=0,h=0;h<i;h++)if(this._bufferData[r+4*a+o]!==Ht.FloatRound(t[h])&&(s=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+4*a+o]=t[h]),++o===n.strideSize){for(;o<4;o++)this._bufferData[r+4*a+o]=0;o=0,a++}this._needSync=this._needSync||s}}},e.prototype._cacheMatrix=function(e,t){this._checkNewFrame();var i=this._valueCache[e];t=t.updateFlag;return(void 0===i||i!==t)&&(this._valueCache[e]=t,!0)},e.prototype._updateMatrix3x3ForUniform=function(t,i){for(var r=0;r<3;r++)e._TempBuffer[4*r]=i[3*r],e._TempBuffer[4*r+1]=i[3*r+1],e._TempBuffer[4*r+2]=i[3*r+2],e._TempBuffer[4*r+3]=0;this.updateUniform(t,e._TempBuffer,12)},e.prototype._updateMatrix3x3ForEffect=function(e,t){this._currentEffect.setMatrix3x3(e,t)},e.prototype._updateMatrix2x2ForEffect=function(e,t){this._currentEffect.setMatrix2x2(e,t)},e.prototype._updateMatrix2x2ForUniform=function(t,i){for(var r=0;r<2;r++)e._TempBuffer[4*r]=i[2*r],e._TempBuffer[4*r+1]=i[2*r+1],e._TempBuffer[4*r+2]=0,e._TempBuffer[4*r+3]=0;this.updateUniform(t,e._TempBuffer,8)},e.prototype._updateFloatForEffect=function(e,t){this._currentEffect.setFloat(e,t)},e.prototype._updateFloatForUniform=function(t,i){e._TempBuffer[0]=i,this.updateUniform(t,e._TempBuffer,1)},e.prototype._updateFloat2ForEffect=function(e,t,i,r){this._currentEffect.setFloat2(e+(r=void 0===r?"":r),t,i)},e.prototype._updateFloat2ForUniform=function(t,i,r){e._TempBuffer[0]=i,e._TempBuffer[1]=r,this.updateUniform(t,e._TempBuffer,2)},e.prototype._updateFloat3ForEffect=function(e,t,i,r,n){this._currentEffect.setFloat3(e+(n=void 0===n?"":n),t,i,r)},e.prototype._updateFloat3ForUniform=function(t,i,r,n){e._TempBuffer[0]=i,e._TempBuffer[1]=r,e._TempBuffer[2]=n,this.updateUniform(t,e._TempBuffer,3)},e.prototype._updateFloat4ForEffect=function(e,t,i,r,n,s){this._currentEffect.setFloat4(e+(s=void 0===s?"":s),t,i,r,n)},e.prototype._updateFloat4ForUniform=function(t,i,r,n,s){e._TempBuffer[0]=i,e._TempBuffer[1]=r,e._TempBuffer[2]=n,e._TempBuffer[3]=s,this.updateUniform(t,e._TempBuffer,4)},e.prototype._updateFloatArrayForEffect=function(e,t){this._currentEffect.setFloatArray(e,t)},e.prototype._updateFloatArrayForUniform=function(e,t){this.updateUniformArray(e,t,t.length)},e.prototype._updateArrayForEffect=function(e,t){this._currentEffect.setArray(e,t)},e.prototype._updateArrayForUniform=function(e,t){this.updateUniformArray(e,t,t.length)},e.prototype._updateIntArrayForEffect=function(e,t){this._currentEffect.setIntArray(e,t)},e.prototype._updateIntArrayForUniform=function(t,i){e._TempBufferInt32View.set(i),this.updateUniformArray(t,e._TempBuffer,i.length)},e.prototype._updateMatrixForEffect=function(e,t){this._currentEffect.setMatrix(e,t)},e.prototype._updateMatrixForUniform=function(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)},e.prototype._updateMatricesForEffect=function(e,t){this._currentEffect.setMatrices(e,t)},e.prototype._updateMatricesForUniform=function(e,t){this.updateUniform(e,t,t.length)},e.prototype._updateVector3ForEffect=function(e,t){this._currentEffect.setVector3(e,t)},e.prototype._updateVector3ForUniform=function(t,i){e._TempBuffer[0]=i.x,e._TempBuffer[1]=i.y,e._TempBuffer[2]=i.z,this.updateUniform(t,e._TempBuffer,3)},e.prototype._updateVector4ForEffect=function(e,t){this._currentEffect.setVector4(e,t)},e.prototype._updateVector4ForUniform=function(t,i){e._TempBuffer[0]=i.x,e._TempBuffer[1]=i.y,e._TempBuffer[2]=i.z,e._TempBuffer[3]=i.w,this.updateUniform(t,e._TempBuffer,4)},e.prototype._updateColor3ForEffect=function(e,t,i){this._currentEffect.setColor3(e+(i=void 0===i?"":i),t)},e.prototype._updateColor3ForUniform=function(t,i){e._TempBuffer[0]=i.r,e._TempBuffer[1]=i.g,e._TempBuffer[2]=i.b,this.updateUniform(t,e._TempBuffer,3)},e.prototype._updateColor4ForEffect=function(e,t,i,r){this._currentEffect.setColor4(e+(r=void 0===r?"":r),t,i)},e.prototype._updateDirectColor4ForEffect=function(e,t,i){this._currentEffect.setDirectColor4(e+(i=void 0===i?"":i),t)},e.prototype._updateColor4ForUniform=function(t,i,r){e._TempBuffer[0]=i.r,e._TempBuffer[1]=i.g,e._TempBuffer[2]=i.b,e._TempBuffer[3]=r,this.updateUniform(t,e._TempBuffer,4)},e.prototype._updateDirectColor4ForUniform=function(t,i){e._TempBuffer[0]=i.r,e._TempBuffer[1]=i.g,e._TempBuffer[2]=i.b,e._TempBuffer[3]=i.a,this.updateUniform(t,e._TempBuffer,4)},e.prototype._updateIntForEffect=function(e,t,i){this._currentEffect.setInt(e+(i=void 0===i?"":i),t)},e.prototype._updateIntForUniform=function(t,i){e._TempBufferInt32View[0]=i,this.updateUniform(t,e._TempBuffer,1)},e.prototype._updateInt2ForEffect=function(e,t,i,r){this._currentEffect.setInt2(e+(r=void 0===r?"":r),t,i)},e.prototype._updateInt2ForUniform=function(t,i,r){e._TempBufferInt32View[0]=i,e._TempBufferInt32View[1]=r,this.updateUniform(t,e._TempBuffer,2)},e.prototype._updateInt3ForEffect=function(e,t,i,r,n){this._currentEffect.setInt3(e+(n=void 0===n?"":n),t,i,r)},e.prototype._updateInt3ForUniform=function(t,i,r,n){e._TempBufferInt32View[0]=i,e._TempBufferInt32View[1]=r,e._TempBufferInt32View[2]=n,this.updateUniform(t,e._TempBuffer,3)},e.prototype._updateInt4ForEffect=function(e,t,i,r,n,s){this._currentEffect.setInt4(e+(s=void 0===s?"":s),t,i,r,n)},e.prototype._updateInt4ForUniform=function(t,i,r,n,s){e._TempBufferInt32View[0]=i,e._TempBufferInt32View[1]=r,e._TempBufferInt32View[2]=n,e._TempBufferInt32View[3]=s,this.updateUniform(t,e._TempBuffer,4)},e.prototype.setTexture=function(e,t){this._currentEffect.setTexture(e,t)},e.prototype.updateUniformDirectly=function(e,t){this.updateUniform(e,t,t.length),this.update()},e.prototype.bindToEffect=function(e,t){this._currentEffect=e,this._currentEffectName=t},e.prototype.bindUniformBuffer=function(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)},e.prototype.unbindEffect=function(){this._currentEffect=void 0,this._currentEffectName=void 0},e.prototype.setDataBuffer=function(e){if(!this._buffers)return this._buffer===e;for(var t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,!(this._currentEffect=void 0);return!1},e.prototype.dispose=function(){if(!this._noUBO){var e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(var i=0;i<this._buffers.length;++i){var r=this._buffers[i][0];this._engine._releaseBuffer(r)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}},e._UpdatedUbosInFrame={},e._MAX_UNIFORM_SIZE=256,e._TempBuffer=new Float32Array(e._MAX_UNIFORM_SIZE),e._TempBufferInt32View=new Uint32Array(e._TempBuffer.buffer),e}()),Ni=function(){function e(e,t,i,r,n,s,o,a){void 0===r&&(r=0),void 0===n&&(n=!1),void 0===s&&(s=!1),void 0===o&&(o=!1),this._isAlreadyOwned=!1,e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=s,this._divisor=a||1,t instanceof ft?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?r:r*Float32Array.BYTES_PER_ELEMENT,n||this.create()}return e.prototype.createVertexBuffer=function(e,t,i,r,n,s,o){return t=(s=void 0!==s&&s)?t:t*Float32Array.BYTES_PER_ELEMENT,s=r?s?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride,new ki(this._engine,this,e,this._updatable,!0,s,void 0===n?this._instanced:n,t,i,void 0,void 0,!0,this._divisor||o)},e.prototype.isUpdatable=function(){return this._updatable},e.prototype.getData=function(){return this._data},e.prototype.getBuffer=function(){return this._buffer},e.prototype.getStrideSize=function(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT},e.prototype.create=function(e){!(e=void 0===e?null:e)&&this._buffer||(e=e||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e))},e.prototype._rebuild=function(){this._buffer=null,this.create(this._data)},e.prototype.update=function(e){this.create(e)},e.prototype.updateDirectly=function(e,t,i,r){void 0===r&&(r=!1),this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),this._data=0===t&&void 0===i?e:null)},e.prototype._increaseReferences=function(){this._buffer&&(this._isAlreadyOwned?this._buffer.references++:this._isAlreadyOwned=!0)},e.prototype.dispose=function(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)},e}(),ki=function(){function e(t,i,r,n,s,o,a,h,l,c,u,d,p,_){void 0===u&&(u=!1),void 0===d&&(d=!1),void 0===p&&(p=1),void 0===_&&(_=!1),i instanceof Ni?(this._buffer=i,this._ownsBuffer=_):(this._buffer=new Ni(t,i,n,o,s,a,d),this._ownsBuffer=!0),this.uniqueId=e._Counter++,this._kind=r,null==c?(_=this.getData(),this.type=e.FLOAT,_ instanceof Int8Array?this.type=e.BYTE:_ instanceof Uint8Array?this.type=e.UNSIGNED_BYTE:_ instanceof Int16Array?this.type=e.SHORT:_ instanceof Uint16Array?this.type=e.UNSIGNED_SHORT:_ instanceof Int32Array?this.type=e.INT:_ instanceof Uint32Array&&(this.type=e.UNSIGNED_INT)):this.type=c,t=e.GetTypeByteLength(this.type),d?(this._size=l||(o?o/t:e.DeduceStride(r)),this.byteStride=o||this._buffer.byteStride||this._size*t,this.byteOffset=h||0):(this._size=l||o||e.DeduceStride(r),this.byteStride=o?o*t:this._buffer.byteStride||this._size*t,this.byteOffset=(h||0)*t),this.normalized=u,this._instanced=void 0!==a&&a,this._instanceDivisor=a?p:0,this._computeHashCode()}return Object.defineProperty(e.prototype,"instanceDivisor",{get:function(){return this._instanceDivisor},set:function(e){this._instanceDivisor=e,this._instanced=0!=e,this._computeHashCode()},enumerable:!1,configurable:!0}),e.prototype._computeHashCode=function(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)},e.prototype._rebuild=function(){this._buffer&&this._buffer._rebuild()},e.prototype.getKind=function(){return this._kind},e.prototype.isUpdatable=function(){return this._buffer.isUpdatable()},e.prototype.getData=function(){return this._buffer.getData()},e.prototype.getFloatData=function(t,i){var r=this.getData();if(!r)return null;var n,s=this.getSize()*e.GetTypeByteLength(this.type);t*=this.getSize();if(this.type!==e.FLOAT||this.byteStride!==s)return n=new Float32Array(t),this.forEach(t,(function(e,t){return n[t]=e})),n;if((r instanceof Array||r instanceof Float32Array)&&0===this.byteOffset&&r.length===t)return i?r.slice():r;if(r instanceof Array)return o=this.byteOffset/4,r.slice(o,o+t);if(r instanceof ArrayBuffer)return new Float32Array(r,this.byteOffset,t);var o=r.byteOffset+this.byteOffset;return i?(s=new Float32Array(t),i=new Float32Array(r.buffer,o,t),s.set(i),s):((i=o%4)&&(o=Math.max(0,o-i)),new Float32Array(r.buffer,o,t))},e.prototype.getBuffer=function(){return this._buffer.getBuffer()},e.prototype.getStrideSize=function(){return this.byteStride/e.GetTypeByteLength(this.type)},e.prototype.getOffset=function(){return this.byteOffset/e.GetTypeByteLength(this.type)},e.prototype.getSize=function(t){return(t=void 0!==t&&t)?this._size*e.GetTypeByteLength(this.type):this._size},e.prototype.getIsInstanced=function(){return this._instanced},e.prototype.getInstanceDivisor=function(){return this._instanceDivisor},e.prototype.create=function(e){this._buffer.create(e)},e.prototype.update=function(e){this._buffer.update(e)},e.prototype.updateDirectly=function(e,t,i){this._buffer.updateDirectly(e,t,void 0,i=void 0!==i&&i)},e.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose()},e.prototype.forEach=function(t,i){e.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,t,this.normalized,i)},e.DeduceStride=function(t){switch(t){case e.UVKind:case e.UV2Kind:case e.UV3Kind:case e.UV4Kind:case e.UV5Kind:case e.UV6Kind:return 2;case e.NormalKind:case e.PositionKind:return 3;case e.ColorKind:case e.MatricesIndicesKind:case e.MatricesIndicesExtraKind:case e.MatricesWeightsKind:case e.MatricesWeightsExtraKind:case e.TangentKind:return 4;default:throw new Error("Invalid kind '"+t+"'")}},e.GetTypeByteLength=function(t){switch(t){case e.BYTE:case e.UNSIGNED_BYTE:return 1;case e.SHORT:case e.UNSIGNED_SHORT:return 2;case e.INT:case e.UNSIGNED_INT:case e.FLOAT:return 4;default:throw new Error("Invalid type '".concat(t,"'"))}},e.ForEach=function(t,i,r,n,s,o,a,h){if(t instanceof Array)for(var l=i/4,c=r/4,u=0;u<o;u+=n){for(var d=0;d<n;d++)h(t[l+d],u+d);l+=c}else{var p=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),_=e.GetTypeByteLength(s);for(u=0;u<o;u+=n){var f=i;for(d=0;d<n;d++)h(e._GetFloatValue(p,s,f,a),u+d),f+=_;i+=r}}},e._GetFloatValue=function(t,i,r,n){switch(i){case e.BYTE:var s=t.getInt8(r);return n?Math.max(s/127,-1):s;case e.UNSIGNED_BYTE:return s=t.getUint8(r),n&&(s/=255),s;case e.SHORT:return s=t.getInt16(r,!0),n?Math.max(s/32767,-1):s;case e.UNSIGNED_SHORT:return s=t.getUint16(r,!0),n&&(s/=65535),s;case e.INT:return t.getInt32(r,!0);case e.UNSIGNED_INT:return t.getUint32(r,!0);case e.FLOAT:return t.getFloat32(r,!0);default:throw new Error("Invalid component type ".concat(i))}},e._Counter=0,e.BYTE=5120,e.UNSIGNED_BYTE=5121,e.SHORT=5122,e.UNSIGNED_SHORT=5123,e.INT=5124,e.UNSIGNED_INT=5125,e.FLOAT=5126,e.PositionKind="position",e.NormalKind="normal",e.TangentKind="tangent",e.UVKind="uv",e.UV2Kind="uv2",e.UV3Kind="uv3",e.UV4Kind="uv4",e.UV5Kind="uv5",e.UV6Kind="uv6",e.ColorKind="color",e.ColorInstanceKind="instanceColor",e.MatricesIndicesKind="matricesIndices",e.MatricesWeightsKind="matricesWeights",e.MatricesIndicesExtraKind="matricesIndicesExtra",e.MatricesWeightsExtraKind="matricesWeightsExtra",e}(),Ui=function(){function e(){this._pickingUnavailable=!1,this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}return e.prototype.getNormal=function(e,t){if(void 0===e&&(e=!1),void 0===t&&(t=!0),!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(ki.NormalKind))return null;var i,r,n=this.pickedMesh.getIndices();return n?(i=t?(t=this.pickedMesh.getVerticesData(ki.NormalKind),i=ni.FromArray(t,3*n[3*this.faceId]),r=ni.FromArray(t,3*n[3*this.faceId+1]),t=ni.FromArray(t,3*n[3*this.faceId+2]),i=i.scale(this.bu),r=r.scale(this.bv),t=t.scale(1-this.bu-this.bv),new ni(i.x+r.x+t.x,i.y+r.y+t.y,i.z+r.z+t.z)):(i=this.pickedMesh.getVerticesData(ki.PositionKind),r=ni.FromArray(i,3*n[3*this.faceId]),t=ni.FromArray(i,3*n[3*this.faceId+1]),i=ni.FromArray(i,3*n[3*this.faceId+2]),n=r.subtract(t),r=i.subtract(t),ni.Cross(n,r)),e&&(t=this.pickedMesh.getWorldMatrix(),this.pickedMesh.nonUniformScaling&&(li.Matrix[0].copyFrom(t),(t=li.Matrix[0]).setTranslationFromFloats(0,0,0),t.invert(),t.transposeToRef(li.Matrix[1]),t=li.Matrix[1]),i=ni.TransformNormal(i,t)),i.normalize(),i):null},e.prototype.getTextureCoordinates=function(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(ki.UVKind))return null;var e=this.pickedMesh.getIndices();if(!e)return null;if(!(r=this.pickedMesh.getVerticesData(ki.UVKind)))return null;var t=ri.FromArray(r,2*e[3*this.faceId]),i=ri.FromArray(r,2*e[3*this.faceId+1]),r=ri.FromArray(r,2*e[3*this.faceId+2]);t=t.scale(this.bu),i=i.scale(this.bv),r=r.scale(1-this.bu-this.bv);return new ri(t.x+i.x+r.x,t.y+i.y+r.y)},e}(),zi=function(){function e(e,t,i,r,n,s){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=r,this.sourceEvent=n,this.additionalData=s}return e.CreateNew=function(t,i,r){var n=t.getScene();return new e(t,n.pointerX,n.pointerY,n.meshUnderPointer||t,i,r)},e.CreateNewFromSprite=function(t,i,r,n){return new e(t,i.pointerX,i.pointerY,i.meshUnderPointer,r,n)},e.CreateNewFromScene=function(t,i){return new e(null,t.pointerX,t.pointerY,t.meshUnderPointer,i)},e.CreateNewFromPrimitive=function(t,i,r,n){return new e(t,i.x,i.y,null,r,n)},e}(),Gi=function(){function e(e){this._vertexBuffers={},this._scene=e}return e.prototype._prepareBuffers=function(){var e;this._vertexBuffers[ki.PositionKind]||((e=[]).push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[ki.PositionKind]=new ki(this._scene.getEngine(),e,ki.PositionKind,!1,!1,2),this._buildIndexBuffer())},e.prototype._buildIndexBuffer=function(){var e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)},e.prototype._rebuild=function(){var e=this._vertexBuffers[ki.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())},e.prototype._prepareFrame=function(e,t){void 0===e&&(e=null);var i=this._scene.activeCamera;return!(!i||!(t=(t=void 0===t?null:t)||i._postProcesses.filter((function(e){return null!=e})))||0===t.length||!this._scene.postProcessesEnabled||(t[0].activate(i,e,null!=t),0))},e.prototype.directRender=function(e,t,i,r,n,s){void 0===t&&(t=null),void 0===i&&(i=!1),void 0===r&&(r=0),void 0===n&&(n=0),void 0===s&&(s=!1);for(var o=this._scene.getEngine(),a=0;a<e.length;a++){a<e.length-1?e[a+1].activate(this._scene.activeCamera,null==t?void 0:t.texture):(t?o.bindFramebuffer(t,r,void 0,void 0,i,n):s||o.restoreDefaultFramebuffer(),null!=(h=o._debugInsertMarker)&&h.call(o,"post process ".concat(e[a].name," output")));var h=e[a],l=h.apply();l&&(h.onBeforeRenderObservable.notifyObservers(l),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,l),o.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(l))}o.setDepthBuffer(!0),o.setDepthWrite(!0)},e.prototype._finalizeFrame=function(e,t,i,r,n){void 0===n&&(n=!1);var s=this._scene.activeCamera;if(s&&0!==(r=r||s._postProcesses.filter((function(e){return null!=e}))).length&&this._scene.postProcessesEnabled){for(var o=this._scene.getEngine(),a=0,h=r.length;a<h;a++){var l=r[a];if(a<h-1?l._outputTexture=r[a+1].activate(s,null==t?void 0:t.texture):(t?(o.bindFramebuffer(t,i,void 0,void 0,n),l._outputTexture=t):(o.restoreDefaultFramebuffer(),l._outputTexture=null),null!=(c=o._debugInsertMarker)&&c.call(o,"post process ".concat(r[a].name," output"))),e)break;var c=l.apply();c&&(l.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,c),o.drawElementsType(0,0,6),l.onAfterRenderObservable.notifyObservers(c))}o.setDepthBuffer(!0),o.setDepthWrite(!0),o.setAlphaMode(0)}},e.prototype.dispose=function(){var e=this._vertexBuffers[ki.PositionKind];e&&(e.dispose(),this._vertexBuffers[ki.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)},e}(),Vi=function(){function e(e,t,i,r,n){void 0===i&&(i=null),void 0===r&&(r=null),void 0===n&&(n=null),this.index=e,this._opaqueSubMeshes=new Kt(256),this._transparentSubMeshes=new Kt(256),this._alphaTestSubMeshes=new Kt(256),this._depthOnlySubMeshes=new Kt(256),this._particleSystems=new Kt(256),this._spriteManagers=new Kt(256),this._empty=!0,this._edgesRenderers=new Xt(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=n}return Object.defineProperty(e.prototype,"opaqueSortCompareFn",{set:function(t){this._opaqueSortCompareFn=t||e.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"alphaTestSortCompareFn",{set:function(t){this._alphaTestSortCompareFn=t||e.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"transparentSortCompareFn",{set:function(t){this._transparentSortCompareFn=t||e.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted},enumerable:!1,configurable:!0}),e.prototype.render=function(e,t,i,r){if(e)e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);else{e=this._scene.getEngine();var n=(0!==this._depthOnlySubMeshes.length&&(e.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),e.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes),e.getStencilBuffer());if(e.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0===this._transparentSubMeshes.length&&!this._scene.useOrderIndependentTransparency||(e.setStencilBuffer(n),this._scene.useOrderIndependentTransparency?(t=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes)).length&&this._renderTransparent(t):this._renderTransparent(this._transparentSubMeshes),e.setAlphaMode(0)),e.setStencilBuffer(!1),this._edgesRenderers.length){for(var s=0;s<this._edgesRenderers.length;s++)this._edgesRenderers.data[s].render();e.setAlphaMode(0)}e.setStencilBuffer(n)}},e.prototype._renderOpaqueSorted=function(t){return e._RenderSorted(t,this._opaqueSortCompareFn,this._scene.activeCamera,!1)},e.prototype._renderAlphaTestSorted=function(t){return e._RenderSorted(t,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)},e.prototype._renderTransparentSorted=function(t){return e._RenderSorted(t,this._transparentSortCompareFn,this._scene.activeCamera,!0)},e._RenderSorted=function(t,i,r,n){var s=0,o=r?r.globalPosition:e._ZeroVector;if(n)for(;s<t.length;s++)(c=t.data[s])._alphaIndex=c.getMesh().alphaIndex,c._distanceToCamera=ni.Distance(c.getBoundingInfo().boundingSphere.centerWorld,o);var a=t.length===t.data.length?t.data:t.data.slice(0,t.length),h=(i&&a.sort(i),a[0].getMesh().getScene());for(s=0;s<a.length;s++){var l,c=a[s];h._activeMeshesFrozenButKeepClipping&&!c.isInFrustum(h._frustumPlanes)||(n&&(l=c.getMaterial())&&l.needDepthPrePass&&((l=l.getScene().getEngine()).setColorWrite(!1),l.setAlphaMode(0),c.render(!1),l.setColorWrite(!0)),c.render(n))}},e.defaultTransparentSortCompare=function(t,i){return t._alphaIndex>i._alphaIndex?1:t._alphaIndex<i._alphaIndex?-1:e.backToFrontSortCompare(t,i)},e.backToFrontSortCompare=function(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0},e.frontToBackSortCompare=function(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0},e.PainterSortCompare=function(e,t){return e=e.getMesh(),t=t.getMesh(),e.material&&t.material?e.material.uniqueId-t.material.uniqueId:e.uniqueId-t.uniqueId},e.prototype.prepare=function(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this._spriteManagers.reset(),this._edgesRenderers.reset(),this._empty=!0},e.prototype.dispose=function(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()},e.prototype.dispatch=function(e,t,i){void 0===t&&(t=e.getMesh()),null!=(i=void 0===i?e.getMaterial():i)&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)},e.prototype.dispatchSprites=function(e){this._spriteManagers.push(e),this._empty=!1},e.prototype.dispatchParticles=function(e){this._particleSystems.push(e),this._empty=!1},e.prototype._renderParticles=function(e){if(0!==this._particleSystems.length){var t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(var i=0;i<this._particleSystems.length;i++){var r,n=this._particleSystems.data[i];0!==(t&&t.layerMask&n.layerMask)&&((r=n.emitter).position&&e&&-1===e.indexOf(r)||this._scene._activeParticles.addCount(n.render(),!1))}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}},e.prototype._renderSprites=function(){if(this._scene.spritesEnabled&&0!==this._spriteManagers.length){var e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(var t=0;t<this._spriteManagers.length;t++){var i=this._spriteManagers.data[t];0!==(e&&e.layerMask&i.layerMask)&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}},e._ZeroVector=ni.Zero(),e}(),ji=function(){},Wi=function(){function e(t){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new ji,this._scene=t;for(var i=e.MIN_RENDERINGGROUPS;i<e.MAX_RENDERINGGROUPS;i++)this._autoClearDepthStencil[i]={autoClear:!0,depth:!0,stencil:!0}}return e.prototype._clearDepthStencilBuffer=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!0),this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)},e.prototype.render=function(t,i,r,n){var s=this._renderingGroupInfo;if(s.scene=this._scene,s.camera=this._scene.activeCamera,this._scene.spriteManagers&&n)for(var o=0;o<this._scene.spriteManagers.length;o++){var a=this._scene.spriteManagers[o];this.dispatchSprites(a)}for(o=e.MIN_RENDERINGGROUPS;o<e.MAX_RENDERINGGROUPS;o++){this._depthStencilBufferAlreadyCleaned=o===e.MIN_RENDERINGGROUPS;var h=this._renderingGroups[o];if(h&&!h._empty){var l,c=Math.pow(2,o);s.renderingGroupId=o,this._scene.onBeforeRenderingGroupObservable.notifyObservers(s,c),!e.AUTOCLEAR||(l=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(o):this._autoClearDepthStencil[o])&&l.autoClear&&this._clearDepthStencilBuffer(l.depth,l.stencil);for(var u=0,d=this._scene._beforeRenderingGroupDrawStage;u<d.length;u++)d[u].action(o);h.render(t,n,r,i);for(var p=0,_=this._scene._afterRenderingGroupDrawStage;p<_.length;p++)_[p].action(o);this._scene.onAfterRenderingGroupObservable.notifyObservers(s,c)}}},e.prototype.reset=function(){for(var t=e.MIN_RENDERINGGROUPS;t<e.MAX_RENDERINGGROUPS;t++){var i=this._renderingGroups[t];i&&i.prepare()}},e.prototype.dispose=function(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null},e.prototype.freeRenderingGroups=function(){for(var t=e.MIN_RENDERINGGROUPS;t<e.MAX_RENDERINGGROUPS;t++){var i=this._renderingGroups[t];i&&i.dispose()}},e.prototype._prepareRenderingGroup=function(e){void 0===this._renderingGroups[e]&&(this._renderingGroups[e]=new Vi(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))},e.prototype.dispatchSprites=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t),this._renderingGroups[t].dispatchSprites(e)},e.prototype.dispatchParticles=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t),this._renderingGroups[t].dispatchParticles(e)},e.prototype.dispatch=function(e,t,i){var r=(t=void 0===t?e.getMesh():t).renderingGroupId||0;this._prepareRenderingGroup(r),this._renderingGroups[r].dispatch(e,t,i)},e.prototype.setRenderingOrder=function(e,t,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this._customOpaqueSortCompareFn[e]=t=void 0===t?null:t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=r,this._renderingGroups[e]&&((t=this._renderingGroups[e]).opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],t.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],t.transparentSortCompareFn=this._customTransparentSortCompareFn[e])},e.prototype.setRenderingAutoClearDepthStencil=function(e,t,i,r){this._autoClearDepthStencil[e]={autoClear:t,depth:i=void 0===i||i,stencil:r=void 0===r||r}},e.prototype.getAutoClearDepthStencilSetup=function(e){return this._autoClearDepthStencil[e]},e.MAX_RENDERINGGROUPS=4,e.MIN_RENDERINGGROUPS=0,e.AUTOCLEAR=!0,e}(),Hi=function(e){function t(t){return e.apply(this,t)||this}return c(t,e),t.Create=function(){return Object.create(t.prototype)},t.prototype.registerStep=function(e,t,i){var r=0;for(Number.MAX_VALUE;r<this.length&&!(e<this[r].index);r++);this.splice(r,0,{index:e,component:t,action:i.bind(t)})},t.prototype.clear=function(){this.length=0},t}(Array),Ki=function(){function e(){}return e.POINTERDOWN=1,e.POINTERUP=2,e.POINTERMOVE=4,e.POINTERWHEEL=8,e.POINTERPICK=16,e.POINTERTAP=32,e.POINTERDOUBLETAP=64,e}(),Xi=function(e,t){this.type=e,this.event=t},qi=function(e){function t(t,i,r,n){return(t=e.call(this,t,i)||this).ray=null,t.skipOnPointerObservable=!1,t.localPosition=new ri(r,n),t}return c(t,e),t}(Xi),Yi=function(e){function t(t,i,r){return(t=e.call(this,t,i)||this).pickInfo=r,t}return c(t,e),t}(Xi),Zi=function(){function e(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}return Object.defineProperty(e,"HasTriggers",{get:function(){for(var t in e.Triggers)if(Object.prototype.hasOwnProperty.call(e.Triggers,t))return!0;return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e,"HasPickTriggers",{get:function(){for(var t in e.Triggers)if(Object.prototype.hasOwnProperty.call(e.Triggers,t)&&1<=(t=parseInt(t))&&t<=7)return!0;return!1},enumerable:!1,configurable:!0}),e.HasSpecificTrigger=function(t){for(var i in e.Triggers)if(Object.prototype.hasOwnProperty.call(e.Triggers,i)&&parseInt(i)===t)return!0;return!1},e.Triggers={},e}(),Qi=function(){function e(){}return e.KEYDOWN=1,e.KEYUP=2,e}(),Ji=function(e,t){this.type=e,this.event=t},$i=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.type=t,r.event=i,r.skipOnKeyboardObservable=!1,r}return c(t,e),Object.defineProperty(t.prototype,"skipOnPointerObservable",{get:function(){return this.skipOnKeyboardObservable},set:function(e){this.skipOnKeyboardObservable=e},enumerable:!1,configurable:!0}),t}(Ji),er=(function(e){e[e.Generic=0]="Generic",e[e.Keyboard=1]="Keyboard",e[e.Mouse=2]="Mouse",e[e.Touch=3]="Touch",e[e.DualShock=4]="DualShock",e[e.Xbox=5]="Xbox",e[e.Switch=6]="Switch",e[e.DualSense=7]="DualSense"}(Ti=Ti||{}),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.Move=12]="Move"}(Ci=Ci||{}),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.DeltaHorizontal=10]="DeltaHorizontal",e[e.DeltaVertical=11]="DeltaVertical"}(Ei=Ei||{}),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(Si=Si||{}),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Create=8]="Create",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(Pi=Pi||{}),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.LT=6]="LT",e[e.RT=7]="RT",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.LStickXAxis=17]="LStickXAxis",e[e.LStickYAxis=18]="LStickYAxis",e[e.RStickXAxis=19]="RStickXAxis",e[e.RStickYAxis=20]="RStickYAxis"}(Ri=Ri||{}),function(e){e[e.B=0]="B",e[e.A=1]="A",e[e.Y=2]="Y",e[e.X=3]="X",e[e.L=4]="L",e[e.R=5]="R",e[e.ZL=6]="ZL",e[e.ZR=7]="ZR",e[e.Minus=8]="Minus",e[e.Plus=9]="Plus",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.Capture=17]="Capture",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(Ai=Ai||{}),function(e){e[e.PointerMove=0]="PointerMove",e[e.PointerDown=1]="PointerDown",e[e.PointerUp=2]="PointerUp"}(Mi=Mi||{}),function(){function e(){}return e.DOM_DELTA_PIXEL=0,e.DOM_DELTA_LINE=1,e.DOM_DELTA_PAGE=2,e}()),tr=function(){function e(){}return e.CreateDeviceEvent=function(e,t,i,r,n,s){switch(e){case Ti.Keyboard:return this._CreateKeyboardEvent(i,r,n,s);case Ti.Mouse:if(i===Ci.MouseWheelX||i===Ci.MouseWheelY||i===Ci.MouseWheelZ)return this._CreateWheelEvent(e,t,i,r,n,s);case Ti.Touch:return this._CreatePointerEvent(e,t,i,r,n,s);default:throw"Unable to generate event for device ".concat(Ti[e])}},e._CreatePointerEvent=function(e,t,i,r,n,s){return n=this._CreateMouseEvent(e,t,i,r,n,s),e===Ti.Mouse?(n.deviceType=Ti.Mouse,n.pointerId=1,n.pointerType="mouse"):(n.deviceType=Ti.Touch,n.pointerId=t,n.pointerType="touch"),i===Ci.Move?n.type="pointermove":i>=Ci.LeftClick&&i<=Ci.RightClick&&(n.type=1===r?"pointerdown":"pointerup",n.button=i-2),n},e._CreateWheelEvent=function(e,t,i,r,n,s){var o=this._CreateMouseEvent(e,t,i,r,n,s);switch(o.type="wheel",o.deltaMode=er.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,i){case Ci.MouseWheelX:o.deltaX=r;break;case Ci.MouseWheelY:o.deltaY=r;break;case Ci.MouseWheelZ:o.deltaZ=r}return o},e._CreateMouseEvent=function(e,t,i,r,n,s){var o=this._CreateEvent(s),a=n.pollInput(e,t,Ci.Horizontal),h=n.pollInput(e,t,Ci.Vertical);return s?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-s.getBoundingClientRect().x,o.offsetY=o.movementY-s.getBoundingClientRect().y):(o.movementX=n.pollInput(e,t,Ei.DeltaHorizontal),o.movementY=n.pollInput(e,t,Ei.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,n),o.clientX=a,o.clientY=h,o.x=a,o.y=h,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o},e._CreateKeyboardEvent=function(e,t,i,r){return r=this._CreateEvent(r),this._CheckNonCharacterKeys(r,i),r.deviceType=Ti.Keyboard,r.deviceSlot=0,r.inputIndex=e,r.type=1===t?"keydown":"keyup",r.key=String.fromCharCode(e),r.keyCode=e,r},e._CheckNonCharacterKeys=function(e,t){var i=(s=t.isDeviceAvailable(Ti.Keyboard))&&1===t.pollInput(Ti.Keyboard,0,18),r=s&&1===t.pollInput(Ti.Keyboard,0,17),n=s&&(1===t.pollInput(Ti.Keyboard,0,91)||1===t.pollInput(Ti.Keyboard,0,92)||1===t.pollInput(Ti.Keyboard,0,93)),s=s&&1===t.pollInput(Ti.Keyboard,0,16);e.altKey=i,e.ctrlKey=r,e.metaKey=n,e.shiftKey=s},e._CreateEvent=function(e){var t={preventDefault:function(){}};return t.target=e,t},e}(),ir=function(){function e(e,t,i){var r=this;this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(function(e,t,n,s){n=tr.CreateDeviceEvent(e,t,n,s,r),i(e,t,n)})):this._createDummyNativeInput()}return e.prototype.pollInput=function(e,t,i){return this._nativeInput.pollInput(e,t,i)},e.prototype.isDeviceAvailable=function(e){return e===Ti.Mouse||e===Ti.Touch},e.prototype.dispose=function(){this._nativeInput.dispose()},e.prototype._createDummyNativeInput=function(){return{pollInput:function(){return 0},isDeviceAvailable:function(){return!1},dispose:function(){}}},e}(),rr=Object.keys(Ci).length/2,nr=function(){function e(e,t,i,r){var n=this;this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=Ht.IsSafari(),this._keyboardDownEvent=function(e){},this._keyboardUpEvent=function(e){},this._keyboardBlurEvent=function(e){},this._pointerMoveEvent=function(e){},this._pointerDownEvent=function(e){},this._pointerUpEvent=function(e){},this._pointerCancelEvent=function(e){},this._pointerWheelEvent=function(e){},this._pointerBlurEvent=function(e){},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Ae.IsNavigatorAvailable()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=function(e){},this._gamepadDisconnectedEvent=function(e){},this._eventPrefix=Ht.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=r,this._enableEvents(),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=function(){n._enableEvents()})}return e.prototype.pollInput=function(e,t,i){var r=this._inputs[e][t];if(!r)throw"Unable to find device ".concat(Ti[e]);if(e>=Ti.DualShock&&e<=Ti.DualSense&&navigator.getGamepads&&this._updateDevice(e,t,i),void 0===(r=r[i]))throw"Unable to find input ".concat(i," for device ").concat(Ti[e]," in slot ").concat(t);return i===Ci.Move&&Ht.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),r},e.prototype.isDeviceAvailable=function(e){return void 0!==this._inputs[e]},e.prototype.dispose=function(){this._onDeviceConnected=function(){},this._onDeviceDisconnected=function(){},this._onInputChanged=function(){},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()},e.prototype._enableEvents=function(){var e=null==this?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(var t=0,i=this._inputs;t<i.length;t++){var r=i[t];if(r)for(var n in r){var s=r[+n];if(s)for(var o=0;o<s.length;o++)s[o]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}},e.prototype._disableEvents=function(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1},e.prototype._checkForConnectedDevices=function(){if(navigator.getGamepads)for(var e=0,t=navigator.getGamepads();e<t.length;e++){var i=t[e];i&&this._addGamePad(i)}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(Ti.Mouse,0,0,0)},e.prototype._addGamePad=function(e){var t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t},e.prototype._addPointerDevice=function(e,t,i,r){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,rr),(e=this._inputs[e][t])[0]=i,e[1]=r},e.prototype._registerDevice=function(e,t,i){if(void 0===t)throw"Unable to register device ".concat(Ti[e]," to undefined slot.");if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){for(var r=new Array(i),n=0;n<i;n++)r[n]=0;this._inputs[e][t]=r,this._onDeviceConnected(e,t)}},e.prototype._unregisterDevice=function(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))},e.prototype._handleKeyActions=function(){var e=this;this._keyboardDownEvent=function(t){e._keyboardActive||(e._keyboardActive=!0,e._registerDevice(Ti.Keyboard,0,255));var i=e._inputs[Ti.Keyboard][0];i&&(i[t.keyCode]=1,(i=t).inputIndex=t.keyCode,e._onInputChanged(Ti.Keyboard,0,i))},this._keyboardUpEvent=function(t){e._keyboardActive||(e._keyboardActive=!0,e._registerDevice(Ti.Keyboard,0,255));var i=e._inputs[Ti.Keyboard][0];i&&(i[t.keyCode]=0,(i=t).inputIndex=t.keyCode,e._onInputChanged(Ti.Keyboard,0,i))},this._keyboardBlurEvent=function(){if(e._keyboardActive)for(var t,i=e._inputs[Ti.Keyboard][0],r=0;r<i.length;r++)0!==i[r]&&(i[r]=0,t=tr.CreateDeviceEvent(Ti.Keyboard,0,r,0,e,e._elementToAttachTo),e._onInputChanged(Ti.Keyboard,0,t))},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)},e.prototype._handlePointerActions=function(){var e=this;this._maxTouchPoints=Ae.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(var t=0;t<this._maxTouchPoints;t++)this._activeTouchIds[t]=-1;function i(){}this._pointerMoveEvent=function(t){var i,r=e._getPointerType(t),n=r===Ti.Mouse?0:e._activeTouchIds.indexOf(t.pointerId),s=(e._inputs[r]||(e._inputs[r]={}),e._inputs[r][n]||e._addPointerDevice(r,n,t.clientX,t.clientY),e._inputs[r][n]);s&&(s[Ci.Horizontal]=t.clientX,s[Ci.Vertical]=t.clientY,(i=t).inputIndex=Ci.Move,e._onInputChanged(r,n,i),e._usingSafari||-1===t.button||(i.inputIndex=t.button+2,s[t.button+2]=s[t.button+2]?0:1,e._onInputChanged(r,n,i)))},this._pointerDownEvent=function(t){var i=e._getPointerType(t),r=i===Ti.Mouse?0:t.pointerId;if(i===Ti.Touch){var n=e._activeTouchIds.indexOf(-1);if(!(0<=n))return void Ht.Warn("Max number of touches exceeded.  Ignoring touches in excess of ".concat(e._maxTouchPoints));e._activeTouchIds[r=n]=t.pointerId}if(e._inputs[i]||(e._inputs[i]={}),e._inputs[i][r]?i===Ti.Touch&&e._onDeviceConnected(i,r):e._addPointerDevice(i,r,t.clientX,t.clientY),n=e._inputs[i][r]){var s=n[Ci.Horizontal],o=n[Ci.Vertical];if(i===Ti.Mouse){if(-1===e._mouseId&&(void 0===t.pointerId?e._mouseId=e._isUsingFirefox?0:1:e._mouseId=t.pointerId),!document.pointerLockElement&&e._elementToAttachTo.hasPointerCapture)try{e._elementToAttachTo.setPointerCapture(e._mouseId)}catch(t){}}else if(t.pointerId&&!document.pointerLockElement&&e._elementToAttachTo.hasPointerCapture)try{e._elementToAttachTo.setPointerCapture(t.pointerId)}catch(t){}n[Ci.Horizontal]=t.clientX,n[Ci.Vertical]=t.clientY,n[t.button+2]=1,(n=t).inputIndex=t.button+2,e._onInputChanged(i,r,n),s===t.clientX&&o===t.clientY||(n.inputIndex=Ci.Move,e._onInputChanged(i,r,n))}},this._pointerUpEvent=function(t){var i=e._getPointerType(t),r=i===Ti.Mouse?0:e._activeTouchIds.indexOf(t.pointerId);if(i===Ti.Touch){if(-1===r)return;e._activeTouchIds[r]=-1}var n,s,o=null==(o=e._inputs[i])?void 0:o[r];o&&0!==o[t.button+2]&&(n=o[Ci.Horizontal],s=o[Ci.Vertical],o[Ci.Horizontal]=t.clientX,o[Ci.Vertical]=t.clientY,o[t.button+2]=0,n===(o=t).clientX&&s===t.clientY||(o.inputIndex=Ci.Move,e._onInputChanged(i,r,o)),o.inputIndex=t.button+2,i===Ti.Mouse&&0<=e._mouseId&&null!=(s=(n=e._elementToAttachTo).hasPointerCapture)&&s.call(n,e._mouseId)?e._elementToAttachTo.releasePointerCapture(e._mouseId):t.pointerId&&null!=(n=(s=e._elementToAttachTo).hasPointerCapture)&&n.call(s,t.pointerId)&&e._elementToAttachTo.releasePointerCapture(t.pointerId),e._onInputChanged(i,r,o),i===Ti.Touch&&e._onDeviceDisconnected(i,r))},this._pointerCancelEvent=function(t){var i,r;if("mouse"===t.pointerType){var n=e._inputs[Ti.Mouse][0];0<=e._mouseId&&null!=(o=(i=e._elementToAttachTo).hasPointerCapture)&&o.call(i,e._mouseId)&&e._elementToAttachTo.releasePointerCapture(e._mouseId);for(var s=Ci.LeftClick;s<=Ci.BrowserForward;s++)1===n[s]&&(n[s]=0,a=tr.CreateDeviceEvent(Ti.Mouse,0,s,0,e,e._elementToAttachTo),e._onInputChanged(Ti.Mouse,0,a))}else{var o=e._activeTouchIds.indexOf(t.pointerId),a=(null!=(r=(i=e._elementToAttachTo).hasPointerCapture)&&r.call(i,t.pointerId)&&e._elementToAttachTo.releasePointerCapture(t.pointerId),e._inputs[Ti.Touch][o][Ci.LeftClick]=0,tr.CreateDeviceEvent(Ti.Touch,o,Ci.LeftClick,0,e,e._elementToAttachTo));e._onInputChanged(Ti.Touch,o,a),e._activeTouchIds[o]=-1,e._onDeviceDisconnected(Ti.Touch,o)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";var r=!1;try{var n={passive:{get:function(){r=!0}}};this._elementToAttachTo.addEventListener("test",i,n),this._elementToAttachTo.removeEventListener("test",i,n)}catch(t){}this._pointerBlurEvent=function(){var t,i,r,n;if(e.isDeviceAvailable(Ti.Mouse)){var s=e._inputs[Ti.Mouse][0];0<=e._mouseId&&null!=(i=(t=e._elementToAttachTo).hasPointerCapture)&&i.call(t,e._mouseId)&&e._elementToAttachTo.releasePointerCapture(e._mouseId);for(var o=Ci.LeftClick;o<=Ci.BrowserForward;o++)1===s[o]&&(s[o]=0,h=tr.CreateDeviceEvent(Ti.Mouse,0,o,0,e,e._elementToAttachTo),e._onInputChanged(Ti.Mouse,0,h))}if(e.isDeviceAvailable(Ti.Touch)){s=e._inputs[Ti.Touch];for(var a=0;a<e._activeTouchIds.length;a++){var h,l=e._activeTouchIds[a];null!=(n=(r=e._elementToAttachTo).hasPointerCapture)&&n.call(r,l)&&e._elementToAttachTo.releasePointerCapture(l),-1!==l&&1===(null==(n=s[a])?void 0:n[Ci.LeftClick])&&(s[a][Ci.LeftClick]=0,h=tr.CreateDeviceEvent(Ti.Touch,a,Ci.LeftClick,0,e,e._elementToAttachTo),e._onInputChanged(Ti.Touch,a,h),e._activeTouchIds[a]=-1,e._onDeviceDisconnected(Ti.Touch,a))}}},this._pointerWheelEvent=function(t){var i=Ti.Mouse,r=(e._inputs[i]||(e._inputs[i]=[]),e._inputs[i][0]||(e._pointerActive=!0,e._registerDevice(i,0,rr)),e._inputs[i][0]);r&&(r[Ci.MouseWheelX]=t.deltaX||0,r[Ci.MouseWheelY]=t.deltaY||t.wheelDelta||0,r[Ci.MouseWheelZ]=t.deltaZ||0,0!==r[Ci.MouseWheelX]&&(t.inputIndex=Ci.MouseWheelX,e._onInputChanged(i,0,t)),0!==r[Ci.MouseWheelY]&&(t.inputIndex=Ci.MouseWheelY,e._onInputChanged(i,0,t)),0!==r[Ci.MouseWheelZ]&&(t.inputIndex=Ci.MouseWheelZ,e._onInputChanged(i,0,t)))},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!r&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add((function(){var t;e.isDeviceAvailable(Ti.Mouse)&&((t=e._inputs[Ti.Mouse][0])[Ci.MouseWheelX]=0,t[Ci.MouseWheelY]=0,t[Ci.MouseWheelZ]=0)}))},e.prototype._handleGamepadActions=function(){var e=this;this._gamepadConnectedEvent=function(t){e._addGamePad(t.gamepad)},this._gamepadDisconnectedEvent=function(t){var i;e._gamepads&&(i=e._getGamepadDeviceType(t.gamepad.id),t=t.gamepad.index,e._unregisterDevice(i,t),delete e._gamepads[t])},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)},e.prototype._updateDevice=function(e,t,i){var r=navigator.getGamepads()[t];r&&e===this._gamepads[t]&&(e=this._inputs[e][t],i>=r.buttons.length?e[i]=r.axes[i-r.buttons.length].valueOf():e[i]=r.buttons[i].value)},e.prototype._getGamepadDeviceType=function(e){return-1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?Ti.DualSense:Ti.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?Ti.Xbox:-1!==e.indexOf("057e")?Ti.Switch:Ti.Generic},e.prototype._getPointerType=function(e){var t=Ti.Mouse;return"touch"===e.pointerType||"pen"===e.pointerType||e.touches?Ti.Touch:t},e}(),sr=function(){function e(e,t,i){void 0===i&&(i=0),this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new Ce,this._deviceInputSystem=e}return e.prototype.getInput=function(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)},e}(),or=function(){function e(e){function t(e,t){n._devices[e]||(n._devices[e]=new Array),n._devices[e][t]||(n._devices[e][t]=t);for(var i=0,r=n._registeredManagers;i<r.length;i++){var s=r[i],o=new sr(n._deviceInputSystem,e,t);s._addDevice(o)}}function i(e,t){var i;null!=(i=n._devices[e])&&i[t]&&delete n._devices[e][t];for(var r=0,s=n._registeredManagers;r<s.length;r++)s[r]._removeDevice(e,t)}function r(e,t,i){if(i)for(var r=0,s=n._registeredManagers;r<s.length;r++)s[r]._onInputChanged(e,t,i)}var n=this,s=(this._registeredManagers=new Array,this._refCount=0,this.registerManager=function(e){for(var t,i=0;i<n._devices.length;i++)for(t in n._devices[i])e._addDevice(new sr(n._deviceInputSystem,i,+t));n._registeredManagers.push(e)},this.unregisterManager=function(e){-1<(e=n._registeredManagers.indexOf(e))&&n._registeredManagers.splice(e,1)},Object.keys(Ti).length/2);this._devices=new Array(s),"undefined"!=typeof _native?this._deviceInputSystem=new ir(t,i,r):this._deviceInputSystem=new nr(e,t,i,r)}return e.prototype.dispose=function(){this._deviceInputSystem.dispose()},e}(),ar=function(){function e(e){var t=this,i=Object.keys(Ti).length/2;this._devices=new Array(i),this._firstDevice=new Array(i),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new or(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new Ce((function(e){for(var i=0,r=t._devices;i<r.length;i++){var n=r[i];if(n)for(var s=0,o=n;s<o.length;s++){var a=o[s];a&&t.onDeviceConnectedObservable.notifyObserver(e,a)}}})),this.onDeviceDisconnectedObservable=new Ce,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add((function(){t.dispose()}))}return e.prototype.getDeviceSource=function(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null},e.prototype.getDeviceSources=function(e){return this._devices[e].filter((function(e){return!!e}))},e.prototype.dispose=function(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)},e.prototype._addDevice=function(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)},e.prototype._removeDevice=function(e,t){var i=null==(i=this._devices[e])?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(i),null!=(i=this._devices[e])&&i[t]&&delete this._devices[e][t],this._updateFirstDevices(e)},e.prototype._onInputChanged=function(e,t,i){null!=(e=null==(e=this._devices[e])?void 0:e[t])&&e.onInputChangedObservable.notifyObservers(i)},e.prototype._updateFirstDevices=function(e){switch(e){case Ti.Keyboard:case Ti.Mouse:this._firstDevice[e]=0;break;case Ti.Touch:case Ti.DualSense:case Ti.DualShock:case Ti.Xbox:case Ti.Switch:case Ti.Generic:delete this._firstDevice[e];var t=this._devices[e];if(t)for(var i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}},e}(),hr=function(){function e(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}return Object.defineProperty(e.prototype,"singleClick",{get:function(){return this._singleClick},set:function(e){this._singleClick=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"doubleClick",{get:function(){return this._doubleClick},set:function(e){this._doubleClick=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasSwiped",{get:function(){return this._hasSwiped},set:function(e){this._hasSwiped=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ignore",{get:function(){return this._ignore},set:function(e){this._ignore=e},enumerable:!1,configurable:!0}),e}(),lr=function(){function e(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new ri(0,0),this._previousStartingPointerPosition=new ri(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._deviceSourceManager=null,this._scene=e||ke.LastCreatedScene,this._scene}return Object.defineProperty(e.prototype,"meshUnderPointer",{get:function(){return this._pointerOverMesh},enumerable:!1,configurable:!0}),e.prototype.getMeshUnderPointerByPointerId=function(e){return this._meshUnderPointerId[e]||null},Object.defineProperty(e.prototype,"unTranslatedPointer",{get:function(){return new ri(this._unTranslatedPointerX,this._unTranslatedPointerY)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointerX",{get:function(){return this._pointerX},set:function(e){this._pointerX=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointerY",{get:function(){return this._pointerY},set:function(e){this._pointerY=e},enumerable:!1,configurable:!0}),e.prototype._updatePointerPosition=function(e){var t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)},e.prototype._processPointerMove=function(e,t){var i=this._scene,r=i.getEngine(),n=r.getInputElement(),s=(n&&(n.tabIndex=r.canvasTabIndex,i.doNotHandleCursors||(n.style.cursor=i.defaultCursor)),!!(e&&e.hit&&e.pickedMesh));s?(i.setPointerOverMesh(e.pickedMesh,t.pointerId,e),!i.doNotHandleCursors&&n&&this._pointerOverMesh&&(r=this._pointerOverMesh._getActionManagerForTrigger())&&r.hasPointerTriggers&&(n.style.cursor=r.hoverCursor||i.hoverCursor)):i.setPointerOverMesh(null,t.pointerId,e);for(var o=0,a=i._pointerMoveStage;o<a.length;o++)e=a[o].action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,s,n);e&&(r="wheel"===t.type||"mousewheel"===t.type||"DOMMouseScroll"===t.type?Ki.POINTERWHEEL:Ki.POINTERMOVE,i.onPointerMove&&i.onPointerMove(t,e,r),i.onPointerObservable.hasObservers()&&(t=new Yi(r,t,e),this._setRayOnPointerInfo(t),i.onPointerObservable.notifyObservers(t,r)))},e.prototype._setRayOnPointerInfo=function(e){var t=this._scene;!e.pickInfo||e.pickInfo._pickingUnavailable||e.pickInfo.ray||(e.pickInfo.ray=t.createPickingRay(e.event.offsetX,e.event.offsetY,ai.Identity(),t.activeCamera))},e.prototype._checkPrePointerObservable=function(e,t,i){var r=this._scene;t=new qi(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(t.ray=e.ray,e.originMesh&&(t.nearInteractionPickingInfo=e)),r.onPrePointerObservable.notifyObservers(t,i),!!t.skipOnPointerObservable},e.prototype.simulatePointerMove=function(e,t){(t=new PointerEvent("pointermove",t)).inputIndex=Ci.Move,this._checkPrePointerObservable(e,t,Ki.POINTERMOVE)||this._processPointerMove(e,t)},e.prototype.simulatePointerDown=function(e,t){(t=new PointerEvent("pointerdown",t)).inputIndex=t.button+2,this._checkPrePointerObservable(e,t,Ki.POINTERDOWN)||this._processPointerDown(e,t)},e.prototype._processPointerDown=function(t,i){var r,n,s=this,o=this._scene;if(t&&t.hit&&t.pickedMesh){this._pickedDownMesh=t.pickedMesh;var a=t.pickedMesh._getActionManagerForTrigger();if(a){if(a.hasPickTriggers)switch(a.processTrigger(5,zi.CreateNew(t.pickedMesh,i)),i.button){case 0:a.processTrigger(2,zi.CreateNew(t.pickedMesh,i));break;case 1:a.processTrigger(4,zi.CreateNew(t.pickedMesh,i));break;case 2:a.processTrigger(3,zi.CreateNew(t.pickedMesh,i))}a.hasSpecificTrigger(8)&&window.setTimeout((function(){var t=o.pick(s._unTranslatedPointerX,s._unTranslatedPointerY,(function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.actionManager&&e.actionManager.hasSpecificTrigger(8)&&e===s._pickedDownMesh}),!1,o.cameraToUseForPointers);t&&t.hit&&t.pickedMesh&&a&&0!==s._totalPointersPressed&&Date.now()-s._startingPointerTime>e.LongPressDelay&&!s._isPointerSwiping()&&(s._startingPointerTime=0,a.processTrigger(8,zi.CreateNew(t.pickedMesh,i)))}),e.LongPressDelay)}}else for(var h=0,l=o._pointerDownStage;h<l.length;h++)t=l[h].action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,i);t&&(r=Ki.POINTERDOWN,o.onPointerDown&&o.onPointerDown(i,t,r),o.onPointerObservable.hasObservers()&&(n=new Yi(r,i,t),this._setRayOnPointerInfo(n),o.onPointerObservable.notifyObservers(n,r)))},e.prototype._isPointerSwiping=function(){return Math.abs(this._startingPointerPosition.x-this._pointerX)>e.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>e.DragMovementThreshold},e.prototype.simulatePointerUp=function(e,t,i){var r=((t=new PointerEvent("pointerup",t)).inputIndex=Ci.Move,new hr);i?r.doubleClick=!0:r.singleClick=!0,this._checkPrePointerObservable(e,t,Ki.POINTERUP)||this._processPointerUp(e,t,r)},e.prototype._processPointerUp=function(e,t,i){var r=this._scene;if(e&&e.hit&&e.pickedMesh)this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(r.onPointerPick&&r.onPointerPick(t,e),i.singleClick&&!i.ignore&&r.onPointerObservable.hasObservers()&&(a=Ki.POINTERPICK,o=new Yi(a,t,e),this._setRayOnPointerInfo(o),r.onPointerObservable.notifyObservers(o,a))),(a=e.pickedMesh._getActionManagerForTrigger())&&!i.ignore&&(a.processTrigger(7,zi.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&a.processTrigger(1,zi.CreateNew(e.pickedMesh,t,e)),a=e.pickedMesh._getActionManagerForTrigger(6),i.doubleClick&&a&&a.processTrigger(6,zi.CreateNew(e.pickedMesh,t,e)));else if(!i.ignore)for(var n=0,s=r._pointerUpStage;n<s.length;n++)e=s[n].action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t);this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh&&(a=this._pickedDownMesh._getActionManagerForTrigger(16))&&a.processTrigger(16,zi.CreateNew(this._pickedDownMesh,t));var o,a=0;r.onPointerObservable.hasObservers()&&(i.ignore||i.hasSwiped||(i.singleClick&&r.onPointerObservable.hasSpecificMask(Ki.POINTERTAP)?a=Ki.POINTERTAP:i.doubleClick&&r.onPointerObservable.hasSpecificMask(Ki.POINTERDOUBLETAP)&&(a=Ki.POINTERDOUBLETAP),a&&(o=new Yi(a,t,e),this._setRayOnPointerInfo(o),r.onPointerObservable.notifyObservers(o,a))),i.ignore||(a=Ki.POINTERUP,o=new Yi(a,t,e),this._setRayOnPointerInfo(o),r.onPointerObservable.notifyObservers(o,a))),r.onPointerUp&&!i.ignore&&r.onPointerUp(t,e,a)},e.prototype.isPointerCaptured=function(e){return this._pointerCaptures[e=void 0===e?0:e]},e.prototype.attachControl=function(t,i,r,n){var s=this,o=(void 0===t&&(t=!0),void 0===i&&(i=!0),void 0===r&&(r=!0),void 0===n&&(n=null),this._scene),a=o.getEngine();n=n||a.getInputElement(),this._alreadyAttached&&this.detachControl(),n&&(this._alreadyAttachedTo=n),this._deviceSourceManager=new ar(a),this._initActionManager=function(e){var t;return s._meshPickProceed||(t=o.skipPointerUpPicking?null:o.pick(s._unTranslatedPointerX,s._unTranslatedPointerY,o.pointerUpPredicate,!1,o.cameraToUseForPointers),(s._currentPickResult=t)&&(e=t.hit&&t.pickedMesh?t.pickedMesh._getActionManagerForTrigger():null),s._meshPickProceed=!0),e},this._delayedSimpleClick=function(t,i,r){(Date.now()-s._previousStartingPointerTime>e.DoubleClickDelay&&!s._doubleClickOccured||t!==s._previousButtonPressed)&&(s._doubleClickOccured=!1,i.singleClick=!0,i.ignore=!1,r(i,s._currentPickResult))},this._initClickEvent=function(t,i,r,n){var o=new hr,a=s._currentPickResult=null,h=t.hasSpecificMask(Ki.POINTERPICK)||i.hasSpecificMask(Ki.POINTERPICK)||t.hasSpecificMask(Ki.POINTERTAP)||i.hasSpecificMask(Ki.POINTERTAP)||t.hasSpecificMask(Ki.POINTERDOUBLETAP)||i.hasSpecificMask(Ki.POINTERDOUBLETAP),l=!1;(h=!h&&Zi&&(a=s._initActionManager(a,o))?a.hasPickTriggers:h)&&(h=r.button,o.hasSwiped=s._isPointerSwiping(),o.hasSwiped||((r=!e.ExclusiveDoubleClickMode)||(r=!t.hasSpecificMask(Ki.POINTERDOUBLETAP)&&!i.hasSpecificMask(Ki.POINTERDOUBLETAP))&&!Zi.HasSpecificTrigger(6)&&(a=s._initActionManager(a,o))&&(r=!a.hasSpecificTrigger(6)),r?(Date.now()-s._previousStartingPointerTime>e.DoubleClickDelay||h!==s._previousButtonPressed)&&(o.singleClick=!0,n(o,s._currentPickResult),l=!0):(s._previousDelayedSimpleClickTimeout=s._delayedSimpleClickTimeout,s._delayedSimpleClickTimeout=window.setTimeout(s._delayedSimpleClick.bind(s,h,o,n),e.DoubleClickDelay)),(r=!(r=t.hasSpecificMask(Ki.POINTERDOUBLETAP)||i.hasSpecificMask(Ki.POINTERDOUBLETAP))&&Zi.HasSpecificTrigger(6)&&(a=s._initActionManager(a,o))?a.hasSpecificTrigger(6):r)&&(h===s._previousButtonPressed&&Date.now()-s._previousStartingPointerTime<e.DoubleClickDelay&&!s._doubleClickOccured?(o.hasSwiped||s._isPointerSwiping()?(s._doubleClickOccured=!1,s._previousStartingPointerTime=s._startingPointerTime,s._previousStartingPointerPosition.x=s._startingPointerPosition.x,s._previousStartingPointerPosition.y=s._startingPointerPosition.y,s._previousButtonPressed=h,e.ExclusiveDoubleClickMode?(s._previousDelayedSimpleClickTimeout&&clearTimeout(s._previousDelayedSimpleClickTimeout),s._previousDelayedSimpleClickTimeout=s._delayedSimpleClickTimeout,n(o,s._previousPickResult)):n(o,s._currentPickResult)):(s._previousStartingPointerTime=0,s._doubleClickOccured=!0,o.doubleClick=!0,o.ignore=!1,e.ExclusiveDoubleClickMode&&s._previousDelayedSimpleClickTimeout&&clearTimeout(s._previousDelayedSimpleClickTimeout),s._previousDelayedSimpleClickTimeout=s._delayedSimpleClickTimeout,n(o,s._currentPickResult)),l=!0):(s._doubleClickOccured=!1,s._previousStartingPointerTime=s._startingPointerTime,s._previousStartingPointerPosition.x=s._startingPointerPosition.x,s._previousStartingPointerPosition.y=s._startingPointerPosition.y,s._previousButtonPressed=h)))),l||n(o,s._currentPickResult)},this._onPointerMove=function(e){var t;void 0===e.pointerId&&(e.pointerId=0),s._updatePointerPosition(e),s._checkPrePointerObservable(null,e,"wheel"===e.type||"mousewheel"===e.type||"DOMMouseScroll"===e.type?Ki.POINTERWHEEL:Ki.POINTERMOVE)||(o.cameraToUseForPointers||o.activeCamera)&&(o.skipPointerMovePicking?s._processPointerMove(new Ui,e):(o.pointerMovePredicate||(o.pointerMovePredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(e.enablePointerMoveEvents||o.constantlyUpdateMeshUnderPointer||null!==e._getActionManagerForTrigger())&&(!o.cameraToUseForPointers||0!=(o.cameraToUseForPointers.layerMask&e.layerMask))}),t=o.pick(s._unTranslatedPointerX,s._unTranslatedPointerY,o.pointerMovePredicate,!1,o.cameraToUseForPointers,o.pointerMoveTrianglePredicate),s._processPointerMove(t,e)))},this._onPointerDown=function(e){var t;s._totalPointersPressed++,s._pickedDownMesh=null,s._meshPickProceed=!1,void 0===e.pointerId&&(e.pointerId=0),s._updatePointerPosition(e),o.preventDefaultOnPointerDown&&n&&(e.preventDefault(),n.focus()),s._startingPointerPosition.x=s._pointerX,s._startingPointerPosition.y=s._pointerY,s._startingPointerTime=Date.now(),s._checkPrePointerObservable(null,e,Ki.POINTERDOWN)||(o.cameraToUseForPointers||o.activeCamera)&&(s._pointerCaptures[e.pointerId]=!0,o.pointerDownPredicate||(o.pointerDownPredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!o.cameraToUseForPointers||0!=(o.cameraToUseForPointers.layerMask&e.layerMask))}),s._pickedDownMesh=null,t=o.skipPointerDownPicking?new Ui:o.pick(s._unTranslatedPointerX,s._unTranslatedPointerY,o.pointerDownPredicate,!1,o.cameraToUseForPointers),s._processPointerDown(t,e))},this._onPointerUp=function(e){0!==s._totalPointersPressed&&(s._totalPointersPressed--,s._pickedUpMesh=null,s._meshPickProceed=!1,void 0===e.pointerId&&(e.pointerId=0),s._updatePointerPosition(e),o.preventDefaultOnPointerUp&&n&&(e.preventDefault(),n.focus()),s._initClickEvent(o.onPrePointerObservable,o.onPointerObservable,e,(function(t,i){if(o.onPrePointerObservable.hasObservers()&&!t.ignore){if(!t.hasSwiped){if(t.singleClick&&o.onPrePointerObservable.hasSpecificMask(Ki.POINTERTAP)&&s._checkPrePointerObservable(null,e,Ki.POINTERTAP))return;if(t.doubleClick&&o.onPrePointerObservable.hasSpecificMask(Ki.POINTERDOUBLETAP)&&s._checkPrePointerObservable(null,e,Ki.POINTERDOUBLETAP))return}if(s._checkPrePointerObservable(null,e,Ki.POINTERUP))return}!s._pointerCaptures[e.pointerId]&&0<e.buttons||(s._pointerCaptures[e.pointerId]=!1,(o.cameraToUseForPointers||o.activeCamera)&&(o.pointerUpPredicate||(o.pointerUpPredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!o.cameraToUseForPointers||0!=(o.cameraToUseForPointers.layerMask&e.layerMask))}),!s._meshPickProceed&&(Zi&&Zi.HasTriggers||o.onPointerObservable.hasObservers())&&s._initActionManager(null,t),i=i||s._currentPickResult,s._processPointerUp(i,e,t),s._previousPickResult=s._currentPickResult))})))},this._onKeyDown=function(e){var t=Qi.KEYDOWN;if(o.onPreKeyboardObservable.hasObservers()){var i=new $i(t,e);if(o.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}o.onKeyboardObservable.hasObservers()&&(i=new Ji(t,e),o.onKeyboardObservable.notifyObservers(i,t)),o.actionManager&&o.actionManager.processTrigger(14,zi.CreateNewFromScene(o,e))},this._onKeyUp=function(e){var t=Qi.KEYUP;if(o.onPreKeyboardObservable.hasObservers()){var i=new $i(t,e);if(o.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}o.onKeyboardObservable.hasObservers()&&(i=new Ji(t,e),o.onKeyboardObservable.notifyObservers(i,t)),o.actionManager&&o.actionManager.processTrigger(15,zi.CreateNewFromScene(o,e))},this._deviceSourceManager.onDeviceConnectedObservable.add((function(e){e.deviceType===Ti.Mouse?e.onInputChangedObservable.add((function(n){n.inputIndex===Ci.LeftClick||n.inputIndex===Ci.MiddleClick||n.inputIndex===Ci.RightClick?i&&1===e.getInput(n.inputIndex)?s._onPointerDown(n):t&&0===e.getInput(n.inputIndex)&&s._onPointerUp(n):!r||n.inputIndex!==Ci.Move&&n.inputIndex!==Ci.MouseWheelX&&n.inputIndex!==Ci.MouseWheelY&&n.inputIndex!==Ci.MouseWheelZ||s._onPointerMove(n)})):e.deviceType===Ti.Touch?e.onInputChangedObservable.add((function(n){n.inputIndex===Ci.LeftClick&&(i&&1===e.getInput(n.inputIndex)?s._onPointerDown(n):t&&0===e.getInput(n.inputIndex)&&s._onPointerUp(n)),r&&n.inputIndex===Ci.Move&&s._onPointerMove(n)})):e.deviceType===Ti.Keyboard&&e.onInputChangedObservable.add((function(e){"keydown"===e.type?s._onKeyDown(e):"keyup"===e.type&&s._onKeyUp(e)}))})),this._alreadyAttached=!0},e.prototype.detachControl=function(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)},e.prototype.setPointerOverMesh=function(e,t,i){var r,n;this._meshUnderPointerId[t=void 0===t?0:t]!==e&&((r=this._meshUnderPointerId[t])&&(n=r._getActionManagerForTrigger(10))&&n.processTrigger(10,zi.CreateNew(r,void 0,{pointerId:t})),e?(this._meshUnderPointerId[t]=e,(n=(this._pointerOverMesh=e)._getActionManagerForTrigger(9))&&n.processTrigger(9,zi.CreateNew(e,void 0,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null))},e.prototype.getPointerOverMesh=function(){return this._pointerOverMesh},e.prototype._invalidateMesh=function(e){for(var t in this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null),this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]},e.DragMovementThreshold=10,e.LongPressDelay=500,e.DoubleClickDelay=300,e.ExclusiveDoubleClickMode=!1,e}(),cr=function(){function e(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}return Object.defineProperty(e.prototype,"min",{get:function(){return this._min},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"max",{get:function(){return this._max},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"average",{get:function(){return this._average},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lastSecAverage",{get:function(){return this._lastSecAverage},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"current",{get:function(){return this._current},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"total",{get:function(){return this._totalAccumulated},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"count",{get:function(){return this._totalValueCount},enumerable:!1,configurable:!0}),e.prototype.fetchNewFrame=function(){this._totalValueCount++,this._current=0,this._lastSecValueCount++},e.prototype.addCount=function(t,i){e.Enabled&&(this._current+=t,i&&this._fetchResult())},e.prototype.beginMonitoring=function(){e.Enabled&&(this._startMonitoringTime=Fe.Now)},e.prototype.endMonitoring=function(t){var i;void 0===t&&(t=!0),e.Enabled&&(t&&this.fetchNewFrame(),i=Fe.Now,this._current=i-this._startMonitoringTime,t&&this._fetchResult())},e.prototype._fetchResult=function(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;var e=Fe.Now;1e3<e-this._lastSecTime&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)},e.Enabled=!0,e}(),ur=function(){function e(e,t,i,r){this.normal=new ni(e,t,i),this.d=r}return e.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},e.prototype.clone=function(){return new e(this.normal.x,this.normal.y,this.normal.z,this.d)},e.prototype.getClassName=function(){return"Plane"},e.prototype.getHashCode=function(){return 397*this.normal.getHashCode()^(0|this.d)},e.prototype.normalize=function(){var e=0!==(e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z))?1/e:0;return this.normal.x*=e,this.normal.y*=e,this.normal.z*=e,this.d*=e,this},e.prototype.transform=function(t){var i=e._TmpMatrix,r=(t=(t.invertToRef(i),i.m),i=this.normal.x,this.normal.y),n=this.normal.z,s=this.d;return new e(i*t[0]+r*t[1]+n*t[2]+s*t[3],i*t[4]+r*t[5]+n*t[6]+s*t[7],i*t[8]+r*t[9]+n*t[10]+s*t[11],i*t[12]+r*t[13]+n*t[14]+s*t[15])},e.prototype.dotCoordinate=function(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d},e.prototype.copyFromPoints=function(e,t,i){var r=t.x-e.x,n=t.y-e.y,s=(t=t.z-e.z,i.x-e.x),o=i.y-e.y,a=n*(i=i.z-e.z)-t*o;t=t*s-r*i,i=r*o-n*s,o=0!==(r=Math.sqrt(a*a+t*t+i*i))?1/r:0;return this.normal.x=a*o,this.normal.y=t*o,this.normal.z=i*o,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this},e.prototype.isFrontFacingTo=function(e,t){return ni.Dot(this.normal,e)<=t},e.prototype.signedDistanceTo=function(e){return ni.Dot(e,this.normal)+this.d},e.FromArray=function(t){return new e(t[0],t[1],t[2],t[3])},e.FromPoints=function(t,i,r){var n=new e(0,0,0,0);return n.copyFromPoints(t,i,r),n},e.FromPositionAndNormal=function(t,i){var r=new e(0,0,0,0);return i.normalize(),r.normal=i,r.d=-(i.x*t.x+i.y*t.y+i.z*t.z),r},e.SignedDistanceToPlaneFromPositionAndNormal=function(e,t,i){return e=-(t.x*e.x+t.y*e.y+t.z*e.z),ni.Dot(i,t)+e},e._TmpMatrix=ai.Identity(),e}(),dr=function(){function e(){}return e.GetPlanes=function(t){for(var i=[],r=0;r<6;r++)i.push(new ur(0,0,0,0));return e.GetPlanesToRef(t,i),i},e.GetNearPlaneToRef=function(e,t){e=e.m,t.normal.x=e[3]+e[2],t.normal.y=e[7]+e[6],t.normal.z=e[11]+e[10],t.d=e[15]+e[14],t.normalize()},e.GetFarPlaneToRef=function(e,t){e=e.m,t.normal.x=e[3]-e[2],t.normal.y=e[7]-e[6],t.normal.z=e[11]-e[10],t.d=e[15]-e[14],t.normalize()},e.GetLeftPlaneToRef=function(e,t){e=e.m,t.normal.x=e[3]+e[0],t.normal.y=e[7]+e[4],t.normal.z=e[11]+e[8],t.d=e[15]+e[12],t.normalize()},e.GetRightPlaneToRef=function(e,t){e=e.m,t.normal.x=e[3]-e[0],t.normal.y=e[7]-e[4],t.normal.z=e[11]-e[8],t.d=e[15]-e[12],t.normalize()},e.GetTopPlaneToRef=function(e,t){e=e.m,t.normal.x=e[3]-e[1],t.normal.y=e[7]-e[5],t.normal.z=e[11]-e[9],t.d=e[15]-e[13],t.normalize()},e.GetBottomPlaneToRef=function(e,t){e=e.m,t.normal.x=e[3]+e[1],t.normal.y=e[7]+e[5],t.normal.z=e[11]+e[9],t.d=e[15]+e[13],t.normalize()},e.GetPlanesToRef=function(t,i){e.GetNearPlaneToRef(t,i[0]),e.GetFarPlaneToRef(t,i[1]),e.GetLeftPlaneToRef(t,i[2]),e.GetRightPlaneToRef(t,i[3]),e.GetTopPlaneToRef(t,i[4]),e.GetBottomPlaneToRef(t,i[5])},e}(),pr=function(){function e(){}return Object.defineProperty(e,"UniqueId",{get:function(){var e=this._UniqueIdCounter;return this._UniqueIdCounter++,e},enumerable:!1,configurable:!0}),e._UniqueIdCounter=1,e}(),_r=function(){function e(){}return e.CompareLightsPriority=function(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority},e.FALLOFF_DEFAULT=0,e.FALLOFF_PHYSICAL=1,e.FALLOFF_GLTF=2,e.FALLOFF_STANDARD=3,e.LIGHTMAP_DEFAULT=0,e.LIGHTMAP_SPECULAR=1,e.LIGHTMAP_SHADOWSONLY=2,e.INTENSITYMODE_AUTOMATIC=0,e.INTENSITYMODE_LUMINOUSPOWER=1,e.INTENSITYMODE_LUMINOUSINTENSITY=2,e.INTENSITYMODE_ILLUMINANCE=3,e.INTENSITYMODE_LUMINANCE=4,e.LIGHTTYPEID_POINTLIGHT=0,e.LIGHTTYPEID_DIRECTIONALLIGHT=1,e.LIGHTTYPEID_SPOTLIGHT=2,e.LIGHTTYPEID_HEMISPHERICLIGHT=3,e}(),fr=function(){function e(t,i){e.IsAvailable&&(this._observer=new window.ComputePressureObserver(t,i))}return Object.defineProperty(e,"IsAvailable",{get:function(){return Ee()&&"ComputePressureObserver"in window},enumerable:!1,configurable:!0}),e.prototype.observe=function(){var e;null!=(e=this._observer)&&e.observe&&null!=(e=this._observer)&&e.observe().catch((function(){}))},e.prototype.unobserve=function(){var e;null!=(e=this._observer)&&e.unobserve&&null!=(e=this._observer)&&e.unobserve()},e}(),gr=function(e){function t(i,r){var n=e.call(this)||this,s=(n._inputManager=new lr(n),n.cameraToUseForPointers=null,n._isScene=!0,n._blockEntityCollection=!1,n.autoClear=!0,n.autoClearDepthAndStencil=!0,n.clearColor=new pi(.2,.2,.3,1),n.ambientColor=new di(0,0,0),n.environmentIntensity=1,n._forceWireframe=!1,n._skipFrustumClipping=!1,n._forcePointsCloud=!1,n.animationsEnabled=!0,n._animationPropertiesOverride=null,n.useConstantAnimationDeltaTime=!1,n.constantlyUpdateMeshUnderPointer=!1,n.hoverCursor="pointer",n.defaultCursor="",n.doNotHandleCursors=!1,n.preventDefaultOnPointerDown=!0,n.preventDefaultOnPointerUp=!0,n.metadata=null,n.reservedDataStore=null,n.disableOfflineSupportExceptionRules=new Array,n.onDisposeObservable=new Ce,n._onDisposeObserver=null,n.onBeforeRenderObservable=new Ce,n._onBeforeRenderObserver=null,n.onAfterRenderObservable=new Ce,n.onAfterRenderCameraObservable=new Ce,n._onAfterRenderObserver=null,n.onBeforeAnimationsObservable=new Ce,n.onAfterAnimationsObservable=new Ce,n.onBeforeDrawPhaseObservable=new Ce,n.onAfterDrawPhaseObservable=new Ce,n.onReadyObservable=new Ce,n.onBeforeCameraRenderObservable=new Ce,n._onBeforeCameraRenderObserver=null,n.onAfterCameraRenderObservable=new Ce,n._onAfterCameraRenderObserver=null,n.onBeforeActiveMeshesEvaluationObservable=new Ce,n.onAfterActiveMeshesEvaluationObservable=new Ce,n.onBeforeParticlesRenderingObservable=new Ce,n.onAfterParticlesRenderingObservable=new Ce,n.onDataLoadedObservable=new Ce,n.onNewCameraAddedObservable=new Ce,n.onCameraRemovedObservable=new Ce,n.onNewLightAddedObservable=new Ce,n.onLightRemovedObservable=new Ce,n.onNewGeometryAddedObservable=new Ce,n.onGeometryRemovedObservable=new Ce,n.onNewTransformNodeAddedObservable=new Ce,n.onTransformNodeRemovedObservable=new Ce,n.onNewMeshAddedObservable=new Ce,n.onMeshRemovedObservable=new Ce,n.onNewSkeletonAddedObservable=new Ce,n.onSkeletonRemovedObservable=new Ce,n.onNewMaterialAddedObservable=new Ce,n.onNewMultiMaterialAddedObservable=new Ce,n.onMaterialRemovedObservable=new Ce,n.onMultiMaterialRemovedObservable=new Ce,n.onNewTextureAddedObservable=new Ce,n.onTextureRemovedObservable=new Ce,n.onBeforeRenderTargetsRenderObservable=new Ce,n.onAfterRenderTargetsRenderObservable=new Ce,n.onBeforeStepObservable=new Ce,n.onAfterStepObservable=new Ce,n.onActiveCameraChanged=new Ce,n.onBeforeRenderingGroupObservable=new Ce,n.onAfterRenderingGroupObservable=new Ce,n.onMeshImportedObservable=new Ce,n.onAnimationFileImportedObservable=new Ce,n._registeredForLateAnimationBindings=new Xt(256),n.skipPointerMovePicking=!1,n.skipPointerDownPicking=!1,n.skipPointerUpPicking=!1,n.onPrePointerObservable=new Ce,n.onPointerObservable=new Ce,n.onPreKeyboardObservable=new Ce,n.onKeyboardObservable=new Ce,n._useRightHandedSystem=!1,n._timeAccumulator=0,n._currentStepId=0,n._currentInternalStep=0,n._fogEnabled=!0,n._fogMode=t.FOGMODE_NONE,n.fogColor=new di(.2,.2,.3),n.fogDensity=.1,n.fogStart=0,n.fogEnd=1e3,n.needsPreviousWorldMatrices=!1,n._shadowsEnabled=!0,n._lightsEnabled=!0,n.activeCameras=new Array,n._texturesEnabled=!0,n.physicsEnabled=!0,n.particlesEnabled=!0,n.spritesEnabled=!0,n._skeletonsEnabled=!0,n.lensFlaresEnabled=!0,n.collisionsEnabled=!0,n.gravity=new ni(0,-9.807,0),n.postProcessesEnabled=!0,n.renderTargetsEnabled=!0,n.dumpNextRenderTargets=!1,n.customRenderTargets=new Array,n.importedMeshesFiles=new Array,n.probesEnabled=!0,n._meshesForIntersections=new Xt(256),n.proceduralTexturesEnabled=!0,n._totalVertices=new cr,n._activeIndices=new cr,n._activeParticles=new cr,n._activeBones=new cr,n._animationTime=0,n.animationTimeScale=1,n._renderId=0,n._frameId=0,n._executeWhenReadyTimeoutId=null,n._intermediateRendering=!1,n._defaultFrameBufferCleared=!1,n._viewUpdateFlag=-1,n._projectionUpdateFlag=-1,n._toBeDisposed=new Array(256),n._activeRequests=new Array,n._pendingData=new Array,n._isDisposed=!1,n.dispatchAllSubMeshesOfActiveMeshes=!1,n._activeMeshes=new Kt(256),n._processedMaterials=new Kt(256),n._renderTargets=new Xt(256),n._materialsRenderTargets=new Xt(256),n._activeParticleSystems=new Kt(256),n._activeSkeletons=new Xt(32),n._softwareSkinnedMeshes=new Xt(32),n._activeAnimatables=new Array,n._transformMatrix=ai.Zero(),n.requireLightSorting=!1,n._components=[],n._serializableComponents=[],n._transientComponents=[],n._beforeCameraUpdateStage=Hi.Create(),n._beforeClearStage=Hi.Create(),n._beforeRenderTargetClearStage=Hi.Create(),n._gatherRenderTargetsStage=Hi.Create(),n._gatherActiveCameraRenderTargetsStage=Hi.Create(),n._isReadyForMeshStage=Hi.Create(),n._beforeEvaluateActiveMeshStage=Hi.Create(),n._evaluateSubMeshStage=Hi.Create(),n._preActiveMeshStage=Hi.Create(),n._cameraDrawRenderTargetStage=Hi.Create(),n._beforeCameraDrawStage=Hi.Create(),n._beforeRenderTargetDrawStage=Hi.Create(),n._beforeRenderingGroupDrawStage=Hi.Create(),n._beforeRenderingMeshStage=Hi.Create(),n._afterRenderingMeshStage=Hi.Create(),n._afterRenderingGroupDrawStage=Hi.Create(),n._afterCameraDrawStage=Hi.Create(),n._afterRenderTargetDrawStage=Hi.Create(),n._afterRenderStage=Hi.Create(),n._pointerMoveStage=Hi.Create(),n._pointerDownStage=Hi.Create(),n._pointerUpStage=Hi.Create(),n._geometriesByUniqueId=null,n._defaultMeshCandidates={data:[],length:0},n._defaultSubMeshCandidates={data:[],length:0},n._preventFreeActiveMeshesAndRenderingGroups=!1,n._activeMeshesFrozen=!1,n._activeMeshesFrozenButKeepClipping=!1,n._skipEvaluateActiveMeshesCompletely=!1,n._allowPostProcessClearColor=!0,n.getDeterministicFrameTime=function(){return n._engine.getTimeStep()},n._blockMaterialDirtyMechanism=!1,n._perfCollector=null,n.onComputePressureChanged=new Ce,m({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},r));return n._engine=i||ke.LastCreatedEngine,(s.virtual?n._engine._virtualScenes:(ke._LastCreatedScene=n)._engine.scenes).push(n),n._uid=null,n._renderingManager=new Wi(n),Gi&&(n.postProcessManager=new Gi(n)),Ee()&&n.attachControl(),n._createUbo(),Li&&(n._imageProcessingConfiguration=new Li),n.setDefaultCandidateProviders(),s.useGeometryUniqueIdsMap&&(n._geometriesByUniqueId={}),n.useMaterialMeshMap=s.useMaterialMeshMap,n.useClonedMeshMap=s.useClonedMeshMap,r&&r.virtual||n._engine.onNewSceneAddedObservable.notifyObservers(n),fr.IsAvailable&&(n._computePressureObserver=new fr((function(e){n.onComputePressureChanged.notifyObservers(e)}),{cpuUtilizationThresholds:[.25,.5,.75,.9],cpuSpeedThresholds:[.5]}),n._computePressureObserver.observe()),n}return c(t,e),t.DefaultMaterialFactory=function(e){throw De("StandardMaterial")},t.CollisionCoordinatorFactory=function(){throw De("DefaultCollisionCoordinator")},Object.defineProperty(t.prototype,"environmentTexture",{get:function(){return this._environmentTexture},set:function(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"forceWireframe",{get:function(){return this._forceWireframe},set:function(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"skipFrustumClipping",{get:function(){return this._skipFrustumClipping},set:function(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"forcePointsCloud",{get:function(){return this._forcePointsCloud},set:function(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"beforeRender",{set:function(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"afterRender",{set:function(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"beforeCameraRender",{set:function(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"afterCameraRender",{set:function(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"unTranslatedPointer",{get:function(){return this._inputManager.unTranslatedPointer},enumerable:!1,configurable:!0}),Object.defineProperty(t,"DragMovementThreshold",{get:function(){return lr.DragMovementThreshold},set:function(e){lr.DragMovementThreshold=e},enumerable:!1,configurable:!0}),Object.defineProperty(t,"LongPressDelay",{get:function(){return lr.LongPressDelay},set:function(e){lr.LongPressDelay=e},enumerable:!1,configurable:!0}),Object.defineProperty(t,"DoubleClickDelay",{get:function(){return lr.DoubleClickDelay},set:function(e){lr.DoubleClickDelay=e},enumerable:!1,configurable:!0}),Object.defineProperty(t,"ExclusiveDoubleClickMode",{get:function(){return lr.ExclusiveDoubleClickMode},set:function(e){lr.ExclusiveDoubleClickMode=e},enumerable:!1,configurable:!0}),t.prototype.bindEyePosition=function(e,t,i){void 0===t&&(t="vEyePosition"),void 0===i&&(i=!1);var r=this._forcedViewPosition||this._mirroredCameraPosition||(null!=(r=this.activeCamera.globalPosition)?r:this.activeCamera.devicePosition),n=this.useRightHandedSystem===(null!=this._mirroredCameraPosition);return li.Vector4[0].set(r.x,r.y,r.z,n?-1:1),e&&(i?e.setFloat3(t,li.Vector4[0].x,li.Vector4[0].y,li.Vector4[0].z):e.setVector4(t,li.Vector4[0])),li.Vector4[0]},t.prototype.finalizeSceneUbo=function(){var e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e},Object.defineProperty(t.prototype,"useRightHandedSystem",{get:function(){return this._useRightHandedSystem},set:function(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),t.prototype.setStepId=function(e){this._currentStepId=e},t.prototype.getStepId=function(){return this._currentStepId},t.prototype.getInternalStep=function(){return this._currentInternalStep},Object.defineProperty(t.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fogMode",{get:function(){return this._fogMode},set:function(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"prePass",{get:function(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shadowsEnabled",{get:function(){return this._shadowsEnabled},set:function(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lightsEnabled",{get:function(){return this._lightsEnabled},set:function(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"activeCamera",{get:function(){return this._activeCamera},set:function(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"defaultMaterial",{get:function(){return this._defaultMaterial||(this._defaultMaterial=t.DefaultMaterialFactory(this)),this._defaultMaterial},set:function(e){this._defaultMaterial=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"texturesEnabled",{get:function(){return this._texturesEnabled},set:function(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"skeletonsEnabled",{get:function(){return this._skeletonsEnabled},set:function(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"collisionCoordinator",{get:function(){return this._collisionCoordinator||(this._collisionCoordinator=t.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frustumPlanes",{get:function(){return this._frustumPlanes},enumerable:!1,configurable:!0}),t.prototype._registerTransientComponents=function(){if(0<this._transientComponents.length){for(var e=0,t=this._transientComponents;e<t.length;e++)t[e].register();this._transientComponents=[]}},t.prototype._addComponent=function(e){this._components.push(e),this._transientComponents.push(e),e.addFromContainer&&e.serialize&&this._serializableComponents.push(e)},t.prototype._getComponent=function(e){for(var t=0,i=this._components;t<i.length;t++){var r=i[t];if(r.name===e)return r}return null},t.prototype.getClassName=function(){return"Scene"},t.prototype._getDefaultMeshCandidates=function(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates},t.prototype._getDefaultSubMeshCandidates=function(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates},t.prototype.setDefaultCandidateProviders=function(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)},Object.defineProperty(t.prototype,"meshUnderPointer",{get:function(){return this._inputManager.meshUnderPointer},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"pointerX",{get:function(){return this._inputManager.pointerX},set:function(e){this._inputManager.pointerX=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"pointerY",{get:function(){return this._inputManager.pointerY},set:function(e){this._inputManager.pointerY=e},enumerable:!1,configurable:!0}),t.prototype.getCachedMaterial=function(){return this._cachedMaterial},t.prototype.getCachedEffect=function(){return this._cachedEffect},t.prototype.getCachedVisibility=function(){return this._cachedVisibility},t.prototype.isCachedMaterialInvalid=function(e,t,i){return void 0===i&&(i=1),this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i},t.prototype.getEngine=function(){return this._engine},t.prototype.getTotalVertices=function(){return this._totalVertices.current},Object.defineProperty(t.prototype,"totalVerticesPerfCounter",{get:function(){return this._totalVertices},enumerable:!1,configurable:!0}),t.prototype.getActiveIndices=function(){return this._activeIndices.current},Object.defineProperty(t.prototype,"totalActiveIndicesPerfCounter",{get:function(){return this._activeIndices},enumerable:!1,configurable:!0}),t.prototype.getActiveParticles=function(){return this._activeParticles.current},Object.defineProperty(t.prototype,"activeParticlesPerfCounter",{get:function(){return this._activeParticles},enumerable:!1,configurable:!0}),t.prototype.getActiveBones=function(){return this._activeBones.current},Object.defineProperty(t.prototype,"activeBonesPerfCounter",{get:function(){return this._activeBones},enumerable:!1,configurable:!0}),t.prototype.getActiveMeshes=function(){return this._activeMeshes},t.prototype.getAnimationRatio=function(){return void 0!==this._animationRatio?this._animationRatio:1},t.prototype.getRenderId=function(){return this._renderId},t.prototype.getFrameId=function(){return this._frameId},t.prototype.incrementRenderId=function(){this._renderId++},t.prototype._createUbo=function(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())},t.prototype.simulatePointerMove=function(e,t){return this._inputManager.simulatePointerMove(e,t),this},t.prototype.simulatePointerDown=function(e,t){return this._inputManager.simulatePointerDown(e,t),this},t.prototype.simulatePointerUp=function(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this},t.prototype.isPointerCaptured=function(e){return this._inputManager.isPointerCaptured(e=void 0===e?0:e)},t.prototype.attachControl=function(e,t,i){this._inputManager.attachControl(e=void 0===e||e,t=void 0===t||t,i=void 0===i||i)},t.prototype.detachControl=function(){this._inputManager.detachControl()},t.prototype.isReady=function(e){if(void 0===e&&(e=!0),this._isDisposed)return!1;var t,i=this.getEngine(),r=!0;for(0<this._pendingData.length&&(r=!1),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){var n=this.meshes[t];if(n.subMeshes&&0!==n.subMeshes.length)if(n.isReady(!0)){for(var s=n.hasThinInstances||"InstancedMesh"===n.getClassName()||"InstancedLinesMesh"===n.getClassName()||i.getCaps().instancedArrays&&0<n.instances.length,o=0,a=this._isReadyForMeshStage;o<a.length;o++)a[o].action(n,s)||(r=!1);if(e){var h=n.material||this.defaultMaterial;if(h)if(h._storeEffectOnSubMeshes)for(var l=0,c=n.subMeshes;l<c.length;l++){var u=c[l].getMaterial();u&&u.hasRenderTargetTextures&&null!=u.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(u)&&(this._processedMaterials.push(u),this._materialsRenderTargets.concatWithNoDuplicate(u.getRenderTargetTextures()))}else h.hasRenderTargetTextures&&null!=h.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(h)&&(this._processedMaterials.push(h),this._materialsRenderTargets.concatWithNoDuplicate(h.getRenderTargetTextures()))}}else r=!1}if(!r)return!1;if(!i.areAllEffectsReady())return!1;if(e)for(t=0;t<this._materialsRenderTargets.length;++t)if(!this._materialsRenderTargets.data[t].isReadyForRendering())return!1;for(t=0;t<this.geometries.length;t++)if(2===this.geometries[t].delayLoadState)return!1;if(this.activeCameras&&0<this.activeCameras.length){for(var d=0,p=this.activeCameras;d<p.length;d++)if(!p[d].isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(var _=0,f=this.particleSystems;_<f.length;_++)if(!f[_].isReady())return!1;return!0},t.prototype.resetCachedMaterial=function(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null},t.prototype.registerBeforeRender=function(e){this.onBeforeRenderObservable.add(e)},t.prototype.unregisterBeforeRender=function(e){this.onBeforeRenderObservable.removeCallback(e)},t.prototype.registerAfterRender=function(e){this.onAfterRenderObservable.add(e)},t.prototype.unregisterAfterRender=function(e){this.onAfterRenderObservable.removeCallback(e)},t.prototype._executeOnceBeforeRender=function(e){var t=this;this.registerBeforeRender((function i(){e(),setTimeout((function(){t.unregisterBeforeRender(i)}))}))},t.prototype.executeOnceBeforeRender=function(e,t){var i=this;void 0!==t?setTimeout((function(){i._executeOnceBeforeRender(e)}),t):this._executeOnceBeforeRender(e)},t.prototype._addPendingData=function(e){this._pendingData.push(e)},t.prototype._removePendingData=function(e){var t=this.isLoading;-1!==(e=this._pendingData.indexOf(e))&&this._pendingData.splice(e,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)},t.prototype.getWaitingItemsCount=function(){return this._pendingData.length},Object.defineProperty(t.prototype,"isLoading",{get:function(){return 0<this._pendingData.length},enumerable:!1,configurable:!0}),t.prototype.executeWhenReady=function(e,t){void 0===t&&(t=!1),this.onReadyObservable.add(e),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(t)},t.prototype.whenReadyAsync=function(e){var t=this;return void 0===e&&(e=!1),new Promise((function(i){t.executeWhenReady((function(){i()}),e)}))},t.prototype._checkIsReady=function(e){var t=this;return void 0===e&&(e=!1),this._registerTransientComponents(),this.isReady(e)?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):this._isDisposed?(this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):void(this._executeWhenReadyTimeoutId=setTimeout((function(){t._checkIsReady(e)}),100))},Object.defineProperty(t.prototype,"animatables",{get:function(){return this._activeAnimatables},enumerable:!1,configurable:!0}),t.prototype.resetLastAnimationTimeFrame=function(){this._animationTimeLast=Fe.Now},t.prototype.getViewMatrix=function(){return this._viewMatrix},t.prototype.getProjectionMatrix=function(){return this._projectionMatrix},t.prototype.getTransformMatrix=function(){return this._transformMatrix},t.prototype.setTransformMatrix=function(e,t,i,r){i||r||!this._multiviewSceneUbo||(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag||(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?dr.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=dr.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,r):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))},t.prototype.getSceneUniformBuffer=function(){return this._multiviewSceneUbo||this._sceneUbo},t.prototype.createSceneUniformBuffer=function(e){return(e=new Bi(this._engine,void 0,!1,null!=e?e:"scene")).addUniform("viewProjection",16),e.addUniform("view",16),e.addUniform("projection",16),e.addUniform("vEyePosition",4),e},t.prototype.setSceneUniformBuffer=function(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1},t.prototype.getUniqueId=function(){return pr.UniqueId},t.prototype.addMesh=function(e,t){var i=this;void 0===t&&(t=!1),this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach((function(e){i.addMesh(e)})))},t.prototype.removeMesh=function(e,t){var i=this,r=(void 0===t&&(t=!1),this.meshes.indexOf(e));return-1!==r&&(this.meshes[r]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach((function(e){i.removeMesh(e)})),r},t.prototype.addTransformNode=function(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneTransformNodesArray||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))},t.prototype.removeTransformNode=function(e){var t,i=e._indexInSceneTransformNodesArray;return-1!==i&&(i!==this.transformNodes.length-1&&(t=this.transformNodes[this.transformNodes.length-1],(this.transformNodes[i]=t)._indexInSceneTransformNodesArray=i),e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()),this.onTransformNodeRemovedObservable.notifyObservers(e),i},t.prototype.removeSkeleton=function(e){var t=this.skeletons.indexOf(e);return-1!==t&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t},t.prototype.removeMorphTargetManager=function(e){return-1!==(e=this.morphTargetManagers.indexOf(e))&&this.morphTargetManagers.splice(e,1),e},t.prototype.removeLight=function(e){var t=this.lights.indexOf(e);if(-1!==t){for(var i=0,r=this.meshes;i<r.length;i++)r[i]._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t},t.prototype.removeCamera=function(e){var t,i=this.cameras.indexOf(e);return-1!==i&&(this.cameras.splice(i,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras&&-1!==(t=this.activeCameras.indexOf(e))&&this.activeCameras.splice(t,1),this.activeCamera===e&&(0<this.cameras.length?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),i},t.prototype.removeParticleSystem=function(e){return-1!==(e=this.particleSystems.indexOf(e))&&(this.particleSystems.splice(e,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),e},t.prototype.removeAnimation=function(e){return-1!==(e=this.animations.indexOf(e))&&this.animations.splice(e,1),e},t.prototype.stopAnimation=function(e,t,i){},t.prototype.removeAnimationGroup=function(e){return-1!==(e=this.animationGroups.indexOf(e))&&this.animationGroups.splice(e,1),e},t.prototype.removeMultiMaterial=function(e){var t=this.multiMaterials.indexOf(e);return-1!==t&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t},t.prototype.removeMaterial=function(e){var t,i=e._indexInSceneMaterialArray;return-1!==i&&i<this.materials.length&&(i!==this.materials.length-1&&(t=this.materials[this.materials.length-1],(this.materials[i]=t)._indexInSceneMaterialArray=i),e._indexInSceneMaterialArray=-1,this.materials.pop()),this.onMaterialRemovedObservable.notifyObservers(e),i},t.prototype.removeActionManager=function(e){return-1!==(e=this.actionManagers.indexOf(e))&&this.actionManagers.splice(e,1),e},t.prototype.removeTexture=function(e){var t=this.textures.indexOf(e);return-1!==t&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t},t.prototype.addLight=function(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(var t=0,i=this.meshes;t<i.length;t++){var r=i[t];-1===r.lightSources.indexOf(e)&&(r.lightSources.push(e),r._resyncLightSources())}this.onNewLightAddedObservable.notifyObservers(e)}},t.prototype.sortLightsByPriority=function(){this.requireLightSorting&&this.lights.sort(_r.CompareLightsPriority)},t.prototype.addCamera=function(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())},t.prototype.addSkeleton=function(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))},t.prototype.addParticleSystem=function(e){this._blockEntityCollection||this.particleSystems.push(e)},t.prototype.addAnimation=function(e){this._blockEntityCollection||this.animations.push(e)},t.prototype.addAnimationGroup=function(e){this._blockEntityCollection||this.animationGroups.push(e)},t.prototype.addMultiMaterial=function(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))},t.prototype.addMaterial=function(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneMaterialArray||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))},t.prototype.addMorphTargetManager=function(e){this._blockEntityCollection||this.morphTargetManagers.push(e)},t.prototype.addGeometry=function(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))},t.prototype.addActionManager=function(e){this.actionManagers.push(e)},t.prototype.addTexture=function(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))},t.prototype.switchActiveCamera=function(e,t){void 0===t&&(t=!0),this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())},t.prototype.setActiveCameraById=function(e){return(e=this.getCameraById(e))?this.activeCamera=e:null},t.prototype.setActiveCameraByName=function(e){return(e=this.getCameraByName(e))?this.activeCamera=e:null},t.prototype.getAnimationGroupByName=function(e){for(var t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null},t.prototype.getMaterialByUniqueID=function(e){for(var t=0;t<this.materials.length;t++)if(this.materials[t].uniqueId===e)return this.materials[t];return null},t.prototype.getMaterialById=function(e){for(var t=0;t<this.materials.length;t++)if(this.materials[t].id===e)return this.materials[t];return null},t.prototype.getLastMaterialById=function(e,t){void 0===t&&(t=!1);for(var i=this.materials.length-1;0<=i;i--)if(this.materials[i].id===e)return this.materials[i];if(t)for(i=this.multiMaterials.length-1;0<=i;i--)if(this.multiMaterials[i].id===e)return this.multiMaterials[i];return null},t.prototype.getMaterialByName=function(e){for(var t=0;t<this.materials.length;t++)if(this.materials[t].name===e)return this.materials[t];return null},t.prototype.getTextureByUniqueId=function(e){for(var t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null},t.prototype.getTextureByName=function(e){for(var t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null},t.prototype.getCameraById=function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null},t.prototype.getCameraByUniqueId=function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null},t.prototype.getCameraByName=function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null},t.prototype.getBoneById=function(e){for(var t=0;t<this.skeletons.length;t++)for(var i=this.skeletons[t],r=0;r<i.bones.length;r++)if(i.bones[r].id===e)return i.bones[r];return null},t.prototype.getBoneByName=function(e){for(var t=0;t<this.skeletons.length;t++)for(var i=this.skeletons[t],r=0;r<i.bones.length;r++)if(i.bones[r].name===e)return i.bones[r];return null},t.prototype.getLightByName=function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null},t.prototype.getLightById=function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null},t.prototype.getLightByUniqueId=function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null},t.prototype.getParticleSystemById=function(e){for(var t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null},t.prototype.getGeometryById=function(e){for(var t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null},t.prototype._getGeometryByUniqueId=function(e){if(this._geometriesByUniqueId){if(void 0!==(t=this._geometriesByUniqueId[e]))return this.geometries[t]}else for(var t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null},t.prototype.pushGeometry=function(e,t){return!(!t&&this._getGeometryByUniqueId(e.uniqueId)||(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),0))},t.prototype.removeGeometry=function(e){var t,i;if(this._geometriesByUniqueId){if(void 0===(t=this._geometriesByUniqueId[e.uniqueId]))return!1}else if((t=this.geometries.indexOf(e))<0)return!1;return t!==this.geometries.length-1&&(i=this.geometries[this.geometries.length-1])&&(this.geometries[t]=i,this._geometriesByUniqueId&&(this._geometriesByUniqueId[i.uniqueId]=t,this._geometriesByUniqueId[e.uniqueId]=void 0)),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0},t.prototype.getGeometries=function(){return this.geometries},t.prototype.getMeshById=function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null},t.prototype.getMeshesById=function(e){return this.meshes.filter((function(t){return t.id===e}))},t.prototype.getTransformNodeById=function(e){for(var t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null},t.prototype.getTransformNodeByUniqueId=function(e){for(var t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null},t.prototype.getTransformNodesById=function(e){return this.transformNodes.filter((function(t){return t.id===e}))},t.prototype.getMeshByUniqueId=function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null},t.prototype.getLastMeshById=function(e){for(var t=this.meshes.length-1;0<=t;t--)if(this.meshes[t].id===e)return this.meshes[t];return null},t.prototype.getLastEntryById=function(e){for(var t=this.meshes.length-1;0<=t;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;0<=t;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;0<=t;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;0<=t;t--)if(this.lights[t].id===e)return this.lights[t];return null},t.prototype.getNodeById=function(e){var t=this.getMeshById(e);return t||((t=this.getTransformNodeById(e))||(t=this.getLightById(e))||(t=this.getCameraById(e))?t:(t=this.getBoneById(e))||null)},t.prototype.getNodeByName=function(e){var t=this.getMeshByName(e);return t||((t=this.getTransformNodeByName(e))||(t=this.getLightByName(e))||(t=this.getCameraByName(e))?t:(t=this.getBoneByName(e))||null)},t.prototype.getMeshByName=function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null},t.prototype.getTransformNodeByName=function(e){for(var t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null},t.prototype.getLastSkeletonById=function(e){for(var t=this.skeletons.length-1;0<=t;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null},t.prototype.getSkeletonByUniqueId=function(e){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null},t.prototype.getSkeletonById=function(e){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null},t.prototype.getSkeletonByName=function(e){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null},t.prototype.getMorphTargetManagerById=function(e){for(var t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null},t.prototype.getMorphTargetById=function(e){for(var t=0;t<this.morphTargetManagers.length;++t)for(var i=this.morphTargetManagers[t],r=0;r<i.numTargets;++r){var n=i.getTarget(r);if(n.id===e)return n}return null},t.prototype.getMorphTargetByName=function(e){for(var t=0;t<this.morphTargetManagers.length;++t)for(var i=this.morphTargetManagers[t],r=0;r<i.numTargets;++r){var n=i.getTarget(r);if(n.name===e)return n}return null},t.prototype.getPostProcessByName=function(e){for(var t=0;t<this.postProcesses.length;++t){var i=this.postProcesses[t];if(i.name===e)return i}return null},t.prototype.isActiveMesh=function(e){return-1!==this._activeMeshes.indexOf(e)},Object.defineProperty(t.prototype,"uid",{get:function(){return this._uid||(this._uid=Ht.RandomId()),this._uid},enumerable:!1,configurable:!0}),t.prototype.addExternalData=function(e,t){return this._externalData||(this._externalData=new qt),this._externalData.add(e,t)},t.prototype.getExternalData=function(e){return this._externalData?this._externalData.get(e):null},t.prototype.getOrAddExternalDataWithFactory=function(e,t){return this._externalData||(this._externalData=new qt),this._externalData.getOrAddWithFactory(e,t)},t.prototype.removeExternalData=function(e){return this._externalData.remove(e)},t.prototype._evaluateSubMesh=function(e,t,i){if(i.hasInstances||i.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh||1===t.subMeshes.length||e.isInFrustum(this._frustumPlanes)){for(var r=0,n=this._evaluateSubMeshStage;r<n.length;r++)n[r].action(t,e);null!=(i=e.getMaterial())&&(i.hasRenderTargetTextures&&null!=i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._materialsRenderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,i))}},t.prototype.freeProcessedMaterials=function(){this._processedMaterials.dispose()},Object.defineProperty(t.prototype,"blockfreeActiveMeshesAndRenderingGroups",{get:function(){return this._preventFreeActiveMeshesAndRenderingGroups},set:function(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)},enumerable:!1,configurable:!0}),t.prototype.freeActiveMeshes=function(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(var e=0;e<this.activeCameras.length;e++){var t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}},t.prototype.freeRenderingGroups=function(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(var e=0;e<this.textures.length;e++){var t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}},t.prototype._isInIntermediateRendering=function(){return this._intermediateRendering},t.prototype.freezeActiveMeshes=function(e,t,i,r,n){var s=this;return void 0===e&&(e=!1),void 0===r&&(r=!0),void 0===n&&(n=!1),this.executeWhenReady((function(){if(s.activeCamera){if(s._frustumPlanes||s.updateTransformMatrix(),s._evaluateActiveMeshes(),s._activeMeshesFrozen=!0,s._activeMeshesFrozenButKeepClipping=n,s._skipEvaluateActiveMeshesCompletely=e,r)for(var o=0;o<s._activeMeshes.length;o++)s._activeMeshes.data[o]._freeze();t&&t()}else i&&i("No active camera found")})),this},t.prototype.unfreezeActiveMeshes=function(){for(var e=0;e<this.meshes.length;e++){var t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this},t.prototype._executeActiveContainerCleanup=function(e){(!this._engine.snapshotRendering||1!==this._engine.snapshotRenderingMode)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce((function(){return e.dispose()}))},t.prototype._evaluateActiveMeshes=function(){var e;if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode)0<this._activeMeshes.length&&(null!=(e=this.activeCamera)&&e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());else if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely)for(var t=this._activeMeshes.length,i=0;i<t;i++)(h=this._activeMeshes.data[i]).computeWorldMatrix();if(this._activeParticleSystems){var r=this._activeParticleSystems.length;for(i=0;i<r;i++)this._activeParticleSystems.data[i].animate()}}else if(this.activeCamera){this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(var n=0,s=this._beforeEvaluateActiveMeshStage;n<s.length;n++)s[n].action();var o=this.getActiveMeshCandidates(),a=o.length;for(i=0;i<a;i++){var h=o.data[i];if(h._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,!h.isBlocked&&(this._totalVertices.addCount(h.getTotalVertices(),!1),h.isReady()&&h.isEnabled()&&!h.scaling.hasAZeroComponent)){h.computeWorldMatrix(),h.actionManager&&h.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(h);var l=this.customLODSelector?this.customLODSelector(h,this.activeCamera):h.getLOD(this.activeCamera);if(h._internalAbstractMeshDataInfo._currentLOD=l,h._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,null!=l&&(l!==h&&0!==l.billboardMode&&l.computeWorldMatrix(),h._preActivate(),h.isVisible&&0<h.visibility&&0!=(h.layerMask&this.activeCamera.layerMask)&&(this._skipFrustumClipping||h.alwaysSelectAsActiveMesh||h.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(h),this.activeCamera._activeMeshes.push(h),l!==h&&l._activate(this._renderId,!1);for(var c=0,u=this._preActiveMeshStage;c<u.length;c++)u[c].action(h);h._activate(this._renderId,!1)&&(h.isAnInstance?h._internalAbstractMeshDataInfo._actAsRegularMesh&&(l=h):l._internalAbstractMeshDataInfo._onlyForInstances=!1,l._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(h,l)),h._postActivate()}}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(var d=0;d<this.particleSystems.length;d++){var p,_=this.particleSystems[d];_.isStarted()&&_.emitter&&((p=_.emitter).position&&!p.isEnabled()||(this._activeParticleSystems.push(_),_.animate(),this._renderingManager.dispatchParticles(_)))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}},t.prototype._activeMesh=function(e,t){if(this._skeletonsEnabled&&null!==t.skeleton&&void 0!==t.skeleton&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&(t.skeleton.prepare(),this._activeBones.addCount(t.skeleton.bones.length,!1)),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t)),t&&t.subMeshes&&0<t.subMeshes.length)for(var i=this.getActiveSubMeshCandidates(t),r=i.length,n=0;n<r;n++){var s=i.data[n];this._evaluateSubMesh(s,t,e)}},t.prototype.updateTransformMatrix=function(e){var t,i;this.activeCamera&&(this.activeCamera._renderingMultiview?(t=this.activeCamera._rigCameras[0],i=this.activeCamera._rigCameras[1],this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e),i.getViewMatrix(),i.getProjectionMatrix(e))):this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e)))},t.prototype._bindFrameBuffer=function(e,t){void 0===t&&(t=!0),e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)},t.prototype._clearFrameBuffer=function(e){e&&e._multiviewTexture||(e&&e.outputRenderTarget?(e=e.outputRenderTarget).onClearObservable.hasObservers()?e.onClearObservable.notifyObservers(this._engine):e.skipInitialClear||(this._engine.clear(e.clearColor||this.clearColor,!e._cleared,!0,!0),e._cleared=!0):this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear()))},t.prototype._renderForCamera=function(e,t,i){if(void 0===i&&(i=!0),!e||!e._skipRendering){var r=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");r.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i&&(i=!0,e._renderingMultiview&&e.outputRenderTarget&&(i=e.outputRenderTarget.skipInitialClear,this.autoClear&&(e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=i)),this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(var n=0;n<this._softwareSkinnedMeshes.length;n++){var s=this._softwareSkinnedMeshes.data[n];s.applySkeleton(s.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&0<e.customRenderTargets.length&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&0<t.customRenderTargets.length&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(var o=0,a=this._gatherActiveCameraRenderTargetsStage;o<a.length;o++)a[o].action(this._renderTargets);var h=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,0<this._renderTargets.length){Ht.StartPerformanceCounter("Render targets",0<this._renderTargets.length);for(var l=0;l<this._renderTargets.length;l++){var c,u=this._renderTargets.data[l];u._shouldRender()&&(this._renderId++,c=u.activeCamera&&u.activeCamera!==this.activeCamera,u.render(c,this.dumpNextRenderTargets),h=!0)}Ht.EndPerformanceCounter("Render targets",0<this._renderTargets.length),this._renderId++}for(var d=0,p=this._cameraDrawRenderTargetStage;d<p.length;d++)h=p[d].action(this.activeCamera)||h;this._intermediateRendering=!1}this._engine.currentRenderPassId=null!=(i=null!=(t=null==(i=e.outputRenderTarget)?void 0:i.renderPassId)?t:e.renderPassId)?i:0,h&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),!this.postProcessManager||e._multiviewTexture||this.prePass||this.postProcessManager._prepareFrame();for(var _=0,f=this._beforeCameraDrawStage;_<f.length;_++)f[_].action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),r.snapshotRendering&&1===r.snapshotRenderingMode&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(var g=0,m=this._afterCameraDrawStage;g<m.length;g++)m[g].action(this.activeCamera);this.postProcessManager&&!e._multiviewTexture&&(t=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0,this.postProcessManager._finalizeFrame(e.isIntermediate,t)),this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}},t.prototype._processSubCameras=function(e,t){if(void 0===t&&(t=!0),0===e.cameraRigMode||e._renderingMultiview)return e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),void this.onAfterRenderCameraObservable.notifyObservers(e);if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(var i=0;i<e._rigCameras.length;i++)this._renderForCamera(e._rigCameras[i],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)},t.prototype._checkIntersections=function(){for(var e=0;e<this._meshesForIntersections.length;e++){var t=this._meshesForIntersections.data[e];if(t.actionManager)for(var i=0;t.actionManager&&i<t.actionManager.actions.length;i++)!function(e){var i,r,n;12!==(e=t.actionManager.actions[e]).trigger&&13!==e.trigger||(r=e.getTriggerParameter(),r=(i=r.mesh||r).intersectsMesh(t,r.usePreciseIntersection),n=t._intersectionsInProgress.indexOf(i),r&&-1===n?12===e.trigger?(e._executeCurrent(zi.CreateNew(t,void 0,i)),t._intersectionsInProgress.push(i)):13===e.trigger&&t._intersectionsInProgress.push(i):!r&&-1<n&&(13===e.trigger&&e._executeCurrent(zi.CreateNew(t,void 0,i)),t.actionManager.hasSpecificTrigger(13,(function(e){return e=e.mesh||e,i===e}))&&13!==e.trigger||t._intersectionsInProgress.splice(n,1)))}(i)}},t.prototype._advancePhysicsEngineStep=function(e){},t.prototype._animate=function(){},t.prototype.animate=function(){if(this._engine.isDeterministicLockStep()){var e=Math.max(t.MinDeltaTime,Math.min(this._engine.getDeltaTime(),t.MaxDeltaTime))+this._timeAccumulator,i=this._engine.getTimeStep(),r=1e3/i/1e3,n=0,s=this._engine.getLockstepMaxSteps(),o=Math.floor(e/i);for(o=Math.min(o,s);0<e&&n<o;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=i*r,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(i),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,n++,e-=i;this._timeAccumulator=e<0?0:e}else e=this.useConstantAnimationDeltaTime?16:Math.max(t.MinDeltaTime,Math.min(this._engine.getDeltaTime(),t.MaxDeltaTime)),this._animationRatio=.06*e,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)},t.prototype._clear=function(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)},t.prototype._checkCameraRenderTarget=function(e){var t;if(null==e||!e.outputRenderTarget||null!=e&&e.isRigCamera||(e.outputRenderTarget._cleared=!1),null!=(t=null==e?void 0:e.rigCameras)&&t.length)for(var i=0;i<e.rigCameras.length;++i){var r=e.rigCameras[i].outputRenderTarget;r&&(r._cleared=!1)}},t.prototype.resetDrawCache=function(e){if(this.meshes)for(var t=0,i=this.meshes;t<i.length;t++)i[t].resetDrawCache(e)},t.prototype.render=function(e,t){var i;if(void 0===e&&(e=!0),void 0===t&&(t=!1),!this.isDisposed){this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),null!=(i=this.activeCameras)&&i.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(var r=0,n=this._beforeCameraUpdateStage;r<n.length;r++)n[r].action();if(e)if(this.activeCameras&&0<this.activeCameras.length)for(var s=0;s<this.activeCameras.length;s++){var o=this.activeCameras[s];if(o.update(),0!==o.cameraRigMode)for(var a=0;a<o._rigCameras.length;a++)o._rigCameras[a].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(a=0;a<this.activeCamera._rigCameras.length;a++)this.activeCamera._rigCameras[a].update();this.onBeforeRenderObservable.notifyObservers(this);var h=this.getEngine(),l=(this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),null!=(i=this.activeCameras)&&i.length?this.activeCameras[0]:this.activeCamera);if(this.renderTargetsEnabled){Ht.StartPerformanceCounter("Custom render targets",0<this.customRenderTargets.length),this._intermediateRendering=!0;for(var c=0;c<this.customRenderTargets.length;c++){var u=this.customRenderTargets[c];if(u._shouldRender()){if(this._renderId++,this.activeCamera=u.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");h.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),u.render(l!==this.activeCamera,this.dumpNextRenderTargets)}}Ht.EndPerformanceCounter("Custom render targets",0<this.customRenderTargets.length),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=null!=(t=null==l?void 0:l.renderPassId)?t:0,this.activeCamera=l,this._activeCamera&&22!==this._activeCamera.cameraRigMode&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(var d=0,p=this._beforeClearStage;d<p.length;d++)p[d].action();this._clearFrameBuffer(this.activeCamera);for(var _=0,f=this._gatherRenderTargetsStage;_<f.length;_++)f[_].action(this._renderTargets);if(this.activeCameras&&0<this.activeCameras.length)for(s=0;s<this.activeCameras.length;s++)this._processSubCameras(this.activeCameras[s],0<s);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(var g=0,m=this._afterRenderStage;g<m.length;g++)m[g].action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(a=0;a<this._toBeDisposed.length;a++){var y=this._toBeDisposed[a];y&&y.dispose()}this._toBeDisposed=[]}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}},t.prototype.freezeMaterials=function(){for(var e=0;e<this.materials.length;e++)this.materials[e].freeze()},t.prototype.unfreezeMaterials=function(){for(var e=0;e<this.materials.length;e++)this.materials[e].unfreeze()},t.prototype.dispose=function(){if(!this.isDisposed){this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons=[],this.morphTargetManagers=[],this._transientComponents=[],this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed=[];for(var e=0,t=this._activeRequests.slice();e<t.length;e++)t[e].abort();if(this._activeRequests=[],this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onComputePressureChanged.clear(),null!=(r=this._computePressureObserver)&&r.unobserve(),this._computePressureObserver=void 0,this.detachControl(),this._engine.getInputElement())for(var i=0;i<this.cameras.length;i++)this.cameras[i].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,(function(e){return e.dispose(!0)})),this._disposeList(this.transformNodes,(function(e){return e.dispose(!0)})),this._disposeList(this.cameras),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);var r=this._engine.scenes.indexOf(this);-1<r&&this._engine.scenes.splice(r,1),ke._LastCreatedScene===this&&(0<this._engine.scenes.length?ke._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:ke._LastCreatedScene=null),-1<(r=this._engine._virtualScenes.indexOf(this))&&this._engine._virtualScenes.splice(r,1),this._engine.wipeCaches(!0),this._isDisposed=!0}},t.prototype._disposeList=function(e,t){t=null!=t?t:function(e){return e.dispose()};for(var i=0,r=e.slice(0);i<r.length;i++)t(r[i]);e.length=0},Object.defineProperty(t.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:!1,configurable:!0}),t.prototype.clearCachedVertexData=function(){for(var e=0;e<this.meshes.length;e++){var t=this.meshes[e].geometry;t&&t.clearCachedData()}},t.prototype.cleanCachedTextureBuffer=function(){for(var e=0,t=this.textures;e<t.length;e++){var i=t[e];i._buffer&&(i._buffer=null)}},t.prototype.getWorldExtends=function(e){var t=new ni(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new ni(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return this.meshes.filter(e=e||function(){return!0}).forEach((function(e){var r;e.computeWorldMatrix(!0),e.subMeshes&&0!==e.subMeshes.length&&!e.infiniteDistance&&(r=(e=e.getBoundingInfo()).boundingBox.minimumWorld,e=e.boundingBox.maximumWorld,ni.CheckExtends(r,t,i),ni.CheckExtends(e,t,i))})),{min:t,max:i}},t.prototype.createPickingRay=function(e,t,i,r,n){throw De("Ray")},t.prototype.createPickingRayToRef=function(e,t,i,r,n,s,o){throw De("Ray")},t.prototype.createPickingRayInCameraSpace=function(e,t,i){throw De("Ray")},t.prototype.createPickingRayInCameraSpaceToRef=function(e,t,i,r){throw De("Ray")},t.prototype.pick=function(e,t,i,r,n,s){var o=new Ui;return o._pickingUnavailable=!0,o},t.prototype.pickWithBoundingInfo=function(e,t,i,r,n){var s=new Ui;return s._pickingUnavailable=!0,s},t.prototype.pickWithRay=function(e,t,i,r){throw De("Ray")},t.prototype.multiPick=function(e,t,i,r,n){throw De("Ray")},t.prototype.multiPickWithRay=function(e,t,i){throw De("Ray")},t.prototype.setPointerOverMesh=function(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)},t.prototype.getPointerOverMesh=function(){return this._inputManager.getPointerOverMesh()},t.prototype._rebuildGeometries=function(){for(var e=0,t=this.geometries;e<t.length;e++)t[e]._rebuild();for(var i=0,r=this.meshes;i<r.length;i++)r[i]._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(var n=0,s=this._components;n<s.length;n++)s[n].rebuild();for(var o=0,a=this.particleSystems;o<a.length;o++)a[o].rebuild();if(this.spriteManagers)for(var h=0,l=this.spriteManagers;h<l.length;h++)l[h].rebuild()},t.prototype._rebuildTextures=function(){for(var e=0,t=this.textures;e<t.length;e++)t[e]._rebuild();this.markAllMaterialsAsDirty(1)},t.prototype._getByTags=function(e,t,i){if(void 0===t)return e;var r,n=[];for(r in i=i||function(e){},e){var s=e[r];Zt&&Zt.MatchesQuery(s,t)&&(n.push(s),i(s))}return n},t.prototype.getMeshesByTags=function(e,t){return this._getByTags(this.meshes,e,t)},t.prototype.getCamerasByTags=function(e,t){return this._getByTags(this.cameras,e,t)},t.prototype.getLightsByTags=function(e,t){return this._getByTags(this.lights,e,t)},t.prototype.getMaterialByTags=function(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))},t.prototype.getTransformNodesByTags=function(e,t){return this._getByTags(this.transformNodes,e,t)},t.prototype.setRenderingOrder=function(e,t,i,r){this._renderingManager.setRenderingOrder(e,t=void 0===t?null:t,i=void 0===i?null:i,r=void 0===r?null:r)},t.prototype.setRenderingAutoClearDepthStencil=function(e,t,i,r){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i=void 0===i||i,r=void 0===r||r)},t.prototype.getAutoClearDepthStencilSetup=function(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)},Object.defineProperty(t.prototype,"blockMaterialDirtyMechanism",{get:function(){return this._blockMaterialDirtyMechanism},set:function(e){this._blockMaterialDirtyMechanism===e||(this._blockMaterialDirtyMechanism=e)||this.markAllMaterialsAsDirty(63)},enumerable:!1,configurable:!0}),t.prototype.markAllMaterialsAsDirty=function(e,t){if(!this._blockMaterialDirtyMechanism)for(var i=0,r=this.materials;i<r.length;i++){var n=r[i];t&&!t(n)||n.markAsDirty(e)}},t.prototype._loadFile=function(e,t,i,r,n,s,o){var a=this;e=Dt(e,t,i,r?this.offlineProvider:void 0,n,s,o);return this._activeRequests.push(e),e.onCompleteObservable.add((function(e){a._activeRequests.splice(a._activeRequests.indexOf(e),1)})),e},t.prototype._loadFileAsync=function(e,t,i,r,n){var s=this;return new Promise((function(o,a){s._loadFile(e,(function(e){o(e)}),t,i,r,(function(e,t){a(t)}),n)}))},t.prototype._requestFile=function(e,t,i,r,n,s,o){var a=this;e=Lt(e,t,i,r?this.offlineProvider:void 0,n,s,o);return this._activeRequests.push(e),e.onCompleteObservable.add((function(e){a._activeRequests.splice(a._activeRequests.indexOf(e),1)})),e},t.prototype._requestFileAsync=function(e,t,i,r,n){var s=this;return new Promise((function(o,a){s._requestFile(e,(function(e){o(e)}),t,i,r,(function(e){a(e)}),n)}))},t.prototype._readFile=function(e,t,i,r,n){var s=this;e=Ft(e,t,i,r,n);return this._activeRequests.push(e),e.onCompleteObservable.add((function(e){s._activeRequests.splice(s._activeRequests.indexOf(e),1)})),e},t.prototype._readFileAsync=function(e,t,i){var r=this;return new Promise((function(n,s){r._readFile(e,(function(e){n(e)}),t,i,(function(e){s(e)}))}))},t.prototype.getPerfCollector=function(){throw De("performanceViewerSceneExtension")},t.FOGMODE_NONE=0,t.FOGMODE_EXP=1,t.FOGMODE_EXP2=2,t.FOGMODE_LINEAR=3,t.MinDeltaTime=1,t.MaxDeltaTime=1e3,t}(ui),mr=(gr.prototype.setActiveCameraByID=function(e){return this.setActiveCameraById(e)},gr.prototype.getLastMaterialByID=function(e){return this.getLastMaterialById(e)},gr.prototype.getMaterialByID=function(e){return this.getMaterialById(e)},gr.prototype.getTextureByUniqueID=function(e){return this.getTextureByUniqueId(e)},gr.prototype.getCameraByID=function(e){return this.getCameraById(e)},gr.prototype.getCameraByUniqueID=function(e){return this.getCameraByUniqueId(e)},gr.prototype.getBoneByID=function(e){return this.getBoneById(e)},gr.prototype.getLightByID=function(e){return this.getLightById(e)},gr.prototype.getLightByUniqueID=function(e){return this.getLightByUniqueId(e)},gr.prototype.getParticleSystemByID=function(e){return this.getParticleSystemById(e)},gr.prototype.getGeometryByID=function(e){return this.getGeometryById(e)},gr.prototype.getMeshByID=function(e){return this.getMeshById(e)},gr.prototype.getMeshesByID=function(e){return this.getMeshesById(e)},gr.prototype.getTransformNodeByID=function(e){return this.getTransformNodeById(e)},gr.prototype.getTransformNodeByUniqueID=function(e){return this.getTransformNodeByUniqueId(e)},gr.prototype.getTransformNodesByID=function(e){return this.getTransformNodesById(e)},gr.prototype.getMeshByUniqueID=function(e){return this.getMeshByUniqueId(e)},gr.prototype.getLastMeshByID=function(e){return this.getLastMeshById(e)},gr.prototype.getLastEntryByID=function(e){return this.getLastEntryById(e)},gr.prototype.getNodeByID=function(e){return this.getNodeById(e)},gr.prototype.getLastSkeletonByID=function(e){return this.getLastSkeletonById(e)},function(){function e(e){void 0===e&&(e=30),this._enabled=!0,this._rollingFrameTime=new yr(e)}return e.prototype.sampleFrame=function(e){var t;void 0===e&&(e=Fe.Now),this._enabled&&(null!=this._lastFrameTimeMs&&(t=e-this._lastFrameTimeMs,this._rollingFrameTime.add(t)),this._lastFrameTimeMs=e)},Object.defineProperty(e.prototype,"averageFrameTime",{get:function(){return this._rollingFrameTime.average},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"averageFrameTimeVariance",{get:function(){return this._rollingFrameTime.variance},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"instantaneousFrameTime",{get:function(){return this._rollingFrameTime.history(0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"averageFPS",{get:function(){return 1e3/this._rollingFrameTime.average},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"instantaneousFPS",{get:function(){var e=this._rollingFrameTime.history(0);return 0===e?0:1e3/e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isSaturated",{get:function(){return this._rollingFrameTime.isSaturated()},enumerable:!1,configurable:!0}),e.prototype.enable=function(){this._enabled=!0},e.prototype.disable=function(){this._enabled=!1,this._lastFrameTimeMs=null},Object.defineProperty(e.prototype,"isEnabled",{get:function(){return this._enabled},enumerable:!1,configurable:!0}),e.prototype.reset=function(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()},e}()),yr=function(){function e(e){this._samples=new Array(e),this.reset()}return e.prototype.add=function(e){var t,i;this.isSaturated()?(i=(t=this._samples[this._pos])-this.average,this.average-=i/(this._sampleCount-1),this._m2-=i*(t-this.average)):this._sampleCount++,i=e-this.average,this.average+=i/this._sampleCount,this._m2+=i*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length},e.prototype.history=function(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;var t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]},e.prototype.isSaturated=function(){return this._sampleCount>=this._samples.length},e.prototype.reset=function(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0},e.prototype._wrapPosition=function(e){var t=this._samples.length;return(e%t+t)%t},e}();Tt.prototype.setAlphaConstants=function(e,t,i,r){this._alphaState.setAlphaBlendConstants(e,t,i,r)},Tt.prototype.setAlphaMode=function(e,t){if(void 0===t&&(t=!1),this._alphaMode!==e){switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}t||(this.depthCullingState.depthMask=0===e),this._alphaMode=e}},Tt.prototype.getAlphaMode=function(){return this._alphaMode},Tt.prototype.setAlphaEquation=function(e){if(this._alphaEquation!==e){switch(e){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=e}},Tt.prototype.getAlphaEquation=function(){return this._alphaEquation},Tt.prototype._readTexturePixelsSync=function(e,t,i,r,n,s,o,a,h,l){void 0===r&&(r=-1),void 0===n&&(n=0),void 0===s&&(s=null),void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===h&&(h=0),void 0===l&&(l=0);var c=this._gl;if(!c)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){var u=c.createFramebuffer();if(!u)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=u}return c.bindFramebuffer(c.FRAMEBUFFER,this._dummyFramebuffer),-1<r?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+r,null==(u=e._hardwareTexture)?void 0:u.underlyingResource,n):c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,null==(r=e._hardwareTexture)?void 0:r.underlyingResource,n),u=void 0!==e.type?this._getWebGLTextureType(e.type):c.UNSIGNED_BYTE,a?s=s||function(e,t,i,r){switch(void 0===i&&(i=!1),e){case 3:ArrayBuffer;var n=new Int8Array(t);return r&&n.set(new Int8Array(r)),n;case 0:return ArrayBuffer,n=new Uint8Array(t),r&&n.set(new Uint8Array(r)),n;case 4:return n=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(i?t/2:t),r&&n.set(new Int16Array(r)),n;case 5:case 8:case 9:case 10:case 2:return n=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(i?t/2:t),r&&n.set(new Uint16Array(r)),n;case 6:return n=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(i?t/4:t),r&&n.set(new Int32Array(r)),n;case 7:case 11:case 12:case 13:case 14:case 15:return n=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(i?t/4:t),r&&n.set(new Uint32Array(r)),n;case 1:return n=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(i?t/4:t),r&&n.set(new Float32Array(r)),n}return ArrayBuffer,e=new Uint8Array(t),r&&e.set(new Uint8Array(r)),e}(e.type,4*t*i):u=u===c.UNSIGNED_BYTE?(s=s||new Uint8Array(4*t*i),c.UNSIGNED_BYTE):(s=s||new Float32Array(4*t*i),c.FLOAT),o&&this.flushFramebuffer(),c.readPixels(h,l,t,i,c.RGBA,u,s),c.bindFramebuffer(c.FRAMEBUFFER,this._currentFramebuffer),s},Tt.prototype._readTexturePixels=function(e,t,i,r,n,s,o,a,h,l){return void 0===r&&(r=-1),void 0===n&&(n=0),void 0===s&&(s=null),void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===h&&(h=0),void 0===l&&(l=0),Promise.resolve(this._readTexturePixelsSync(e,t,i,r,n,s,o,a,h,l))},Tt.prototype.updateDynamicIndexBuffer=function(e,t,i){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e),e=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},Tt.prototype.updateDynamicVertexBuffer=function(e,t,i,r){this.bindArrayBuffer(e),void 0===i&&(i=0),e=t.byteLength||t.length,void 0===r||e<=r&&0===i?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(i,i+r)):(t=t instanceof ArrayBuffer?new Uint8Array(t,i,r):new Uint8Array(t.buffer,t.byteOffset+i,r),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)),this._resetVertexBufferBinding()};var vr,br,wr,xr,Tr,Cr,Er=function(e){function t(i,r,n,s){var o,a,h=e.call(this,i,r,n,s=void 0!==s&&s)||this;return h.enableOfflineSupport=!1,h.disableManifestCheck=!1,h.scenes=new Array,h._virtualScenes=new Array,h.onNewSceneAddedObservable=new Ce,h.postProcesses=new Array,h.isPointerLock=!1,h.onResizeObservable=new Ce,h.onCanvasBlurObservable=new Ce,h.onCanvasFocusObservable=new Ce,h.onCanvasPointerOutObservable=new Ce,h.onBeginFrameObservable=new Ce,h.customAnimationFrameRequester=null,h.onEndFrameObservable=new Ce,h.onBeforeShaderCompilationObservable=new Ce,h.onAfterShaderCompilationObservable=new Ce,h._deterministicLockstep=!1,h._lockstepMaxSteps=4,h._timeStep=1/60,h._fps=60,h._deltaTime=0,h._drawCalls=new cr,h.canvasTabIndex=1,h.disablePerformanceMonitorInBackground=!1,h._performanceMonitor=new mr,h._compatibilityMode=!0,h.currentRenderPassId=0,h._renderPassNames=["main"],t.Instances.push(h),i&&(h._features.supportRenderPasses=!0,n=h._creationOptions,i.getContext&&(h._sharedInit(o=i,!!n.doNotHandleTouchAction,n.audioEngine),Ee()&&(a=document,h._onFullscreenChange=function(){void 0!==a.fullscreen?h.isFullscreen=a.fullscreen:void 0!==a.mozFullScreen?h.isFullscreen=a.mozFullScreen:void 0!==a.webkitIsFullScreen?h.isFullscreen=a.webkitIsFullScreen:void 0!==a.msIsFullScreen&&(h.isFullscreen=a.msIsFullScreen),h.isFullscreen&&h._pointerLockRequested&&o&&t._RequestPointerlock(o)},document.addEventListener("fullscreenchange",h._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",h._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",h._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",h._onFullscreenChange,!1),h._onPointerLockChange=function(){h.isPointerLock=a.mozPointerLockElement===o||a.webkitPointerLockElement===o||a.msPointerLockElement===o||a.pointerLockElement===o},document.addEventListener("pointerlockchange",h._onPointerLockChange,!1),document.addEventListener("mspointerlockchange",h._onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",h._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",h._onPointerLockChange,!1),!t.audioEngine&&n.audioEngine&&t.AudioEngineFactory&&(t.audioEngine=t.AudioEngineFactory(h.getRenderingCanvas(),h.getAudioContext(),h.getAudioDestination()))),h._connectVREvents(),h.enableOfflineSupport=void 0!==t.OfflineProviderFactory,h._deterministicLockstep=!!n.deterministicLockstep,h._lockstepMaxSteps=n.lockstepMaxSteps||0,h._timeStep=n.timeStep||1/60),h._prepareVRComponent(),n.autoEnableWebVR&&h.initWebVR()),h}return c(t,e),Object.defineProperty(t,"NpmPackage",{get:function(){return Tt.NpmPackage},enumerable:!1,configurable:!0}),Object.defineProperty(t,"Version",{get:function(){return Tt.Version},enumerable:!1,configurable:!0}),Object.defineProperty(t,"Instances",{get:function(){return ke.Instances},enumerable:!1,configurable:!0}),Object.defineProperty(t,"LastCreatedEngine",{get:function(){return ke.LastCreatedEngine},enumerable:!1,configurable:!0}),Object.defineProperty(t,"LastCreatedScene",{get:function(){return ke.LastCreatedScene},enumerable:!1,configurable:!0}),t.prototype._createImageBitmapFromSource=function(e,t){var i=this;return new Promise((function(r,n){var s=new Image;s.onload=function(){s.decode().then((function(){i.createImageBitmap(s,t).then((function(e){r(e)}))}))},s.onerror=function(){n("Error loading image ".concat(s.src))},s.src=e}))},t.prototype.createImageBitmap=function(e,t){return createImageBitmap(e,t)},t.prototype.resizeImageBitmap=function(e,t,i){var r=this.createCanvas(t,i).getContext("2d");if(r)return r.drawImage(e,0,0),r.getImageData(0,0,t,i).data;throw new Error("Unable to get 2d context for resizeImageBitmap")},t.MarkAllMaterialsAsDirty=function(e,i){for(var r=0;r<t.Instances.length;r++)for(var n=t.Instances[r],s=0;s<n.scenes.length;s++)n.scenes[s].markAllMaterialsAsDirty(e,i)},t.DefaultLoadingScreenFactory=function(e){throw De("LoadingScreen")},Object.defineProperty(t.prototype,"_supportsHardwareTextureRescaling",{get:function(){return!!t._RescalePostProcessFactory},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"performanceMonitor",{get:function(){return this._performanceMonitor},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"compatibilityMode",{get:function(){return this._compatibilityMode},set:function(e){this._compatibilityMode=!0},enumerable:!1,configurable:!0}),t.prototype.getInputElement=function(){return this._renderingCanvas},t.prototype._sharedInit=function(i,r,n){var s,o=this;e.prototype._sharedInit.call(this,i,r,n),this._onCanvasFocus=function(){o.onCanvasFocusObservable.notifyObservers(o)},this._onCanvasBlur=function(){o.onCanvasBlurObservable.notifyObservers(o)},i.addEventListener("focus",this._onCanvasFocus),i.addEventListener("blur",this._onCanvasBlur),this._onBlur=function(){o.disablePerformanceMonitorInBackground&&o._performanceMonitor.disable(),o._windowIsBackground=!0},this._onFocus=function(){o.disablePerformanceMonitorInBackground&&o._performanceMonitor.enable(),o._windowIsBackground=!1},this._onCanvasPointerOut=function(e){document.elementFromPoint(e.clientX,e.clientY)!==i&&o.onCanvasPointerOutObservable.notifyObservers(e)},Ee()&&(s=this.getHostWindow())&&(s.addEventListener("blur",this._onBlur),s.addEventListener("focus",this._onFocus)),i.addEventListener("pointerout",this._onCanvasPointerOut),r||this._disableTouchAction(),!t.audioEngine&&n&&t.AudioEngineFactory&&(t.audioEngine=t.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))},t.prototype.getAspectRatio=function(e,t){return e=e.viewport,this.getRenderWidth(t=void 0!==t&&t)*e.width/(this.getRenderHeight(t)*e.height)},t.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},t.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},t.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},t.prototype.isDeterministicLockStep=function(){return this._deterministicLockstep},t.prototype.getLockstepMaxSteps=function(){return this._lockstepMaxSteps},t.prototype.getTimeStep=function(){return 1e3*this._timeStep},t.prototype.generateMipMapsForCubemap=function(e,t){var i;void 0===t&&(t=!0),e.generateMipMaps&&(i=this._gl,this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null))},t.prototype.getDepthBuffer=function(){return this._depthCullingState.depthTest},t.prototype.setDepthBuffer=function(e){this._depthCullingState.depthTest=e},t.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},t.prototype.setDepthWrite=function(e){this._depthCullingState.depthMask=e},t.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},t.prototype.setStencilBuffer=function(e){this._stencilState.stencilTest=e},t.prototype.getStencilMask=function(){return this._stencilState.stencilMask},t.prototype.setStencilMask=function(e){this._stencilState.stencilMask=e},t.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},t.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},t.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},t.prototype.setStencilFunction=function(e){this._stencilState.stencilFunc=e},t.prototype.setStencilFunctionReference=function(e){this._stencilState.stencilFuncRef=e},t.prototype.setStencilFunctionMask=function(e){this._stencilState.stencilFuncMask=e},t.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},t.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},t.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},t.prototype.setStencilOperationFail=function(e){this._stencilState.stencilOpStencilFail=e},t.prototype.setStencilOperationDepthFail=function(e){this._stencilState.stencilOpDepthFail=e},t.prototype.setStencilOperationPass=function(e){this._stencilState.stencilOpStencilDepthPass=e},t.prototype.setDitheringState=function(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)},t.prototype.setRasterizerState=function(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)},t.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},t.prototype.setDepthFunction=function(e){this._depthCullingState.depthFunc=e},t.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},t.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},t.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},t.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},t.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},t.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},t.prototype.setDirectViewport=function(e,t,i,r){var n=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,r),n},t.prototype.scissorClear=function(e,t,i,r,n){this.enableScissor(e,t,i,r),this.clear(n,!0,!0,!0),this.disableScissor()},t.prototype.enableScissor=function(e,t,i,r){var n=this._gl;n.enable(n.SCISSOR_TEST),n.scissor(e,t,i,r)},t.prototype.disableScissor=function(){var e=this._gl;e.disable(e.SCISSOR_TEST)},t.prototype._reportDrawCall=function(e){this._drawCalls.addCount(e=void 0===e?1:e,!1)},t.prototype.initWebVR=function(){throw De("WebVRCamera")},t.prototype._prepareVRComponent=function(){},t.prototype._connectVREvents=function(e,t){},t.prototype._submitVRFrame=function(){},t.prototype.disableVR=function(){},t.prototype.isVRPresenting=function(){return!1},t.prototype._requestVRFrame=function(){},t.prototype._loadFileAsync=function(e,t,i){var r=this;return new Promise((function(n,s){r._loadFile(e,(function(e){n(e)}),void 0,t,i,(function(e,t){s(t)}))}))},t.prototype.getVertexShaderSource=function(e){return(e=this._gl.getAttachedShaders(e))?this._gl.getShaderSource(e[0]):null},t.prototype.getFragmentShaderSource=function(e){return(e=this._gl.getAttachedShaders(e))?this._gl.getShaderSource(e[1]):null},t.prototype.setDepthStencilTexture=function(e,t,i,r){void 0!==e&&(t&&(this._boundUniforms[e]=t),i&&i.depthStencilTexture?this._setTexture(e,i,!1,!0,r):this._setTexture(e,null,void 0,void 0,r))},t.prototype.setTextureFromPostProcess=function(e,t,i){var r=null;t&&(t._textures.data[t._currentRenderTextureInd]?r=t._textures.data[t._currentRenderTextureInd]:t._forcedOutputTexture&&(r=t._forcedOutputTexture)),this._bindTexture(e,null!=(t=null==r?void 0:r.texture)?t:null,i)},t.prototype.setTextureFromPostProcessOutput=function(e,t,i){this._bindTexture(e,null!=(t=null==(e=null==t?void 0:t._outputTexture)?void 0:e.texture)?t:null,i)},t.prototype._rebuildBuffers=function(){for(var t=0,i=this.scenes;t<i.length;t++)(r=i[t]).resetCachedMaterial(),r._rebuildGeometries(),r._rebuildTextures();for(var r,n=0,s=this._virtualScenes;n<s.length;n++)(r=s[n]).resetCachedMaterial(),r._rebuildGeometries(),r._rebuildTextures();e.prototype._rebuildBuffers.call(this)},t.prototype._renderFrame=function(){for(var e=0;e<this._activeRenderLoops.length;e++)(0,this._activeRenderLoops[e])()},t.prototype._renderLoop=function(){var e;this._contextWasLost||(e=!0,(e=!(!this.renderEvenInBackground&&this._windowIsBackground)&&e)&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())),0<this._activeRenderLoops.length?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1},t.prototype._renderViews=function(){return!1},t.prototype.switchFullscreen=function(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)},t.prototype.enterFullscreen=function(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&t._RequestFullscreen(this._renderingCanvas))},t.prototype.exitFullscreen=function(){this.isFullscreen&&t._ExitFullscreen()},t.prototype.enterPointerlock=function(){this._renderingCanvas&&t._RequestPointerlock(this._renderingCanvas)},t.prototype.exitPointerlock=function(){t._ExitPointerlock()},t.prototype.beginFrame=function(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),e.prototype.beginFrame.call(this)},t.prototype.endFrame=function(){e.prototype.endFrame.call(this),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)},t.prototype.resize=function(t){void 0===t&&(t=!1),this.isVRPresenting()||e.prototype.resize.call(this,t)},t.prototype.setSize=function(t,i,r){if(!this._renderingCanvas)return!1;if(!e.prototype.setSize.call(this,t,i,r=void 0!==r&&r))return!1;if(this.scenes){for(var n=0;n<this.scenes.length;n++)for(var s=this.scenes[n],o=0;o<s.cameras.length;o++)s.cameras[o]._currentRenderId=0;this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0},t.prototype._deletePipelineContext=function(t){var i=t;i&&i.program&&i.transformFeedback&&(this.deleteTransformFeedback(i.transformFeedback),i.transformFeedback=null),e.prototype._deletePipelineContext.call(this,t)},t.prototype.createShaderProgram=function(t,i,r,n,s,o){return void 0===o&&(o=null),s=s||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this),t=e.prototype.createShaderProgram.call(this,t,i,r,n,s,o),this.onAfterShaderCompilationObservable.notifyObservers(this),t},t.prototype._createShaderProgram=function(e,t,i,r,n){void 0===n&&(n=null);var s,o=r.createProgram();if(e.program=o)return r.attachShader(o,t),r.attachShader(o,i),1<this.webGLVersion&&n&&(s=this.createTransformFeedback(),this.bindTransformFeedback(s),this.setTranformFeedbackVaryings(o,n),e.transformFeedback=s),r.linkProgram(o),1<this.webGLVersion&&n&&this.bindTransformFeedback(null),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),o;throw new Error("Unable to create program")},t.prototype._releaseTexture=function(t){e.prototype._releaseTexture.call(this,t)},t.prototype._releaseRenderTargetWrapper=function(t){e.prototype._releaseRenderTargetWrapper.call(this,t),this.scenes.forEach((function(e){e.postProcesses.forEach((function(e){e._outputTexture===t&&(e._outputTexture=null)})),e.cameras.forEach((function(e){e._postProcesses.forEach((function(e){e&&e._outputTexture===t&&(e._outputTexture=null)}))}))}))},t.prototype.getRenderPassNames=function(){return this._renderPassNames},t.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},t.prototype.createRenderPassId=function(e){var i=++t._RenderPassIdCounter;return this._renderPassNames[i]=null!=e?e:"NONAME",i},t.prototype.releaseRenderPassId=function(e){this._renderPassNames[e]=void 0;for(var t=0;t<this.scenes.length;++t)for(var i=this.scenes[t],r=0;r<i.meshes.length;++r){var n=i.meshes[r];if(n.subMeshes)for(var s=0;s<n.subMeshes.length;++s)n.subMeshes[s]._removeDrawWrapper(e)}},t.prototype._rescaleTexture=function(e,i,r,n,s){var o=this,a=(this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE),this.createRenderTargetTexture({width:i.width,height:i.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1}));!this._rescalePostProcess&&t._RescalePostProcessFactory&&(this._rescalePostProcess=t._RescalePostProcessFactory(this)),this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled((function(){o._rescalePostProcess.onApply=function(t){t._bindTexture("textureSampler",e)},(r||o.scenes[o.scenes.length-1]).postProcessManager.directRender([o._rescalePostProcess],a,!0),o._bindTextureDirectly(o._gl.TEXTURE_2D,i,!0),o._gl.copyTexImage2D(o._gl.TEXTURE_2D,0,n,0,0,i.width,i.height,0),o.unBindFramebuffer(a),a.dispose(),s&&s()}))},t.prototype.getFps=function(){return this._fps},t.prototype.getDeltaTime=function(){return this._deltaTime},t.prototype._measureFps=function(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0},t.prototype.wrapWebGLTexture=function(e){e=new vt(e,this._gl);var t=new dt(this,Be.Unknown,!0);return t._hardwareTexture=e,t.isReady=!0,t},t.prototype._uploadImageToTexture=function(e,t,i,r){void 0===i&&(i=0),void 0===r&&(r=0);var n=this._gl,s=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),a=this._getRGBABufferInternalSizedFormat(e.type,o),h=e.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D,l=(this._bindTextureDirectly(h,e,!0),this._unpackFlipY(e.invertY),n.TEXTURE_2D);e.isCube&&(l=n.TEXTURE_CUBE_MAP_POSITIVE_X+i),n.texImage2D(l,r,a,o,s,t),this._bindTextureDirectly(h,null,!0)},t.prototype.updateTextureComparisonFunction=function(e,t){var i;1===this.webGLVersion?Me.Error("WebGL 1 does not support texture comparison."):(i=this._gl,e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),0===t?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),0===t?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t)},t.prototype.createInstancesBuffer=function(e){var t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");return(t=new gt(t)).capacity=e,this.bindArrayBuffer(t),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),t.references=1,t},t.prototype.deleteInstancesBuffer=function(e){this._gl.deleteBuffer(e)},t.prototype._clientWaitAsync=function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=10);var r=this._gl;return new Promise((function(n,s){!function o(){var a=r.clientWaitSync(e,t,0);a==r.WAIT_FAILED?s():a==r.TIMEOUT_EXPIRED?setTimeout(o,i):n()}()}))},t.prototype._readPixelsAsync=function(e,t,i,r,n,s,o){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");var a=this._gl,h=a.createBuffer(),l=(a.bindBuffer(a.PIXEL_PACK_BUFFER,h),a.bufferData(a.PIXEL_PACK_BUFFER,o.byteLength,a.STREAM_READ),a.readPixels(e,t,i,r,n,s,0),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0));return l?(a.flush(),this._clientWaitAsync(l,0,10).then((function(){return a.deleteSync(l),a.bindBuffer(a.PIXEL_PACK_BUFFER,h),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,o),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),a.deleteBuffer(h),o}))):null},t.prototype.dispose=function(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();1===t.Instances.length&&t.audioEngine&&(t.audioEngine.dispose(),t.audioEngine=null),this.disableVR(),Ee()&&(window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut)),Pe()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange))),e.prototype.dispose.call(this);var i=t.Instances.indexOf(this);0<=i&&t.Instances.splice(i,1),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()},t.prototype._disableTouchAction=function(){this._renderingCanvas&&this._renderingCanvas.setAttribute&&(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.msTouchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")},t.prototype.displayLoadingUI=function(){var e;!Ee()||(e=this.loadingScreen)&&e.displayLoadingUI()},t.prototype.hideLoadingUI=function(){var e;!Ee()||(e=this._loadingScreen)&&e.hideLoadingUI()},Object.defineProperty(t.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=t.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(e){this._loadingScreen=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loadingUIText",{set:function(e){this.loadingScreen.loadingUIText=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loadingUIBackgroundColor",{set:function(e){this.loadingScreen.loadingUIBackgroundColor=e},enumerable:!1,configurable:!0}),t.prototype.createVideoElement=function(e){return document.createElement("video")},t._RequestPointerlock=function(e){e.requestPointerLock=e.requestPointerLock||e.msRequestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,e.requestPointerLock&&(e.requestPointerLock(),e.focus())},t._ExitPointerlock=function(){var e=document;document.exitPointerLock=document.exitPointerLock||e.msExitPointerLock||e.mozExitPointerLock||e.webkitExitPointerLock,document.exitPointerLock&&document.exitPointerLock()},t._RequestFullscreen=function(e){var t=e.requestFullscreen||e.msRequestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen;t&&t.call(e)},t._ExitFullscreen=function(){var e=document;document.exitFullscreen?document.exitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.webkitCancelFullScreen?e.webkitCancelFullScreen():e.msCancelFullScreen&&e.msCancelFullScreen()},t.prototype.getFontOffset=function(e){var t=document.createElement("span"),i=((e=(t.innerHTML="Hg",t.setAttribute("style","font: ".concat(e," !important")),document.createElement("div"))).style.display="inline-block",e.style.width="1px",e.style.height="0px",e.style.verticalAlign="bottom",document.createElement("div")),r=(i.style.whiteSpace="nowrap",i.appendChild(t),i.appendChild(e),document.body.appendChild(i),0),n=0;try{n=e.getBoundingClientRect().top-t.getBoundingClientRect().top,e.style.verticalAlign="baseline",r=e.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(i)}return{ascent:r,height:n,descent:n-r}},t.ALPHA_DISABLE=0,t.ALPHA_ADD=1,t.ALPHA_COMBINE=2,t.ALPHA_SUBTRACT=3,t.ALPHA_MULTIPLY=4,t.ALPHA_MAXIMIZED=5,t.ALPHA_ONEONE=6,t.ALPHA_PREMULTIPLIED=7,t.ALPHA_PREMULTIPLIED_PORTERDUFF=8,t.ALPHA_INTERPOLATE=9,t.ALPHA_SCREENMODE=10,t.DELAYLOADSTATE_NONE=0,t.DELAYLOADSTATE_LOADED=1,t.DELAYLOADSTATE_LOADING=2,t.DELAYLOADSTATE_NOTLOADED=4,t.NEVER=512,t.ALWAYS=519,t.LESS=513,t.EQUAL=514,t.LEQUAL=515,t.GREATER=516,t.GEQUAL=518,t.NOTEQUAL=517,t.KEEP=7680,t.REPLACE=7681,t.INCR=7682,t.DECR=7683,t.INVERT=5386,t.INCR_WRAP=34055,t.DECR_WRAP=34056,t.TEXTURE_CLAMP_ADDRESSMODE=0,t.TEXTURE_WRAP_ADDRESSMODE=1,t.TEXTURE_MIRROR_ADDRESSMODE=2,t.TEXTUREFORMAT_ALPHA=0,t.TEXTUREFORMAT_LUMINANCE=1,t.TEXTUREFORMAT_LUMINANCE_ALPHA=2,t.TEXTUREFORMAT_RGB=4,t.TEXTUREFORMAT_RGBA=5,t.TEXTUREFORMAT_RED=6,t.TEXTUREFORMAT_R=6,t.TEXTUREFORMAT_RG=7,t.TEXTUREFORMAT_RED_INTEGER=8,t.TEXTUREFORMAT_R_INTEGER=8,t.TEXTUREFORMAT_RG_INTEGER=9,t.TEXTUREFORMAT_RGB_INTEGER=10,t.TEXTUREFORMAT_RGBA_INTEGER=11,t.TEXTURETYPE_UNSIGNED_BYTE=0,t.TEXTURETYPE_UNSIGNED_INT=0,t.TEXTURETYPE_FLOAT=1,t.TEXTURETYPE_HALF_FLOAT=2,t.TEXTURETYPE_BYTE=3,t.TEXTURETYPE_SHORT=4,t.TEXTURETYPE_UNSIGNED_SHORT=5,t.TEXTURETYPE_INT=6,t.TEXTURETYPE_UNSIGNED_INTEGER=7,t.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,t.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,t.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,t.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,t.TEXTURETYPE_UNSIGNED_INT_24_8=12,t.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,t.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,t.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,t.TEXTURE_NEAREST_SAMPLINGMODE=1,t.TEXTURE_BILINEAR_SAMPLINGMODE=2,t.TEXTURE_TRILINEAR_SAMPLINGMODE=3,t.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,t.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,t.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,t.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,t.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,t.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,t.TEXTURE_NEAREST_LINEAR=7,t.TEXTURE_NEAREST_NEAREST=1,t.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,t.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,t.TEXTURE_LINEAR_LINEAR=2,t.TEXTURE_LINEAR_NEAREST=12,t.TEXTURE_EXPLICIT_MODE=0,t.TEXTURE_SPHERICAL_MODE=1,t.TEXTURE_PLANAR_MODE=2,t.TEXTURE_CUBIC_MODE=3,t.TEXTURE_PROJECTION_MODE=4,t.TEXTURE_SKYBOX_MODE=5,t.TEXTURE_INVCUBIC_MODE=6,t.TEXTURE_EQUIRECTANGULAR_MODE=7,t.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,t.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,t.SCALEMODE_FLOOR=1,t.SCALEMODE_NEAREST=2,t.SCALEMODE_CEILING=3,t._RescalePostProcessFactory=null,t._RenderPassIdCounter=0,t}(Tt),Sr=(Object.defineProperty(gr.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new Sr(this)),this._debugLayer},enumerable:!0,configurable:!0}),function(e){e[e.Properties=0]="Properties",e[e.Debug=1]="Debug",e[e.Statistics=2]="Statistics",e[e.Tools=3]="Tools",e[e.Settings=4]="Settings"}(vr=vr||{}),function(){function e(e){var t=this;this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||ke.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add((function(){t._scene._debugLayer&&t._scene._debugLayer.hide()}))}return Object.defineProperty(e.prototype,"onPropertyChangedObservable",{get:function(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new Ce),this._onPropertyChangedObservable)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onSelectionChangedObservable",{get:function(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new Ce),this._onSelectionChangedObservable)},enumerable:!1,configurable:!0}),e.prototype._createInspector=function(e){if(!this.isVisible()){if(this._onPropertyChangedObservable){for(var t=0,i=this._onPropertyChangedObservable.observers;t<i.length;t++){var r=i[t];this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(r)}this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(var n=0,s=this._onSelectionChangedObservable.observers;n<s.length;n++)r=s[n],this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(r);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}e=m({overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0},e),this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,e)}},e.prototype.select=function(e,t){this.BJSINSPECTOR&&(t&&("[object String]"==Object.prototype.toString.call(t)?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))},e.prototype._getGlobalInspector=function(){return"undefined"!=typeof INSPECTOR?INSPECTOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.Inspector?BABYLON:void 0},e.prototype.isVisible=function(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible},e.prototype.hide=function(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()},e.prototype.setAsActiveScene=function(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)},e.prototype.show=function(t){var i=this;return new Promise((function(r){var n;void 0===i.BJSINSPECTOR?(n=t&&t.inspectorURL?t.inspectorURL:e.InspectorURL,Ht.LoadScript(n,(function(){i._createInspector(t),r(i)}))):(i._createInspector(t),r(i))}))},e.InspectorURL="https://unpkg.com/babylonjs-inspector@".concat(Er.Version,"/babylon.inspector.bundle.js"),e}());function Pr(e,t,i,...r){if(t=e[Mr(t,i)])for(var n of t)if(n.call(e,...r))return}function Rr(e){return function(t,i,r){var n=Mr(i=Ar(t,i),e);!function(e,t){var i=Symbol.for("__aopinit__"+t);if(!e.hasOwnProperty(i)){e[i]=!0;let r=e[t];e[t]=function(...i){Pr(e,t,br.begin,...i);var n=r.call(e,...i);return i.push(n),Pr(e,t,br.end,...i),n}}}(t,i);let s=function(e,t){return e.hasOwnProperty(t)||(e[t]=[]),e[t]}(t,n);return s.unshift(r),s.length,function(){var e=s.indexOf(r);-1!==e&&s.splice(e,1)}}}function Ar(e,t){if(t.name)return t.name;for(var i in e)if(e[i]===t)return i}function Mr(e,t){return Symbol.for(t+e)}!function(e){e.begin="__begin__",e.end="__end__"}(br=br||{});const Or=Rr(br.begin),Ir=Rr(br.end),Fr="_isProxy",Dr=(e,t,i,r=!1)=>{Object.defineProperty(e,t,{set:function(e){if(e instanceof Array)if(this[i]){let t=this[i];t.length=0,t.push(...e)}else e[Fr]?this[i]=e:this[i]=new Proxy(e,{set:(e,t,i,n)=>(Reflect.get(e,t,n)!==i&&this.writeSnapshoot(),e=Reflect.set(e,t,i,n),r&&this.update(),e),get:(e,t,i)=>t===Fr||("splice"!==t&&"pop"!==t&&"shift"!==t||this.writeSnapshoot(),Reflect.get(e,t,i))});else this[i]!==e&&(this.writeSnapshoot(),this[i]=e,r&&this.update())},get:function(){return this[i]},enumerable:!0,configurable:!0})};function Lr(e,t,i){Dr(e,t,"__"+t,!0)}function Br(e,t,i){Dr(e,t,"__"+t,!1)}let Nr=class extends _e{constructor(){super(),this.data={},this.initData(),this.entitys=this.initComponents()}getData(){return{}}get IsComponent(){return!0}get AnimationNames(){const e=super.AnimationNames;for(const t of this.entitys)e.push(...t.AnimationNames);return e}get BoundingBox(){var{min:e,max:t}=this.BoundingVectors;return new w(e,t)}startAnimates(e,t){super.startAnimates(e,t);for(const i of this.entitys)i.startAnimates(e,t)}stopAnimates(e){super.stopAnimates(e);for(const t of this.entitys)t.stopAnimates(e)}initData(e){const t=this;this.data=new Proxy(null!=e?e:this.getData(),{get:(e,t)=>e[t],set(e,i,r){var n=e.hasOwnProperty(i)&&r!==e[i];return t.writeSnapshoot(),e[i]=r,n&&(t.play(),t.update(),t.trigger({type:"change",target:this,key:i})),!0}})}initComponents(){return[]}initDrawObject(e){var t=new n.Mesh(this.UniqueName,_e.Scene);return this.updateDrawObject(e,t),this.watchLoad().then((e=>{this.play(),this.mounted()})).catch((e=>{this.componentCatch(e)})),t}updateDrawObject(e,t){for(var i of this.entitys){i.isPart=!0;let r=i.GetDrawObjectFromRenderType(e);r&&(i.updatePart(),r.parent=t)}}updateMaterial(){this.entitys.forEach((e=>e.updateMaterial()))}play(){}mounted(){}componentCatch(e){}destory(){super.destory();for(const e of this.entitys)e.destory()}writeFile(e){super.writeFile(e),e.write(1),e.write(JSON.stringify(Object.assign({},this.data))),e.write(this.entitys.length);for(const t of this.entitys)e.writeObject(t)}readFile(e){super.readFile(e),e.read();var t=e.read(),i=(this.initData(JSON.parse(t)),e.read());for(const e of this.entitys)e.destory();for(let t=this.entitys.length=0;t<i;t++){var r=e.readObject();this.entitys.push(r)}this.update(),this.watchLoad().then((e=>{this.play()}))}watchLoad(){const e=[];for(const t of this.entitys)t.isAsync&&e.push(new Promise((e=>{t.on("load",(()=>e(!0)))})));return Promise.all(e)}};Nr.type="Component",Nr.component=!0,Nr=y([E],Nr);class kr{constructor(){this.IsContainer=!1,this.startTime=0}get Type(){return this.constructor.type}do(){return null}destory(){}fromJSON(e){}readFile(e){}writeFile(e){}}kr.schema={};class Ur extends L{constructor(){super(...arguments),this._name=""}get Name(){return this._name}set Name(e){this._name=e}}class zr extends Ur{constructor(){super(),this._isLoading=!1,this.wrapU=n.Texture.WRAP_ADDRESSMODE,this.wrapV=n.Texture.WRAP_ADDRESSMODE,this.scale=[1,1],this.rotation=[0,0,0],this.offset=[0,0]}get Texture(){return this.texture}getTexture(){return v(this,void 0,void 0,(function*(){return this.texture}))}get Scale(){return this.scale}set Scale(e){e[0]===this.scale[0]&&e[1]===this.scale[1]||(this.writeSnapshoot(),this.scale=e,this.update())}get Offset(){return this.scale}set Offset(e){e[0]===this.offset[0]&&e[1]===this.offset[1]||(this.writeSnapshoot(),this.offset=e,this.update())}get Rotation(){return this.rotation}set Rotation(e){e[0]===this.rotation[0]&&e[1]===this.rotation[1]&&e[2]===this.rotation[2]||(this.writeSnapshoot(),this.rotation=e,this.update())}update(){this.texture&&(this.texture.name=this._name,this.texture.wrapU=this.wrapU,this.texture.wrapV=this.wrapV)}writeFile(e){super.writeFile(e),e.write(1),e.write(this.wrapU),e.write(this.wrapV),e.write(this.scale[0]),e.write(this.scale[1]),e.write(this.rotation[0]),e.write(this.rotation[1]),e.write(this.rotation[2]),e.write(this.offset[0]),e.write(this.offset[1])}readFile(e){super.readFile(e),e.read(),this.wrapU=e.read(),this.wrapV=e.read(),this.scale[0]=e.read(),this.scale[1]=e.read(),this.rotation[0]=e.read(),this.rotation[1]=e.read(),this.rotation[2]=e.read(),this.offset[0]=e.read(),this.offset[1]=e.read()}}(wr=wr||{}).SelectMarquee="32";class Gr{constructor(e){this.start=new n.Vector2,this.end=new n.Vector2,this.selectType=X.None,this.rightColor="rgba(225, 240, 255, 0.5)",this.leftColor="rgba(225, 240, 255, 0.4)",this.rightBorder="1px dashed rgb(179, 179, 245)",this.leftBorder="1px solid rgb(179, 179, 245)",this.dom=document.createElement("div"),e.appendChild(this.dom);let t=this.dom.style;t.position="absolute",t.zIndex=wr.SelectMarquee,t.background="rgba(0, 63, 255, 0.2)",t.margin="0",t.pointerEvents="none",t.top="460px",t.left="100px",t.width="100px",t.height="200px",t.display="none",t.border=this.leftBorder}show(){this.dom.style.display="block"}hide(){this.dom.style.display="none"}update(){this.dom.style.top=Math.min(this.start.y,this.end.y)+"px",this.dom.style.left=Math.min(this.start.x,this.end.x)+"px",this.width=Math.abs(this.start.x-this.end.x),this.height=Math.abs(this.start.y-this.end.y),this.dom.style.width=this.width+"px",this.dom.style.height=this.height+"px";let e=this.selectType;(e=this.selectType===X.None?this.start.x>this.end.x?X.C:X.W:e)===X.C?(this.dom.style.background=this.leftColor,this.dom.style.border=this.leftBorder):(this.dom.style.background=this.rightColor,this.dom.style.border=this.rightBorder)}setStart(e,t){this.start.set(e,t)}setEnd(e,t){this.end.set(e,t),this.update()}}class Vr extends class{constructor(e){this._viewer=e,this.selectList=new Set}get Plane(){if(this._tempPlane)return this._tempPlane;const e=n.MeshBuilder.CreatePlane("get-point",{size:1e3});return e.setEnabled(!1),this._tempPlane=e}select(e){}destoryTempPlane(){this._tempPlane&&(this._tempPlane.dispose(),this._tempPlane=null)}world2screen(e){return n.Vector3.Project(e,n.Matrix.IdentityReadOnly,this._viewer.Scene.getTransformMatrix(),this._viewer.Camera.viewport.toGlobal(this._viewer.Scene.getEngine().getRenderWidth(),this._viewer.Scene.getEngine().getRenderHeight()))}screen2World(e,t=!0){const i=this._viewer.Scene.createPickingRay(e.x,e.y,this._viewer.Scene.getViewMatrix(),this._viewer.cameraManager.Camera,!0);return this._viewer.ground&&(this._viewer.ground.isPickable=!0),e=i.intersectsMesh(this._viewer.ground||this.Plane),this._viewer.ground&&(this._viewer.ground.isPickable=!1),t&&this.destoryTempPlane(),e.hit?e.pickedPoint:null}get SelectEntitys(){const e=[];for(const t of this.selectList)e.push(t.metadata.Entity);return e}get SelectMeshs(){return[...this.selectList]}}{constructor(e,t,i){super(e),this._Viewer=e,this.start=t,this.end=i}select(e){for(const t of e=null!=e?e:this._Viewer.Scene.rootNodes)this.targetIsSelect(t)&&this.selectList.add(t)}targetIsSelect(e){if(null==(t=null==(t=e.metadata)?void 0:t.Entity)||!t.Visiable)return!1;if(null==(t=null==(t=e.metadata)?void 0:t.Entity)||!t.IsPickable)return!1;if("WORLD_GROUND"===e.name)return!1;if(this._SelectType===X.None)return!1;var t=this.start,i=this.end,r=Math.min(t.x,i.x),s=Math.min(t.y,i.y),o=Math.max(t.x,i.x),a=Math.max(t.y,i.y);for(const t of e.getChildMeshes())if(t.geometry){var h=t.geometry._vertexBuffers.position.getData();for(let e=0;e<h.length;e+=3){var l=new n.Vector3(h[e],h[e+1],h[e+2]);if((l=(n.Vector3.TransformCoordinatesToRef(l,t.getWorldMatrix(),l),this.world2screen(l))).x>=r&&l.x<=o&&l.y>=s&&l.y<=a)return!0}}return!1}}class jr{constructor(){this._selectSetList=new Set}get SelectMeshs(){return[...this._selectSetList]}get SelectEntitys(){return this.SelectMeshs.map((e=>e.metadata.Entity))}add(e){e.forEach((e=>this._selectSetList.add(e)))}addEns(e){e.forEach((e=>this._selectSetList.add(e.DrawObject)))}remove(){}clear(){this._selectSetList.forEach((e=>{var t;null!=(t=e.metadata)&&t.Entity&&(e.metadata.Entity.IsSelect=!1)})),this._selectSetList.clear()}}class Wr{constructor(e){this._viewer=e,this.selectSet=new jr,this.doing=!1,this.selectObserable=new n.Observable,this._SelectType=X.None,this.selectMarquee=new Gr(e.canvas.parentElement),this._registerEvent()}set SelectType(e){this._SelectType=e,this.selectMarquee.selectType=e}set SelectEntitys(e){this.clearSelect();const t=new jr;t.addEns(e),this.selectSet=t,this.update()}get SelectMeshs(){return this._selectGui||this._selectDOM?[]:this.selectSet.SelectMeshs}get SelectObjects(){return this._selectGui?[this._selectGui]:this._selectDOM?[this._selectDOM]:this._selectParticle?[this._selectParticle]:this.selectSet.SelectEntitys}onPointerDown(e){var t;if(0===e.event.button){if(this.clearSelect(),e.pickInfo.pickedMesh&&null!=(t=(e=k(e.pickInfo.pickedMesh)).metadata)&&t.Entity)return this.selectSet.add([e]),void this.update();this.doing=!0,this.selectMarquee.show(),this.selectMarquee.setStart(this._viewer.Scene.pointerX,this._viewer.Scene.pointerY),this.selectMarquee.setEnd(this._viewer.Scene.pointerX,this._viewer.Scene.pointerY),this.selectMarquee.update()}}onPointerMove(e){var t;!this.doing||null!=(t=this.SelectGui)&&t.Draging||(this.selectMarquee.setEnd(this._viewer.Scene.pointerX,this._viewer.Scene.pointerY),this._SelectType=this.selectMarquee.end.x>this.selectMarquee.start.x?X.W:X.C)}onPointerUp(e){0===e.event.button&&this.doing&&(this.doing=!1,this.selectMarquee.hide(),this.selectByMarquee())}clearSelect(e=!1){this._selectGui&&(this._selectGui.IsSelect=!1,this._selectGui=null),this._selectParticle&&(this._selectParticle.IsSelect=!1,this._selectParticle=null),this._selectDOM&&(this._selectDOM.IsSelect=!1,this._selectDOM=null),this._viewer.highlightManager.clear(),this.selectSet.clear(),e&&this.update()}on(e){const t=this.selectObserable.add(e);return()=>{this.selectObserable.remove(t)}}update(){this.selectSet.SelectEntitys.forEach((e=>e.IsSelect=!0)),this._viewer.highlightManager.addMeshs(this.selectSet.SelectMeshs),this.selectObserable.notifyObservers({type:"select",meshs:this.SelectMeshs,entitys:this.SelectObjects})}get SelectParticle(){return this._selectParticle}set SelectParticle(e){this.clearSelect(),(this._selectParticle=e).IsSelect=!0,this.update()}get SelectGui(){return this._selectGui}set SelectGui(e){this.clearSelect(),(this._selectGui=e).IsSelect=!0,this.update()}get SelectDOM(){return this._selectDOM}set SelectDOM(e){this.clearSelect(),(this._selectDOM=e).IsSelect=!0,this.update()}selectByMarquee(){const e=new Vr(this._viewer,this.selectMarquee.start,this.selectMarquee.end);e._SelectType=this._SelectType,e.select(),this.selectSet.add(e.SelectMeshs),this.update()}_registerEvent(){this._viewer.Scene.onPointerObservable.add((e=>{var t;switch(e.type){case n.PointerEventTypes.POINTERDOWN:this.onPointerDown(e);break;case n.PointerEventTypes.POINTERUP:this.onPointerUp(e);break;case n.PointerEventTypes.POINTERMOVE:null!=(t=this.SelectGui)&&t.Draging?this.SelectGui.drag({x:e.event.offsetX,y:e.event.offsetY}):this.onPointerMove(e)}})),this._viewer.canvas.parentElement.addEventListener("mousemove",(e=>{var t;null!=(t=this.SelectDOM)&&t.Draging&&this.SelectDOM.move(e.clientX,e.clientY)})),he.on("pointerDownGui",(e=>{this.SelectGui=e.target})),document.addEventListener("mouseup",(()=>{var e;null!=(e=this.SelectDOM)&&e.Draging&&this.SelectDOM.end()}))}}class Hr extends n.Gizmo{constructor(){super(...arguments),this._attachedNodes=null,this._tempVector_=new n.Vector3,this.gizmoPosition=null}_attachedNodesChanged(e){}get attachedNode(){return super.attachedNode}set attachedNode(e){this._attachedNodes=null,super.attachedNode=e}get attachedMesh(){return super.attachedMesh}set attachedMesh(e){this._attachedNodes=null,super.attachedMesh=e}get AttachedNodes(){let e;return this.attachedNode?e=[this.attachedNode]:this.attachedNodes&&(e=this.attachedNodes),e}get attachedNodes(){return this._attachedNodes}set attachedNodes(e){this._attachedNode=null,this._attachedMesh=null,this._attachedNodes=e,this._rootMesh.setEnabled(!!e),this._attachedNodesChanged(e),this.setGizmosPosition(),this.gizmoPosition&&this._rootMesh.position.copyFrom(this.gizmoPosition)}setGizmosPosition(){if(this.attachedNodes){const t=this.attachedNodes.map((e=>e.getWorldMatrix().getRow(3)));var e=t.map((e=>e?e.toVector3():new n.Vector3(0,0,0)));1===e.length?this.gizmoPosition=null:this.gizmoPosition=w.GetCenterFromPoints(e)}else this.gizmoPosition=null}_nodeMatrixChanged(e){var t=this._attachedNode;this._attachedNode=e,this._matrixChanged(),this._attachedNode=t}_handlePivots(){for(const e of this._attachedNodes)e.isUsingPivotMatrix&&e.isUsingPivotMatrix()&&e.getWorldMatrix().setTranslation(e.position)}_update(){if(super._update(),this.attachedNodes){let t=this.attachedNodes;if(this.updateGizmoPositionToMatchAttachedMesh&&(this.setGizmosPosition(),this.gizmoPosition&&this._rootMesh.position.copyFrom(this.gizmoPosition)),this.updateGizmoRotationToMatchAttachedMesh&&this._rootMesh.rotationQuaternion.set(0,0,0,1),this.updateScale){let i=(e=this.gizmoLayer.utilityLayerScene.activeCamera).globalPosition;e.devicePosition&&(i=e.devicePosition),this._rootMesh.position.subtractToRef(i,this._tempVector_);var e=this._tempVector_.length()*this.scaleRatio;this._rootMesh.scaling.set(e,e,e),t.some((e=>e._getWorldMatrixDeterminant()<0))&&!n.Gizmo.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}else this.gizmoPosition=null;this.updateScale&&(e=this.gizmoLayer.utilityLayerScene.activeCamera).mode===n.Camera.ORTHOGRAPHIC_CAMERA&&(e=null==(e=e.metadata)?void 0:e.size)&&this._rootMesh.scaling.set(2*e,2*e,2*e)}}class Kr extends Hr{constructor(e,t=n.Color3.Gray(),i=n.UtilityLayerRenderer.DefaultUtilityLayer,r=null,s=1){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new n.Observable,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._parent=r,this._coloredMaterial=new n.StandardMaterial("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new n.Color3(.1,.1,.1)),this._hoverMaterial=new n.StandardMaterial("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=n.Color3.Yellow(),this._disableMaterial=new n.StandardMaterial("",i.utilityLayerScene),this._disableMaterial.diffuseColor=n.Color3.Gray(),this._disableMaterial.alpha=.4;const o=Kr._CreateArrow(i.utilityLayerScene,this._coloredMaterial,s),a=Kr._CreateArrow(i.utilityLayerScene,this._coloredMaterial,s+4,!0);this._gizmoMesh=new n.Mesh("",i.utilityLayerScene),this._gizmoMesh.addChild(o),this._gizmoMesh.addChild(a),this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let h=0;const l=new n.Vector3,c=new n.Vector3,u={snapDistance:0},d=(this.dragBehavior=new n.PointerDragBehavior({dragAxis:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add((e=>{let t;if(this.attachedNode?(this._handlePivot(),t=[this.attachedNode]):this.attachedNodes&&(this._handlePivots(),t=this.attachedNodes),t){for(const r of t){let t=!1;var i;0===this.snapDistance?(r.getWorldMatrix().getTranslationToRef(c),c.addInPlace(e.delta),this.dragBehavior.validateDrag(c)&&(r.position&&r.position.addInPlaceFromFloats(e.delta.x,e.delta.y,e.delta.z),r.getWorldMatrix().addTranslationFromFloats(e.delta.x,e.delta.y,e.delta.z),r.updateCache(),t=!0)):(h+=e.dragDistance,Math.abs(h)>this.snapDistance&&(i=Math.floor(Math.abs(h)/this.snapDistance),h%=this.snapDistance,e.delta.normalizeToRef(l),l.scaleInPlace(this.snapDistance*i),r.getWorldMatrix().getTranslationToRef(c),c.addInPlace(l),this.dragBehavior.validateDrag(c)&&(r.getWorldMatrix().addTranslationFromFloats(l.x,l.y,l.z),r.updateCache(),u.snapDistance=this.snapDistance*i,this.onSnapObservable.notifyObservers(u),t=!0))),t&&(this._attachedNode=r,this._matrixChanged())}this.attachedNodes&&(this._attachedNode=null)}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1})),i._getSharedGizmoLight()),p=(d.includedOnlyMeshes=d.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1)),{gizmoMeshes:o.getChildMeshes(),colliderMeshes:a.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior});null!=(r=this._parent)&&r.addToAxisCache(a,p),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{this._customMeshSet||(this._isHovered=!(-1===p.colliderMeshes.indexOf(null==(e=null==e?void 0:e.pickInfo)?void 0:e.pickedMesh)),this._parent||(e=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial,this._setGizmoMeshMaterial(p.gizmoMeshes,e)))})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(p.gizmoMeshes,e?p.material:p.disableMaterial)}))}static _CreateArrow(e,t,i=1,r=!1){var s=new n.TransformNode("arrow",e);const o=(0,n.CreateCylinder)("cylinder",{diameterTop:0,height:.075,diameterBottom:.0375*(1+(i-1)/4),tessellation:96},e),a=(0,n.CreateCylinder)("cylinder",{diameterTop:.005*i,height:.275,diameterBottom:.005*i,tessellation:96},e);return o.parent=s,o.material=t,o.rotation.x=Math.PI/2,o.position.z+=.3,a.parent=s,a.material=t,a.position.z+=.1375,a.rotation.x=Math.PI/2,r&&(a.visibility=0,o.visibility=0),s}static _CreateArrowInstance(e,t){var i=new n.TransformNode("arrow",e);for(const e of t.getChildMeshes()){e.createInstance(e.name).parent=i}return i}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}_attachedNodesChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){(this._isEnabled=e)?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}}class Xr extends Hr{constructor(e,t=n.Color3.Gray(),i=n.UtilityLayerRenderer.DefaultUtilityLayer,r=null){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new n.Observable,this._isEnabled=!1,this._parent=null,this._dragging=!1,this._parent=r,this._coloredMaterial=new n.StandardMaterial("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new n.Color3(.1,.1,.1)),this._hoverMaterial=new n.StandardMaterial("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=n.Color3.Yellow(),this._disableMaterial=new n.StandardMaterial("",i.utilityLayerScene),this._disableMaterial.diffuseColor=n.Color3.Gray(),this._disableMaterial.alpha=.4,this._gizmoMesh=Xr._CreatePlane(i.utilityLayerScene,this._coloredMaterial),this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let s=0;const o=new n.Vector3,a={snapDistance:0},h=(this.dragBehavior=new n.PointerDragBehavior({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add((e=>{let t;if(this.attachedNode?(this._handlePivot(),t=[this.attachedNode]):this.attachedNodes&&(t=this.attachedNodes),t){for(const r of t){var i;0===this.snapDistance?r.getWorldMatrix().addTranslationFromFloats(e.delta.x,e.delta.y,e.delta.z):(s+=e.dragDistance,Math.abs(s)>this.snapDistance&&(i=Math.floor(Math.abs(s)/this.snapDistance),s%=this.snapDistance,e.delta.normalizeToRef(o),o.scaleInPlace(this.snapDistance*i),r.getWorldMatrix().addTranslationFromFloats(o.x,o.y,o.z),a.snapDistance=this.snapDistance*i,this.onSnapObservable.notifyObservers(a))),this._attachedNode=r,this._matrixChanged()}this.attachedNodes&&(this._attachedNode=null)}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1})),i._getSharedGizmoLight()),l=(h.includedOnlyMeshes=h.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1)),{gizmoMeshes:this._gizmoMesh.getChildMeshes(),colliderMeshes:this._gizmoMesh.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior});null!=(r=this._parent)&&r.addToAxisCache(this._gizmoMesh,l),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{this._customMeshSet||(this._isHovered=!(-1===l.colliderMeshes.indexOf(null==(e=null==e?void 0:e.pickInfo)?void 0:e.pickedMesh)),this._parent||(e=l.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial,this._setGizmoMeshMaterial(l.gizmoMeshes,e)))})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(l.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}))}static _CreatePlane(e,t){var i=new n.TransformNode("plane",e);const r=(0,n.CreatePlane)("dragPlane",{width:.1375,height:.1375,sideOrientation:2},e);return r.material=t,r.parent=i,r.visibility=.3,i}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}_attachedNodesChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){(this._isEnabled=e)?this._parent&&(this.attachedNode=this._parent.attachedNode):this.attachedNode=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),super.dispose(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()}))}}class qr extends n.Gizmo{constructor(e=n.UtilityLayerRenderer.DefaultUtilityLayer,t=1,i){super(e),this._meshAttached=null,this._nodeAttached=null,this._nodeAttacheds=null,this._observables=[],this._gizmoAxisCache=new Map,this.onDragStartObservable=new n.Observable,this.onDragEndObservable=new n.Observable,this._planarGizmoEnabled=!1,this.xGizmo=new Kr(new n.Vector3(1,0,0),n.Color3.Red().scale(.5),e,this,t),this.yGizmo=new Kr(new n.Vector3(0,1,0),n.Color3.Green().scale(.5),e,this,t),this.zGizmo=new Kr(new n.Vector3(0,0,1),n.Color3.Blue().scale(.5),e,this,t),this.xPlaneGizmo=new Xr(new n.Vector3(1,0,0),n.Color3.Red().scale(.5),this.gizmoLayer,this),this.yPlaneGizmo=new Xr(new n.Vector3(0,1,0),n.Color3.Green().scale(.5),this.gizmoLayer,this),this.zPlaneGizmo=new Xr(new n.Vector3(0,0,1),n.Color3.Blue().scale(.5),this.gizmoLayer,this),[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((e=>{e.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),e.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,i?i.addToAxisCache(this._gizmoAxisCache):n.Gizmo.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._nodeAttacheds=null,this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttacheds=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null}))}get attachedNodes(){return this._nodeAttacheds}set attachedNodes(e){this._meshAttached=null,this._nodeAttached=null,this._nodeAttacheds=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.isEnabled?t.attachedNodes=e:t.attachedNodes=null}))}get isHovered(){let e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{e=e||t.isHovered})),e}set planarGizmoEnabled(e){this._planarGizmoEnabled=e,[this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.isEnabled=e)&&(t.attachedMesh?t.attachedMesh=this.attachedMesh:t.attachedNode=this.attachedNode)}),this)}get planarGizmoEnabled(){return this._planarGizmoEnabled}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.updateGizmoRotationToMatchAttachedMesh=e)}))}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set snapDistance(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.snapDistance=e)}))}get snapDistance(){return this._snapDistance}set scaleRatio(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.scaleRatio=e)}))}get scaleRatio(){return this._scaleRatio}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}dispose(){[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((e=>{e&&e.dispose()})),this._observables.forEach((e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)})),this.onDragStartObservable.clear(),this.onDragEndObservable.clear()}setCustomMesh(){n.Logger.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo,gizmo.xPlaneGizmo, gizmo.yPlaneGizmo, gizmo.zPlaneGizmo)")}}class Yr extends Hr{constructor(e,t=n.Color3.Gray(),i=n.UtilityLayerRenderer.DefaultUtilityLayer,r=32,s=null,o,a=1){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new n.Observable,this.angle=0,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._angles=new n.Vector3,this._parent=s,this._coloredMaterial=new n.StandardMaterial("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new n.Color3(.1,.1,.1)),this._hoverMaterial=new n.StandardMaterial("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=n.Color3.Yellow(),this._disableMaterial=new n.StandardMaterial("",i.utilityLayerScene),this._disableMaterial.diffuseColor=n.Color3.Gray(),this._disableMaterial.alpha=.4,this._gizmoMesh=new n.Mesh("",i.utilityLayerScene);var{rotationMesh:s,collider:t}=this._createGizmoMesh(this._gizmoMesh,a,r);this._rotationDisplayPlane=(0,n.CreatePlane)("rotationDisplay",{size:.6,updatable:!1},this.gizmoLayer.utilityLayerScene),this._rotationDisplayPlane.rotation.z=.5*Math.PI,this._rotationDisplayPlane.parent=this._gizmoMesh,this._rotationDisplayPlane.setEnabled(!1),n.Effect.ShadersStore.rotationGizmoVertexShader=Yr._RotationGizmoVertexShader,n.Effect.ShadersStore.rotationGizmoFragmentShader=Yr._RotationGizmoFragmentShader,this._rotationShaderMaterial=new n.ShaderMaterial("shader",this.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles"]}),this._rotationShaderMaterial.backFaceCulling=!1,this._rotationDisplayPlane.material=this._rotationShaderMaterial,this._rotationDisplayPlane.visibility=.999,this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,n.Gizmo.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3),this.dragBehavior=new n.PointerDragBehavior({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.maxDragAngle=Yr.MaxDragAngle,this.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,this._rootMesh.addBehavior(this.dragBehavior);const h=new n.Vector3,l=new n.Matrix,c=new n.Vector3;let u=new n.Vector3;this.dragBehavior.onDragStartObservable.add((e=>{this.AttachedNodes&&(h.copyFrom(e.dragPlanePoint),this._rotationDisplayPlane.setEnabled(!0),this._rotationDisplayPlane.getWorldMatrix().invertToRef(l),n.Vector3.TransformCoordinatesToRef(e.dragPlanePoint,l,h),this._angles.x=Math.atan2(h.y,h.x)+Math.PI,this._angles.y=0,this._angles.z=this.updateGizmoRotationToMatchAttachedMesh?1:0,this._dragging=!0,h.copyFrom(e.dragPlanePoint),this._rotationShaderMaterial.setVector3("angles",this._angles),this.angle=0)})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1,this._rotationDisplayPlane.setEnabled(!1)}));const d={snapDistance:0};let p=0;const _=new n.Matrix,f=new n.Quaternion,g=(this.dragBehavior.onDragObservable.add((t=>{let r=this.AttachedNodes;if(this.attachedNode?this._handlePivot():this._handlePivots(),r){var s=new n.Vector3(1,1,1);const g=new n.Quaternion(0,0,0,1),m=new n.Vector3(0,0,0);1<r.length?this.gizmoPosition&&m.copyFrom(this.gizmoPosition):r[0].getWorldMatrix().decompose(s,g,m);var o=t.dragPlanePoint.subtract(m).normalize(),a=h.subtract(m).normalize();const y=n.Vector3.Cross(o,a);o=n.Vector3.Dot(o,a);let v=Math.atan2(y.length(),o),b=(c.copyFrom(e),u.copyFrom(e),!1);if(this.updateGizmoRotationToMatchAttachedMesh&&(g.toRotationMatrix(l),u=n.Vector3.TransformCoordinates(c,l)),i.utilityLayerScene.activeCamera&&(a=i.utilityLayerScene.activeCamera.position.subtract(m).normalize(),0<n.Vector3.Dot(a,u)&&(c.scaleInPlace(-1),u.scaleInPlace(-1))),0!==this.snapDistance)if(p+=v,Math.abs(p)>this.snapDistance){let e=Math.floor(Math.abs(p)/this.snapDistance);p<0&&(e*=-1),p%=this.snapDistance,v=this.snapDistance*e,b=!0}else v=0;0<n.Vector3.Dot(u,y)&&(v=-v),o=Math.sin(v/2),f.set(c.x*o,c.y*o,c.z*o,Math.cos(v/2)),0<_.determinant()&&(a=new n.Vector3,f.toEulerAnglesToRef(a),n.Quaternion.RotationYawPitchRollToRef(a.y,-a.x,-a.z,f)),this._angles.y+=v,this._rotationShaderMaterial.setVector3("angles",this._angles);for(const e of r){let t=new n.Vector3;1===r.length?t=m:e.getWorldMatrix().decompose(s,g,t),this.updateGizmoRotationToMatchAttachedMesh?g.multiplyToRef(f,g):f.multiplyToRef(g,g),e.getWorldMatrix().copyFrom(n.Matrix.Compose(s,g,t)),this._nodeMatrixChanged(e)}b&&(d.snapDistance=v,this.onSnapObservable.notifyObservers(d)),h.copyFrom(t.dragPlanePoint)}})),i._getSharedGizmoLight()),m=(g.includedOnlyMeshes=g.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1)),{colliderMeshes:[t],gizmoMeshes:[s],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior});null!=(a=this._parent)&&a.addToAxisCache(this._gizmoMesh,m),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{this._customMeshSet||(this.dragBehavior.maxDragAngle=Yr.MaxDragAngle,this._isHovered=!(-1===m.colliderMeshes.indexOf(null==(e=null==e?void 0:e.pickInfo)?void 0:e.pickedMesh)),this._parent||(e=m.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial,this._setGizmoMeshMaterial(m.gizmoMeshes,e)))})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(m.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}))}_createGizmoMesh(e,t,i){const r=(0,n.CreateTorus)("ignore",{diameter:.6,thickness:.03*t,tessellation:i},this.gizmoLayer.utilityLayerScene),s=(r.visibility=0,(0,n.CreateTorus)("",{diameter:.6,thickness:.005*t,tessellation:i},this.gizmoLayer.utilityLayerScene));return s.material=this._coloredMaterial,s.rotation.x=Math.PI/2,r.rotation.x=Math.PI/2,e.addChild(s,n.Gizmo.PreserveScaling),e.addChild(r,n.Gizmo.PreserveScaling),{rotationMesh:s,collider:r}}_attachedNodeChanged(e){this.updateGizmoPositionToMatchAttachedMesh=!0,this.dragBehavior&&(this.dragBehavior.enabled=!!e)}_attachedNodesChanged(e){this.updateGizmoPositionToMatchAttachedMesh=!1,this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){(this._isEnabled=e)?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}}Yr.MaxDragAngle=9*Math.PI/20,Yr._RotationGizmoVertexShader="\n        precision highp float;\n        attribute vec3 position;\n        attribute vec2 uv;\n        uniform mat4 worldViewProjection;\n        varying vec3 vPosition;\n        varying vec2 vUV;\n        void main(void) {\n            gl_Position = worldViewProjection * vec4(position, 1.0);\n            vUV = uv;\n        }",Yr._RotationGizmoFragmentShader="\n        precision highp float;\n        varying vec2 vUV;\n        varying vec3 vPosition;\n        uniform vec3 angles;\n        #define twopi 6.283185307\n        void main(void) {\n            vec2 uv = vUV - vec2(0.5);\n            float angle = atan(uv.y, uv.x) + 3.141592;\n            float delta = gl_FrontFacing ? angles.y : -angles.y;\n            float begin = angles.x - delta * angles.z;\n            float start = (begin < (begin + delta)) ? begin : (begin + delta);\n            float end = (begin > (begin + delta)) ? begin : (begin + delta);\n            float len = sqrt(dot(uv,uv));\n            float opacity = 1. - step(0.5, len);\n\n            float base = abs(floor(start / twopi)) * twopi;\n            start += base;\n            end += base;\n\n            float intensity = 0.;\n            for (int i = 0; i < 5; i++)\n            {\n                intensity += max(step(start, angle) - step(end, angle), 0.);\n                angle += twopi;\n            }\n            gl_FragColor = vec4(1.,1.,0., min(intensity * 0.25, 0.8)) * opacity;\n        }";class Zr extends n.Gizmo{constructor(e=n.UtilityLayerRenderer.DefaultUtilityLayer,t=32,i=!1,r=1,s,o){super(e),this.onDragStartObservable=new n.Observable,this.onDragEndObservable=new n.Observable,this._observables=[],this._gizmoAxisCache=new Map;var a=o&&o.xOptions&&o.xOptions.color?o.xOptions.color:n.Color3.Red().scale(.5),h=o&&o.yOptions&&o.yOptions.color?o.yOptions.color:n.Color3.Green().scale(.5),l=o&&o.zOptions&&o.zOptions.color?o.zOptions.color:n.Color3.Blue().scale(.5);this.xGizmo=new Yr(new n.Vector3(1,0,0),a,e,t,this,i,r),this.yGizmo=new Yr(new n.Vector3(0,1,0),h,e,t,this,i,r),this.zGizmo=new Yr(new n.Vector3(0,0,1),l,e,t,this,i,r),[this.xGizmo,this.yGizmo,this.zGizmo].forEach((e=>{o&&void 0!==o.updateScale&&(e.updateScale=o.updateScale),e.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),e.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,this.attachedNode=null,s?s.addToAxisCache(this._gizmoAxisCache):n.Gizmo.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null}))}get attachedNodes(){return this._nodeAttacheds}set attachedNodes(e){this._meshAttached=null,this._nodeAttached=null,this._nodeAttacheds=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.isEnabled?t.attachedNodes=e:t.attachedNodes=null}))}_checkBillboardTransform(){this._nodeAttached&&this._nodeAttached.billboardMode}get isHovered(){let e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{e=e||t.isHovered})),e}set updateGizmoRotationToMatchAttachedMesh(e){this.xGizmo&&(this.xGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.yGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.zGizmo.updateGizmoRotationToMatchAttachedMesh=e)}get updateGizmoRotationToMatchAttachedMesh(){return this.xGizmo.updateGizmoRotationToMatchAttachedMesh}set snapDistance(e){this.xGizmo&&(this.xGizmo.snapDistance=e,this.yGizmo.snapDistance=e,this.zGizmo.snapDistance=e)}get snapDistance(){return this.xGizmo.snapDistance}set scaleRatio(e){this.xGizmo&&(this.xGizmo.scaleRatio=e,this.yGizmo.scaleRatio=e,this.zGizmo.scaleRatio=e)}get scaleRatio(){return this.xGizmo.scaleRatio}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}dispose(){this.xGizmo.dispose(),this.yGizmo.dispose(),this.zGizmo.dispose(),this.onDragStartObservable.clear(),this.onDragEndObservable.clear(),this._observables.forEach((e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)}))}setCustomMesh(){n.Logger.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo)")}}class Qr{constructor(e,t=1,i=n.UtilityLayerRenderer.DefaultUtilityLayer,r=n.UtilityLayerRenderer.DefaultKeepDepthUtilityLayer){this._scene=e,this.clearGizmoOnEmptyPointerEvent=!1,this.enableAutoPicking=!0,this.onAttachedToMeshObservable=new n.Observable,this.onAttachedToNodeObservable=new n.Observable,this._gizmosEnabled={positionGizmo:!1,rotationGizmo:!1,scaleGizmo:!1,boundingBoxGizmo:!1},this._pointerObservers=[],this._attachedMesh=null,this._attachedNode=null,this._attachedNodes=null,this._boundingBoxColor=n.Color3.FromHexString("#0984e3"),this._thickness=1,this._scaleRatio=1,this._gizmoAxisCache=new Map,this.boundingBoxDragBehavior=new n.SixDofDragBehavior,this.attachableMeshes=null,this.attachableNodes=null,this.usePointerToAttachGizmos=!0,this._defaultUtilityLayer=i,this._defaultKeepDepthUtilityLayer=r,this._defaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,this._thickness=t,this.gizmos={positionGizmo:null,rotationGizmo:null,scaleGizmo:null,boundingBoxGizmo:null},i=this._attachToMeshPointerObserver(e),r=n.Gizmo.GizmoAxisPointerObserver(this._defaultUtilityLayer,this._gizmoAxisCache),this._pointerObservers=[i,r]}get keepDepthUtilityLayer(){return this._defaultKeepDepthUtilityLayer}get utilityLayer(){return this._defaultUtilityLayer}get isHovered(){let e=!1;for(const i in this.gizmos){var t=this.gizmos[i];if(t&&t.isHovered){e=!0;break}}return e}set scaleRatio(e){this._scaleRatio=e,[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo].forEach((t=>{t&&(t.scaleRatio=e)}))}get scaleRatio(){return this._scaleRatio}_attachToMeshPointerObserver(e){return e.onPointerObservable.add((e=>{if(this.usePointerToAttachGizmos&&e.type===n.PointerEventTypes.POINTERDOWN)if(e.pickInfo&&e.pickInfo.pickedMesh){if(this.enableAutoPicking){let t=e.pickInfo.pickedMesh;if(null===this.attachableMeshes)for(;t&&null!==t.parent;)t=t.parent;else{let e=!1;this.attachableMeshes.forEach((i=>{t&&(t===i||t.isDescendantOf(i))&&(t=i,e=!0)})),e||(t=null)}t instanceof n.AbstractMesh?this._attachedMesh!==t&&this.attachToMesh(t):this.clearGizmoOnEmptyPointerEvent&&this.attachToMesh(null)}}else this.clearGizmoOnEmptyPointerEvent&&this.attachToMesh(null)}))}attachToMesh(e){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=e,this._attachedNode=null;for(const t in this.gizmos){const i=this.gizmos[t];i&&this._gizmosEnabled[t]&&(i.attachedMesh=e)}this.boundingBoxGizmoEnabled&&this._attachedMesh&&this._attachedMesh.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToMeshObservable.notifyObservers(e)}attachToNode(e){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNodes&&this._attachedNodes.forEach((e=>e.removeBehavior(this.boundingBoxDragBehavior))),this._attachedMesh=null,this._attachedNodes=null,this._attachedNode=e;for(const t in this.gizmos){const i=this.gizmos[t];i&&this._gizmosEnabled[t]&&(i.attachedNode=e)}this.boundingBoxGizmoEnabled&&this._attachedNode&&this._attachedNode.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToNodeObservable.notifyObservers(e)}attachToNodes(e){if(null==e||!e.length)return this._attachedNodes=null,void this.attachToNode(null);if(1===(null==e?void 0:e.length))this.attachToNode(e[0]);else{this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNodes&&this._attachedNodes.forEach((e=>e.removeBehavior(this.boundingBoxDragBehavior))),this._attachedMesh=null,this._attachedNode=null,this._attachedNodes=e;for(const t in this.gizmos){const i=this.gizmos[t];i&&this._gizmosEnabled[t]&&("attachedNodes"in i?i.attachedNodes=e:i.attachedNode=e[0])}this.boundingBoxGizmoEnabled&&this._attachedNode&&this._attachedNode.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToNodeObservable.notifyObservers(e)}}set positionGizmoEnabled(e){e?(this.gizmos.positionGizmo||(this.gizmos.positionGizmo=new qr(this._defaultUtilityLayer,this._thickness,this)),this._attachedNode?this.gizmos.positionGizmo.attachedNode=this._attachedNode:this._attachedNodes?this.gizmos.positionGizmo.attachedNodes=this._attachedNodes:this.gizmos.positionGizmo.attachedMesh=this._attachedMesh):this.gizmos.positionGizmo&&(this.gizmos.positionGizmo.attachedNode=null,this.gizmos.positionGizmo.attachedNodes=null),this._gizmosEnabled.positionGizmo=e}get positionGizmoEnabled(){return this._gizmosEnabled.positionGizmo}set rotationGizmoEnabled(e){e?(this.gizmos.rotationGizmo||(this.gizmos.rotationGizmo=new Zr(this._defaultUtilityLayer,32,!1,this._thickness,this)),this._attachedNode?this.gizmos.rotationGizmo.attachedNode=this._attachedNode:this._attachedNodes?this.gizmos.rotationGizmo.attachedNodes=this._attachedNodes:this.gizmos.rotationGizmo.attachedMesh=this._attachedMesh):this.gizmos.rotationGizmo&&(this.gizmos.rotationGizmo.attachedNode=null,this.gizmos.rotationGizmo.attachedNodes=null),this._gizmosEnabled.rotationGizmo=e}get rotationGizmoEnabled(){return this._gizmosEnabled.rotationGizmo}set scaleGizmoEnabled(e){e?(this.gizmos.scaleGizmo=this.gizmos.scaleGizmo||new n.ScaleGizmo(this._defaultUtilityLayer,this._thickness,this),this._attachedNode?this.gizmos.scaleGizmo.attachedNode=this._attachedNode:this._attachedNodes?this.gizmos.scaleGizmo.attachedNode=this._attachedNodes[0]:this.gizmos.scaleGizmo.attachedMesh=this._attachedMesh):this.gizmos.scaleGizmo&&(this.gizmos.scaleGizmo.attachedNode=null),this._gizmosEnabled.scaleGizmo=e}get scaleGizmoEnabled(){return this._gizmosEnabled.scaleGizmo}set boundingBoxGizmoEnabled(e){e?(this.gizmos.boundingBoxGizmo=this.gizmos.boundingBoxGizmo||new n.BoundingBoxGizmo(this._boundingBoxColor,this._defaultKeepDepthUtilityLayer),this._attachedMesh?this.gizmos.boundingBoxGizmo.attachedMesh=this._attachedMesh:this.gizmos.boundingBoxGizmo.attachedNode=this._attachedNode,this._attachedMesh?(this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh.addBehavior(this.boundingBoxDragBehavior)):this._attachedNode&&(this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode.addBehavior(this.boundingBoxDragBehavior))):this.gizmos.boundingBoxGizmo&&(this._attachedMesh?this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior):this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this.gizmos.boundingBoxGizmo.attachedNode=null),this._gizmosEnabled.boundingBoxGizmo=e}get boundingBoxGizmoEnabled(){return this._gizmosEnabled.boundingBoxGizmo}addToAxisCache(e){0<e.size&&e.forEach(((e,t)=>{this._gizmoAxisCache.set(t,e)}))}dispose(){var e;this._pointerObservers.forEach((e=>{this._scene.onPointerObservable.remove(e)}));for(const e in this.gizmos){const t=this.gizmos[e];t&&t.dispose()}this._defaultKeepDepthUtilityLayer!==n.UtilityLayerRenderer._DefaultKeepDepthUtilityLayer&&null!=(e=this._defaultKeepDepthUtilityLayer)&&e.dispose(),this._defaultUtilityLayer!==n.UtilityLayerRenderer._DefaultUtilityLayer&&null!=(e=this._defaultUtilityLayer)&&e.dispose(),this.boundingBoxDragBehavior.detach(),this.onAttachedToMeshObservable.clear()}}class Jr{constructor(e){this._viewer=e,this._mode=Z.Translate,this.gizmoManager=new Qr(this._viewer.Scene,1,e.utilLayer),this.positionGizmo=new qr(e.utilLayer,1),this.positionGizmo.planarGizmoEnabled=!0,this.rotationGizmo=new Zr(e.utilLayer),this.scaleGizmo=new n.ScaleGizmo(e.utilLayer,1),this.gizmoManager.gizmos.positionGizmo=this.positionGizmo,this.gizmoManager.gizmos.rotationGizmo=this.rotationGizmo,this.gizmoManager.gizmos.scaleGizmo=this.scaleGizmo,this.gizmoManager.usePointerToAttachGizmos=!1,this.Mode=this._mode,this._register()}get Mode(){return this._mode}set Mode(e){this._mode=e,this.gizmoManager.positionGizmoEnabled=!!(e&Z.Translate),this.gizmoManager.rotationGizmoEnabled=!!(e&Z.Rotate),this.gizmoManager.scaleGizmoEnabled=!!(e&Z.Scale),this.gizmoManager.positionGizmoEnabled&&this.gizmoManager.scaleGizmoEnabled&&(this.gizmoManager.gizmos.positionGizmo.scaleRatio=1.5)}attachMeshs(e){this.detachMeshs(),0!==e.length&&(this.attachNodes=e,this.gizmoManager.attachToNodes([...e]))}detachMeshs(){this.attachNodes=null,this.gizmoManager.attachToNode(null)}_register(){const e=e=>{const t=N(null==e?void 0:e[0]);null!=t&&t.DB&&t.DB.HistoryManager.startCmd("\u5b9e\u4f53\u53d8\u6362");for(const t of e)if(t){N(t).Matrix=t._worldMatrix}null!=t&&t.DB&&t.DB.HistoryManager.endCmd()};this.positionGizmo.onDragEndObservable.add((t=>{e(this.attachNodes)})),this.rotationGizmo.onDragEndObservable.add((t=>{e(this.attachNodes)})),this.scaleGizmo.onDragEndObservable.add((t=>{e(this.attachNodes)}))}}class $r{constructor(e){this._viewer=e,this.keyeunm={keydown:n.KeyboardEventTypes.KEYDOWN,keyup:n.KeyboardEventTypes.KEYUP},this.keydownEvents=new Set,this.keyupEvents=new Set,this._ctrlKey=!1,this._shiftKey=!1,this._altKey=!1,this._register()}get IsCtrl(){return this._ctrlKey}get IsShift(){return this._shiftKey}get IsAlt(){return this._altKey}on(e,t){if(this.keyeunm[e]===n.KeyboardEventTypes.KEYDOWN)this.keydownEvents.add(t);else{if(this.keyeunm[e]!==n.KeyboardEventTypes.KEYUP)throw new TypeError("\u4e8b\u4ef6\u7c7b\u578b\u9519\u8bef");this.keyupEvents.add(t)}return()=>{this.off(e,t)}}off(e,t){this.keyeunm[e]===n.KeyboardEventTypes.KEYDOWN?this.keydownEvents.delete(t):this.keyeunm[e]===n.KeyboardEventTypes.KEYUP&&this.keyupEvents.delete(t)}removeAll(){this.keydownEvents.clear(),this.keyupEvents.clear()}_register(){this._viewer.Scene.onKeyboardObservable.add((e=>{if(e.type===n.KeyboardEventTypes.KEYDOWN){this._ctrlKey=e.event.ctrlKey,this._shiftKey=e.event.shiftKey,this._altKey=e.event.altKey;for(const t of this.keydownEvents)t(e.event)}else for(const t of this.keyupEvents)this._ctrlKey=e.event.ctrlKey,this._shiftKey=e.event.shiftKey,this._altKey=e.event.altKey,t(e.event);he.trigger({type:["keydown","keyup"][e.type-1],event:e.event,target:null})}))}}class en{constructor(e){this._viewer=e,this._pointerdownEvs=new Set,this._pointermoveEvs=new Set,this._pointerupEvs=new Set,this._pointerwheelEvs=new Set,this._pointerPickEvs=new Set,this._pointerTapEvs=new Set,this._pointerDbTapEvs=new Set,this._register()}get Scene(){return this._viewer.Scene}get ScreenPoint(){return{x:this.Scene.pointerX,y:this.Scene.pointerY}}get WorldPoint(){this._viewer.ground&&(this._viewer.ground.isPickable=!0);var e=this.Scene.pick(this.Scene.pointerX,this.Scene.pointerY,(e=>"WORLD_GROUND"===e.name));return this._viewer.ground&&(this._viewer.ground.isPickable=!1),e.hit?e.pickedPoint:null}on(e,t){switch(n.PointerEventTypes[e.toUpperCase()]){case n.PointerEventTypes.POINTERDOWN:this._pointerdownEvs.add(t);break;case n.PointerEventTypes.POINTERMOVE:this._pointermoveEvs.add(t);break;case n.PointerEventTypes.POINTERUP:this._pointerupEvs.add(t);break;case n.PointerEventTypes.POINTERWHEEL:this._pointerwheelEvs.add(t);break;case n.PointerEventTypes.POINTERPICK:this._pointerPickEvs.add(t);break;case n.PointerEventTypes.POINTERTAP:this._pointerTapEvs.add(t);break;case n.PointerEventTypes.POINTERDOUBLETAP:this._pointerDbTapEvs.add(t)}return()=>{this.off(e,t)}}off(e,t){if(e)switch(n.PointerEventTypes[e.toUpperCase()]){case n.PointerEventTypes.POINTERDOWN:this._pointerdownEvs.delete(t);break;case n.PointerEventTypes.POINTERMOVE:this._pointermoveEvs.delete(t);break;case n.PointerEventTypes.POINTERUP:this._pointerupEvs.delete(t);break;case n.PointerEventTypes.POINTERWHEEL:this._pointerwheelEvs.delete(t);break;case n.PointerEventTypes.POINTERPICK:this._pointerPickEvs.delete(t);break;case n.PointerEventTypes.POINTERTAP:this._pointerTapEvs.delete(t);break;case n.PointerEventTypes.POINTERDOUBLETAP:this._pointerDbTapEvs.delete(t)}}getEvent(e){var t;let i,r;return null!=(t=e.pickInfo)&&t.hit&&null!=(t=e.pickInfo)&&t.pickedMesh&&(i=k(e.pickInfo.pickedMesh),r=N(i)),{type:de[e.type],screenX:this.Scene.pointerX,screenY:this.Scene.pointerY,worldPoint:this.WorldPoint,target:r,object:i,event:e.event}}_register(){this._viewer.Scene.onPointerObservable.add((e=>{const t=this.getEvent(e);let i;switch(t.target&&t.target.trigger(t),e.type){case n.PointerEventTypes.POINTERDOWN:i=this._pointerdownEvs;break;case n.PointerEventTypes.POINTERUP:i=this._pointerupEvs;break;case n.PointerEventTypes.POINTERMOVE:i=this._pointermoveEvs;break;case n.PointerEventTypes.POINTERWHEEL:i=this._pointerwheelEvs;break;case n.PointerEventTypes.POINTERPICK:i=this._pointerPickEvs;break;case n.PointerEventTypes.POINTERTAP:i=this._pointerTapEvs;break;case n.PointerEventTypes.POINTERDOUBLETAP:i=this._pointerDbTapEvs}i.forEach((e=>e(t))),he.trigger(t)}))}}class tn{constructor(e,t=!1){this._viewer=e,this.editorMode=t,this.keyboardCtrl=new $r(e),this.mouseCtrl=new en(e),t&&this.initEditor()}initEditor(){this._viewer.initEditor(),this.selectControl=new Wr(this._viewer),this.transformControl=new Jr(this._viewer),this._register()}_register(){this.selectControl.on((e=>{"select"===e.type&&this.transformControl.attachMeshs(e.meshs)}))}}class rn{constructor(e){this._color=n.Color3.White(),this._highlightLayer=new n.HighlightLayer("select-entity",e.Scene),this._highlightLayer.innerGlow=!1}exclude(e){this._highlightLayer.addExcludedMesh(e)}addMeshs(e,t){for(const i of e){i.getChildMeshes().forEach((e=>this._highlightLayer.addMesh(e,null!=t?t:this._color)))}}addEnitys(e,t){for(const i of e)this.addMeshs([i.DrawObject],t)}clear(){this._highlightLayer.removeAllMeshes()}}const nn=1e5,sn=1e3;class on{constructor(e){this._attachedCamera=e,this._radiusScale=1,this._positionScale=.5}zoomOnBoundingInfo(e,t,i=0,r){let s;var o,a;this._attachedCamera&&(a=(a=e.y)+(t.y-a)*this._positionScale,o=t.subtract(e).scale(.5),o=e.add(o),s=new n.Vector3(o.x,a,o.z),this._attachedCamera.target=s,a=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this._attachedCamera.position=s.add(new n.Vector3(0,0,a)))}_calculateLowerRadiusFromModelBoundingSphere(e,t){t=t.subtract(e).length(),e=this._getFrustumSlope();var i=(t=.5*t*this._radiusScale)*Math.sqrt(1+1/(e.x*e.x));t*=Math.sqrt(1+1/(e.y*e.y)),e=Math.max(i,t);return this._attachedCamera?e:0}_getFrustumSlope(){const e=this._attachedCamera;if(!e)return n.Vector2.Zero();var t=e.getScene().getEngine().getAspectRatio(e),i=Math.tan(e.fov/2);return new n.Vector2(i*t,i)}}class an{constructor(e,t){this._scene=e,this._canvas=t,this._enable=q.All,this._position=new n.Vector3(0,0,10),this._target=n.Vector3.Zero(),this._mode=n.Camera.PERSPECTIVE_CAMERA,this.wheelSpeed=20,this.wheelDeltaPercentage=.05,this._flying=!1,this.size=sn,this.onRadiusChangeObserver=new n.Observable,this.onZommScaleChangeObserver=new n.Observable,this.zoomScale=1}get CurrentCamera(){return this._camera}get Position(){return{x:this._position.x,y:this._position.y,z:this._position.z}}set Position(e){se(this._position,e)}get Target(){return this._target}set Target(e){se(this._target,e)}get Alpha(){return 0}set Alpha(e){}get Beta(){return 0}set Beta(e){}get Radius(){return n.Vector3.Distance(this._target,this._position)}set Radius(e){e=this._position.subtract(this._target).normalize().scale(e),this._position=this._position.add(e),this._camera.position.copyFrom(this._position)}get Aspect(){return this._canvas.width/this._canvas.height}get Enable(){return this._enable!==q.None}set Enable(e){this._enable=e?q.All:q.None}get EnableZoom(){return!!(this._enable&q.Zoom)}set EnableZoom(e){e!==this.EnableZoom&&(e?this._enable|=q.Zoom:this._enable&=~q.Zoom,this._mode===n.Camera.PERSPECTIVE_CAMERA&&(e?this._camera.inputs.attached.mousewheel.attachControl():this._camera.inputs.attached.mousewheel.detachControl()))}get Mode(){return this._mode}set Mode(e){this._mode=e}set Size(e){e&&(this.size=e,this._camera.orthoTop=this.size*this.zoomScale,this._camera.orthoBottom=-this.size*this.zoomScale,this._camera.orthoLeft=-this.size*this.zoomScale*this.Aspect,this._camera.orthoRight=this.size*this.zoomScale*this.Aspect)}active(){this._scene.activeCamera=this._camera,this.attachControl()}attachControl(){}detachControl(){this._camera.detachControl()}zoomByBoundBox(e,t){const i=this._camera.getBehaviorByName("Framing");i?(i.framingTime=0,i.elevationReturnTime=-1,i.autoCorrectCameraLimitsAndSensibility=!1,i.zoomOnBoundingInfo(e,t)):(this.customFramingBehavior||(this.customFramingBehavior=new on(this._camera)),this.customFramingBehavior.zoomOnBoundingInfo(e,t))}zoomAll(){var e=e=>e.isVisible&&e.isEnabled()&&"WORLD_GROUND"!==e.name&&!e.getBoundingInfo().boundingBox.extendSize.equalsWithEpsilon(n.Vector3.Zero());if(this._scene.meshes.filter(e).length){const{max:t,min:i}=this._scene.getWorldExtends(e);t.equalsWithEpsilon(i,.001)||this.zoomByBoundBox(i,t)}}zoomToEntity(e){const{extendSize:t,minimumWorld:i,maximumWorld:r}=e.BoundingBox;t.equalsWithEpsilon(n.Vector3.Zero())||this.zoomByBoundBox(i,r)}initOrthCamera(){this.updateOrthCamera(),this._camera.inputs.attached.mousewheel.detachControl(),this.customWheel=this._scene.onPointerObservable.add((e=>{if(this.EnableZoom){let t=0;t=(e=e.event).wheelDelta?-e.wheelDelta:60*-(e.deltaY||e.detail),this.zoomScale+=t/(100*this.wheelSpeed),this.zoomScale<0?this.zoomScale=.001:(this.updateOrthCamera(),this.onZommScaleChangeObserver.notifyObservers(this.zoomScale))}}),n.PointerEventTypes.POINTERWHEEL)}updateOrthCamera(){this._camera.orthoTop=this.Radius*this.zoomScale,this._camera.orthoBottom=-this.Radius*this.zoomScale,this._camera.orthoLeft=-this.Radius*this.zoomScale*this.Aspect,this._camera.orthoRight=this.Radius*this.zoomScale*this.Aspect,this._camera.metadata={zoomScale:this.zoomScale,size:this.Radius*this.zoomScale}}flyTo(e){this._animateGroup&&(this._animateGroup.dispose(),this._animateGroup=null);let{target:t,position:i,time:r=1,complete:s,loop:o=!1}=e;if(t){e=t instanceof _e?t.Position:ne(t);const a=new n.AnimationGroup("camera-fly-group"),h=new n.Animation("camera-fly-target","target",30,n.Animation.ANIMATIONTYPE_VECTOR3);if(h.setKeys([{frame:0,value:this._camera.target.clone()},{frame:30*r,value:e}]),a.addTargetedAnimation(h,this._camera),i){const t=new n.Animation("camera-fly-position","position",30,n.Animation.ANIMATIONTYPE_VECTOR3);e=[{frame:0,value:this._camera.position.clone()},{frame:30*r,value:ne(i)}],t.setKeys(e),a.addTargetedAnimation(t,this._camera)}return a.normalize(0,100),a.play(o),a.onAnimationGroupPlayObservable.add((()=>{this._flying=!0})),a.onAnimationEndObservable.add((()=>{null!=s&&s(),this._flying=!1})),this._animateGroup=a,{clear:()=>{a.dispose(),this._animateGroup=null},stop:()=>a.stop(),pause:()=>a.pause(),reset:()=>a.reset(),restart:()=>a.restart()}}}moveTo(e){return null}destory(){this._camera&&this._camera.dispose()}writeFile(e){e.write(2),e.write(this._target.x),e.write(this._target.y),e.write(this._target.z),e.write(this.zoomScale),e.write(this.size),e.write(this._mode),e.write(this._enable)}readFile(e){var t=e.read();this._target.x=e.read(),this._target.y=e.read(),this._target.z=e.read(),this.zoomScale=e.read(),this.size=e.read(),this._mode=e.read(),1<t&&(this._enable=e.read())}}class hn extends n.ArcRotateCameraPointersInput{constructor(){super(...arguments),this.panningSensibility=1e3,this._button=-1,this.enablePan=!1,this.enableRotate=!0,this.panPercentage=.1}getPanSpeedPercent(){return this.camera.mode===n.Camera.PERSPECTIVE_CAMERA?1e3/(this.panPercentage*this.camera.radius):500*this.panPercentage}onButtonDown(e){this._button=e.button}onTouch(e,t,i){0!==this.panningSensibility&&(this._ctrlKey||this._altKey)&&1===this._button?this.pan(t,i):1===this._button&&this.rotate(t,i)}pan(e,t){var i;this.enablePan&&(i=this.getPanSpeedPercent(),this.camera.inertialPanningX+=-e/i,this.camera.inertialPanningY+=t/i)}rotate(e,t){this.enableRotate&&(this.camera.inertialAlphaOffset-=e/this.angularSensibilityX,this.camera.inertialBetaOffset-=t/this.angularSensibilityY)}}class ln extends an{constructor(e,t){super(e,t),this._scene=e,this._canvas=t,this._pointerInput=new hn,this._radius=10,this._alpha=Math.PI/4,this._beta=Math.PI/3,this._lowerRadiusLimit=.01,this._panningAxis=new n.Vector3(1,1,0),this._originPanTarget=n.Vector3.Zero(),this._panDistance=null,this._minZ=1,this._maxZ=nn,this.onRadiusChangeObserver=new n.Observable,e&&t&&(this.init(),this._camera.onViewMatrixChangedObservable.add((e=>{this._alpha=e.alpha,this._beta=e.beta,this._target.copyFrom(e.target),e.radius!==this._radius&&this.onRadiusChangeObserver.notifyObservers(e),this._mode===n.Camera.PERSPECTIVE_CAMERA&&(this._radius=e.radius),he.trigger({type:"CameraUpdate",target:this})})))}get Alpha(){return this._alpha}set Alpha(e){this._alpha=e,this._camera.alpha=e}get Beta(){return this._beta}set Beta(e){this._beta=e,this._camera.beta=e}get Aspect(){return this._canvas.width/this._canvas.height}get EnablePan(){return!!(this._enable&q.Pan)}set EnablePan(e){e?this._enable|=q.Pan:this._enable&=~q.Pan,this._pointerInput.enablePan=e}get EnableRotate(){return!!(this._enable&q.Roate)}set EnableRotate(e){e?this._enable|=q.Roate:this._enable&=~q.Roate,this._pointerInput.enableRotate=e}get EnableZoom(){return!!(this._enable&q.Zoom)}set EnableZoom(e){e!==this.EnableZoom&&(e?this._enable|=q.Zoom:this._enable&=~q.Zoom,this._mode===n.Camera.PERSPECTIVE_CAMERA&&(e?this._camera.inputs.attached.mousewheel.attachControl():this._camera.inputs.attached.mousewheel.detachControl()))}get Radius(){return this._radius}set Radius(e){this._radius=e,this._camera.radius=e}get IsFlying(){return this._flying}get Position(){return{x:this._camera.position.x,y:this._camera.position.y,z:this._camera.position.z}}set Position(e){var t=new n.Vector3;se(t,e),this._camera.setPosition(t),this._position.copyFrom(t)}get Target(){return{x:this._target.x,y:this._target.y,z:this._target.z}}set Target(e){se(this._target,e),this._camera.setTarget(this._target)}get LowerRadiusLimit(){return this._lowerRadiusLimit}set LowerRadiusLimit(e){e!==this._lowerRadiusLimit&&(this._lowerRadiusLimit=e,this.update())}get UpperRadiusLimit(){return this._upperRadiusLimit}set UpperRadiusLimit(e){e!==this._upperRadiusLimit&&(this._upperRadiusLimit=e,this.update())}get LowerAlphaLimit(){return this._lowerAlphaLimit}set LowerAlphaLimit(e){e!==this._lowerAlphaLimit&&(this._lowerAlphaLimit=e,this.update())}get UpperAlphaLimit(){return this._upperAlphaLimit}set UpperAlphaLimit(e){e!==this._upperAlphaLimit&&(this._upperAlphaLimit=e,this.update())}get LowerBetaLimit(){return this._lowerBetaLimit}set LowerBetaLimit(e){e!==this._lowerBetaLimit&&(this._lowerBetaLimit=e,this.update())}get UpperBetaLimit(){return this._upperBetaLimit}set UpperBetaLimit(e){e!==this._upperBetaLimit&&(this._upperBetaLimit=e,this.update())}get PanningAxis(){return ae(this._panningAxis)}set PanningAxis(e){se(this._panningAxis,e),this.update()}get OriginPanTarget(){return ae(this._originPanTarget)}set OriginPanTarget(e){se(this._originPanTarget,e),this.update()}get PanDistance(){return this._panDistance}set PanDistance(e){e!==this._panDistance&&(this._panDistance=e,this.update())}get MinZ(){return this._minZ}set MinZ(e){e!==this._minZ&&(this._minZ=e,this.update())}get MaxZ(){return this._maxZ}set MaxZ(e){e!==this._maxZ&&(this._maxZ=e,this.update())}zoomTo(e,t){this._camera.setTarget(new n.Vector3(e.x,e.y)),this.Mode===n.Camera.ORTHOGRAPHIC_CAMERA?(this.zoomScale=1.2,this.Size=Math.max(...t.asArray())/2,this._camera.position=new n.Vector3(e.x,e.y,1)):(this._camera.alpha=0,this._camera.beta=0,this._camera.radius=Math.max(...t.asArray())*this.Aspect,this._camera.position=new n.Vector3(e.x,e.y,this._camera.radius))}zoomByBoundBox(e,t){const i=this._camera;i.useFramingBehavior=!0,super.zoomByBoundBox(e,t),i.useFramingBehavior=!1,i.lowerRadiusLimit=this._lowerRadiusLimit}zoomAll(){var e=e=>e.isVisible&&e.isEnabled()&&"WORLD_GROUND"!==e.name&&!e.getBoundingInfo().boundingBox.extendSize.equalsWithEpsilon(n.Vector3.Zero());if(this._scene.meshes.filter(e).length){const{max:t,min:i}=this._scene.getWorldExtends(e);t.equalsWithEpsilon(i,.001)||this.zoomByBoundBox(i,t)}}init(){const e=new n.ArcRotateCamera("MainArcRotateCamera",this._alpha,this._beta,this._radius,this._target,this._scene),t=((this._camera=e).mode=this._mode,e.wheelPrecision=this.wheelSpeed,e.wheelDeltaPercentage=this.wheelDeltaPercentage,e.maxZ=this._maxZ,e.minZ=this._minZ,e.inertia=.5,e.panningInertia=.5,e.lowerRadiusLimit=this._lowerRadiusLimit,e.inputs.removeByType("ArcRotateCameraPointersInput"),this._pointerInput=new hn,this._pointerInput.enableRotate=this.EnableRotate,this._pointerInput.enablePan=this.EnablePan,e.inputs.add(this._pointerInput),e.inputs.attached.mousewheel);t&&(t.customComputeDeltaFromMouseWheel=(t,i,r)=>{let s=0;if(this.wheelDeltaPercentage&&!r.altKey){if(0<(s=this._computeDeltaFromMouseWheelLegacyEvent(t,e.radius))){let i=e.radius,r=e.inertialRadiusOffset+s;for(let t=0;t<20&&.001<Math.abs(r);t++)i-=r,r*=e.inertia;i=n.Scalar.Clamp(i,0,Number.MAX_VALUE),s=this._computeDeltaFromMouseWheelLegacyEvent(t,i)}}else s=t/(40*e.wheelPrecision);return s}),this._mode===n.Camera.ORTHOGRAPHIC_CAMERA?this.initOrthCamera():this.initPerCamera()}set WheelSpeed(e){this._camera.wheelPrecision=this.wheelSpeed}get Mode(){return this._mode}set Mode(e){e!==n.Camera.ORTHOGRAPHIC_CAMERA&&e!==n.Camera.PERSPECTIVE_CAMERA||(this._mode=e,(this._camera.mode=e)===n.Camera.ORTHOGRAPHIC_CAMERA?(this._camera.radius=sn,this.initOrthCamera()):(this._camera.radius=this._radius,this.initPerCamera()))}set ViewMode(e){switch(e){case Y.Up:this._camera.position=this._camera.target.clone().add(new n.Vector3(0,0,10));break;case Y.Down:this._camera.position=this._camera.target.clone().add(new n.Vector3(0,0,-10));break;case Y.Left:this._camera.position=this._camera.target.clone().add(new n.Vector3(-10));break;case Y.Right:this._camera.position=this._camera.target.clone().add(new n.Vector3(10));break;case Y.Front:this._camera.position=this._camera.target.clone().add(new n.Vector3(0,10));break;case Y.Back:this._camera.position=this._camera.target.clone().add(new n.Vector3(0,-10));break;case Y.SW:this._camera.position=this._camera.target.clone().add(new n.Vector3(10,10,10))}}initPerCamera(){this.customWheel&&(this._scene.onPointerObservable.remove(this.customWheel),this.customWheel=null,this.EnableZoom&&this._camera.inputs.attached.mousewheel.attachControl())}attachControl(){this._camera.attachControl(this._canvas,!0,!0)}detachControl(){this._camera.detachControl()}lookAt(e){this._camera.setTarget(ne(e))}rotateAround(e){var{target:e,angleX:t,angleY:i,frame:r=30,time:s=10,loop:o=!1}=e;if(t||i){e&&this._camera.target.copyFrom(ne(e));const a=new n.AnimationGroup("camera-around-group");if(t){const e=new n.Animation("camera-around","alpha",r,n.Animation.ANIMATIONTYPE_FLOAT);this._camera.inertialAlphaOffset,e.setKeys([{frame:0,value:0},{frame:s/2*r,value:t/2},{frame:s*r,value:t}]),a.addTargetedAnimation(e,this._camera)}if(i){const e=new n.Animation("camera-around","beta",r,n.Animation.ANIMATIONTYPE_FLOAT);e.setKeys([{frame:0,value:0},{frame:s/2*r,value:i/2},{frame:s*r,value:i}]),a.addTargetedAnimation(e,this._camera)}return a.play(o),{clear:()=>{a.dispose(),this._animateGroup=null},stop:()=>a.stop(),pause:()=>a.pause(),reset:()=>a.reset(),restart:()=>a.restart()}}}moveTo(e){var{alpha:e,beta:t,radius:i,target:r,time:s=1}=e;if(void 0!==e||void 0!==t||void 0!==i||void 0!==r){const o=new n.AnimationGroup("camera-move-to",this._scene);if(void 0!==e){const t=new n.Animation("alpha-a","alpha",30,n.Animation.ANIMATIONTYPE_FLOAT);t.setKeys([{frame:0,value:this._camera.alpha},{frame:30*s,value:e}]),o.addTargetedAnimation(t,this._camera)}if(void 0!==t){const e=new n.Animation("beta-a","beta",30,n.Animation.ANIMATIONTYPE_FLOAT);e.setKeys([{frame:0,value:this._camera.beta},{frame:30*s,value:t}]),o.addTargetedAnimation(e,this._camera)}if(void 0!==i){const e=new n.Animation("radius-a","radius",30,n.Animation.ANIMATIONTYPE_FLOAT);e.setKeys([{frame:0,value:this._camera.radius},{frame:30*s,value:i}]),o.addTargetedAnimation(e,this._camera)}if(void 0!==r){const e=new n.Animation("target-a","target",30,n.Animation.ANIMATIONTYPE_VECTOR3);e.setKeys([{frame:0,value:this._camera.target},{frame:30*s,value:ne(r)}]),o.addTargetedAnimation(e,this._camera)}return{start:()=>(o.start(),new Promise((e=>o.onAnimationEndObservable.add(e)))),clear:()=>{o.dispose(),this._animateGroup=null},stop:()=>o.stop(),pause:()=>o.pause(),reset:()=>o.reset(),restart:()=>o.restart()}}}update(){this._camera.mode=this._mode,this._camera.setTarget(this._target),this._camera.alpha=this._alpha,this._camera.beta=this._beta,this._camera.lowerRadiusLimit=this._lowerRadiusLimit,this._camera.upperRadiusLimit=this._upperRadiusLimit,this._camera.lowerAlphaLimit=this._lowerAlphaLimit,this._camera.upperAlphaLimit=this._upperAlphaLimit,this._camera.lowerBetaLimit=this._lowerBetaLimit,this._camera.upperBetaLimit=this._upperBetaLimit,this._camera.minZ=this._minZ,this._camera.maxZ=this._maxZ,this._camera.panningOriginTarget.copyFrom(this._originPanTarget),this._camera.panningAxis.copyFrom(this._panningAxis),this._camera.panningDistanceLimit=this.PanDistance,this._mode===n.Camera.PERSPECTIVE_CAMERA?this._camera.radius=this._radius:this._camera.radius=sn}reset(){this._target.copyFrom(n.Vector3.Zero()),this._alpha=Math.PI/4,this._beta=Math.PI/3,this._radius=10,this.update()}writeFile(e){e.write(5),super.writeFile(e),e.write(this._alpha),e.write(this._beta),e.write(this._radius),e.write(this._lowerRadiusLimit),e.write(this._upperRadiusLimit),e.write(this._lowerAlphaLimit),e.write(this._upperAlphaLimit),e.write(this._lowerBetaLimit),e.write(this._upperBetaLimit),e.write(this._panDistance),e.write(this._panningAxis.x),e.write(this._panningAxis.y),e.write(this._panningAxis.z),e.write(this._originPanTarget.x),e.write(this._originPanTarget.y),e.write(this._originPanTarget.z),e.write(this._minZ),e.write(this._maxZ)}readFile(e){var t=e.read();1<t&&super.readFile(e),this._alpha=e.read(),this._beta=e.read(),this._radius=e.read(),2<t&&(this._lowerRadiusLimit=e.read(),this._upperRadiusLimit=e.read(),this._lowerAlphaLimit=e.read(),this._upperAlphaLimit=e.read(),this._lowerBetaLimit=e.read(),this._upperBetaLimit=e.read()),3<t&&(this._panDistance=e.read(),this._panningAxis.x=e.read(),this._panningAxis.y=e.read(),this._panningAxis.z=e.read(),this._originPanTarget.x=e.read(),this._originPanTarget.y=e.read(),this._originPanTarget.z=e.read()),4<t&&(this._minZ=e.read(),this._maxZ=e.read()),this._mode===n.Camera.ORTHOGRAPHIC_CAMERA&&this.initOrthCamera(),this.update()}_computeDeltaFromMouseWheelLegacyEvent(e,t){return t=.01*e*this.wheelDeltaPercentage*t,0<e?t/(1+this.wheelDeltaPercentage):t*(1+this.wheelDeltaPercentage)}}class cn extends an{constructor(e,t){super(e,t),this._scene=e,this._canvas=t,e&&t&&(this.init(),this._camera.onViewMatrixChangedObservable.add((e=>{this._position.copyFrom(e.position),this._target.copyFrom(e.target),he.trigger({type:"CameraUpdate",target:this})})))}get EnableZoom(){return!!(this._enable&q.Zoom)}set EnableZoom(e){e!==this.EnableZoom&&(e?this._enable|=q.Zoom:this._enable&=~q.Zoom,this._mode===n.Camera.PERSPECTIVE_CAMERA&&(e?this._camera.inputs.attached.mousewheel.attachControl():this._camera.inputs.attached.mousewheel.detachControl()))}get IsFlying(){return this._flying}get Position(){return{x:this._camera.position.x,y:this._camera.position.y,z:this._camera.position.z}}set Position(e){var t=new n.Vector3;se(t,e),this._camera.position.copyFromFloats(t.x,t.y,t.z)}get Target(){return{x:this._target.x,y:this._target.y,z:this._target.z}}set Target(e){se(this._target,e),this._camera.setTarget(this._target)}zoomTo(e,t){this._camera.setTarget(new n.Vector3(e.x,e.y))}zoomByBoundBox(e,t){super.zoomByBoundBox(e,t)}init(){const e=new n.FreeCamera("MainFreeCamera",this._position,this._scene);e.inputs._mouseInput.buttons=[1],e.keysDown=[p.KeyS],e.keysDownward=[p.ArrowDown],e.keysUp=[p.KeyW],e.keysUpward=[p.ArrowUp],e.keysLeft=[p.KeyA],e.keysRight=[p.KeyD],e.inputs.addMouseWheel(),e.maxZ=nn,this._camera=e,this._mode===n.Camera.ORTHOGRAPHIC_CAMERA?this.initOrthCamera():this.initPerCamera()}set ViewMode(e){switch(e){case Y.Up:this._camera.position=this._camera.target.clone().add(new n.Vector3(0,0,10));break;case Y.Down:this._camera.position=this._camera.target.clone().add(new n.Vector3(0,0,-10));break;case Y.Left:this._camera.position=this._camera.target.clone().add(new n.Vector3(-10));break;case Y.Right:this._camera.position=this._camera.target.clone().add(new n.Vector3(10));break;case Y.Front:this._camera.position=this._camera.target.clone().add(new n.Vector3(0,10));break;case Y.Back:this._camera.position=this._camera.target.clone().add(new n.Vector3(0,-10));break;case Y.SW:this._camera.position=this._camera.target.clone().add(new n.Vector3(10,10,10))}}initOrthCamera(){this._camera.orthoTop=this.size,this._camera.orthoBottom=-this.size,this._camera.orthoLeft=-this.size*this.Aspect,this._camera.orthoRight=this.size*this.Aspect,this._camera.inputs.attached.mousewheel.detachControl(),this.customWheel=this._scene.onPointerObservable.add((e=>{if(this.EnableZoom){let t=0;t=(e=e.event).wheelDelta?-e.wheelDelta:60*-(e.deltaY||e.detail),this.zoomScale+=t/(100*this.wheelSpeed),this.zoomScale<0?this.zoomScale=.001:this.updateOrthCamera()}}),n.PointerEventTypes.POINTERWHEEL)}initPerCamera(){this.customWheel&&(this._scene.onPointerObservable.remove(this.customWheel),this.customWheel=null,this.EnableZoom&&this._camera.inputs.attached.mousewheel.attachControl())}attachControl(){this._camera.attachControl(this._canvas,!0)}detachControl(){this._camera.detachControl()}lookAt(e){this._camera.setTarget(ne(e))}moveTo(e){var{target:e,time:t=1,position:i}=e;if(void 0!==i||void 0!==e){const r=new n.AnimationGroup("camera-move-to",this._scene);if(void 0!==e){const i=new n.Animation("target-a","target",30,n.Animation.ANIMATIONTYPE_VECTOR3);i.setKeys([{frame:0,value:this._camera.target},{frame:30*t,value:ne(e)}]),r.addTargetedAnimation(i,this._camera)}if(void 0!==i){const e=new n.Animation("position","position",30,n.Animation.ANIMATIONTYPE_VECTOR3);e.setKeys([{frame:0,value:this._camera.position},{frame:30*t,value:ne(i)}]),r.addTargetedAnimation(e,this._camera)}return{start:()=>(r.start(),new Promise((e=>r.onAnimationEndObservable.add(e)))),clear:()=>{r.dispose(),this._animateGroup=null},stop:()=>r.stop(),pause:()=>r.pause(),reset:()=>r.reset(),restart:()=>r.restart()}}}update(){this._camera.mode=this._mode,this._camera.setTarget(this._target),this._camera.position=this._position,this._mode===n.Camera.ORTHOGRAPHIC_CAMERA&&this.updateOrthCamera()}reset(){this._target.copyFrom(n.Vector3.Zero()),this.update()}updateOrthCamera(){this._camera.orthoTop=this.size*this.zoomScale,this._camera.orthoBottom=-this.size*this.zoomScale,this._camera.orthoLeft=-this.size*this.zoomScale*this.Aspect,this._camera.orthoRight=this.size*this.zoomScale*this.Aspect}writeFile(e){e.write(2),super.writeFile(e),e.write(this._position.x),e.write(this._position.y),e.write(this._position.z)}readFile(e){1<e.read()&&super.readFile(e),this._position.x=e.read(),this._position.y=e.read(),this._position.z=e.read(),this.update()}}!function(e){e[e.ArcRotate=0]="ArcRotate",e[e.FreeCamera=1]="FreeCamera",e[e.Follow=2]="Follow"}(xr=xr||{});class un{constructor(e,t){this._scene=e,this._canvas=t,this._type=xr.ArcRotate,this.init()}get Type(){return this._type}set Type(e){this._type=e,this.switch()}get Control(){return this._control}get Camera(){return this._control.CurrentCamera}get ArcRotateCamera(){return this.ArcRotateControl.CurrentCamera}get FreeCamera(){return this.FreeControl.CurrentCamera}get Alpha(){return this._control.Alpha}set Alpha(e){this._control.Alpha=e}get Beta(){return this._control.Beta}set Beta(e){this._control.Beta=e}get Radius(){return this.ArcRotateControl.Radius}set Radius(e){this.ArcRotateControl.Radius=e}get Position(){return this.Control.Position}set Position(e){this.Control.Position=e}get Target(){return this.Control.Target}set Target(e){this.Control.Target=e}get Mode(){return this.Control.Mode}set Mode(e){this.Control.Mode=e}get ZoomScale(){return this.Control.zoomScale}init(){this.ArcRotateControl=new ln(this._scene,this._canvas),this.FreeControl=new cn(this._scene,this._canvas),this._control=this.ArcRotateControl,this._control.active()}switch(){switch(this._control.detachControl(),this._type){case xr.ArcRotate:this._control=this.ArcRotateControl;break;case xr.FreeCamera:this._control=this.FreeControl;case xr.Follow:}this._control.active(),this.switchEvent(this)}switchEvent(e){}zoomAll(){this._control.zoomAll()}zoomToEntity(e){this._control.zoomToEntity(e)}reset(){this.ArcRotateControl.reset(),this.FreeControl.reset()}destory(){this.ArcRotateControl.destory(),this.FreeControl.destory()}writeFile(e){e.write(1),e.write(this._type),this.ArcRotateControl.writeFile(e),this.FreeControl.writeFile(e)}readFile(e){e.read(),this._type=e.read(),this.ArcRotateControl.readFile(e),this.FreeControl.readFile(e),this.switch()}}class dn{static LoadSkyboxPathTexture(e){var t=Math.max(0,class{static ReadLocalStorageValue(e,t){return"undefined"!=typeof Storage&&null!==localStorage.getItem(e)?parseInt(localStorage.getItem(e)):t}}.ReadLocalStorageValue("defaultSkyboxId",0));const i=this.SkyboxPath||this.Skyboxes[t];return i.indexOf(".hdr")===i.length-4?new n.HDRCubeTexture(i,e,256,!1,!0,!1,!0):n.CubeTexture.CreateFromPrefilteredData(i,e)}}function pn(e,t,i,r){e=[{frame:0,value:e},{frame:30*r,value:t}];const s=new n.Animation("animation"+Date.now(),i,30,n.Animation.ANIMATIONTYPE_FLOAT,n.Animation.ANIMATIONLOOPMODE_CONSTANT);return s.setKeys(e),s}dn.SkyboxPath="",dn.Skyboxes=["https://am-img.gkiiot.com/editor/envs/environmentSpecular.env","https://am-img.gkiiot.com/editor/envs/studio.env"],dn.SkyboxesNames=["Default","Studio"];const _n=["groundMaterial","skyMaterial","skyBox","default material"],fn=["px.jpg","py.jpg","pz.jpg","nx.jpg","ny.jpg","nz.jpg"];class gn{constructor(e){this._skybox="",this._mode=te.None,this._turbidity=10,this._luminance=1,this._rayleigh=2,this._sunPosition=new n.Vector3(0,100,0),this._inclination=0,this._azimuth=.25,this._mieDirectionalG=.8,this._mieCoefficient=.005,this._isReflect=!1,this.LoadObserable=new n.Observable,this.watchMaterial=e=>{setTimeout((()=>{this.reflectMaterial(e)}),0)},this.onLoad=()=>{he.trigger({type:"loadBackground",target:null}),this.LoadObserable.notifyObservers(!0)},this._scene=new n.Scene(e,{useMaterialMeshMap:!0,useClonedMeshMap:!0}),this._scene.ambientColor=n.Color3.FromHexString("#222222"),this._scene.useRightHandedSystem=!0,this.BlockMaterialUpdate=!0,this.initReflection(),this.init()}init(){const e=new n.GlowLayer("glow",this._scene);e.intensity=.5,this._glowLayer=e}initReflection(){this._reflectionProbe&&this._reflectionProbe.dispose();var e=new n.ReflectionProbe("ref",512,this._scene);this._reflectionProbe=e}get Scene(){return this._scene}get Mode(){return this._mode}set Mode(e){this._mode=e,this.update()}get Skybox(){return this._skybox}set Skybox(e){this._skybox!==e&&(this._skybox=e,this.showSkyBox())}get AmbientColor(){return this._scene.ambientColor.toHexString()}set AmbientColor(e){this.Scene.ambientColor=n.Color3.FromHexString(e)}get EmissiveIntensity(){return this._glowLayer.intensity}set EmissiveIntensity(e){this._glowLayer.intensity=e}get Background(){return this.Scene.clearColor.toHexString(!0)}set Background(e){var t;"string"==typeof e?this.Scene.clearColor=n.Color4.FromHexString(e+"FF"):Array.isArray(e)?this.Scene.clearColor=new n.Color4(e[0]/255,e[1]/255,e[2]/255,null!=(t=e[3])?t:1):this.Scene.clearColor=e}get Turbidity(){return this._turbidity}set Turbidity(e){e!==this._turbidity&&(this._turbidity=e,this.update())}get Rayleigh(){return this._rayleigh}set Rayleigh(e){e!==this._rayleigh&&(this._rayleigh=e,this.update())}get Luminance(){return this._luminance}set Luminance(e){e!==this._luminance&&(this._luminance=e,this.update())}get SunPosition(){return{x:this._sunPosition.x,y:this._sunPosition.y,z:this._sunPosition.z}}set SunPosition(e){se(this._sunPosition,e),this.update()}get Inclination(){return this._inclination}set Inclination(e){e!==this._inclination&&(this._inclination=e,this.update())}get Azimuth(){return this._azimuth}set Azimuth(e){e!==this._azimuth&&(this._azimuth=e,this.update())}get IsReflect(){return this._isReflect}set IsReflect(e){e!==this._isReflect&&((this._isReflect=e)?(this._scene.onNewMaterialAddedObservable.add(this.watchMaterial),this.reflect()):(this._scene.onNewMaterialAddedObservable.removeCallback(this.watchMaterial),this.cancelReflect()))}get BlockMaterialUpdate(){return this._scene.blockMaterialDirtyMechanism}set BlockMaterialUpdate(e){this._scene.blockMaterialDirtyMechanism=e}debugger(e={}){fe.debugger&&this._scene.debugLayer.show(Object.assign({embedMode:!0},e))}render(){this._scene.activeCamera&&this._scene.render()}update(){switch(this._mode){case te.Image:this.showSkyBox();break;case te.Sun:this.getSkyBox(),this._skyMaterial.inclination=this._inclination,this._skyMaterial.azimuth=this._azimuth,this._skyMaterial.rayleigh=this._rayleigh,this._skyMaterial.turbidity=this._turbidity,this._skyMaterial.luminance=this._luminance,this._skyMaterial.mieDirectionalG=this._mieDirectionalG,this._skyMaterial.mieCoefficient=this._mieCoefficient;break;case te.Env:break;default:this.hiddenSkyBox()}}reflect(){return v(this,void 0,void 0,(function*(){this.BlockMaterialUpdate=!1;let e=0;for(const t of this._scene.materials)_n.includes(t.name)||(this.reflectMaterial(t),5===e?(yield z(100),e=0):e++);this.BlockMaterialUpdate=!0}))}cancelReflect(){return v(this,void 0,void 0,(function*(){this.BlockMaterialUpdate=!1;let e=0;for(const t of this._scene.materials)_n.includes(t.name)||(this.cancelReflectMaterial(t),5===e?(yield z(100),e=0):e++);this.BlockMaterialUpdate=!0}))}createDefaultEnv(){this._scene.environmentTexture=dn.LoadSkyboxPathTexture(this._scene),this._scene.createDefaultSkybox(this._scene.environmentTexture,!0,(this._scene.activeCamera.maxZ-this._scene.activeCamera.minZ)/2,.3,!1)}loadEnv(e){this.BlockMaterialUpdate=!1,e=n.CubeTexture.CreateFromPrefilteredData(e,this._scene),this._scene.environmentTexture=e,this.BlockMaterialUpdate=!0}reset(){this._skybox="",this._scene.clearColor=new n.Color4(.2,.2,.3,1),this._reflectionProbe.dispose(),this._reflectionProbe=new n.ReflectionProbe("ref",512,this._scene),this.update()}writeFile(e){e.write(2),e.write(this._skybox),e.write(this.EmissiveIntensity),e.write(this.Background),e.write(this.AmbientColor),e.write(this._mode),e.write(this._turbidity),e.write(this._luminance),e.write(this._rayleigh),e.write(this._sunPosition.x),e.write(this._sunPosition.y),e.write(this._sunPosition.z),e.write(this._isReflect),e.write(this._inclination),e.write(this._azimuth)}readFile(e){this.initReflection();var t=e.read();this._skybox=e.read(),this.EmissiveIntensity=e.read(),this.Background=e.read(),this.AmbientColor=e.read(),this._mode=e.read(),this._turbidity=e.read(),this._luminance=e.read(),this._rayleigh=e.read(),this._sunPosition.x=e.read(),this._sunPosition.y=e.read(),this._sunPosition.z=e.read(),this.IsReflect=e.read(),1<t&&(this._inclination=e.read(),this._azimuth=e.read()),this.update()}testLights(){var[e,t,i]=[275,30,180],[r,s]=[225,146],[o,a]=[80,148],[h,l]=[-71,190];const c=[new n.Vector3(e,t,i-36),new n.Vector3(r-43,t,s),new n.Vector3(r-43,t,s-30),new n.Vector3(o-43,t,a),new n.Vector3(h,t,l-43)];let u=1;this._scene.materials.forEach((e=>e.maxSimultaneousLights=c.length+1));for(const e of c){const t=new n.SpotLight("s"+u++,e,new n.Vector3(0,-1),2*Math.PI,2,this._scene);t.intensity=3e3,t.range=1e3}}day2Evening(e=!1){if(this._skyMaterial){const h=[this._turbidity,1],l=[this._rayleigh,0],c=[this._luminance,.8],u=[this._inclination,-.48],d=[this._inclination,-.48],p=[1,-.1],_=(e&&(h.reverse(),l.reverse(),c.reverse(),u.reverse(),d.reverse(),p.reverse()),new n.AnimationGroup("d2e"));e=pn(h[0],h[1],"material.turbidity",6);var t=pn(l[0],l[1],"material.rayleigh",6),i=pn(c[0],c[1],"material.luminance",6),r=pn(u[0],u[1],"material.inclination",6),s=pn(d[0],d[1],"material.azimuth",6),o=this._scene.lights[0],a=pn(p[0],p[1],"intensity",6);this._scene.stopAnimation(this._skyboxMesh),this._scene.stopAnimation(o);for(const n of[e,t,i,r,s])_.addTargetedAnimation(n,this._skyboxMesh);_.addTargetedAnimation(a,o),_.start(!1,1,0,180)}}showFog(e=200,t=1e3){this._scene.fogMode=n.Scene.FOGMODE_LINEAR,this._scene.fogColor=new n.Color3(.9,.9,.85),this._scene.fogDensity=.01,this._scene.fogStart=e,this._scene.fogEnd=t}showSkyBox(){this._skybox?["png","jpg","jpeg"].some((e=>this._skybox.endsWith(e)))?(this.hiddenBox(),this._layer?(he.trigger({type:"loadingBackground",target:null}),this._layer.isEnabled=!0,this._layer.texture.updateURL(fe.SkyBox_URL+this._skybox,null,this.onLoad)):this._layer=new n.Layer("GlobalBackground",fe.SkyBox_URL+this._skybox,this._scene,!0)):(this.hiddenLayer(),this._skybox.endsWith("hdr")?this.setSkyboxByHdr(fe.SkyBox_URL+this._skybox):(he.trigger({type:"loadingBackground",target:null}),this.setEnvTexture(new n.CubeTexture(fe.SkyBox_URL+this._skybox,this._scene,fn,void 0,null,this.onLoad)))):this.hiddenSkyBox()}hiddenLayer(){this._layer&&(this._layer.isEnabled=!1)}hiddenBox(){this._skyboxMesh&&this._skyboxMesh.setEnabled(!1)}hiddenSkyBox(){this.hiddenBox(),this.hiddenLayer()}setSkyboxByHdr(e){e=new n.HDRCubeTexture(e,this._scene,512),this.setEnvTexture(e)}getSkyBox(){const e=this.createSkybox();return e.setEnabled(!0),this._mode===te.Sun?e.material=this.getSkyMaterial():this._mode===te.Env?e.material=this.getPBRMaterial():e.material=this.getStandMaterial(),e}createSkybox(){if(this._skyboxMesh)return this._skyboxMesh;const e=(0,n.CreateBox)("skybox",{size:nn},this._scene);return e.isPickable=!1,e.infiniteDistance=!0,e.ignoreCameraMaxZ=!0,this._reflectionProbe.renderList.push(e),this._skyboxMesh=e,this._skyboxMesh}getStandMaterial(){if(this._standMaterial)return this._standMaterial;const e=new n.StandardMaterial("skyBox",this._scene);return(this._standMaterial=e).backFaceCulling=!1,e.disableLighting=!0,this._standMaterial=e,this._standMaterial}getPBRMaterial(){if(this._pbrMaterial)return this._pbrMaterial;const e=new n.PBRMaterial("skyBox",this._scene);return e.backFaceCulling=!1,e.reflectionTexture&&(e.reflectionTexture.coordinatesMode=n.Texture.SKYBOX_MODE),e.microSurface=1,e.disableLighting=!0,e.twoSidedLighting=!0,this._pbrMaterial=e,this._pbrMaterial}getSkyMaterial(){if(this._skyMaterial)return this._skyMaterial;const e=new o.SkyMaterial("skyMaterial",this._scene);return e.backFaceCulling=!1,this._skyMaterial=e,this._skyMaterial}setEnvTexture(e){const t=this.getSkyBox().material;t.reflectionTexture=e,t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=n.Texture.SKYBOX_MODE)}reflectMaterial(e){var t;_n.includes(e.name)||(e instanceof n.StandardMaterial||e instanceof n.PBRMaterial)&&(this.BlockMaterialUpdate=!1,t=e.reflectionTexture,e.metadata=t,e.reflectionTexture=this._reflectionProbe.cubeTexture,e.realTimeFiltering=!0,this.BlockMaterialUpdate=!0)}cancelReflectMaterial(e){_n.includes(e.name)||(e instanceof n.StandardMaterial||e instanceof n.PBRMaterial)&&(e.reflectionTexture=e.metadata,e.metadata=null,e.realTimeFiltering=!1)}}function mn({color:e,dir:t,height:i,cameraHeight:r,scene:o,cm:a,reverse:h=!1},l){const c=h?-1:1,u=new n.TransformNode((h?"-":"")+t+"-label",o),d=(u.position[t]=i*c,new s.Ellipse),p=(d.isPointerBlocker=!0,d.width="120px",d.height="120px",d.thickness=4,d.color=e,d.background=e,new s.TextBlock(t,(h?"-":"")+t.toUpperCase())),_=(p.fontSize=70,p.fontWeight="400",p.color="#000000",d.addControl(p),o.activeCamera);return d.onPointerClickObservable.add((e=>{_.restoreState();const i=new n.Vector3,s=new n.Vector3;if(s[t]=r*c,a.Camera instanceof n.ArcRotateCamera){const e=a.Camera;var o=e.radius;i[t]=o*c,a.Position=e.target.add(i)}else a.Camera instanceof n.FreeCamera&&(o=n.Vector3.Distance(a.Camera.target,a.Camera.position),i[t]=o*c,a.Target=a.Camera.position.add(i));_.setPosition(s)})),d.onPointerEnterObservable.add((()=>{p.color="#ffffff"})),d.onPointerOutObservable.add((()=>{p.color="#000000"})),l.addControl(d),d.linkWithMesh(u),d}class yn{constructor(e,t,i){this.engine=e,this.cameraManger=i,this._cameraHeight=3.2,this.ellipses=[],this.stopRender=!1,this.onArcRotateChange=e=>{const t=this.Scene.activeCamera;t instanceof n.ArcRotateCamera&&(t.alpha=e.alpha,t.beta=e.beta)},this.onFreeChange=e=>{const t=this.Scene.activeCamera;t instanceof n.ArcRotateCamera&&(e=e.position.subtract(e.target).normalize().scale(this._cameraHeight),t.position=e)},this.init(),this.initViewHelper();const r=n.Frustum.GetPlanes(this._scene.getTransformMatrix());this._scene.registerBeforeRender((()=>{this.ellipses.forEach((e=>{e.linkedMesh&&this.isInFrustum(r,e.linkedMesh.position)&&this.changeZIndex(e,e.linkedMesh,Math.round(1e3/t.activeCamera.position.subtract(e.linkedMesh.position).length()))}))})),t.onActiveCameraChanged.add((e=>{e.activeCamera instanceof n.FreeCamera&&!this.FreeObserver&&(this.FreeObserver=t.activeCamera.onViewMatrixChangedObservable.add(this.onFreeChange))})),this._scene.activeCamera instanceof n.ArcRotateCamera&&t.activeCamera instanceof n.ArcRotateCamera&&(this._scene.activeCamera.alpha=t.activeCamera.alpha,this._scene.activeCamera.beta=t.activeCamera.beta),t.activeCamera.onViewMatrixChangedObservable.add(this.onArcRotateChange)}get Scene(){return this._scene}render(){this._scene.activeCamera&&!this.stopRender&&this._scene.render()}init(){const e=new n.Scene(this.engine),t=(e.autoClear=!1,e.ambientColor=n.Color3.White(),e.createDefaultCamera(!0,!0,!0),e.useRightHandedSystem=!0,e.activeCamera);t.viewport=new n.Viewport(.85,.85,.15,.15),t.detachControl(),t.target=n.Vector3.Zero(),t.setPosition(new n.Vector3(0,0,this._cameraHeight)),this._scene=e}initViewHelper(){var e={diameter:.05,height:1,tessellation:96},t=new n.TransformNode("viewerHelper",this._scene),i="#ff3653",r="#8adb00",o="#2c8fff";const a=(0,n.CreateCylinder)("x-line",e,this._scene),h=(a.position.x+=.5,a.rotation.z=Math.PI/2,a.parent=t,new n.StandardMaterial("",this._scene)),l=(h.ambientColor=n.Color3.FromHexString(i),a.material=h,(0,n.CreateCylinder)("y-line",e,this._scene)),c=new n.StandardMaterial("",this._scene),u=(c.ambientColor=n.Color3.FromHexString(r),l.material=c,l.position.y+=.5,(0,n.CreateCylinder)("z-line",e,this._scene)),d=new n.StandardMaterial("",this._scene);d.ambientColor=n.Color3.FromHexString(o),u.material=d,u.rotation.x=Math.PI/2,u.position.z+=.5,t=s.AdvancedDynamicTexture.CreateFullscreenUI("UI",!0,this._scene),e={height:1,cameraHeight:this._cameraHeight,scene:this._scene,cm:this.cameraManger},this.ellipses.push(mn(Object.assign(Object.assign({},e),{dir:"x",color:i}),t),mn(Object.assign(Object.assign({},e),{dir:"x",color:i,reverse:!0}),t),mn(Object.assign(Object.assign({},e),{dir:"y",color:r}),t),mn(Object.assign(Object.assign({},e),{dir:"y",color:r,reverse:!0}),t),mn(Object.assign(Object.assign({},e),{dir:"z",color:o}),t),mn(Object.assign(Object.assign({},e),{dir:"z",color:o,reverse:!0}),t))}changeZIndex(e,t,i){e.zIndex=i,e.linkWithMesh(t)}isInFrustum(e,t){for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}}class vn{constructor(e,t=!1,i={defaultLight:!1}){this.canvas=e,this.preview=t,this._option=i,this._showWorldAxes=!1,this._engineOption={preserveDrawingBuffer:!0,stencil:!0,useHighPrecisionMatrix:!0,premultipliedAlpha:!1,antialias:!0,forceSRGBBufferSupportState:!1},this.Reading=!1,this.pauseRender=!1,this.renderFunction=()=>{this.renderEvent(),this.Reading||this.pauseRender||(this.sceneControl.render(),this._sceneHelper&&this._sceneHelper.render())},this.init(),this._regiser(),this.render()}get Scene(){return this.sceneControl.Scene}get ShowAxesViewer(){return this._showWorldAxes}set ShowAxesViewer(e){this._showWorldAxes=e,this._worldAxes&&(this._worldAxes.xAxis.setEnabled(e),this._worldAxes.yAxis.setEnabled(e),this._worldAxes.zAxis.setEnabled(e))}get AmbientColor(){return this.Scene.ambientColor}set AmibentColor(e){this.Scene.ambientColor=n.Color3.FromHexString(e)}get GuiContainer(){return this._advancedDynamicTexture}get PauseRender(){return this.PauseRender}set PauseRender(e){e!==this.pauseRender&&(this.pauseRender=e)&&setTimeout((()=>{this.engine.clear(this.Scene.clearColor,this.Scene.autoClear||this.Scene.forceWireframe||this.Scene.forcePointsCloud,this.Scene.autoClearDepthAndStencil,this.Scene.autoClearDepthAndStencil)}),0)}getPreviewUrl(e=!1,t=400){return v(this,void 0,void 0,(function*(){return this._sceneHelper&&(this._sceneHelper.stopRender=!0),this.utilLayer&&this.utilLayer.utilityLayerScene.rootNodes.forEach((e=>{e.metadata=e.isEnabled(),e.setEnabled(!1)})),e&&(this.setSize(400,400),yield z(0)),new Promise((i=>{n.Tools.CreateScreenshot(this.engine,this.Camera,t,(t=>{e&&this.setSize(),this._sceneHelper&&(this._sceneHelper.stopRender=!1),this.utilLayer&&this.utilLayer.utilityLayerScene.rootNodes.forEach((e=>{e.setEnabled(e.metadata)})),i(t)}))}))}))}getBlob(e=!1){return v(this,void 0,void 0,(function*(){return G(yield this.getPreviewUrl(e))}))}get ShowGround(){return this.ground.isEnabled()}set ShowGround(e){this.ground.setEnabled(e)}init(){this._initEngine(),this._initScene(),this._initCamera(),this._option.defaultLight&&this._initLight(),this.preview||this._initSceneHelper(),ge.Scene=this.Scene,this.highlightManager=new rn(this),this.setSize();var e=s.AdvancedDynamicTexture.CreateFullscreenUI("MainGuiContainer",!0,this.Scene);this._advancedDynamicTexture=e}initEditor(){this.utilLayer=new n.UtilityLayerRenderer(this.Scene),this._worldAxes=new n.AxesViewer(this.utilLayer.utilityLayerScene,1,0),this._worldAxes.xAxis.setEnabled(this._showWorldAxes),this._worldAxes.yAxis.setEnabled(this._showWorldAxes),this._worldAxes.zAxis.setEnabled(this._showWorldAxes),this.cameraManager.ArcRotateControl.onRadiusChangeObserver.add((e=>{this.updateAxes()})),this.cameraManager.ArcRotateControl.onZommScaleChangeObserver.add((e=>{this.updateAxes()}));const e=n.MeshBuilder.CreateGround("WORLD_GROUND",{width:4e3,height:4e3},this.Scene),t=(e.isPickable=!1,new o.GridMaterial("groundMaterial",this.Scene));t.lineColor=new n.Color3(79/255,79/255,79/255),t.mainColor=new n.Color3(61/255,61/255,61/255),t.opacity=.98,t.backFaceCulling=!1,t.gridRatio=10,t.freeze(),e.material=t,this.ground=e,this.highlightManager.exclude(e),Or(this.cameraManager,this.cameraManager.switchEvent,(e=>{this._worldAxes&&(e=this._showWorldAxes&&e.Type===xr.ArcRotate,this._worldAxes.xAxis.setEnabled(e),this._worldAxes.yAxis.setEnabled(e),this._worldAxes.zAxis.setEnabled(e))}))}get Width(){return this.engine.getRenderWidth()}get Height(){return this.engine.getRenderHeight()}get Camera(){return this.cameraManager.Camera}get FPS(){return this.engine.getFps()}setSize(e,t){this.engine.setSize(null!=e?e:this.canvas.parentElement.clientWidth,null!=t?t:this.canvas.parentElement.clientHeight)}world2screen(e){return n.Vector3.Project(ne(e),n.Matrix.IdentityReadOnly,this.Scene.getTransformMatrix(),this.Camera.viewport.toGlobal(this.Scene.getEngine().getRenderWidth(),this.Scene.getEngine().getRenderHeight()))}screen2World(e){const t=this.Scene.createPickingRay(e.x,e.y,this.Scene.getViewMatrix(),this.cameraManager.Camera,!0);return this.ground&&(this.ground.isPickable=!0),e=t.intersectsMesh(this.ground||this.Plane),this.ground&&(this.ground.isPickable=!1),e.hit?e.pickedPoint:null}render(){this.engine.runRenderLoop(this.renderFunction)}stopRender(){this.engine.stopRenderLoop()}destory(){this.Scene!==ge.MainScene&&(ge.Scene=ge.MainScene),this.cameraManager.destory(),this.engine.dispose()}on(e,t){let i;return"rendered"===e?(i=this.Scene.onAfterRenderObservable.add(t),()=>{this.Scene.onAfterRenderObservable.remove(i)}):()=>{}}zoomAll(){this.cameraManager.zoomAll()}reset(){this.cameraManager.reset(),this.sceneControl.reset(),this.updateAxes(!0)}_regiser(){}_initEngine(){var e=new n.Engine(this.canvas,!0,this._engineOption);this.engine=e}_initScene(){this.sceneControl=new gn(this.engine)}_initCamera(){this.cameraManager=new un(this.Scene,this.canvas)}_initLight(){new n.HemisphericLight("global-light",new n.Vector3(1,1,1),this.Scene)}_initSceneHelper(){this._sceneHelper=new yn(this.engine,this.Scene,this.cameraManager)}updateAxes(e=!1){var t,i;this.utilLayer&&(t=this.utilLayer.utilityLayerScene.activeCamera.globalPosition,this._worldAxes.xAxis.position.subtractToRef(t,re),t=re.length(),this.Camera.mode===n.Camera.ORTHOGRAPHIC_CAMERA?(i=this.cameraManager.ZoomScale,this._worldAxes.xAxis.scaling.setAll(100*i),this._worldAxes.yAxis.scaling.setAll(100*i),this._worldAxes.zAxis.scaling.setAll(100*i)):e?(this._worldAxes.xAxis.scaling.setAll(1),this._worldAxes.yAxis.scaling.setAll(1),this._worldAxes.zAxis.scaling.setAll(1)):(this._worldAxes.xAxis.scaling.setAll(t/15*4),this._worldAxes.yAxis.scaling.setAll(t/15*4),this._worldAxes.zAxis.scaling.setAll(t/15*4)))}renderEvent(){}writeFile(e){e.write(1),this.cameraManager.writeFile(e),this.sceneControl.writeFile(e)}readFile(e){this.Reading=!0,e.read(),this.cameraManager.readFile(e),this.sceneControl.readFile(e),this.Reading=!1,this.updateAxes(!0)}}class bn extends L{constructor(){super(),this._name="\u7c92\u5b50\u7279\u6548",this._isSelect=!1}get IsSelect(){return this._isSelect}set IsSelect(e){this._isSelect=e}get Name(){return this._name}set Name(e){this._name=e}get UniupeName(){return this.Name+this.Id}start(){}stop(){}destory(){}update(){}clone(){}fromJSON(e){return this}writeFile(e){super.writeFile(e),e.write(1),e.write(this._name)}readFile(e){super.readFile(e),e.read(),this._name=e.read()}}class wn{constructor(e){this.Object=e,this.filer=new D}save(){return this.Object&&0===this.filer.Data.length&&this.filer.writeObject(this.Object),this}getObject(e){return this.filer.reset(),this.filer.database=e,this.Object=this.filer.readObject(),this.filer.reset(),this.Object}readFile(e){e.read(),e=e.read(),this.filer.Data=e}writeFile(e){e.write(1),e.write(this.filer.Data)}}class xn{writeFile(e){}readFile(e){}}class Tn{constructor(e){this.index=e}get Index(){return this.index}readFile(e){e.read(),this.index=e.read()}writeFile(e){e.write(1),e.write(this.index)}}let Cn=class extends L{constructor(){super(...arguments),this.objects=[]}append(e){this._db&&!e.ObjectId?e._SetOwnerDatabase(this._db):e._SetDatabase(this._db),e.Owner=this._Owner,this.objects.push(e);let t=this.UndoRecord;if(t){let i=new xn;i.redoData=new wn(e).save(),i.undoData=new Tn(this.objects.length-1),t.writeObjectHistoryPath(this,i)}return this.appendEvent(e),e.ObjectId}appendEvent(e){}remove(e){e=this.objects.indexOf(e),this.removeIndex(e)}removeIndex(e){if(-1!==e){let t=this.objects[e];return this.objects.splice(e,1),t&&t.destory(),t}}destory(){super.destory();for(const e of this.objects)e.destory();this.objects.length=0}readFile(e){super.readFile(e),e.read();var t=e.read();this.objects=[];for(let r=0;r<t;r++){var i=e.readObject();i&&(this.objects.push(i),i.IsErase||this.appendEvent(i))}}writeFile(e){for(var t of(super.writeFile(e),e.write(1),e.write(this.objects.length),this.objects))e.writeObject(t)}_applyHistoryRecord(e){var t;e instanceof wn?(t=e.getObject(this._db),this.objects.push(t),this.appendEvent(t)):e instanceof Tn&&(t=this.removeIndex(e.Index),e.removeObject=t)}};Cn=y([E],Cn);const En=[_e,we,ve,bn];class Sn extends L{constructor(){super(),this.entityCol=new Cn,Ir(this.entityCol,this.entityCol.appendEvent,(e=>{this.appendEvent(e)}))}get Entitys(){return this.entityCol.objects.slice()}IsVaildObject(e){return En.some((t=>e instanceof t))}setCheckout(e){return this.checkout=e,this}append(e){this.checkout&&!this.checkout(e)||!this.IsVaildObject(e)||this.entityCol.append(e)}appendEvent(e){}_SetOwnerDatabase(e){return super._SetOwnerDatabase(e),this.entityCol._SetOwnerDatabase(e),this.entityCol.Owner=this.ObjectId,this}writeFile(e){super.writeFile(e),e.write(1),this.entityCol.writeFile(e)}readFile(e){super.readFile(e),e.read(),this.entityCol.readFile(e)}destory(){super.destory(),this.entityCol.destory()}}class Pn extends xn{constructor(e){super(),this.id=e,this.writeUndo()}writeUndo(){this.undoData=new B(this.id.Object)}writeRedo(){this.redoData=new B(this.id.Object)}writeFile(e){e.write(1),e.writeObjectId(this.id)}readFile(e){e.read(),this.id=e.readObjectId()}}let Rn=class extends L{constructor(e=""){super(),this.commandName=e,this._HistoryList=new Map,this._CreateObjects=new Map}get HistoryList(){return this._HistoryList}getObjectAllDataRecord(e){let t=[];for(const i of e)i instanceof Pn&&t.push(i);return t}writeObjectSnapshoot(e){var t;if(e.ObjectId&&!this._CreateObjects.has(e)){let i=this.getObjectHistoryList(e.ObjectId);null!=(t=this.getObjectAllDataRecord(i))&&t.length||(t=new Pn(e.ObjectId),i.push(t))}}getObjectHistoryList(e){return this._HistoryList.has(e)||this._HistoryList.set(e,[]),this._HistoryList.get(e)}createEraseHistory(e,t){let i=new xn;i.undoData=new R(!t),i.redoData=new R(t),this.writeObjectHistoryPath(e,i)}writeObjectHistoryPath(e,t){if(!this._CreateObjects.has(e)){let i=this.getObjectHistoryList(e.ObjectId);null!=(e=this.getObjectAllDataRecord(i))&&e.length||(t.redoData instanceof wn&&this._CreateObjects.set(t.redoData.Object,t),i.push(t))}}destory(){}writeFile(e){e.write(1),e.write(this.commandName)}readFile(e){e.read(),this.commandName=e.read()}};Rn=y([E],Rn);class An extends L{constructor(){super(...arguments),this.historyRecordList=[],this.doing=!1,this.cursor=-1,this.isEnable=!0}startCmd(e){this.historyRecordList.splice(this.cursor+1,this.historyRecordList.length-(this.cursor+1)),this.historyRecordList.push(new Rn(e)),this.cursor=this.historyRecordList.length-1}endCmd(){var e=this.historyRecordList[this.cursor];if(e){for(var[,t]of e.HistoryList)for(const e of t)e instanceof Pn&&e.writeRedo();return this.endCmdEvent(!0),!0}return this.endCmdEvent(!1),!1}get HasUndo(){return!!this.historyRecordList[this.cursor]}get HasRedo(){return!!this.historyRecordList[this.cursor+1]}endCmdEvent(e){}undo(){var e,t,i=this.historyRecordList[this.cursor];if(!i)return!1;for([e,t]of(this.doing=!0,i.HistoryList))for(let i=t.length;i--;)e.Object._applyHistoryRecord(t[i].undoData);return this.cursor--,this.doing=!1,this.undoEvent(i),!0}undoEvent(e){}redo(){var e,t,i=this.historyRecordList[this.cursor+1];if(!i)return!1;for([e,t]of(this.doing=!0,i.HistoryList))for(let i=t.length;i--;)e.Object._applyHistoryRecord(t[i].redoData);return this.cursor++,this.doing=!1,this.redoEvent(i),!0}redoEvent(e){}clear(){this.historyRecordList.length=0,this.cursor=-1}destory(){super.destory();for(const e of this.historyRecordList)e.destory();this.historyRecordList.length=0,this.cursor=-1}get LastCmdRecord(){if(!this.doing&&this.isEnable)return A(this.historyRecordList)}writeFile(e){e.write(1),e.write(this.historyRecordList.length);for(const t of this.historyRecordList)t.writeFile(e)}readFile(e){e.read();var t=e.read();for(let i=this.historyRecordList.length=0;i<t;i++){const t=new Rn;t.readFile(e),this.historyRecordList.push(t)}}}class Mn extends L{constructor(){super(...arguments),this.recordMap=new Map}append(e){e._SetOwnerDatabase(this.DB),this.recordMap.set(e.Name,e)}remove(e){return this.recordMap.delete(e)}}class On extends L{constructor(){super(),this.objects=[],this.cleaners=[],this.doing=!1,this._pause=!1,this.queues=[],this.resolveFun=[],this.callback=(e,t)=>v(this,void 0,void 0,(function*(){if(this.doing)e.isChild&&(e.isEnd?this.queues.length=0:this.queues.push((()=>this.callback(e,t))));else{this.doing=!0;for(const e of this.objects)e.Target||t(e)&&(yield e.do());if(this.doing=!1,0<this.queues.length&&!this.Pause){this.queues.pop()()}}})),this.pointerCallback=e=>{if(this.lastClickTimeStap){var t=e.event.timeStamp-this.lastClickTimeStap;if(this.lastClickTimeStap=null,t<200&&this.preventDbTimeId)return void clearTimeout(this.preventDbTimeId)}else this.lastClickTimeStap=e.event.timeStamp;this.preventDbTimeId=setTimeout((()=>{const t=2===e.event.button;this.lastClickTimeStap=null,this.callback(e,(i=>"RightClick"===i.TriggerType&&t||"Click"===i.TriggerType&&0===e.event.button||void 0))}),200)},this.pointerDbClick=e=>v(this,void 0,void 0,(function*(){yield this.callback(e,(e=>"DoubleClick"===e.TriggerType))})),this.onKeydown=e=>v(this,void 0,void 0,(function*(){yield this.callback(e,(e=>"KeyDown"===e.TriggerType))})),this.onKeyup=e=>v(this,void 0,void 0,(function*(){yield this.callback(e,(e=>"KeyUp"===e.TriggerType))})),this.onLoad=e=>v(this,void 0,void 0,(function*(){yield z(100),yield this.callback(e,(e=>"Load"===e.TriggerType))})),this.onUpdate=e=>v(this,void 0,void 0,(function*(){yield this.callback(e,(e=>"Update"===e.TriggerType))}))}get Pause(){return this._pause}start(){if(this._pause=!1,0<this.resolveFun.length&&(this.resolveFun.forEach((e=>e(!0))),this.resolveFun.length=0),ge.MainScene.animatables.forEach((e=>e.restart())),0<this.queues.length){this.queues.pop()()}}stop(){this._pause=!0,ge.MainScene.animatables.forEach((e=>e.pause()))}wait(){return new Promise((e=>this.resolveFun.push(e)))}append(e){e._SetOwnerDatabase(this._db),this.objects.push(e)}removeAll(){this.objects.forEach((e=>e.destory())),this.objects.length=0}remove(e){let t;for(const i of t=Array.isArray(e)?e:[e])i.destory();O(this.objects,(e=>t.includes(e)))}destory(){super.destory(),this.objects.forEach((e=>e.destory())),this.objects.length=0,this.doing=!1}watch(){this.cleaners.push(he.on("pointerTap",this.pointerCallback),he.on("pointerDoubleTap",this.pointerDbClick),he.on("keydown",this.onKeydown),he.on("keyup",this.onKeyup),he.on("loadComplete",this.onLoad),he.on("update",this.onUpdate)),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this.start(),"hidden"===document.visibilityState&&this.stop()}))}writeFile(e){super.writeFile(e),e.write(1),e.writeAnyArray(this.objects,e.writeObject)}readFile(e){super.readFile(e),e.read(),e.readAnyArrayAndPush(this.objects,e.readObject)}}let In=class extends L{constructor(){super(...arguments),this.list=[]}append(e){this.list.push(e)}do(){for(const e of this.list)e.do()}remove(e){M(this.list,e)}destory(){super.destory();for(const e of this.list)e.destory()}writeFile(e){e.write(1),e.writeAnyArray(this.list,e.writeObject)}readFile(e){e.read(),e.readAnyArrayAndPush(this.list,e.readObject)}},Fn=(In=y([E],In),class extends Cn{append(e){var t=super.append(e);return t&&(e.Owner=this.ObjectId),t}readFile(e){e.read(),super.readFile(e)}writeFile(e){e.write(1),super.writeFile(e)}});Fn.type="GroupRecordTable",Fn=y([E],Fn);class Dn{constructor(e=!1){this.preview=e,this.idIndex=1,this.idMap=new Map,this.ModelSpace=(new Sn)._SetOwnerDatabase(this),this.LightSpace=(new Sn)._SetOwnerDatabase(this).setCheckout((e=>e.isLight)),this.TextureTable=(new Mn)._SetOwnerDatabase(this),this.MaterialTable=(new Mn)._SetOwnerDatabase(this),this.HistoryManager=(new An)._SetOwnerDatabase(this),this.InteractionTable=(new On)._SetOwnerDatabase(this),e&&this.InteractionTable.watch(),this.DataBindTable=(new In)._SetOwnerDatabase(this),this.GuiSpace=(new Sn)._SetOwnerDatabase(this),this.DomSpace=(new Sn)._SetOwnerDatabase(this),this.ParticleSystemSpace=(new Sn)._SetOwnerDatabase(this),this.GroupTable=(new Fn)._SetOwnerDatabase(this),this.idIndex=100}get AllObjects(){const e=[];for(var[t,i]of this.idMap)t<100||e.push(i.Object);return e}allocateId(){return this.getObjectId(this.idIndex++)}getObjectId(e){if(0!==e){let t=this.idMap.get(e);return t||(t=new F(e),this.idMap.set(e,t),t)}}findObjectById(e){return null==(e=this.idMap.get(e))?void 0:e.Object}findObjectByName(e,t=!0,i){var r,n;const s=[];for([,n]of(i=i||(e=>!1),this.idMap))n.isErase||null!=(r=n.Object)&&r.Name&&!i(n.Object)&&(t?n.Object.Name.includes(e)&&s.push(n.Object):n.Object.Name===e&&s.push(n.Object));return s}writeFile(e){return(e=e||new D).write(2),e.write(this.idIndex),this.ModelSpace.writeFile(e),this.LightSpace.writeFile(e),this.TextureTable.writeFile(e),this.MaterialTable.writeFile(e),this.InteractionTable.writeFile(e),this.DataBindTable.writeFile(e),this.GuiSpace.writeFile(e),this.DomSpace.writeFile(e),this.ParticleSystemSpace.writeFile(e),this.GroupTable.writeFile(e),e}readFile(e){this.destory(),this.reset(),e.database=this;var t=e.read();return this.idIndex=e.read(),this.ModelSpace.readFile(e),this.LightSpace.readFile(e),this.TextureTable.readFile(e),this.MaterialTable.readFile(e),this.InteractionTable.readFile(e),this.DataBindTable.readFile(e),this.GuiSpace.readFile(e),this.DomSpace.readFile(e),this.ParticleSystemSpace.readFile(e),1<t&&this.GroupTable.readFile(e),this.preview&&this.DataBindTable.do(),this}destory(){this.idMap.clear(),this.ModelSpace.destory(),this.LightSpace.destory(),this.TextureTable.destory(),this.MaterialTable.destory(),this.HistoryManager.destory(),this.InteractionTable.destory(),this.DataBindTable.destory(),this.GuiSpace.destory(),this.DomSpace.destory(),this.ParticleSystemSpace.destory(),this.GroupTable.destory(),this.idIndex=1}reset(){this.ModelSpace._SetOwnerDatabase(this),this.LightSpace._SetOwnerDatabase(this),this.TextureTable._SetOwnerDatabase(this),this.MaterialTable._SetOwnerDatabase(this),this.InteractionTable._SetOwnerDatabase(this),this.DataBindTable._SetOwnerDatabase(this),this.GuiSpace._SetOwnerDatabase(this),this.DomSpace._SetOwnerDatabase(this),this.ParticleSystemSpace._SetOwnerDatabase(this),this.GroupTable._SetOwnerDatabase(this),this.idIndex=100}}class Ln extends _e{constructor(){super(...arguments),this.isLight=!0,this._color="#ffffff",this.Intensity=1,this.showHelper=!0}get HasShadowGenerator(){return!!this._shadowGenerator}get Color(){return this._color}set Color(e){e!==this._color&&(this.writeSnapshoot(),this._color=e,this.update())}addShadowCaster(e){if(this._shadowGenerator)for(const t of e)if(t.EnableShadow)for(const e of t.DrawObject.getChildMeshes())this._shadowGenerator.addShadowCaster(e)}removeShadowCaster(e){if(this._shadowGenerator)if(e)for(const t of e)for(const e of t.DrawObject.getChildMeshes())this._shadowGenerator.removeShadowCaster(e);else for(const e of this._shadowGenerator.getShadowMap().renderList.slice())this._shadowGenerator.removeShadowCaster(e)}updateMaterial(){}writeFile(e){super.writeFile(e),e.write(1),e.write(this.Intensity)}readFile(e){super.readFile(e),e.read(),this.Intensity=e.read()}initShadowGenerator(e){this._shadowGenerator=new n.ShadowGenerator(1024,e),this._shadowGenerator.useExponentialShadowMap=!1,this._shadowGenerator.usePercentageCloserFiltering=!0,this._shadowGenerator.filteringQuality=n.ShadowGenerator.QUALITY_MEDIUM}}y([Lr],Ln.prototype,"Intensity",void 0);let Bn=class extends Ln{constructor(){super(...arguments),this._dir=[1,1,1],this._name="\u5168\u5c40\u5149"}initDrawObject(e){var t=new n.Mesh(this.UniqueName,_e.Scene);const i=new n.HemisphericLight(this.UniqueName+"-1",n.Vector3.FromArray(this._dir),_e.Scene);return i.parent=t,i.diffuse=n.Color3.FromHexString(this.Color),t}updateDrawObject(e,t){if(t&&0!==t.getChildren().length){const e=t.getChildren()[0];e.intensity=this.Intensity,e.direction.fromArray(this._dir),e.diffuse=n.Color3.FromHexString(this.Color)}}readFile(e){super.readFile(e),this.update()}};Bn.type="HemisphericLight",Bn=y([E],Bn);class Nn{constructor(){this.loadedActions=[],this.conditions=[],this.doing=!1,this.register()}append(e){this.conditions.push(e)}register(){he.once("loaded",(e=>{for(const e of this.loadedActions)e.do()})),he.on("update",(e=>{if(!this.doing){this.doing=!0;const e=[];for(const t of this.conditions)t.check()&&e.push(t.do());Promise.all(e).finally((()=>{this.doing=!1}))}}))}}class kn extends Ur{}let Un=class extends kn{constructor(){super(),this._albedoColor="#ffffff",this._reflectivityColor="#000000",this._emissiveColor="#000000",this._metallic=0,this._roughness=0,this._opaticy=1,this._gloss=1,this.material=new n.PBRMaterial("pbr",ge.MainScene),this.updateMaterial()}get Material(){return this.material}set Map(e){this._albedoTexture=e.ObjectId,this.update()}set BumpMap(e){this._bumpTexture=e.ObjectId,this.update()}get Color(){return this._albedoColor}set Color(e){e!==this._albedoColor&&(this.writeSnapshoot(),this._albedoColor=e,this.updateMaterial())}get ReflectivityColor(){return this._reflectivityColor}set ReflectivityColor(e){e!==this._reflectivityColor&&(this.writeSnapshoot(),this._reflectivityColor=e,this.updateMaterial())}get EmissiveColor(){return this._emissiveColor}set EmissiveColor(e){e!==this._emissiveColor&&(this.writeSnapshoot(),this._emissiveColor=e,this.updateMaterial())}get Metallic(){return this._metallic}set Metallic(e){e!==this._metallic&&(this.writeSnapshoot(),this._metallic=e,this.updateMaterial())}get Roughness(){return this._roughness}set Roughness(e){e!==this._roughness&&(this.writeSnapshoot(),this._roughness=e,this.updateMaterial())}get Opaticy(){return this._opaticy}set Opaticy(e){e!==this._opaticy&&(this.writeSnapshoot(),this._opaticy=e,this.updateMaterial())}get Gloss(){return this._gloss}set Gloss(e){e!==this._gloss&&(this.writeSnapshoot(),this._gloss=e,this.updateMaterial())}updateMaterial(){this.material.albedoColor=K(this._albedoColor),this.material.reflectivityColor=K(this._reflectivityColor),this.material.emissiveColor=K(this._emissiveColor),this.material.alpha=this._opaticy,this.material.metallic=this._metallic,this.material.roughness=this._roughness,this.material.microSurface=this._gloss}update(){var e;null!=(e=this._albedoTexture)&&e.Object&&(e=this._albedoTexture.Object,this.material.albedoTexture=e.Texture),null!=(e=this._bumpTexture)&&e.Object&&(e=this._bumpTexture.Object,this.material.bumpTexture=e.Texture),this.updateMaterial()}writeFile(e){super.writeFile(e),e.write(1),e.write(this._albedoColor),e.write(this._reflectivityColor),e.write(this._emissiveColor),e.write(this._opaticy),e.write(this._metallic),e.write(this._roughness),e.write(this._gloss),e.writeObjectId(this._albedoTexture)}readFile(e){super.readFile(e),e.read(),this._albedoColor=e.read(),this._reflectivityColor=e.read(),this._emissiveColor=e.read(),this._opaticy=e.read(),this._metallic=e.read(),this._roughness=e.read(),this._gloss=e.read(),this._albedoTexture=e.readObjectId(),this.update()}_SetOwnerDatabase(e){return super._SetOwnerDatabase(e),this.material.name="pbr-"+this.Id,this.material.id="pbr-"+this.Id,this}},zn=(Un.type="PBRMaterialRecord",Un=y([E],Un),class extends zr{constructor(e=""){super(),this.url=e,this.onLoad=e=>{this._isLoading=!1,this.trigger({type:"load",target:this,object:e})},this.texture=new n.Texture(e,null),this.texture.onLoadObservable.add(this.onLoad)}get Texture(){return this.texture}get Url(){return this.url}set Url(e){this.url=e,this.update()}update(){this.texture.url!==this.url&&(this._isLoading=!0,this.texture.updateURL(this.url)),this.texture.name=this._name,this.texture.wrapU=this.wrapU,this.texture.wrapV=this.wrapV,this.texture.uScale=this.scale[0],this.texture.vScale=this.scale[1],this.texture.uOffset=this.offset[0],this.texture.vOffset=this.offset[1],this.texture.uAng=W(this.rotation[0]),this.texture.vAng=W(this.rotation[1]),this.texture.wAng=W(this.rotation[2])}waitUpdate(){return v(this,void 0,void 0,(function*(){return new Promise((e=>{if(!this._isLoading)return e(!0),!0;let t=setInterval((()=>{this._isLoading||(clearInterval(t),e(!0))}),1e3)}))}))}writeFile(e){super.writeFile(e),e.write(1),e.write(this.url)}readFile(e){super.readFile(e),e.read(),this.url=e.read(),this.update()}});zn=y([E],zn),n.StandardMaterial.AmbientTextureEnabled=!1,function(e){const t=new Map,i=new Map;function r(e){return n.Color3.FromArray(H[e].map((e=>e/255)))}e.getColor3=r,e.getColor4=function(e){return n.Color4.FromArray(H[e].map((e=>e/255)))},e.getColorArray=function(e){return H[e].map((e=>e/255))},e.getStandMaterial=function(e,i){if(t.has(e))return t.get(e);let s=new n.StandardMaterial("__common_color"+e,i);return s.backFaceCulling=!1,s.diffuseColor=r(e),t.set(e,s),s},e.getWireframeStandMaterial=function(e,t){if(i.has(e))return i.get(e);let s=new n.StandardMaterial("__common__wf_color"+e,t);return s.diffuseColor=r(e),s.alpha=0,i.set(e,s),s},e.clear=function(){t.clear(),i.clear()}}(Tr=Tr||{}),n.SceneLoader.ShowLoadingScreen=!1;class Gn{constructor(e){return this.EventSystem=new Nn,this.GisViwer=new h,this._IsShadow=!1,this.cleaners=[],Gn.Intance||(this.Viewer=new vn(e.canvas,!e.editor),this.Editor=new tn(this.Viewer,e.editor),e.domContainer?this._domContainer=e.domContainer:this._domContainer=e.canvas.parentElement,ge.PreviewMode=!e.editor,this.Database=new Dn(!e.editor),ge.MainViewer=this.Viewer,this._register(),this.initLight(),e.skybox&&(this.Viewer.sceneControl.Mode=e.skybox),e.cameraRadius&&(this.Viewer.cameraManager.Radius=e.cameraRadius),fe.debugger=e.debug,Gn.Intance=this),Gn.Intance}get IsShadow(){return this._IsShadow}set IsShadow(e){this._IsShadow!==e&&((this._IsShadow=e)?this.openShadow():this.closeShadow())}create(e){const t=C.CreateObject(e.type,e);if(t)return e.name&&(t.Name=e.name),e.position&&(t.Position=e.position,t instanceof ye&&(t.isRead=!0)),void 0!==e.colorIndex&&(t.ColorIndex=e.colorIndex),t instanceof we?this.Database.GuiSpace.append(t):t instanceof ve?this.Database.DomSpace.append(t):t instanceof _e&&(t.isLight?this.Database.LightSpace:this.Database.ModelSpace).append(t),e.loading&&t.on("loading",e.loading),e.complete&&(t.isAsync?t.once("load",e.complete):e.complete({type:"load",target:t})),t}createGui(e,t){if(e=C.CreateObject(e,t))return this.Database.GuiSpace.append(e),e}createParticle(e,t){if(e=C.CreateObject(e,t))return this.Database.ParticleSystemSpace.append(e),e}createPBR(){var e=new Un;return this.Database.MaterialTable.append(e),e}createTexture(e,t){const i=new zn(e);return t&&i.once("load",t),this.Database.TextureTable.append(i),i}get SelectObjects(){return[...this.SelectEntitys,...this.SelectGuis,...this.SelectDoms,...this.SelectParticles]}get SelectEntitys(){var e;return null==(e=this.Editor)?void 0:e.selectControl.selectSet.SelectEntitys}get SelectParticles(){var e=null==(e=null==(e=this.Editor)?void 0:e.selectControl)?void 0:e.SelectParticle;return e?[e]:[]}get SelectGuis(){var e=null==(e=null==(e=this.Editor)?void 0:e.selectControl)?void 0:e.SelectGui;return e?[e]:[]}get SelectDoms(){var e=null==(e=null==(e=this.Editor)?void 0:e.selectControl)?void 0:e.SelectDOM;return e?[e]:[]}zoomAll(){this.Viewer.cameraManager.zoomAll()}changeRenderType(e){void 0!==e&&this.Database.ModelSpace.Entitys.forEach((t=>t.updateRenderType(e)))}new(e=!0){var t;null!=(t=this.Editor)&&t.transformControl&&this.Editor.transformControl.detachMeshs(),this.Viewer.reset(),this.Database.readFile((new Dn).writeFile()),this.initLight(),e&&he.trigger({type:"newFile",target:null})}saveFile(){var e=this.Database.writeFile();return this.Viewer.writeFile(e),e.Data}loadFile(e){var t;ge.StartWait(),this.Viewer.stopRender(),null!=(t=this.Editor)&&t.transformControl&&this.Editor.transformControl.detachMeshs(),me.clear(),he.trigger({type:"startLoad",target:null}),0<fe.loadPlugins.size&&(fe.loadPlugins.forEach((e=>{var t;return null==(t=null==e?void 0:e.dispose)?void 0:t.call(e)})),fe.loadPlugins.clear()),e?(ge.Reading=!0,t=new D(e),this.Database.readFile(t),this.Viewer.readFile(t),this.Viewer.hemisphericLight=this.Database.LightSpace.Entitys.find((e=>e instanceof Bn)),ge.Reading=!1):this.new(!1),this.Viewer.render(),he.trigger({type:"loadFile",target:null}),ge.WaitComplete().then((e=>{he.trigger({type:"loadComplete",target:null})}))}destory(){this.Database.destory(),this.Viewer.destory(),Gn.Intance=null,Tr.clear(),this.cleaners.forEach((e=>e())),this.cleaners.length=0}createView(e,t){return new vn(e,!0,t)}openShadow(){var e=this.Database.LightSpace.Entitys,t=this.Database.ModelSpace.Entitys;for(const i of e)i.HasShadowGenerator&&i.addShadowCaster(t)}closeShadow(){for(const e of this.Database.LightSpace.Entitys)e.HasShadowGenerator&&e.removeShadowCaster()}on(e,t){return he.on(e,t)}off(e,t){he.off(e,t)}openGis(e){if(this.GisViwer.viewer)this.GisViwer.openViewer();else{if(!e){const t=document.createElement("link");t.type="text/css",t.rel="stylesheet",t.href="/static/cesium/Widgets/widgets.css",document.head.append(t),e=document.createElement("div"),this.Viewer.canvas.parentElement.append(e),e.style.cssText="width: 100%;\n        height: 100%;\n        ",this.Viewer.canvas.style.position="absolute",this.Viewer.canvas.style.left="0",this.Viewer.canvas.style.top="0",this.Viewer.canvas.style.zIndex="1"}this.GisViwer.init(e),this.Viewer.sceneControl.Background=[0,0,0,0],this.Viewer.canvas.style.pointerEvents="none"}return this.GisViwer}closeGis(){this.GisViwer.close()}controlCanvas(e){1===e?(this.GisViwer.container.style.pointerEvents="none",this.Viewer.canvas.style.pointerEvents="auto"):2===e&&(this.GisViwer.container.style.pointerEvents="auto",this.Viewer.canvas.style.pointerEvents="none")}initLight(){var e=new Bn;this.Viewer.hemisphericLight=e,this.Database.LightSpace.append(e)}_register(){const e=()=>{this.Viewer.setSize(),this.Database.DomSpace.Entitys.forEach((e=>e.update())),this.Database.GuiSpace.Entitys.forEach((e=>e.update()))};window.addEventListener("resize",e),this.cleaners.push(Ir(this.Database.ModelSpace,this.Database.ModelSpace.appendEvent,(e=>{this.Viewer.Scene.addTransformNode(e.DrawObject)})),Ir(this.Database.LightSpace,this.Database.LightSpace.appendEvent,(e=>{this.Viewer.Scene.addTransformNode(e.DrawObject),this._IsShadow&&e.EnableShadow&&e.addShadowCaster(this.Database.ModelSpace.Entitys)})),Ir(this.Database.GuiSpace,this.Database.GuiSpace.appendEvent,(e=>{this.Viewer.GuiContainer.addControl(e.DrawObject)})),Ir(this.Database.DomSpace,this.Database.DomSpace.appendEvent,(e=>{this._domContainer.appendChild(e.DrawObject)})),Ir(this.Database.ParticleSystemSpace,this.Database.ParticleSystemSpace.appendEvent,(e=>{var t=_e.Scene;_e.Scene=ge.MainScene,e.IsErase||e.Intance&&e.stop(),_e.Scene=t})),this.on("update-shadow",(e=>{var t=e.target;for(const e of this.Database.LightSpace.Entitys)e.HasShadowGenerator&&(t.EnableShadow?e.addShadowCaster([t]):e.removeShadowCaster([t]))})),this.on("remove",(()=>{this.Editor.selectControl.clearSelect(!0)})),(()=>{window.removeEventListener("resize",e)}),Ir(this.Viewer,this.Viewer.renderEvent,(()=>{this.GisViwer.render()})))}}const Vn=new class{constructor(){}displayLoadingUI(){this.displayLoadingUIEvnet()}displayLoadingUIEvnet(){}hideLoadingUI(){this.hideLoadingUIEvent()}hideLoadingUIEvent(){}};class jn{constructor(e,t=!1){this.defaultEnv=t,this.onFileLoadedObserver=new n.Observable,this.onFileProgressObserver=new n.Observable,this.onFileErrorObserver=new n.Observable,this.isRendered=!1,this.engine=new n.Engine(e,!1,{premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1}),this.engine.loadingScreen=Vn,this.scene=new n.Scene(this.engine),this.scene.clearColor=new n.Color4(1,1,1,1),this.scene.createDefaultCameraOrLight(),t&&this.createDefaultEnv(),this.scene.executeWhenReady((()=>{this.engine.hideLoadingUI(),this.engine.runRenderLoop((()=>{this.scene.activeCamera&&this.scene.render()}))})),n.FilesInputStore.FilesToLoad=new Proxy(n.FilesInputStore.FilesToLoad,{get:(e,t)=>e[t],set:(e,t,i)=>(e[t]=i,!0)}),e=new n.FilesInput(this.engine,null,((e,t)=>{this.scene=t;var i=e.name.endsWith(".glb")||e.name.endsWith(".gltf");this.prepareCamera(i),t.materials.forEach((e=>{e.diffuseColor=n.Color3.White(),e.backFaceCulling=!1,e.emissiveColor=n.Color3.Black()})),this.onFileLoadedObserver.notifyObservers(e)}),(e=>{this.onFileProgressObserver.notifyObservers(e)}),(()=>{this.isRendered=!0}),(e=>{}),(e=>{}),null,((e,t,i)=>{this.onFileErrorObserver.notifyObservers({file:e,scene:t,message:i})})),this.filesInput=e}prepareCamera(e=!1){this.scene.activeCamera||this.scene.createDefaultCameraOrLight(!0,!0);const t=this.scene.activeCamera,i=(e&&(t.alpha+=Math.PI),this.defaultEnv&&this.createDefaultEnv(),t.useFramingBehavior=!0,t.getBehaviorByName("Framing"));i.framingTime=0,i.elevationReturnTime=-1,this.scene.meshes.length&&(t.lowerRadiusLimit=null,e=this.scene.getWorldExtends((function(e){return e.isVisible&&e.isEnabled()})),i.zoomOnBoundingInfo(e.min,e.max)),t.pinchPrecision=200/t.radius,t.upperRadiusLimit=5*t.radius,t.wheelDeltaPercentage=.01,t.pinchDeltaPercentage=.01,t.attachControl(),t.alpha-=Math.PI/4}loadLocalFile(e){this.isRendered=!1,this.filesInput.loadFiles(e)}loadFile(e){return v(this,void 0,void 0,(function*(){this.scene.rootNodes.forEach((e=>e.dispose())),this.isRendered=!1;const t=yield n.SceneLoader.AppendAsync(e,"",this.scene);this.scene=t,this.prepareCamera(e.endsWith("gltf")||e.endsWith("glb")),t.materials.forEach((e=>{e.diffuseColor=n.Color3.White(),e.backFaceCulling=!1,e.emissiveColor=n.Color3.Black()})),this.isRendered=!0}))}getPreviewUrl(e=400){return v(this,void 0,void 0,(function*(){return yield this.waitRendered(),n.Tools.CreateScreenshotAsync(this.engine,this.scene.activeCamera,e)}))}getBlob(){return v(this,void 0,void 0,(function*(){return this.scene.clearColor=new n.Color4(1,1,1,1),yield this.waitRendered(),G(yield this.getPreviewUrl())}))}waitRendered(){return v(this,void 0,void 0,(function*(){return new Promise((e=>{let t=setInterval((()=>{this.isRendered&&(clearInterval(t),e(null))}),100)}))}))}onLoaded(e){const t=this.onFileLoadedObserver.add(e);return()=>{this.onFileLoadedObserver.remove(t)}}onError(e){const t=this.onFileErrorObserver.add(e);return()=>{this.onFileErrorObserver.remove(t)}}onProgress(e){const t=this.onFileProgressObserver.add(e);return()=>{this.onFileProgressObserver.remove(t)}}destory(){this.filesInput.dispose(),this.onFileLoadedObserver.clear(),this.engine.dispose()}createDefaultEnv(){this.scene.environmentTexture=dn.LoadSkyboxPathTexture(this.scene),this.scene.activeCamera&&this.scene.createDefaultSkybox(this.scene.environmentTexture,!0,1e4,.3,!1)}}class Wn extends _e{constructor(){super()}get VertextData(){return null}initDrawObject(e=u.Conceptual){const t=new n.Mesh(this.UniqueName,_e.Scene);return this.VertextData.applyToMesh(t),e===u.Wireframe&&(t.enableEdgesRendering(),t.edgesColor=n.Color4.FromArray(H[this.ColorIndex])),this.updateMaterial(e,t),t.receiveShadows=!0,t}updateDrawObject(e,t){t&&t.geometry.setAllVerticesData(this.VertextData)}updateMaterial(e,t){const i=null!=t?t:this.RenderObject;switch(null!=e?e:this.RenderType){case u.Wireframe:i.material=Tr.getWireframeStandMaterial(this._colorIndex,_e.Scene);break;case u.Conceptual:var r=Tr.getStandMaterial(this.ColorIndex,_e.Scene);i.material=r;break;case u.Physical:this.Material&&(i.material=this.Material.Material)}this.defaultMaterial||(this.defaultMaterial=i.material),this._standardMaterial&&(i.material=this._standardMaterial),i.material&&(i.material.alpha=this._opacity)}}Wn.VertexDataCache=new Map;let Hn=Cr=class extends Wn{constructor(e={width:10,height:10,depth:10,center:Q.Center}){var t;super(),this.width=10,this.height=10,this.depth=10,this._center=Q.Center,this.width=null!=(t=e.width)?t:this.width,this.height=null!=(t=e.height)?t:this.height,this.depth=null!=(t=e.depth)?t:this.depth,this._center=null!=(t=e.center)?t:Q.Center}get Width(){return this.width}set Width(e){e!==this.width&&(this.writeSnapshoot(),this.width=e,this.update())}get Height(){return this.height}set Height(e){e!==this.height&&(this.writeSnapshoot(),this.height=e,this.update())}get Depth(){return this.depth}set Depth(e){e!==this.depth&&(this.writeSnapshoot(),this.depth=e,this.update())}get CenterPosition(){return this._center}set CenterPosition(e){e!==this.depth&&(this.writeSnapshoot(),this._center=e,this.update())}get TranslateMtx(){let[e,t,i]=[0,0,0];switch(this._center){case Q.Center:break;case Q.Bottom:i=this.depth/2;break;case Q.Top:i=-this.depth/2;break;case Q.Left:e=this.width/2;break;case Q.Right:e=-this.width/2;break;case Q.Front:t=-this.Height/2;break;case Q.Back:t=this.Height/2;break;case Q.LFB:[e,t,i]=[this.width/2,this.height/2,this.depth/2];break;case Q.RFB:[e,t,i]=[-this.width/2,this.height/2,this.depth/2];break;case Q.LBB:[e,t,i]=[this.width/2,-this.height/2,this.depth/2];break;case Q.RBB:[e,t,i]=[-this.width/2,-this.height/2,this.depth/2]}return n.Matrix.Translation(e,t,i)}get VertextData(){var e=`${this.width}-${this.height}-${this.depth}-`+this._center;let t=Cr.VertexDataCache.get(e);return t||((t=(0,n.CreateBoxVertexData)({width:this.width,height:this.height,depth:this.depth})).transform(this.TranslateMtx),Cr.VertexDataCache.set(e,t)),t}writeFile(e){super.writeFile(e),e.write(1),e.write(this.width),e.write(this.height),e.write(this.depth),e.write(this._center)}readFile(e){super.readFile(e),e.read(),this.width=e.read(),this.height=e.read(),this.depth=e.read(),this._center=e.read(),this.update()}};Hn.type="Box",Hn=Cr=y([E],Hn);class Kn extends _e{updateMaterial(){this.RenderObject.color=Tr.getColor3(this.ColorIndex)}}let Xn=class extends Kn{constructor(e={points:[[0,0,0],[.1,0,0]]}){super(),this.points=[],this.points=null!=(e=e.points)?e:[[0,0,0],[.1,0,0]]}get Points(){return this.points.map((e=>({x:e[0],y:e[1],z:e[2]})))}initDrawObject(e){return n.MeshBuilder.CreateLines("line"+this.Id,{points:this.points.map((e=>n.Vector3.FromArray(e)))},_e.Scene)}writeFile(e){super.writeFile(e),e.write(1),e.write(this.points.length);for(const t of this.points)e.writeArray(t)}readFile(e){super.readFile(e),e.read();var t=e.read();for(let i=this.points.length=0;i<t;i++)this.points.push(e.readArray(e.read()));this.update()}},qn=(Xn.type="Lines",Xn=y([E],Xn),class extends Wn{constructor(e={diameter:1,arc:1}){var t;super(),this.diameter=10,this.arc=10,this.diameter=null!=(t=e.diameter)?t:this.diameter,this.arc=null!=(t=e.arc)?t:this.arc}get Diameter(){return this.diameter}set Diameter(e){e!==this.diameter&&(this.writeSnapshoot(),this.diameter=e,this.update())}get VertextData(){return(0,n.CreateSphereVertexData)({diameter:this.diameter,arc:this.arc})}writeFile(e){super.writeFile(e),e.write(1),e.write(this.diameter),e.write(this.arc)}readFile(e){super.readFile(e),e.read(),this.diameter=e.read(),this.arc=e.read(),this.update()}}),Yn=(qn.type="Sphere",qn=y([E],qn),class extends Wn{constructor(e={diameterTop:10,diameterBottom:10,height:10,arc:10}){var t;super(),this.diameterTop=10,this.diameterBottom=10,this.height=10,this.tessellation=void 0,this.arc=10,this.diameterTop=null!=(t=e.diameterTop)?t:10,this.diameterBottom=null!=(t=e.diameterBottom)?t:10,this.height=null!=(t=e.height)?t:10,this.arc=null!=(t=e.arc)?t:10}get DiameterTop(){return this.diameterTop}set DiameterTop(e){e!==this.diameterTop&&(this.writeSnapshoot(),this.diameterTop=e,this.update())}get DiameterBottom(){return this.diameterBottom}set DiameterBottom(e){e!==this.diameterBottom&&(this.writeSnapshoot(),this.diameterBottom=e,this.update())}get Height(){return this.height}set Height(e){e!==this.height&&(this.writeSnapshoot(),this.height=e,this.update())}get Tessellation(){return this.tessellation}set Tessellation(e){e!==this.tessellation&&(this.writeSnapshoot(),this.tessellation=e,this.update())}get VertextData(){return(0,n.CreateCylinderVertexData)({diameterTop:this.diameterTop,diameterBottom:this.diameterBottom,height:this.height,arc:this.arc,tessellation:this.tessellation})}writeFile(e){super.writeFile(e),e.write(1),e.write(this.diameterTop),e.write(this.diameterBottom),e.write(this.height),e.write(this.tessellation),e.write(this.arc)}readFile(e){super.readFile(e),e.read(),this.diameterTop=e.read(),this.diameterBottom=e.read(),this.height=e.read(),this.tessellation=e.read(),this.arc=e.read(),this.update()}}),Zn=(Yn.type="Cylinder",Yn=y([E],Yn),class extends Wn{constructor(e){var t;super(),this.width=10,this.height=10,this.width=null!=(t=null==e?void 0:e.width)?t:this.width,this.height=null!=(t=null==e?void 0:e.height)?t:this.height}get Width(){return this.width}set Width(e){e!==this.width&&(this.writeSnapshoot(),this.width=e,this.update())}get Height(){return this.height}set Height(e){e!==this.height&&(this.writeSnapshoot(),this.height=e,this.update())}get VertextData(){return(0,n.CreatePlaneVertexData)({width:this.width,height:this.height})}writeFile(e){super.writeFile(e),e.write(1),e.write(this.width),e.write(this.height)}readFile(e){super.readFile(e),e.read(),this.width=e.read(),this.height=e.read(),this.update()}}),Qn=(Zn.type="Plane",Zn=y([E],Zn),class extends Wn{constructor(e={radius:1,radiusTop:void 0,radiusBottom:void 0,height:1,subdivisions:2,tessellation:2,capSubdivisions:6}){var t;super(),this.subdivisions=20,this.tessellation=16,this.capSubdivisions=6,this.height=null!=(t=e.height)?t:20,this.radius=null!=(t=e.radius)?t:5,this.subdivisions=null!=(t=e.subdivisions)?t:2,this.tessellation=null!=(t=e.tessellation)?t:16,this.capSubdivisions=null!=(t=e.capSubdivisions)?t:6,this.radiusTop=e.radiusTop,this.radiusBottom=e.radiusBottom,this.topCapSubdivisions=e.topCapSubdivisions,this.bottomCapSubdivisions=e.bottomCapSubdivisions}get Radius(){return this.radius}set Radius(e){e!==this.radius&&(this.writeSnapshoot(),this.radius=e,this.update())}get RadiusTop(){return this.radiusTop}set RadiusTop(e){e!==this.radiusTop&&(this.writeSnapshoot(),this.radiusTop=e,this.update())}get RadiusBottom(){return this.radiusBottom}set RadiusBottom(e){e!==this.radiusBottom&&(this.writeSnapshoot(),this.radiusBottom=e,this.update())}get CapSubdivisions(){return this.capSubdivisions}set CapSubdivisions(e){e!==this.capSubdivisions&&(this.writeSnapshoot(),this.capSubdivisions=e,this.update())}get TopCapSubdivisions(){return this.topCapSubdivisions}set TopCapSubdivisions(e){e!==this.topCapSubdivisions&&(this.writeSnapshoot(),this.topCapSubdivisions=e,this.update())}get BottomCapSubdivisions(){return this.bottomCapSubdivisions}set BottomCapSubdivisions(e){e!==this.bottomCapSubdivisions&&(this.writeSnapshoot(),this.bottomCapSubdivisions=e,this.update())}get Height(){return this.height}set Height(e){e!==this.height&&(this.writeSnapshoot(),this.height=e,this.update())}get Subdivisions(){return this.subdivisions}set Subdivisions(e){e!==this.subdivisions&&(this.writeSnapshoot(),this.subdivisions=e,this.update())}get Tessellation(){return this.tessellation}set Tessellation(e){e!==this.tessellation&&(this.writeSnapshoot(),this.tessellation=e,this.update())}get VertextData(){return(0,n.CreateCapsuleVertexData)({radius:this.radius,radiusTop:this.radiusTop,radiusBottom:this.radiusBottom,height:this.height,subdivisions:this.subdivisions,tessellation:this.tessellation,capSubdivisions:this.capSubdivisions,topCapSubdivisions:this.topCapSubdivisions,bottomCapSubdivisions:this.bottomCapSubdivisions})}writeFile(e){super.writeFile(e),e.write(1),e.write(this.radius),e.write(this.height),e.write(this.subdivisions),e.write(this.tessellation),e.write(this.capSubdivisions),e.write(this.radiusTop),e.write(this.radiusBottom),e.write(this.topCapSubdivisions),e.write(this.bottomCapSubdivisions)}readFile(e){super.readFile(e),e.read(),this.radius=e.read(),this.height=e.read(),this.subdivisions=e.read(),this.tessellation=e.read(),this.capSubdivisions=e.read(),this.radiusTop=e.read(),this.radiusBottom=e.read(),this.topCapSubdivisions=e.read(),this.bottomCapSubdivisions=e.read(),this.update()}}),Jn=(Qn.type="Capsule",Qn=y([E],Qn),class extends Wn{constructor(e={diameter:1,tessellation:2,thickness:.1}){var t;super(),this.diameter=1,this.thickness=.1,this.diameter=null!=(t=e.diameter)?t:1,this.tessellation=null!=(t=e.tessellation)?t:32,this.thickness=null!=(t=e.thickness)?t:.1}get Diameter(){return this.diameter}set Diameter(e){e!==this.diameter&&(this.writeSnapshoot(),this.diameter=e,this.update())}get Tthickness(){return this.thickness}set Tthickness(e){e!==this.thickness&&(this.writeSnapshoot(),this.thickness=e,this.update())}get Tessellation(){return this.tessellation}set Tessellation(e){e!==this.tessellation&&(this.writeSnapshoot(),this.tessellation=e,this.update())}get VertextData(){return(0,n.CreateTorusVertexData)({diameter:this.diameter,tessellation:this.tessellation,thickness:this.thickness})}writeFile(e){super.writeFile(e),e.write(1),e.write(this.diameter),e.write(this.thickness),e.write(this.tessellation)}readFile(e){super.readFile(e),e.read(),this.diameter=e.read(),this.thickness=e.read(),this.tessellation=e.read(),this.update()}}),$n=(Jn.type="Torus",Jn=y([E],Jn),class extends Wn{constructor(e){var t;super(),this.width=10,this.height=10,this.width=null!=(t=null==e?void 0:e.width)?t:this.width,this.height=null!=(t=null==e?void 0:e.height)?t:this.height}get Width(){return this.width}set Width(e){e!==this.width&&(this.writeSnapshoot(),this.width=e,this.update())}get Height(){return this.height}set Height(e){e!==this.height&&(this.writeSnapshoot(),this.height=e,this.update())}get VertextData(){return(0,n.CreateGroundVertexData)({width:this.width,height:this.height})}writeFile(e){super.writeFile(e),e.write(1),e.write(this.width),e.write(this.height)}readFile(e){super.readFile(e),e.read(),this.width=e.read(),this.height=e.read(),this.update()}}),es=($n.type="Ground",$n=y([E],$n),class extends Ln{constructor(){super(...arguments),this._colorIndex=2,this._name="\u70b9\u5149\u6e90",this.Range=100}initDrawObject(e=u.Conceptual){var t=new n.Mesh(this.UniqueName+"_root",_e.Scene);const i=n.MeshBuilder.CreateSphere("root_"+this.UniqueName,{diameter:.1},_e.Scene),r=new n.StandardMaterial("point-light",_e.Scene),s=(r.emissiveColor=Tr.getColor3(this.ColorIndex),i.material=r,new n.PointLight(this.UniqueName,n.Vector3.Zero(),_e.Scene));return s.diffuse=Tr.getColor3(this.ColorIndex),s.intensity=this.Intensity,s.range=this.Range,s.parent=t,i.parent=t,i.setEnabled(this.showHelper),this.initShadowGenerator(s),t}updateDrawObject(e,t){if(t&&0!==t.getChildren().length){const e=t.getChildren()[0];e.intensity=this.Intensity,e.range=this.Range}}writeFile(e){super.writeFile(e),e.write(1),e.write(this.Range)}readFile(e){super.readFile(e),e.read(),this.Range=e.read(),this.update()}}),ts=(es.type="PointLight",y([Lr],es.prototype,"Range",void 0),es=y([E],es),class extends Ln{constructor(){super(...arguments),this._angle=Math.PI/3,this._dir=[-1,-1,-1],this._colorIndex=2,this._name="\u5c04\u706f",this.Range=100}initDrawObject(){var e=new n.Mesh(this.UniqueName+"_root",_e.Scene);const t=n.CylinderBuilder.CreateCylinder(this.UniqueName+"_cy",{diameterTop:0,diameterBottom:.2,height:.4},_e.Scene);t.setEnabled(this.showHelper);var i=n.Matrix.RotationAxis(n.Vector3.Right(),-Math.PI/2);t.bakeTransformIntoVertices(i);const r=new n.SpotLight(this.UniqueName,n.Vector3.Zero(),n.Vector3.FromArray(this._dir).normalize(),this._angle,2,_e.Scene);return r.parent=e,t.parent=e,r.diffuse=Tr.getColor3(this.ColorIndex),r.intensity=this.Intensity,r.range=this.Range,this.initShadowGenerator(r),e}updateDrawObject(e,t){if(t&&2===t.getChildren().length){const e=(t=t.getChildren())[0],i=(e.intensity=this.Intensity,e.range=this.Range,t[1]),r=new n.StandardMaterial(this.UniqueName+"_mtl",_e.Scene);t=((i.material=r).wireframe=!0,ne(this.Position)).add(n.Vector3.FromArray(this._dir)),i.lookAt(t,0,0,0,n.Space.WORLD)}}}),is=(ts.type="SpotLight",y([Lr],ts.prototype,"Range",void 0),ts=y([E],ts),class extends Ln{constructor(){super(...arguments),this._dir=[-1,-1,-1],this._colorIndex=7,this._name="\u65b9\u5411\u5149"}initDrawObject(){var e=new n.Mesh(this.UniqueName+"_root",_e.Scene);const t=new n.DirectionalLight(this.UniqueName,n.Vector3.FromArray(this._dir),_e.Scene);return t.parent=e,t.diffuse=Tr.getColor3(this._colorIndex),this.initShadowGenerator(t),e}});is.type="DirectionalLight",is=y([E],is);class rs{constructor(){this.noHistory=!0}exec(){Gn.Intance.Database.HistoryManager.undo()}}class ns{constructor(){this.noHistory=!0}exec(){Gn.Intance.Database.HistoryManager.redo()}}class ss{constructor(){this.CommandMap=new Map,this._CommandNameList=new Set,this.doing=!1}ExecCommand(e){return v(this,void 0,void 0,(function*(){if(this.CommandMap.has(e)){let t=this.CommandMap.get(e);if(!this.doing){this.CommandStart(e,t.noHistory);try{yield t.exec()}catch(e){he.trigger({type:"error",target:null,error:e})}yield this.CommandEnd(t.noHistory)}}}))}RegisterCommand(e,t){e=e.toUpperCase(),this.CommandMap.set(e,t),this._CommandNameList.add(e)}RemoveCommand(e){e&&(e=e.toUpperCase(),this.CommandMap.delete(e),this._CommandNameList.delete(e))}CommandStart(e,t=!1){return!this.doing&&(this.LastCmd=e,this.doing=!0,t||Gn.Intance.Database.HistoryManager.startCmd(e),!0)}CommandEnd(e=!1){return v(this,void 0,void 0,(function*(){this.doing=!1,e||Gn.Intance.Database.HistoryManager.endCmd()}))}get CommandNameList(){return this._CommandNameList}}const os=new ss;var as=Object.freeze({__proto__:null,registerCommand:function(e=[]){os.RegisterCommand("undo",new rs),os.RegisterCommand("redo",new ns);for(const t of e)os.RegisterCommand(t[0],t[1])},CommandManager:ss,commandManager:os,CommandWrap:function(e,t=""){return v(this,void 0,void 0,(function*(){if(os.CommandStart(t)){let t=!0;try{var i=yield e();t="boolean"==typeof i&&i}catch(e){}yield os.CommandEnd(t)}}))}});class hs extends kn{}class ls extends class{constructor(){this.actions=[]}check(){return!1}addAction(e){this.actions.push(e)}do(){return v(this,void 0,void 0,(function*(){for(const e of this.actions)yield e.do()}))}}{constructor(){super(...arguments),this.conditionType=J.Equal}static Create(e={entity:null}){const t=new ls;return t.entity=e.entity,e.type&&(t.conditionType=e.type),t.propertyKey=e.key,t.target=e.target,t}check(){if(null==(i=this.entity)||!i.Object||!this.propertyKey)return!1;var e=this.entity.Object;let t=e;for(const i of this.propertyKey.split("/"))t=e[i];var i=t;return this.compare(i,this.target,this.conditionType)}compare(e,t,i){switch(typeof e!=typeof t&&(t=i===J.Equal?(e=String(e),String(t)):(e=Number(e),Number(t))),i){case J.Equal:return e===t;case J.Greater:return t<e;case J.Less:return e<t;case J.GreEqu:return t<=e;case J.LessEqu:return e<=t;default:return!1}}}class cs extends class{do(){}}{constructor(e=[],t={x:0,y:0,z:0}){super(),this.entitys=e,this.target=t,this.animateType="",this.isOffset=!0,this.time=1}do(){const e=[];for(const t of this.entitys){const i=t.Object;e.push(i.moveTo(this.target,this.isOffset,{time:1}))}return Promise.all(e)}}let us=class extends kr{constructor(){super(...arguments),this.data={type:"url",value:"",target:"_blank"}}do(){switch(this.data.type){case"url":this.openUrl(this.data.value);break;case"file":this.openUrl(j(location.href,"id",this.data.value)+"&time="+Date.now());break;case"back":history.back();break;case"reload":location.reload()}return!0}readFile(e){e.read(),this.data=JSON.parse(e.read())}writeFile(e){e.write(1),e.write(JSON.stringify(this.data))}toJSON(){return Object.assign({},this.data)}fromJSON(e){Object.assign(this.data,e)}openUrl(e){var t="OpenWidgetHref";let i=document.getElementById(t);i||(i=document.createElement("a"),document.body.appendChild(i),i.setAttribute("id",t)),i.setAttribute("target",this.data.target),i.setAttribute("href",e),i.click()}},ds=(us.type="Open",us.schema={label:"\u6253\u5f00\u94fe\u63a5"},us=y([E],us),class extends kr{constructor(){super(...arguments),this._list=[]}get List(){return[...this._list]}do(){return v(this,void 0,void 0,(function*(){const e=[];for(const t of this._list){const i=t.objectId.Object;i&&e.push(i.moveTo(t.target,t.type===$.Offset,{time:t.time,startTime:this.startTime}))}return Promise.all(e).then((e=>!0))}))}add(e){this._list.push(e)}fromJSON(e){this._list.length=0;for(const t of e)this._list.push({objectId:t.objectId,time:t.time,target:t.target,type:t.type,animationType:t.animationType})}readFile(e){e.read();var t=e.read();for(let i=this._list.length=0;i<t;i++){const t={target:{x:0,y:0,z:0}};t.objectId=e.readObjectId(),t.type=e.read(),t.target.x=e.read(),t.target.y=e.read(),t.target.z=e.read(),t.time=e.read(),t.animationType=e.read(),this._list.push(t)}}writeFile(e){e.write(1),e.write(this._list.length);for(const t of this._list)e.writeObjectId(t.objectId),e.write(t.type),e.write(t.target.x),e.write(t.target.y),e.write(t.target.z),e.write(t.time),e.write(t.animationType)}});ds.type="Move",ds.schema={label:"\u79fb\u52a8"},ds=y([E],ds);const ps=eval;function _s(e,t){if(!e)return 0;let i="";if(t)for(var r in t)i+=`let ${r} = ${t[r]};`;i+=e;let n=ps(i);return"function"==typeof n?n():Number(n)}let fs=class extends kr{constructor(){super(...arguments),this._List=[]}get List(){return[...this._List]}do(){return v(this,void 0,void 0,(function*(){const e=[];for(const r of this._List){const n=r.objectId.Object;var t,i;n&&(t={x:(t=n.BoundingBox.extendSize.scale(2)).x,X:t.x,y:t.y,Y:t.y,z:t.z,Z:t.z},t={x:_s(r.pivot.x,t),y:_s(r.pivot.y,t),z:_s(r.pivot.z,t)},i={x:parseFloat(r.axis.x)||0,y:parseFloat(r.axis.y)||0,z:parseFloat(r.axis.z)||0},e.push(n.rotateTo({angle:0===r.dir?-1*r.angle:r.angle,time:r.time,isOffset:r.type===$.Offset,animation:!0,pivot:t,startTime:this.startTime,dir:i})))}return Promise.all(e).then((e=>!0))}))}add(e){this._List.push(e)}fromJSON(e){this._List.length=0;for(const t of e)this._List.push({objectId:t.objectId,time:t.time,angle:t.angle,type:t.type,animationType:t.animationType,dir:t.dir,pivot:t.pivot,axis:t.axis})}readFile(e){var t=e.read(),i=e.read();for(let r=this._List.length=0;r<i;r++){const i={pivot:{x:"",y:"",z:""},axis:{x:"0",y:"1",z:"0"}};i.objectId=e.readObjectId(),i.type=e.read(),i.time=e.read(),i.animationType=e.read(),i.angle=e.read(),i.dir=e.read(),i.pivot.x=e.read(),i.pivot.y=e.read(),i.pivot.z=e.read(),1<t&&(i.axis.x=e.read(),i.axis.y=e.read(),i.axis.z=e.read()),this._List.push(i)}}writeFile(e){e.write(2),e.write(this._List.length);for(const t of this._List)e.writeObjectId(t.objectId),e.write(t.type),e.write(t.time),e.write(t.animationType),e.write(t.angle),e.write(t.dir),e.write(t.pivot.x),e.write(t.pivot.y),e.write(t.pivot.z),e.write(t.axis.x),e.write(t.axis.y),e.write(t.axis.z)}},gs=(fs.type="Rotate",fs.schema={label:"\u65cb\u8f6c"},fs=y([E],fs),class extends kr{constructor(){super(...arguments),this.List=[]}do(){return v(this,void 0,void 0,(function*(){for(const e of this.List){const{type:t,objectId:i}=e;switch(t){case"Show":i.Object.Visiable=!0;break;case"Hidden":i.Object.Visiable=!1;break;case"Toggle":i.Object.Visiable=!i.Object.Visiable}}return!0}))}fromJSON(e){this.List=e}readFile(e){e.read(),this.List.length=0,e.readAnyArray((()=>{const t={};t.type=e.read(),t.objectId=e.readObjectId(),this.List.push(t)}))}writeFile(e){e.write(1),e.writeAnyArray(this.List,(t=>{e.write(t.type),e.writeObjectId(t.objectId)}))}}),ms=(gs.type="Display",gs.schema={label:"\u663e\u793a/\u9690\u85cf"},gs=y([E],gs),class extends kr{constructor(){super(...arguments),this._List=[]}get List(){return[...this._List]}do(){return v(this,void 0,void 0,(function*(){const e=[];for(const s of this._List){const o=s.objectId.Object;if(o){let a,h,l;var t=o.BoundingBox.extendSize.scale(2),i=s.bySize?o.BoundingBox.extendSizeWorld.scale(2):o.Scale,r={x:i.x,X:i.x,y:i.y,Y:i.y,z:i.z,Z:i.z};t={x:t.x,X:t.x,y:t.y,Y:t.y,z:t.z,Z:t.z},r=(a=_s(s.scale.x,r),h=_s(s.scale.y,r),l=_s(s.scale.z,r),s.bySize&&(a/=i.x,h/=i.y,l/=i.z),{x:_s(s.pivot.x,t),y:_s(s.pivot.y,t),z:_s(s.pivot.z,t)});e.push(o.scaleTo({scale:new n.Vector3(a,h,l),time:s.time,animation:!0,isOffset:s.bySize,pivot:r,startTime:this.startTime}))}}return Promise.all(e).then((e=>!0))}))}add(e){this._List.push(e)}toJSON(){return{}}fromJSON(e){this._List.length=0;for(const t of e)this._List.push(Object.assign({},t))}readFile(e){e.read(),this._List.length=0,e.readAnyArray((()=>{const t={scale:{x:"1",y:"1",z:"1"},pivot:{x:"x/2",y:"y/2",z:"z/2"}};t.objectId=e.readObjectId(),t.scale.x=e.read(),t.scale.y=e.read(),t.scale.z=e.read(),t.pivot.x=e.read(),t.pivot.y=e.read(),t.pivot.z=e.read(),t.type=e.read(),t.time=e.read(),t.animationType=e.read(),t.bySize=e.read(),this._List.push(t)}))}writeFile(e){e.write(1),e.writeAnyArray(this._List,(t=>{e.writeObjectId(t.objectId),e.write(t.scale.x),e.write(t.scale.y),e.write(t.scale.z),e.write(t.pivot.x),e.write(t.pivot.y),e.write(t.pivot.z),e.write(t.type),e.write(t.time),e.write(t.animationType),e.write(t.bySize)}))}}),ys=(ms.type="Scale",ms.schema={label:"\u7f29\u653e"},ms=y([E],ms),class extends kr{constructor(){super(),this.current=!1,this._target={x:void 0,y:void 0,z:void 0},this._time=1e3}do(){return v(this,void 0,void 0,(function*(){const e=ge.MainViewer.cameraManager.Control.moveTo({alpha:this._alpha,beta:this._beta,target:this._target,radius:this._radius,time:this._time});return yield e.start(),!0}))}fromJSON(e){var t;this._alpha=null!=(t=e.alpha)?t:this._alpha,this._beta=null!=(t=e.beta)?t:this._beta,this._radius=null!=(t=e.radius)?t:this._radius,this._target=null!=(t=e.target)?t:this._target,this._time=null!=(t=e.time)?t:this._time}readFile(e){e.read(),this._alpha=e.read(),this._beta=e.read(),this._radius=e.read(),this._target.x=e.read(),this._target.y=e.read(),this._target.z=e.read(),this._time=e.read()}writeFile(e){e.write(1),e.write(this._alpha),e.write(this._beta),e.write(this._radius),e.write(this._target.x),e.write(this._target.y),e.write(this._target.z),e.write(this._time)}}),vs=(ys.type="MoveCamera",ys.schema={label:"\u79fb\u52a8\u76f8\u673a\u5230"},ys=y([E],ys),class extends kr{constructor(){super(...arguments),this.list=[]}get List(){return[...this.list]}do(){for(const t of this.list){const i=ge.GlobalVariables.find((e=>e.key===t.key));var e;i&&("value"===t.value.type?i.value=t.value.value:"param"===t.value.type?(e=ge.GlobalVariables.find((e=>e.key===t.value.value)),i.value=e.value):"entity"===t.value.type&&(i.value=t.value.value.Object[t.value.entityKey]))}return localStorage.setItem("variables",JSON.stringify(ge.GlobalVariables)),!0}add(e){this.list.push(e)}fromJSON(e){this.list=e}readFile(e){e.read(),this.list.length=0,e.readAnyArray((()=>{const t={key:"",value:{type:null,value:null}};t.key=e.read(),e.readWidgetValue(t.value),this.list.push(t)}))}writeFile(e){e.write(1),e.writeAnyArray(this.list,(t=>{e.write(t.key),e.writeWidgetValue(t.value)}))}}),bs=(vs.type="SetVariable",vs.schema={label:"\u8bbe\u7f6e\u53d8\u91cf\u503c"},vs=y([E],vs),class extends kr{constructor(){super(...arguments),this._time=1e3}do(){return new Promise((e=>setTimeout(e,this._time)))}fromJSON(e){this._time=e.time}readFile(e){e.read(),this._time=e.read()}writeFile(e){e.write(1),e.write(this._time)}}),ws=(bs.type="Wait",bs.schema={label:"\u7b49\u5f85"},bs=y([E],bs),class extends kr{constructor(){super(),this._list=[]}get List(){return[...this._list]}do(){return v(this,void 0,void 0,(function*(){for(const e of this._list)switch(e.type){case"select":e.objectId.Object.IsSelect=!0;break;case"unSelect":e.objectId.Object.IsSelect=!1;break;case"toggle":e.objectId.Object.IsSelect=!e.objectId.Object.IsSelect}return!0}))}fromJSON(e){this._list.length=0;for(const t of e)t.type&&t.objectId&&this._list.push({type:t.type,objectId:t.objectId});return this}readFile(e){e.read(),this._list.length=0,e.readAnyArray((()=>{const t={type:"",objectId:null};t.type=e.read(),t.objectId=e.readObjectId(),this._list.push(t)}))}writeFile(e){e.write(1),e.writeAnyArray(this._list,(t=>{e.write(t.type),e.writeObjectId(t.objectId)}))}}),xs=(ws.type="Select",ws.schema={label:"\u8bbe\u7f6e\u9009\u4e2d"},ws=y([E],ws),class extends kr{do(){return!0}readFile(e){e.read()}writeFile(e){e.write(1)}}),Ts=(xs.type="DataFeedback",xs.schema={label:"\u6570\u636e\u53cd\u9988"},xs=y([E],xs),class extends kr{constructor(){super(...arguments),this._list=[]}get List(){return[...this._list]}do(){return v(this,void 0,void 0,(function*(){for(const e of this._list){e.objectId.Object.highlight(e.color)}return!0}))}fromJSON(e){this._list=e}readFile(e){e.read(),this._list.length=0,e.readAnyArray((()=>{const t={color:"",objectId:null};t.color=e.read(),t.objectId=e.readObjectId(),this._list.push(t)}))}writeFile(e){e.write(1),e.writeAnyArray(this._list,(t=>{e.write(t.color),e.writeObjectId(t.objectId)}))}});function Cs(e,t=[]){if(e)return"value"===e.type?e.value:"param"===e.type?null==(t=t.find((t=>t.key===e.value)))?void 0:t.value:"entity"===e.type?(e.entityKey,null==(t=null==(t=e.value)?void 0:t.Object)?void 0:t[e.entityKey]):void 0}function Es(e){return"RightClick"===e||"Click"===e?"pointerPick":"Load"===e?"load":e}Ts.type="Highlight",Ts.schema={label:"\u663e\u793a\u9ad8\u4eae\u8fb9\u6846"},Ts=y([E],Ts);let Ss=class extends kr{constructor(){super(...arguments),this._list=[]}get List(){return[...this._list]}do(){var e;for(const t of this._list){const i=null==(e=t.objectId)?void 0:e.Object;i?t.triggerNames.forEach((e=>{e=Object.assign(Object.assign({},this.getTriggerEvent(e)),{type:Es(e),target:i}),i.trigger(e)})):t.triggerNames.forEach((e=>{e=this.getTriggerEvent(e),he.trigger(e)}))}return!0}fromJSON(e){this._list=e}readFile(e){e.read(),this._list.length=0,e.readAnyArray((()=>{let t={triggerNames:[],objectId:null};e.readAnyArrayAndPush(t.triggerNames,e.read),t.objectId=e.readObjectId(),this._list.push(t)}))}writeFile(e){e.write(1),e.writeAnyArray(this._list,(t=>{e.writeAnyArray(t.triggerNames,e.write),e.writeObjectId(t.objectId)}))}getTriggerEvent(e,t){switch(e){case"Click":case"DoubleClick":return{type:"pointerDown",event:{button:0},isChild:!0,target:t};case"RightClick":return{type:"pointerDown",event:{button:2},isChild:!0,isEnd:!0,target:t};case"Load":return{type:"loadFile",isChild:!0,target:t};default:return{type:e,target:t,isChild:!0}}}},Ps=(Ss.type="Dispatch",Ss.schema={label:"\u89e6\u53d1\u4e8b\u4ef6"},Ss=y([E],Ss),class extends kr{constructor(){super(...arguments),this.List=[]}do(){var e;return v(this,void 0,void 0,(function*(){const t=[];for(const i of this.List){const r=null==(e=i.objectId)?void 0:e.Object;r&&t.push(r.opacityTo(Object.assign(Object.assign({},i),{startTime:this.startTime})))}return Promise.all(t)}))}fromJSON(e){this.List=e}readFile(e){e.read(),this.List.length=0,e.readAnyArray((()=>{const t={};t.opacity=e.read(),t.time=e.read(),t.animationType=e.read(),t.objectId=e.readObjectId(),this.List.push(t)}))}writeFile(e){e.write(1),e.writeAnyArray(this.List,(t=>{e.write(t.opacity),e.write(t.time),e.write(t.animationType),e.writeObjectId(t.objectId)}))}}),Rs=(Ps.type="Opacity",Ps.schema={label:"\u8bbe\u7f6e\u4e0d\u900f\u660e"},Ps=y([E],Ps),class extends L{constructor(e,t=null){super(),this._triggerType=e,this.target=t,this.list=[],this._cleaners=[],this.watch()}get TriggerType(){return this._triggerType}get List(){return[...this.list]}set List(e){this.list=e}get Target(){return this.target}do(){return v(this,void 0,void 0,(function*(){const e=[];let t=0;for(const i of this.list)if(this.DB.InteractionTable.Pause&&(yield this.DB.InteractionTable.wait(),yield Promise.all(e).then((t=>{e.length=0}))),"Wait"===i.Type)yield i.do(),t+=i._time/1e3;else if(i.IsContainer){if(yield i.do())return}else i.startTime=t,e.push(i.do());return Promise.all(e).then((e=>{}))}))}add(e){this.list.push(e)}destory(){super.destory(),this.clearWatch();for(const e of this.list)e.destory()}readFile(e){super.readFile(e),e.read(),this._triggerType=e.read(),e.readAnyArrayAndPush(this.list,e.readObject),this.target=e.readObjectId(),this.watch()}writeFile(e){super.writeFile(e),e.write(1),e.write(this._triggerType),e.writeAnyArray(this.list,e.writeObject),e.writeObjectId(this.target)}clearWatch(){this._cleaners.forEach((e=>e())),this._cleaners.length=0}watch(){var e;this.clearWatch(),this.target&&ge.PreviewMode&&(e=Es(this._triggerType),pe[e]?this._cleaners.push(this.target.Object.registerAction(e,(e=>v(this,void 0,void 0,(function*(){this.DB.InteractionTable.doing||this.check(e.sourceEvent)&&(yield this.doList())}))))):this._cleaners.push(this.target.Object.on(e,(e=>v(this,void 0,void 0,(function*(){this.DB.InteractionTable.doing&&"load"!==e.type&&!e.isChild||this.check(e)&&(yield this.doList())}))))))}check(e){var t;return!e||("RightClick"===this._triggerType?2===e.event.button:void 0===(null==(t=e.event)?void 0:t.button)||e.event.button<=0)}doList(){return v(this,void 0,void 0,(function*(){this.DB.InteractionTable.Pause?this.DB.InteractionTable.queues.push((()=>v(this,void 0,void 0,(function*(){this.DB.InteractionTable.doing=!0,yield this.do(),this.DB.InteractionTable.doing=!1})))):(this.DB.InteractionTable.doing=!0,yield this.do(),this.DB.InteractionTable.doing=!1)}))}}),As=(Rs.type="Interaction",Rs=y([E],Rs),class{constructor(){this.type=ee.Equal}check(){return this.compare()}writeFile(e){e.write(1),e.writeWidgetValue(this.value1),e.writeWidgetValue(this.value2),e.write(this.type)}readFile(e){e.read(),this.value1||(this.value1={}),e.readWidgetValue(this.value1),this.value2||(this.value2={}),e.readWidgetValue(this.value2),this.type=e.read()}compare(){var e=Cs(this.value1,this._Params),t=Cs(this.value2,this._Params);switch(this.type){case ee.Equal:return e===t;case ee.UnEqual:return e!==t;case ee.Great:return t<e;case ee.Less:return e<t;case ee.GtEqual:return t<=e;case ee.LessEqual:return e<=t;case ee.Include:case ee.UnInclude:case ee.Is:case ee.IsNot:default:return!1}}}),Ms=(As.type="Compare",As=y([E],As),0),Os=class extends kr{constructor(){super(...arguments),this.IsContainer=!0,this.isAll=!0,this.compares=[],this.list=[],this.Name="\u60c5\u5f62"+Ms++}check(){return this.compares.forEach((e=>e._Params=ge.GlobalVariables)),this.isAll?this.compares.every((e=>e.check())):this.compares.some((e=>e.check()))}do(){return v(this,void 0,void 0,(function*(){if(!this.check())return!1;let e=0;const t=[];for(const i of this.list)"Wait"===i.Type?(yield i.do(),e+=i._time/1e3):(i.startTime=e,t.push(i.do()));return Promise.all(t).then((()=>!0))}))}add(e){this.list.push(e)}addCompare(e){this.compares.push(e)}writeFile(e){e.write(1),e.write(this.isAll),e.write(this.Name),e.writeAnyArray(this.list,e.writeObject),e.writeAnyArray(this.compares,e.writeObject)}readFile(e){e.read(),this.isAll=e.read(),this.Name=e.read(),e.readAnyArrayAndPush(this.list,e.readObject),e.readAnyArrayAndPush(this.compares,e.readObject)}};Os.type="Condition",Os=y([E],Os);var Is,Fs,Ds=Object.freeze({__proto__:null,get Open(){return us},get Move(){return ds},get Rotate(){return fs},get Display(){return gs},get Scale(){return ms},get MoveCamera(){return ys},get SetVariable(){return vs},get Wait(){return bs},get Select(){return ws},get DataFeedback(){return xs},get Highlight(){return Ts},get Dispatch(){return Ss},get Opacity(){return Ps},get Interaction(){return Rs},get Compare(){return As},get Condition(){return Os}});!function(e){e.Ws="1",e.Api="2"}(Fs=Fs||{});let Ls=Is=class{constructor(e,t){this.target=e,this.targetKey=t,this.type=Fs.Ws}do(){this.type===Fs.Api?this.startApiRequest():this.startWs()}setEntityValue(e){var t=this.target.Object;if(t){const i=this.targetKey.split("/");let r=t;t=i.pop();for(const e of i)r=r[e];"setProp"in r?r.setProp(t,e):r[t]=e}}destory(){if(this._time&&clearTimeout(this._time),"ws"in this.data){const e=Is.WSList.get(this.data.ws);e&&(e.close(),Is.WSList.delete(this.data.ws))}}writeFile(e){e.write(1),e.writeObjectId(this.target),e.write(this.targetKey),e.write(this.type),e.write(JSON.stringify(this.data))}readFile(e){e.read(),this.target=e.readObjectId(),this.targetKey=e.read(),this.type=e.read(),(e=e.read())&&(this.data=JSON.parse(e))}startApiRequest(){return v(this,void 0,void 0,(function*(){var{type:e,params:t,time:i,url:r,filter:n}=this.data;let s=e=>e;try{const e=new Function("return "+n);e&&(s=e())}catch(e){}const o={};if(t)for(const e of t)o[e.key]=e.value;n=yield function(e,t){var i={method:null!=(i=t.method)?i:"GET",body:null!=t&&t.data?JSON.stringify(t.data):void 0};if(t.params){let i="?";for(const e in t.params)i+=e+"="+t.params[e];e+=i}return fetch(e,i).then((e=>e.json()))}(r,Object.assign({method:e},"POST"===e?{data:o}:{params:o})),this.setEntityValue(s(n)),i&&0<i&&(this._time=setTimeout((()=>{this.startApiRequest()}),1e3*i))}))}startWs(){const e=this.data;if(e.ws){let t=Is.WSList.get(e.ws);t||(t=new WebSocket(e.ws),Is.WSList.set(e.ws,t)),t.addEventListener("message",(t=>{t.data&&(t=JSON.parse(t.data),e.key in(null==t?void 0:t.params)&&this.setEntityValue(t.params[e.key]))}))}}},Bs=(Ls.type="DataBind",Ls.WSList=new Map,Ls=Is=y([E],Ls),class extends we{constructor(){super(...arguments),this._background="#4a4b4b"}get Visiable(){return super.Visiable}set Visiable(e){super.Visiable=e,this.lines.forEach((t=>t.isVisible=!this._erase&&e))}setProp(e,t){super.setProp(e,t);const i=this._drawObject,r=i.children;var n=r.length;let o=0;for(;o<this.dataList.length;o++){var a=this.dataList[o];if(r[o])r[o].text=a.label+"\uff1a"+a.value+" "+a.unit;else{const e=new s.TextBlock(a.key,a.label+"\uff1a"+a.value+" "+a.unit);e.height=this._height,e.color="#fff",i.addControl(e)}}for(;o<n;o++)i.removeControl(r[o])}initDrawObject(){const e=new s.StackPanel(this.UniqueName);return e.shadowOffsetX=1,e.shadowOffsetY=1,e.shadowBlur=8,e.shadowColor="#168df8",e.background=this._background,this.updateDrawObject(e),this.generateLinkLine(e),e}updateDrawObject(e){super.updateDrawObject(e),e.background=this._background;const t=e.children;var i=t.length;let r=0;for(;r<this.dataList.length;r++){var n=this.dataList[r];if(t[r])t[r].text=n.label+"\uff1a"+n.value+" "+n.unit;else{const t=new s.TextBlock(n.key,n.label+"\uff1a"+n.value+" "+n.unit);t.height=this._height,t.color="#fff",e.addControl(t)}}for(;r<i;r++)e.removeControl(t[r])}readFile(e){super.readFile(e),e.read(),this._background=e.read(),this.update()}writeFile(e){super.writeFile(e),e.write(1),e.write(this._background)}});function Ns(e){for(;e.firstChild;)e.removeChild(e.firstChild);e.srcObject=null,e.src="",e.removeAttribute("src")}Bs.type="StackPanelGui",Bs=y([E],Bs);class ks extends s.Control{constructor(e,t=null,i,r,s){super(e),this.name=e,this.scene=s,this._workingCanvas=null,this._loaded=!1,this._autoScale=!1,this._sourceLeft=0,this._sourceTop=0,this._sourceWidth=0,this._sourceHeight=0,this._svgAttributesComputationCompleted=!1,this._cellWidth=0,this._cellHeight=0,this._cellId=-1,this._keepSize=!0,this._imageDataCache={data:null,key:""},this.onImageLoadedObservable=new n.Observable,this.onSVGAttributesComputedObservable=new n.Observable,this.width=i,this.height=r,this.source=t,this.listener=s.onAfterRenderObservable.add((()=>{this.isVisible&&this.source&&this._onImageLoaded()}))}get isLoaded(){return this._loaded}get detectPointerOnOpaqueOnly(){return this._detectPointerOnOpaqueOnly}set detectPointerOnOpaqueOnly(e){this._detectPointerOnOpaqueOnly!==e&&(this._detectPointerOnOpaqueOnly=e)}get sourceLeft(){return this._sourceLeft}set sourceLeft(e){this._sourceLeft!==e&&(this._sourceLeft=e,this._markAsDirty())}get sourceTop(){return this._sourceTop}set sourceTop(e){this._sourceTop!==e&&(this._sourceTop=e,this._markAsDirty())}get sourceWidth(){return this._sourceWidth}set sourceWidth(e){this._sourceWidth!==e&&(this._sourceWidth=e,this._markAsDirty())}get sourceHeight(){return this._sourceHeight}set sourceHeight(e){this._sourceHeight!==e&&(this._sourceHeight=e,this._markAsDirty())}get imageWidth(){return this._videoWidth}get imageHeight(){return this._videoHeight}get svgAttributesComputationCompleted(){return this._svgAttributesComputationCompleted}get autoScale(){return this._autoScale}set autoScale(e){this._autoScale!==e&&(this._autoScale=e)&&this._loaded&&this.synchronizeSizeWithContent()}get keepSize(){return this._autoScale}set keepSize(e){this._keepSize!==e&&(this._keepSize=e)&&this._loaded&&this.synchronizeSizeWithContent()}set VideoDom(e){this._video=e,this._loaded=!1,this._imageDataCache.data=null,this._video.width?this._onImageLoaded():this._video.onload=()=>{this._onImageLoaded()}}get VideoDom(){return this._video}_onImageLoaded(){this._imageDataCache.data=null,this._videoWidth=this._video.videoWidth,this._videoHeight=this._video.videoHeight,this._loaded=!0,this._autoScale&&this.synchronizeSizeWithContent(),this.onImageLoadedObservable.notifyObservers(this),this._markAsDirty()}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return n.Tools.SetCorsBehavior(e.currentSrc,e),e;const t=document.createElement("video");return"string"==typeof e?(n.Tools.SetCorsBehavior(e,t),t.src=e):(n.Tools.SetCorsBehavior(e[0],t),e.forEach((e=>{const i=document.createElement("source");i.src=e,t.appendChild(i)}))),this.onDisposeObservable.addOnce((()=>{Ns(t)})),t}get source(){return this._source}set source(e){this._source!==e&&(this._loaded=!1,this._source=e,this._imageDataCache.data=null,this._video=this._getVideo(e),this._video.crossOrigin="anonymous",this._video.width=400,this._video.height=400,this._video.muted=!0,this._video.autoplay=!0,this._video.loop=!0,e&&(this._video.play(),this._video.addEventListener("play",(()=>{this._onImageLoaded()})),this._video.addEventListener("seeked",(()=>{this._onImageLoaded()})),this._video.addEventListener("canPlay",(()=>{this._onImageLoaded()})),this._video.addEventListener("loadedData",(()=>{this._onImageLoaded()}))))}get cellWidth(){return this._cellWidth}set cellWidth(e){this._cellWidth!==e&&(this._cellWidth=e,this._markAsDirty())}get cellHeight(){return this._cellHeight}set cellHeight(e){this._cellHeight!==e&&(this._cellHeight=e,this._markAsDirty())}get cellId(){return this._cellId}set cellId(e){this._cellId!==e&&(this._cellId=e,this._markAsDirty())}contains(e,t){if(!super.contains(e,t))return!1;if(!this._detectPointerOnOpaqueOnly||!this._workingCanvas)return!0;var i=0|this._currentMeasure.width,r=0|this._currentMeasure.height,n=i+"_"+r;let s=this._imageDataCache.data;if(!s||this._imageDataCache.key!==n){const e=this._workingCanvas.getContext("2d");this._imageDataCache.data=s=e.getImageData(0,0,i,r).data,this._imageDataCache.key=n}return 0<s[4*((e=e-this._currentMeasure.left|0)+(t=t-this._currentMeasure.top|0)*i)+3]}_getTypeName(){return"Image"}synchronizeSizeWithContent(){this._loaded&&(this.width=this._video.width+"px",this.height=this._video.height+"px")}_processMeasures(e,t){this._loaded&&(this._autoScale&&this.synchronizeSizeWithContent(),this.parent&&this.parent.parent&&(this.parent.adaptWidthToChildren=!0,this.parent.adaptHeightToChildren=!0)),super._processMeasures(e,t)}_prepareWorkingCanvasForOpaqueDetection(){var e;if(this._detectPointerOnOpaqueOnly){var t=this._currentMeasure.width,i=this._currentMeasure.height;if(!this._workingCanvas){const r=(null==(e=null==(e=this._host)?void 0:e.getScene())?void 0:e.getEngine())||n.EngineStore.LastCreatedEngine;if(!r)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=r.createCanvas(t,i)}this._workingCanvas.getContext("2d").clearRect(0,0,t,i)}}_drawImage(e,t,i,r,n,s,o,a,h){if(e.drawImage(this._video,t,i,r,n,s,o,a,h),this._detectPointerOnOpaqueOnly){(e=this._workingCanvas.getContext("2d")).drawImage(this._video,t,i,r,n,s-this._currentMeasure.left,o-this._currentMeasure.top,a,h)}}_draw(e){let t,i,r,n;var s,o;e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),n=-1===this.cellId?(t=this._sourceLeft,i=this._sourceTop,r=this._sourceWidth||this._videoWidth,this._sourceHeight||this._videoHeight):(o=this._video.videoWidth/this.cellWidth,s=this.cellId/o>>0,o=this.cellId%o,t=this.cellWidth*o,i=this.cellHeight*s,r=this.cellWidth,this.cellHeight),this._prepareWorkingCanvasForOpaqueDetection(),this._applyStates(e),this._loaded&&this._drawImage(e,t,i,r,n,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._keepSize?this._currentMeasure.width*n/r:this._currentMeasure.height),e.restore()}dispose(){super.dispose(),this.onImageLoadedObservable.clear(),this.onSVGAttributesComputedObservable.clear(),this.listener&&this.scene.onAfterRenderObservable.remove(this.listener),Ns(this._video)}}y([(0,n.serialize)()],ks.prototype,"detectPointerOnOpaqueOnly",null),y([(0,n.serialize)()],ks.prototype,"sourceLeft",null),y([(0,n.serialize)()],ks.prototype,"sourceTop",null),y([(0,n.serialize)()],ks.prototype,"sourceWidth",null),y([(0,n.serialize)()],ks.prototype,"sourceHeight",null),y([(0,n.serialize)()],ks.prototype,"autoScale",null),y([(0,n.serialize)()],ks.prototype,"keepSize",null),y([(0,n.serialize)()],ks.prototype,"source",null),y([(0,n.serialize)()],ks.prototype,"cellWidth",null),y([(0,n.serialize)()],ks.prototype,"cellHeight",null),y([(0,n.serialize)()],ks.prototype,"cellId",null);let Us=class extends we{constructor(e){super(),this._url="",this._width="200px",this._height="100px",null!=e&&e.url&&(this._url=e.url),null!=e&&e.width&&(this._width=e.width),null!=e&&e.height&&(this._height=e.height)}get VideoDom(){return this._videoDom}get Url(){return this._url}set Url(e){this._url=e,this.update()}initDrawObject(){const e=new s.Container(this.UniqueName),t=(e.width=this._width,e.height=this._height,new ks(this.UniqueName,this._url,this._width,this._height,_e.Scene));return e.background="#000",this._videoDom=t.VideoDom,t.keepSize=!0,e.addControl(t),e}updateDrawObject(e){super.updateDrawObject(e);e.children[0].source=this._url}readFile(e){super.readFile(e),e.read(),this.update()}writeFile(e){super.writeFile(e),e.write(1)}erase(e=!0){super.erase(e)}destory(){super.destory()}};Us.type="VideoGui",Us=y([E],Us);class zs extends s.Control{constructor(e,t,i){super(e),this.name=e,this.scene=i,this._needAnimation=!1,this._workingCanvas=null,this._loaded=!1,this._autoScale=!1,this._sourceLeft=0,this._sourceTop=0,this._sourceWidth=0,this._sourceHeight=0,this._svgAttributesComputationCompleted=!1,this._cellWidth=0,this._cellHeight=0,this._cellId=-1,this._keepSize=!0,this._imageDataCache={data:null,key:""},this.onImageLoadedObservable=new n.Observable,this.onSVGAttributesComputedObservable=new n.Observable,this.CanvasDom=t,this.listener=i.onAfterRenderObservable.add((()=>{this.isVisible&&this._needAnimation&&this._onImageLoaded()}))}get isLoaded(){return this._loaded}get detectPointerOnOpaqueOnly(){return this._detectPointerOnOpaqueOnly}set detectPointerOnOpaqueOnly(e){this._detectPointerOnOpaqueOnly!==e&&(this._detectPointerOnOpaqueOnly=e)}get sourceLeft(){return this._sourceLeft}set sourceLeft(e){this._sourceLeft!==e&&(this._sourceLeft=e,this._markAsDirty())}get sourceTop(){return this._sourceTop}set sourceTop(e){this._sourceTop!==e&&(this._sourceTop=e,this._markAsDirty())}get sourceWidth(){return this._sourceWidth}set sourceWidth(e){this._sourceWidth!==e&&(this._sourceWidth=e,this._markAsDirty())}get sourceHeight(){return this._sourceHeight}set sourceHeight(e){this._sourceHeight!==e&&(this._sourceHeight=e,this._markAsDirty())}get imageWidth(){return this._canvasWidth}get imageHeight(){return this._canvasHeight}get svgAttributesComputationCompleted(){return this._svgAttributesComputationCompleted}get autoScale(){return this._autoScale}set autoScale(e){this._autoScale!==e&&(this._autoScale=e)&&this._loaded&&this.synchronizeSizeWithContent()}get keepSize(){return this._autoScale}set keepSize(e){this._keepSize!==e&&(this._keepSize=e)&&this._loaded&&this.synchronizeSizeWithContent()}set CanvasDom(e){this._canvas_=e,this._imageDataCache.data=null,this._onImageLoaded()}get CanvasDom(){return this._canvas_}_onImageLoaded(){this._imageDataCache.data=null,this._canvasWidth=this._canvas_.width,this._canvasHeight=this._canvas_.height,this._loaded=!0,this._autoScale&&this.synchronizeSizeWithContent(),this.onImageLoadedObservable.notifyObservers(this),this._markAsDirty()}get cellWidth(){return this._cellWidth}set cellWidth(e){this._cellWidth!==e&&(this._cellWidth=e,this._markAsDirty())}get cellHeight(){return this._cellHeight}set cellHeight(e){this._cellHeight!==e&&(this._cellHeight=e,this._markAsDirty())}get cellId(){return this._cellId}set cellId(e){this._cellId!==e&&(this._cellId=e,this._markAsDirty())}contains(e,t){if(!super.contains(e,t))return!1;if(!this._detectPointerOnOpaqueOnly||!this._workingCanvas)return!0;var i=0|this._currentMeasure.width,r=0|this._currentMeasure.height,n=i+"_"+r;let s=this._imageDataCache.data;if(!s||this._imageDataCache.key!==n){const e=this._workingCanvas.getContext("2d");this._imageDataCache.data=s=e.getImageData(0,0,i,r).data,this._imageDataCache.key=n}return 0<s[4*((e=e-this._currentMeasure.left|0)+(t=t-this._currentMeasure.top|0)*i)+3]}_getTypeName(){return"Image"}synchronizeSizeWithContent(){this._loaded&&(this.width=this._canvas_.width+"px",this.height=this._canvas_.height+"px")}_processMeasures(e,t){this._loaded&&(this._autoScale&&this.synchronizeSizeWithContent(),this.parent&&this.parent.parent&&(this.parent.adaptWidthToChildren=!0,this.parent.adaptHeightToChildren=!0)),super._processMeasures(e,t)}_prepareWorkingCanvasForOpaqueDetection(){var e;if(this._detectPointerOnOpaqueOnly){var t=this._currentMeasure.width,i=this._currentMeasure.height;if(!this._workingCanvas){const r=(null==(e=null==(e=this._host)?void 0:e.getScene())?void 0:e.getEngine())||n.EngineStore.LastCreatedEngine;if(!r)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=r.createCanvas(t,i)}this._workingCanvas.getContext("2d").clearRect(0,0,t,i)}}_drawImage(e,t,i,r,n,s,o,a,h){if(e.drawImage(this._canvas_,t,i,r,n,s,o,a,h),this._detectPointerOnOpaqueOnly){(e=this._workingCanvas.getContext("2d")).drawImage(this._canvas_,t,i,r,n,s-this._currentMeasure.left,o-this._currentMeasure.top,a,h)}}_draw(e){let t,i,r,n;var s,o;e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),n=-1===this.cellId?(t=this._sourceLeft,i=this._sourceTop,r=this._sourceWidth||this._canvasWidth,this._sourceHeight||this._canvasHeight):(o=this._canvas_.width/this.cellWidth,s=this.cellId/o>>0,o=this.cellId%o,t=this.cellWidth*o,i=this.cellHeight*s,r=this.cellWidth,this.cellHeight),this._prepareWorkingCanvasForOpaqueDetection(),this._applyStates(e),this._loaded&&this._drawImage(e,t,i,r,n,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._keepSize?this._currentMeasure.width*n/r:this._currentMeasure.height),e.restore()}dispose(){super.dispose(),this.onImageLoadedObservable.clear(),this.onSVGAttributesComputedObservable.clear(),this.listener&&this.scene.onAfterRenderObservable.remove(this.listener)}}y([(0,n.serialize)()],zs.prototype,"detectPointerOnOpaqueOnly",null),y([(0,n.serialize)()],zs.prototype,"sourceLeft",null),y([(0,n.serialize)()],zs.prototype,"sourceTop",null),y([(0,n.serialize)()],zs.prototype,"sourceWidth",null),y([(0,n.serialize)()],zs.prototype,"sourceHeight",null),y([(0,n.serialize)()],zs.prototype,"autoScale",null),y([(0,n.serialize)()],zs.prototype,"keepSize",null),y([(0,n.serialize)()],zs.prototype,"cellWidth",null),y([(0,n.serialize)()],zs.prototype,"cellHeight",null),y([(0,n.serialize)()],zs.prototype,"cellId",null);var Gs,Vs,js,Ws=Object.freeze({__proto__:null,get CommandHistoryRecord(){return Rn}});class Hs{constructor(e){this.attachSystem=e}get AttachSystem(){return this.attachSystem}set AttachSystem(e){this.attachSystem=e}update(){}fromJSON(e){return this}toJSON(){return null}readFile(e){}writeFile(e){}}class Ks extends Hs{constructor(e,t){super(e),this.attachSystem=e,this._radius=1,this._radiusRange=1,null!=t&&t.radius&&(this._radius=t.radius),null!=t&&t.radiusRange&&(this._radiusRange=t.radiusRange),null!=e&&e.HasIntance&&this.setEmiter()}setEmiter(){}get AttachSystem(){return this.attachSystem}set AttachSystem(e){this.attachSystem=e,this.setEmiter()}get Radius(){return this._radius}set Radius(e){e!==this._radius&&(this._radius=e,this.update())}get RadiusRange(){return this._radiusRange}set RadiusRange(e){e!==this._radiusRange&&(this._radiusRange=e,this.update())}update(){this._emiter&&(this._emiter.radius=this._radius,this._emiter.radiusRange=this._radiusRange)}toJSON(){return{Radius:this.Radius,RadiusRange:this.RadiusRange}}fromJSON(e){return this._radius=e.Radius,this._radiusRange=e.RadiusRange,this}writeFile(e){super.writeFile(e),e.write(1),e.write(this._radius),e.write(this._radiusRange)}readFile(e){super.readFile(e),e.read(),this._radius=e.read(),this._radiusRange=e.read()}}let Xs=class extends Ks{constructor(e,t){super(e,t),null!=(this.attachSystem=e)&&e.HasIntance&&this.setEmiter()}setEmiter(){this._emiter=this.attachSystem.Intance.createSphereEmitter(this._radius,this._radiusRange)}},qs=(Xs.type="SphereEmiter",Xs=y([E],Xs),function(e){e[e.Point=0]="Point",e[e.Box=1]="Box",e[e.Sphere=2]="Sphere",e[e.Hemisphere=3]="Hemisphere",e[e.Cylinder=4]="Cylinder",e[e.DirctedCylinder=5]="DirctedCylinder",e[e.Cone=6]="Cone",e[e.Mesh=7]="Mesh",e[e.Custom=8]="Custom"}(Gs=Gs||{}),function(e){e[e.Point=0]="Point",e[e.Entity=1]="Entity",e[e.Camera=2]="Camera"}(Vs=Vs||{}),class extends bn{constructor(e){super(),this.particleSystem=e,this._name="\u5b50\u7c92\u5b50\u7279\u6548\u89e6\u53d1\u5668",this.type=n.SubEmitterType.END}get Intance(){return this._intance||(this._intance=this.initParticle()),this._intance}initParticle(){const e=this.particleSystem.Intance,t=(e.disposeOnStop=!0,new n.SubEmitter(e));return t.type=this.type,t}updateParticle(e){e.type=this.type,this.particleSystem.updateParticle(e.particleSystem)}destory(){super.destory(),this._intance&&(this._intance.dispose(),this._intance=null)}fromJSON(e){if(e)return e.type&&(this.type=e.type),this.particleSystem.fromJSON(e,!0),this}readFile(e){super.readFile(e),this.particleSystem=e.readObject()}writeFile(e){super.writeFile(e),e.writeObject(this.particleSystem)}}),Ys=(qs.type="SubEmitter",qs=y([E],qs),class extends Ks{constructor(e,t){super(e,t),null!=(this.attachSystem=e)&&e.HasIntance&&this.setEmiter()}setEmiter(){this._emiter=this.attachSystem.Intance.createHemisphericEmitter(this._radius,this._radiusRange)}}),Zs=(Ys.type="HemisphericEmiter",Ys=y([E],Ys),class extends Ks{constructor(e,t){super(e,t),this.attachSystem=e,this.height=1,null!=t&&t.height&&(this.height=t.height),null!=e&&e.HasIntance&&this.setEmiter()}setEmiter(){this._emiter=this.attachSystem.Intance.createCylinderEmitter(this._radius,this.height,this._radiusRange)}writeFile(e){super.writeFile(e),e.write(1),e.write(this.height)}readFile(e){super.readFile(e),e.read(),this.height=e.read()}}),Qs=(Zs.type="CylinderEmitter",Zs=y([E],Zs),class extends Hs{constructor(e,t){super(e),this.attachSystem=e,this._radius=1,this.angle=Math.PI/4,null!=t&&t.radius&&(this._radius=t.radius),null!=t&&t.angle&&(this.angle=t.angle),null!=e&&e.HasIntance&&this.setEmiter()}setEmiter(){this._emiter=this.attachSystem.Intance.createConeEmitter(this._radius,this.angle)}get AttachSystem(){return this.attachSystem}set AttachSystem(e){this.attachSystem=e,this.setEmiter()}get Radius(){return this._radius}set Radius(e){e!==this._radius&&(this._radius=e,this.update())}get Angle(){return this.angle}set Angle(e){e!==this.angle&&(this.angle=e,this.update())}update(){this._emiter&&(this._emiter.radius=this._radius,this._emiter.angle=this.angle)}toJSON(){return{Radius:this.Radius,Angle:this.Angle}}fromJSON(e){return e.Radius&&(this._radius=e.Radius),e.Angle&&(this.angle=e.Angle),this}writeFile(e){super.writeFile(e),e.write(1),e.write(this._radius),e.write(this.angle)}readFile(e){super.readFile(e),e.read(),this._radius=e.read(),this.angle=e.read()}}),Js=(Qs.type="ConeEmitter",Qs=y([E],Qs),class extends Zs{constructor(e,t){super(e,t),null!=(this.attachSystem=e)&&e.HasIntance&&this.setEmiter()}setEmiter(){this._emiter=this.attachSystem.Intance.createDirectedCylinderEmitter(this._radius,this.height,this._radiusRange,ne(this.attachSystem.Direction1),ne(this.attachSystem.Direction2))}}),$s=(Js.type="DirectedCylinder",Js=y([E],Js),js=class extends bn{constructor(e){super(),this.capacity=1e3,this._updateSpeed=.01,this._size={min:.1,max:.5},this._scale={min:{x:.1,y:.1},max:{x:.5,y:.5}},this.color1="#CD581BFF",this.color2="#000000FF",this.colorDead="#00000000",this._manualEmitCount=-1,this.emitPower={min:1,max:3},this._angularSpeed={min:0,max:Math.PI},this._pivot=new n.Vector2,this.direction1=new n.Vector3(0,1),this.direction2=new n.Vector3(0,1),this.minEmitBox=new n.Vector3(-.5,-.5,-.5),this.maxEmitBox=new n.Vector3(.5,.5,.5),this._gravity=new n.Vector3(0,0),this._rate=100,this.lifeTime={min:.3,max:1.5},this.spriteOption={isAnimationSheetEnabled:!1,spriteCellHeight:32,spriteCellWidth:32,spriteRandomStartCell:!0,startSpriteCellID:0,endSpriteCellID:3,spriteCellChangeSpeed:0},this.emiterShape=Gs.Box,this.emiterType=Vs.Point,this.emiterPosition=new n.Vector3,this.blendMode=n.ParticleSystem.BLENDMODE_ONEONE,this.subParticleSystems=[],this.needUpdateSubEmiters=!1,this.gradients=[],this._targetStopDuration=0,this._position=n.Vector3.Zero(),null!=e&&e.image&&(this._image=e.image),null!=e&&e.capacity&&(this.capacity=e.capacity),null!=e&&e.manualEmitCount&&(this._manualEmitCount=e.manualEmitCount)}get HasIntance(){return!!this._intance}get Intance(){return this._intance||(this._intance=this.initParticle(),this._intance)}get ManualEmitCount(){return this._manualEmitCount}set ManualEmitCount(e){e!==this._manualEmitCount&&(this._manualEmitCount=e,this.update())}get Capacity(){return this.capacity}set Capacity(e){this.capacity!==e&&(this.capacity=e,js.Reading||(this._intance&&(this._intance.dispose(),this._intance=null),this.Intance.start()))}get UpdateSpeed(){return this._updateSpeed}set UpdateSpeed(e){e!==this._updateSpeed&&(this._updateSpeed=e,this.update())}get Size(){return this._size}set Size(e){this._size=e,this.update()}get TextureUrl(){return this._image?this._image.startsWith("http")?this._image:fe.Texture_URL+this._image:""}get Image(){return this._image}set Image(e){e!==this._image&&(this._image=e,this.update())}get Scale(){return this._scale}set Scale(e){this.writeSnapshoot(),this._scale=e,this.update()}get Color1(){return this.color1}set Color1(e){this.color1=e,this.update()}get Color2(){return this.color2}set Color2(e){e!==this.color2&&(this.color2=e,this.update())}get ColorDead(){return this.colorDead}set ColorDead(e){e!==this.colorDead&&(this.colorDead=e,this.update())}get EmitPower(){return this.emitPower}set EmitPower(e){e!==this.emitPower&&(this.emitPower=e,this.update())}get AngularSpeed(){return this._angularSpeed}set AngularSpeed(e){this._angularSpeed=e,this.update()}get Pivot(){return function(e){return{x:e.x,y:e.y}}(this._pivot)}set Pivot(e){se(this._pivot,e),this.update()}get Direction1(){return ae(this.direction1)}set Direction1(e){se(this.direction1,e),this.update()}get Direction2(){return ae(this.direction2)}set Direction2(e){se(this.direction2,e),this.update()}get MinEmitBox(){return ae(this.minEmitBox)}set MinEmitBox(e){se(this.minEmitBox,e),this.update()}get MaxEmitBox(){return ae(this.maxEmitBox)}set MaxEmitBox(e){se(this.maxEmitBox,e),this.update()}get Gravity(){return ae(this._gravity)}set Gravity(e){se(this._gravity,e),this.update()}get EmiterPosition(){return ae(this.emiterPosition)}set EmiterPosition(e){se(this.emiterPosition,e),this.update()}get Rate(){return this._rate}set Rate(e){e!==this._rate&&(this._rate=e,this.update())}get LifeTime(){return this.lifeTime}set LifeTime(e){this.lifeTime=e,this.update()}get SpriteOption(){return this.spriteOption}set SpriteOption(e){this.spriteOption=e,this.update()}get EmiterType(){return this.emiterType}set EmiterType(e){e!==this.emiterType&&(this.emiterType=e,this.updateEmitType())}get EmiterShape(){return this.emiterShape}set EmiterShape(e){e!==this.emiterShape&&(this.emiterShape=e,this.updateEmitShape())}get EmiterEntity(){return this.emiterEntity}set EmiterEntity(e){this.emiterEntity=e,this.update()}get BlendMode(){return this.blendMode}set BlendMode(e){e!==this.blendMode&&(this.blendMode=e,this.update())}get SubParticleSystems(){return[...this.subParticleSystems]}set SubParticleSystems(e){this.subParticleSystems=e,this.needUpdateSubEmiters=!0,this.update()}get Emiter(){return this.emiter}get Gradients(){return[...this.gradients]}set Gradients(e){this.removeGradients(),this.gradients=e,this.updateGradient()}get TargetStopDuration(){return this._targetStopDuration}set TargetStopDuration(e){e!==this._targetStopDuration&&(this._targetStopDuration=e,this.update())}get Position(){return ae(this._position)}set Position(e){this.writeSnapshoot(),se(this._position,e),this.update()}appendGradient(e){this.gradients.push(e),this.updateGradient()}removeGradient(e){this.gradients[e]&&(e=this.gradients.splice(e,1),this.removeGradients(e))}initParticle(){const e=new n.ParticleSystem(this.UniupeName,this.capacity,_e.Scene);return e.particleTexture=new n.Texture(this.TextureUrl,_e.Scene),this.updateParticle(e),e}updateParticle(e){e.translationPivot=this._pivot;const t=e.particleTexture;t.url!==this.TextureUrl&&t.updateURL(this.TextureUrl),this.updateEmitType(e),e.blendMode=this.blendMode,e.minEmitBox=this.minEmitBox,e.maxEmitBox=this.maxEmitBox,this.color1&&(e.color1=n.Color4.FromHexString(this.color1)),this.color2&&(e.color2=n.Color4.FromHexString(this.color2)),this.colorDead&&(e.colorDead=n.Color4.FromHexString(this.colorDead)),e.minSize=this._size.min,e.maxSize=this._size.max,e.minLifeTime=this.lifeTime.min,e.maxLifeTime=this.lifeTime.max,e.targetStopDuration=this._targetStopDuration,e.emitRate=this._rate,e.gravity=this._gravity,e.direction1=this.direction1,e.direction2=this.direction2,this.spriteOption.isAnimationSheetEnabled?(e.isAnimationSheetEnabled=this.spriteOption.isAnimationSheetEnabled,e.spriteCellHeight=this.spriteOption.spriteCellHeight,e.spriteCellWidth=this.spriteOption.spriteCellWidth,e.spriteRandomStartCell=this.spriteOption.spriteRandomStartCell,e.startSpriteCellID=this.spriteOption.startSpriteCellID,e.endSpriteCellID=this.spriteOption.endSpriteCellID,e.spriteCellChangeSpeed=this.spriteOption.spriteCellChangeSpeed):e.isAnimationSheetEnabled=this.spriteOption.isAnimationSheetEnabled,e.minAngularSpeed=this._angularSpeed.min,e.maxAngularSpeed=this._angularSpeed.max,e.minEmitPower=this.emitPower.min,e.maxEmitPower=this.emitPower.max,e.updateSpeed=this._updateSpeed,e.manualEmitCount=this._manualEmitCount,this.needUpdateSubEmiters&&this.updateSubEmiters(e),this.updateGradient(e),e.worldOffset.copyFrom(this._position)}update(){js.Reading||this._intance&&this.updateParticle(this._intance)}start(){this._intance&&this._intance.start()}stop(){this._intance&&this._intance.stop()}destory(){if(super.destory(),this._intance){this._intance.dispose(),this._intance=null;for(const e of this.subParticleSystems)e.destory()}}fromJSON(e,t=!1){let i;t||(js.Reading=!0);for(const t in e){var r;t in this&&("SubParticleSystems"===t?(r=e.SubParticleSystems.map((e=>new qs(new js).fromJSON(e))),this.subParticleSystems=r,this.needUpdateSubEmiters=!0):"Emiter"===t?i=e[t]:this[t]=e[t])}return t||(js.Reading=!1),i&&this.emiter&&(this.emiter.fromJSON(i),setTimeout((()=>{this.emiter.AttachSystem=this}),0)),this}erase(e){super.erase(e),this._intance&&this._intance.stop(),he.trigger({type:"remove",target:this}),this.trigger({type:"remove",target:this})}toJSON(){return{capacity:this.capacity,updateSpeed:this._updateSpeed,size:Object.assign({},this._size),image:this._image,scale:this._scale,color1:this.color1,color2:this.color2,colorDead:this.colorDead}}clone(){const e=new js({image:this._image,capacity:this.capacity});var t=new D;return this.writeFile(t),e.readFile(t),this._id=null,e}writeFile(e){super.writeFile(e),e.write(2),e.write(this.capacity),e.write(this._manualEmitCount),e.write(this._updateSpeed),e.write(this._size.min),e.write(this._size.max),e.write(this._image),e.write(this._scale.min.x),e.write(this._scale.min.y),e.write(this._scale.max.x),e.write(this._scale.max.y),e.write(this.color1),e.write(this.color2),e.write(this.colorDead),e.write(this.emitPower.min),e.write(this.emitPower.max),e.write(this._angularSpeed.min),e.write(this._angularSpeed.max),e.write(this._pivot.x),e.write(this._pivot.y),e.writeArray(this.direction1.asArray()),e.writeArray(this.direction2.asArray()),e.writeArray(this.minEmitBox.asArray()),e.writeArray(this.maxEmitBox.asArray()),e.writeArray(this._gravity.asArray()),e.write(this._rate),e.write(this.lifeTime.min),e.write(this.lifeTime.max),e.write(this._targetStopDuration),e.write(this.spriteOption.isAnimationSheetEnabled),e.write(this.spriteOption.spriteCellHeight),e.write(this.spriteOption.spriteCellWidth),e.write(this.spriteOption.spriteRandomStartCell),e.write(this.spriteOption.startSpriteCellID),e.write(this.spriteOption.endSpriteCellID),e.write(this.spriteOption.spriteCellChangeSpeed),e.write(this.emiterShape),e.write(this.emiterType),e.writeArray(this.emiterPosition.asArray()),e.writeObjectId(this.emiterEntity),e.write(this.blendMode),e.writeAnyArray(this.subParticleSystems,e.writeObject),e.writeObject(this.emiter),e.writeAnyArray(this.gradients,(t=>{e.write(t.key),e.write(t.period),e.write(t.value),e.write(t.otherValue)})),e.writeVector3(this._position)}readFile(e){super.readFile(e);var t=e.read(),i=(this.capacity=e.read(),this._manualEmitCount=e.read(),this._updateSpeed=e.read(),this._size.min=e.read(),this._size.max=e.read(),this._image=e.read(),this._scale.min.x=e.read(),this._scale.min.y=e.read(),this._scale.max.x=e.read(),this._scale.max.y=e.read(),this.color1=e.read(),this.color2=e.read(),this.colorDead=e.read(),this.emitPower.min=e.read(),this.emitPower.max=e.read(),this._angularSpeed.min=e.read(),this._angularSpeed.max=e.read(),this._pivot.x=e.read(),this._pivot.y=e.read(),e.read()),r=e.readArray(i);this.direction1.fromArray(r),i=e.read(),r=e.readArray(i),this.direction2.fromArray(r),i=e.read(),r=e.readArray(i),this.minEmitBox.fromArray(r),i=e.read(),r=e.readArray(i),this.maxEmitBox.fromArray(r),i=e.read(),r=e.readArray(i),this._gravity.fromArray(r),this._rate=e.read(),this.lifeTime.min=e.read(),this.lifeTime.max=e.read(),this._targetStopDuration=e.read(),this.spriteOption.isAnimationSheetEnabled=e.read(),this.spriteOption.spriteCellHeight=e.read(),this.spriteOption.spriteCellWidth=e.read(),this.spriteOption.spriteRandomStartCell=e.read(),this.spriteOption.startSpriteCellID=e.read(),this.spriteOption.endSpriteCellID=e.read(),this.spriteOption.spriteCellChangeSpeed=e.read(),this.emiterShape=e.read(),this.emiterType=e.read(),i=e.read(),r=e.readArray(i),this.emiterPosition.fromArray(r),this.emiterEntity=e.readObjectId(),this.blendMode=e.read(),e.readAnyArrayAndPush(this.subParticleSystems,e.readObject),this.needUpdateSubEmiters=0<this.subParticleSystems.length,this.emiter=e.readObject(this.emiter),this.emiter&&!this.emiter.AttachSystem&&setTimeout((()=>{this.emiter.AttachSystem=this}),0),this.gradients.length=0,e.readAnyArray((()=>{const t={key:"Size",period:0,value:0,otherValue:0};t.key=e.read(),t.period=e.read(),t.value=e.read(),t.otherValue=e.read(),this.gradients.push(t)})),1<t&&e.readVector3(this._position),this.update()}updateSubEmiters(e=this._intance){e&&(e.subEmitters=[this.subParticleSystems.map((e=>e.Intance))],e.start(),this.needUpdateSubEmiters=!1)}updateEmitShape(e=this._intance){switch(this.emiter=null,this.emiterShape){case Gs.Point:e&&e.createPointEmitter(this.direction1,this.direction2);break;case Gs.Box:e&&e.createBoxEmitter(this.direction1,this.direction2,this.minEmitBox,this.maxEmitBox);break;case Gs.Sphere:this.emiter=new Xs(this);break;case Gs.Hemisphere:this.emiter=new Ys(this);break;case Gs.Cylinder:this.emiter=new Zs(this);break;case Gs.DirctedCylinder:this.emiter=new Js(this);break;case Gs.Cone:this.emiter=new Qs(this);case Gs.Mesh:case Gs.Custom:}}updateEmitType(e=this._intance){var t;if(e)switch(this.emiterType){case Vs.Point:e.emitter=this.emiterPosition;break;case Vs.Entity:null!=(t=this.emiterEntity)&&t.Object&&(e.emitter=this.emiterEntity.Object.RenderObject);break;case Vs.Camera:e.emitter=_e.Scene.activeCamera}}updateGradient(e=this._intance){if(e)for(const t of this.gradients)switch(t.key){case"Size":e.removeSizeGradient(t.period),e.addSizeGradient(t.period,t.value,t.otherValue);break;case"Color":e.removeColorGradient(t.period),e.addColorGradient(t.period,n.Color4.FromHexString(t.value),n.Color4.FromHexString(t.otherValue))}}removeGradients(e=this.gradients,t=this._intance){if(t)for(const i of e)switch(i.key){case"Size":t.removeSizeGradient(i.period);break;case"Color":t.removeColorGradient(i.period)}}}),eo=($s.type="ParticleSystem",$s.Reading=!1,$s=js=y([E],$s),class extends $s{constructor(){super(...arguments),this.capacity=1e4,this._pivot=new n.Vector2(0,10),this.minEmitBox=new n.Vector3(-100,50,-100),this.maxEmitBox=new n.Vector3(100,50,100),this.colorDead=new n.Color4(1,1,1,0).toHexString(),this._size={min:.1,max:2},this.lifeTime={min:1,max:10},this._rate=1e3,this._gravity=new n.Vector3(0,-9.81,-1),this.direction1=new n.Vector3(-.5,-1,0),this.direction2=new n.Vector3(5,-1,0),this.spriteOption={isAnimationSheetEnabled:!0,spriteCellHeight:32,spriteCellWidth:32,spriteRandomStartCell:!0,startSpriteCellID:0,endSpriteCellID:3,spriteCellChangeSpeed:0},this._angularSpeed={min:0,max:Math.PI/4},this.emitPower={min:.01,max:10},this.useCameraPosition=!0,this.blendMode=n.BaseParticleSystem.BLENDMODE_STANDARD}}),to=(eo.type="SnowParticleSystem",eo=y([E],eo),class extends $s{constructor(){super(...arguments),this.capacity=1e4,this._updateSpeed=.033,this._pivot=new n.Vector2(0,10),this.minEmitBox=new n.Vector3(-100,50,-100),this.maxEmitBox=new n.Vector3(100,50,100),this.colorDead=new n.Color4(1,1,1,0).toHexString(),this._size={min:.1,max:2},this.lifeTime={min:1,max:10},this._rate=1e3,this._gravity=new n.Vector3(0,-9.81,-1),this.direction1=new n.Vector3(0,-1,0),this.direction2=new n.Vector3(0,-1,0),this.spriteOption={isAnimationSheetEnabled:!0,spriteCellHeight:512,spriteCellWidth:128,spriteRandomStartCell:!0,startSpriteCellID:0,endSpriteCellID:3,spriteCellChangeSpeed:0},this._angularSpeed={min:0,max:0},this.emitPower={min:.01,max:10}}initParticle(){const e=super.initParticle();return e.emitter=_e.Scene.activeCamera,e}}),io=(to.type="RainParticleSystem",to=y([E],to),class extends bn{constructor(){super(...arguments),this._name="\u7c92\u5b50\u7ec4\u5408",this.systems=[]}get Intance(){return this._intance||(this._intance=this.initParticle(),this._intance)}initParticle(){const e=new n.ParticleSystemSet;for(const t of this.systems)e.systems.push(t.Intance);return e}updateParticle(e){for(let t=0;t<this.systems.length;t++)this.systems[t].updateParticle(e.systems[t])}start(){this.systems.forEach((e=>e.start()))}stop(){this.systems.forEach((e=>e.stop()))}destory(){this.systems.forEach((e=>e.destory()))}erase(e=!0){super.erase(e),this._intance&&this._intance.systems.forEach((e=>e.stop())),he.trigger({type:"remove",target:this}),this.trigger({type:"remove",target:this})}fromJSON(e){$s.Reading=!0;for(const t of e){const e=new $s;e.fromJSON(t,!0),this.systems.push(e)}return $s.Reading=!1,this}writeFile(e){super.writeFile(e),e.writeAnyArray(this.systems,e.writeObject)}readFile(e){super.readFile(e),e.readAnyArrayAndPush(this.systems,e.readObject)}}),ro=(io.type="ParticleSystemGroup",io=y([E],io),class extends Ur{constructor(){super(),this._isPickable=!0;const e=this;this.entitys=new Proxy([],{get:(e,t,i)=>Reflect.get(e,t,i),set:(t,i,r,n)=>(Reflect.get(t,i,n)!==r&&r instanceof F&&r.Object instanceof _e&&(e.Id&&(r.Object.GroupId=e.ObjectId)),Reflect.set(t,i,r,n))})}get IsPickable(){return this._isPickable}set IsPickable(e){e!==this._isPickable&&(this.writeSnapshoot(),this._isPickable=e)}readFile(e){e.read(),e.readAnyArrayAndPush(this.entitys,e.readObjectId)}writeFile(e){e.write(1),e.writeAnyArray(this.entitys,e.writeObjectId)}});ro=y([E],ro)}}]);