"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[3919],{8152:(t,e,i)=>{i.d(e,{S:()=>n});var r=i(1101),o=i(58095),s=i(72739),n=function(){function t(){this.direction1=new o.P(0,1,0),this.direction2=new o.P(0,1,0),this.minEmitBox=new o.P(-.5,-.5,-.5),this.maxEmitBox=new o.P(.5,.5,.5)}return t.prototype.startDirectionFunction=function(t,e,i,r){var n=s.R.RandomRange(this.direction1.x,this.direction2.x),a=s.R.RandomRange(this.direction1.y,this.direction2.y),h=s.R.RandomRange(this.direction1.z,this.direction2.z);if(r)return e.x=n,e.y=a,void(e.z=h);o.P.TransformNormalFromFloatsToRef(n,a,h,t,e)},t.prototype.startPositionFunction=function(t,e,i,r){var n=s.R.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),a=s.R.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),h=s.R.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(r)return e.x=n,e.y=a,void(e.z=h);o.P.TransformCoordinatesFromFloatsToRef(n,a,h,t,e)},t.prototype.clone=function(){var e=new t;return r.j.DeepCopy(this,e),e},t.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2),t.setVector3("minEmitBox",this.minEmitBox),t.setVector3("maxEmitBox",this.maxEmitBox)},t.prototype.buildUniformLayout=function(t){t.addUniform("direction1",3),t.addUniform("direction2",3),t.addUniform("minEmitBox",3),t.addUniform("maxEmitBox",3)},t.prototype.getEffectDefines=function(){return"#define BOXEMITTER"},t.prototype.getClassName=function(){return"BoxParticleEmitter"},t.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.minEmitBox=this.minEmitBox.asArray(),t.maxEmitBox=this.maxEmitBox.asArray(),t},t.prototype.parse=function(t){o.P.FromArrayToRef(t.direction1,0,this.direction1),o.P.FromArrayToRef(t.direction2,0,this.direction2),o.P.FromArrayToRef(t.minEmitBox,0,this.minEmitBox),o.P.FromArrayToRef(t.maxEmitBox,0,this.maxEmitBox)},t}()},97052:(t,e,i)=>{i.d(e,{E:()=>s});var r=i(1101),o=i(58095),s=function(){function t(){this.particlePositionGenerator=function(){},this.particleDestinationGenerator=function(){}}return t.prototype.startDirectionFunction=function(t,e,i,r){var s=o.jp.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,s);var n=o.jp.Vector3[1];s.subtractToRef(i.position,n),n.scaleToRef(1/i.lifeTime,s)}else s.set(0,0,0);r?e.copyFrom(s):o.P.TransformNormalToRef(s,t,e)},t.prototype.startPositionFunction=function(t,e,i,r){var s=o.jp.Vector3[0];this.particlePositionGenerator?this.particlePositionGenerator(-1,i,s):s.set(0,0,0),r?e.copyFrom(s):o.P.TransformCoordinatesToRef(s,t,e)},t.prototype.clone=function(){var e=new t;return r.j.DeepCopy(this,e),e},t.prototype.applyToShader=function(t){},t.prototype.buildUniformLayout=function(t){},t.prototype.getEffectDefines=function(){return"#define CUSTOMEMITTER"},t.prototype.getClassName=function(){return"CustomParticleEmitter"},t.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t},t.prototype.parse=function(t){},t}()},22016:(t,e,i)=>{i.d(e,{S3:()=>r.S,LV:()=>a,E0:()=>f.E,z:()=>c,kT:()=>l,VD:()=>d,F3:()=>g,cl:()=>u,cE:()=>m,Ai:()=>p});var r=i(8152),o=i(1101),s=i(58095),n=i(72739),a=function(){function t(t,e,i){void 0===t&&(t=1),void 0===e&&(e=Math.PI),void 0===i&&(i=0),this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=e,this.radius=t}return Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t,this._buildHeight()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"angle",{get:function(){return this._angle},set:function(t){this._angle=t,this._buildHeight()},enumerable:!1,configurable:!0}),t.prototype._buildHeight=function(){0!==this._angle?this._height=this._radius/Math.tan(this._angle/2):this._height=1},t.prototype.startDirectionFunction=function(t,e,i,r){r?s.jp.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(t.getTranslation(),s.jp.Vector3[0]).normalize();var o=n.R.RandomRange(0,this.directionRandomizer),a=n.R.RandomRange(0,this.directionRandomizer),h=n.R.RandomRange(0,this.directionRandomizer);e.x=s.jp.Vector3[0].x+o,e.y=s.jp.Vector3[0].y+a,e.z=s.jp.Vector3[0].z+h,e.normalize()},t.prototype.startPositionFunction=function(t,e,i,r){var o,a=n.R.RandomRange(0,2*Math.PI);o=this.emitFromSpawnPointOnly?1e-4:1-(o=n.R.RandomRange(0,this.heightRange))*o;var h=this._radius-n.R.RandomRange(0,this._radius*this.radiusRange),l=(h*=o)*Math.sin(a),c=h*Math.cos(a),d=o*this._height;if(r)return e.x=l,e.y=d,void(e.z=c);s.P.TransformCoordinatesFromFloatsToRef(l,d,c,t,e)},t.prototype.clone=function(){var e=new t(this._radius,this._angle,this.directionRandomizer);return o.j.DeepCopy(this,e),e},t.prototype.applyToShader=function(t){t.setFloat2("radius",this._radius,this.radiusRange),t.setFloat("coneAngle",this._angle),t.setFloat2("height",this._height,this.heightRange),t.setFloat("directionRandomizer",this.directionRandomizer)},t.prototype.buildUniformLayout=function(t){t.addUniform("radius",2),t.addUniform("coneAngle",1),t.addUniform("height",2),t.addUniform("directionRandomizer",1)},t.prototype.getEffectDefines=function(){var t="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(t+="\n#define CONEEMITTERSPAWNPOINT"),t},t.prototype.getClassName=function(){return"ConeParticleEmitter"},t.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this._radius,t.angle=this._angle,t.directionRandomizer=this.directionRandomizer,t.radiusRange=this.radiusRange,t.heightRange=this.heightRange,t.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,t},t.prototype.parse=function(t){this.radius=t.radius,this.angle=t.angle,this.directionRandomizer=t.directionRandomizer,this.radiusRange=void 0!==t.radiusRange?t.radiusRange:1,this.heightRange=void 0!==t.radiusRange?t.heightRange:1,this.emitFromSpawnPointOnly=void 0!==t.emitFromSpawnPointOnly&&t.emitFromSpawnPointOnly},t}(),h=i(31191),l=function(){function t(t,e,i,r){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=1),void 0===r&&(r=0),this.radius=t,this.height=e,this.radiusRange=i,this.directionRandomizer=r,this._tempVector=s.P.Zero()}return t.prototype.startDirectionFunction=function(t,e,i,r,o){i.position.subtractToRef(t.getTranslation(),this._tempVector),this._tempVector.normalize(),s.P.TransformNormalToRef(this._tempVector,o,this._tempVector);var a=n.R.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2),h=Math.atan2(this._tempVector.x,this._tempVector.z);h+=n.R.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=a,this._tempVector.x=Math.sin(h),this._tempVector.z=Math.cos(h),this._tempVector.normalize(),r?e.copyFrom(this._tempVector):s.P.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,t,e)},t.prototype.startPositionFunction=function(t,e,i,r){var o=n.R.RandomRange(-this.height/2,this.height/2),a=n.R.RandomRange(0,2*Math.PI),h=n.R.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(h)*this.radius,c=l*Math.cos(a),d=l*Math.sin(a);r?e.copyFromFloats(c,o,d):s.P.TransformCoordinatesFromFloatsToRef(c,o,d,t,e)},t.prototype.clone=function(){var e=new t(this.radius,this.directionRandomizer);return o.j.DeepCopy(this,e),e},t.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("height",this.height),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},t.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("height",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)},t.prototype.getEffectDefines=function(){return"#define CYLINDEREMITTER"},t.prototype.getClassName=function(){return"CylinderParticleEmitter"},t.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.height=this.height,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},t.prototype.parse=function(t){this.radius=t.radius,this.height=t.height,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},t}(),c=function(t){function e(e,i,r,o,n){void 0===e&&(e=1),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=new s.P(0,1,0)),void 0===n&&(n=new s.P(0,1,0));var a=t.call(this,e,i,r)||this;return a.direction1=o,a.direction2=n,a}return(0,h.ZT)(e,t),e.prototype.startDirectionFunction=function(t,e){var i=n.R.RandomRange(this.direction1.x,this.direction2.x),r=n.R.RandomRange(this.direction1.y,this.direction2.y),o=n.R.RandomRange(this.direction1.z,this.direction2.z);s.P.TransformNormalFromFloatsToRef(i,r,o,t,e)},e.prototype.clone=function(){var t=new e(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return o.j.DeepCopy(this,t),t},e.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("height",this.height),t.setFloat("radiusRange",this.radiusRange),t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},e.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("height",1),t.addUniform("radiusRange",1),t.addUniform("direction1",3),t.addUniform("direction2",3)},e.prototype.getEffectDefines=function(){return"#define CYLINDEREMITTER\n#define DIRECTEDCYLINDEREMITTER"},e.prototype.getClassName=function(){return"CylinderDirectedParticleEmitter"},e.prototype.serialize=function(){var e=t.prototype.serialize.call(this);return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e},e.prototype.parse=function(e){t.prototype.parse.call(this,e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)},e}(l),d=function(){function t(t,e,i){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=0),this.radius=t,this.radiusRange=e,this.directionRandomizer=i}return t.prototype.startDirectionFunction=function(t,e,i,r){var o=i.position.subtract(t.getTranslation()).normalize(),a=n.R.RandomRange(0,this.directionRandomizer),h=n.R.RandomRange(0,this.directionRandomizer),l=n.R.RandomRange(0,this.directionRandomizer);o.x+=a,o.y+=h,o.z+=l,o.normalize(),r?e.copyFrom(o):s.P.TransformNormalFromFloatsToRef(o.x,o.y,o.z,t,e)},t.prototype.startPositionFunction=function(t,e,i,r){var o=this.radius-n.R.RandomRange(0,this.radius*this.radiusRange),a=n.R.RandomRange(0,1),h=n.R.RandomRange(0,2*Math.PI),l=Math.acos(2*a-1),c=o*Math.cos(h)*Math.sin(l),d=o*Math.cos(l),u=o*Math.sin(h)*Math.sin(l);r?e.copyFromFloats(c,Math.abs(d),u):s.P.TransformCoordinatesFromFloatsToRef(c,Math.abs(d),u,t,e)},t.prototype.clone=function(){var e=new t(this.radius,this.directionRandomizer);return o.j.DeepCopy(this,e),e},t.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},t.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)},t.prototype.getEffectDefines=function(){return"#define HEMISPHERICEMITTER"},t.prototype.getClassName=function(){return"HemisphericParticleEmitter"},t.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},t.prototype.parse=function(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},t}(),u=function(){function t(){this.direction1=new s.P(0,1,0),this.direction2=new s.P(0,1,0)}return t.prototype.startDirectionFunction=function(t,e,i,r){var o=n.R.RandomRange(this.direction1.x,this.direction2.x),a=n.R.RandomRange(this.direction1.y,this.direction2.y),h=n.R.RandomRange(this.direction1.z,this.direction2.z);r?e.copyFromFloats(o,a,h):s.P.TransformNormalFromFloatsToRef(o,a,h,t,e)},t.prototype.startPositionFunction=function(t,e,i,r){r?e.copyFromFloats(0,0,0):s.P.TransformCoordinatesFromFloatsToRef(0,0,0,t,e)},t.prototype.clone=function(){var e=new t;return o.j.DeepCopy(this,e),e},t.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},t.prototype.buildUniformLayout=function(t){t.addUniform("direction1",3),t.addUniform("direction2",3)},t.prototype.getEffectDefines=function(){return"#define POINTEMITTER"},t.prototype.getClassName=function(){return"PointParticleEmitter"},t.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t},t.prototype.parse=function(t){s.P.FromArrayToRef(t.direction1,0,this.direction1),s.P.FromArrayToRef(t.direction2,0,this.direction2)},t}(),p=function(){function t(t,e,i){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=0),this.radius=t,this.radiusRange=e,this.directionRandomizer=i}return t.prototype.startDirectionFunction=function(t,e,i,r){var o=i.position.subtract(t.getTranslation()).normalize(),a=n.R.RandomRange(0,this.directionRandomizer),h=n.R.RandomRange(0,this.directionRandomizer),l=n.R.RandomRange(0,this.directionRandomizer);o.x+=a,o.y+=h,o.z+=l,o.normalize(),r?e.copyFrom(o):s.P.TransformNormalFromFloatsToRef(o.x,o.y,o.z,t,e)},t.prototype.startPositionFunction=function(t,e,i,r){var o=this.radius-n.R.RandomRange(0,this.radius*this.radiusRange),a=n.R.RandomRange(0,1),h=n.R.RandomRange(0,2*Math.PI),l=Math.acos(2*a-1),c=o*Math.cos(h)*Math.sin(l),d=o*Math.cos(l),u=o*Math.sin(h)*Math.sin(l);r?e.copyFromFloats(c,d,u):s.P.TransformCoordinatesFromFloatsToRef(c,d,u,t,e)},t.prototype.clone=function(){var e=new t(this.radius,this.directionRandomizer);return o.j.DeepCopy(this,e),e},t.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setFloat("directionRandomizer",this.directionRandomizer)},t.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("directionRandomizer",1)},t.prototype.getEffectDefines=function(){return"#define SPHEREEMITTER"},t.prototype.getClassName=function(){return"SphereParticleEmitter"},t.prototype.serialize=function(){var t={};return t.type=this.getClassName(),t.radius=this.radius,t.radiusRange=this.radiusRange,t.directionRandomizer=this.directionRandomizer,t},t.prototype.parse=function(t){this.radius=t.radius,this.radiusRange=t.radiusRange,this.directionRandomizer=t.directionRandomizer},t}(),m=function(t){function e(e,i,r){void 0===e&&(e=1),void 0===i&&(i=new s.P(0,1,0)),void 0===r&&(r=new s.P(0,1,0));var o=t.call(this,e)||this;return o.direction1=i,o.direction2=r,o}return(0,h.ZT)(e,t),e.prototype.startDirectionFunction=function(t,e){var i=n.R.RandomRange(this.direction1.x,this.direction2.x),r=n.R.RandomRange(this.direction1.y,this.direction2.y),o=n.R.RandomRange(this.direction1.z,this.direction2.z);s.P.TransformNormalFromFloatsToRef(i,r,o,t,e)},e.prototype.clone=function(){var t=new e(this.radius,this.direction1,this.direction2);return o.j.DeepCopy(this,t),t},e.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},e.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("direction1",3),t.addUniform("direction2",3)},e.prototype.getEffectDefines=function(){return"#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER"},e.prototype.getClassName=function(){return"SphereDirectedParticleEmitter"},e.prototype.serialize=function(){var e=t.prototype.serialize.call(this);return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e},e.prototype.parse=function(e){t.prototype.parse.call(this,e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)},e}(p),f=i(97052),_=i(72208),g=function(){function t(t){void 0===t&&(t=null),this._indices=null,this._positions=null,this._normals=null,this._storedNormal=s.P.Zero(),this._mesh=null,this.direction1=new s.P(0,1,0),this.direction2=new s.P(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=t}return Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh},set:function(t){this._mesh!==t&&(this._mesh=t,t?(this._indices=t.getIndices(),this._positions=t.getVerticesData(_.o.PositionKind),this._normals=t.getVerticesData(_.o.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))},enumerable:!1,configurable:!0}),t.prototype.startDirectionFunction=function(t,e,i,r){if(this.useMeshNormalsForDirection&&this._normals)s.P.TransformNormalToRef(this._storedNormal,t,e);else{var o=n.R.RandomRange(this.direction1.x,this.direction2.x),a=n.R.RandomRange(this.direction1.y,this.direction2.y),h=n.R.RandomRange(this.direction1.z,this.direction2.z);r?e.copyFromFloats(o,a,h):s.P.TransformNormalFromFloatsToRef(o,a,h,t,e)}},t.prototype.startPositionFunction=function(t,e,i,r){if(this._indices&&this._positions){var o=3*Math.random()*(this._indices.length/3)|0,n=Math.random(),a=Math.random()*(1-n),h=1-n-a,l=this._indices[o],c=this._indices[o+1],d=this._indices[o+2],u=s.jp.Vector3[0],p=s.jp.Vector3[1],m=s.jp.Vector3[2],f=s.jp.Vector3[3];s.P.FromArrayToRef(this._positions,3*l,u),s.P.FromArrayToRef(this._positions,3*c,p),s.P.FromArrayToRef(this._positions,3*d,m),f.x=n*u.x+a*p.x+h*m.x,f.y=n*u.y+a*p.y+h*m.y,f.z=n*u.z+a*p.z+h*m.z,r?e.copyFromFloats(f.x,f.y,f.z):s.P.TransformCoordinatesFromFloatsToRef(f.x,f.y,f.z,t,e),this.useMeshNormalsForDirection&&this._normals&&(s.P.FromArrayToRef(this._normals,3*l,u),s.P.FromArrayToRef(this._normals,3*c,p),s.P.FromArrayToRef(this._normals,3*d,m),this._storedNormal.x=n*u.x+a*p.x+h*m.x,this._storedNormal.y=n*u.y+a*p.y+h*m.y,this._storedNormal.z=n*u.z+a*p.z+h*m.z)}},t.prototype.clone=function(){var e=new t(this.mesh);return o.j.DeepCopy(this,e),e},t.prototype.applyToShader=function(t){t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},t.prototype.buildUniformLayout=function(t){t.addUniform("direction1",3),t.addUniform("direction2",3)},t.prototype.getEffectDefines=function(){return""},t.prototype.getClassName=function(){return"MeshParticleEmitter"},t.prototype.serialize=function(){var t,e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.meshId=null===(t=this.mesh)||void 0===t?void 0:t.id,e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e},t.prototype.parse=function(t,e){s.P.FromArrayToRef(t.direction1,0,this.direction1),s.P.FromArrayToRef(t.direction2,0,this.direction2),t.meshId&&e&&(this.mesh=e.getLastMeshById(t.meshId)),this.useMeshNormalsForDirection=t.useMeshNormalsForDirection},t}()},25846:(t,e,i)=>{i.d(e,{U:()=>a});var r=i(58095),o=i(90622),s=i(22016),n=i(15631),a=(i(89553),function(){function t(e){this.animations=[],this.renderingGroupId=0,this.emitter=r.P.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._rootUrl="",this.noiseStrength=new r.P(10,10,10),this.onAnimationEnd=null,this.blendMode=t.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new r.FM(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new r.P(0,0,0),this.gravity=r.P.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new n.HE(1,1,1,1),this.color2=new n.HE(1,1,1,1),this.colorDead=new n.HE(0,0,0,1),this.textureMask=new n.HE(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new o.b,this.id=e,this.name=e}return Object.defineProperty(t.prototype,"noiseTexture",{get:function(){return this._noiseTexture},set:function(t){this._noiseTexture!==t&&(this._noiseTexture=t,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isAnimationSheetEnabled",{get:function(){return this._isAnimationSheetEnabled},set:function(t){this._isAnimationSheetEnabled!=t&&(this._isAnimationSheetEnabled=t,this._reset())},enumerable:!1,configurable:!0}),t.prototype.getScene=function(){return this._scene},t.prototype._hasTargetStopDurationDependantGradient=function(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0},t.prototype.getDragGradients=function(){return this._dragGradients},t.prototype.getLimitVelocityGradients=function(){return this._limitVelocityGradients},t.prototype.getColorGradients=function(){return this._colorGradients},t.prototype.getSizeGradients=function(){return this._sizeGradients},t.prototype.getColorRemapGradients=function(){return this._colorRemapGradients},t.prototype.getAlphaRemapGradients=function(){return this._alphaRemapGradients},t.prototype.getLifeTimeGradients=function(){return this._lifeTimeGradients},t.prototype.getAngularSpeedGradients=function(){return this._angularSpeedGradients},t.prototype.getVelocityGradients=function(){return this._velocityGradients},t.prototype.getStartSizeGradients=function(){return this._startSizeGradients},t.prototype.getEmitRateGradients=function(){return this._emitRateGradients},Object.defineProperty(t.prototype,"direction1",{get:function(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:r.P.Zero()},set:function(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"direction2",{get:function(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:r.P.Zero()},set:function(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"minEmitBox",{get:function(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:r.P.Zero()},set:function(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"maxEmitBox",{get:function(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:r.P.Zero()},set:function(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"billboardMode",{get:function(){return this._billboardMode},set:function(t){this._billboardMode!==t&&(this._billboardMode=t,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isBillboardBased",{get:function(){return this._isBillboardBased},set:function(t){this._isBillboardBased!==t&&(this._isBillboardBased=t,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(t){this._attachImageProcessingConfiguration(t)},enumerable:!1,configurable:!0}),t.prototype._attachImageProcessingConfiguration=function(t){t!==this._imageProcessingConfiguration&&(!t&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=t)},t.prototype._reset=function(){},t.prototype._removeGradientAndTexture=function(t,e,i){if(!e)return this;for(var r=0,o=0,s=e;o<s.length;o++){if(s[o].gradient===t){e.splice(r,1);break}r++}return i&&i.dispose(),this},t.prototype.createPointEmitter=function(t,e){var i=new s.cl;return i.direction1=t,i.direction2=e,this.particleEmitterType=i,i},t.prototype.createHemisphericEmitter=function(t,e){void 0===t&&(t=1),void 0===e&&(e=1);var i=new s.VD(t,e);return this.particleEmitterType=i,i},t.prototype.createSphereEmitter=function(t,e){void 0===t&&(t=1),void 0===e&&(e=1);var i=new s.Ai(t,e);return this.particleEmitterType=i,i},t.prototype.createDirectedSphereEmitter=function(t,e,i){void 0===t&&(t=1),void 0===e&&(e=new r.P(0,1,0)),void 0===i&&(i=new r.P(0,1,0));var o=new s.cE(t,e,i);return this.particleEmitterType=o,o},t.prototype.createCylinderEmitter=function(t,e,i,r){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=1),void 0===r&&(r=0);var o=new s.kT(t,e,i,r);return this.particleEmitterType=o,o},t.prototype.createDirectedCylinderEmitter=function(t,e,i,o,n){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=1),void 0===o&&(o=new r.P(0,1,0)),void 0===n&&(n=new r.P(0,1,0));var a=new s.z(t,e,i,o,n);return this.particleEmitterType=a,a},t.prototype.createConeEmitter=function(t,e){void 0===t&&(t=1),void 0===e&&(e=Math.PI/4);var i=new s.LV(t,e);return this.particleEmitterType=i,i},t.prototype.createBoxEmitter=function(t,e,i,r){var o=new s.S3;return this.particleEmitterType=o,this.direction1=t,this.direction2=e,this.minEmitBox=i,this.maxEmitBox=r,o},t.BLENDMODE_ONEONE=0,t.BLENDMODE_STANDARD=1,t.BLENDMODE_ADD=2,t.BLENDMODE_MULTIPLY=3,t.BLENDMODE_MULTIPLYADD=4,t}())},80759:(t,e,i)=>{i.d(e,{U4:()=>r.U,S3:()=>o.S3,QV:()=>rt,fc:()=>p,LV:()=>o.LV,E0:()=>o.E0,z:()=>o.z,kT:()=>o.kT,jZ:()=>Z,hp:()=>B,VD:()=>o.VD,F3:()=>o.F3,sY:()=>Q,ZX:()=>E.h,n4:()=>O,pc:()=>b.p,D_:()=>w,Ic:()=>U,cl:()=>o.cl,B0:()=>ht,O5:()=>ot,eD:()=>Y,Jy:()=>et,s:()=>K,cE:()=>o.cE,Ai:()=>o.Ai,Hb:()=>lt.H,ll:()=>lt.l,dY:()=>l});var r=i(25846),o=i(22016),s=i(9256),n=i(97052),a=i(38649),h=i(48620),l=(i(19187),i(99763),function(){function t(t,e){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=t,this._engine=e,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}return t.prototype.isUpdateBufferCreated=function(){return!!this._updateEffect},t.prototype.isUpdateBufferReady=function(){var t,e;return null!==(e=null===(t=this._updateEffect)||void 0===t?void 0:t.isReady())&&void 0!==e&&e},t.prototype.createUpdateBuffer=function(t){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof n.E&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=t,this._updateEffect=new s.Q("gpuUpdateParticles",this._updateEffectOptions,this._engine),new a.c(this._updateEffect)},t.prototype.createVertexBuffers=function(t,e){this._updateVAO.push(this._createUpdateVAO(t)),this._renderVAO.push(this._engine.recordVertexArrayObject(e,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null)},t.prototype.createParticleBuffer=function(t){return t},t.prototype.bindDrawBuffers=function(t){this._engine.bindVertexArrayObject(this._renderVAO[t],null)},t.prototype.preUpdateParticleBuffer=function(){var t=this._engine;if(this._engine.enableEffect(this._updateEffect),!t.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")},t.prototype.updateParticleBuffer=function(t,e,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[t],null);var r=this._engine;r.bindTransformFeedbackBuffer(e.getBuffer()),r.setRasterizerState(!1),r.beginTransformFeedback(!0),r.drawArraysType(3,0,i),r.endTransformFeedback(),r.setRasterizerState(!0),r.bindTransformFeedbackBuffer(null)},t.prototype.releaseBuffers=function(){},t.prototype.releaseVertexBuffers=function(){for(var t=0;t<this._updateVAO.length;t++)this._engine.releaseVertexArrayObject(this._updateVAO[t]);this._updateVAO=[];for(t=0;t<this._renderVAO.length;t++)this._engine.releaseVertexArrayObject(this._renderVAO[t]);this._renderVAO=[]},t.prototype._createUpdateVAO=function(t){var e={};e.position=t.createVertexBuffer("position",0,3);var i=3;e.age=t.createVertexBuffer("age",i,1),i+=1,e.size=t.createVertexBuffer("size",i,3),i+=3,e.life=t.createVertexBuffer("life",i,1),i+=1,e.seed=t.createVertexBuffer("seed",i,4),i+=4,e.direction=t.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof n.E&&(e.initialPosition=t.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(e.color=t.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(e.initialDirection=t.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(e.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",i,3),i+=3,e.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(e.angle=t.createVertexBuffer("angle",i,1),i+=1):(e.angle=t.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(e.cellIndex=t.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(e.cellStartOffset=t.createVertexBuffer("cellStartOffset",i,1),i+=1));var r=this._engine.recordVertexArrayObject(e,null,this._updateEffect);return this._engine.bindArrayBuffer(null),r},t}());(0,h.H)("BABYLON.WebGL2ParticleSystem",l);var c=i(93752),d=i(73821),u=i(83353),p=(i(84577),function(){function t(t,e){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=t,this._engine=e}return t.prototype.isUpdateBufferCreated=function(){return!!this._updateComputeShader},t.prototype.isUpdateBufferReady=function(){var t,e;return null!==(e=null===(t=this._updateComputeShader)||void 0===t?void 0:t.isReady())&&void 0!==e&&e},t.prototype.createUpdateBuffer=function(t){var e,i={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(i.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(i.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(i.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(i.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(i.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(i.noiseTexture={group:1,binding:11}),this._updateComputeShader=new d.U("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:i,defines:t.split("\n")}),null===(e=this._simParamsComputeShader)||void 0===e||e.dispose(),this._simParamsComputeShader=new u.M(this._engine),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new a.c(this._simParamsComputeShader)},t.prototype.createVertexBuffers=function(t,e){this._renderVertexBuffers.push(e)},t.prototype.createParticleBuffer=function(t){var e=new c.N(this._engine,4*t.length,11);return e.update(t),this._bufferComputeShader.push(e),e.getBuffer()},t.prototype.bindDrawBuffers=function(t,e){this._engine.bindBuffers(this._renderVertexBuffers[t],null,e)},t.prototype.preUpdateParticleBuffer=function(){},t.prototype.updateParticleBuffer=function(t,e,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[t]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[1^t]),this._updateComputeShader.dispatch(Math.ceil(i/64))},t.prototype.releaseBuffers=function(){for(var t,e=0;e<this._bufferComputeShader.length;++e)this._bufferComputeShader[e].dispose();this._bufferComputeShader=[],null===(t=this._simParamsComputeShader)||void 0===t||t.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null},t.prototype.releaseVertexBuffers=function(){this._renderVertexBuffers=[]},t}());(0,h.H)("BABYLON.ComputeShaderParticleSystem",p);var m=i(31191),f=i(4359),_=i(62897),g=i(58095),y=i(15631),v=i(72739),x=i(72208),b=i(22672),S=i(8152),P=i(90360),R=i(90622),T=i(15034),A=i(15210),C=i(61159),G=i(67759),B=(i(18011),i(51067),function(t){function e(e,i,r,o,s){void 0===o&&(o=null),void 0===s&&(s=!1);var n=t.call(this,e)||this;if(n.layerMask=268435455,n._accumulatedCount=0,n._targetIndex=0,n._currentRenderId=-1,n._currentRenderingCameraUniqueId=-1,n._started=!1,n._stopped=!1,n._timeDelta=0,n._actualFrame=0,n._rawTextureWidth=256,n.onDisposeObservable=new _.y$,n.onStoppedObservable=new _.y$,n.forceDepthWrite=!1,n._preWarmDone=!1,n.isLocal=!1,n._onBeforeDrawParticlesObservable=null,r&&"Scene"!==r.getClassName()?(n._engine=r,n.defaultProjectionMatrix=g.y3.PerspectiveFovLH(.8,1,.1,100,n._engine.isNDCHalfZRange)):(n._scene=r||A.l.LastCreatedScene,n._engine=n._scene.getEngine(),n.uniqueId=n._scene.getUniqueId(),n._scene.particleSystems.push(n)),n._engine.getCaps().supportComputeShaders){if(!(0,h.q)("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");n._platform=new((0,h.q)("BABYLON.ComputeShaderParticleSystem"))(n,n._engine)}else{if(!(0,h.q)("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");n._platform=new((0,h.q)("BABYLON.WebGL2ParticleSystem"))(n,n._engine)}n._customWrappers={0:new G.q(n._engine)},n._customWrappers[0].effect=o,n._drawWrappers={0:new G.q(n._engine)},n._drawWrappers[0].drawContext&&(n._drawWrappers[0].drawContext.useInstancing=!0),n._attachImageProcessingConfiguration(null),(i=null!=i?i:{}).randomTextureSize||delete i.randomTextureSize;var a=(0,m.pi)({capacity:5e4,randomTextureSize:n._engine.getCaps().maxTextureSize},i),l=i;isFinite(l)&&(a.capacity=l),n._capacity=a.capacity,n._activeCount=a.capacity,n._currentActiveCount=0,n._isAnimationSheetEnabled=s,n.particleEmitterType=new S.S;for(var c=Math.min(n._engine.getCaps().maxTextureSize,a.randomTextureSize),d=[],u=0;u<c;++u)d.push(Math.random()),d.push(Math.random()),d.push(Math.random()),d.push(Math.random());n._randomTexture=new T.l(new Float32Array(d),c,1,5,r,!1,!1,1,1),n._randomTexture.name="GPUParticleSystem_random1",n._randomTexture.wrapU=1,n._randomTexture.wrapV=1,d=[];for(u=0;u<c;++u)d.push(Math.random()),d.push(Math.random()),d.push(Math.random()),d.push(Math.random());return n._randomTexture2=new T.l(new Float32Array(d),c,1,5,r,!1,!1,1,1),n._randomTexture2.name="GPUParticleSystem_random2",n._randomTexture2.wrapU=1,n._randomTexture2.wrapV=1,n._randomTextureSize=c,n}return(0,m.ZT)(e,t),Object.defineProperty(e,"IsSupported",{get:function(){if(!A.l.LastCreatedEngine)return!1;var t=A.l.LastCreatedEngine.getCaps();return t.supportTransformFeedbacks||t.supportComputeShaders},enumerable:!1,configurable:!0}),e.prototype.getCapacity=function(){return this._capacity},Object.defineProperty(e.prototype,"activeParticleCount",{get:function(){return this._activeCount},set:function(t){this._activeCount=Math.min(t,this._capacity)},enumerable:!1,configurable:!0}),e.prototype.isReady=function(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==b.p.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else{if(!this._getWrapper(b.p.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this._getWrapper(b.p.BLENDMODE_ADD).effect.isReady())return!1}return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)},e.prototype.isStarted=function(){return this._started},e.prototype.isStopped=function(){return this._stopped},e.prototype.isStopping=function(){return!1},e.prototype.getActiveCount=function(){return this._currentActiveCount},e.prototype.start=function(t){var e=this;if(void 0===t&&(t=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";t?setTimeout((function(){e.start(0)}),t):(this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop))},e.prototype.stop=function(){this._stopped||(this._stopped=!0)},e.prototype.reset=function(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0},e.prototype.getClassName=function(){return"GPUParticleSystem"},e.prototype.getCustomEffect=function(t){var e,i;return void 0===t&&(t=0),null!==(i=null===(e=this._customWrappers[t])||void 0===e?void 0:e.effect)&&void 0!==i?i:this._customWrappers[0].effect},e.prototype._getCustomDrawWrapper=function(t){var e;return void 0===t&&(t=0),null!==(e=this._customWrappers[t])&&void 0!==e?e:this._customWrappers[0]},e.prototype.setCustomEffect=function(t,e){void 0===e&&(e=0),this._customWrappers[e]=new G.q(this._engine),this._customWrappers[e].effect=t},Object.defineProperty(e.prototype,"onBeforeDrawParticlesObservable",{get:function(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new _.y$),this._onBeforeDrawParticlesObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vertexShaderName",{get:function(){return"gpuRenderParticles"},enumerable:!1,configurable:!0}),e.prototype._removeGradientAndTexture=function(e,i,r){return t.prototype._removeGradientAndTexture.call(this,e,i,r),this._releaseBuffers(),this},e.prototype.addColorGradient=function(t,e){this._colorGradients||(this._colorGradients=[]);var i=new f.bK(t,e);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this},e.prototype._refreshColorGradient=function(t){void 0===t&&(t=!1),this._colorGradients&&(t&&this._colorGradients.sort((function(t,e){return t.gradient<e.gradient?-1:t.gradient>e.gradient?1:0})),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))},e.prototype.forceRefreshGradients=function(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()},e.prototype.removeColorGradient=function(t){return this._removeGradientAndTexture(t,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this},e.prototype.resetDrawCache=function(){var t;for(var e in this._drawWrappers){null===(t=this._drawWrappers[e].drawContext)||void 0===t||t.reset()}},e.prototype._addFactorGradient=function(t,e,i){var r=new f.b3(e,i);t.push(r),this._releaseBuffers()},e.prototype.addSizeGradient=function(t,e){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,t,e),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this},e.prototype.removeSizeGradient=function(t){return this._removeGradientAndTexture(t,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this},e.prototype._refreshFactorGradient=function(t,e,i){if(void 0===i&&(i=!1),t){i&&t.sort((function(t,e){return t.gradient<e.gradient?-1:t.gradient>e.gradient?1:0}));var r=this;r[e]&&(r[e].dispose(),r[e]=null)}},e.prototype.addAngularSpeedGradient=function(t,e){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,t,e),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this},e.prototype.removeAngularSpeedGradient=function(t){return this._removeGradientAndTexture(t,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this},e.prototype.addVelocityGradient=function(t,e){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,t,e),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this},e.prototype.removeVelocityGradient=function(t){return this._removeGradientAndTexture(t,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this},e.prototype.addLimitVelocityGradient=function(t,e){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,t,e),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this},e.prototype.removeLimitVelocityGradient=function(t){return this._removeGradientAndTexture(t,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this},e.prototype.addDragGradient=function(t,e){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,t,e),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this},e.prototype.removeDragGradient=function(t){return this._removeGradientAndTexture(t,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this},e.prototype.addEmitRateGradient=function(){return this},e.prototype.removeEmitRateGradient=function(){return this},e.prototype.addStartSizeGradient=function(){return this},e.prototype.removeStartSizeGradient=function(){return this},e.prototype.addColorRemapGradient=function(){return this},e.prototype.removeColorRemapGradient=function(){return this},e.prototype.addAlphaRemapGradient=function(){return this},e.prototype.removeAlphaRemapGradient=function(){return this},e.prototype.addRampGradient=function(){return this},e.prototype.removeRampGradient=function(){return this},e.prototype.getRampGradients=function(){return null},Object.defineProperty(e.prototype,"useRampGradients",{get:function(){return!1},set:function(t){},enumerable:!1,configurable:!0}),e.prototype.addLifeTimeGradient=function(){return this},e.prototype.removeLifeTimeGradient=function(){return this},e.prototype._reset=function(){this._releaseBuffers()},e.prototype._createVertexBuffers=function(t,e,i){var r={};r.position=e.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);var o=3;r.age=e.createVertexBuffer("age",o,1,this._attributesStrideSize,!0),o+=1,r.size=e.createVertexBuffer("size",o,3,this._attributesStrideSize,!0),o+=3,r.life=e.createVertexBuffer("life",o,1,this._attributesStrideSize,!0),o+=1,o+=4,this.billboardMode===b.p.BILLBOARDMODE_STRETCHED&&(r.direction=e.createVertexBuffer("direction",o,3,this._attributesStrideSize,!0)),o+=3,this._platform.alignDataInBuffer&&(o+=1),this.particleEmitterType instanceof n.E&&(o+=3,this._platform.alignDataInBuffer&&(o+=1)),this._colorGradientsTexture||(r.color=e.createVertexBuffer("color",o,4,this._attributesStrideSize,!0),o+=4),this._isBillboardBased||(r.initialDirection=e.createVertexBuffer("initialDirection",o,3,this._attributesStrideSize,!0),o+=3,this._platform.alignDataInBuffer&&(o+=1)),this.noiseTexture&&(r.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",o,3,this._attributesStrideSize,!0),o+=3,this._platform.alignDataInBuffer&&(o+=1),r.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",o,3,this._attributesStrideSize,!0),o+=3,this._platform.alignDataInBuffer&&(o+=1)),r.angle=e.createVertexBuffer("angle",o,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?o++:o+=2,this._isAnimationSheetEnabled&&(r.cellIndex=e.createVertexBuffer("cellIndex",o,1,this._attributesStrideSize,!0),o+=1,this.spriteRandomStartCell&&(r.cellStartOffset=e.createVertexBuffer("cellStartOffset",o,1,this._attributesStrideSize,!0),o+=1)),r.offset=i.createVertexBuffer("offset",0,2),r.uv=i.createVertexBuffer("uv",2,2),this._platform.createVertexBuffers(t,r),this.resetDrawCache()},e.prototype._initialize=function(t){if(void 0===t&&(t=!1),!this._buffer0||t){var e=this._engine,i=new Array;this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof n.E&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));for(var r=this.particleEmitterType instanceof n.E,o=g.jp.Vector3[0],s=0,a=0;a<this._capacity;a++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),r?(this.particleEmitterType.particleDestinationGenerator(a,null,o),i.push(o.x),i.push(o.y),i.push(o.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),s+=16,r&&(this.particleEmitterType.particlePositionGenerator(a,null,o),i.push(o.x),i.push(o.y),i.push(o.z),this._platform.alignDataInBuffer&&i.push(0),s+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),s+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),s+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),s+=8),i.push(0),s+=1,this._angularSpeedGradientsTexture||(i.push(0),s+=1),this._isAnimationSheetEnabled&&(i.push(0),s+=1,this.spriteRandomStartCell&&(i.push(0),s+=1)),this._platform.alignDataInBuffer){var h=3-(s+3&3);for(s+=h;h-- >0;)i.push(0)}var l=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),c=this._platform.createParticleBuffer(i),d=this._platform.createParticleBuffer(i);this._buffer0=new x.l(e,c,!1,this._attributesStrideSize),this._buffer1=new x.l(e,d,!1,this._attributesStrideSize),this._spriteBuffer=new x.l(e,l,!1,4),this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}},e.prototype._recreateUpdateEffect=function(){var t=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";this._isBillboardBased&&(t+="\n#define BILLBOARD"),this._colorGradientsTexture&&(t+="\n#define COLORGRADIENTS"),this._sizeGradientsTexture&&(t+="\n#define SIZEGRADIENTS"),this._angularSpeedGradientsTexture&&(t+="\n#define ANGULARSPEEDGRADIENTS"),this._velocityGradientsTexture&&(t+="\n#define VELOCITYGRADIENTS"),this._limitVelocityGradientsTexture&&(t+="\n#define LIMITVELOCITYGRADIENTS"),this._dragGradientsTexture&&(t+="\n#define DRAGGRADIENTS"),this.isAnimationSheetEnabled&&(t+="\n#define ANIMATESHEET",this.spriteRandomStartCell&&(t+="\n#define ANIMATESHEETRANDOMSTART")),this.noiseTexture&&(t+="\n#define NOISE"),this.isLocal&&(t+="\n#define LOCAL"),this._platform.isUpdateBufferCreated()&&this._cachedUpdateDefines===t||(this._cachedUpdateDefines=t,this._updateBuffer=this._platform.createUpdateBuffer(t))},e.prototype._getWrapper=function(t){var e=this._getCustomDrawWrapper(t);if(null==e?void 0:e.effect)return e;var i=[];this.fillDefines(i,t);var r=this._drawWrappers[t];r||((r=new G.q(this._engine)).drawContext&&(r.drawContext.useInstancing=!0),this._drawWrappers[t]=r);var o=i.join("\n");if(r.defines!==o){var s=[],n=[],a=[];this.fillUniformsAttributesAndSamplerNames(n,s,a),r.setEffect(this._engine.createEffect("gpuRenderParticles",s,n,a,o),o)}return r},e._GetAttributeNamesOrOptions=function(t,e,i,r){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===i&&(i=!1),void 0===r&&(r=!1);var o=[x.o.PositionKind,"age","life","size","angle"];return t||o.push(x.o.ColorKind),e&&o.push("cellIndex"),i||o.push("initialDirection"),r||o.push("direction"),o.push("offset",x.o.UVKind),o},e._GetEffectCreationOptions=function(t){void 0===t&&(t=!1);var e=["emitterWM","worldOffset","view","projection","colorDead","invView","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","translationPivot","eyePosition"];return t&&e.push("sheetInfos"),e},e.prototype.fillDefines=function(t,e){if(void 0===e&&(e=0),this._scene&&(this._scene.clipPlane&&t.push("#define CLIPPLANE"),this._scene.clipPlane2&&t.push("#define CLIPPLANE2"),this._scene.clipPlane3&&t.push("#define CLIPPLANE3"),this._scene.clipPlane4&&t.push("#define CLIPPLANE4"),this._scene.clipPlane5&&t.push("#define CLIPPLANE5"),this._scene.clipPlane6&&t.push("#define CLIPPLANE6")),e===b.p.BLENDMODE_MULTIPLY&&t.push("#define BLENDMULTIPLYMODE"),this.isLocal&&t.push("#define LOCAL"),this._isBillboardBased)switch(t.push("#define BILLBOARD"),this.billboardMode){case b.p.BILLBOARDMODE_Y:t.push("#define BILLBOARDY");break;case b.p.BILLBOARDMODE_STRETCHED:t.push("#define BILLBOARDSTRETCHED");break;case b.p.BILLBOARDMODE_ALL:t.push("#define BILLBOARDMODE_ALL")}this._colorGradientsTexture&&t.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&t.push("#define ANIMATESHEET"),this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),t.push(""+this._imageProcessingConfigurationDefines.toString()))},e.prototype.fillUniformsAttributesAndSamplerNames=function(t,i,r){i.push.apply(i,e._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===b.p.BILLBOARDMODE_STRETCHED)),t.push.apply(t,e._GetEffectCreationOptions(this._isAnimationSheetEnabled)),r.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(R.$.PrepareUniforms(t,this._imageProcessingConfigurationDefines),R.$.PrepareSamplers(r,this._imageProcessingConfigurationDefines))},e.prototype.animate=function(t){var e;void 0===t&&(t=!1),this._timeDelta=this.updateSpeed*(t?this.preWarmStepOffset:(null===(e=this._scene)||void 0===e?void 0:e.getAnimationRatio())||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()},e.prototype._createFactorGradientTexture=function(t,e){var i=this[e];if(t&&t.length&&!i){for(var r=new Float32Array(this._rawTextureWidth),o=function(e){var i=e/s._rawTextureWidth;f.fR.GetCurrentGradient(i,t,(function(t,i,o){r[e]=v.R.Lerp(t.factor1,i.factor1,o)}))},s=this,n=0;n<this._rawTextureWidth;n++)o(n);this[e]=T.l.CreateRTexture(r,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1)}},e.prototype._createSizeGradientTexture=function(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")},e.prototype._createAngularSpeedGradientTexture=function(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")},e.prototype._createVelocityGradientTexture=function(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")},e.prototype._createLimitVelocityGradientTexture=function(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")},e.prototype._createDragGradientTexture=function(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")},e.prototype._createColorGradientTexture=function(){if(this._colorGradients&&this._colorGradients.length&&!this._colorGradientsTexture){for(var t=new Uint8Array(4*this._rawTextureWidth),e=y.zZ.Color4[0],i=function(i){var o=i/r._rawTextureWidth;f.fR.GetCurrentGradient(o,r._colorGradients,(function(r,o,s){y.HE.LerpToRef(r.color1,o.color1,s,e),t[4*i]=255*e.r,t[4*i+1]=255*e.g,t[4*i+2]=255*e.b,t[4*i+3]=255*e.a}))},r=this,o=0;o<this._rawTextureWidth;o++)i(o);this._colorGradientsTexture=T.l.CreateRGBATexture(t,this._rawTextureWidth,1,this._scene,!1,!1,1)}},e.prototype._render=function(t,e){var i,r,o=this._getWrapper(t),s=o.effect;this._engine.enableEffect(o);var n=(null===(i=this._scene)||void 0===i?void 0:i.getViewMatrix())||g.y3.IdentityReadOnly;if(s.setMatrix("view",n),s.setMatrix("projection",null!==(r=this.defaultProjectionMatrix)&&void 0!==r?r:this._scene.getProjectionMatrix()),s.setTexture("diffuseSampler",this.particleTexture),s.setVector2("translationPivot",this.translationPivot),s.setVector3("worldOffset",this.worldOffset),this.isLocal&&s.setMatrix("emitterWM",e),this._colorGradientsTexture?s.setTexture("colorGradientSampler",this._colorGradientsTexture):s.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){var a=this.particleTexture.getBaseSize();s.setFloat3("sheetInfos",this.spriteCellWidth/a.width,this.spriteCellHeight/a.height,a.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){var h=this._scene.activeCamera;s.setVector3("eyePosition",h.globalPosition)}var l=s.defines;if(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&P.G.BindClipPlane(s,this._scene),l.indexOf("#define BILLBOARDMODE_ALL")>=0){var c=n.clone();c.invert(),s.setMatrix("invView",c)}switch(this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(s),t){case b.p.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case b.p.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case b.p.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case b.p.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4)}return this._platform.bindDrawBuffers(this._targetIndex,s),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(s),this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._currentActiveCount},e.prototype.render=function(t,e){if(void 0===t&&(t=!1),void 0===e&&(e=!1),!this._started)return 0;if(this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture(),this._recreateUpdateEffect(),!this.isReady())return 0;if(!t&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(var i=0;i<this.preWarmCycles;i++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getFrameId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getFrameId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){var r=0|this._accumulatedCount;this._accumulatedCount-=r,this._currentActiveCount=Math.min(this._activeCount,this._currentActiveCount+r)}if(!this._currentActiveCount)return 0;var o;if(this.emitter.position){o=this.emitter.getWorldMatrix()}else{var s=this.emitter;o=g.y3.Translation(s.x,s.y,s.z)}var n=this._engine;this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",o),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount);var a=0;t||e||(n.setState(!1),this.forceDepthWrite&&n.setDepthWrite(!0),a=this.blendMode===b.p.BLENDMODE_MULTIPLYADD?this._render(b.p.BLENDMODE_MULTIPLY,o)+this._render(b.p.BLENDMODE_ADD,o):this._render(this.blendMode,o),this._engine.setAlphaMode(0)),this._targetIndex++,2===this._targetIndex&&(this._targetIndex=0);var h=this._sourceBuffer;return this._sourceBuffer=this._targetBuffer,this._targetBuffer=h,a},e.prototype.rebuild=function(){this._initialize(!0)},e.prototype._releaseBuffers=function(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()},e.prototype.dispose=function(t){for(var e in void 0===t&&(t=!0),this._drawWrappers){this._drawWrappers[e].dispose()}if(this._drawWrappers={},this._scene){var i=this._scene.particleSystems.indexOf(this);i>-1&&this._scene.particleSystems.splice(i,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),t&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),t&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},e.prototype.clone=function(t,i){var r=(0,m.pi)({},this._customWrappers),o=null,s=this._engine;if(s.createEffectForParticles&&null!=this.customShader){var n=(o=this.customShader).shaderOptions.defines.length>0?o.shaderOptions.defines.join("\n"):"";r[0]=s.createEffectForParticles(o.shaderPath.fragmentElement,o.shaderOptions.uniforms,o.shaderOptions.samplers,n,void 0,void 0,void 0,this)}var a=this.serialize(),h=e.Parse(a,this._scene||this._engine,this._rootUrl);return h.name=t,h.customShader=o,h._customWrappers=r,void 0===i&&(i=this.emitter),this.noiseTexture&&(h.noiseTexture=this.noiseTexture.clone()),h.emitter=i,h},e.prototype.serialize=function(t){void 0===t&&(t=!1);var e={};return b.p._Serialize(e,this,t),e.activeParticleCount=this.activeParticleCount,e.randomTextureSize=this._randomTextureSize,e.customShader=this.customShader,e},e.Parse=function(t,i,r,o,s){void 0===o&&(o=!1);var n,a=t.name;n=i instanceof C.B?i:i.getEngine();var h=new e(a,{capacity:s||t.capacity,randomTextureSize:t.randomTextureSize},i,null,t.isAnimationSheetEnabled);if(h._rootUrl=r,t.customShader&&n.createEffectForParticles){var l=t.customShader,c=l.shaderOptions.defines.length>0?l.shaderOptions.defines.join("\n"):"",d=n.createEffectForParticles(l.shaderPath.fragmentElement,l.shaderOptions.uniforms,l.shaderOptions.samplers,c,void 0,void 0,void 0,h);h.setCustomEffect(d,0),h.customShader=l}return t.id&&(h.id=t.id),t.activeParticleCount&&(h.activeParticleCount=t.activeParticleCount),b.p._Parse(t,h,i,r),t.preventAutoStart&&(h.preventAutoStart=t.preventAutoStart),o||h.preventAutoStart||h.start(),h},e}(r.U)),E=i(74290),D=i(13514),M=i(73803),I=i(48087),V=i(3085),w=function(){function t(){this._emitterNodeIsOwned=!0,this.systems=new Array}return Object.defineProperty(t.prototype,"emitterNode",{get:function(){return this._emitterNode},set:function(t){this._emitterNodeIsOwned&&this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!1);for(var e=0,i=this.systems;e<i.length;e++){i[e].emitter=t}this._emitterNode=t},enumerable:!1,configurable:!0}),t.prototype.setEmitterAsSphere=function(t,e,i){this._emitterNodeIsOwned&&this._emitterNode&&this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!0,this._emitterCreationOptions={kind:"Sphere",options:t,renderingGroupId:e};var r=(0,I.Qk)("emitterSphere",{diameter:t.diameter,segments:t.segments},i);r.renderingGroupId=e;var o=new V.K("emitterSphereMaterial",i);o.emissiveColor=t.color,r.material=o;for(var s=0,n=this.systems;s<n.length;s++){n[s].emitter=r}this._emitterNode=r},t.prototype.start=function(t){for(var e=0,i=this.systems;e<i.length;e++){var r=i[e];t&&(r.emitter=t),r.start()}},t.prototype.dispose=function(){for(var t=0,e=this.systems;t<e.length;t++){e[t].dispose()}this.systems=[],this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNode=null)},t.prototype.serialize=function(t){void 0===t&&(t=!1);for(var e={systems:[]},i=0,r=this.systems;i<r.length;i++){var o=r[i];e.systems.push(o.serialize(t))}return this._emitterNode&&(e.emitter=this._emitterCreationOptions),e},t.Parse=function(e,i,r,o){void 0===r&&(r=!1);var s=new t,n=this.BaseAssetsUrl+"/textures/";i=i||A.l.LastCreatedScene;for(var a=0,h=e.systems;a<h.length;a++){var l=h[a];s.systems.push(r?B.Parse(l,i,n,!0,o):b.p.Parse(l,i,n,!0,o))}if(e.emitter){var c=e.emitter.options;if("Sphere"===e.emitter.kind)s.setEmitterAsSphere({diameter:c.diameter,segments:c.segments,color:y.Wo.FromArray(c.color)},e.emitter.renderingGroupId,i)}return s},t.BaseAssetsUrl="https://assets.babylonjs.com/particles",t}(),z=i(51912),O=function(){function t(){}return t.CreateDefault=function(t,e,i,r){var o;return void 0===e&&(e=500),void 0===r&&(r=!1),(o=r?new B("default system",{capacity:e},i):new b.p("default system",e,i)).emitter=t,o.particleTexture=new M.x("https://assets.babylonjs.com/textures/flare.png",o.getScene()),o.createConeEmitter(.1,Math.PI/4),o.color1=new y.HE(1,1,1,1),o.color2=new y.HE(1,1,1,1),o.colorDead=new y.HE(1,1,1,0),o.minSize=.1,o.maxSize=.1,o.minEmitPower=2,o.maxEmitPower=2,o.updateSpeed=1/60,o.emitRate=30,o},t.CreateAsync=function(e,i,r,o){void 0===r&&(r=!1),i||(i=A.l.LastCreatedScene);var s={};return i._addPendingData(s),new Promise((function(n,a){if(r&&!B.IsSupported)return i._removePendingData(s),a("Particle system with GPU is not supported.");D.w1.LoadFile("".concat(t.BaseAssetsUrl,"/systems/").concat(e,".json"),(function(t){i._removePendingData(s);var e=JSON.parse(t.toString());return n(w.Parse(e,i,r,o))}),void 0,void 0,void 0,(function(){return i._removePendingData(s),a("An error occurred with the creation of your particle system. Check if your type '".concat(e,"' exists."))}))}))},t.ExportSet=function(t){for(var e=new w,i=0,r=t;i<r.length;i++){var o=r[i];e.systems.push(o)}return e},t.ParseFromFileAsync=function(t,e,i,r,o,s){return void 0===r&&(r=!1),void 0===o&&(o=""),new Promise((function(n,a){var h=new z.g;h.addEventListener("readystatechange",(function(){if(4==h.readyState)if(200==h.status){var e=JSON.parse(h.responseText),l=void 0;l=r?B.Parse(e,i,o,!1,s):b.p.Parse(e,i,o,!1,s),t&&(l.name=t),n(l)}else a("Unable to load the particle system")})),h.open("GET",e),h.send()}))},t.CreateFromSnippetAsync=function(t,e,i,r,o){var s=this;if(void 0===i&&(i=!1),void 0===r&&(r=""),"_BLANK"===t){var n=this.CreateDefault(null);return n.start(),Promise.resolve(n)}return new Promise((function(n,a){var h=new z.g;h.addEventListener("readystatechange",(function(){if(4==h.readyState)if(200==h.status){var s=JSON.parse(JSON.parse(h.responseText).jsonPayload),l=JSON.parse(s.particleSystem),c=void 0;(c=i?B.Parse(l,e,r,!1,o):b.p.Parse(l,e,r,!1,o)).snippetId=t,n(c)}else a("Unable to load the snippet "+t)})),h.open("GET",s.SnippetUrl+"/"+t.replace(/#/g,"/")),h.send()}))},t.BaseAssetsUrl=w.BaseAssetsUrl,t.SnippetUrl="https://snippet.babylonjs.com",t}(),F=i(91243),L=i(57755),j=i(37290),N=i(85627);i(24007);L.p.AddParser(N.l.NAME_PARTICLESYSTEM,(function(t,e,i,r){var o=L.p.GetIndividualParser(N.l.NAME_PARTICLESYSTEM);if(o&&void 0!==t.particleSystems&&null!==t.particleSystems)for(var s=0,n=t.particleSystems.length;s<n;s++){var a=t.particleSystems[s];i.particleSystems.push(o(a,e,r))}})),L.p.AddIndividualParser(N.l.NAME_PARTICLESYSTEM,(function(t,e,i){return t.activeParticleCount?B.Parse(t,e,i):b.p.Parse(t,e,i)})),j.D.prototype.createEffectForParticles=function(t,e,i,r,o,s,n,a){var h;void 0===e&&(e=[]),void 0===i&&(i=[]),void 0===r&&(r="");var l=[],c=[],d=[];return a?a.fillUniformsAttributesAndSamplerNames(c,l,d):(l=b.p._GetAttributeNamesOrOptions(),c=b.p._GetEffectCreationOptions()),-1===r.indexOf(" BILLBOARD")&&(r+="\n#define BILLBOARD\n"),-1===i.indexOf("diffuseSampler")&&i.push("diffuseSampler"),this.createEffect({vertex:null!==(h=null==a?void 0:a.vertexShaderName)&&void 0!==h?h:"particles",fragmentElement:t},l,c.concat(e),d.concat(i),r,o,s,n)},F.Kj.prototype.getEmittedParticleSystems=function(){for(var t=new Array,e=0;e<this.getScene().particleSystems.length;e++){var i=this.getScene().particleSystems[e];i.emitter===this&&t.push(i)}return t},F.Kj.prototype.getHierarchyEmittedParticleSystems=function(){var t=new Array,e=this.getDescendants();e.push(this);for(var i=0;i<this.getScene().particleSystems.length;i++){var r=this.getScene().particleSystems[i],o=r.emitter;o.position&&-1!==e.indexOf(o)&&t.push(r)}return t};var U,W=i(91859),k=i(14750),H=i(71419),Y=function(){function t(t,e,i,r,o,s,n,a,h,l){void 0===h&&(h=null),void 0===l&&(l=null),this.idx=0,this.id=0,this.color=new y.HE(1,1,1,1),this.position=g.P.Zero(),this.rotation=g.P.Zero(),this.scaling=g.P.One(),this.uvs=new g.Lt(0,0,1,1),this.velocity=g.P.Zero(),this.pivot=g.P.Zero(),this.translateFromPivot=!1,this.alive=!0,this.isVisible=!0,this._pos=0,this._ind=0,this.shapeId=0,this.idxInShape=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this.materialIndex=null,this.props=null,this.cullingStrategy=H.x.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this._globalPosition=g.P.Zero(),this.idx=t,this.id=e,this._pos=i,this._ind=r,this._model=o,this.shapeId=s,this.idxInShape=n,this._sps=a,h&&(this._modelBoundingInfo=h,this._boundingInfo=new W.j(h.minimum,h.maximum)),null!==l&&(this.materialIndex=l)}return t.prototype.getBoundingInfo=function(){return this._boundingInfo},Object.defineProperty(t.prototype,"hasBoundingInfo",{get:function(){return null!==this._boundingInfo},enumerable:!1,configurable:!0}),t.prototype.copyToRef=function(t){return t.position.copyFrom(this.position),t.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(t.rotationQuaternion?t.rotationQuaternion.copyFrom(this.rotationQuaternion):t.rotationQuaternion=this.rotationQuaternion.clone()),t.scaling.copyFrom(this.scaling),this.color&&(t.color?t.color.copyFrom(this.color):t.color=this.color.clone()),t.uvs.copyFrom(this.uvs),t.velocity.copyFrom(this.velocity),t.pivot.copyFrom(this.pivot),t.translateFromPivot=this.translateFromPivot,t.alive=this.alive,t.isVisible=this.isVisible,t.parentId=this.parentId,t.cullingStrategy=this.cullingStrategy,null!==this.materialIndex&&(t.materialIndex=this.materialIndex),this},Object.defineProperty(t.prototype,"scale",{get:function(){return this.scaling},set:function(t){this.scaling=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(t){this.rotationQuaternion=t},enumerable:!1,configurable:!0}),t.prototype.intersectsMesh=function(t){return!(!this._boundingInfo||!t.hasBoundingInfo)&&(this._sps._bSphereOnly?k.K.Intersects(this._boundingInfo.boundingSphere,t.getBoundingInfo().boundingSphere):this._boundingInfo.intersects(t.getBoundingInfo(),!1))},t.prototype.isInFrustum=function(t){return null!==this._boundingInfo&&this._boundingInfo.isInFrustum(t,this.cullingStrategy)},t.prototype.getRotationMatrix=function(t){var e;if(this.rotationQuaternion)e=this.rotationQuaternion;else{e=g.jp.Quaternion[0];var i=this.rotation;g._f.RotationYawPitchRollToRef(i.y,i.x,i.z,e)}e.toRotationMatrix(t)},t}(),Q=function(){function t(t,e,i,r,o,s,n,a,h){this._indicesLength=0,this.shapeId=t,this._shape=e,this._indices=i,this._indicesLength=i.length,this._shapeUV=s,this._shapeColors=o,this._normals=r,this._positionFunction=n,this._vertexFunction=a,this._material=h}return Object.defineProperty(t.prototype,"shapeID",{get:function(){return this.shapeId},set:function(t){this.shapeId=t},enumerable:!1,configurable:!0}),t}(),Z=function(t,e,i,r){this.idx=0,this.ind=0,this.indicesLength=0,this.sqDistance=0,this.materialIndex=0,this.idx=t,this.ind=e,this.indicesLength=i,this.materialIndex=r},K=function(){function t(){this.position=g.P.Zero(),this.color=new y.HE(1,1,1,1),this.uv=g.FM.Zero()}return Object.defineProperty(t.prototype,"x",{get:function(){return this.position.x},set:function(t){this.position.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.position.y},set:function(t){this.position.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this.position.z},set:function(t){this.position.z=t},enumerable:!1,configurable:!0}),t}(),q=i(89209),X=i(42620),J=i(43048),$=i(68345),tt=i(91855),et=function(){function t(t,e,i){this.particles=new Array,this.nbParticles=0,this.billboard=!1,this.recomputeNormals=!1,this.counter=0,this.vars={},this._bSphereOnly=!1,this._bSphereRadiusFactor=1,this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._index=0,this._updatable=!0,this._pickable=!1,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._depthSort=!1,this._expandable=!1,this._shapeCounter=0,this._copy=new Y(0,0,0,0,null,0,0,this),this._color=new y.HE(0,0,0,0),this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeParticleVertex=!1,this._computeBoundingBox=!1,this._depthSortParticles=!0,this._mustUnrotateFixedNormals=!1,this._particlesIntersect=!1,this._needs32Bits=!1,this._isNotBuilt=!0,this._lastParticleId=0,this._idxOfId=[],this._multimaterialEnabled=!1,this._useModelMaterial=!1,this._depthSortFunction=function(t,e){return e.sqDistance-t.sqDistance},this._materialSortFunction=function(t,e){return t.materialIndex-e.materialIndex},this._autoUpdateSubMeshes=!1,this.name=t,this._scene=e||A.l.LastCreatedScene,this._camera=e.activeCamera,this._pickable=!!i&&i.isPickable,this._depthSort=!!i&&i.enableDepthSort,this._multimaterialEnabled=!!i&&i.enableMultiMaterial,this._useModelMaterial=!!i&&i.useModelMaterial,this._multimaterialEnabled=!!this._useModelMaterial||this._multimaterialEnabled,this._expandable=!!i&&i.expandable,this._particlesIntersect=!!i&&i.particleIntersection,this._bSphereOnly=!!i&&i.boundingSphereOnly,this._bSphereRadiusFactor=i&&i.bSphereRadiusFactor?i.bSphereRadiusFactor:1,i&&void 0!==i.updatable?this._updatable=i.updatable:this._updatable=!0,this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]),(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]),this._multimaterialEnabled&&(this._multimaterial=new tt.G(this.name+"MultiMaterial",this._scene),this._materials=[],this._materialIndexesById={}),this._tmpVertex=new K}return t.prototype.buildMesh=function(){if(!this._isNotBuilt&&this.mesh)return this.mesh;if(0===this.nbParticles&&!this.mesh){var t=(0,X.u)("",{radius:1,tessellation:3},this._scene);this.addShape(t,1),t.dispose()}if(this._indices32=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),!this.mesh){var e=new F.Kj(this.name,this._scene);this.mesh=e}!this._updatable&&this._multimaterialEnabled&&this._sortParticlesByMaterial(),this.recomputeNormals&&q.x.ComputeNormals(this._positions32,this._indices32,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals),this._mustUnrotateFixedNormals&&this._unrotateFixedNormals();var i=new q.x;if(i.indices=this._depthSort?this._indices:this._indices32,i.set(this._positions32,x.o.PositionKind),i.set(this._normals32,x.o.NormalKind),this._uvs32.length>0&&i.set(this._uvs32,x.o.UVKind),this._colors32.length>0&&i.set(this._colors32,x.o.ColorKind),i.applyToMesh(this.mesh,this._updatable),this.mesh.isPickable=this._pickable,this._pickable)for(var r=0,o=0;o<this.nbParticles;o++)for(var s=this.particles[o],n=s._model._indicesLength,a=0;a<n;a++){if(0==a%3){var h={idx:s.idx,faceId:r};this.pickedParticles[r]=h,r++}}return this._multimaterialEnabled&&this.setMultiMaterial(this._materials),this._expandable||(this._depthSort||this._multimaterialEnabled||(this._indices=null),this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0)),this._isNotBuilt=!1,this.recomputeNormals=!1,this.mesh},t.prototype.digest=function(t,e){var i=e&&e.facetNb||1,r=e&&e.number||0,o=e&&e.delta||0,s=t.getVerticesData(x.o.PositionKind),n=t.getIndices(),a=t.getVerticesData(x.o.UVKind),h=t.getVerticesData(x.o.ColorKind),l=t.getVerticesData(x.o.NormalKind),c=e&&e.storage?e.storage:null,d=0,u=n.length/3;r?(r=r>u?u:r,i=Math.round(u/r),o=0):i=i>u?u:i;for(var p=[],m=[],f=[],_=[],y=[],v=g.P.Zero(),b=i;d<u;){d>u-(i=b+Math.floor((1+o)*Math.random()))&&(i=u-d),p.length=0,m.length=0,f.length=0,_.length=0,y.length=0;for(var S=0,P=3*d;P<3*(d+i);P++){f.push(S);var R=n[P],T=3*R;if(p.push(s[T],s[T+1],s[T+2]),m.push(l[T],l[T+1],l[T+2]),a){var A=2*R;_.push(a[A],a[A+1])}if(h){var C=4*R;y.push(h[C],h[C+1],h[C+2],h[C+3])}S++}var G=this.nbParticles,B=this._posToShape(p),E=this._uvsToShapeUV(_),D=f.slice(),M=y.slice(),I=m.slice();v.copyFromFloats(0,0,0);var V=void 0;for(V=0;V<B.length;V++)v.addInPlace(B[V]);v.scaleInPlace(1/B.length);var w=new g.P(1/0,1/0,1/0),z=new g.P(-1/0,-1/0,-1/0);for(V=0;V<B.length;V++)B[V].subtractInPlace(v),w.minimizeInPlaceFromFloats(B[V].x,B[V].y,B[V].z),z.maximizeInPlaceFromFloats(B[V].x,B[V].y,B[V].z);var O=void 0;this._particlesIntersect&&(O=new W.j(w,z));var F=null;this._useModelMaterial&&(F=t.material?t.material:this._setDefaultMaterial());var L=new Q(this._shapeCounter,B,D,I,M,E,null,null,F),j=this._positions.length,N=this._indices.length;this._meshBuilder(this._index,N,B,this._positions,D,this._indices,_,this._uvs,M,this._colors,I,this._normals,G,0,null,L),this._addParticle(G,this._lastParticleId,j,N,L,this._shapeCounter,0,O,c),this.particles[this.nbParticles].position.addInPlace(v),c||(this._index+=B.length,G++,this.nbParticles++,this._lastParticleId++),this._shapeCounter++,d+=i}return this._isNotBuilt=!0,this},t.prototype._unrotateFixedNormals=function(){for(var t=0,e=0,i=g.jp.Vector3[0],r=g.jp.Quaternion[0],o=g.jp.Matrix[0],s=0;s<this.particles.length;s++){var n=this.particles[s],a=n._model._shape;if(n.rotationQuaternion)n.rotationQuaternion.conjugateToRef(r);else{var h=n.rotation;g._f.RotationYawPitchRollToRef(h.y,h.x,h.z,r),r.conjugateInPlace()}r.toRotationMatrix(o);for(var l=0;l<a.length;l++)e=t+3*l,g.P.TransformNormalFromFloatsToRef(this._normals32[e],this._normals32[e+1],this._normals32[e+2],o,i),i.toArray(this._fixedNormal32,e);t=e+3}},t.prototype._resetCopy=function(){var t=this._copy;t.position.setAll(0),t.rotation.setAll(0),t.rotationQuaternion=null,t.scaling.setAll(1),t.uvs.copyFromFloats(0,0,1,1),t.color=null,t.translateFromPivot=!1,t.shapeId=0,t.materialIndex=null},t.prototype._meshBuilder=function(t,e,i,r,o,s,n,a,h,l,c,d,u,p,m,f){var _,y=0,v=0,x=0;this._resetCopy();var b=this._copy,S=!(!m||!m.storage);if(b.idx=u,b.idxInShape=p,b.shapeId=f.shapeId,this._useModelMaterial){var P=f._material.uniqueId,R=this._materialIndexesById;Object.prototype.hasOwnProperty.call(R,P)||(R[P]=this._materials.length,this._materials.push(f._material));var T=R[P];b.materialIndex=T}if(m&&m.positionFunction&&(m.positionFunction(b,u,p),this._mustUnrotateFixedNormals=!0),S)return b;var A=g.jp.Matrix[0],C=this._tmpVertex,G=C.position,B=C.color,E=C.uv,D=g.jp.Vector3[1],M=g.jp.Vector3[2],I=g.jp.Vector3[3];g.y3.IdentityToRef(A),b.getRotationMatrix(A),b.pivot.multiplyToRef(b.scaling,I),b.translateFromPivot?M.setAll(0):M.copyFrom(I);var V=m&&m.vertexFunction;for(_=0;_<i.length;_++){if(G.copyFrom(i[_]),b.color&&B.copyFrom(b.color),n&&E.copyFromFloats(n[y],n[y+1]),V&&m.vertexFunction(b,C,_),G.multiplyInPlace(b.scaling).subtractInPlace(I),g.P.TransformCoordinatesToRef(G,A,D),D.addInPlace(M).addInPlace(b.position),r.push(D.x,D.y,D.z),n){var w=b.uvs;a.push((w.z-w.x)*E.x+w.x,(w.w-w.y)*E.y+w.y),y+=2}if(b.color)this._color.copyFrom(B);else{var z=this._color;h&&void 0!==h[v]?(z.r=h[v],z.g=h[v+1],z.b=h[v+2],z.a=h[v+3]):(z.r=1,z.g=1,z.b=1,z.a=1)}l.push(this._color.r,this._color.g,this._color.b,this._color.a),v+=4,!this.recomputeNormals&&c&&(g.P.TransformNormalFromFloatsToRef(c[x],c[x+1],c[x+2],A,G),d.push(G.x,G.y,G.z),x+=3)}for(_=0;_<o.length;_++){var O=t+o[_];s.push(O),O>65535&&(this._needs32Bits=!0)}if(this._depthSort||this._multimaterialEnabled){var F=null!==b.materialIndex?b.materialIndex:0;this.depthSortedParticles.push(new Z(u,e,o.length,F))}return b},t.prototype._posToShape=function(t){for(var e=[],i=0;i<t.length;i+=3)e.push(g.P.FromArray(t,i));return e},t.prototype._uvsToShapeUV=function(t){var e=[];if(t)for(var i=0;i<t.length;i++)e.push(t[i]);return e},t.prototype._addParticle=function(t,e,i,r,o,s,n,a,h){void 0===a&&(a=null),void 0===h&&(h=null);var l=new Y(t,e,i,r,o,s,n,this,a);return(h||this.particles).push(l),l},t.prototype.addShape=function(t,e,i){var r=t.getVerticesData(x.o.PositionKind),o=t.getIndices(),s=t.getVerticesData(x.o.UVKind),n=t.getVerticesData(x.o.ColorKind),a=t.getVerticesData(x.o.NormalKind);this.recomputeNormals=!a;var h=Array.from(o),l=Array.from(a),c=n?Array.from(n):[],d=i&&i.storage?i.storage:null,u=null;this._particlesIntersect&&(u=t.getBoundingInfo());var p=this._posToShape(r),m=this._uvsToShapeUV(s),f=i?i.positionFunction:null,_=i?i.vertexFunction:null,g=null;this._useModelMaterial&&(g=t.material?t.material:this._setDefaultMaterial());for(var y=new Q(this._shapeCounter,p,h,l,c,m,f,_,g),v=0;v<e;v++)this._insertNewParticle(this.nbParticles,v,y,p,o,s,n,a,u,d,i);return this._shapeCounter++,this._isNotBuilt=!0,this._shapeCounter-1},t.prototype._rebuildParticle=function(t,e){void 0===e&&(e=!1),this._resetCopy();var i=this._copy;t._model._positionFunction&&t._model._positionFunction(i,t.idx,t.idxInShape);var r=g.jp.Matrix[0],o=g.jp.Vector3[0],s=g.jp.Vector3[1],n=g.jp.Vector3[2],a=g.jp.Vector3[3];i.getRotationMatrix(r),t.pivot.multiplyToRef(t.scaling,a),i.translateFromPivot?n.copyFromFloats(0,0,0):n.copyFrom(a);for(var h=t._model._shape,l=0;l<h.length;l++)o.copyFrom(h[l]),t._model._vertexFunction&&t._model._vertexFunction(i,o,l),o.multiplyInPlace(i.scaling).subtractInPlace(a),g.P.TransformCoordinatesToRef(o,r,s),s.addInPlace(n).addInPlace(i.position).toArray(this._positions32,t._pos+3*l);e&&(t.position.setAll(0),t.rotation.setAll(0),t.rotationQuaternion=null,t.scaling.setAll(1),t.uvs.setAll(0),t.pivot.setAll(0),t.translateFromPivot=!1,t.parentId=null)},t.prototype.rebuildMesh=function(t){void 0===t&&(t=!1);for(var e=0;e<this.particles.length;e++)this._rebuildParticle(this.particles[e],t);return this.mesh.updateVerticesData(x.o.PositionKind,this._positions32,!1,!1),this},t.prototype.removeParticles=function(t,e){var i=e-t+1;if(!this._expandable||i<=0||i>=this.nbParticles||!this._updatable)return[];var r=this.particles,o=this.nbParticles;if(e<o-1)for(var s=e+1,n=r[s]._pos-r[t]._pos,a=r[s]._ind-r[t]._ind,h=s;h<o;h++){var l=r[h];l._pos-=n,l._ind-=a}var c=r.splice(t,i);this._positions.length=0,this._indices.length=0,this._colors.length=0,this._uvs.length=0,this._normals.length=0,this._index=0,this._idxOfId.length=0,(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]);for(var d=0,u=r.length,p=0;p<u;p++){var m=r[p],f=m._model,_=f._shape,g=f._indices,y=f._normals,v=f._shapeColors,x=f._shapeUV;m.idx=p,this._idxOfId[m.id]=p,this._meshBuilder(this._index,d,_,this._positions,g,this._indices,x,this._uvs,v,this._colors,y,this._normals,m.idx,m.idxInShape,null,f),this._index+=_.length,d+=g.length}return this.nbParticles-=i,this._isNotBuilt=!0,c},t.prototype.insertParticlesFromArray=function(t){if(!this._expandable)return this;for(var e=0,i=t[0].shapeId,r=t.length,o=0;o<r;o++){var s=t[o],n=s._model,a=n._shape,h=n._indices,l=n._shapeUV,c=n._shapeColors,d=n._normals,u=!d;this.recomputeNormals=u||this.recomputeNormals;var p=s.getBoundingInfo(),m=this._insertNewParticle(this.nbParticles,e,n,a,h,l,c,d,p,null,null);s.copyToRef(m),e++,i!=s.shapeId&&(i=s.shapeId,e=0)}return this._isNotBuilt=!0,this},t.prototype._insertNewParticle=function(t,e,i,r,o,s,n,a,h,l,c){var d=this._positions.length,u=this._indices.length,p=this._meshBuilder(this._index,u,r,this._positions,o,this._indices,s,this._uvs,n,this._colors,a,this._normals,t,e,c,i),m=null;return this._updatable&&((m=this._addParticle(this.nbParticles,this._lastParticleId,d,u,i,this._shapeCounter,e,h,l)).position.copyFrom(p.position),m.rotation.copyFrom(p.rotation),p.rotationQuaternion&&(m.rotationQuaternion?m.rotationQuaternion.copyFrom(p.rotationQuaternion):m.rotationQuaternion=p.rotationQuaternion.clone()),p.color&&(m.color?m.color.copyFrom(p.color):m.color=p.color.clone()),m.scaling.copyFrom(p.scaling),m.uvs.copyFrom(p.uvs),null!==p.materialIndex&&(m.materialIndex=p.materialIndex),this.expandable&&(this._idxOfId[m.id]=m.idx)),l||(this._index+=r.length,this.nbParticles++,this._lastParticleId++),m},t.prototype.setParticles=function(t,e,i){if(void 0===t&&(t=0),void 0===e&&(e=this.nbParticles-1),void 0===i&&(i=!0),!this._updatable||this._isNotBuilt)return this;this.beforeUpdateParticles(t,e,i);var r=g.jp.Matrix[0],o=g.jp.Matrix[1],s=this.mesh,n=this._colors32,a=this._positions32,h=this._normals32,l=this._uvs32,c=this._indices32,d=this._indices,u=this._fixedNormal32,p=g.jp.Vector3,m=p[5].copyFromFloats(1,0,0),f=p[6].copyFromFloats(0,1,0),_=p[7].copyFromFloats(0,0,1),y=p[8].setAll(Number.MAX_VALUE),v=p[9].setAll(-Number.MAX_VALUE),b=p[10].setAll(0),S=this._tmpVertex,P=S.position,R=S.color,T=S.uv;if((this.billboard||this._depthSort)&&(this.mesh.computeWorldMatrix(!0),this.mesh._worldMatrix.invertToRef(o)),this.billboard){var A=p[0];this._camera.getDirectionToRef(J.RD.Z,A),g.P.TransformNormalToRef(A,o,_),_.normalize();var C=this._camera.getViewMatrix(!0);g.P.TransformNormalFromFloatsToRef(C.m[1],C.m[5],C.m[9],o,f),g.P.CrossToRef(f,_,m),f.normalize(),m.normalize()}this._depthSort&&g.P.TransformCoordinatesToRef(this._camera.globalPosition,o,b),g.y3.IdentityToRef(r);var G=0,B=0,E=0,D=0,M=0,I=0,V=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),e=e>=this.nbParticles?this.nbParticles-1:e,this._computeBoundingBox&&(0!=t||e!=this.nbParticles-1)){var w=this.mesh.getBoundingInfo();w&&(y.copyFrom(w.minimum),v.copyFrom(w.maximum))}var z=(B=this.particles[t]._pos)/3|0;D=4*z,I=2*z;for(var O=t;O<=e;O++){var F=this.particles[O];this.updateParticle(F);var L=F._model._shape,j=F._model._shapeUV,N=F._rotationMatrix,U=F.position,W=F.rotation,k=F.scaling,H=F._globalPosition;if(this._depthSort&&this._depthSortParticles){var Y=this.depthSortedParticles[O];Y.idx=F.idx,Y.ind=F._ind,Y.indicesLength=F._model._indicesLength,Y.sqDistance=g.P.DistanceSquared(F.position,b)}if(!F.alive||F._stillInvisible&&!F.isVisible)B+=3*(V=L.length),D+=4*V,I+=2*V;else{if(F.isVisible){F._stillInvisible=!1;var Q=p[12];if(F.pivot.multiplyToRef(k,Q),this.billboard&&(W.x=0,W.y=0),(this._computeParticleRotation||this.billboard)&&F.getRotationMatrix(r),null!==F.parentId){var Z=this.getParticleById(F.parentId);if(Z){var K=Z._rotationMatrix,X=Z._globalPosition,$=U.x*K[1]+U.y*K[4]+U.z*K[7],tt=U.x*K[0]+U.y*K[3]+U.z*K[6],et=U.x*K[2]+U.y*K[5]+U.z*K[8];if(H.x=X.x+tt,H.y=X.y+$,H.z=X.z+et,this._computeParticleRotation||this.billboard){var it=r.m;N[0]=it[0]*K[0]+it[1]*K[3]+it[2]*K[6],N[1]=it[0]*K[1]+it[1]*K[4]+it[2]*K[7],N[2]=it[0]*K[2]+it[1]*K[5]+it[2]*K[8],N[3]=it[4]*K[0]+it[5]*K[3]+it[6]*K[6],N[4]=it[4]*K[1]+it[5]*K[4]+it[6]*K[7],N[5]=it[4]*K[2]+it[5]*K[5]+it[6]*K[8],N[6]=it[8]*K[0]+it[9]*K[3]+it[10]*K[6],N[7]=it[8]*K[1]+it[9]*K[4]+it[10]*K[7],N[8]=it[8]*K[2]+it[9]*K[5]+it[10]*K[8]}}else F.parentId=null}else if(H.x=U.x,H.y=U.y,H.z=U.z,this._computeParticleRotation||this.billboard){it=r.m;N[0]=it[0],N[1]=it[1],N[2]=it[2],N[3]=it[4],N[4]=it[5],N[5]=it[6],N[6]=it[8],N[7]=it[9],N[8]=it[10]}var rt=p[11];for(F.translateFromPivot?rt.setAll(0):rt.copyFrom(Q),V=0;V<L.length;V++){G=B+3*V,E=D+4*V,M=I+2*V;var ot=2*V,st=ot+1;P.copyFrom(L[V]),this._computeParticleColor&&F.color&&R.copyFrom(F.color),this._computeParticleTexture&&T.copyFromFloats(j[ot],j[st]),this._computeParticleVertex&&this.updateParticleVertex(F,S,V);var nt=P.x*k.x-Q.x,at=P.y*k.y-Q.y,ht=P.z*k.z-Q.z;tt=nt*N[0]+at*N[3]+ht*N[6],$=nt*N[1]+at*N[4]+ht*N[7],et=nt*N[2]+at*N[5]+ht*N[8];tt+=rt.x,$+=rt.y,et+=rt.z;var lt=a[G]=H.x+m.x*tt+f.x*$+_.x*et,ct=a[G+1]=H.y+m.y*tt+f.y*$+_.y*et,dt=a[G+2]=H.z+m.z*tt+f.z*$+_.z*et;if(this._computeBoundingBox&&(y.minimizeInPlaceFromFloats(lt,ct,dt),v.maximizeInPlaceFromFloats(lt,ct,dt)),!this._computeParticleVertex){var ut=u[G],pt=u[G+1],mt=u[G+2],ft=ut*N[0]+pt*N[3]+mt*N[6],_t=ut*N[1]+pt*N[4]+mt*N[7],gt=ut*N[2]+pt*N[5]+mt*N[8];h[G]=m.x*ft+f.x*_t+_.x*gt,h[G+1]=m.y*ft+f.y*_t+_.y*gt,h[G+2]=m.z*ft+f.z*_t+_.z*gt}if(this._computeParticleColor&&F.color){var yt=this._colors32;yt[E]=R.r,yt[E+1]=R.g,yt[E+2]=R.b,yt[E+3]=R.a}if(this._computeParticleTexture){var vt=F.uvs;l[M]=T.x*(vt.z-vt.x)+vt.x,l[M+1]=T.y*(vt.w-vt.y)+vt.y}}}else for(F._stillInvisible=!0,V=0;V<L.length;V++){if(E=D+4*V,M=I+2*V,a[G=B+3*V]=a[G+1]=a[G+2]=0,h[G]=h[G+1]=h[G+2]=0,this._computeParticleColor&&F.color){var xt=F.color;n[E]=xt.r,n[E+1]=xt.g,n[E+2]=xt.b,n[E+3]=xt.a}if(this._computeParticleTexture){vt=F.uvs;l[M]=j[2*V]*(vt.z-vt.x)+vt.x,l[M+1]=j[2*V+1]*(vt.w-vt.y)+vt.y}}if(this._particlesIntersect){var bt=F.getBoundingInfo(),St=bt.boundingBox,Pt=bt.boundingSphere,Rt=F._modelBoundingInfo;if(!this._bSphereOnly){var Tt=Rt.boundingBox.vectors,At=p[1],Ct=p[2];At.setAll(Number.MAX_VALUE),Ct.setAll(-Number.MAX_VALUE);for(var Gt=0;Gt<8;Gt++){var Bt=Tt[Gt].x*k.x,Et=Tt[Gt].y*k.y,Dt=Tt[Gt].z*k.z,Mt=(tt=Bt*N[0]+Et*N[3]+Dt*N[6],$=Bt*N[1]+Et*N[4]+Dt*N[7],et=Bt*N[2]+Et*N[5]+Dt*N[8],U.x+m.x*tt+f.x*$+_.x*et),It=U.y+m.y*tt+f.y*$+_.y*et,Vt=U.z+m.z*tt+f.z*$+_.z*et;At.minimizeInPlaceFromFloats(Mt,It,Vt),Ct.maximizeInPlaceFromFloats(Mt,It,Vt)}St.reConstruct(At,Ct,s._worldMatrix)}var wt=Rt.minimum.multiplyToRef(k,p[1]),zt=Rt.maximum.multiplyToRef(k,p[2]),Ot=zt.addToRef(wt,p[3]).scaleInPlace(.5).addInPlace(H),Ft=zt.subtractToRef(wt,p[4]).scaleInPlace(.5*this._bSphereRadiusFactor),Lt=Ot.subtractToRef(Ft,p[1]),jt=Ot.addToRef(Ft,p[2]);Pt.reConstruct(Lt,jt,s._worldMatrix)}B=G+3,D=E+4,I=M+2}}if(i){if(this._computeParticleColor)(kt=s.getVertexBuffer(x.o.ColorKind))&&!s.isPickable?kt.updateDirectly(n,0):s.updateVerticesData(x.o.ColorKind,n,!1,!1);if(this._computeParticleTexture)(kt=s.getVertexBuffer(x.o.UVKind))&&!s.isPickable?kt.updateDirectly(l,0):s.updateVerticesData(x.o.UVKind,l,!1,!1);var Nt=s.getVertexBuffer(x.o.PositionKind);if(Nt&&!s.isPickable?Nt.updateDirectly(a,0):s.updateVerticesData(x.o.PositionKind,a,!1,!1),!s.areNormalsFrozen||s.isFacetDataEnabled){if(this._computeParticleVertex||s.isFacetDataEnabled){var Ut=s.isFacetDataEnabled?s.getFacetDataParameters():null;q.x.ComputeNormals(a,c,h,Ut);for(var Wt=0;Wt<h.length;Wt++)u[Wt]=h[Wt]}var kt;if(!s.areNormalsFrozen)(kt=s.getVertexBuffer(x.o.NormalKind))&&!s.isPickable?kt.updateDirectly(h,0):s.updateVerticesData(x.o.NormalKind,h,!1,!1)}if(this._depthSort&&this._depthSortParticles){var Ht=this.depthSortedParticles;Ht.sort(this._depthSortFunction);for(var Yt=Ht.length,Qt=0,Zt=0,Kt=0;Kt<Yt;Kt++){var qt=Ht[Kt],Xt=qt.indicesLength,Jt=qt.ind;for(Wt=0;Wt<Xt;Wt++){if(c[Qt]=d[Jt+Wt],Qt++,this._pickable)if(0==Wt%3){var $t=this.pickedParticles[Zt];$t.idx=qt.idx,$t.faceId=Zt,Zt++}}}s.updateIndices(c)}}return this._computeBoundingBox&&(s.hasBoundingInfo?s.getBoundingInfo().reConstruct(y,v,s._worldMatrix):s.buildBoundingInfo(y,v,s._worldMatrix)),this._autoUpdateSubMeshes&&this.computeSubMeshes(),this.afterUpdateParticles(t,e,i),this},t.prototype.dispose=function(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._normals32=null,this._fixedNormal32=null,this._uvs32=null,this._colors32=null,this.pickedParticles=null,this.pickedBySubMesh=null,this._materials=null,this._materialIndexes=null,this._indicesByMaterial=null,this._idxOfId=null},t.prototype.pickedParticle=function(t){if(t.hit){var e=t.subMeshId,i=t.faceId-this.mesh.subMeshes[e].indexStart/3,r=this.pickedBySubMesh;if(r[e]&&r[e][i])return r[e][i]}return null},t.prototype.getParticleById=function(t){var e=this.particles[t];if(e&&e.id==t)return e;var i=this.particles,r=this._idxOfId[t];if(void 0!==r)return i[r];for(var o=0,s=this.nbParticles;o<s;){var n=i[o];if(n.id==t)return n;o++}return null},t.prototype.getParticlesByShapeId=function(t){var e=[];return this.getParticlesByShapeIdToRef(t,e),e},t.prototype.getParticlesByShapeIdToRef=function(t,e){e.length=0;for(var i=0;i<this.nbParticles;i++){var r=this.particles[i];r.shapeId==t&&e.push(r)}return this},t.prototype.computeSubMeshes=function(){if(!this.mesh||!this._multimaterialEnabled)return this;var t=this.depthSortedParticles;if(this.particles.length>0)for(var e=0;e<this.particles.length;e++){var i=this.particles[e];i.materialIndex||(i.materialIndex=0);var r=t[e];r.materialIndex=i.materialIndex,r.ind=i._ind,r.indicesLength=i._model._indicesLength,r.idx=i.idx}this._sortParticlesByMaterial();var o=this._indicesByMaterial,s=this._materialIndexes,n=this.mesh;n.subMeshes=[];for(var a=n.getTotalVertices(),h=0;h<s.length;h++){var l=o[h],c=o[h+1]-l,d=s[h];new $.P(d,0,a,l,c,n)}return this},t.prototype._sortParticlesByMaterial=function(){var t=[0];this._indicesByMaterial=t;var e=[];this._materialIndexes=e;var i=this.depthSortedParticles;i.sort(this._materialSortFunction);var r=i.length,o=this._indices32,s=this._indices,n=0,a=0,h=0,l=i[0].materialIndex;e.push(l),this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]);for(var c=0;c<r;c++){var d=i[c],u=d.indicesLength,p=d.ind;d.materialIndex!==l&&(l=d.materialIndex,t.push(h),e.push(l),this._pickable&&(n++,this.pickedBySubMesh[n]=[],a=0));for(var m=0,f=0;f<u;f++){if(o[h]=s[p+f],this._pickable)if(0==f%3){var _=this.pickedBySubMesh[n][a];_?(_.idx=d.idx,_.faceId=m):this.pickedBySubMesh[n][a]={idx:d.idx,faceId:m},a++,m++}h++}}return t.push(o.length),this._updatable&&this.mesh.updateIndices(o),this},t.prototype._setMaterialIndexesById=function(){this._materialIndexesById={};for(var t=0;t<this._materials.length;t++){var e=this._materials[t].uniqueId;this._materialIndexesById[e]=t}},t.prototype._filterUniqueMaterialId=function(t){return t.filter((function(t,e,i){return i.indexOf(t)===e}))},t.prototype._setDefaultMaterial=function(){return this._defaultMaterial||(this._defaultMaterial=new V.K(this.name+"DefaultMaterial",this._scene)),this._defaultMaterial},t.prototype.refreshVisibleSize=function(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this},t.prototype.setVisibilityBox=function(t){var e=t/2;this.mesh.buildBoundingInfo(new g.P(-e,-e,-e),new g.P(e,e,e))},Object.defineProperty(t.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(t){this._alwaysVisible=t,this.mesh.alwaysSelectAsActiveMesh=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isVisibilityBoxLocked",{get:function(){return this._isVisibilityBoxLocked},set:function(t){this._isVisibilityBoxLocked=t,this.mesh.getBoundingInfo().isLocked=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeParticleRotation",{get:function(){return this._computeParticleRotation},set:function(t){this._computeParticleRotation=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(t){this._computeParticleColor=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(t){this._computeParticleTexture=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeParticleVertex",{get:function(){return this._computeParticleVertex},set:function(t){this._computeParticleVertex=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(t){this._computeBoundingBox=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"depthSortParticles",{get:function(){return this._depthSortParticles},set:function(t){this._depthSortParticles=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"expandable",{get:function(){return this._expandable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"multimaterialEnabled",{get:function(){return this._multimaterialEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"useModelMaterial",{get:function(){return this._useModelMaterial},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"materials",{get:function(){return this._materials},enumerable:!1,configurable:!0}),t.prototype.setMultiMaterial=function(t){this._materials=this._filterUniqueMaterialId(t),this._setMaterialIndexesById(),this._multimaterial&&this._multimaterial.dispose(),this._multimaterial=new tt.G(this.name+"MultiMaterial",this._scene);for(var e=0;e<this._materials.length;e++)this._multimaterial.subMaterials.push(this._materials[e]);this.computeSubMeshes(),this.mesh.material=this._multimaterial},Object.defineProperty(t.prototype,"multimaterial",{get:function(){return this._multimaterial},set:function(t){this._multimaterial=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"autoUpdateSubMeshes",{get:function(){return this._autoUpdateSubMeshes},set:function(t){this._autoUpdateSubMeshes=t},enumerable:!1,configurable:!0}),t.prototype.initParticles=function(){},t.prototype.recycleParticle=function(t){return t},t.prototype.updateParticle=function(t){return t},t.prototype.updateParticleVertex=function(t,e,i){return this},t.prototype.beforeUpdateParticles=function(t,e,i){},t.prototype.afterUpdateParticles=function(t,e,i){},t}(),it=i(6307),rt=function(){function t(t,e,i,r,o){this.idx=0,this.color=new it.HE(1,1,1,1),this.position=it.P.Zero(),this.rotation=it.P.Zero(),this.uv=new it.FM(0,0),this.velocity=it.P.Zero(),this.pivot=it.P.Zero(),this.translateFromPivot=!1,this._pos=0,this._ind=0,this.groupId=0,this.idxInGroup=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=it.P.Zero(),this.idx=t,this._group=e,this.groupId=i,this.idxInGroup=r,this._pcs=o}return Object.defineProperty(t.prototype,"size",{get:function(){return this.size},set:function(t){this.size=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(t){this.rotationQuaternion=t},enumerable:!1,configurable:!0}),t.prototype.intersectsMesh=function(t,e){if(!t.hasBoundingInfo)return!1;if(e=e||!1)return t.getBoundingInfo().boundingSphere.intersectsPoint(this.position.add(this._pcs.mesh.position));var i,r,o,s,n,a;i=t.getBoundingInfo().boundingBox.maximumWorld.x,r=t.getBoundingInfo().boundingBox.minimumWorld.x,o=t.getBoundingInfo().boundingBox.maximumWorld.y,s=t.getBoundingInfo().boundingBox.minimumWorld.y,n=t.getBoundingInfo().boundingBox.maximumWorld.z,a=t.getBoundingInfo().boundingBox.minimumWorld.z;var h=this.position.x+this._pcs.mesh.position.x,l=this.position.y+this._pcs.mesh.position.y,c=this.position.z+this._pcs.mesh.position.z;return r<=h&&h<=i&&s<=l&&l<=o&&a<=c&&c<=n},t.prototype.getRotationMatrix=function(t){var e;if(this.rotationQuaternion)e=this.rotationQuaternion;else{e=it.jp.Quaternion[0];var i=this.rotation;it._f.RotationYawPitchRollToRef(i.y,i.x,i.z,e)}e.toRotationMatrix(t)},t}(),ot=function(){function t(t,e){this.groupId=t,this._positionFunction=e}return Object.defineProperty(t.prototype,"groupID",{get:function(){return this.groupId},set:function(t){this.groupId=t},enumerable:!1,configurable:!0}),t}(),st=i(84318),nt=i(1316),at=i(39126);!function(t){t[t.Color=2]="Color",t[t.UV=1]="UV",t[t.Random=0]="Random",t[t.Stated=3]="Stated"}(U||(U={}));var ht=function(){function t(t,e,i,r){this.particles=new Array,this.nbParticles=0,this.counter=0,this.vars={},this._promises=[],this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._updatable=!0,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._groups=new Array,this._groupCounter=0,this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeBoundingBox=!1,this._isReady=!1,this.name=t,this._size=e,this._scene=i||A.l.LastCreatedScene,r&&void 0!==r.updatable?this._updatable=r.updatable:this._updatable=!0}return Object.defineProperty(t.prototype,"positions",{get:function(){return this._positions32},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"colors",{get:function(){return this._colors32},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uvs",{get:function(){return this._uvs32},enumerable:!1,configurable:!0}),t.prototype.buildMeshAsync=function(t){var e=this;return Promise.all(this._promises).then((function(){return e._isReady=!0,e._buildMesh(t)}))},t.prototype._buildMesh=function(t){0===this.nbParticles&&this.addPoints(1),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors);var e=new q.x;e.set(this._positions32,x.o.PositionKind),this._uvs32.length>0&&e.set(this._uvs32,x.o.UVKind);var i=0;this._colors32.length>0&&(i=1,e.set(this._colors32,x.o.ColorKind));var r=new F.Kj(this.name,this._scene);e.applyToMesh(r,this._updatable),this.mesh=r,this._positions=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0);var o=t;return o||((o=new V.K("point cloud material",this._scene)).emissiveColor=new it.Wo(i,i,i),o.disableLighting=!0,o.pointsCloud=!0,o.pointSize=this._size),r.material=o,new Promise((function(t){return t(r)}))},t.prototype._addParticle=function(t,e,i,r){var o=new rt(t,e,i,r,this);return this.particles.push(o),o},t.prototype._randomUnitVector=function(t){t.position=new g.P(Math.random(),Math.random(),Math.random()),t.color=new it.HE(1,1,1,1)},t.prototype._getColorIndicesForCoord=function(t,e,i,r){var o=t._groupImageData,s=i*(4*r)+4*e,n=[s,s+1,s+2,s+3],a=n[1],h=n[2],l=n[3],c=o[n[0]],d=o[a],u=o[h],p=o[l];return new it.HE(c/255,d/255,u/255,p)},t.prototype._setPointsColorOrUV=function(t,e,i,r,o,s,n){i&&t.updateFacetData();var a=2*t.getBoundingInfo().boundingSphere.radius,h=t.getVerticesData(x.o.PositionKind),l=t.getIndices(),c=t.getVerticesData(x.o.UVKind),d=t.getVerticesData(x.o.ColorKind),u=g.P.Zero();t.computeWorldMatrix();var p=t.getWorldMatrix();if(!p.isIdentity()){h=h.slice(0);for(var m=0;m<h.length/3;m++)g.P.TransformCoordinatesFromFloatsToRef(h[3*m],h[3*m+1],h[3*m+2],p,u),h[3*m]=u.x,h[3*m+1]=u.y,h[3*m+2]=u.z}var f,_,y=0,b=0,S=0,P=0,R=0,T=0,A=0,C=0,G=0,B=0,E=0,D=0,M=0,I=g.P.Zero(),V=g.P.Zero(),w=g.P.Zero(),z=g.P.Zero(),O=g.P.Zero(),F=0,L=0,j=0,N=0,U=0,W=0,k=g.FM.Zero(),H=g.FM.Zero(),Y=g.FM.Zero(),Q=g.FM.Zero(),Z=g.FM.Zero(),K=0,q=0,X=0,J=0,$=0,tt=0,et=0,rt=0,ot=0,st=0,at=0,ht=0,lt=g.Lt.Zero(),ct=g.Lt.Zero(),dt=g.Lt.Zero(),ut=g.Lt.Zero(),pt=g.Lt.Zero(),mt=0,ft=0;n=n||0;for(var _t,gt=new g.Lt(0,0,0,0),yt=g.P.Zero(),vt=g.P.Zero(),xt=g.P.Zero(),bt=0,St=g.P.Zero(),Pt=0,Rt=0,Tt=new nt.z(g.P.Zero(),new g.P(1,0,0)),At=g.P.Zero(),Ct=0;Ct<l.length/3;Ct++){b=l[3*Ct],S=l[3*Ct+1],P=l[3*Ct+2],R=h[3*b],T=h[3*b+1],A=h[3*b+2],C=h[3*S],G=h[3*S+1],B=h[3*S+2],E=h[3*P],D=h[3*P+1],M=h[3*P+2],I.set(R,T,A),V.set(C,G,B),w.set(E,D,M),V.subtractToRef(I,z),w.subtractToRef(V,O),c&&(F=c[2*b],L=c[2*b+1],j=c[2*S],N=c[2*S+1],U=c[2*P],W=c[2*P+1],k.set(F,L),H.set(j,N),Y.set(U,W),H.subtractToRef(k,Q),Y.subtractToRef(H,Z)),d&&r&&(K=d[4*b],q=d[4*b+1],X=d[4*b+2],J=d[4*b+3],$=d[4*S],tt=d[4*S+1],et=d[4*S+2],rt=d[4*S+3],ot=d[4*P],st=d[4*P+1],at=d[4*P+2],ht=d[4*P+3],lt.set(K,q,X,J),ct.set($,tt,et,rt),dt.set(ot,st,at,ht),ct.subtractToRef(lt,ut),dt.subtractToRef(ct,pt));for(var Gt=void 0,Bt=void 0,Et=void 0,Dt=void 0,Mt=void 0,It=void 0,Vt=void 0,wt=void 0,zt=new it.Wo(0,0,0),Ot=new it.Wo(0,0,0),Ft=void 0,Lt=void 0,jt=0;jt<e._groupDensity[Ct];jt++)y=this.particles.length,this._addParticle(y,e,this._groupCounter,Ct+jt),Lt=this.particles[y],mt=v.R.RandomRange(0,1),ft=v.R.RandomRange(0,1),f=I.add(z.scale(mt)).add(O.scale(mt*ft)),i&&(yt=t.getFacetNormal(Ct).normalize().scale(-1),vt=z.clone().normalize(),xt=g.P.Cross(yt,vt),bt=v.R.RandomRange(0,2*Math.PI),St=vt.scale(Math.cos(bt)).add(xt.scale(Math.sin(bt))),bt=v.R.RandomRange(.1,Math.PI/2),At=St.scale(Math.cos(bt)).add(yt.scale(Math.sin(bt))),Tt.origin=f.add(At.scale(1e-5)),Tt.direction=At,Tt.length=a,(_t=Tt.intersectsMesh(t)).hit&&(Rt=_t.pickedPoint.subtract(f).length(),Pt=v.R.RandomRange(0,1)*Rt,f.addInPlace(At.scale(Pt)))),Lt.position=f.clone(),this._positions.push(Lt.position.x,Lt.position.y,Lt.position.z),void 0!==r?c&&(_=k.add(Q.scale(mt)).add(Z.scale(mt*ft)),r?o&&null!==e._groupImageData?(Gt=e._groupImgWidth,Bt=e._groupImgHeight,Ft=this._getColorIndicesForCoord(e,Math.round(_.x*Gt),Math.round(_.y*Bt),Gt),Lt.color=Ft,this._colors.push(Ft.r,Ft.g,Ft.b,Ft.a)):d?(gt=lt.add(ut.scale(mt)).add(pt.scale(mt*ft)),Lt.color=new it.HE(gt.x,gt.y,gt.z,gt.w),this._colors.push(gt.x,gt.y,gt.z,gt.w)):(gt=lt.set(Math.random(),Math.random(),Math.random(),1),Lt.color=new it.HE(gt.x,gt.y,gt.z,gt.w),this._colors.push(gt.x,gt.y,gt.z,gt.w)):(Lt.uv=_.clone(),this._uvs.push(Lt.uv.x,Lt.uv.y))):(s?(zt.set(s.r,s.g,s.b),Et=v.R.RandomRange(-n,n),Dt=v.R.RandomRange(-n,n),Mt=(wt=zt.toHSV()).r,(It=wt.g+Et)<0&&(It=0),It>1&&(It=1),(Vt=wt.b+Dt)<0&&(Vt=0),Vt>1&&(Vt=1),it.Wo.HSVtoRGBToRef(Mt,It,Vt,Ot),gt.set(Ot.r,Ot.g,Ot.b,1)):gt=lt.set(Math.random(),Math.random(),Math.random(),1),Lt.color=new it.HE(gt.x,gt.y,gt.z,gt.w),this._colors.push(gt.x,gt.y,gt.z,gt.w))}},t.prototype._colorFromTexture=function(t,e,i){var r=this;if(null===t.material)return st.Y.Warn(t.name+"has no material."),e._groupImageData=null,void this._setPointsColorOrUV(t,e,i,!0,!1);var o=t.material.getActiveTextures();if(0===o.length)return st.Y.Warn(t.name+"has no usable texture."),e._groupImageData=null,void this._setPointsColorOrUV(t,e,i,!0,!1);var s=t.clone();s.setEnabled(!1),this._promises.push(new Promise((function(t){at.V.WhenAllReady(o,(function(){var n=e._textureNb;n<0&&(n=0),n>o.length-1&&(n=o.length-1);var a=function(){e._groupImgWidth=o[n].getSize().width,e._groupImgHeight=o[n].getSize().height,r._setPointsColorOrUV(s,e,i,!0,!0),s.dispose(),t()};e._groupImageData=null;var h=o[n].readPixels();h?h.then((function(t){e._groupImageData=t,a()})):a()}))})))},t.prototype._calculateDensity=function(t,e,i){for(var r,o,s,n,a,h,l,c,d,u,p,m,f,_,y,v,x,b=new Array,S=g.P.Zero(),P=g.P.Zero(),R=g.P.Zero(),T=g.P.Zero(),A=g.P.Zero(),C=g.P.Zero(),G=new Array,B=0,E=i.length/3,D=0;D<E;D++)r=i[3*D],o=i[3*D+1],s=i[3*D+2],n=e[3*r],a=e[3*r+1],h=e[3*r+2],l=e[3*o],c=e[3*o+1],d=e[3*o+2],u=e[3*s],p=e[3*s+1],m=e[3*s+2],S.set(n,a,h),P.set(l,c,d),R.set(u,p,m),P.subtractToRef(S,T),R.subtractToRef(P,A),R.subtractToRef(S,C),v=((f=T.length())+(_=A.length())+(y=C.length()))/2,B+=x=Math.sqrt(v*(v-f)*(v-_)*(v-y)),G[D]=x;var M=0;for(D=0;D<E;D++)b[D]=Math.floor(t*G[D]/B),M+=b[D];var I=t-M,V=Math.floor(I/E),w=I%E;V>0&&(b=b.map((function(t){return t+V})));for(D=0;D<w;D++)b[D]+=1;return b},t.prototype.addPoints=function(t,e){void 0===e&&(e=this._randomUnitVector);for(var i,r=new ot(this._groupCounter,e),o=this.nbParticles,s=0;s<t;s++)i=this._addParticle(o,r,this._groupCounter,s),r&&r._positionFunction&&r._positionFunction(i,o,s),this._positions.push(i.position.x,i.position.y,i.position.z),i.color&&this._colors.push(i.color.r,i.color.g,i.color.b,i.color.a),i.uv&&this._uvs.push(i.uv.x,i.uv.y),o++;return this.nbParticles+=t,this._groupCounter++,this._groupCounter},t.prototype.addSurfacePoints=function(t,e,i,r,o){var s=i||U.Random;(isNaN(s)||s<0||s>3)&&(s=U.Random);var n=t.getVerticesData(x.o.PositionKind),a=t.getIndices();this._groups.push(this._groupCounter);var h=new ot(this._groupCounter,null);switch(h._groupDensity=this._calculateDensity(e,n,a),s===U.Color?h._textureNb=r||0:r=r||new it.HE(1,1,1,1),s){case U.Color:this._colorFromTexture(t,h,!1);break;case U.UV:this._setPointsColorOrUV(t,h,!1,!1,!1);break;case U.Random:this._setPointsColorOrUV(t,h,!1);break;case U.Stated:this._setPointsColorOrUV(t,h,!1,void 0,void 0,r,o)}return this.nbParticles+=e,this._groupCounter++,this._groupCounter-1},t.prototype.addVolumePoints=function(t,e,i,r,o){var s=i||U.Random;(isNaN(s)||s<0||s>3)&&(s=U.Random);var n=t.getVerticesData(x.o.PositionKind),a=t.getIndices();this._groups.push(this._groupCounter);var h=new ot(this._groupCounter,null);switch(h._groupDensity=this._calculateDensity(e,n,a),s===U.Color?h._textureNb=r||0:r=r||new it.HE(1,1,1,1),s){case U.Color:this._colorFromTexture(t,h,!0);break;case U.UV:this._setPointsColorOrUV(t,h,!0,!1,!1);break;case U.Random:this._setPointsColorOrUV(t,h,!0);break;case U.Stated:this._setPointsColorOrUV(t,h,!0,void 0,void 0,r,o)}return this.nbParticles+=e,this._groupCounter++,this._groupCounter-1},t.prototype.setParticles=function(t,e,i){if(void 0===t&&(t=0),void 0===e&&(e=this.nbParticles-1),void 0===i&&(i=!0),!this._updatable||!this._isReady)return this;this.beforeUpdateParticles(t,e,i);var r=g.jp.Matrix[0],o=this.mesh,s=this._colors32,n=this._positions32,a=this._uvs32,h=g.jp.Vector3,l=h[5].copyFromFloats(1,0,0),c=h[6].copyFromFloats(0,1,0),d=h[7].copyFromFloats(0,0,1),u=h[8].setAll(Number.MAX_VALUE),p=h[9].setAll(-Number.MAX_VALUE);g.y3.IdentityToRef(r);var m=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),e=e>=this.nbParticles?this.nbParticles-1:e,this._computeBoundingBox&&(0!=t||e!=this.nbParticles-1)){var f=this.mesh.getBoundingInfo();f&&(u.copyFrom(f.minimum),p.copyFrom(f.maximum))}m=0;for(var _=0,y=0,v=0,b=t;b<=e;b++){var S=this.particles[b];_=3*(m=S.idx),y=4*m,v=2*m,this.updateParticle(S);var P=S._rotationMatrix,R=S.position,T=S._globalPosition;if(this._computeParticleRotation&&S.getRotationMatrix(r),null!==S.parentId){var A=this.particles[S.parentId],C=A._rotationMatrix,G=A._globalPosition,B=R.x*C[1]+R.y*C[4]+R.z*C[7],E=R.x*C[0]+R.y*C[3]+R.z*C[6],D=R.x*C[2]+R.y*C[5]+R.z*C[8];if(T.x=G.x+E,T.y=G.y+B,T.z=G.z+D,this._computeParticleRotation){var M=r.m;P[0]=M[0]*C[0]+M[1]*C[3]+M[2]*C[6],P[1]=M[0]*C[1]+M[1]*C[4]+M[2]*C[7],P[2]=M[0]*C[2]+M[1]*C[5]+M[2]*C[8],P[3]=M[4]*C[0]+M[5]*C[3]+M[6]*C[6],P[4]=M[4]*C[1]+M[5]*C[4]+M[6]*C[7],P[5]=M[4]*C[2]+M[5]*C[5]+M[6]*C[8],P[6]=M[8]*C[0]+M[9]*C[3]+M[10]*C[6],P[7]=M[8]*C[1]+M[9]*C[4]+M[10]*C[7],P[8]=M[8]*C[2]+M[9]*C[5]+M[10]*C[8]}}else if(T.x=0,T.y=0,T.z=0,this._computeParticleRotation){M=r.m;P[0]=M[0],P[1]=M[1],P[2]=M[2],P[3]=M[4],P[4]=M[5],P[5]=M[6],P[6]=M[8],P[7]=M[9],P[8]=M[10]}var I=h[11];S.translateFromPivot?I.setAll(0):I.copyFrom(S.pivot);var V=h[0];V.copyFrom(S.position);var w=V.x-S.pivot.x,z=V.y-S.pivot.y,O=V.z-S.pivot.z,F=w*P[0]+z*P[3]+O*P[6],L=w*P[1]+z*P[4]+O*P[7],j=w*P[2]+z*P[5]+O*P[8];F+=I.x,L+=I.y,j+=I.z;var N=n[_]=T.x+l.x*F+c.x*L+d.x*j,U=n[_+1]=T.y+l.y*F+c.y*L+d.y*j,W=n[_+2]=T.z+l.z*F+c.z*L+d.z*j;if(this._computeBoundingBox&&(u.minimizeInPlaceFromFloats(N,U,W),p.maximizeInPlaceFromFloats(N,U,W)),this._computeParticleColor&&S.color){var k=S.color,H=this._colors32;H[y]=k.r,H[y+1]=k.g,H[y+2]=k.b,H[y+3]=k.a}if(this._computeParticleTexture&&S.uv){var Y=S.uv,Q=this._uvs32;Q[v]=Y.x,Q[v+1]=Y.y}}return i&&(this._computeParticleColor&&o.updateVerticesData(x.o.ColorKind,s,!1,!1),this._computeParticleTexture&&o.updateVerticesData(x.o.UVKind,a,!1,!1),o.updateVerticesData(x.o.PositionKind,n,!1,!1)),this._computeBoundingBox&&(o.hasBoundingInfo?o.getBoundingInfo().reConstruct(u,p,o._worldMatrix):o.buildBoundingInfo(u,p,o._worldMatrix)),this.afterUpdateParticles(t,e,i),this},t.prototype.dispose=function(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._uvs32=null,this._colors32=null},t.prototype.refreshVisibleSize=function(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this},t.prototype.setVisibilityBox=function(t){var e=t/2;this.mesh.buildBoundingInfo(new g.P(-e,-e,-e),new g.P(e,e,e))},Object.defineProperty(t.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(t){this._alwaysVisible=t,this.mesh.alwaysSelectAsActiveMesh=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeParticleRotation",{set:function(t){this._computeParticleRotation=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(t){this._computeParticleColor=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(t){this._computeParticleTexture=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(t){this._computeBoundingBox=t},enumerable:!1,configurable:!0}),t.prototype.initParticles=function(){},t.prototype.recycleParticle=function(t){return t},t.prototype.updateParticle=function(t){return t},t.prototype.beforeUpdateParticles=function(t,e,i){},t.prototype.afterUpdateParticles=function(t,e,i){},t}(),lt=i(45680)},74290:(t,e,i)=>{i.d(e,{h:()=>n});var r=i(58095),o=i(15631),s=i(72739),n=function(){function t(e){this.particleSystem=e,this.position=r.P.Zero(),this.direction=r.P.Zero(),this.color=new o.HE(0,0,0,0),this.colorStep=new o.HE(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new r.FM(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new o.HE(0,0,0,0),this._currentColor2=new o.HE(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=t._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}return t.prototype._updateCellInfoFromSystem=function(){this.cellIndex=this.particleSystem.startSpriteCellID},t.prototype.updateCellIndex=function(){var t=this.age,e=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(void 0===this._randomCellOffset&&(this._randomCellOffset=Math.random()*this.lifeTime),0===e?(e=1,t=this._randomCellOffset):t+=this._randomCellOffset);var i,r=this._initialEndSpriteCellID-this._initialStartSpriteCellID;i=this._initialSpriteCellLoop?s.R.Clamp(t*e%this.lifeTime/this.lifeTime):s.R.Clamp(t*e/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+i*r|0},t.prototype._inheritParticleInfoToSubEmitter=function(t){if(t.particleSystem.emitter.position){var e=t.particleSystem.emitter;if(e.position.copyFrom(this.position),t.inheritDirection){var i=r.jp.Vector3[0];this.direction.normalizeToRef(i),e.setDirection(i,0,Math.PI/2)}}else{t.particleSystem.emitter.copyFrom(this.position)}this.direction.scaleToRef(t.inheritedVelocityAmount/2,r.jp.Vector3[0]),t.particleSystem._inheritedVelocityOffset.copyFrom(r.jp.Vector3[0])},t.prototype._inheritParticleInfoToSubEmitters=function(){var t=this;this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach((function(e){t._inheritParticleInfoToSubEmitter(e)}))},t.prototype._reset=function(){this.age=0,this.id=t._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0},t.prototype.copyTo=function(t){t.position.copyFrom(this.position),this._initialDirection?t._initialDirection?t._initialDirection.copyFrom(this._initialDirection):t._initialDirection=this._initialDirection.clone():t._initialDirection=null,t.direction.copyFrom(this.direction),this._localPosition&&(t._localPosition?t._localPosition.copyFrom(this._localPosition):t._localPosition=this._localPosition.clone()),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.lifeTime=this.lifeTime,t.age=this.age,t._randomCellOffset=this._randomCellOffset,t.size=this.size,t.scale.copyFrom(this.scale),t.angle=this.angle,t.angularSpeed=this.angularSpeed,t.particleSystem=this.particleSystem,t.cellIndex=this.cellIndex,t.id=this.id,t._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(t._currentColorGradient=this._currentColorGradient,t._currentColor1.copyFrom(this._currentColor1),t._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(t._currentSizeGradient=this._currentSizeGradient,t._currentSize1=this._currentSize1,t._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(t._currentAngularSpeedGradient=this._currentAngularSpeedGradient,t._currentAngularSpeed1=this._currentAngularSpeed1,t._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(t._currentVelocityGradient=this._currentVelocityGradient,t._currentVelocity1=this._currentVelocity1,t._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(t._currentLimitVelocityGradient=this._currentLimitVelocityGradient,t._currentLimitVelocity1=this._currentLimitVelocity1,t._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(t._currentDragGradient=this._currentDragGradient,t._currentDrag1=this._currentDrag1,t._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this._initialStartSpriteCellID,t._initialEndSpriteCellID=this._initialEndSpriteCellID,t._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(t.remapData&&this.remapData?t.remapData.copyFrom(this.remapData):t.remapData=new r.Lt(0,0,0,0)),this._randomNoiseCoordinates1&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),t._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(t._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),t._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))},t._Count=0,t}()},22672:(t,e,i)=>{i.d(e,{p:()=>S});var r=i(31191),o=i(4359),s=i(62897),n=i(58095),a=i(72739),h=i(72208),l=i(90622),c=i(15034),d=i(15210),u=i(22016),p=i(25846),m=i(74290),f=i(45680),_=i(96969),g=i(48620),y=i(67759),v=(i(82943),i(24007),i(15631)),x=i(61159),b=i(91901),S=(i(21352),function(t){function e(e,i,r,h,l,c){void 0===h&&(h=null),void 0===l&&(l=!1),void 0===c&&(c=.01);var p=t.call(this,e)||this;p._emitterInverseWorldMatrix=n.y3.Identity(),p._inheritedVelocityOffset=new n.P,p.onDisposeObservable=new s.y$,p.onStoppedObservable=new s.y$,p._particles=new Array,p._stockParticles=new Array,p._newPartsExcess=0,p._vertexBuffers={},p._scaledColorStep=new v.HE(0,0,0,0),p._colorDiff=new v.HE(0,0,0,0),p._scaledDirection=n.P.Zero(),p._scaledGravity=n.P.Zero(),p._currentRenderId=-1,p._useInstancing=!1,p._started=!1,p._stopped=!1,p._actualFrame=0,p._currentEmitRate1=0,p._currentEmitRate2=0,p._currentStartSize1=0,p._currentStartSize2=0,p._rawTextureWidth=256,p._useRampGradients=!1,p._disposeEmitterOnDispose=!1,p.isLocal=!1,p._onBeforeDrawParticlesObservable=null,p.recycleParticle=function(t){var e=p._particles.pop();e!==t&&e.copyTo(t),p._stockParticles.push(e)},p._createParticle=function(){var t;if(0!==p._stockParticles.length?(t=p._stockParticles.pop())._reset():t=new m.h(p),p._subEmitters&&p._subEmitters.length>0){var e=p._subEmitters[Math.floor(Math.random()*p._subEmitters.length)];t._attachedSubEmitters=[],e.forEach((function(e){if(e.type===f.l.ATTACHED){var i=e.clone();t._attachedSubEmitters.push(i),i.particleSystem.start()}}))}return t},p._emitFromParticle=function(t){if(p._subEmitters&&0!==p._subEmitters.length){var e=Math.floor(Math.random()*p._subEmitters.length);p._subEmitters[e].forEach((function(e){if(e.type===f.l.END){var i=e.clone();t._inheritParticleInfoToSubEmitter(i),i.particleSystem._rootParticleSystem=p,p.activeSubSystems.push(i.particleSystem),i.particleSystem.start()}}))}},p._capacity=i,p._epsilon=c,p._isAnimationSheetEnabled=l,r&&"Scene"!==r.getClassName()?(p._engine=r,p.defaultProjectionMatrix=n.y3.PerspectiveFovLH(.8,1,.1,100,p._engine.isNDCHalfZRange)):(p._scene=r||d.l.LastCreatedScene,p._engine=p._scene.getEngine(),p.uniqueId=p._scene.getUniqueId(),p._scene.particleSystems.push(p)),p._engine.getCaps().vertexArrayObject&&(p._vertexArrayObject=null),p._attachImageProcessingConfiguration(null),p._customWrappers={0:new y.q(p._engine)},p._customWrappers[0].effect=h,p._drawWrappers=[],p._useInstancing=p._engine.getCaps().instancedArrays,p._createIndexBuffer(),p._createVertexBuffers(),p.particleEmitterType=new u.S3;var _=null;return p.updateFunction=function(t){var e,i=null;p.noiseTexture&&(i=p.noiseTexture.getSize(),null===(e=p.noiseTexture.getContent())||void 0===e||e.then((function(t){_=t})));for(var r,s=function(e){var s=t[e],h=p._scaledUpdateSpeed,l=s.age;if(s.age+=h,s.age>s.lifeTime){var c=s.age-l;h=(s.lifeTime-l)*h/c,s.age=s.lifeTime}var d=s.age/s.lifeTime;p._colorGradients&&p._colorGradients.length>0?o.fR.GetCurrentGradient(d,p._colorGradients,(function(t,e,i){t!==s._currentColorGradient&&(s._currentColor1.copyFrom(s._currentColor2),e.getColorToRef(s._currentColor2),s._currentColorGradient=t),v.HE.LerpToRef(s._currentColor1,s._currentColor2,i,s.color)})):(s.colorStep.scaleToRef(h,p._scaledColorStep),s.color.addInPlace(p._scaledColorStep),s.color.a<0&&(s.color.a=0)),p._angularSpeedGradients&&p._angularSpeedGradients.length>0&&o.fR.GetCurrentGradient(d,p._angularSpeedGradients,(function(t,e,i){t!==s._currentAngularSpeedGradient&&(s._currentAngularSpeed1=s._currentAngularSpeed2,s._currentAngularSpeed2=e.getFactor(),s._currentAngularSpeedGradient=t),s.angularSpeed=a.R.Lerp(s._currentAngularSpeed1,s._currentAngularSpeed2,i)})),s.angle+=s.angularSpeed*h;var u=h;if(p._velocityGradients&&p._velocityGradients.length>0&&o.fR.GetCurrentGradient(d,p._velocityGradients,(function(t,e,i){t!==s._currentVelocityGradient&&(s._currentVelocity1=s._currentVelocity2,s._currentVelocity2=e.getFactor(),s._currentVelocityGradient=t),u*=a.R.Lerp(s._currentVelocity1,s._currentVelocity2,i)})),s.direction.scaleToRef(u,p._scaledDirection),p._limitVelocityGradients&&p._limitVelocityGradients.length>0&&o.fR.GetCurrentGradient(d,p._limitVelocityGradients,(function(t,e,i){t!==s._currentLimitVelocityGradient&&(s._currentLimitVelocity1=s._currentLimitVelocity2,s._currentLimitVelocity2=e.getFactor(),s._currentLimitVelocityGradient=t);var r=a.R.Lerp(s._currentLimitVelocity1,s._currentLimitVelocity2,i);s.direction.length()>r&&s.direction.scaleInPlace(p.limitVelocityDamping)})),p._dragGradients&&p._dragGradients.length>0&&o.fR.GetCurrentGradient(d,p._dragGradients,(function(t,e,i){t!==s._currentDragGradient&&(s._currentDrag1=s._currentDrag2,s._currentDrag2=e.getFactor(),s._currentDragGradient=t);var r=a.R.Lerp(s._currentDrag1,s._currentDrag2,i);p._scaledDirection.scaleInPlace(1-r)})),p.isLocal&&s._localPosition?(s._localPosition.addInPlace(p._scaledDirection),n.P.TransformCoordinatesToRef(s._localPosition,p._emitterWorldMatrix,s.position)):s.position.addInPlace(p._scaledDirection),_&&i&&s._randomNoiseCoordinates1){var m=p._fetchR(s._randomNoiseCoordinates1.x,s._randomNoiseCoordinates1.y,i.width,i.height,_),f=p._fetchR(s._randomNoiseCoordinates1.z,s._randomNoiseCoordinates2.x,i.width,i.height,_),g=p._fetchR(s._randomNoiseCoordinates2.y,s._randomNoiseCoordinates2.z,i.width,i.height,_),y=n.jp.Vector3[0],x=n.jp.Vector3[1];y.copyFromFloats((2*m-1)*p.noiseStrength.x,(2*f-1)*p.noiseStrength.y,(2*g-1)*p.noiseStrength.z),y.scaleToRef(h,x),s.direction.addInPlace(x)}if(p.gravity.scaleToRef(h,p._scaledGravity),s.direction.addInPlace(p._scaledGravity),p._sizeGradients&&p._sizeGradients.length>0&&o.fR.GetCurrentGradient(d,p._sizeGradients,(function(t,e,i){t!==s._currentSizeGradient&&(s._currentSize1=s._currentSize2,s._currentSize2=e.getFactor(),s._currentSizeGradient=t),s.size=a.R.Lerp(s._currentSize1,s._currentSize2,i)})),p._useRampGradients&&(p._colorRemapGradients&&p._colorRemapGradients.length>0&&o.fR.GetCurrentGradient(d,p._colorRemapGradients,(function(t,e,i){var r=a.R.Lerp(t.factor1,e.factor1,i),o=a.R.Lerp(t.factor2,e.factor2,i);s.remapData.x=r,s.remapData.y=o-r})),p._alphaRemapGradients&&p._alphaRemapGradients.length>0&&o.fR.GetCurrentGradient(d,p._alphaRemapGradients,(function(t,e,i){var r=a.R.Lerp(t.factor1,e.factor1,i),o=a.R.Lerp(t.factor2,e.factor2,i);s.remapData.z=r,s.remapData.w=o-r}))),p._isAnimationSheetEnabled&&s.updateCellIndex(),s._inheritParticleInfoToSubEmitters(),s.age>=s.lifeTime)return p._emitFromParticle(s),s._attachedSubEmitters&&(s._attachedSubEmitters.forEach((function(t){t.particleSystem.disposeOnStop=!0,t.particleSystem.stop()})),s._attachedSubEmitters=null),p.recycleParticle(s),e--,r=e,"continue";r=e},h=0;h<t.length;h++)s(h),h=r},p}return(0,r.ZT)(e,t),Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"useRampGradients",{get:function(){return this._useRampGradients},set:function(t){this._useRampGradients!==t&&(this._useRampGradients=t,this._resetEffect())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"particles",{get:function(){return this._particles},enumerable:!1,configurable:!0}),e.prototype.getActiveCount=function(){return this._particles.length},e.prototype.getClassName=function(){return"ParticleSystem"},e.prototype.isStopping=function(){return this._stopped&&this.isAlive()},e.prototype.getCustomEffect=function(t){var e,i;return void 0===t&&(t=0),null!==(i=null===(e=this._customWrappers[t])||void 0===e?void 0:e.effect)&&void 0!==i?i:this._customWrappers[0].effect},e.prototype._getCustomDrawWrapper=function(t){var e;return void 0===t&&(t=0),null!==(e=this._customWrappers[t])&&void 0!==e?e:this._customWrappers[0]},e.prototype.setCustomEffect=function(t,e){void 0===e&&(e=0),this._customWrappers[e]=new y.q(this._engine),this._customWrappers[e].effect=t,this._customWrappers[e].drawContext&&(this._customWrappers[e].drawContext.useInstancing=this._useInstancing)},Object.defineProperty(e.prototype,"onBeforeDrawParticlesObservable",{get:function(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new s.y$),this._onBeforeDrawParticlesObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vertexShaderName",{get:function(){return"particles"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vertexBuffers",{get:function(){return this._vertexBuffers},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"indexBuffer",{get:function(){return this._indexBuffer},enumerable:!1,configurable:!0}),e.prototype._addFactorGradient=function(t,e,i,r){var s=new o.b3(e,i,r);t.push(s),t.sort((function(t,e){return t.gradient<e.gradient?-1:t.gradient>e.gradient?1:0}))},e.prototype._removeFactorGradient=function(t,e){if(t)for(var i=0,r=0,o=t;r<o.length;r++){if(o[r].gradient===e){t.splice(i,1);break}i++}},e.prototype.addLifeTimeGradient=function(t,e,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,t,e,i),this},e.prototype.removeLifeTimeGradient=function(t){return this._removeFactorGradient(this._lifeTimeGradients,t),this},e.prototype.addSizeGradient=function(t,e,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,t,e,i),this},e.prototype.removeSizeGradient=function(t){return this._removeFactorGradient(this._sizeGradients,t),this},e.prototype.addColorRemapGradient=function(t,e,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,t,e,i),this},e.prototype.removeColorRemapGradient=function(t){return this._removeFactorGradient(this._colorRemapGradients,t),this},e.prototype.addAlphaRemapGradient=function(t,e,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,t,e,i),this},e.prototype.removeAlphaRemapGradient=function(t){return this._removeFactorGradient(this._alphaRemapGradients,t),this},e.prototype.addAngularSpeedGradient=function(t,e,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,t,e,i),this},e.prototype.removeAngularSpeedGradient=function(t){return this._removeFactorGradient(this._angularSpeedGradients,t),this},e.prototype.addVelocityGradient=function(t,e,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,t,e,i),this},e.prototype.removeVelocityGradient=function(t){return this._removeFactorGradient(this._velocityGradients,t),this},e.prototype.addLimitVelocityGradient=function(t,e,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,t,e,i),this},e.prototype.removeLimitVelocityGradient=function(t){return this._removeFactorGradient(this._limitVelocityGradients,t),this},e.prototype.addDragGradient=function(t,e,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,t,e,i),this},e.prototype.removeDragGradient=function(t){return this._removeFactorGradient(this._dragGradients,t),this},e.prototype.addEmitRateGradient=function(t,e,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,t,e,i),this},e.prototype.removeEmitRateGradient=function(t){return this._removeFactorGradient(this._emitRateGradients,t),this},e.prototype.addStartSizeGradient=function(t,e,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,t,e,i),this},e.prototype.removeStartSizeGradient=function(t){return this._removeFactorGradient(this._startSizeGradients,t),this},e.prototype._createRampGradientTexture=function(){if(this._rampGradients&&this._rampGradients.length&&!this._rampGradientsTexture&&this._scene){for(var t=new Uint8Array(4*this._rawTextureWidth),e=v.zZ.Color3[0],i=function(i){var s=i/r._rawTextureWidth;o.fR.GetCurrentGradient(s,r._rampGradients,(function(r,o,s){v.Wo.LerpToRef(r.color,o.color,s,e),t[4*i]=255*e.r,t[4*i+1]=255*e.g,t[4*i+2]=255*e.b,t[4*i+3]=255}))},r=this,s=0;s<this._rawTextureWidth;s++)i(s);this._rampGradientsTexture=c.l.CreateRGBATexture(t,this._rawTextureWidth,1,this._scene,!1,!1,1)}},e.prototype.getRampGradients=function(){return this._rampGradients},e.prototype.forceRefreshGradients=function(){this._syncRampGradientTexture()},e.prototype._syncRampGradientTexture=function(){this._rampGradients&&(this._rampGradients.sort((function(t,e){return t.gradient<e.gradient?-1:t.gradient>e.gradient?1:0})),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())},e.prototype.addRampGradient=function(t,e){this._rampGradients||(this._rampGradients=[]);var i=new o.cw(t,e);return this._rampGradients.push(i),this._syncRampGradientTexture(),this},e.prototype.removeRampGradient=function(t){return this._removeGradientAndTexture(t,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this},e.prototype.addColorGradient=function(t,e,i){this._colorGradients||(this._colorGradients=[]);var r=new o.bK(t,e,i);return this._colorGradients.push(r),this._colorGradients.sort((function(t,e){return t.gradient<e.gradient?-1:t.gradient>e.gradient?1:0})),this},e.prototype.removeColorGradient=function(t){if(!this._colorGradients)return this;for(var e=0,i=0,r=this._colorGradients;i<r.length;i++){if(r[i].gradient===t){this._colorGradients.splice(e,1);break}e++}return this},e.prototype.resetDrawCache=function(){for(var t=0,e=this._drawWrappers;t<e.length;t++){var i=e[t];if(i)for(var r=0,o=i;r<o.length;r++){var s=o[r];null==s||s.dispose()}}this._drawWrappers=[]},e.prototype._fetchR=function(t,e,i,r,o){return o[4*(((t=.5*Math.abs(t)+.5)*i%i|0)+((e=.5*Math.abs(e)+.5)*r%r|0)*i)]/255},e.prototype._reset=function(){this._resetEffect()},e.prototype._resetEffect=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()},e.prototype._createVertexBuffers=function(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),this._isBillboardBased&&this.billboardMode!==e.BILLBOARDMODE_STRETCHED||(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);var t=this._engine,i=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*i),this._vertexBuffer=new h.l(t,this._vertexData,!0,i);var r=0,o=this._vertexBuffer.createVertexBuffer(h.o.PositionKind,r,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[h.o.PositionKind]=o,r+=3;var s=this._vertexBuffer.createVertexBuffer(h.o.ColorKind,r,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[h.o.ColorKind]=s,r+=4;var n=this._vertexBuffer.createVertexBuffer("angle",r,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=n,r+=1;var a,l=this._vertexBuffer.createVertexBuffer("size",r,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=l,r+=2,this._isAnimationSheetEnabled){var c=this._vertexBuffer.createVertexBuffer("cellIndex",r,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=c,r+=1}if(!this._isBillboardBased||this.billboardMode===e.BILLBOARDMODE_STRETCHED){var d=this._vertexBuffer.createVertexBuffer("direction",r,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=d,r+=3}if(this._useRampGradients){var u=this._vertexBuffer.createVertexBuffer("remapData",r,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=u,r+=4}if(this._useInstancing){var p=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new h.l(t,p,!1,2),a=this._spriteBuffer.createVertexBuffer("offset",0,2)}else a=this._vertexBuffer.createVertexBuffer("offset",r,2,this._vertexBufferSize,this._useInstancing),r+=2;this._vertexBuffers.offset=a,this.resetDrawCache()},e.prototype._createIndexBuffer=function(){if(!this._useInstancing){for(var t=[],e=0,i=0;i<this._capacity;i++)t.push(e),t.push(e+1),t.push(e+2),t.push(e),t.push(e+2),t.push(e+3),e+=4;this._indexBuffer=this._engine.createIndexBuffer(t)}},e.prototype.getCapacity=function(){return this._capacity},e.prototype.isAlive=function(){return this._alive},e.prototype.isStarted=function(){return this._started},e.prototype._prepareSubEmitterInternalArray=function(){var t=this;this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach((function(i){i instanceof e?t._subEmitters.push([new f.H(i)]):i instanceof f.H?t._subEmitters.push([i]):i instanceof Array&&t._subEmitters.push(i)}))},e.prototype.start=function(t){var e,i=this;if(void 0===t&&(t=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(t)setTimeout((function(){i.start(0)}),t);else{if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&0!=this._subEmitters.length&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){-1!==(null===(e=this.emitter)||void 0===e?void 0:e.getClassName().indexOf("Mesh"))&&this.emitter.computeWorldMatrix(!0);var r=this.noiseTexture;if(r&&r.onGeneratedObservable)r.onGeneratedObservable.addOnce((function(){setTimeout((function(){for(var t=0;t<i.preWarmCycles;t++)i.animate(!0),r.render()}))}));else for(var o=0;o<this.preWarmCycles;o++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}},e.prototype.stop=function(t){void 0===t&&(t=!0),this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,t&&this._stopSubEmitters())},e.prototype.reset=function(){this._stockParticles=[],this._particles=[]},e.prototype._appendParticleVertex=function(t,i,r,o){var s=t*this._vertexBufferSize;if(this._vertexData[s++]=i.position.x+this.worldOffset.x,this._vertexData[s++]=i.position.y+this.worldOffset.y,this._vertexData[s++]=i.position.z+this.worldOffset.z,this._vertexData[s++]=i.color.r,this._vertexData[s++]=i.color.g,this._vertexData[s++]=i.color.b,this._vertexData[s++]=i.color.a,this._vertexData[s++]=i.angle,this._vertexData[s++]=i.scale.x*i.size,this._vertexData[s++]=i.scale.y*i.size,this._isAnimationSheetEnabled&&(this._vertexData[s++]=i.cellIndex),this._isBillboardBased)this.billboardMode===e.BILLBOARDMODE_STRETCHED&&(this._vertexData[s++]=i.direction.x,this._vertexData[s++]=i.direction.y,this._vertexData[s++]=i.direction.z);else if(i._initialDirection){var a=i._initialDirection;this.isLocal&&(n.P.TransformNormalToRef(a,this._emitterWorldMatrix,n.jp.Vector3[0]),a=n.jp.Vector3[0]),0===a.x&&0===a.z&&(a.x=.001),this._vertexData[s++]=a.x,this._vertexData[s++]=a.y,this._vertexData[s++]=a.z}else{var h=i.direction;this.isLocal&&(n.P.TransformNormalToRef(h,this._emitterWorldMatrix,n.jp.Vector3[0]),h=n.jp.Vector3[0]),0===h.x&&0===h.z&&(h.x=.001),this._vertexData[s++]=h.x,this._vertexData[s++]=h.y,this._vertexData[s++]=h.z}this._useRampGradients&&i.remapData&&(this._vertexData[s++]=i.remapData.x,this._vertexData[s++]=i.remapData.y,this._vertexData[s++]=i.remapData.z,this._vertexData[s++]=i.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(0===r?r=this._epsilon:1===r&&(r=1-this._epsilon),0===o?o=this._epsilon:1===o&&(o=1-this._epsilon)),this._vertexData[s++]=r,this._vertexData[s++]=o)},e.prototype._stopSubEmitters=function(){this.activeSubSystems&&(this.activeSubSystems.forEach((function(t){t.stop(!0)})),this.activeSubSystems=new Array)},e.prototype._removeFromRoot=function(){if(this._rootParticleSystem){var t=this._rootParticleSystem.activeSubSystems.indexOf(this);-1!==t&&this._rootParticleSystem.activeSubSystems.splice(t,1),this._rootParticleSystem=null}},e.prototype._update=function(t){var e,i=this;if(this._alive=this._particles.length>0,this.emitter.position){var r=this.emitter;this._emitterWorldMatrix=r.getWorldMatrix()}else{var s=this.emitter;this._emitterWorldMatrix=n.y3.Translation(s.x,s.y,s.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);for(var h=function(t){if(l._particles.length===l._capacity)return"break";if(e=l._createParticle(),l._particles.push(e),l.targetStopDuration&&l._lifeTimeGradients&&l._lifeTimeGradients.length>0){var r=a.R.Clamp(l._actualFrame/l.targetStopDuration);o.fR.GetCurrentGradient(r,l._lifeTimeGradients,(function(t,i){var o=t,s=i,n=o.getFactor(),h=s.getFactor(),l=(r-o.gradient)/(s.gradient-o.gradient);e.lifeTime=a.R.Lerp(n,h,l)}))}else e.lifeTime=a.R.RandomRange(l.minLifeTime,l.maxLifeTime);var s=a.R.RandomRange(l.minEmitPower,l.maxEmitPower);if(l.startPositionFunction?l.startPositionFunction(l._emitterWorldMatrix,e.position,e,l.isLocal):l.particleEmitterType.startPositionFunction(l._emitterWorldMatrix,e.position,e,l.isLocal),l.isLocal&&(e._localPosition?e._localPosition.copyFrom(e.position):e._localPosition=e.position.clone(),n.P.TransformCoordinatesToRef(e._localPosition,l._emitterWorldMatrix,e.position)),l.startDirectionFunction?l.startDirectionFunction(l._emitterWorldMatrix,e.direction,e,l.isLocal):l.particleEmitterType.startDirectionFunction(l._emitterWorldMatrix,e.direction,e,l.isLocal,l._emitterInverseWorldMatrix),0===s?e._initialDirection?e._initialDirection.copyFrom(e.direction):e._initialDirection=e.direction.clone():e._initialDirection=null,e.direction.scaleInPlace(s),l._sizeGradients&&0!==l._sizeGradients.length?(e._currentSizeGradient=l._sizeGradients[0],e._currentSize1=e._currentSizeGradient.getFactor(),e.size=e._currentSize1,l._sizeGradients.length>1?e._currentSize2=l._sizeGradients[1].getFactor():e._currentSize2=e._currentSize1):e.size=a.R.RandomRange(l.minSize,l.maxSize),e.scale.copyFromFloats(a.R.RandomRange(l.minScaleX,l.maxScaleX),a.R.RandomRange(l.minScaleY,l.maxScaleY)),l._startSizeGradients&&l._startSizeGradients[0]&&l.targetStopDuration){var h=l._actualFrame/l.targetStopDuration;o.fR.GetCurrentGradient(h,l._startSizeGradients,(function(t,r,o){t!==i._currentStartSizeGradient&&(i._currentStartSize1=i._currentStartSize2,i._currentStartSize2=r.getFactor(),i._currentStartSizeGradient=t);var s=a.R.Lerp(i._currentStartSize1,i._currentStartSize2,o);e.scale.scaleInPlace(s)}))}if(l._angularSpeedGradients&&0!==l._angularSpeedGradients.length?(e._currentAngularSpeedGradient=l._angularSpeedGradients[0],e.angularSpeed=e._currentAngularSpeedGradient.getFactor(),e._currentAngularSpeed1=e.angularSpeed,l._angularSpeedGradients.length>1?e._currentAngularSpeed2=l._angularSpeedGradients[1].getFactor():e._currentAngularSpeed2=e._currentAngularSpeed1):e.angularSpeed=a.R.RandomRange(l.minAngularSpeed,l.maxAngularSpeed),e.angle=a.R.RandomRange(l.minInitialRotation,l.maxInitialRotation),l._velocityGradients&&l._velocityGradients.length>0&&(e._currentVelocityGradient=l._velocityGradients[0],e._currentVelocity1=e._currentVelocityGradient.getFactor(),l._velocityGradients.length>1?e._currentVelocity2=l._velocityGradients[1].getFactor():e._currentVelocity2=e._currentVelocity1),l._limitVelocityGradients&&l._limitVelocityGradients.length>0&&(e._currentLimitVelocityGradient=l._limitVelocityGradients[0],e._currentLimitVelocity1=e._currentLimitVelocityGradient.getFactor(),l._limitVelocityGradients.length>1?e._currentLimitVelocity2=l._limitVelocityGradients[1].getFactor():e._currentLimitVelocity2=e._currentLimitVelocity1),l._dragGradients&&l._dragGradients.length>0&&(e._currentDragGradient=l._dragGradients[0],e._currentDrag1=e._currentDragGradient.getFactor(),l._dragGradients.length>1?e._currentDrag2=l._dragGradients[1].getFactor():e._currentDrag2=e._currentDrag1),l._colorGradients&&0!==l._colorGradients.length)e._currentColorGradient=l._colorGradients[0],e._currentColorGradient.getColorToRef(e.color),e._currentColor1.copyFrom(e.color),l._colorGradients.length>1?l._colorGradients[1].getColorToRef(e._currentColor2):e._currentColor2.copyFrom(e.color);else{var c=a.R.RandomRange(0,1);v.HE.LerpToRef(l.color1,l.color2,c,e.color),l.colorDead.subtractToRef(e.color,l._colorDiff),l._colorDiff.scaleToRef(1/e.lifeTime,e.colorStep)}l._isAnimationSheetEnabled&&(e._initialStartSpriteCellID=l.startSpriteCellID,e._initialEndSpriteCellID=l.endSpriteCellID,e._initialSpriteCellLoop=l.spriteCellLoop),e.direction.addInPlace(l._inheritedVelocityOffset),l._useRampGradients&&(e.remapData=new n.Lt(0,1,0,1)),l.noiseTexture&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),e._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(e._randomNoiseCoordinates1=new n.P(Math.random(),Math.random(),Math.random()),e._randomNoiseCoordinates2=new n.P(Math.random(),Math.random(),Math.random()))),e._inheritParticleInfoToSubEmitters()},l=this,c=0;c<t;c++){if("break"===h())break}},e._GetAttributeNamesOrOptions=function(t,e,i){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===i&&(i=!1);var r=[h.o.PositionKind,h.o.ColorKind,"angle","offset","size"];return t&&r.push("cellIndex"),e||r.push("direction"),i&&r.push("remapData"),r},e._GetEffectCreationOptions=function(t){void 0===t&&(t=!1);var e=["invView","view","projection","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","textureMask","translationPivot","eyePosition"];return t&&e.push("particlesInfos"),e},e.prototype.fillDefines=function(t,i){if(this._scene&&(this._scene.clipPlane&&t.push("#define CLIPPLANE"),this._scene.clipPlane2&&t.push("#define CLIPPLANE2"),this._scene.clipPlane3&&t.push("#define CLIPPLANE3"),this._scene.clipPlane4&&t.push("#define CLIPPLANE4"),this._scene.clipPlane5&&t.push("#define CLIPPLANE5"),this._scene.clipPlane6&&t.push("#define CLIPPLANE6")),this._isAnimationSheetEnabled&&t.push("#define ANIMATESHEET"),i===e.BLENDMODE_MULTIPLY&&t.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&t.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(t.push("#define BILLBOARD"),this.billboardMode){case e.BILLBOARDMODE_Y:t.push("#define BILLBOARDY");break;case e.BILLBOARDMODE_STRETCHED:t.push("#define BILLBOARDSTRETCHED");break;case e.BILLBOARDMODE_ALL:t.push("#define BILLBOARDMODE_ALL")}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),t.push(this._imageProcessingConfigurationDefines.toString()))},e.prototype.fillUniformsAttributesAndSamplerNames=function(t,i,r){i.push.apply(i,e._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==e.BILLBOARDMODE_STRETCHED,this._useRampGradients)),t.push.apply(t,e._GetEffectCreationOptions(this._isAnimationSheetEnabled)),r.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(l.$.PrepareUniforms(t,this._imageProcessingConfigurationDefines),l.$.PrepareSamplers(r,this._imageProcessingConfigurationDefines))},e.prototype._getWrapper=function(t){var e=this._getCustomDrawWrapper(t);if(null==e?void 0:e.effect)return e;var i=[];this.fillDefines(i,t);var r=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0,o=this._drawWrappers[r];o||(o=this._drawWrappers[r]=[]);var s=o[t];s||((s=new y.q(this._engine)).drawContext&&(s.drawContext.useInstancing=this._useInstancing),o[t]=s);var n=i.join("\n");if(s.defines!==n){var a=[],h=[],l=[];this.fillUniformsAttributesAndSamplerNames(h,a,l),s.setEffect(this._engine.createEffect("particles",a,h,l,n),n)}return s},e.prototype.animate=function(t){var e,i=this;if(void 0===t&&(t=!1),this._started){if(!t&&this._scene){if(!this.isReady())return;if(this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}var r;if(this._scaledUpdateSpeed=this.updateSpeed*(t?this.preWarmStepOffset:(null===(e=this._scene)||void 0===e?void 0:e.getAnimationRatio())||1),this.manualEmitCount>-1)r=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{var s=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){var n=this._actualFrame/this.targetStopDuration;o.fR.GetCurrentGradient(n,this._emitRateGradients,(function(t,e,r){t!==i._currentEmitRateGradient&&(i._currentEmitRate1=i._currentEmitRate2,i._currentEmitRate2=e.getFactor(),i._currentEmitRateGradient=t),s=a.R.Lerp(i._currentEmitRate1,i._currentEmitRate2,r)}))}r=s*this._scaledUpdateSpeed>>0,this._newPartsExcess+=s*this._scaledUpdateSpeed-r}if(this._newPartsExcess>1&&(r+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?r=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(r),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!t){for(var h=0,l=0;l<this._particles.length;l++){var c=this._particles[l];this._appendParticleVertices(h,c),h+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}0===this.manualEmitCount&&this.disposeOnStop&&this.stop()}},e.prototype._appendParticleVertices=function(t,e){this._appendParticleVertex(t++,e,0,0),this._useInstancing||(this._appendParticleVertex(t++,e,1,0),this._appendParticleVertex(t++,e,1,1),this._appendParticleVertex(t++,e,0,1))},e.prototype.rebuild=function(){var t,e;for(var i in this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),null===(t=this._spriteBuffer)||void 0===t||t._rebuild(),null===(e=this._vertexBuffer)||void 0===e||e._rebuild(),this._vertexBuffers)this._vertexBuffers[i]._rebuild();this.resetDrawCache()},e.prototype.isReady=function(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==e.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else{if(!this._getWrapper(e.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this._getWrapper(e.BLENDMODE_ADD).effect.isReady())return!1}return!0},e.prototype._render=function(t){var i,r,o=this._getWrapper(t),s=o.effect,a=this._engine;a.enableEffect(o);var h=null!==(i=this.defaultViewMatrix)&&void 0!==i?i:this._scene.getViewMatrix();if(s.setTexture("diffuseSampler",this.particleTexture),s.setMatrix("view",h),s.setMatrix("projection",null!==(r=this.defaultProjectionMatrix)&&void 0!==r?r:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){var l=this.particleTexture.getBaseSize();s.setFloat3("particlesInfos",this.spriteCellWidth/l.width,this.spriteCellHeight/l.height,this.spriteCellWidth/l.width)}if(s.setVector2("translationPivot",this.translationPivot),s.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){var c=this._scene.activeCamera;s.setVector3("eyePosition",c.globalPosition)}this._rampGradientsTexture&&(this._rampGradients&&this._rampGradients.length||(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),s.setTexture("rampSampler",this._rampGradientsTexture));var d=s.defines;switch(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&b.O.BindClipPlane(s,this._scene),d.indexOf("#define BILLBOARDMODE_ALL")>=0&&(h.invertToRef(n.jp.Matrix[0]),s.setMatrix("invView",n.jp.Matrix[0])),void 0!==this._vertexArrayObject?(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,s)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):a.bindBuffers(this._vertexBuffers,this._indexBuffer,s),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(s),t){case e.BLENDMODE_ADD:a.setAlphaMode(1);break;case e.BLENDMODE_ONEONE:a.setAlphaMode(6);break;case e.BLENDMODE_STANDARD:a.setAlphaMode(2);break;case e.BLENDMODE_MULTIPLY:a.setAlphaMode(4)}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(s),this._useInstancing?a.drawArraysType(7,0,4,this._particles.length):a.drawElementsType(0,0,6*this._particles.length),this._particles.length},e.prototype.render=function(){if(!this.isReady()||!this._particles.length)return 0;var t=this._engine;t.setState&&(t.setState(!1),this.forceDepthWrite&&t.setDepthWrite(!0));var i=0;return i=this.blendMode===e.BLENDMODE_MULTIPLYADD?this._render(e.BLENDMODE_MULTIPLY)+this._render(e.BLENDMODE_ADD):this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),i},e.prototype.dispose=function(t){if(void 0===t&&(t=!0),this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),t&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),t&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length){for(var e=0;e<this._subEmitters.length;e++)for(var i=0,r=this._subEmitters[e];i<r.length;i++){r[i].dispose()}this._subEmitters=[],this.subEmitters=[]}(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene)&&((e=this._scene.particleSystems.indexOf(this))>-1&&this._scene.particleSystems.splice(e,1),this._scene._activeParticleSystems.dispose());this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()},e.prototype.clone=function(t,i){var o=(0,r.pi)({},this._customWrappers),s=null,n=this._engine;if(n.createEffectForParticles&&null!=this.customShader){var a=(s=this.customShader).shaderOptions.defines.length>0?s.shaderOptions.defines.join("\n"):"",h=n.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,a);o[0]?o[0].effect=h:this.setCustomEffect(h,0)}var l=this.serialize(),c=e.Parse(l,this._scene||this._engine,this._rootUrl);return c.name=t,c.customShader=s,c._customWrappers=o,void 0===i&&(i=this.emitter),this.noiseTexture&&(c.noiseTexture=this.noiseTexture.clone()),c.emitter=i,this.preventAutoStart||c.start(),c},e.prototype.serialize=function(t){void 0===t&&(t=!1);var i={};if(e._Serialize(i,this,t),i.textureMask=this.textureMask.asArray(),i.customShader=this.customShader,i.preventAutoStart=this.preventAutoStart,this.subEmitters){i.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(var r=0,o=this._subEmitters;r<o.length;r++){for(var s=[],n=0,a=o[r];n<a.length;n++){var h=a[n];s.push(h.serialize(t))}i.subEmitters.push(s)}}return i},e._Serialize=function(t,e,i){if(t.name=e.name,t.id=e.id,t.capacity=e.getCapacity(),t.disposeOnStop=e.disposeOnStop,t.manualEmitCount=e.manualEmitCount,e.emitter.position){var r=e.emitter;t.emitterId=r.id}else{var o=e.emitter;t.emitter=o.asArray()}e.particleEmitterType&&(t.particleEmitterType=e.particleEmitterType.serialize()),e.particleTexture&&(i?t.texture=e.particleTexture.serialize():(t.textureName=e.particleTexture.name,t.invertY=!!e.particleTexture._invertY)),t.isLocal=e.isLocal,_.p4.AppendSerializedAnimations(e,t),t.beginAnimationOnStart=e.beginAnimationOnStart,t.beginAnimationFrom=e.beginAnimationFrom,t.beginAnimationTo=e.beginAnimationTo,t.beginAnimationLoop=e.beginAnimationLoop,t.startDelay=e.startDelay,t.renderingGroupId=e.renderingGroupId,t.isBillboardBased=e.isBillboardBased,t.billboardMode=e.billboardMode,t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,t.minScaleX=e.minScaleX,t.maxScaleX=e.maxScaleX,t.minScaleY=e.minScaleY,t.maxScaleY=e.maxScaleY,t.minEmitPower=e.minEmitPower,t.maxEmitPower=e.maxEmitPower,t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.emitRate=e.emitRate,t.gravity=e.gravity.asArray(),t.noiseStrength=e.noiseStrength.asArray(),t.color1=e.color1.asArray(),t.color2=e.color2.asArray(),t.colorDead=e.colorDead.asArray(),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopDuration,t.blendMode=e.blendMode,t.preWarmCycles=e.preWarmCycles,t.preWarmStepOffset=e.preWarmStepOffset,t.minInitialRotation=e.minInitialRotation,t.maxInitialRotation=e.maxInitialRotation,t.startSpriteCellID=e.startSpriteCellID,t.spriteCellLoop=e.spriteCellLoop,t.endSpriteCellID=e.endSpriteCellID,t.spriteCellChangeSpeed=e.spriteCellChangeSpeed,t.spriteCellWidth=e.spriteCellWidth,t.spriteCellHeight=e.spriteCellHeight,t.spriteRandomStartCell=e.spriteRandomStartCell,t.isAnimationSheetEnabled=e.isAnimationSheetEnabled;var s=e.getColorGradients();if(s){t.colorGradients=[];for(var n=0,a=s;n<a.length;n++){var h=a[n],l={gradient:h.gradient,color1:h.color1.asArray()};h.color2?l.color2=h.color2.asArray():l.color2=h.color1.asArray(),t.colorGradients.push(l)}}var c=e.getRampGradients();if(c){t.rampGradients=[];for(var d=0,u=c;d<u.length;d++){var p=u[d];l={gradient:p.gradient,color:p.color.asArray()};t.rampGradients.push(l)}t.useRampGradients=e.useRampGradients}var m=e.getColorRemapGradients();if(m){t.colorRemapGradients=[];for(var f=0,g=m;f<g.length;f++){var y=g[f];l={gradient:y.gradient,factor1:y.factor1};void 0!==y.factor2?l.factor2=y.factor2:l.factor2=y.factor1,t.colorRemapGradients.push(l)}}var v=e.getAlphaRemapGradients();if(v){t.alphaRemapGradients=[];for(var x=0,b=v;x<b.length;x++){var S=b[x];l={gradient:S.gradient,factor1:S.factor1};void 0!==S.factor2?l.factor2=S.factor2:l.factor2=S.factor1,t.alphaRemapGradients.push(l)}}var P=e.getSizeGradients();if(P){t.sizeGradients=[];for(var R=0,T=P;R<T.length;R++){var A=T[R];l={gradient:A.gradient,factor1:A.factor1};void 0!==A.factor2?l.factor2=A.factor2:l.factor2=A.factor1,t.sizeGradients.push(l)}}var C=e.getAngularSpeedGradients();if(C){t.angularSpeedGradients=[];for(var G=0,B=C;G<B.length;G++){var E=B[G];l={gradient:E.gradient,factor1:E.factor1};void 0!==E.factor2?l.factor2=E.factor2:l.factor2=E.factor1,t.angularSpeedGradients.push(l)}}var D=e.getVelocityGradients();if(D){t.velocityGradients=[];for(var M=0,I=D;M<I.length;M++){var V=I[M];l={gradient:V.gradient,factor1:V.factor1};void 0!==V.factor2?l.factor2=V.factor2:l.factor2=V.factor1,t.velocityGradients.push(l)}}var w=e.getDragGradients();if(w){t.dragGradients=[];for(var z=0,O=w;z<O.length;z++){var F=O[z];l={gradient:F.gradient,factor1:F.factor1};void 0!==F.factor2?l.factor2=F.factor2:l.factor2=F.factor1,t.dragGradients.push(l)}}var L=e.getEmitRateGradients();if(L){t.emitRateGradients=[];for(var j=0,N=L;j<N.length;j++){var U=N[j];l={gradient:U.gradient,factor1:U.factor1};void 0!==U.factor2?l.factor2=U.factor2:l.factor2=U.factor1,t.emitRateGradients.push(l)}}var W=e.getStartSizeGradients();if(W){t.startSizeGradients=[];for(var k=0,H=W;k<H.length;k++){var Y=H[k];l={gradient:Y.gradient,factor1:Y.factor1};void 0!==Y.factor2?l.factor2=Y.factor2:l.factor2=Y.factor1,t.startSizeGradients.push(l)}}var Q=e.getLifeTimeGradients();if(Q){t.lifeTimeGradients=[];for(var Z=0,K=Q;Z<K.length;Z++){var q=K[Z];l={gradient:q.gradient,factor1:q.factor1};void 0!==q.factor2?l.factor2=q.factor2:l.factor2=q.factor1,t.lifeTimeGradients.push(l)}}var X=e.getLimitVelocityGradients();if(X){t.limitVelocityGradients=[];for(var J=0,$=X;J<$.length;J++){var tt=$[J];l={gradient:tt.gradient,factor1:tt.factor1};void 0!==tt.factor2?l.factor2=tt.factor2:l.factor2=tt.factor1,t.limitVelocityGradients.push(l)}t.limitVelocityDamping=e.limitVelocityDamping}e.noiseTexture&&(t.noiseTexture=e.noiseTexture.serialize())},e._Parse=function(t,e,i,r){var o,s,a,h;h=i instanceof x.B?null:i;var l,c=(0,g.q)("BABYLON.Texture");if(c&&h&&(t.texture?e.particleTexture=c.Parse(t.texture,h,r):t.textureName&&(e.particleTexture=new c(r+t.textureName,h,!1,void 0===t.invertY||t.invertY),e.particleTexture.name=t.textureName)),t.emitterId||0===t.emitterId||void 0!==t.emitter?t.emitterId&&h?e.emitter=h.getLastMeshById(t.emitterId):e.emitter=n.P.FromArray(t.emitter):e.emitter=n.P.Zero(),e.isLocal=!!t.isLocal,void 0!==t.renderingGroupId&&(e.renderingGroupId=t.renderingGroupId),void 0!==t.isBillboardBased&&(e.isBillboardBased=t.isBillboardBased),void 0!==t.billboardMode&&(e.billboardMode=t.billboardMode),t.animations){for(var d=0;d<t.animations.length;d++){var p=t.animations[d],m=(0,g.q)("BABYLON.Animation");m&&e.animations.push(m.Parse(p))}e.beginAnimationOnStart=t.beginAnimationOnStart,e.beginAnimationFrom=t.beginAnimationFrom,e.beginAnimationTo=t.beginAnimationTo,e.beginAnimationLoop=t.beginAnimationLoop}if(t.autoAnimate&&h&&h.beginAnimation(e,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),e.startDelay=0|t.startDelay,e.minAngularSpeed=t.minAngularSpeed,e.maxAngularSpeed=t.maxAngularSpeed,e.minSize=t.minSize,e.maxSize=t.maxSize,t.minScaleX&&(e.minScaleX=t.minScaleX,e.maxScaleX=t.maxScaleX,e.minScaleY=t.minScaleY,e.maxScaleY=t.maxScaleY),void 0!==t.preWarmCycles&&(e.preWarmCycles=t.preWarmCycles,e.preWarmStepOffset=t.preWarmStepOffset),void 0!==t.minInitialRotation&&(e.minInitialRotation=t.minInitialRotation,e.maxInitialRotation=t.maxInitialRotation),e.minLifeTime=t.minLifeTime,e.maxLifeTime=t.maxLifeTime,e.minEmitPower=t.minEmitPower,e.maxEmitPower=t.maxEmitPower,e.emitRate=t.emitRate,e.gravity=n.P.FromArray(t.gravity),t.noiseStrength&&(e.noiseStrength=n.P.FromArray(t.noiseStrength)),e.color1=v.HE.FromArray(t.color1),e.color2=v.HE.FromArray(t.color2),e.colorDead=v.HE.FromArray(t.colorDead),e.updateSpeed=t.updateSpeed,e.targetStopDuration=t.targetStopDuration,e.blendMode=t.blendMode,t.colorGradients)for(var f=0,_=t.colorGradients;f<_.length;f++){var y=_[f];e.addColorGradient(y.gradient,v.HE.FromArray(y.color1),y.color2?v.HE.FromArray(y.color2):void 0)}if(t.rampGradients){for(var b=0,S=t.rampGradients;b<S.length;b++){var P=S[b];e.addRampGradient(P.gradient,v.Wo.FromArray(P.color))}e.useRampGradients=t.useRampGradients}if(t.colorRemapGradients)for(var R=0,T=t.colorRemapGradients;R<T.length;R++){var A=T[R];e.addColorRemapGradient(A.gradient,void 0!==A.factor1?A.factor1:A.factor,A.factor2)}if(t.alphaRemapGradients)for(var C=0,G=t.alphaRemapGradients;C<G.length;C++){var B=G[C];e.addAlphaRemapGradient(B.gradient,void 0!==B.factor1?B.factor1:B.factor,B.factor2)}if(t.sizeGradients)for(var E=0,D=t.sizeGradients;E<D.length;E++){var M=D[E];e.addSizeGradient(M.gradient,void 0!==M.factor1?M.factor1:M.factor,M.factor2)}if(t.angularSpeedGradients)for(var I=0,V=t.angularSpeedGradients;I<V.length;I++){var w=V[I];e.addAngularSpeedGradient(w.gradient,void 0!==w.factor1?w.factor1:w.factor,w.factor2)}if(t.velocityGradients)for(var z=0,O=t.velocityGradients;z<O.length;z++){var F=O[z];e.addVelocityGradient(F.gradient,void 0!==F.factor1?F.factor1:F.factor,F.factor2)}if(t.dragGradients)for(var L=0,j=t.dragGradients;L<j.length;L++){var N=j[L];e.addDragGradient(N.gradient,void 0!==N.factor1?N.factor1:N.factor,N.factor2)}if(t.emitRateGradients)for(var U=0,W=t.emitRateGradients;U<W.length;U++){var k=W[U];e.addEmitRateGradient(k.gradient,void 0!==k.factor1?k.factor1:k.factor,k.factor2)}if(t.startSizeGradients)for(var H=0,Y=t.startSizeGradients;H<Y.length;H++){var Q=Y[H];e.addStartSizeGradient(Q.gradient,void 0!==Q.factor1?Q.factor1:Q.factor,Q.factor2)}if(t.lifeTimeGradients)for(var Z=0,K=t.lifeTimeGradients;Z<K.length;Z++){var q=K[Z];e.addLifeTimeGradient(q.gradient,void 0!==q.factor1?q.factor1:q.factor,q.factor2)}if(t.limitVelocityGradients){for(var X=0,J=t.limitVelocityGradients;X<J.length;X++){var $=J[X];e.addLimitVelocityGradient($.gradient,void 0!==$.factor1?$.factor1:$.factor,$.factor2)}e.limitVelocityDamping=t.limitVelocityDamping}if(t.noiseTexture&&h){var tt=(0,g.q)("BABYLON.ProceduralTexture");e.noiseTexture=tt.Parse(t.noiseTexture,h,r)}if(t.particleEmitterType){switch(t.particleEmitterType.type){case"SphereParticleEmitter":l=new u.Ai;break;case"SphereDirectedParticleEmitter":l=new u.cE;break;case"ConeEmitter":case"ConeParticleEmitter":l=new u.LV;break;case"CylinderParticleEmitter":l=new u.kT;break;case"CylinderDirectedParticleEmitter":l=new u.z;break;case"HemisphericParticleEmitter":l=new u.VD;break;case"PointParticleEmitter":l=new u.cl;break;case"MeshParticleEmitter":l=new u.F3;break;default:l=new u.S3}l.parse(t.particleEmitterType,h)}else(l=new u.S3).parse(t,h);e.particleEmitterType=l,e.startSpriteCellID=t.startSpriteCellID,e.endSpriteCellID=t.endSpriteCellID,e.spriteCellLoop=null===(o=t.spriteCellLoop)||void 0===o||o,e.spriteCellWidth=t.spriteCellWidth,e.spriteCellHeight=t.spriteCellHeight,e.spriteCellChangeSpeed=t.spriteCellChangeSpeed,e.spriteRandomStartCell=t.spriteRandomStartCell,e.disposeOnStop=null!==(s=t.disposeOnStop)&&void 0!==s&&s,e.manualEmitCount=null!==(a=t.manualEmitCount)&&void 0!==a?a:-1},e.Parse=function(t,i,r,o,s){void 0===o&&(o=!1);var n,a=t.name,h=null,l=null;if(n=i instanceof x.B?i:i.getEngine(),t.customShader&&n.createEffectForParticles){var c=(l=t.customShader).shaderOptions.defines.length>0?l.shaderOptions.defines.join("\n"):"";h=n.createEffectForParticles(l.shaderPath.fragmentElement,l.shaderOptions.uniforms,l.shaderOptions.samplers,c)}var d=new e(a,s||t.capacity,i,h,t.isAnimationSheetEnabled);if(d.customShader=l,d._rootUrl=r,t.id&&(d.id=t.id),t.subEmitters){d.subEmitters=[];for(var u=0,p=t.subEmitters;u<p.length;u++){for(var m=[],_=0,g=p[u];_<g.length;_++){var y=g[_];m.push(f.H.Parse(y,i,r))}d.subEmitters.push(m)}}return e._Parse(t,d,i,r),t.textureMask&&(d.textureMask=v.HE.FromArray(t.textureMask)),t.preventAutoStart&&(d.preventAutoStart=t.preventAutoStart),o||d.preventAutoStart||d.start(),d},e.BILLBOARDMODE_Y=2,e.BILLBOARDMODE_ALL=7,e.BILLBOARDMODE_STRETCHED=8,e}(p.U));f.H._ParseParticleSystem=S.Parse},45680:(t,e,i)=>{i.d(e,{H:()=>a,l:()=>r});var r,o=i(58095),s=i(77851),n=i(48620);!function(t){t[t.ATTACHED=0]="ATTACHED",t[t.END=1]="END"}(r||(r={}));var a=function(){function t(t){if(this.particleSystem=t,this.type=r.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!t.emitter||!t.emitter.dispose){var e=(0,n.q)("BABYLON.AbstractMesh");t.emitter=new e("SubemitterSystemEmitter",t.getScene()),t._disposeEmitterOnDispose=!0}}return t.prototype.clone=function(){var e=this.particleSystem.emitter;if(e){if(e instanceof o.P)e=e.clone();else if(-1!==e.getClassName().indexOf("Mesh")){(e=new((0,n.q)("BABYLON.Mesh"))("",e.getScene())).isVisible=!1}}else e=new o.P;var i=new t(this.particleSystem.clone(this.particleSystem.name,e));return i.particleSystem.name+="Clone",i.type=this.type,i.inheritDirection=this.inheritDirection,i.inheritedVelocityAmount=this.inheritedVelocityAmount,i.particleSystem._disposeEmitterOnDispose=!0,i.particleSystem.disposeOnStop=!0,i},t.prototype.serialize=function(t){void 0===t&&(t=!1);var e={};return e.type=this.type,e.inheritDirection=this.inheritDirection,e.inheritedVelocityAmount=this.inheritedVelocityAmount,e.particleSystem=this.particleSystem.serialize(t),e},t._ParseParticleSystem=function(t,e,i,r){throw void 0===r&&(r=!1),(0,s.S)("ParseParticle")},t.Parse=function(e,i,r){var o=e.particleSystem,s=new t(t._ParseParticleSystem(o,i,r,!0));return s.type=e.type,s.inheritDirection=e.inheritDirection,s.inheritedVelocityAmount=e.inheritedVelocityAmount,s.particleSystem._isSubEmitter=!0,s},t.prototype.dispose=function(){this.particleSystem.dispose()},t}()},78740:()=>{},35731:(t,e,i)=>{i.d(e,{b:()=>m});var r=i(58095),o=i(84318),s=i(18737),n=i(7968),a=i(72208),h=i(89209),l=i(75159),c=i(9866),d=i(60604),u=i(72739),p=i(48154),m=function(){function t(t,e,i){void 0===t&&(t=!0),void 0===e&&(e=Ammo),void 0===i&&(i=null);var s=this;this._useDeltaForWorldStep=t,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new r._f,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new r.P,this._tmpVec3=new r.P,this._tmpMatrix=new r.y3,"function"!=typeof e?(this.bjsAMMO=e,this.isSupported()?(this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=i||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=function(t){var e=(t=s.bjsAMMO.wrapPointer(t,s.bjsAMMO.btManifoldPoint)).getPositionWorldOnA();s._tmpContactPoint.x=e.x(),s._tmpContactPoint.y=e.y(),s._tmpContactPoint.z=e.z(),s._tmpContactCallbackResult=!0},this._raycastResult=new d.d,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)):o.Y.Error("AmmoJS is not available. Please make sure you included the js file.")):o.Y.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.")}return t.prototype.setGravity=function(t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)},t.prototype.setTimeStep=function(t){this._timeStep=t},t.prototype.setFixedTimeStep=function(t){this._fixedTimeStep=t},t.prototype.setMaxSteps=function(t){this._maxSteps=t},t.prototype.getTimeStep=function(){return this._timeStep},t.prototype._isImpostorInContact=function(t){return this._tmpContactCallbackResult=!1,this.world.contactTest(t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult},t.prototype._isImpostorPairInContact=function(t,e){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(t.physicsBody,e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult},t.prototype._stepSimulation=function(t,e,i){if(void 0===t&&(t=1/60),void 0===e&&(e=10),void 0===i&&(i=1/60),0==e)this.world.stepSimulation(t,0);else for(;e>0&&t>0;)t-i<i?(this.world.stepSimulation(t,0),t=0):(t-=i,this.world.stepSimulation(i,0)),e--},t.prototype.executeStep=function(t,e){for(var i=0,r=e;i<r.length;i++){var o=r[i];o.soft||o.beforeStep()}this._stepSimulation(this._useDeltaForWorldStep?t:this._timeStep,this._maxSteps,this._fixedTimeStep);for(var s=0,n=e;s<n.length;s++){var a=n[s];if(a.soft?this._afterSoftStep(a):a.afterStep(),a._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(a))for(var h=0,l=a._onPhysicsCollideCallbacks;h<l.length;h++)for(var c=0,d=l[h].otherImpostors;c<d.length;c++){var u=d[c];(a.physicsBody.isActive()||u.physicsBody.isActive())&&this._isImpostorPairInContact(a,u)&&(a.onCollide({body:u.physicsBody,point:this._tmpContactPoint}),u.onCollide({body:a.physicsBody,point:this._tmpContactPoint}))}}},t.prototype._afterSoftStep=function(t){t.type===s.Q.RopeImpostor?this._ropeStep(t):this._softbodyOrClothStep(t)},t.prototype._ropeStep=function(t){for(var e,i,o,s,n=t.physicsBody.get_m_nodes(),a=n.size(),h=new Array,d=0;d<a;d++)i=(e=n.at(d).get_m_x()).x(),o=e.y(),s=e.z(),h.push(new r.P(i,o,s));var u=t.object,p=t.getParam("shape");t._isFromLine?t.object=(0,c.nL)("lines",{points:h,instance:u}):t.object=(0,l.Gc)("ext",{shape:p,path:h,instance:u})},t.prototype._softbodyOrClothStep=function(t){var e=t.type===s.Q.ClothImpostor?1:-1,i=t.object,r=i.getVerticesData(a.o.PositionKind);r||(r=[]);var o=i.getVerticesData(a.o.NormalKind);o||(o=[]);for(var n,l,c,d,u,p,m,f,_=r.length/3,g=t.physicsBody.get_m_nodes(),y=0;y<_;y++){c=(l=(n=g.at(y)).get_m_x()).x(),d=l.y(),u=l.z()*e;var v=n.get_m_n();p=v.x(),m=v.y(),f=v.z()*e,r[3*y]=c,r[3*y+1]=d,r[3*y+2]=u,o[3*y]=p,o[3*y+1]=m,o[3*y+2]=f}var x=new h.x;x.positions=r,x.normals=o,x.uvs=i.getVerticesData(a.o.UVKind),x.colors=i.getVerticesData(a.o.ColorKind),i&&i.getIndices&&(x.indices=i.getIndices()),x.applyToMesh(i)},t.prototype.applyImpulse=function(t,e,i){if(t.soft)o.Y.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();var r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;t.object&&t.object.getWorldMatrix&&i.subtractInPlace(t.object.getWorldMatrix().getTranslation()),r.setValue(i.x,i.y,i.z),s.setValue(e.x,e.y,e.z),t.physicsBody.applyImpulse(s,r)}},t.prototype.applyForce=function(t,e,i){if(t.soft)o.Y.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();var r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;if(t.object&&t.object.getWorldMatrix){var n=t.object.getWorldMatrix().getTranslation();r.setValue(i.x-n.x,i.y-n.y,i.z-n.z)}else r.setValue(i.x,i.y,i.z);s.setValue(e.x,e.y,e.z),t.physicsBody.applyForce(s,r)}},t.prototype.generatePhysicsBody=function(e){if(e._pluginData.toDispose=[],e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else if(e.isBodyInitRequired()){var i=this._createShape(e),r=e.getParam("mass");if(e._pluginData.mass=r,e.soft)i.get_m_cfg().set_collisions(17),i.get_m_cfg().set_kDP(e.getParam("damping")),this.bjsAMMO.castObject(i,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(e.getParam("margin")),i.setActivationState(t._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(i,1,-1),e.physicsBody=i,e._pluginData.toDispose.push(i),this.setBodyPressure(e,0),e.type===s.Q.SoftbodyImpostor&&this.setBodyPressure(e,e.getParam("pressure")),this.setBodyStiffness(e,e.getParam("stiffness")),this.setBodyVelocityIterations(e,e.getParam("velocityIterations")),this.setBodyPositionIterations(e,e.getParam("positionIterations"));else{var o=new this.bjsAMMO.btVector3(0,0,0),n=new this.bjsAMMO.btTransform;e.object.computeWorldMatrix(!0),n.setIdentity(),0!==r&&i.calculateLocalInertia(r,o),this._tmpAmmoVectorA.setValue(e.object.position.x,e.object.position.y,e.object.position.z),this._tmpAmmoQuaternion.setValue(e.object.rotationQuaternion.x,e.object.rotationQuaternion.y,e.object.rotationQuaternion.z,e.object.rotationQuaternion.w),n.setOrigin(this._tmpAmmoVectorA),n.setRotation(this._tmpAmmoQuaternion);var a=new this.bjsAMMO.btDefaultMotionState(n),h=new this.bjsAMMO.btRigidBodyConstructionInfo(r,a,i,o),l=new this.bjsAMMO.btRigidBody(h);if(0===r&&(l.setCollisionFlags(l.getCollisionFlags()|t._KINEMATIC_FLAG),l.setActivationState(t._DISABLE_DEACTIVATION_FLAG)),e.type!=s.Q.NoImpostor||i.getChildShape||l.setCollisionFlags(l.getCollisionFlags()|t._DISABLE_COLLISION_FLAG),e.type!==s.Q.MeshImpostor&&e.type!==s.Q.NoImpostor){var c=e.object.getBoundingInfo();this._tmpVec3.copyFrom(e.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(c.boundingBox.centerWorld),this._tmpVec3.x/=e.object.scaling.x,this._tmpVec3.y/=e.object.scaling.y,this._tmpVec3.z/=e.object.scaling.z,e.setDeltaPosition(this._tmpVec3)}var d=e.getParam("group"),u=e.getParam("mask");d&&u?this.world.addRigidBody(l,d,u):this.world.addRigidBody(l),e.physicsBody=l,e._pluginData.toDispose=e._pluginData.toDispose.concat([l,h,a,n,o,i])}this.setBodyRestitution(e,e.getParam("restitution")),this.setBodyFriction(e,e.getParam("friction"))}},t.prototype.removePhysicsBody=function(t){var e=this;this.world&&(t.soft?this.world.removeSoftBody(t.physicsBody):this.world.removeRigidBody(t.physicsBody),t._pluginData&&(t._pluginData.toDispose.forEach((function(t){e.bjsAMMO.destroy(t)})),t._pluginData.toDispose=[]))},t.prototype.generateJoint=function(t){var e=t.mainImpostor.physicsBody,i=t.connectedImpostor.physicsBody;if(e&&i){var s,a=t.joint.jointData;switch(a.mainPivot||(a.mainPivot=new r.P(0,0,0)),a.connectedPivot||(a.connectedPivot=new r.P(0,0,0)),t.joint.type){case n.q7.DistanceJoint:var h=a.maxDistance;h&&(a.mainPivot=new r.P(0,-h/2,0),a.connectedPivot=new r.P(0,h/2,0)),s=new this.bjsAMMO.btPoint2PointConstraint(e,i,new this.bjsAMMO.btVector3(a.mainPivot.x,a.mainPivot.y,a.mainPivot.z),new this.bjsAMMO.btVector3(a.connectedPivot.x,a.connectedPivot.y,a.connectedPivot.z));break;case n.q7.HingeJoint:a.mainAxis||(a.mainAxis=new r.P(0,0,0)),a.connectedAxis||(a.connectedAxis=new r.P(0,0,0));var l=new this.bjsAMMO.btVector3(a.mainAxis.x,a.mainAxis.y,a.mainAxis.z),c=new this.bjsAMMO.btVector3(a.connectedAxis.x,a.connectedAxis.y,a.connectedAxis.z);s=new this.bjsAMMO.btHingeConstraint(e,i,new this.bjsAMMO.btVector3(a.mainPivot.x,a.mainPivot.y,a.mainPivot.z),new this.bjsAMMO.btVector3(a.connectedPivot.x,a.connectedPivot.y,a.connectedPivot.z),l,c);break;case n.q7.BallAndSocketJoint:s=new this.bjsAMMO.btPoint2PointConstraint(e,i,new this.bjsAMMO.btVector3(a.mainPivot.x,a.mainPivot.y,a.mainPivot.z),new this.bjsAMMO.btVector3(a.connectedPivot.x,a.connectedPivot.y,a.connectedPivot.z));break;default:o.Y.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),s=new this.bjsAMMO.btPoint2PointConstraint(e,i,new this.bjsAMMO.btVector3(a.mainPivot.x,a.mainPivot.y,a.mainPivot.z),new this.bjsAMMO.btVector3(a.connectedPivot.x,a.connectedPivot.y,a.connectedPivot.z))}this.world.addConstraint(s,!t.joint.jointData.collision),t.joint.physicsJoint=s}},t.prototype.removeJoint=function(t){this.world&&this.world.removeConstraint(t.joint.physicsJoint)},t.prototype._addMeshVerts=function(t,e,i){var o=this,s=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){var n=i.getIndices();n||(n=[]);var h=i.getVerticesData(a.o.PositionKind);h||(h=[]);var l=void 0;if(e&&e!==i){var c=void 0;c=e.rotationQuaternion?e.rotationQuaternion:e.rotation?r._f.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z):r._f.Identity(),r.y3.Compose(r.P.One(),c,e.position).invertToRef(this._tmpMatrix),l=i.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else r.y3.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),l=this._tmpMatrix;for(var d=n.length/3,u=0;u<d;u++){for(var p=[],m=0;m<3;m++){var f=new r.P(h[3*n[3*u+m]+0],h[3*n[3*u+m]+1],h[3*n[3*u+m]+2]);f=r.P.TransformCoordinates(f,l);var _=void 0;(_=0==m?this._tmpAmmoVectorA:1==m?this._tmpAmmoVectorB:this._tmpAmmoVectorC).setValue(f.x,f.y,f.z),p.push(_)}t.addTriangle(p[0],p[1],p[2]),s++}i.getChildMeshes().forEach((function(i){s+=o._addMeshVerts(t,e,i)}))}return s},t.prototype._softVertexData=function(t){var e=t.object;if(e&&e.getIndices&&e.getWorldMatrix&&e.getChildMeshes){var i=e.getIndices();i||(i=[]);var o=e.getVerticesData(a.o.PositionKind);o||(o=[]);var s=e.getVerticesData(a.o.NormalKind);s||(s=[]),e.computeWorldMatrix(!1);for(var n=[],l=[],c=0;c<o.length;c+=3){var d=new r.P(o[c],o[c+1],o[c+2]),u=new r.P(s[c],s[c+1],s[c+2]);d=r.P.TransformCoordinates(d,e.getWorldMatrix()),u=r.P.TransformNormal(u,e.getWorldMatrix()),n.push(d.x,d.y,d.z),l.push(u.x,u.y,u.z)}var p=new h.x;return p.positions=n,p.normals=l,p.uvs=e.getVerticesData(a.o.UVKind),p.colors=e.getVerticesData(a.o.ColorKind),e&&e.getIndices&&(p.indices=e.getIndices()),p.applyToMesh(e),e.position=r.P.Zero(),e.rotationQuaternion=null,e.rotation=r.P.Zero(),e.computeWorldMatrix(!0),p}return h.x.ExtractFromMesh(e)},t.prototype._createSoftbody=function(t){var e=t.object;if(e&&e.getIndices){var i=e.getIndices();i||(i=[]);var o=this._softVertexData(t),s=o.positions,n=o.normals;if(null===s||null===n)return new this.bjsAMMO.btCompoundShape;for(var a=[],h=[],l=0;l<s.length;l+=3){var c=new r.P(s[l],s[l+1],s[l+2]),d=new r.P(n[l],n[l+1],n[l+2]);a.push(c.x,c.y,-c.z),h.push(d.x,d.y,-d.z)}var u=(new this.bjsAMMO.btSoftBodyHelpers).CreateFromTriMesh(this.world.getWorldInfo(),a,e.getIndices(),i.length/3,!0),p=s.length/3,m=u.get_m_nodes(),f=void 0;for(l=0;l<p;l++)(f=m.at(l).get_m_n()).setX(h[3*l]),f.setY(h[3*l+1]),f.setZ(h[3*l+2]);return u}},t.prototype._createCloth=function(t){var e=t.object;if(e&&e.getIndices){var i=e.getIndices();i||(i=[]);var r=this._softVertexData(t),o=r.positions,s=r.normals;if(null===o||null===s)return new this.bjsAMMO.btCompoundShape;var n=o.length,a=Math.sqrt(n/3);t.segments=a;var h=a-1;return this._tmpAmmoVectorA.setValue(o[0],o[1],o[2]),this._tmpAmmoVectorB.setValue(o[3*h],o[3*h+1],o[3*h+2]),this._tmpAmmoVectorD.setValue(o[n-3],o[n-2],o[n-1]),this._tmpAmmoVectorC.setValue(o[n-3-3*h],o[n-2-3*h],o[n-1-3*h]),(new this.bjsAMMO.btSoftBodyHelpers).CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,a,a,t.getParam("fixedPoints"),!0)}},t.prototype._createRope=function(t){var e,i,r=this._softVertexData(t),s=r.positions,n=r.normals;if(null===s||null===n)return new this.bjsAMMO.btCompoundShape;r.applyToMesh(t.object,!0),t._isFromLine=!0;if(0===n.map((function(t){return t*t})).reduce((function(t,e){return t+e})))i=(e=s.length)/3-1,this._tmpAmmoVectorA.setValue(s[0],s[1],s[2]),this._tmpAmmoVectorB.setValue(s[e-3],s[e-2],s[e-1]);else{t._isFromLine=!1;var a=t.getParam("path");if(null===t.getParam("shape"))return o.Y.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;i=(e=a.length)-1,this._tmpAmmoVectorA.setValue(a[0].x,a[0].y,a[0].z),this._tmpAmmoVectorB.setValue(a[e-1].x,a[e-1].y,a[e-1].z)}t.segments=i;var h=t.getParam("fixedPoints");h=h>3?3:h;var l=(new this.bjsAMMO.btSoftBodyHelpers).CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,i-1,h);return l.get_m_cfg().set_collisions(17),l},t.prototype._createCustom=function(t){var e=null;return this.onCreateCustomShape&&(e=this.onCreateCustomShape(t)),null==e&&(e=new this.bjsAMMO.btCompoundShape),e},t.prototype._addHullVerts=function(t,e,i){var o=this,s=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){var n=i.getIndices();n||(n=[]);var h=i.getVerticesData(a.o.PositionKind);h||(h=[]),i.computeWorldMatrix(!1);for(var l=n.length/3,c=0;c<l;c++){for(var d=[],u=0;u<3;u++){var p=new r.P(h[3*n[3*c+u]+0],h[3*n[3*c+u]+1],h[3*n[3*c+u]+2]);r.y3.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),p=r.P.TransformCoordinates(p,this._tmpMatrix);var m=void 0;(m=0==u?this._tmpAmmoVectorA:1==u?this._tmpAmmoVectorB:this._tmpAmmoVectorC).setValue(p.x,p.y,p.z),d.push(m)}t.addPoint(d[0],!0),t.addPoint(d[1],!0),t.addPoint(d[2],!0),s++}i.getChildMeshes().forEach((function(i){s+=o._addHullVerts(t,e,i)}))}return s},t.prototype._createShape=function(t,e){var i=this;void 0===e&&(e=!1);var n,a=t.object,h=t.getObjectExtendSize();if(!e){var l=t.object.getChildMeshes?t.object.getChildMeshes(!0):[];n=new this.bjsAMMO.btCompoundShape;var c=0;if(l.forEach((function(t){var e=t.getPhysicsImpostor();if(e){if(e.type==s.Q.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";var o=i._createShape(e),a=t.parent.getWorldMatrix().clone(),h=new r.P;a.decompose(h),i._tmpAmmoTransform.getOrigin().setValue(t.position.x*h.x,t.position.y*h.y,t.position.z*h.z),i._tmpAmmoQuaternion.setValue(t.rotationQuaternion.x,t.rotationQuaternion.y,t.rotationQuaternion.z,t.rotationQuaternion.w),i._tmpAmmoTransform.setRotation(i._tmpAmmoQuaternion),n.addChildShape(i._tmpAmmoTransform,o),e.dispose(),c++}})),c>0){if(t.type!=s.Q.NoImpostor){var d=this._createShape(t,!0);d&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),n.addChildShape(this._tmpAmmoTransform,d))}return n}this.bjsAMMO.destroy(n),n=null}switch(t.type){case s.Q.SphereImpostor:if(u.R.WithinEpsilon(h.x,h.y,1e-4)&&u.R.WithinEpsilon(h.x,h.z,1e-4))n=new this.bjsAMMO.btSphereShape(h.x/2);else{var p=[new this.bjsAMMO.btVector3(0,0,0)];(n=new this.bjsAMMO.btMultiSphereShape(p,[1],1)).setLocalScaling(new this.bjsAMMO.btVector3(h.x/2,h.y/2,h.z/2))}break;case s.Q.CapsuleImpostor:var m=h.x/2;n=new this.bjsAMMO.btCapsuleShape(m,h.y-2*m);break;case s.Q.CylinderImpostor:this._tmpAmmoVectorA.setValue(h.x/2,h.y/2,h.z/2),n=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case s.Q.PlaneImpostor:case s.Q.BoxImpostor:this._tmpAmmoVectorA.setValue(h.x/2,h.y/2,h.z/2),n=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case s.Q.MeshImpostor:if(0==t.getParam("mass")){if(this.onCreateCustomMeshImpostor)n=this.onCreateCustomMeshImpostor(t);else{var f=new this.bjsAMMO.btTriangleMesh;t._pluginData.toDispose.push(f);var _=this._addMeshVerts(f,a,a);n=0==_?new this.bjsAMMO.btCompoundShape:new this.bjsAMMO.btBvhTriangleMeshShape(f)}break}case s.Q.ConvexHullImpostor:if(this.onCreateCustomConvexHullImpostor)n=this.onCreateCustomConvexHullImpostor(t);else{var g=new this.bjsAMMO.btConvexHullShape;0==(_=this._addHullVerts(g,a,a))?(t._pluginData.toDispose.push(g),n=new this.bjsAMMO.btCompoundShape):n=g}break;case s.Q.NoImpostor:n=new this.bjsAMMO.btSphereShape(h.x/2);break;case s.Q.CustomImpostor:n=this._createCustom(t);break;case s.Q.SoftbodyImpostor:n=this._createSoftbody(t);break;case s.Q.ClothImpostor:n=this._createCloth(t);break;case s.Q.RopeImpostor:n=this._createRope(t);break;default:o.Y.Warn("The impostor type is not currently supported by the ammo plugin.")}return n},t.prototype.setTransformationFromPhysicsBody=function(t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),t.object.rotationQuaternion?t.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):t.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(t.object.rotation))},t.prototype.setPhysicsBodyTransformation=function(t,e,i){var r=t.physicsBody.getWorldTransform();if(Math.abs(r.getOrigin().x()-e.x)>p.kn||Math.abs(r.getOrigin().y()-e.y)>p.kn||Math.abs(r.getOrigin().z()-e.z)>p.kn||Math.abs(r.getRotation().x()-i.x)>p.kn||Math.abs(r.getRotation().y()-i.y)>p.kn||Math.abs(r.getRotation().z()-i.z)>p.kn||Math.abs(r.getRotation().w()-i.w)>p.kn)if(this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),r.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),r.setRotation(this._tmpAmmoQuaternion),t.physicsBody.setWorldTransform(r),0==t.mass){var o=t.physicsBody.getMotionState();o&&o.setWorldTransform(r)}else t.physicsBody.activate()},t.prototype.isSupported=function(){return void 0!==this.bjsAMMO},t.prototype.setLinearVelocity=function(t,e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),t.soft?t.physicsBody.linearVelocity(this._tmpAmmoVectorA):t.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)},t.prototype.setAngularVelocity=function(t,e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),t.soft?t.physicsBody.angularVelocity(this._tmpAmmoVectorA):t.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)},t.prototype.getLinearVelocity=function(t){var e;if(!(e=t.soft?t.physicsBody.linearVelocity():t.physicsBody.getLinearVelocity()))return null;var i=new r.P(e.x(),e.y(),e.z());return this.bjsAMMO.destroy(e),i},t.prototype.getAngularVelocity=function(t){var e;if(!(e=t.soft?t.physicsBody.angularVelocity():t.physicsBody.getAngularVelocity()))return null;var i=new r.P(e.x(),e.y(),e.z());return this.bjsAMMO.destroy(e),i},t.prototype.setBodyMass=function(t,e){t.soft?t.physicsBody.setTotalMass(e,!1):t.physicsBody.setMassProps(e),t._pluginData.mass=e},t.prototype.getBodyMass=function(t){return t._pluginData.mass||0},t.prototype.getBodyFriction=function(t){return t._pluginData.friction||0},t.prototype.setBodyFriction=function(t,e){t.soft?t.physicsBody.get_m_cfg().set_kDF(e):t.physicsBody.setFriction(e),t._pluginData.friction=e},t.prototype.getBodyRestitution=function(t){return t._pluginData.restitution||0},t.prototype.setBodyRestitution=function(t,e){t.physicsBody.setRestitution(e),t._pluginData.restitution=e},t.prototype.getBodyPressure=function(t){return t.soft?t._pluginData.pressure||0:(o.Y.Warn("Pressure is not a property of a rigid body"),0)},t.prototype.setBodyPressure=function(t,e){t.soft?t.type===s.Q.SoftbodyImpostor?(t.physicsBody.get_m_cfg().set_kPR(e),t._pluginData.pressure=e):(t.physicsBody.get_m_cfg().set_kPR(0),t._pluginData.pressure=0):o.Y.Warn("Pressure can only be applied to a softbody")},t.prototype.getBodyStiffness=function(t){return t.soft?t._pluginData.stiffness||0:(o.Y.Warn("Stiffness is not a property of a rigid body"),0)},t.prototype.setBodyStiffness=function(t,e){t.soft?(e=(e=e<0?0:e)>1?1:e,t.physicsBody.get_m_materials().at(0).set_m_kLST(e),t._pluginData.stiffness=e):o.Y.Warn("Stiffness cannot be applied to a rigid body")},t.prototype.getBodyVelocityIterations=function(t){return t.soft?t._pluginData.velocityIterations||0:(o.Y.Warn("Velocity iterations is not a property of a rigid body"),0)},t.prototype.setBodyVelocityIterations=function(t,e){t.soft?(e=e<0?0:e,t.physicsBody.get_m_cfg().set_viterations(e),t._pluginData.velocityIterations=e):o.Y.Warn("Velocity iterations cannot be applied to a rigid body")},t.prototype.getBodyPositionIterations=function(t){return t.soft?t._pluginData.positionIterations||0:(o.Y.Warn("Position iterations is not a property of a rigid body"),0)},t.prototype.setBodyPositionIterations=function(t,e){t.soft?(e=e<0?0:e,t.physicsBody.get_m_cfg().set_piterations(e),t._pluginData.positionIterations=e):o.Y.Warn("Position iterations cannot be applied to a rigid body")},t.prototype.appendAnchor=function(t,e,i,r,o,s){void 0===o&&(o=1),void 0===s&&(s=!1);var n=t.segments,a=Math.round((n-1)*i)+n*(n-1-Math.round((n-1)*r));t.physicsBody.appendAnchor(a,e.physicsBody,s,o)},t.prototype.appendHook=function(t,e,i,r,o){void 0===r&&(r=1),void 0===o&&(o=!1);var s=Math.round(t.segments*i);t.physicsBody.appendAnchor(s,e.physicsBody,o,r)},t.prototype.sleepBody=function(t){t.physicsBody.forceActivationState(0)},t.prototype.wakeUpBody=function(t){t.physicsBody.activate()},t.prototype.updateDistanceJoint=function(){o.Y.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")},t.prototype.setMotor=function(t,e,i){t.physicsJoint.enableAngularMotor(!0,e,i)},t.prototype.setLimit=function(){o.Y.Warn("setLimit is not currently supported by the Ammo physics plugin")},t.prototype.syncMeshWithImpostor=function(t,e){e.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.position.x=this._tmpAmmoTransform.getOrigin().x(),t.position.y=this._tmpAmmoTransform.getOrigin().y(),t.position.z=this._tmpAmmoTransform.getOrigin().z(),t.rotationQuaternion&&(t.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),t.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),t.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),t.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())},t.prototype.getRadius=function(t){return t.getObjectExtendSize().x/2},t.prototype.getBoxSizeToRef=function(t,e){var i=t.getObjectExtendSize();e.x=i.x,e.y=i.y,e.z=i.z},t.prototype.dispose=function(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null},t.prototype.raycast=function(t,e){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(t.x,t.y,t.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(e.x,e.y,e.z);var i=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);return this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,i),this._raycastResult.reset(t,e),i.hasHit()&&(this._raycastResult.setHitData({x:i.get_m_hitNormalWorld().x(),y:i.get_m_hitNormalWorld().y(),z:i.get_m_hitNormalWorld().z()},{x:i.get_m_hitPointWorld().x(),y:i.get_m_hitPointWorld().y(),z:i.get_m_hitPointWorld().z()}),this._raycastResult.calculateHitDistance()),this.bjsAMMO.destroy(i),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB),this._raycastResult},t._DISABLE_COLLISION_FLAG=4,t._KINEMATIC_FLAG=2,t._DISABLE_DEACTIVATION_FLAG=4,t}()}}]);